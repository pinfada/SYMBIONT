fcc570b40174f6d76e9319224c81b70c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const WebGLBatcher_1 = require("../src/core/utils/WebGLBatcher");
// Mock WebGL context
const createMockWebGLContext = () => {
    const buffers = [];
    let bufferIndex = 0;
    return {
        TRIANGLES: 4,
        LINES: 1,
        POINTS: 0,
        ARRAY_BUFFER: 34962,
        ELEMENT_ARRAY_BUFFER: 34963,
        DYNAMIC_DRAW: 35048,
        FLOAT: 5126,
        UNSIGNED_SHORT: 5123,
        createBuffer: jest.fn(() => {
            const buffer = { id: bufferIndex++ };
            buffers.push(buffer);
            return buffer;
        }),
        deleteBuffer: jest.fn(),
        bindBuffer: jest.fn(),
        bufferData: jest.fn(),
        vertexAttribPointer: jest.fn(),
        enableVertexAttribArray: jest.fn(),
        drawArrays: jest.fn(),
        drawElements: jest.fn(),
    };
};
describe('WebGLBatcher', () => {
    let gl;
    let batcher;
    beforeEach(() => {
        gl = createMockWebGLContext();
        batcher = new WebGLBatcher_1.WebGLBatcher(gl, {
            maxBatchSize: 3,
            maxVertices: 100,
            frameTimeoutMs: 16.67
        });
    });
    afterEach(() => {
        if (batcher) {
            batcher.dispose();
        }
    });
    it('should initialize WebGL buffers correctly', () => {
        expect(gl.createBuffer).toHaveBeenCalledTimes(2); // Vertex and index buffers
    });
    it('should add draw calls and return unique IDs', () => {
        const drawCall = {
            type: 'triangle',
            vertices: new Float32Array([0, 0, 0, 1, 0, 0, 0, 1, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        };
        const id1 = batcher.addDrawCall(drawCall);
        const id2 = batcher.addDrawCall(drawCall);
        expect(id1).toBeDefined();
        expect(id2).toBeDefined();
        expect(id1).not.toBe(id2);
    });
    it('should batch draw calls of the same type', async () => {
        const vertices1 = new Float32Array([0, 0, 0, 0, 0, 1, 0, 0]);
        const vertices2 = new Float32Array([1, 0, 0, 0, 0, 1, 0, 0]);
        batcher.addDrawCall({
            type: 'triangle',
            vertices: vertices1,
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        });
        batcher.addDrawCall({
            type: 'triangle',
            vertices: vertices2,
            uniforms: { u_color: 0.5 },
            priority: 'normal'
        });
        // Force flush to trigger batching
        batcher.flush();
        expect(gl.bufferData).toHaveBeenCalled();
        expect(gl.drawArrays).toHaveBeenCalled();
    });
    it('should handle high priority draw calls immediately', async () => {
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([0, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'low'
        });
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([1, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'high' // Should trigger immediate rendering
        });
        // Small delay to allow async processing
        await new Promise(resolve => setTimeout(resolve, 50));
        expect(gl.drawArrays).toHaveBeenCalled();
    });
    it('should render when max batch size is reached', () => {
        // Add draw calls up to max batch size
        for (let i = 0; i < 3; i++) {
            batcher.addDrawCall({
                type: 'triangle',
                vertices: new Float32Array([i, 0, 0, 0, 0, 1, 0, 0]),
                uniforms: { u_color: 1.0 },
                priority: 'normal'
            });
        }
        // Should have triggered immediate rendering
        expect(gl.drawArrays).toHaveBeenCalled();
    });
    it('should handle indexed drawing correctly', () => {
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([0, 0, 0, 0, 0, 1, 0, 0,
                1, 0, 0, 0, 0, 1, 0, 0,
                0, 1, 0, 0, 0, 1, 0, 0]),
            indices: new Uint16Array([0, 1, 2]),
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        });
        batcher.flush();
        expect(gl.bindBuffer).toHaveBeenCalledWith(gl.ELEMENT_ARRAY_BUFFER, expect.anything());
        expect(gl.drawElements).toHaveBeenCalled();
    });
    it('should track statistics correctly', () => {
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([0, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        });
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([1, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        });
        batcher.flush();
        const stats = batcher.getStats();
        expect(stats.totalDrawCalls).toBe(2);
        expect(stats.totalBatches).toBeGreaterThan(0);
        expect(stats.compressionRatio).toBeGreaterThan(1);
    });
    it('should handle different primitive types separately', () => {
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([0, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        });
        batcher.addDrawCall({
            type: 'line',
            vertices: new Float32Array([0, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        });
        batcher.flush();
        // Should have made separate draw calls for different primitive types
        expect(gl.drawArrays).toHaveBeenCalledTimes(2);
    });
    it('should dispose resources correctly', () => {
        batcher.dispose();
        expect(gl.deleteBuffer).toHaveBeenCalledTimes(2);
    });
    it('should handle empty batches gracefully', () => {
        // Try to flush with no draw calls
        expect(() => batcher.flush()).not.toThrow();
    });
    it('should merge uniforms correctly when batching', () => {
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([0, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0, u_intensity: 0.5 },
            priority: 'normal'
        });
        batcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([1, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 0.5, u_brightness: 1.0 },
            priority: 'normal'
        });
        batcher.flush();
        const stats = batcher.getStats();
        expect(stats.totalBatches).toBe(1); // Should be batched together
    });
    it('should respect frame timeout for rendering', async () => {
        const fastBatcher = new WebGLBatcher_1.WebGLBatcher(gl, {
            frameTimeoutMs: 10 // Very short timeout
        });
        fastBatcher.addDrawCall({
            type: 'triangle',
            vertices: new Float32Array([0, 0, 0, 0, 0, 1, 0, 0]),
            uniforms: { u_color: 1.0 },
            priority: 'normal'
        });
        // Should render within timeout
        await new Promise(resolve => setTimeout(resolve, 50));
        const stats = fastBatcher.getStats();
        expect(stats.totalBatches).toBeGreaterThan(0);
        fastBatcher.dispose();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUE0QyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzFELE1BQU0sV0FBVyxHQUFHLElBQUksMkJBQVksQ0FBQyxFQUFFLEVBQUU7WUFDdkMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxxQkFBcUI7U0FDekMsQ0FBQyxDQUFDO1FBRUgsV0FBVyxDQUFDLFdBQVcsQ0FBQztZQUN0QixJQUFJLEVBQUUsVUFBVTtZQUNoQixRQUFRLEVBQUUsSUFBSSxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDcEQsUUFBUSxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRTtZQUMxQixRQUFRLEVBQUUsUUFBUTtTQUNuQixDQUFDLENBQUM7UUFFSCwrQkFBK0I7UUFDL0IsTUFBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUV0RCxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckMsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFOUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL3dvcmtzcGFjZXMvU1lNQklPTlQvX190ZXN0c19fL1dlYkdMQmF0Y2hlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFdlYkdMQmF0Y2hlciwgV2ViR0xEcmF3Q2FsbCB9IGZyb20gJy4uL3NyYy9jb3JlL3V0aWxzL1dlYkdMQmF0Y2hlcic7XHJcblxyXG4vLyBNb2NrIFdlYkdMIGNvbnRleHRcclxuY29uc3QgY3JlYXRlTW9ja1dlYkdMQ29udGV4dCA9ICgpOiBXZWJHTFJlbmRlcmluZ0NvbnRleHQgPT4ge1xyXG4gIGNvbnN0IGJ1ZmZlcnM6IFdlYkdMQnVmZmVyW10gPSBbXTtcclxuICBsZXQgYnVmZmVySW5kZXggPSAwO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgVFJJQU5HTEVTOiA0LFxyXG4gICAgTElORVM6IDEsXHJcbiAgICBQT0lOVFM6IDAsXHJcbiAgICBBUlJBWV9CVUZGRVI6IDM0OTYyLFxyXG4gICAgRUxFTUVOVF9BUlJBWV9CVUZGRVI6IDM0OTYzLFxyXG4gICAgRFlOQU1JQ19EUkFXOiAzNTA0OCxcclxuICAgIEZMT0FUOiA1MTI2LFxyXG4gICAgVU5TSUdORURfU0hPUlQ6IDUxMjMsXHJcbiAgICBcclxuICAgIGNyZWF0ZUJ1ZmZlcjogamVzdC5mbigoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IHsgaWQ6IGJ1ZmZlckluZGV4KysgfSBhcyBXZWJHTEJ1ZmZlcjtcclxuICAgICAgYnVmZmVycy5wdXNoKGJ1ZmZlcik7XHJcbiAgICAgIHJldHVybiBidWZmZXI7XHJcbiAgICB9KSxcclxuICAgIFxyXG4gICAgZGVsZXRlQnVmZmVyOiBqZXN0LmZuKCksXHJcbiAgICBiaW5kQnVmZmVyOiBqZXN0LmZuKCksXHJcbiAgICBidWZmZXJEYXRhOiBqZXN0LmZuKCksXHJcbiAgICB2ZXJ0ZXhBdHRyaWJQb2ludGVyOiBqZXN0LmZuKCksXHJcbiAgICBlbmFibGVWZXJ0ZXhBdHRyaWJBcnJheTogamVzdC5mbigpLFxyXG4gICAgZHJhd0FycmF5czogamVzdC5mbigpLFxyXG4gICAgZHJhd0VsZW1lbnRzOiBqZXN0LmZuKCksXHJcbiAgfSBhcyB1bmtub3duIGFzIFdlYkdMUmVuZGVyaW5nQ29udGV4dDtcclxufTtcclxuXHJcbmRlc2NyaWJlKCdXZWJHTEJhdGNoZXInLCAoKSA9PiB7XHJcbiAgbGV0IGdsOiBXZWJHTFJlbmRlcmluZ0NvbnRleHQ7XHJcbiAgbGV0IGJhdGNoZXI6IFdlYkdMQmF0Y2hlcjtcclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBnbCA9IGNyZWF0ZU1vY2tXZWJHTENvbnRleHQoKTtcclxuICAgIGJhdGNoZXIgPSBuZXcgV2ViR0xCYXRjaGVyKGdsLCB7XHJcbiAgICAgIG1heEJhdGNoU2l6ZTogMyxcclxuICAgICAgbWF4VmVydGljZXM6IDEwMCxcclxuICAgICAgZnJhbWVUaW1lb3V0TXM6IDE2LjY3XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgIGlmIChiYXRjaGVyKSB7XHJcbiAgICAgIGJhdGNoZXIuZGlzcG9zZSgpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGluaXRpYWxpemUgV2ViR0wgYnVmZmVycyBjb3JyZWN0bHknLCAoKSA9PiB7XHJcbiAgICBleHBlY3QoZ2wuY3JlYXRlQnVmZmVyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7IC8vIFZlcnRleCBhbmQgaW5kZXggYnVmZmVyc1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGFkZCBkcmF3IGNhbGxzIGFuZCByZXR1cm4gdW5pcXVlIElEcycsICgpID0+IHtcclxuICAgIGNvbnN0IGRyYXdDYWxsID0ge1xyXG4gICAgICB0eXBlOiAndHJpYW5nbGUnIGFzIGNvbnN0LFxyXG4gICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbMCwgMCwgMCwgMSwgMCwgMCwgMCwgMSwgMF0pLFxyXG4gICAgICB1bmlmb3JtczogeyB1X2NvbG9yOiAxLjAgfSxcclxuICAgICAgcHJpb3JpdHk6ICdub3JtYWwnIGFzIGNvbnN0XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IGlkMSA9IGJhdGNoZXIuYWRkRHJhd0NhbGwoZHJhd0NhbGwpO1xyXG4gICAgY29uc3QgaWQyID0gYmF0Y2hlci5hZGREcmF3Q2FsbChkcmF3Q2FsbCk7XHJcblxyXG4gICAgZXhwZWN0KGlkMSkudG9CZURlZmluZWQoKTtcclxuICAgIGV4cGVjdChpZDIpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICBleHBlY3QoaWQxKS5ub3QudG9CZShpZDIpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGJhdGNoIGRyYXcgY2FsbHMgb2YgdGhlIHNhbWUgdHlwZScsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHZlcnRpY2VzMSA9IG5ldyBGbG9hdDMyQXJyYXkoWzAsIDAsIDAsIDAsIDAsIDEsIDAsIDBdKTtcclxuICAgIGNvbnN0IHZlcnRpY2VzMiA9IG5ldyBGbG9hdDMyQXJyYXkoWzEsIDAsIDAsIDAsIDAsIDEsIDAsIDBdKTtcclxuXHJcbiAgICBiYXRjaGVyLmFkZERyYXdDYWxsKHtcclxuICAgICAgdHlwZTogJ3RyaWFuZ2xlJyxcclxuICAgICAgdmVydGljZXM6IHZlcnRpY2VzMSxcclxuICAgICAgdW5pZm9ybXM6IHsgdV9jb2xvcjogMS4wIH0sXHJcbiAgICAgIHByaW9yaXR5OiAnbm9ybWFsJ1xyXG4gICAgfSk7XHJcblxyXG4gICAgYmF0Y2hlci5hZGREcmF3Q2FsbCh7XHJcbiAgICAgIHR5cGU6ICd0cmlhbmdsZScsXHJcbiAgICAgIHZlcnRpY2VzOiB2ZXJ0aWNlczIsXHJcbiAgICAgIHVuaWZvcm1zOiB7IHVfY29sb3I6IDAuNSB9LFxyXG4gICAgICBwcmlvcml0eTogJ25vcm1hbCdcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEZvcmNlIGZsdXNoIHRvIHRyaWdnZXIgYmF0Y2hpbmdcclxuICAgIGJhdGNoZXIuZmx1c2goKTtcclxuXHJcbiAgICBleHBlY3QoZ2wuYnVmZmVyRGF0YSkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgZXhwZWN0KGdsLmRyYXdBcnJheXMpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgaGlnaCBwcmlvcml0eSBkcmF3IGNhbGxzIGltbWVkaWF0ZWx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgYmF0Y2hlci5hZGREcmF3Q2FsbCh7XHJcbiAgICAgIHR5cGU6ICd0cmlhbmdsZScsXHJcbiAgICAgIHZlcnRpY2VzOiBuZXcgRmxvYXQzMkFycmF5KFswLCAwLCAwLCAwLCAwLCAxLCAwLCAwXSksXHJcbiAgICAgIHVuaWZvcm1zOiB7IHVfY29sb3I6IDEuMCB9LFxyXG4gICAgICBwcmlvcml0eTogJ2xvdydcclxuICAgIH0pO1xyXG5cclxuICAgIGJhdGNoZXIuYWRkRHJhd0NhbGwoe1xyXG4gICAgICB0eXBlOiAndHJpYW5nbGUnLFxyXG4gICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbMSwgMCwgMCwgMCwgMCwgMSwgMCwgMF0pLFxyXG4gICAgICB1bmlmb3JtczogeyB1X2NvbG9yOiAxLjAgfSxcclxuICAgICAgcHJpb3JpdHk6ICdoaWdoJyAvLyBTaG91bGQgdHJpZ2dlciBpbW1lZGlhdGUgcmVuZGVyaW5nXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTbWFsbCBkZWxheSB0byBhbGxvdyBhc3luYyBwcm9jZXNzaW5nXHJcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTApKTtcclxuXHJcbiAgICBleHBlY3QoZ2wuZHJhd0FycmF5cykudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIHJlbmRlciB3aGVuIG1heCBiYXRjaCBzaXplIGlzIHJlYWNoZWQnLCAoKSA9PiB7XHJcbiAgICAvLyBBZGQgZHJhdyBjYWxscyB1cCB0byBtYXggYmF0Y2ggc2l6ZVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyBpKyspIHtcclxuICAgICAgYmF0Y2hlci5hZGREcmF3Q2FsbCh7XHJcbiAgICAgICAgdHlwZTogJ3RyaWFuZ2xlJyxcclxuICAgICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbaSwgMCwgMCwgMCwgMCwgMSwgMCwgMF0pLFxyXG4gICAgICAgIHVuaWZvcm1zOiB7IHVfY29sb3I6IDEuMCB9LFxyXG4gICAgICAgIHByaW9yaXR5OiAnbm9ybWFsJ1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBTaG91bGQgaGF2ZSB0cmlnZ2VyZWQgaW1tZWRpYXRlIHJlbmRlcmluZ1xyXG4gICAgZXhwZWN0KGdsLmRyYXdBcnJheXMpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgaW5kZXhlZCBkcmF3aW5nIGNvcnJlY3RseScsICgpID0+IHtcclxuICAgIGJhdGNoZXIuYWRkRHJhd0NhbGwoe1xyXG4gICAgICB0eXBlOiAndHJpYW5nbGUnLFxyXG4gICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbMCwgMCwgMCwgMCwgMCwgMSwgMCwgMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLCAxLCAwLCAwLCAwLCAxLCAwLCAwXSksXHJcbiAgICAgIGluZGljZXM6IG5ldyBVaW50MTZBcnJheShbMCwgMSwgMl0pLFxyXG4gICAgICB1bmlmb3JtczogeyB1X2NvbG9yOiAxLjAgfSxcclxuICAgICAgcHJpb3JpdHk6ICdub3JtYWwnXHJcbiAgICB9KTtcclxuXHJcbiAgICBiYXRjaGVyLmZsdXNoKCk7XHJcblxyXG4gICAgZXhwZWN0KGdsLmJpbmRCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBleHBlY3QuYW55dGhpbmcoKSk7XHJcbiAgICBleHBlY3QoZ2wuZHJhd0VsZW1lbnRzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgdHJhY2sgc3RhdGlzdGljcyBjb3JyZWN0bHknLCAoKSA9PiB7XHJcbiAgICBiYXRjaGVyLmFkZERyYXdDYWxsKHtcclxuICAgICAgdHlwZTogJ3RyaWFuZ2xlJyxcclxuICAgICAgdmVydGljZXM6IG5ldyBGbG9hdDMyQXJyYXkoWzAsIDAsIDAsIDAsIDAsIDEsIDAsIDBdKSxcclxuICAgICAgdW5pZm9ybXM6IHsgdV9jb2xvcjogMS4wIH0sXHJcbiAgICAgIHByaW9yaXR5OiAnbm9ybWFsJ1xyXG4gICAgfSk7XHJcblxyXG4gICAgYmF0Y2hlci5hZGREcmF3Q2FsbCh7XHJcbiAgICAgIHR5cGU6ICd0cmlhbmdsZScsXHJcbiAgICAgIHZlcnRpY2VzOiBuZXcgRmxvYXQzMkFycmF5KFsxLCAwLCAwLCAwLCAwLCAxLCAwLCAwXSksXHJcbiAgICAgIHVuaWZvcm1zOiB7IHVfY29sb3I6IDEuMCB9LFxyXG4gICAgICBwcmlvcml0eTogJ25vcm1hbCdcclxuICAgIH0pO1xyXG5cclxuICAgIGJhdGNoZXIuZmx1c2goKTtcclxuXHJcbiAgICBjb25zdCBzdGF0cyA9IGJhdGNoZXIuZ2V0U3RhdHMoKTtcclxuICAgIGV4cGVjdChzdGF0cy50b3RhbERyYXdDYWxscykudG9CZSgyKTtcclxuICAgIGV4cGVjdChzdGF0cy50b3RhbEJhdGNoZXMpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuICAgIGV4cGVjdChzdGF0cy5jb21wcmVzc2lvblJhdGlvKS50b0JlR3JlYXRlclRoYW4oMSk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgaGFuZGxlIGRpZmZlcmVudCBwcmltaXRpdmUgdHlwZXMgc2VwYXJhdGVseScsICgpID0+IHtcclxuICAgIGJhdGNoZXIuYWRkRHJhd0NhbGwoe1xyXG4gICAgICB0eXBlOiAndHJpYW5nbGUnLFxyXG4gICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbMCwgMCwgMCwgMCwgMCwgMSwgMCwgMF0pLFxyXG4gICAgICB1bmlmb3JtczogeyB1X2NvbG9yOiAxLjAgfSxcclxuICAgICAgcHJpb3JpdHk6ICdub3JtYWwnXHJcbiAgICB9KTtcclxuXHJcbiAgICBiYXRjaGVyLmFkZERyYXdDYWxsKHtcclxuICAgICAgdHlwZTogJ2xpbmUnLFxyXG4gICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbMCwgMCwgMCwgMCwgMCwgMSwgMCwgMF0pLFxyXG4gICAgICB1bmlmb3JtczogeyB1X2NvbG9yOiAxLjAgfSxcclxuICAgICAgcHJpb3JpdHk6ICdub3JtYWwnXHJcbiAgICB9KTtcclxuXHJcbiAgICBiYXRjaGVyLmZsdXNoKCk7XHJcblxyXG4gICAgLy8gU2hvdWxkIGhhdmUgbWFkZSBzZXBhcmF0ZSBkcmF3IGNhbGxzIGZvciBkaWZmZXJlbnQgcHJpbWl0aXZlIHR5cGVzXHJcbiAgICBleHBlY3QoZ2wuZHJhd0FycmF5cykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGRpc3Bvc2UgcmVzb3VyY2VzIGNvcnJlY3RseScsICgpID0+IHtcclxuICAgIGJhdGNoZXIuZGlzcG9zZSgpO1xyXG5cclxuICAgIGV4cGVjdChnbC5kZWxldGVCdWZmZXIpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgZW1wdHkgYmF0Y2hlcyBncmFjZWZ1bGx5JywgKCkgPT4ge1xyXG4gICAgLy8gVHJ5IHRvIGZsdXNoIHdpdGggbm8gZHJhdyBjYWxsc1xyXG4gICAgZXhwZWN0KCgpID0+IGJhdGNoZXIuZmx1c2goKSkubm90LnRvVGhyb3coKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBtZXJnZSB1bmlmb3JtcyBjb3JyZWN0bHkgd2hlbiBiYXRjaGluZycsICgpID0+IHtcclxuICAgIGJhdGNoZXIuYWRkRHJhd0NhbGwoe1xyXG4gICAgICB0eXBlOiAndHJpYW5nbGUnLFxyXG4gICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbMCwgMCwgMCwgMCwgMCwgMSwgMCwgMF0pLFxyXG4gICAgICB1bmlmb3JtczogeyB1X2NvbG9yOiAxLjAsIHVfaW50ZW5zaXR5OiAwLjUgfSxcclxuICAgICAgcHJpb3JpdHk6ICdub3JtYWwnXHJcbiAgICB9KTtcclxuXHJcbiAgICBiYXRjaGVyLmFkZERyYXdDYWxsKHtcclxuICAgICAgdHlwZTogJ3RyaWFuZ2xlJyxcclxuICAgICAgdmVydGljZXM6IG5ldyBGbG9hdDMyQXJyYXkoWzEsIDAsIDAsIDAsIDAsIDEsIDAsIDBdKSxcclxuICAgICAgdW5pZm9ybXM6IHsgdV9jb2xvcjogMC41LCB1X2JyaWdodG5lc3M6IDEuMCB9LFxyXG4gICAgICBwcmlvcml0eTogJ25vcm1hbCdcclxuICAgIH0pO1xyXG5cclxuICAgIGJhdGNoZXIuZmx1c2goKTtcclxuXHJcbiAgICBjb25zdCBzdGF0cyA9IGJhdGNoZXIuZ2V0U3RhdHMoKTtcclxuICAgIGV4cGVjdChzdGF0cy50b3RhbEJhdGNoZXMpLnRvQmUoMSk7IC8vIFNob3VsZCBiZSBiYXRjaGVkIHRvZ2V0aGVyXHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgcmVzcGVjdCBmcmFtZSB0aW1lb3V0IGZvciByZW5kZXJpbmcnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBmYXN0QmF0Y2hlciA9IG5ldyBXZWJHTEJhdGNoZXIoZ2wsIHtcclxuICAgICAgZnJhbWVUaW1lb3V0TXM6IDEwIC8vIFZlcnkgc2hvcnQgdGltZW91dFxyXG4gICAgfSk7XHJcblxyXG4gICAgZmFzdEJhdGNoZXIuYWRkRHJhd0NhbGwoe1xyXG4gICAgICB0eXBlOiAndHJpYW5nbGUnLFxyXG4gICAgICB2ZXJ0aWNlczogbmV3IEZsb2F0MzJBcnJheShbMCwgMCwgMCwgMCwgMCwgMSwgMCwgMF0pLFxyXG4gICAgICB1bmlmb3JtczogeyB1X2NvbG9yOiAxLjAgfSxcclxuICAgICAgcHJpb3JpdHk6ICdub3JtYWwnXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTaG91bGQgcmVuZGVyIHdpdGhpbiB0aW1lb3V0XHJcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTApKTtcclxuXHJcbiAgICBjb25zdCBzdGF0cyA9IGZhc3RCYXRjaGVyLmdldFN0YXRzKCk7XHJcbiAgICBleHBlY3Qoc3RhdHMudG90YWxCYXRjaGVzKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblxyXG4gICAgZmFzdEJhdGNoZXIuZGlzcG9zZSgpO1xyXG4gIH0pO1xyXG59KTsgIl0sInZlcnNpb24iOjN9