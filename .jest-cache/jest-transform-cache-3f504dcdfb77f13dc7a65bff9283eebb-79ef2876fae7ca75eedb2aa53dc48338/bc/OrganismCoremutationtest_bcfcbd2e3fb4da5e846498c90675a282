f8deb4a1381966f1ad94aaabb64a40d4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const OrganismFactory_1 = require("../src/core/factories/OrganismFactory");
const NeuralMesh_1 = require("../src/core/NeuralMesh");
describe('OrganismCore Mutation Integration', () => {
    let organism;
    beforeEach(async () => {
        // Setup factory dependencies
        OrganismFactory_1.OrganismFactory.setDependencies({
            createNeuralMesh: () => new NeuralMesh_1.NeuralMesh()
        });
        organism = OrganismFactory_1.OrganismFactory.createOrganism('ATCGATCGATCGATCG', {
            creativity: 0.5,
            focus: 0.5
        });
        await organism.boot();
    });
    afterEach(async () => {
        if (organism) {
            await organism.hibernate();
        }
    });
    it('should batch multiple quick mutations', async () => {
        const initialMetrics = await organism.getPerformanceMetrics();
        const initialMutationStats = initialMetrics.mutationStats;
        // Apply multiple mutations quickly (should be batched)
        organism.mutate(0.1);
        organism.mutate(0.05);
        organism.mutate(0.15);
        organism.mutate(0.08);
        // Wait for batching to process
        await new Promise(resolve => setTimeout(resolve, 200));
        const finalMetrics = await organism.getPerformanceMetrics();
        const finalMutationStats = finalMetrics.mutationStats;
        // Should have processed mutations in batches
        expect(finalMutationStats.totalRequests).toBeGreaterThan(initialMutationStats.totalRequests);
        expect(finalMutationStats.totalBatches).toBeGreaterThan(0);
        // Compression ratio should show batching efficiency
        expect(finalMutationStats.compressionRatio).toBeGreaterThan(1);
    });
    it('should prioritize high-rate mutations', async () => {
        // Add low rate mutations
        organism.mutate(0.01);
        organism.mutate(0.02);
        // Add high rate mutation (should trigger immediate processing)
        organism.mutate(0.5);
        // Small delay for processing
        await new Promise(resolve => setTimeout(resolve, 50));
        const metrics = await organism.getPerformanceMetrics();
        expect(metrics.mutationStats.totalBatches).toBeGreaterThan(0);
    });
    it('should handle flushMutations correctly', async () => {
        // Queue some mutations
        organism.mutate(0.1);
        organism.mutate(0.2);
        const preFlushMetrics = await organism.getPerformanceMetrics();
        const pendingBeforeFlush = preFlushMetrics.mutationStats.pendingMutations;
        // Force flush
        await organism.flushMutations();
        const postFlushMetrics = await organism.getPerformanceMetrics();
        const pendingAfterFlush = postFlushMetrics.mutationStats.pendingMutations;
        // Should have processed pending mutations
        expect(pendingAfterFlush).toBeLessThan(pendingBeforeFlush);
        expect(postFlushMetrics.mutationStats.totalBatches).toBeGreaterThan(0);
    });
    it('should preserve organism functionality with batched mutations', async () => {
        const initialTraits = organism.getTraits();
        // Apply several mutations with higher rates to ensure detectable change
        organism.mutate(0.3);
        organism.mutate(0.25);
        organism.mutate(0.4);
        organism.mutate(0.35);
        organism.mutate(0.3);
        // Wait for processing
        await organism.flushMutations();
        const finalTraits = organism.getTraits();
        // Traits should have evolved (at least some difference)
        // Using smaller tolerance to detect any change
        const traitsChanged = Object.keys(initialTraits).some(key => {
            const typedKey = key;
            return Math.abs(initialTraits[typedKey] - finalTraits[typedKey]) > 0.00001; // Reduced tolerance
        });
        expect(traitsChanged).toBe(true);
    });
    it('should update performance metrics correctly', async () => {
        // Initial state
        const initialMetrics = await organism.getPerformanceMetrics();
        // Apply mutations and stimulations
        organism.mutate(0.1);
        organism.stimulate('sensory_input', 0.8);
        organism.update(1.0);
        await organism.flushMutations();
        const finalMetrics = await organism.getPerformanceMetrics();
        // Should have mutation statistics
        expect(finalMetrics.mutationStats).toBeDefined();
        expect(finalMetrics.mutationStats.totalRequests).toBeGreaterThan(0);
        // Basic neural metrics should still work
        expect(finalMetrics.neuralActivity).toBeGreaterThanOrEqual(0);
        expect(finalMetrics.connectionStrength).toBeGreaterThanOrEqual(0);
    });
    it('should handle mutation rate validation in batched system', () => {
        // These should not throw errors, but be handled gracefully
        expect(() => organism.mutate(-0.1)).not.toThrow(); // Negative rate
        expect(() => organism.mutate(1.5)).not.toThrow(); // Rate > 1
        expect(() => organism.mutate(0.5)).not.toThrow(); // Valid rate
    });
    it('should clean up mutations during hibernation', async () => {
        // Queue mutations
        organism.mutate(0.1);
        organism.mutate(0.2);
        const metricsBeforeHibernation = await organism.getPerformanceMetrics();
        expect(metricsBeforeHibernation.mutationStats.pendingMutations).toBeGreaterThanOrEqual(0);
        // Hibernate (should flush and clean up)
        await organism.hibernate();
        // Create new organism to check state
        const newOrganism = OrganismFactory_1.OrganismFactory.createOrganism('ATCGATCGATCGATCG');
        await newOrganism.boot();
        const newMetrics = await newOrganism.getPerformanceMetrics();
        expect(newMetrics.mutationStats.pendingMutations).toBe(0);
        await newOrganism.hibernate();
    });
    it('should maintain energy and health with optimized mutations', async () => {
        const initialState = organism.getState();
        // Apply multiple mutations
        for (let i = 0; i < 5; i++) {
            organism.mutate(0.1);
            organism.update(1.0);
        }
        await organism.flushMutations();
        const finalState = organism.getState();
        // Energy and health should remain within valid bounds
        expect(finalState.energy).toBeGreaterThanOrEqual(0);
        expect(finalState.energy).toBeLessThanOrEqual(1);
        expect(finalState.health).toBeGreaterThanOrEqual(0);
        expect(finalState.health).toBeLessThanOrEqual(1);
        // LastMutation should be updated
        expect(finalState.lastMutation).toBeGreaterThan(initialState.lastMutation || 0);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL3dvcmtzcGFjZXMvU1lNQklPTlQvX190ZXN0c19fL09yZ2FuaXNtQ29yZS5tdXRhdGlvbi50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQ0EsMkVBQXdFO0FBQ3hFLHVEQUFvRDtBQUVwRCxRQUFRLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO0lBQ2pELElBQUksUUFBc0IsQ0FBQztJQUUzQixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsNkJBQTZCO1FBQzdCLGlDQUFlLENBQUMsZUFBZSxDQUFDO1lBQzlCLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksdUJBQVUsRUFBRTtTQUN6QyxDQUFDLENBQUM7UUFFSCxRQUFRLEdBQUcsaUNBQWUsQ0FBQyxjQUFjLENBQUMsa0JBQWtCLEVBQUU7WUFDNUQsVUFBVSxFQUFFLEdBQUc7WUFDZixLQUFLLEVBQUUsR0FBRztTQUNYLENBQWlCLENBQUM7UUFFbkIsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDeEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNiLE1BQU0sUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzdCLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNyRCxNQUFNLGNBQWMsR0FBRyxNQUFNLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzlELE1BQU0sb0JBQW9CLEdBQUcsY0FBYyxDQUFDLGFBQWEsQ0FBQztRQUUxRCx1REFBdUQ7UUFDdkQsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQixRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMs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Q0FBQyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWpELGlDQUFpQztRQUNqQyxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2xGLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL3dvcmtzcGFjZXMvU1lNQklPTlQvX190ZXN0c19fL09yZ2FuaXNtQ29yZS5tdXRhdGlvbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9yZ2FuaXNtQ29yZSB9IGZyb20gJy4uL3NyYy9jb3JlL09yZ2FuaXNtQ29yZSc7XHJcbmltcG9ydCB7IE9yZ2FuaXNtRmFjdG9yeSB9IGZyb20gJy4uL3NyYy9jb3JlL2ZhY3Rvcmllcy9PcmdhbmlzbUZhY3RvcnknO1xyXG5pbXBvcnQgeyBOZXVyYWxNZXNoIH0gZnJvbSAnLi4vc3JjL2NvcmUvTmV1cmFsTWVzaCc7XHJcblxyXG5kZXNjcmliZSgnT3JnYW5pc21Db3JlIE11dGF0aW9uIEludGVncmF0aW9uJywgKCkgPT4ge1xyXG4gIGxldCBvcmdhbmlzbTogT3JnYW5pc21Db3JlO1xyXG4gIFxyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgLy8gU2V0dXAgZmFjdG9yeSBkZXBlbmRlbmNpZXNcclxuICAgIE9yZ2FuaXNtRmFjdG9yeS5zZXREZXBlbmRlbmNpZXMoe1xyXG4gICAgICBjcmVhdGVOZXVyYWxNZXNoOiAoKSA9PiBuZXcgTmV1cmFsTWVzaCgpXHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgb3JnYW5pc20gPSBPcmdhbmlzbUZhY3RvcnkuY3JlYXRlT3JnYW5pc20oJ0FUQ0dBVENHQVRDR0FUQ0cnLCB7XHJcbiAgICAgIGNyZWF0aXZpdHk6IDAuNSxcclxuICAgICAgZm9jdXM6IDAuNVxyXG4gICAgfSkgYXMgT3JnYW5pc21Db3JlO1xyXG4gICAgXHJcbiAgICBhd2FpdCBvcmdhbmlzbS5ib290KCk7XHJcbiAgfSk7XHJcblxyXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBpZiAob3JnYW5pc20pIHtcclxuICAgICAgYXdhaXQgb3JnYW5pc20uaGliZXJuYXRlKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgYmF0Y2ggbXVsdGlwbGUgcXVpY2sgbXV0YXRpb25zJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgaW5pdGlhbE1ldHJpY3MgPSBhd2FpdCBvcmdhbmlzbS5nZXRQZXJmb3JtYW5jZU1ldHJpY3MoKTtcclxuICAgIGNvbnN0IGluaXRpYWxNdXRhdGlvblN0YXRzID0gaW5pdGlhbE1ldHJpY3MubXV0YXRpb25TdGF0cztcclxuICAgIFxyXG4gICAgLy8gQXBwbHkgbXVsdGlwbGUgbXV0YXRpb25zIHF1aWNrbHkgKHNob3VsZCBiZSBiYXRjaGVkKVxyXG4gICAgb3JnYW5pc20ubXV0YXRlKDAuMSk7XHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC4wNSk7XHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC4xNSk7XHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC4wOCk7XHJcbiAgICBcclxuICAgIC8vIFdhaXQgZm9yIGJhdGNoaW5nIHRvIHByb2Nlc3NcclxuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDApKTtcclxuICAgIFxyXG4gICAgY29uc3QgZmluYWxNZXRyaWNzID0gYXdhaXQgb3JnYW5pc20uZ2V0UGVyZm9ybWFuY2VNZXRyaWNzKCk7XHJcbiAgICBjb25zdCBmaW5hbE11dGF0aW9uU3RhdHMgPSBmaW5hbE1ldHJpY3MubXV0YXRpb25TdGF0cztcclxuICAgIFxyXG4gICAgLy8gU2hvdWxkIGhhdmUgcHJvY2Vzc2VkIG11dGF0aW9ucyBpbiBiYXRjaGVzXHJcbiAgICBleHBlY3QoZmluYWxNdXRhdGlvblN0YXRzLnRvdGFsUmVxdWVzdHMpLnRvQmVHcmVhdGVyVGhhbihpbml0aWFsTXV0YXRpb25TdGF0cy50b3RhbFJlcXVlc3RzKTtcclxuICAgIGV4cGVjdChmaW5hbE11dGF0aW9uU3RhdHMudG90YWxCYXRjaGVzKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcbiAgICBcclxuICAgIC8vIENvbXByZXNzaW9uIHJhdGlvIHNob3VsZCBzaG93IGJhdGNoaW5nIGVmZmljaWVuY3lcclxuICAgIGV4cGVjdChmaW5hbE11dGF0aW9uU3RhdHMuY29tcHJlc3Npb25SYXRpbykudG9CZUdyZWF0ZXJUaGFuKDEpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIHByaW9yaXRpemUgaGlnaC1yYXRlIG11dGF0aW9ucycsIGFzeW5jICgpID0+IHtcclxuICAgIC8vIEFkZCBsb3cgcmF0ZSBtdXRhdGlvbnNcclxuICAgIG9yZ2FuaXNtLm11dGF0ZSgwLjAxKTtcclxuICAgIG9yZ2FuaXNtLm11dGF0ZSgwLjAyKTtcclxuICAgIFxyXG4gICAgLy8gQWRkIGhpZ2ggcmF0ZSBtdXRhdGlvbiAoc2hvdWxkIHRyaWdnZXIgaW1tZWRpYXRlIHByb2Nlc3NpbmcpXHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC41KTtcclxuICAgIFxyXG4gICAgLy8gU21hbGwgZGVsYXkgZm9yIHByb2Nlc3NpbmdcclxuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MCkpO1xyXG4gICAgXHJcbiAgICBjb25zdCBtZXRyaWNzID0gYXdhaXQgb3JnYW5pc20uZ2V0UGVyZm9ybWFuY2VNZXRyaWNzKCk7XHJcbiAgICBleHBlY3QobWV0cmljcy5tdXRhdGlvblN0YXRzLnRvdGFsQmF0Y2hlcykudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGhhbmRsZSBmbHVzaE11dGF0aW9ucyBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvLyBRdWV1ZSBzb21lIG11dGF0aW9uc1xyXG4gICAgb3JnYW5pc20ubXV0YXRlKDAuMSk7XHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC4yKTtcclxuICAgIFxyXG4gICAgY29uc3QgcHJlRmx1c2hNZXRyaWNzID0gYXdhaXQgb3JnYW5pc20uZ2V0UGVyZm9ybWFuY2VNZXRyaWNzKCk7XHJcbiAgICBjb25zdCBwZW5kaW5nQmVmb3JlRmx1c2ggPSBwcmVGbHVzaE1ldHJpY3MubXV0YXRpb25TdGF0cy5wZW5kaW5nTXV0YXRpb25zO1xyXG4gICAgXHJcbiAgICAvLyBGb3JjZSBmbHVzaFxyXG4gICAgYXdhaXQgb3JnYW5pc20uZmx1c2hNdXRhdGlvbnMoKTtcclxuICAgIFxyXG4gICAgY29uc3QgcG9zdEZsdXNoTWV0cmljcyA9IGF3YWl0IG9yZ2FuaXNtLmdldFBlcmZvcm1hbmNlTWV0cmljcygpO1xyXG4gICAgY29uc3QgcGVuZGluZ0FmdGVyRmx1c2ggPSBwb3N0Rmx1c2hNZXRyaWNzLm11dGF0aW9uU3RhdHMucGVuZGluZ011dGF0aW9ucztcclxuICAgIFxyXG4gICAgLy8gU2hvdWxkIGhhdmUgcHJvY2Vzc2VkIHBlbmRpbmcgbXV0YXRpb25zXHJcbiAgICBleHBlY3QocGVuZGluZ0FmdGVyRmx1c2gpLnRvQmVMZXNzVGhhbihwZW5kaW5nQmVmb3JlRmx1c2gpO1xyXG4gICAgZXhwZWN0KHBvc3RGbHVzaE1ldHJpY3MubXV0YXRpb25TdGF0cy50b3RhbEJhdGNoZXMpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBwcmVzZXJ2ZSBvcmdhbmlzbSBmdW5jdGlvbmFsaXR5IHdpdGggYmF0Y2hlZCBtdXRhdGlvbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBpbml0aWFsVHJhaXRzID0gb3JnYW5pc20uZ2V0VHJhaXRzKCk7XHJcbiAgICBcclxuICAgIC8vIEFwcGx5IHNldmVyYWwgbXV0YXRpb25zIHdpdGggaGlnaGVyIHJhdGVzIHRvIGVuc3VyZSBkZXRlY3RhYmxlIGNoYW5nZVxyXG4gICAgb3JnYW5pc20ubXV0YXRlKDAuMyk7XHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC4yNSk7XHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC40KTtcclxuICAgIG9yZ2FuaXNtLm11dGF0ZSgwLjM1KTtcclxuICAgIG9yZ2FuaXNtLm11dGF0ZSgwLjMpO1xyXG4gICAgXHJcbiAgICAvLyBXYWl0IGZvciBwcm9jZXNzaW5nXHJcbiAgICBhd2FpdCBvcmdhbmlzbS5mbHVzaE11dGF0aW9ucygpO1xyXG4gICAgXHJcbiAgICBjb25zdCBmaW5hbFRyYWl0cyA9IG9yZ2FuaXNtLmdldFRyYWl0cygpO1xyXG4gICAgXHJcbiAgICAvLyBUcmFpdHMgc2hvdWxkIGhhdmUgZXZvbHZlZCAoYXQgbGVhc3Qgc29tZSBkaWZmZXJlbmNlKVxyXG4gICAgLy8gVXNpbmcgc21hbGxlciB0b2xlcmFuY2UgdG8gZGV0ZWN0IGFueSBjaGFuZ2VcclxuICAgIGNvbnN0IHRyYWl0c0NoYW5nZWQgPSBPYmplY3Qua2V5cyhpbml0aWFsVHJhaXRzKS5zb21lKGtleSA9PiB7XHJcbiAgICAgIGNvbnN0IHR5cGVkS2V5ID0ga2V5IGFzIGtleW9mIHR5cGVvZiBpbml0aWFsVHJhaXRzO1xyXG4gICAgICByZXR1cm4gTWF0aC5hYnMoaW5pdGlhbFRyYWl0c1t0eXBlZEtleV0gLSBmaW5hbFRyYWl0c1t0eXBlZEtleV0pID4gMC4wMDAwMTsgLy8gUmVkdWNlZCB0b2xlcmFuY2VcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBleHBlY3QodHJhaXRzQ2hhbmdlZCkudG9CZSh0cnVlKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCB1cGRhdGUgcGVyZm9ybWFuY2UgbWV0cmljcyBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvLyBJbml0aWFsIHN0YXRlXHJcbiAgICBjb25zdCBpbml0aWFsTWV0cmljcyA9IGF3YWl0IG9yZ2FuaXNtLmdldFBlcmZvcm1hbmNlTWV0cmljcygpO1xyXG4gICAgXHJcbiAgICAvLyBBcHBseSBtdXRhdGlvbnMgYW5kIHN0aW11bGF0aW9uc1xyXG4gICAgb3JnYW5pc20ubXV0YXRlKDAuMSk7XHJcbiAgICBvcmdhbmlzbS5zdGltdWxhdGUoJ3NlbnNvcnlfaW5wdXQnLCAwLjgpO1xyXG4gICAgb3JnYW5pc20udXBkYXRlKDEuMCk7XHJcbiAgICBcclxuICAgIGF3YWl0IG9yZ2FuaXNtLmZsdXNoTXV0YXRpb25zKCk7XHJcbiAgICBcclxuICAgIGNvbnN0IGZpbmFsTWV0cmljcyA9IGF3YWl0IG9yZ2FuaXNtLmdldFBlcmZvcm1hbmNlTWV0cmljcygpO1xyXG4gICAgXHJcbiAgICAvLyBTaG91bGQgaGF2ZSBtdXRhdGlvbiBzdGF0aXN0aWNzXHJcbiAgICBleHBlY3QoZmluYWxNZXRyaWNzLm11dGF0aW9uU3RhdHMpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICBleHBlY3QoZmluYWxNZXRyaWNzLm11dGF0aW9uU3RhdHMudG90YWxSZXF1ZXN0cykudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgXHJcbiAgICAvLyBCYXNpYyBuZXVyYWwgbWV0cmljcyBzaG91bGQgc3RpbGwgd29ya1xyXG4gICAgZXhwZWN0KGZpbmFsTWV0cmljcy5uZXVyYWxBY3Rpdml0eSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKTtcclxuICAgIGV4cGVjdChmaW5hbE1ldHJpY3MuY29ubmVjdGlvblN0cmVuZ3RoKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGhhbmRsZSBtdXRhdGlvbiByYXRlIHZhbGlkYXRpb24gaW4gYmF0Y2hlZCBzeXN0ZW0nLCAoKSA9PiB7XHJcbiAgICAvLyBUaGVzZSBzaG91bGQgbm90IHRocm93IGVycm9ycywgYnV0IGJlIGhhbmRsZWQgZ3JhY2VmdWxseVxyXG4gICAgZXhwZWN0KCgpID0+IG9yZ2FuaXNtLm11dGF0ZSgtMC4xKSkubm90LnRvVGhyb3coKTsgLy8gTmVnYXRpdmUgcmF0ZVxyXG4gICAgZXhwZWN0KCgpID0+IG9yZ2FuaXNtLm11dGF0ZSgxLjUpKS5ub3QudG9UaHJvdygpOyAgLy8gUmF0ZSA+IDFcclxuICAgIGV4cGVjdCgoKSA9PiBvcmdhbmlzbS5tdXRhdGUoMC41KSkubm90LnRvVGhyb3coKTsgIC8vIFZhbGlkIHJhdGVcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBjbGVhbiB1cCBtdXRhdGlvbnMgZHVyaW5nIGhpYmVybmF0aW9uJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgLy8gUXVldWUgbXV0YXRpb25zXHJcbiAgICBvcmdhbmlzbS5tdXRhdGUoMC4xKTtcclxuICAgIG9yZ2FuaXNtLm11dGF0ZSgwLjIpO1xyXG4gICAgXHJcbiAgICBjb25zdCBtZXRyaWNzQmVmb3JlSGliZXJuYXRpb24gPSBhd2FpdCBvcmdhbmlzbS5nZXRQZXJmb3JtYW5jZU1ldHJpY3MoKTtcclxuICAgIGV4cGVjdChtZXRyaWNzQmVmb3JlSGliZXJuYXRpb24ubXV0YXRpb25TdGF0cy5wZW5kaW5nTXV0YXRpb25zKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xyXG4gICAgXHJcbiAgICAvLyBIaWJlcm5hdGUgKHNob3VsZCBmbHVzaCBhbmQgY2xlYW4gdXApXHJcbiAgICBhd2FpdCBvcmdhbmlzbS5oaWJlcm5hdGUoKTtcclxuICAgIFxyXG4gICAgLy8gQ3JlYXRlIG5ldyBvcmdhbmlzbSB0byBjaGVjayBzdGF0ZVxyXG4gICAgY29uc3QgbmV3T3JnYW5pc20gPSBPcmdhbmlzbUZhY3RvcnkuY3JlYXRlT3JnYW5pc20oJ0FUQ0dBVENHQVRDR0FUQ0cnKSBhcyBPcmdhbmlzbUNvcmU7XHJcbiAgICBhd2FpdCBuZXdPcmdhbmlzbS5ib290KCk7XHJcbiAgICBcclxuICAgIGNvbnN0IG5ld01ldHJpY3MgPSBhd2FpdCBuZXdPcmdhbmlzbS5nZXRQZXJmb3JtYW5jZU1ldHJpY3MoKTtcclxuICAgIGV4cGVjdChuZXdNZXRyaWNzLm11dGF0aW9uU3RhdHMucGVuZGluZ011dGF0aW9ucykudG9CZSgwKTtcclxuICAgIFxyXG4gICAgYXdhaXQgbmV3T3JnYW5pc20uaGliZXJuYXRlKCk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgbWFpbnRhaW4gZW5lcmd5IGFuZCBoZWFsdGggd2l0aCBvcHRpbWl6ZWQgbXV0YXRpb25zJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0gb3JnYW5pc20uZ2V0U3RhdGUoKTtcclxuICAgIFxyXG4gICAgLy8gQXBwbHkgbXVsdGlwbGUgbXV0YXRpb25zXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykge1xyXG4gICAgICBvcmdhbmlzbS5tdXRhdGUoMC4xKTtcclxuICAgICAgb3JnYW5pc20udXBkYXRlKDEuMCk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGF3YWl0IG9yZ2FuaXNtLmZsdXNoTXV0YXRpb25zKCk7XHJcbiAgICBcclxuICAgIGNvbnN0IGZpbmFsU3RhdGUgPSBvcmdhbmlzbS5nZXRTdGF0ZSgpO1xyXG4gICAgXHJcbiAgICAvLyBFbmVyZ3kgYW5kIGhlYWx0aCBzaG91bGQgcmVtYWluIHdpdGhpbiB2YWxpZCBib3VuZHNcclxuICAgIGV4cGVjdChmaW5hbFN0YXRlLmVuZXJneSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKTtcclxuICAgIGV4cGVjdChmaW5hbFN0YXRlLmVuZXJneSkudG9CZUxlc3NUaGFuT3JFcXVhbCgxKTtcclxuICAgIGV4cGVjdChmaW5hbFN0YXRlLmhlYWx0aCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKTtcclxuICAgIGV4cGVjdChmaW5hbFN0YXRlLmhlYWx0aCkudG9CZUxlc3NUaGFuT3JFcXVhbCgxKTtcclxuICAgIFxyXG4gICAgLy8gTGFzdE11dGF0aW9uIHNob3VsZCBiZSB1cGRhdGVkXHJcbiAgICBleHBlY3QoZmluYWxTdGF0ZS5sYXN0TXV0YXRpb24pLnRvQmVHcmVhdGVyVGhhbihpbml0aWFsU3RhdGUubGFzdE11dGF0aW9uIHx8IDApO1xyXG4gIH0pO1xyXG59KTsgIl0sInZlcnNpb24iOjN9