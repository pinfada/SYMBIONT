25253a0bb35aaf57a832b9e0922242c8
"use strict";
/**
 * Tests pour les utilitaires de génération sécurisée de nombres aléatoires
 */
Object.defineProperty(exports, "__esModule", { value: true });
const secureRandom_1 = require("../../src/shared/utils/secureRandom");
// Mock crypto.getRandomValues pour les tests
const mockGetRandomValues = jest.fn();
Object.defineProperty(global, 'crypto', {
    value: {
        getRandomValues: mockGetRandomValues,
    },
    writable: true,
});
describe('SecureRandom', () => {
    beforeEach(() => {
        mockGetRandomValues.mockClear();
    });
    describe('random()', () => {
        it('should return a number between 0 and 1', () => {
            // Mock crypto.getRandomValues to return a known value
            mockGetRandomValues.mockImplementation((array) => {
                array[0] = 0x80000000; // Half of MAX_UINT32
                return array;
            });
            const result = secureRandom_1.SecureRandom.random();
            expect(result).toBeGreaterThanOrEqual(0);
            expect(result).toBeLessThan(1);
            expect(typeof result).toBe('number');
        });
        it('should use crypto.getRandomValues when available', () => {
            mockGetRandomValues.mockImplementation((array) => {
                array[0] = 0x12345678;
                return array;
            });
            secureRandom_1.SecureRandom.random();
            expect(mockGetRandomValues).toHaveBeenCalledWith(expect.any(Uint32Array));
        });
        it('should fall back to Math.random when crypto is not available', () => {
            // Temporarily remove crypto
            const originalCrypto = global.crypto;
            delete global.crypto;
            const mathRandomSpy = jest.spyOn(Math, 'random').mockReturnValue(0.5);
            const consoleWarnSpy = jest.spyOn(console, 'warn').mockImplementation();
            const result = secureRandom_1.SecureRandom.random();
            expect(result).toBe(0.5);
            expect(mathRandomSpy).toHaveBeenCalled();
            expect(consoleWarnSpy).toHaveBeenCalledWith('SecureRandom: crypto.getRandomValues non disponible, utilisation de Math.random()');
            // Restore
            global.crypto = originalCrypto;
            mathRandomSpy.mockRestore();
            consoleWarnSpy.mockRestore();
        });
    });
    describe('randomInt()', () => {
        beforeEach(() => {
            mockGetRandomValues.mockImplementation((array) => {
                array[0] = 0x40000000; // Quarter of MAX_UINT32
                return array;
            });
        });
        it('should return integer within specified range', () => {
            const result = secureRandom_1.SecureRandom.randomInt(5, 15);
            expect(Number.isInteger(result)).toBe(true);
            expect(result).toBeGreaterThanOrEqual(5);
            expect(result).toBeLessThan(15);
        });
        it('should throw error if min >= max', () => {
            expect(() => secureRandom_1.SecureRandom.randomInt(10, 5)).toThrow('SecureRandom: min doit être inférieur à max');
            expect(() => secureRandom_1.SecureRandom.randomInt(5, 5)).toThrow('SecureRandom: min doit être inférieur à max');
        });
    });
    describe('randomFloat()', () => {
        beforeEach(() => {
            mockGetRandomValues.mockImplementation((array) => {
                array[0] = 0x40000000; // Quarter of MAX_UINT32 (0.25)
                return array;
            });
        });
        it('should return float within specified range', () => {
            const result = secureRandom_1.SecureRandom.randomFloat(1.0, 3.0);
            expect(typeof result).toBe('number');
            expect(result).toBeGreaterThanOrEqual(1.0);
            expect(result).toBeLessThan(3.0);
        });
        it('should throw error if min >= max', () => {
            expect(() => secureRandom_1.SecureRandom.randomFloat(3.0, 1.0)).toThrow('SecureRandom: min doit être inférieur à max');
        });
    });
    describe('randomBytes()', () => {
        it('should return Uint8Array of specified length', () => {
            mockGetRandomValues.mockImplementation((array) => {
                for (let i = 0; i < array.length; i++) {
                    array[i] = i % 256;
                }
                return array;
            });
            const result = secureRandom_1.SecureRandom.randomBytes(10);
            expect(result).toBeInstanceOf(Uint8Array);
            expect(result.length).toBe(10);
            expect(mockGetRandomValues).toHaveBeenCalledWith(expect.any(Uint8Array));
        });
        it('should fall back when crypto is not available', () => {
            const originalCrypto = global.crypto;
            delete global.crypto;
            const consoleWarnSpy = jest.spyOn(console, 'warn').mockImplementation();
            const mathRandomSpy = jest.spyOn(Math, 'random').mockReturnValue(0.5);
            const result = secureRandom_1.SecureRandom.randomBytes(5);
            expect(result).toBeInstanceOf(Uint8Array);
            expect(result.length).toBe(5);
            expect(consoleWarnSpy).toHaveBeenCalledWith('SecureRandom: crypto.getRandomValues non disponible, génération fallback');
            // Restore
            global.crypto = originalCrypto;
            consoleWarnSpy.mockRestore();
            mathRandomSpy.mockRestore();
        });
    });
    describe('choice()', () => {
        beforeEach(() => {
            mockGetRandomValues.mockImplementation((array) => {
                array[0] = 0x40000000; // Should select index 1 of 4 elements
                return array;
            });
        });
        it('should return an element from the array', () => {
            const array = ['a', 'b', 'c', 'd'];
            const result = secureRandom_1.SecureRandom.choice(array);
            expect(array).toContain(result);
        });
        it('should throw error for empty array', () => {
            expect(() => secureRandom_1.SecureRandom.choice([])).toThrow('SecureRandom: Le tableau ne peut pas être vide');
        });
    });
    describe('uuid()', () => {
        it('should return valid UUID v4 format', () => {
            mockGetRandomValues.mockImplementation((array) => {
                for (let i = 0; i < array.length; i++) {
                    array[i] = i + 0x10;
                }
                return array;
            });
            const result = secureRandom_1.SecureRandom.uuid();
            expect(typeof result).toBe('string');
            expect(result).toMatch(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i);
        });
        it('should fall back to Math.random when crypto is not available', () => {
            const originalCrypto = global.crypto;
            delete global.crypto;
            const consoleWarnSpy = jest.spyOn(console, 'warn').mockImplementation();
            const mathRandomSpy = jest.spyOn(Math, 'random').mockReturnValue(0.5);
            const result = secureRandom_1.SecureRandom.uuid();
            expect(typeof result).toBe('string');
            expect(result).toMatch(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i);
            expect(consoleWarnSpy).toHaveBeenCalledWith('SecureRandom: crypto.getRandomValues non disponible, UUID fallback');
            // Restore
            global.crypto = originalCrypto;
            consoleWarnSpy.mockRestore();
            mathRandomSpy.mockRestore();
        });
    });
    describe('randomString()', () => {
        beforeEach(() => {
            mockGetRandomValues.mockImplementation((array) => {
                array[0] = 0x10000000; // Should select predictable characters
                return array;
            });
        });
        it('should return string of specified length', () => {
            const result = secureRandom_1.SecureRandom.randomString(10);
            expect(typeof result).toBe('string');
            expect(result.length).toBe(10);
        });
        it('should use custom charset', () => {
            const charset = 'ABC';
            const result = secureRandom_1.SecureRandom.randomString(5, charset);
            expect(result.length).toBe(5);
            for (const char of result) {
                expect(charset).toContain(char);
            }
        });
    });
    describe('randomId()', () => {
        beforeEach(() => {
            mockGetRandomValues.mockImplementation((array) => {
                array[0] = 0x10000000;
                return array;
            });
        });
        it('should return ID with prefix', () => {
            const result = secureRandom_1.SecureRandom.randomId('test', 6);
            expect(result).toMatch(/^test_[A-Za-z0-9]{6}$/);
        });
        it('should return ID without prefix', () => {
            const result = secureRandom_1.SecureRandom.randomId('', 8);
            expect(result).toMatch(/^[A-Za-z0-9]{8}$/);
        });
        it('should use default length', () => {
            const result = secureRandom_1.SecureRandom.randomId('prefix');
            expect(result).toMatch(/^prefix_[A-Za-z0-9]{8}$/);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL3dvcmtzcGFjZXMvU1lNQklPTlQvX190ZXN0c19fL3NlY3VyaXR5L3NlY3VyZVJhbmRvbS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSCxzRUFBbUU7QUFFbkUsNkNBQTZDO0FBQzdDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3RDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRTtJQUN0QyxLQUFLLEVBQUU7UUFDTCxlQUFlLEVBQUUsbUJBQW1CO0tBQ3JDO0lBQ0QsUUFBUSxFQUFFLElBQUk7Q0FDZixDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtJQUM1QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsbUJBQW1CLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtRQUN4QixFQUFFLENBQUMsd0NBQXdDLEVBQUUsR0FBRyxFQUFFO1lBQ2hELHNEQUFzRDtZQUN0RCxtQkFBbUIsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO2dCQUMvQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxDQUFDLENBQUMscUJBQXFCO2dCQUM1QyxPQUFPLEtBQUssQ0FBQztZQUNmLENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxNQUFNLEdBQUcsMkJBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNyQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixNQUFNLENBQUMsT0FBTyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsa0RB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YW1lcyI6W10sInNvdXJjZXMiOlsiL3dvcmtzcGFjZXMvU1lNQklPTlQvX190ZXN0c19fL3NlY3VyaXR5L3NlY3VyZVJhbmRvbS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdHMgcG91ciBsZXMgdXRpbGl0YWlyZXMgZGUgZ8OpbsOpcmF0aW9uIHPDqWN1cmlzw6llIGRlIG5vbWJyZXMgYWzDqWF0b2lyZXNcbiAqL1xuXG5pbXBvcnQgeyBTZWN1cmVSYW5kb20gfSBmcm9tICcuLi8uLi9zcmMvc2hhcmVkL3V0aWxzL3NlY3VyZVJhbmRvbSc7XG5cbi8vIE1vY2sgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyBwb3VyIGxlcyB0ZXN0c1xuY29uc3QgbW9ja0dldFJhbmRvbVZhbHVlcyA9IGplc3QuZm4oKTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShnbG9iYWwsICdjcnlwdG8nLCB7XG4gIHZhbHVlOiB7XG4gICAgZ2V0UmFuZG9tVmFsdWVzOiBtb2NrR2V0UmFuZG9tVmFsdWVzLFxuICB9LFxuICB3cml0YWJsZTogdHJ1ZSxcbn0pO1xuXG5kZXNjcmliZSgnU2VjdXJlUmFuZG9tJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBtb2NrR2V0UmFuZG9tVmFsdWVzLm1vY2tDbGVhcigpO1xuICB9KTtcblxuICBkZXNjcmliZSgncmFuZG9tKCknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYSBudW1iZXIgYmV0d2VlbiAwIGFuZCAxJywgKCkgPT4ge1xuICAgICAgLy8gTW9jayBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzIHRvIHJldHVybiBhIGtub3duIHZhbHVlXG4gICAgICBtb2NrR2V0UmFuZG9tVmFsdWVzLm1vY2tJbXBsZW1lbnRhdGlvbigoYXJyYXkpID0+IHtcbiAgICAgICAgYXJyYXlbMF0gPSAweDgwMDAwMDAwOyAvLyBIYWxmIG9mIE1BWF9VSU5UMzJcbiAgICAgICAgcmV0dXJuIGFycmF5O1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IFNlY3VyZVJhbmRvbS5yYW5kb20oKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTGVzc1RoYW4oMSk7XG4gICAgICBleHBlY3QodHlwZW9mIHJlc3VsdCkudG9CZSgnbnVtYmVyJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVzZSBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzIHdoZW4gYXZhaWxhYmxlJywgKCkgPT4ge1xuICAgICAgbW9ja0dldFJhbmRvbVZhbHVlcy5tb2NrSW1wbGVtZW50YXRpb24oKGFycmF5KSA9PiB7XG4gICAgICAgIGFycmF5WzBdID0gMHgxMjM0NTY3ODtcbiAgICAgICAgcmV0dXJuIGFycmF5O1xuICAgICAgfSk7XG5cbiAgICAgIFNlY3VyZVJhbmRvbS5yYW5kb20oKTtcbiAgICAgIGV4cGVjdChtb2NrR2V0UmFuZG9tVmFsdWVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3QuYW55KFVpbnQzMkFycmF5KSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZhbGwgYmFjayB0byBNYXRoLnJhbmRvbSB3aGVuIGNyeXB0byBpcyBub3QgYXZhaWxhYmxlJywgKCkgPT4ge1xuICAgICAgLy8gVGVtcG9yYXJpbHkgcmVtb3ZlIGNyeXB0b1xuICAgICAgY29uc3Qgb3JpZ2luYWxDcnlwdG8gPSBnbG9iYWwuY3J5cHRvO1xuICAgICAgZGVsZXRlIChnbG9iYWwgYXMgYW55KS5jcnlwdG87XG5cbiAgICAgIGNvbnN0IG1hdGhSYW5kb21TcHkgPSBqZXN0LnNweU9uKE1hdGgsICdyYW5kb20nKS5tb2NrUmV0dXJuVmFsdWUoMC41KTtcbiAgICAgIGNvbnN0IGNvbnNvbGVXYXJuU3B5ID0gamVzdC5zcHlPbihjb25zb2xlLCAnd2FybicpLm1vY2tJbXBsZW1lbnRhdGlvbigpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBTZWN1cmVSYW5kb20ucmFuZG9tKCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoMC41KTtcbiAgICAgIGV4cGVjdChtYXRoUmFuZG9tU3B5KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QoY29uc29sZVdhcm5TcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnU2VjdXJlUmFuZG9tOiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzIG5vbiBkaXNwb25pYmxlLCB1dGlsaXNhdGlvbiBkZSBNYXRoLnJhbmRvbSgpJ1xuICAgICAgKTtcblxuICAgICAgLy8gUmVzdG9yZVxuICAgICAgZ2xvYmFsLmNyeXB0byA9IG9yaWdpbmFsQ3J5cHRvO1xuICAgICAgbWF0aFJhbmRvbVNweS5tb2NrUmVzdG9yZSgpO1xuICAgICAgY29uc29sZVdhcm5TcHkubW9ja1Jlc3RvcmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3JhbmRvbUludCgpJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgbW9ja0dldFJhbmRvbVZhbHVlcy5tb2NrSW1wbGVtZW50YXRpb24oKGFycmF5KSA9PiB7XG4gICAgICAgIGFycmF5WzBdID0gMHg0MDAwMDAwMDsgLy8gUXVhcnRlciBvZiBNQVhfVUlOVDMyXG4gICAgICAgIHJldHVybiBhcnJheTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gaW50ZWdlciB3aXRoaW4gc3BlY2lmaWVkIHJhbmdlJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnJhbmRvbUludCg1LCAxNSk7XG4gICAgICBleHBlY3QoTnVtYmVyLmlzSW50ZWdlcihyZXN1bHQpKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCg1KTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVMZXNzVGhhbigxNSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGlmIG1pbiA+PSBtYXgnLCAoKSA9PiB7XG4gICAgICBleHBlY3QoKCkgPT4gU2VjdXJlUmFuZG9tLnJhbmRvbUludCgxMCwgNSkpLnRvVGhyb3coXG4gICAgICAgICdTZWN1cmVSYW5kb206IG1pbiBkb2l0IMOqdHJlIGluZsOpcmlldXIgw6AgbWF4J1xuICAgICAgKTtcbiAgICAgIGV4cGVjdCgoKSA9PiBTZWN1cmVSYW5kb20ucmFuZG9tSW50KDUsIDUpKS50b1Rocm93KFxuICAgICAgICAnU2VjdXJlUmFuZG9tOiBtaW4gZG9pdCDDqnRyZSBpbmbDqXJpZXVyIMOgIG1heCdcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyYW5kb21GbG9hdCgpJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgbW9ja0dldFJhbmRvbVZhbHVlcy5tb2NrSW1wbGVtZW50YXRpb24oKGFycmF5KSA9PiB7XG4gICAgICAgIGFycmF5WzBdID0gMHg0MDAwMDAwMDsgLy8gUXVhcnRlciBvZiBNQVhfVUlOVDMyICgwLjI1KVxuICAgICAgICByZXR1cm4gYXJyYXk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZsb2F0IHdpdGhpbiBzcGVjaWZpZWQgcmFuZ2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBTZWN1cmVSYW5kb20ucmFuZG9tRmxvYXQoMS4wLCAzLjApO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQpLnRvQmUoJ251bWJlcicpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgxLjApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZUxlc3NUaGFuKDMuMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGlmIG1pbiA+PSBtYXgnLCAoKSA9PiB7XG4gICAgICBleHBlY3QoKCkgPT4gU2VjdXJlUmFuZG9tLnJhbmRvbUZsb2F0KDMuMCwgMS4wKSkudG9UaHJvdyhcbiAgICAgICAgJ1NlY3VyZVJhbmRvbTogbWluIGRvaXQgw6p0cmUgaW5mw6lyaWV1ciDDoCBtYXgnXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmFuZG9tQnl0ZXMoKScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBVaW50OEFycmF5IG9mIHNwZWNpZmllZCBsZW5ndGgnLCAoKSA9PiB7XG4gICAgICBtb2NrR2V0UmFuZG9tVmFsdWVzLm1vY2tJbXBsZW1lbnRhdGlvbigoYXJyYXkpID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGFycmF5W2ldID0gaSAlIDI1NjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYXJyYXk7XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnJhbmRvbUJ5dGVzKDEwKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVJbnN0YW5jZU9mKFVpbnQ4QXJyYXkpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5sZW5ndGgpLnRvQmUoMTApO1xuICAgICAgZXhwZWN0KG1vY2tHZXRSYW5kb21WYWx1ZXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5hbnkoVWludDhBcnJheSkpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmYWxsIGJhY2sgd2hlbiBjcnlwdG8gaXMgbm90IGF2YWlsYWJsZScsICgpID0+IHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsQ3J5cHRvID0gZ2xvYmFsLmNyeXB0bztcbiAgICAgIGRlbGV0ZSAoZ2xvYmFsIGFzIGFueSkuY3J5cHRvO1xuXG4gICAgICBjb25zdCBjb25zb2xlV2FyblNweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ3dhcm4nKS5tb2NrSW1wbGVtZW50YXRpb24oKTtcbiAgICAgIGNvbnN0IG1hdGhSYW5kb21TcHkgPSBqZXN0LnNweU9uKE1hdGgsICdyYW5kb20nKS5tb2NrUmV0dXJuVmFsdWUoMC41KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnJhbmRvbUJ5dGVzKDUpO1xuICAgICAgXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlSW5zdGFuY2VPZihVaW50OEFycmF5KTtcbiAgICAgIGV4cGVjdChyZXN1bHQubGVuZ3RoKS50b0JlKDUpO1xuICAgICAgZXhwZWN0KGNvbnNvbGVXYXJuU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ1NlY3VyZVJhbmRvbTogY3J5cHRvLmdldFJhbmRvbVZhbHVlcyBub24gZGlzcG9uaWJsZSwgZ8OpbsOpcmF0aW9uIGZhbGxiYWNrJ1xuICAgICAgKTtcblxuICAgICAgLy8gUmVzdG9yZVxuICAgICAgZ2xvYmFsLmNyeXB0byA9IG9yaWdpbmFsQ3J5cHRvO1xuICAgICAgY29uc29sZVdhcm5TcHkubW9ja1Jlc3RvcmUoKTtcbiAgICAgIG1hdGhSYW5kb21TcHkubW9ja1Jlc3RvcmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Nob2ljZSgpJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgbW9ja0dldFJhbmRvbVZhbHVlcy5tb2NrSW1wbGVtZW50YXRpb24oKGFycmF5KSA9PiB7XG4gICAgICAgIGFycmF5WzBdID0gMHg0MDAwMDAwMDsgLy8gU2hvdWxkIHNlbGVjdCBpbmRleCAxIG9mIDQgZWxlbWVudHNcbiAgICAgICAgcmV0dXJuIGFycmF5O1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBhbiBlbGVtZW50IGZyb20gdGhlIGFycmF5JywgKCkgPT4ge1xuICAgICAgY29uc3QgYXJyYXkgPSBbJ2EnLCAnYicsICdjJywgJ2QnXTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFNlY3VyZVJhbmRvbS5jaG9pY2UoYXJyYXkpO1xuICAgICAgZXhwZWN0KGFycmF5KS50b0NvbnRhaW4ocmVzdWx0KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIGVtcHR5IGFycmF5JywgKCkgPT4ge1xuICAgICAgZXhwZWN0KCgpID0+IFNlY3VyZVJhbmRvbS5jaG9pY2UoW10pKS50b1Rocm93KFxuICAgICAgICAnU2VjdXJlUmFuZG9tOiBMZSB0YWJsZWF1IG5lIHBldXQgcGFzIMOqdHJlIHZpZGUnXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgndXVpZCgpJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIHZhbGlkIFVVSUQgdjQgZm9ybWF0JywgKCkgPT4ge1xuICAgICAgbW9ja0dldFJhbmRvbVZhbHVlcy5tb2NrSW1wbGVtZW50YXRpb24oKGFycmF5KSA9PiB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBhcnJheVtpXSA9IGkgKyAweDEwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhcnJheTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBTZWN1cmVSYW5kb20udXVpZCgpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQpLnRvQmUoJ3N0cmluZycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaChcbiAgICAgICAgL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS00WzAtOWEtZl17M30tWzg5YWJdWzAtOWEtZl17M30tWzAtOWEtZl17MTJ9JC9pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmYWxsIGJhY2sgdG8gTWF0aC5yYW5kb20gd2hlbiBjcnlwdG8gaXMgbm90IGF2YWlsYWJsZScsICgpID0+IHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsQ3J5cHRvID0gZ2xvYmFsLmNyeXB0bztcbiAgICAgIGRlbGV0ZSAoZ2xvYmFsIGFzIGFueSkuY3J5cHRvO1xuXG4gICAgICBjb25zdCBjb25zb2xlV2FyblNweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ3dhcm4nKS5tb2NrSW1wbGVtZW50YXRpb24oKTtcbiAgICAgIGNvbnN0IG1hdGhSYW5kb21TcHkgPSBqZXN0LnNweU9uKE1hdGgsICdyYW5kb20nKS5tb2NrUmV0dXJuVmFsdWUoMC41KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnV1aWQoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQpLnRvQmUoJ3N0cmluZycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9NYXRjaChcbiAgICAgICAgL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS00WzAtOWEtZl17M30tWzg5YWJdWzAtOWEtZl17M30tWzAtOWEtZl17MTJ9JC9pXG4gICAgICApO1xuICAgICAgZXhwZWN0KGNvbnNvbGVXYXJuU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ1NlY3VyZVJhbmRvbTogY3J5cHRvLmdldFJhbmRvbVZhbHVlcyBub24gZGlzcG9uaWJsZSwgVVVJRCBmYWxsYmFjaydcbiAgICAgICk7XG5cbiAgICAgIC8vIFJlc3RvcmVcbiAgICAgIGdsb2JhbC5jcnlwdG8gPSBvcmlnaW5hbENyeXB0bztcbiAgICAgIGNvbnNvbGVXYXJuU3B5Lm1vY2tSZXN0b3JlKCk7XG4gICAgICBtYXRoUmFuZG9tU3B5Lm1vY2tSZXN0b3JlKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyYW5kb21TdHJpbmcoKScsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIG1vY2tHZXRSYW5kb21WYWx1ZXMubW9ja0ltcGxlbWVudGF0aW9uKChhcnJheSkgPT4ge1xuICAgICAgICBhcnJheVswXSA9IDB4MTAwMDAwMDA7IC8vIFNob3VsZCBzZWxlY3QgcHJlZGljdGFibGUgY2hhcmFjdGVyc1xuICAgICAgICByZXR1cm4gYXJyYXk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHN0cmluZyBvZiBzcGVjaWZpZWQgbGVuZ3RoJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnJhbmRvbVN0cmluZygxMCk7XG4gICAgICBleHBlY3QodHlwZW9mIHJlc3VsdCkudG9CZSgnc3RyaW5nJyk7XG4gICAgICBleHBlY3QocmVzdWx0Lmxlbmd0aCkudG9CZSgxMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVzZSBjdXN0b20gY2hhcnNldCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGNoYXJzZXQgPSAnQUJDJztcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFNlY3VyZVJhbmRvbS5yYW5kb21TdHJpbmcoNSwgY2hhcnNldCk7XG4gICAgICBleHBlY3QocmVzdWx0Lmxlbmd0aCkudG9CZSg1KTtcbiAgICAgIGZvciAoY29uc3QgY2hhciBvZiByZXN1bHQpIHtcbiAgICAgICAgZXhwZWN0KGNoYXJzZXQpLnRvQ29udGFpbihjaGFyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3JhbmRvbUlkKCknLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBtb2NrR2V0UmFuZG9tVmFsdWVzLm1vY2tJbXBsZW1lbnRhdGlvbigoYXJyYXkpID0+IHtcbiAgICAgICAgYXJyYXlbMF0gPSAweDEwMDAwMDAwO1xuICAgICAgICByZXR1cm4gYXJyYXk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIElEIHdpdGggcHJlZml4JywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnJhbmRvbUlkKCd0ZXN0JywgNik7XG4gICAgICBleHBlY3QocmVzdWx0KS50b01hdGNoKC9edGVzdF9bQS1aYS16MC05XXs2fSQvKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIElEIHdpdGhvdXQgcHJlZml4JywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnJhbmRvbUlkKCcnLCA4KTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2goL15bQS1aYS16MC05XXs4fSQvKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXNlIGRlZmF1bHQgbGVuZ3RoJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gU2VjdXJlUmFuZG9tLnJhbmRvbUlkKCdwcmVmaXgnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2goL15wcmVmaXhfW0EtWmEtejAtOV17OH0kLyk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9