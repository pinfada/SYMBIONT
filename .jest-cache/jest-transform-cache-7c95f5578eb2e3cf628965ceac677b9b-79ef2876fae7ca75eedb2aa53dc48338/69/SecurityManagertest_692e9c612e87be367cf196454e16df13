831e1f1e4767ea3d4cb6af4c097cad7e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('../src/background/service-worker-adapter', () => ({
    swCryptoAPI: {
        subtle: mockCryptoSubtle,
        getRandomValues: mockCryptoGetRandomValues
    }
}));
// Mock service-worker-adapter before importing SecurityManager
const mockCryptoSubtle = {
    generateKey: jest.fn().mockResolvedValue({
        type: 'secret',
        extractable: true,
        algorithm: { name: 'AES-GCM', length: 256 },
        usages: ['encrypt', 'decrypt']
    }),
    importKey: jest.fn().mockResolvedValue({
        type: 'secret',
        extractable: true,
        algorithm: { name: 'AES-GCM', length: 256 },
        usages: ['encrypt', 'decrypt']
    }),
    exportKey: jest.fn().mockResolvedValue(new ArrayBuffer(32)),
    encrypt: jest.fn().mockImplementation(async (algorithm, key, data) => {
        // Simulate realistic encryption result
        const iv = new Uint8Array(12);
        iv.fill(0xAA);
        const ciphertext = new Uint8Array(data.byteLength + 16); // Add some auth tag bytes
        ciphertext.fill(0xBB);
        return ciphertext.buffer;
    }),
    decrypt: jest.fn().mockImplementation(async () => {
        const testData = JSON.stringify({ foo: 'bar', n: 42 });
        return new TextEncoder().encode(testData).buffer;
    }),
    digest: jest.fn().mockImplementation(async () => {
        const hash = new Uint8Array(32);
        hash.fill(0xCD);
        return hash.buffer;
    })
};
const mockCryptoGetRandomValues = jest.fn((arr) => {
    // Fill with deterministic values for testing
    for (let i = 0; i < arr.length; i++) {
        arr[i] = i % 256;
    }
    return arr;
});
const SecurityManager_1 = require("../src/background/SecurityManager");
describe('SecurityManager', () => {
    let security;
    beforeEach(async () => {
        jest.clearAllMocks();
        // Reset all crypto mocks
        mockCryptoSubtle.generateKey.mockClear();
        mockCryptoSubtle.encrypt.mockClear();
        mockCryptoSubtle.decrypt.mockClear();
        mockCryptoSubtle.digest.mockClear();
        mockCryptoGetRandomValues.mockClear();
        // Create SecurityManager with manual initialization to avoid chrome.storage issues
        security = new SecurityManager_1.SecurityManager(true); // Skip auto-init
        // Manually set the encryption key for testing
        security.encryptionKey = {
            type: 'secret',
            extractable: true,
            algorithm: { name: 'AES-GCM', length: 256 },
            usages: ['encrypt', 'decrypt']
        };
    });
    describe('Chiffrement/Déchiffrement', () => {
        it('chiffre et déchiffre correctement les données', async () => {
            const testData = { foo: 'bar', n: 42 };
            // Test encryption
            const encrypted = await security.encryptSensitiveData(testData);
            expect(typeof encrypted).toBe('string');
            expect(encrypted.length).toBeGreaterThan(0);
            expect(mockCryptoSubtle.encrypt).toHaveBeenCalled();
            // Test decryption  
            const decrypted = await security.decryptSensitiveData(encrypted);
            expect(decrypted).toEqual(testData);
            expect(mockCryptoSubtle.decrypt).toHaveBeenCalled();
        });
        it('gère les erreurs de chiffrement gracieusement', async () => {
            mockCryptoSubtle.encrypt.mockRejectedValue(new Error('Crypto failure'));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('Échec du chiffrement des données sensibles');
        });
        it('gère les erreurs de déchiffrement gracieusement', async () => {
            mockCryptoSubtle.decrypt.mockRejectedValue(new Error('Decrypt failure'));
            await expect(security.decryptSensitiveData('invalid')).rejects.toThrow('Échec du déchiffrement des données');
        });
    });
    describe('Anonymisation', () => {
        it('anonymise les données comportementales (async)', async () => {
            const pattern = {
                url: 'https://secret.com',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.interactions).toBe(pattern.interactions);
            expect(anonymized.timeSpent).toBe(pattern.timeSpent);
            expect(anonymized.scrollDepth).toBe(pattern.scrollDepth);
        });
        it('anonymise les données comportementales (sync)', () => {
            const pattern = {
                url: 'https://secret.com',
                userId: 'user123',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = security.anonymizeForSharingSync(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.userId).not.toBe('user123'); // Hashé
            expect(typeof anonymized.userId).toBe('string');
        });
        it('supprime les champs sensibles', async () => {
            const pattern = {
                url: 'https://secret.com',
                email: 'test@example.com',
                name: 'John Doe',
                phone: '123456789',
                interactions: 5
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.email).toBeUndefined();
            expect(anonymized.name).toBeUndefined();
            expect(anonymized.phone).toBeUndefined();
            expect(anonymized.interactions).toBe(5);
        });
    });
    describe('Contrôle d\'accès', () => {
        it('valide l\'accès utilisateur basique', () => {
            const request = { userId: 'user123', resource: 'organisms' };
            expect(security.validateDataAccess(request)).toBe(true);
        });
        it('rejette l\'accès admin sans rôle admin', () => {
            const request = { userId: 'user123', resource: 'admin', role: 'user' };
            expect(security.validateDataAccess(request, 'admin')).toBe(false);
        });
        it('accepte l\'accès admin avec rôle admin', () => {
            const request = { userId: 'admin123', resource: 'admin', role: 'admin' };
            expect(security.validateDataAccess(request, 'admin')).toBe(true);
        });
        it('rejette les requêtes invalides', () => {
            expect(security.validateDataAccess({ userId: '', resource: 'test' })).toBe(false);
            expect(security.validateDataAccess({ userId: 'user', resource: '' })).toBe(false);
        });
    });
    describe('Hashage', () => {
        it('hash des chaînes avec SHA-256', async () => {
            const testString = 'test-string';
            const hash = await security.hash(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
            expect(mockCryptoSubtle.digest).toHaveBeenCalledWith('SHA-256', expect.any(Uint8Array));
        });
        it('produit des hashs cohérents', async () => {
            const testString = 'consistent-test';
            const hash1 = await security.hash(testString);
            const hash2 = await security.hash(testString);
            expect(hash1).toBe(hash2);
        });
        it('hash sync fonctionne comme fallback', () => {
            const testString = 'sync-test';
            const hash = security.hashSync(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
        });
    });
    describe('Initialisation', () => {
        it('peut être créé sans auto-initialisation', () => {
            const testSecurity = new SecurityManager_1.SecurityManager(true);
            expect(testSecurity).toBeInstanceOf(SecurityManager_1.SecurityManager);
        });
        it('gère gracieusement l\'absence de clé lors des opérations', async () => {
            const testSecurity = new SecurityManager_1.SecurityManager(true);
            // Sans clé définie, devrait essayer d'initialiser puis échouer proprement
            await expect(testSecurity.encryptSensitiveData({})).rejects.toThrow();
        });
        it('valide la présence de WebCrypto API', async () => {
            // Temporarily disable the crypto API
            const originalSubtle = mockCryptoSubtle;
            jest.doMock('../src/background/service-worker-adapter', () => ({
                swCryptoAPI: null
            }));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('WebCrypto API non disponible');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvX190ZXN0c19fL1NlY3VyaXR5TWFuYWdlci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBMENBLElBQUksQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMzRCxXQUFXLEVBQUU7UUFDWCxNQUFNLEVBQUUsZ0JBQWdCO1FBQ3hCLGVBQWUsRUFBRSx5QkFBeUI7S0FDM0M7Q0FDRixDQUFDLENBQUMsQ0FBQztBQS9DSiwrREFBK0Q7QUFDL0QsTUFBTSxnQkFBZ0IsR0FBRztJQUN2QixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO1FBQ3ZDLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLElBQUk7UUFDakIsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFO1FBQzNDLE1BQU0sRUFBRSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUM7S0FDbEIsQ0FBQztJQUNmLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUM7UUFDckMsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUU7UUFDM0MsTUFBTSxFQUFFLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQztLQUNsQixDQUFDO0lBQ2YsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ25FLHVDQUF1QztRQUN2QyxNQUFNLEVBQUUsR0FB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QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvbW50L2MvVXNlcnMvbV9vbGkvUHJvamV0cy9TWU1CSU9OVC9fX3Rlc3RzX18vU2VjdXJpdHlNYW5hZ2VyLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gTW9jayBzZXJ2aWNlLXdvcmtlci1hZGFwdGVyIGJlZm9yZSBpbXBvcnRpbmcgU2VjdXJpdHlNYW5hZ2VyXHJcbmNvbnN0IG1vY2tDcnlwdG9TdWJ0bGUgPSB7XHJcbiAgZ2VuZXJhdGVLZXk6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IFxyXG4gICAgdHlwZTogJ3NlY3JldCcsIFxyXG4gICAgZXh0cmFjdGFibGU6IHRydWUsIFxyXG4gICAgYWxnb3JpdGhtOiB7IG5hbWU6ICdBRVMtR0NNJywgbGVuZ3RoOiAyNTYgfSwgXHJcbiAgICB1c2FnZXM6IFsnZW5jcnlwdCcsICdkZWNyeXB0J10gXHJcbiAgfSBhcyBDcnlwdG9LZXkpLFxyXG4gIGltcG9ydEtleTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgXHJcbiAgICB0eXBlOiAnc2VjcmV0JywgXHJcbiAgICBleHRyYWN0YWJsZTogdHJ1ZSwgXHJcbiAgICBhbGdvcml0aG06IHsgbmFtZTogJ0FFUy1HQ00nLCBsZW5ndGg6IDI1NiB9LCBcclxuICAgIHVzYWdlczogWydlbmNyeXB0JywgJ2RlY3J5cHQnXSBcclxuICB9IGFzIENyeXB0b0tleSksXHJcbiAgZXhwb3J0S2V5OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobmV3IEFycmF5QnVmZmVyKDMyKSksXHJcbiAgZW5jcnlwdDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoYWxnb3JpdGhtLCBrZXksIGRhdGEpID0+IHtcclxuICAgIC8vIFNpbXVsYXRlIHJlYWxpc3RpYyBlbmNyeXB0aW9uIHJlc3VsdFxyXG4gICAgY29uc3QgaXYgPSBuZXcgVWludDhBcnJheSgxMik7XHJcbiAgICBpdi5maWxsKDB4QUEpO1xyXG4gICAgY29uc3QgY2lwaGVydGV4dCA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnl0ZUxlbmd0aCArIDE2KTsgLy8gQWRkIHNvbWUgYXV0aCB0YWcgYnl0ZXNcclxuICAgIGNpcGhlcnRleHQuZmlsbCgweEJCKTtcclxuICAgIHJldHVybiBjaXBoZXJ0ZXh0LmJ1ZmZlcjtcclxuICB9KSxcclxuICBkZWNyeXB0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHRlc3REYXRhID0gSlNPTi5zdHJpbmdpZnkoeyBmb286ICdiYXInLCBuOiA0MiB9KTtcclxuICAgIHJldHVybiBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUodGVzdERhdGEpLmJ1ZmZlcjtcclxuICB9KSxcclxuICBkaWdlc3Q6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgaGFzaCA9IG5ldyBVaW50OEFycmF5KDMyKTtcclxuICAgIGhhc2guZmlsbCgweENEKTtcclxuICAgIHJldHVybiBoYXNoLmJ1ZmZlcjtcclxuICB9KVxyXG59O1xyXG5cclxuY29uc3QgbW9ja0NyeXB0b0dldFJhbmRvbVZhbHVlcyA9IGplc3QuZm4oKGFycikgPT4ge1xyXG4gIC8vIEZpbGwgd2l0aCBkZXRlcm1pbmlzdGljIHZhbHVlcyBmb3IgdGVzdGluZ1xyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBhcnJbaV0gPSBpICUgMjU2O1xyXG4gIH1cclxuICByZXR1cm4gYXJyO1xyXG59KTtcclxuXHJcbmplc3QubW9jaygnLi4vc3JjL2JhY2tncm91bmQvc2VydmljZS13b3JrZXItYWRhcHRlcicsICgpID0+ICh7XHJcbiAgc3dDcnlwdG9BUEk6IHtcclxuICAgIHN1YnRsZTogbW9ja0NyeXB0b1N1YnRsZSxcclxuICAgIGdldFJhbmRvbVZhbHVlczogbW9ja0NyeXB0b0dldFJhbmRvbVZhbHVlc1xyXG4gIH1cclxufSkpO1xyXG5cclxuaW1wb3J0IHsgU2VjdXJpdHlNYW5hZ2VyIH0gZnJvbSAnLi4vc3JjL2JhY2tncm91bmQvU2VjdXJpdHlNYW5hZ2VyJ1xyXG5cclxuZGVzY3JpYmUoJ1NlY3VyaXR5TWFuYWdlcicsICgpID0+IHtcclxuICBsZXQgc2VjdXJpdHk6IFNlY3VyaXR5TWFuYWdlcjtcclxuICBcclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgXHJcbiAgICAvLyBSZXNldCBhbGwgY3J5cHRvIG1vY2tzXHJcbiAgICBtb2NrQ3J5cHRvU3VidGxlLmdlbmVyYXRlS2V5Lm1vY2tDbGVhcigpO1xyXG4gICAgbW9ja0NyeXB0b1N1YnRsZS5lbmNyeXB0Lm1vY2tDbGVhcigpO1xyXG4gICAgbW9ja0NyeXB0b1N1YnRsZS5kZWNyeXB0Lm1vY2tDbGVhcigpO1xyXG4gICAgbW9ja0NyeXB0b1N1YnRsZS5kaWdlc3QubW9ja0NsZWFyKCk7XHJcbiAgICBtb2NrQ3J5cHRvR2V0UmFuZG9tVmFsdWVzLm1vY2tDbGVhcigpO1xyXG4gICAgXHJcbiAgICAvLyBDcmVhdGUgU2VjdXJpdHlNYW5hZ2VyIHdpdGggbWFudWFsIGluaXRpYWxpemF0aW9uIHRvIGF2b2lkIGNocm9tZS5zdG9yYWdlIGlzc3Vlc1xyXG4gICAgc2VjdXJpdHkgPSBuZXcgU2VjdXJpdHlNYW5hZ2VyKHRydWUpOyAvLyBTa2lwIGF1dG8taW5pdFxyXG4gICAgXHJcbiAgICAvLyBNYW51YWxseSBzZXQgdGhlIGVuY3J5cHRpb24ga2V5IGZvciB0ZXN0aW5nXHJcbiAgICAoc2VjdXJpdHkgYXMgYW55KS5lbmNyeXB0aW9uS2V5ID0geyBcclxuICAgICAgdHlwZTogJ3NlY3JldCcsIFxyXG4gICAgICBleHRyYWN0YWJsZTogdHJ1ZSwgXHJcbiAgICAgIGFsZ29yaXRobTogeyBuYW1lOiAnQUVTLUdDTScsIGxlbmd0aDogMjU2IH0sIFxyXG4gICAgICB1c2FnZXM6IFsnZW5jcnlwdCcsICdkZWNyeXB0J10gXHJcbiAgICB9IGFzIENyeXB0b0tleTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0NoaWZmcmVtZW50L0TDqWNoaWZmcmVtZW50JywgKCkgPT4ge1xyXG4gICAgaXQoJ2NoaWZmcmUgZXQgZMOpY2hpZmZyZSBjb3JyZWN0ZW1lbnQgbGVzIGRvbm7DqWVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0RGF0YSA9IHsgZm9vOiAnYmFyJywgbjogNDIgfTtcclxuICAgICAgXHJcbiAgICAgIC8vIFRlc3QgZW5jcnlwdGlvblxyXG4gICAgICBjb25zdCBlbmNyeXB0ZWQgPSBhd2FpdCBzZWN1cml0eS5lbmNyeXB0U2Vuc2l0aXZlRGF0YSh0ZXN0RGF0YSk7XHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgZW5jcnlwdGVkKS50b0JlKCdzdHJpbmcnKTtcclxuICAgICAgZXhwZWN0KGVuY3J5cHRlZC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuICAgICAgZXhwZWN0KG1vY2tDcnlwdG9TdWJ0bGUuZW5jcnlwdCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBcclxuICAgICAgLy8gVGVzdCBkZWNyeXB0aW9uICBcclxuICAgICAgY29uc3QgZGVjcnlwdGVkID0gYXdhaXQgc2VjdXJpdHkuZGVjcnlwdFNlbnNpdGl2ZURhdGEoZW5jcnlwdGVkKTtcclxuICAgICAgZXhwZWN0KGRlY3J5cHRlZCkudG9FcXVhbCh0ZXN0RGF0YSk7XHJcbiAgICAgIGV4cGVjdChtb2NrQ3J5cHRvU3VidGxlLmRlY3J5cHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdnw6hyZSBsZXMgZXJyZXVycyBkZSBjaGlmZnJlbWVudCBncmFjaWV1c2VtZW50JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrQ3J5cHRvU3VidGxlLmVuY3J5cHQubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdDcnlwdG8gZmFpbHVyZScpKTtcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGV4cGVjdChzZWN1cml0eS5lbmNyeXB0U2Vuc2l0aXZlRGF0YSh7fSkpLnJlamVjdHMudG9UaHJvdygnw4ljaGVjIGR1IGNoaWZmcmVtZW50IGRlcyBkb25uw6llcyBzZW5zaWJsZXMnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdnw6hyZSBsZXMgZXJyZXVycyBkZSBkw6ljaGlmZnJlbWVudCBncmFjaWV1c2VtZW50JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrQ3J5cHRvU3VidGxlLmRlY3J5cHQubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdEZWNyeXB0IGZhaWx1cmUnKSk7XHJcbiAgICAgIFxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VjdXJpdHkuZGVjcnlwdFNlbnNpdGl2ZURhdGEoJ2ludmFsaWQnKSkucmVqZWN0cy50b1Rocm93KCfDiWNoZWMgZHUgZMOpY2hpZmZyZW1lbnQgZGVzIGRvbm7DqWVzJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0Fub255bWlzYXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnYW5vbnltaXNlIGxlcyBkb25uw6llcyBjb21wb3J0ZW1lbnRhbGVzIChhc3luYyknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhdHRlcm4gPSB7IFxyXG4gICAgICAgIHVybDogJ2h0dHBzOi8vc2VjcmV0LmNvbScsIFxyXG4gICAgICAgIGludGVyYWN0aW9uczogNSwgXHJcbiAgICAgICAgdGltZVNwZW50OiAxMCwgXHJcbiAgICAgICAgc2Nyb2xsRGVwdGg6IDAuOCwgXHJcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpIFxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgY29uc3QgYW5vbnltaXplZCA9IGF3YWl0IHNlY3VyaXR5LmFub255bWl6ZUZvclNoYXJpbmcocGF0dGVybik7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnVybCkudG9CZSgnYW5vbnltaXplZCcpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5pbnRlcmFjdGlvbnMpLnRvQmUocGF0dGVybi5pbnRlcmFjdGlvbnMpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC50aW1lU3BlbnQpLnRvQmUocGF0dGVybi50aW1lU3BlbnQpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5zY3JvbGxEZXB0aCkudG9CZShwYXR0ZXJuLnNjcm9sbERlcHRoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdhbm9ueW1pc2UgbGVzIGRvbm7DqWVzIGNvbXBvcnRlbWVudGFsZXMgKHN5bmMpJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXR0ZXJuID0geyBcclxuICAgICAgICB1cmw6ICdodHRwczovL3NlY3JldC5jb20nLCBcclxuICAgICAgICB1c2VySWQ6ICd1c2VyMTIzJyxcclxuICAgICAgICBpbnRlcmFjdGlvbnM6IDUsIFxyXG4gICAgICAgIHRpbWVTcGVudDogMTAsIFxyXG4gICAgICAgIHNjcm9sbERlcHRoOiAwLjgsIFxyXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSBcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGFub255bWl6ZWQgPSBzZWN1cml0eS5hbm9ueW1pemVGb3JTaGFyaW5nU3luYyhwYXR0ZXJuKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQudXJsKS50b0JlKCdhbm9ueW1pemVkJyk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnVzZXJJZCkubm90LnRvQmUoJ3VzZXIxMjMnKTsgLy8gSGFzaMOpXHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgYW5vbnltaXplZC51c2VySWQpLnRvQmUoJ3N0cmluZycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3N1cHByaW1lIGxlcyBjaGFtcHMgc2Vuc2libGVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXR0ZXJuID0geyBcclxuICAgICAgICB1cmw6ICdodHRwczovL3NlY3JldC5jb20nLFxyXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgbmFtZTogJ0pvaG4gRG9lJyxcclxuICAgICAgICBwaG9uZTogJzEyMzQ1Njc4OScsXHJcbiAgICAgICAgaW50ZXJhY3Rpb25zOiA1XHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBhbm9ueW1pemVkID0gYXdhaXQgc2VjdXJpdHkuYW5vbnltaXplRm9yU2hhcmluZyhwYXR0ZXJuKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuZW1haWwpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQubmFtZSkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5waG9uZSkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5pbnRlcmFjdGlvbnMpLnRvQmUoNSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0NvbnRyw7RsZSBkXFwnYWNjw6hzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3ZhbGlkZSBsXFwnYWNjw6hzIHV0aWxpc2F0ZXVyIGJhc2lxdWUnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7IHVzZXJJZDogJ3VzZXIxMjMnLCByZXNvdXJjZTogJ29yZ2FuaXNtcycgfTtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2VzcyhyZXF1ZXN0KSkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdyZWpldHRlIGxcXCdhY2PDqHMgYWRtaW4gc2FucyByw7RsZSBhZG1pbicsICgpID0+IHtcclxuICAgICAgY29uc3QgcmVxdWVzdCA9IHsgdXNlcklkOiAndXNlcjEyMycsIHJlc291cmNlOiAnYWRtaW4nLCByb2xlOiAndXNlcicgYXMgY29uc3QgfTtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2VzcyhyZXF1ZXN0LCAnYWRtaW4nKSkudG9CZShmYWxzZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnYWNjZXB0ZSBsXFwnYWNjw6hzIGFkbWluIGF2ZWMgcsO0bGUgYWRtaW4nLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7IHVzZXJJZDogJ2FkbWluMTIzJywgcmVzb3VyY2U6ICdhZG1pbicsIHJvbGU6ICdhZG1pbicgYXMgY29uc3QgfTtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2VzcyhyZXF1ZXN0LCAnYWRtaW4nKSkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdyZWpldHRlIGxlcyByZXF1w6p0ZXMgaW52YWxpZGVzJywgKCkgPT4ge1xyXG4gICAgICBleHBlY3Qoc2VjdXJpdHkudmFsaWRhdGVEYXRhQWNjZXNzKHsgdXNlcklkOiAnJywgcmVzb3VyY2U6ICd0ZXN0JyB9KSkudG9CZShmYWxzZSk7XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MoeyB1c2VySWQ6ICd1c2VyJywgcmVzb3VyY2U6ICcnIH0pKS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnSGFzaGFnZScsICgpID0+IHtcclxuICAgIGl0KCdoYXNoIGRlcyBjaGHDrm5lcyBhdmVjIFNIQS0yNTYnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RTdHJpbmcgPSAndGVzdC1zdHJpbmcnO1xyXG4gICAgICBjb25zdCBoYXNoID0gYXdhaXQgc2VjdXJpdHkuaGFzaCh0ZXN0U3RyaW5nKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgaGFzaCkudG9CZSgnc3RyaW5nJyk7XHJcbiAgICAgIGV4cGVjdChoYXNoLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3QobW9ja0NyeXB0b1N1YnRsZS5kaWdlc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdTSEEtMjU2JywgZXhwZWN0LmFueShVaW50OEFycmF5KSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgncHJvZHVpdCBkZXMgaGFzaHMgY29ow6lyZW50cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFN0cmluZyA9ICdjb25zaXN0ZW50LXRlc3QnO1xyXG4gICAgICBjb25zdCBoYXNoMSA9IGF3YWl0IHNlY3VyaXR5Lmhhc2godGVzdFN0cmluZyk7XHJcbiAgICAgIGNvbnN0IGhhc2gyID0gYXdhaXQgc2VjdXJpdHkuaGFzaCh0ZXN0U3RyaW5nKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChoYXNoMSkudG9CZShoYXNoMik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnaGFzaCBzeW5jIGZvbmN0aW9ubmUgY29tbWUgZmFsbGJhY2snLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RTdHJpbmcgPSAnc3luYy10ZXN0JztcclxuICAgICAgY29uc3QgaGFzaCA9IHNlY3VyaXR5Lmhhc2hTeW5jKHRlc3RTdHJpbmcpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHR5cGVvZiBoYXNoKS50b0JlKCdzdHJpbmcnKTtcclxuICAgICAgZXhwZWN0KGhhc2gubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0luaXRpYWxpc2F0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ3BldXQgw6p0cmUgY3LDqcOpIHNhbnMgYXV0by1pbml0aWFsaXNhdGlvbicsICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFNlY3VyaXR5ID0gbmV3IFNlY3VyaXR5TWFuYWdlcih0cnVlKTtcclxuICAgICAgZXhwZWN0KHRlc3RTZWN1cml0eSkudG9CZUluc3RhbmNlT2YoU2VjdXJpdHlNYW5hZ2VyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdnw6hyZSBncmFjaWV1c2VtZW50IGxcXCdhYnNlbmNlIGRlIGNsw6kgbG9ycyBkZXMgb3DDqXJhdGlvbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RTZWN1cml0eSA9IG5ldyBTZWN1cml0eU1hbmFnZXIodHJ1ZSk7XHJcbiAgICAgIC8vIFNhbnMgY2zDqSBkw6lmaW5pZSwgZGV2cmFpdCBlc3NheWVyIGQnaW5pdGlhbGlzZXIgcHVpcyDDqWNob3VlciBwcm9wcmVtZW50XHJcbiAgICAgIGF3YWl0IGV4cGVjdCh0ZXN0U2VjdXJpdHkuZW5jcnlwdFNlbnNpdGl2ZURhdGEoe30pKS5yZWplY3RzLnRvVGhyb3coKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCd2YWxpZGUgbGEgcHLDqXNlbmNlIGRlIFdlYkNyeXB0byBBUEknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIFRlbXBvcmFyaWx5IGRpc2FibGUgdGhlIGNyeXB0byBBUElcclxuICAgICAgY29uc3Qgb3JpZ2luYWxTdWJ0bGUgPSBtb2NrQ3J5cHRvU3VidGxlO1xyXG4gICAgICBqZXN0LmRvTW9jaygnLi4vc3JjL2JhY2tncm91bmQvc2VydmljZS13b3JrZXItYWRhcHRlcicsICgpID0+ICh7XHJcbiAgICAgICAgc3dDcnlwdG9BUEk6IG51bGxcclxuICAgICAgfSkpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KHNlY3VyaXR5LmVuY3J5cHRTZW5zaXRpdmVEYXRhKHt9KSkucmVqZWN0cy50b1Rocm93KCdXZWJDcnlwdG8gQVBJIG5vbiBkaXNwb25pYmxlJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7ICJdLCJ2ZXJzaW9uIjozfQ==