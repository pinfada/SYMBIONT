93db261920f2bffaadc39c05e5a0b170
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('../src/background/service-worker-adapter', () => ({
    swCryptoAPI: mockSwCryptoAPI
}));
// Mock service-worker-adapter before importing SecurityManager
const mockCryptoSubtle = {
    generateKey: jest.fn().mockResolvedValue({
        type: 'secret',
        extractable: true,
        algorithm: { name: 'AES-GCM', length: 256 },
        usages: ['encrypt', 'decrypt']
    }),
    importKey: jest.fn().mockResolvedValue({
        type: 'secret',
        extractable: true,
        algorithm: { name: 'AES-GCM', length: 256 },
        usages: ['encrypt', 'decrypt']
    }),
    exportKey: jest.fn().mockResolvedValue(new ArrayBuffer(32)),
    encrypt: jest.fn().mockImplementation(async (algorithm, key, data) => {
        // Validate parameters
        if (!algorithm || !key || !data) {
            throw new Error('Missing required parameters for encryption');
        }
        // Ensure data is an ArrayBuffer or can be converted to one
        let dataBuffer = data;
        if (!(data instanceof ArrayBuffer)) {
            if (data instanceof Uint8Array) {
                dataBuffer = data.buffer;
            }
            else {
                throw new Error('Data must be ArrayBuffer or Uint8Array');
            }
        }
        // Simulate realistic encryption result with proper buffer
        const inputLength = dataBuffer.byteLength || 0;
        const ciphertext = new Uint8Array(inputLength + 16); // Add some auth tag bytes
        ciphertext.fill(0xBB);
        // Add some variation based on input
        for (let i = 0; i < Math.min(inputLength, ciphertext.length); i++) {
            ciphertext[i] = (ciphertext[i] + i) % 256;
        }
        return ciphertext.buffer;
    }),
    decrypt: jest.fn().mockImplementation(async () => {
        const testData = JSON.stringify({ foo: 'bar', n: 42 });
        return new TextEncoder().encode(testData).buffer;
    }),
    digest: jest.fn().mockImplementation(async (algorithm, data) => {
        // Create a realistic hash-like result
        const hash = new Uint8Array(32);
        for (let i = 0; i < 32; i++) {
            hash[i] = (0xCD + i) % 256;
        }
        return hash.buffer;
    })
};
const mockCryptoGetRandomValues = jest.fn().mockImplementation((arr) => {
    // Fill with deterministic values for testing
    if (arr && arr.length) {
        for (let i = 0; i < arr.length; i++) {
            arr[i] = i % 256;
        }
    }
    return arr;
});
// Mock the service worker adapter
const mockSwCryptoAPI = {
    subtle: mockCryptoSubtle,
    getRandomValues: mockCryptoGetRandomValues
};
const SecurityManager_1 = require("../src/background/SecurityManager");
describe('SecurityManager', () => {
    let security;
    beforeEach(async () => {
        jest.clearAllMocks();
        // Reset all crypto mocks
        mockCryptoSubtle.generateKey.mockClear();
        mockCryptoSubtle.encrypt.mockClear();
        mockCryptoSubtle.decrypt.mockClear();
        mockCryptoSubtle.digest.mockClear();
        mockCryptoGetRandomValues.mockClear();
        // Create SecurityManager with manual initialization to avoid chrome.storage issues
        security = new SecurityManager_1.SecurityManager(true); // Skip auto-init
        // Manually set the encryption key for testing
        security.encryptionKey = {
            type: 'secret',
            extractable: true,
            algorithm: { name: 'AES-GCM', length: 256 },
            usages: ['encrypt', 'decrypt']
        };
    });
    describe('Chiffrement/Déchiffrement', () => {
        it('chiffre et déchiffre correctement les données', async () => {
            const testData = { foo: 'bar', n: 42 };
            // Test encryption
            try {
                const encrypted = await security.encryptSensitiveData(testData);
                expect(typeof encrypted).toBe('string');
                expect(encrypted.length).toBeGreaterThan(0);
                expect(mockCryptoSubtle.encrypt).toHaveBeenCalled();
                // Test decryption  
                const decrypted = await security.decryptSensitiveData(encrypted);
                expect(decrypted).toEqual(testData);
                expect(mockCryptoSubtle.decrypt).toHaveBeenCalled();
            }
            catch (error) {
                console.log('Mock calls:', {
                    getRandomValues: mockCryptoGetRandomValues.mock.calls,
                    encrypt: mockCryptoSubtle.encrypt.mock.calls
                });
                throw error;
            }
        });
        it('gère les erreurs de chiffrement gracieusement', async () => {
            mockCryptoSubtle.encrypt.mockRejectedValue(new Error('Crypto failure'));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('Échec du chiffrement des données sensibles');
        });
        it('gère les erreurs de déchiffrement gracieusement', async () => {
            mockCryptoSubtle.decrypt.mockRejectedValue(new Error('Decrypt failure'));
            await expect(security.decryptSensitiveData('invalid')).rejects.toThrow('Échec du déchiffrement des données');
        });
    });
    describe('Anonymisation', () => {
        it('anonymise les données comportementales (async)', async () => {
            const pattern = {
                url: 'https://secret.com',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.interactions).toBe(pattern.interactions);
            expect(anonymized.timeSpent).toBe(pattern.timeSpent);
            expect(anonymized.scrollDepth).toBe(pattern.scrollDepth);
        });
        it('anonymise les données comportementales (sync)', () => {
            const pattern = {
                url: 'https://secret.com',
                userId: 'user123',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = security.anonymizeForSharingSync(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.userId).not.toBe('user123'); // Hashé
            expect(typeof anonymized.userId).toBe('string');
        });
        it('supprime les champs sensibles', async () => {
            const pattern = {
                url: 'https://secret.com',
                email: 'test@example.com',
                name: 'John Doe',
                phone: '123456789',
                interactions: 5
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.email).toBeUndefined();
            expect(anonymized.name).toBeUndefined();
            expect(anonymized.phone).toBeUndefined();
            expect(anonymized.interactions).toBe(5);
        });
    });
    describe('Contrôle d\'accès', () => {
        it('valide l\'accès utilisateur basique', () => {
            const request = { userId: 'user123', resource: 'organisms' };
            expect(security.validateDataAccess(request)).toBe(true);
        });
        it('rejette l\'accès admin sans rôle admin', () => {
            const request = { userId: 'user123', resource: 'admin', role: 'user' };
            expect(security.validateDataAccess(request, 'admin')).toBe(false);
        });
        it('accepte l\'accès admin avec rôle admin', () => {
            const request = { userId: 'admin123', resource: 'admin', role: 'admin' };
            expect(security.validateDataAccess(request, 'admin')).toBe(true);
        });
        it('rejette les requêtes invalides', () => {
            expect(security.validateDataAccess({ userId: '', resource: 'test' })).toBe(false);
            expect(security.validateDataAccess({ userId: 'user', resource: '' })).toBe(false);
        });
    });
    describe('Hashage', () => {
        it('hash des chaînes avec SHA-256', async () => {
            const testString = 'test-string';
            const hash = await security.hash(testString);
            console.log('Hash result:', hash, 'Length:', hash.length);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
            expect(mockCryptoSubtle.digest).toHaveBeenCalledWith('SHA-256', expect.any(Uint8Array));
        });
        it('produit des hashs cohérents', async () => {
            const testString = 'consistent-test';
            const hash1 = await security.hash(testString);
            const hash2 = await security.hash(testString);
            expect(hash1).toBe(hash2);
        });
        it('hash sync fonctionne comme fallback', () => {
            const testString = 'sync-test';
            const hash = security.hashSync(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
        });
    });
    describe('Initialisation', () => {
        it('peut être créé sans auto-initialisation', () => {
            const testSecurity = new SecurityManager_1.SecurityManager(true);
            expect(testSecurity).toBeInstanceOf(SecurityManager_1.SecurityManager);
        });
        it('gère gracieusement l\'absence de clé lors des opérations', async () => {
            const testSecurity = new SecurityManager_1.SecurityManager(true);
            // Sans clé définie, devrait essayer d'initialiser puis échouer proprement
            await expect(testSecurity.encryptSensitiveData({})).rejects.toThrow();
        });
        it('valide la présence de WebCrypto API', async () => {
            // Temporarily disable the crypto API
            const originalSubtle = mockCryptoSubtle;
            jest.doMock('../src/background/service-worker-adapter', () => ({
                swCryptoAPI: null
            }));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('WebCrypto API non disponible');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvX190ZXN0c19fL1NlY3VyaXR5TWFuYWdlci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBeUVBLElBQUksQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMzRCxXQUFXLEVBQUUsZUFBZTtDQUM3QixDQUFDLENBQUMsQ0FBQztBQTNFSiwrREFBK0Q7QUFDL0QsTUFBTSxnQkFBZ0IsR0FBRztJQUN2QixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO1FBQ3ZDLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLElBQUk7UUFDakIsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFO1FBQzNDLE1BQU0sRUFBRSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUM7S0FDbEIsQ0FBQztJQUNmLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUM7UUFDckMsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUU7UUFDM0MsTUFBTSxFQUFFLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQztLQUNsQixDQUFDO0lBQ2YsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ25FLHNCQUFzQjtRQUN0QixJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFD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Q0FBQyxNQUFNLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDN0QsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQyxDQUFDLENBQUM7WUFFSixNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsb0JBQW9CLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDbEcsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9tX29saS9Qcm9qZXRzL1NZTUJJT05UL19fdGVzdHNfXy9TZWN1cml0eU1hbmFnZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBNb2NrIHNlcnZpY2Utd29ya2VyLWFkYXB0ZXIgYmVmb3JlIGltcG9ydGluZyBTZWN1cml0eU1hbmFnZXJcclxuY29uc3QgbW9ja0NyeXB0b1N1YnRsZSA9IHtcclxuICBnZW5lcmF0ZUtleTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgXHJcbiAgICB0eXBlOiAnc2VjcmV0JywgXHJcbiAgICBleHRyYWN0YWJsZTogdHJ1ZSwgXHJcbiAgICBhbGdvcml0aG06IHsgbmFtZTogJ0FFUy1HQ00nLCBsZW5ndGg6IDI1NiB9LCBcclxuICAgIHVzYWdlczogWydlbmNyeXB0JywgJ2RlY3J5cHQnXSBcclxuICB9IGFzIENyeXB0b0tleSksXHJcbiAgaW1wb3J0S2V5OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBcclxuICAgIHR5cGU6ICdzZWNyZXQnLCBcclxuICAgIGV4dHJhY3RhYmxlOiB0cnVlLCBcclxuICAgIGFsZ29yaXRobTogeyBuYW1lOiAnQUVTLUdDTScsIGxlbmd0aDogMjU2IH0sIFxyXG4gICAgdXNhZ2VzOiBbJ2VuY3J5cHQnLCAnZGVjcnlwdCddIFxyXG4gIH0gYXMgQ3J5cHRvS2V5KSxcclxuICBleHBvcnRLZXk6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShuZXcgQXJyYXlCdWZmZXIoMzIpKSxcclxuICBlbmNyeXB0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChhbGdvcml0aG0sIGtleSwgZGF0YSkgPT4ge1xyXG4gICAgLy8gVmFsaWRhdGUgcGFyYW1ldGVyc1xyXG4gICAgaWYgKCFhbGdvcml0aG0gfHwgIWtleSB8fCAhZGF0YSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgcGFyYW1ldGVycyBmb3IgZW5jcnlwdGlvbicpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBFbnN1cmUgZGF0YSBpcyBhbiBBcnJheUJ1ZmZlciBvciBjYW4gYmUgY29udmVydGVkIHRvIG9uZVxyXG4gICAgbGV0IGRhdGFCdWZmZXIgPSBkYXRhO1xyXG4gICAgaWYgKCEoZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSkge1xyXG4gICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHtcclxuICAgICAgICBkYXRhQnVmZmVyID0gZGF0YS5idWZmZXI7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhIG11c3QgYmUgQXJyYXlCdWZmZXIgb3IgVWludDhBcnJheScpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFNpbXVsYXRlIHJlYWxpc3RpYyBlbmNyeXB0aW9uIHJlc3VsdCB3aXRoIHByb3BlciBidWZmZXJcclxuICAgIGNvbnN0IGlucHV0TGVuZ3RoID0gZGF0YUJ1ZmZlci5ieXRlTGVuZ3RoIHx8IDA7XHJcbiAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXRMZW5ndGggKyAxNik7IC8vIEFkZCBzb21lIGF1dGggdGFnIGJ5dGVzXHJcbiAgICBjaXBoZXJ0ZXh0LmZpbGwoMHhCQik7XHJcbiAgICBcclxuICAgIC8vIEFkZCBzb21lIHZhcmlhdGlvbiBiYXNlZCBvbiBpbnB1dFxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNYXRoLm1pbihpbnB1dExlbmd0aCwgY2lwaGVydGV4dC5sZW5ndGgpOyBpKyspIHtcclxuICAgICAgY2lwaGVydGV4dFtpXSA9IChjaXBoZXJ0ZXh0W2ldICsgaSkgJSAyNTY7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBjaXBoZXJ0ZXh0LmJ1ZmZlcjtcclxuICB9KSxcclxuICBkZWNyeXB0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHRlc3REYXRhID0gSlNPTi5zdHJpbmdpZnkoeyBmb286ICdiYXInLCBuOiA0MiB9KTtcclxuICAgIHJldHVybiBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUodGVzdERhdGEpLmJ1ZmZlcjtcclxuICB9KSxcclxuICBkaWdlc3Q6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGFsZ29yaXRobSwgZGF0YSkgPT4ge1xyXG4gICAgLy8gQ3JlYXRlIGEgcmVhbGlzdGljIGhhc2gtbGlrZSByZXN1bHRcclxuICAgIGNvbnN0IGhhc2ggPSBuZXcgVWludDhBcnJheSgzMik7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDMyOyBpKyspIHtcclxuICAgICAgaGFzaFtpXSA9ICgweENEICsgaSkgJSAyNTY7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGFzaC5idWZmZXI7XHJcbiAgfSlcclxufTtcclxuXHJcbmNvbnN0IG1vY2tDcnlwdG9HZXRSYW5kb21WYWx1ZXMgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChhcnIpID0+IHtcclxuICAvLyBGaWxsIHdpdGggZGV0ZXJtaW5pc3RpYyB2YWx1ZXMgZm9yIHRlc3RpbmdcclxuICBpZiAoYXJyICYmIGFyci5sZW5ndGgpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGFycltpXSA9IGkgJSAyNTY7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBhcnI7XHJcbn0pO1xyXG5cclxuLy8gTW9jayB0aGUgc2VydmljZSB3b3JrZXIgYWRhcHRlclxyXG5jb25zdCBtb2NrU3dDcnlwdG9BUEkgPSB7XHJcbiAgc3VidGxlOiBtb2NrQ3J5cHRvU3VidGxlLFxyXG4gIGdldFJhbmRvbVZhbHVlczogbW9ja0NyeXB0b0dldFJhbmRvbVZhbHVlc1xyXG59O1xyXG5cclxuamVzdC5tb2NrKCcuLi9zcmMvYmFja2dyb3VuZC9zZXJ2aWNlLXdvcmtlci1hZGFwdGVyJywgKCkgPT4gKHtcclxuICBzd0NyeXB0b0FQSTogbW9ja1N3Q3J5cHRvQVBJXHJcbn0pKTtcclxuXHJcbmltcG9ydCB7IFNlY3VyaXR5TWFuYWdlciB9IGZyb20gJy4uL3NyYy9iYWNrZ3JvdW5kL1NlY3VyaXR5TWFuYWdlcidcclxuXHJcbmRlc2NyaWJlKCdTZWN1cml0eU1hbmFnZXInLCAoKSA9PiB7XHJcbiAgbGV0IHNlY3VyaXR5OiBTZWN1cml0eU1hbmFnZXI7XHJcbiAgXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAgIFxyXG4gICAgLy8gUmVzZXQgYWxsIGNyeXB0byBtb2Nrc1xyXG4gICAgbW9ja0NyeXB0b1N1YnRsZS5nZW5lcmF0ZUtleS5tb2NrQ2xlYXIoKTtcclxuICAgIG1vY2tDcnlwdG9TdWJ0bGUuZW5jcnlwdC5tb2NrQ2xlYXIoKTtcclxuICAgIG1vY2tDcnlwdG9TdWJ0bGUuZGVjcnlwdC5tb2NrQ2xlYXIoKTtcclxuICAgIG1vY2tDcnlwdG9TdWJ0bGUuZGlnZXN0Lm1vY2tDbGVhcigpO1xyXG4gICAgbW9ja0NyeXB0b0dldFJhbmRvbVZhbHVlcy5tb2NrQ2xlYXIoKTtcclxuICAgIFxyXG4gICAgLy8gQ3JlYXRlIFNlY3VyaXR5TWFuYWdlciB3aXRoIG1hbnVhbCBpbml0aWFsaXphdGlvbiB0byBhdm9pZCBjaHJvbWUuc3RvcmFnZSBpc3N1ZXNcclxuICAgIHNlY3VyaXR5ID0gbmV3IFNlY3VyaXR5TWFuYWdlcih0cnVlKTsgLy8gU2tpcCBhdXRvLWluaXRcclxuICAgIFxyXG4gICAgLy8gTWFudWFsbHkgc2V0IHRoZSBlbmNyeXB0aW9uIGtleSBmb3IgdGVzdGluZ1xyXG4gICAgKHNlY3VyaXR5IGFzIGFueSkuZW5jcnlwdGlvbktleSA9IHsgXHJcbiAgICAgIHR5cGU6ICdzZWNyZXQnLCBcclxuICAgICAgZXh0cmFjdGFibGU6IHRydWUsIFxyXG4gICAgICBhbGdvcml0aG06IHsgbmFtZTogJ0FFUy1HQ00nLCBsZW5ndGg6IDI1NiB9LCBcclxuICAgICAgdXNhZ2VzOiBbJ2VuY3J5cHQnLCAnZGVjcnlwdCddIFxyXG4gICAgfSBhcyBDcnlwdG9LZXk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdDaGlmZnJlbWVudC9Ew6ljaGlmZnJlbWVudCcsICgpID0+IHtcclxuICAgIGl0KCdjaGlmZnJlIGV0IGTDqWNoaWZmcmUgY29ycmVjdGVtZW50IGxlcyBkb25uw6llcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdERhdGEgPSB7IGZvbzogJ2JhcicsIG46IDQyIH07XHJcbiAgICAgIFxyXG4gICAgICAvLyBUZXN0IGVuY3J5cHRpb25cclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBlbmNyeXB0ZWQgPSBhd2FpdCBzZWN1cml0eS5lbmNyeXB0U2Vuc2l0aXZlRGF0YSh0ZXN0RGF0YSk7XHJcbiAgICAgICAgZXhwZWN0KHR5cGVvZiBlbmNyeXB0ZWQpLnRvQmUoJ3N0cmluZycpO1xyXG4gICAgICAgIGV4cGVjdChlbmNyeXB0ZWQubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcbiAgICAgICAgZXhwZWN0KG1vY2tDcnlwdG9TdWJ0bGUuZW5jcnlwdCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIFRlc3QgZGVjcnlwdGlvbiAgXHJcbiAgICAgICAgY29uc3QgZGVjcnlwdGVkID0gYXdhaXQgc2VjdXJpdHkuZGVjcnlwdFNlbnNpdGl2ZURhdGEoZW5jcnlwdGVkKTtcclxuICAgICAgICBleHBlY3QoZGVjcnlwdGVkKS50b0VxdWFsKHRlc3REYXRhKTtcclxuICAgICAgICBleHBlY3QobW9ja0NyeXB0b1N1YnRsZS5kZWNyeXB0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ01vY2sgY2FsbHM6Jywge1xyXG4gICAgICAgICAgZ2V0UmFuZG9tVmFsdWVzOiBtb2NrQ3J5cHRvR2V0UmFuZG9tVmFsdWVzLm1vY2suY2FsbHMsXHJcbiAgICAgICAgICBlbmNyeXB0OiBtb2NrQ3J5cHRvU3VidGxlLmVuY3J5cHQubW9jay5jYWxsc1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnZ8OocmUgbGVzIGVycmV1cnMgZGUgY2hpZmZyZW1lbnQgZ3JhY2lldXNlbWVudCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja0NyeXB0b1N1YnRsZS5lbmNyeXB0Lm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignQ3J5cHRvIGZhaWx1cmUnKSk7XHJcbiAgICAgIFxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VjdXJpdHkuZW5jcnlwdFNlbnNpdGl2ZURhdGEoe30pKS5yZWplY3RzLnRvVGhyb3coJ8OJY2hlYyBkdSBjaGlmZnJlbWVudCBkZXMgZG9ubsOpZXMgc2Vuc2libGVzJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnZ8OocmUgbGVzIGVycmV1cnMgZGUgZMOpY2hpZmZyZW1lbnQgZ3JhY2lldXNlbWVudCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja0NyeXB0b1N1YnRsZS5kZWNyeXB0Lm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignRGVjcnlwdCBmYWlsdXJlJykpO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZXhwZWN0KHNlY3VyaXR5LmRlY3J5cHRTZW5zaXRpdmVEYXRhKCdpbnZhbGlkJykpLnJlamVjdHMudG9UaHJvdygnw4ljaGVjIGR1IGTDqWNoaWZmcmVtZW50IGRlcyBkb25uw6llcycpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdBbm9ueW1pc2F0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ2Fub255bWlzZSBsZXMgZG9ubsOpZXMgY29tcG9ydGVtZW50YWxlcyAoYXN5bmMpJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXR0ZXJuID0geyBcclxuICAgICAgICB1cmw6ICdodHRwczovL3NlY3JldC5jb20nLCBcclxuICAgICAgICBpbnRlcmFjdGlvbnM6IDUsIFxyXG4gICAgICAgIHRpbWVTcGVudDogMTAsIFxyXG4gICAgICAgIHNjcm9sbERlcHRoOiAwLjgsIFxyXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSBcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGFub255bWl6ZWQgPSBhd2FpdCBzZWN1cml0eS5hbm9ueW1pemVGb3JTaGFyaW5nKHBhdHRlcm4pO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC51cmwpLnRvQmUoJ2Fub255bWl6ZWQnKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuaW50ZXJhY3Rpb25zKS50b0JlKHBhdHRlcm4uaW50ZXJhY3Rpb25zKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQudGltZVNwZW50KS50b0JlKHBhdHRlcm4udGltZVNwZW50KTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuc2Nyb2xsRGVwdGgpLnRvQmUocGF0dGVybi5zY3JvbGxEZXB0aCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnYW5vbnltaXNlIGxlcyBkb25uw6llcyBjb21wb3J0ZW1lbnRhbGVzIChzeW5jKScsICgpID0+IHtcclxuICAgICAgY29uc3QgcGF0dGVybiA9IHsgXHJcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9zZWNyZXQuY29tJywgXHJcbiAgICAgICAgdXNlcklkOiAndXNlcjEyMycsXHJcbiAgICAgICAgaW50ZXJhY3Rpb25zOiA1LCBcclxuICAgICAgICB0aW1lU3BlbnQ6IDEwLCBcclxuICAgICAgICBzY3JvbGxEZXB0aDogMC44LCBcclxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCkgXHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBhbm9ueW1pemVkID0gc2VjdXJpdHkuYW5vbnltaXplRm9yU2hhcmluZ1N5bmMocGF0dGVybik7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnVybCkudG9CZSgnYW5vbnltaXplZCcpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC51c2VySWQpLm5vdC50b0JlKCd1c2VyMTIzJyk7IC8vIEhhc2jDqVxyXG4gICAgICBleHBlY3QodHlwZW9mIGFub255bWl6ZWQudXNlcklkKS50b0JlKCdzdHJpbmcnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzdXBwcmltZSBsZXMgY2hhbXBzIHNlbnNpYmxlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcGF0dGVybiA9IHsgXHJcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9zZWNyZXQuY29tJyxcclxuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxyXG4gICAgICAgIG5hbWU6ICdKb2huIERvZScsXHJcbiAgICAgICAgcGhvbmU6ICcxMjM0NTY3ODknLFxyXG4gICAgICAgIGludGVyYWN0aW9uczogNVxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgY29uc3QgYW5vbnltaXplZCA9IGF3YWl0IHNlY3VyaXR5LmFub255bWl6ZUZvclNoYXJpbmcocGF0dGVybik7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLmVtYWlsKS50b0JlVW5kZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLm5hbWUpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQucGhvbmUpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuaW50ZXJhY3Rpb25zKS50b0JlKDUpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdDb250csO0bGUgZFxcJ2FjY8OocycsICgpID0+IHtcclxuICAgIGl0KCd2YWxpZGUgbFxcJ2FjY8OocyB1dGlsaXNhdGV1ciBiYXNpcXVlJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXF1ZXN0ID0geyB1c2VySWQ6ICd1c2VyMTIzJywgcmVzb3VyY2U6ICdvcmdhbmlzbXMnIH07XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MocmVxdWVzdCkpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgncmVqZXR0ZSBsXFwnYWNjw6hzIGFkbWluIHNhbnMgcsO0bGUgYWRtaW4nLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7IHVzZXJJZDogJ3VzZXIxMjMnLCByZXNvdXJjZTogJ2FkbWluJywgcm9sZTogJ3VzZXInIGFzIGNvbnN0IH07XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MocmVxdWVzdCwgJ2FkbWluJykpLnRvQmUoZmFsc2UpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2FjY2VwdGUgbFxcJ2FjY8OocyBhZG1pbiBhdmVjIHLDtGxlIGFkbWluJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXF1ZXN0ID0geyB1c2VySWQ6ICdhZG1pbjEyMycsIHJlc291cmNlOiAnYWRtaW4nLCByb2xlOiAnYWRtaW4nIGFzIGNvbnN0IH07XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MocmVxdWVzdCwgJ2FkbWluJykpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgncmVqZXR0ZSBsZXMgcmVxdcOqdGVzIGludmFsaWRlcycsICgpID0+IHtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2Vzcyh7IHVzZXJJZDogJycsIHJlc291cmNlOiAndGVzdCcgfSkpLnRvQmUoZmFsc2UpO1xyXG4gICAgICBleHBlY3Qoc2VjdXJpdHkudmFsaWRhdGVEYXRhQWNjZXNzKHsgdXNlcklkOiAndXNlcicsIHJlc291cmNlOiAnJyB9KSkudG9CZShmYWxzZSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0hhc2hhZ2UnLCAoKSA9PiB7XHJcbiAgICBpdCgnaGFzaCBkZXMgY2hhw65uZXMgYXZlYyBTSEEtMjU2JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0U3RyaW5nID0gJ3Rlc3Qtc3RyaW5nJztcclxuICAgICAgY29uc3QgaGFzaCA9IGF3YWl0IHNlY3VyaXR5Lmhhc2godGVzdFN0cmluZyk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zb2xlLmxvZygnSGFzaCByZXN1bHQ6JywgaGFzaCwgJ0xlbmd0aDonLCBoYXNoLmxlbmd0aCk7XHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgaGFzaCkudG9CZSgnc3RyaW5nJyk7XHJcbiAgICAgIGV4cGVjdChoYXNoLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3QobW9ja0NyeXB0b1N1YnRsZS5kaWdlc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdTSEEtMjU2JywgZXhwZWN0LmFueShVaW50OEFycmF5KSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgncHJvZHVpdCBkZXMgaGFzaHMgY29ow6lyZW50cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFN0cmluZyA9ICdjb25zaXN0ZW50LXRlc3QnO1xyXG4gICAgICBjb25zdCBoYXNoMSA9IGF3YWl0IHNlY3VyaXR5Lmhhc2godGVzdFN0cmluZyk7XHJcbiAgICAgIGNvbnN0IGhhc2gyID0gYXdhaXQgc2VjdXJpdHkuaGFzaCh0ZXN0U3RyaW5nKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChoYXNoMSkudG9CZShoYXNoMik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnaGFzaCBzeW5jIGZvbmN0aW9ubmUgY29tbWUgZmFsbGJhY2snLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RTdHJpbmcgPSAnc3luYy10ZXN0JztcclxuICAgICAgY29uc3QgaGFzaCA9IHNlY3VyaXR5Lmhhc2hTeW5jKHRlc3RTdHJpbmcpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHR5cGVvZiBoYXNoKS50b0JlKCdzdHJpbmcnKTtcclxuICAgICAgZXhwZWN0KGhhc2gubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0luaXRpYWxpc2F0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ3BldXQgw6p0cmUgY3LDqcOpIHNhbnMgYXV0by1pbml0aWFsaXNhdGlvbicsICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFNlY3VyaXR5ID0gbmV3IFNlY3VyaXR5TWFuYWdlcih0cnVlKTtcclxuICAgICAgZXhwZWN0KHRlc3RTZWN1cml0eSkudG9CZUluc3RhbmNlT2YoU2VjdXJpdHlNYW5hZ2VyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdnw6hyZSBncmFjaWV1c2VtZW50IGxcXCdhYnNlbmNlIGRlIGNsw6kgbG9ycyBkZXMgb3DDqXJhdGlvbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RTZWN1cml0eSA9IG5ldyBTZWN1cml0eU1hbmFnZXIodHJ1ZSk7XHJcbiAgICAgIC8vIFNhbnMgY2zDqSBkw6lmaW5pZSwgZGV2cmFpdCBlc3NheWVyIGQnaW5pdGlhbGlzZXIgcHVpcyDDqWNob3VlciBwcm9wcmVtZW50XHJcbiAgICAgIGF3YWl0IGV4cGVjdCh0ZXN0U2VjdXJpdHkuZW5jcnlwdFNlbnNpdGl2ZURhdGEoe30pKS5yZWplY3RzLnRvVGhyb3coKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCd2YWxpZGUgbGEgcHLDqXNlbmNlIGRlIFdlYkNyeXB0byBBUEknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIFRlbXBvcmFyaWx5IGRpc2FibGUgdGhlIGNyeXB0byBBUElcclxuICAgICAgY29uc3Qgb3JpZ2luYWxTdWJ0bGUgPSBtb2NrQ3J5cHRvU3VidGxlO1xyXG4gICAgICBqZXN0LmRvTW9jaygnLi4vc3JjL2JhY2tncm91bmQvc2VydmljZS13b3JrZXItYWRhcHRlcicsICgpID0+ICh7XHJcbiAgICAgICAgc3dDcnlwdG9BUEk6IG51bGxcclxuICAgICAgfSkpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KHNlY3VyaXR5LmVuY3J5cHRTZW5zaXRpdmVEYXRhKHt9KSkucmVqZWN0cy50b1Rocm93KCdXZWJDcnlwdG8gQVBJIG5vbiBkaXNwb25pYmxlJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7ICJdLCJ2ZXJzaW9uIjozfQ==