9eae2b7f23b2746aa1ffbfa63a69bf1b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock service worker adapter
jest.mock('../src/background/service-worker-adapter', () => ({
    swCryptoAPI: {
        subtle: global.crypto.subtle,
        getRandomValues: global.crypto.getRandomValues
    }
}));
const SecurityManager_1 = require("../src/background/SecurityManager");
describe('SecurityManager', () => {
    let security;
    beforeEach(() => {
        jest.clearAllMocks();
        security = new SecurityManager_1.SecurityManager();
    });
    describe('Chiffrement/Déchiffrement', () => {
        it('chiffre et déchiffre correctement les données', async () => {
            const testData = { foo: 'bar', n: 42 };
            // Mock encrypt pour retourner données encodées
            const mockResult = JSON.stringify(testData);
            const mockEncoded = new TextEncoder().encode(mockResult);
            global.crypto.subtle.decrypt.mockResolvedValue(mockEncoded.buffer);
            // Test encryption
            const encrypted = await security.encryptSensitiveData(testData);
            expect(typeof encrypted).toBe('string');
            expect(global.crypto.subtle.encrypt).toHaveBeenCalled();
            // Test decryption  
            const decrypted = await security.decryptSensitiveData(encrypted);
            expect(decrypted).toEqual(testData);
            expect(global.crypto.subtle.decrypt).toHaveBeenCalled();
        });
        it('gère les erreurs de chiffrement gracieusement', async () => {
            global.crypto.subtle.encrypt.mockRejectedValue(new Error('Crypto failure'));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('Échec du chiffrement des données sensibles');
        });
        it('gère les erreurs de déchiffrement gracieusement', async () => {
            global.crypto.subtle.decrypt.mockRejectedValue(new Error('Decrypt failure'));
            await expect(security.decryptSensitiveData('invalid')).rejects.toThrow('Échec du déchiffrement des données');
        });
    });
    describe('Anonymisation', () => {
        it('anonymise les données comportementales (async)', async () => {
            const pattern = {
                url: 'https://secret.com',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.interactions).toBe(pattern.interactions);
            expect(anonymized.timeSpent).toBe(pattern.timeSpent);
            expect(anonymized.scrollDepth).toBe(pattern.scrollDepth);
        });
        it('anonymise les données comportementales (sync)', () => {
            const pattern = {
                url: 'https://secret.com',
                userId: 'user123',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = security.anonymizeForSharingSync(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.userId).not.toBe('user123'); // Hashé
            expect(typeof anonymized.userId).toBe('string');
        });
        it('supprime les champs sensibles', async () => {
            const pattern = {
                url: 'https://secret.com',
                email: 'test@example.com',
                name: 'John Doe',
                phone: '123456789',
                interactions: 5
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.email).toBeUndefined();
            expect(anonymized.name).toBeUndefined();
            expect(anonymized.phone).toBeUndefined();
            expect(anonymized.interactions).toBe(5);
        });
    });
    describe('Contrôle d\'accès', () => {
        it('valide l\'accès utilisateur basique', () => {
            const request = { userId: 'user123', resource: 'organisms' };
            expect(security.validateDataAccess(request)).toBe(true);
        });
        it('rejette l\'accès admin sans rôle admin', () => {
            const request = { userId: 'user123', resource: 'admin', role: 'user' };
            expect(security.validateDataAccess(request, 'admin')).toBe(false);
        });
        it('accepte l\'accès admin avec rôle admin', () => {
            const request = { userId: 'admin123', resource: 'admin', role: 'admin' };
            expect(security.validateDataAccess(request, 'admin')).toBe(true);
        });
        it('rejette les requêtes invalides', () => {
            expect(security.validateDataAccess({ userId: '', resource: 'test' })).toBe(false);
            expect(security.validateDataAccess({ userId: 'user', resource: '' })).toBe(false);
        });
    });
    describe('Hashage', () => {
        it('hash des chaînes avec SHA-256', async () => {
            const testString = 'test-string';
            const hash = await security.hash(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
            expect(global.crypto.subtle.digest).toHaveBeenCalledWith('SHA-256', expect.any(Uint8Array));
        });
        it('produit des hashs cohérents', async () => {
            const testString = 'consistent-test';
            const hash1 = await security.hash(testString);
            const hash2 = await security.hash(testString);
            expect(hash1).toBe(hash2);
        });
        it('hash sync fonctionne comme fallback', () => {
            const testString = 'sync-test';
            const hash = security.hashSync(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvX190ZXN0c19fL1NlY3VyaXR5TWFuYWdlci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBRUEsOEJBQThCO0FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMzRCxXQUFXLEVBQUU7UUFDWCxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNO1FBQzVCLGVBQWUsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLGVBQWU7S0FDL0M7Q0FDRixDQUFDLENBQUMsQ0FBQztBQVJKLHVFQUFtRTtBQVVuRSxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksUUFBeUIsQ0FBQztJQUU5QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLFFBQVEsR0FBRyxJQUFJLGlDQUFlLEVBQUUsQ0FBQztJQUNuQyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7UUFDekMsRUFBRSxDQUFDLCtDQUErQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzdELE1BQU0sUUFBUSxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7WUFFdkMsK0NBQStDO1lBQy9DLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDNUMsTUFBTSxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDeEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFbEYsa0JBQWtCO1lBQ2xCLE1BQU0sU0FBUyxHQUFHLE1BQU0sUUFBUSxDQUFDLG9CQUFvQixD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SSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25DLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvbW50L2MvVXNlcnMvbV9vbGkvUHJvamV0cy9TWU1CSU9OVC9fX3Rlc3RzX18vU2VjdXJpdHlNYW5hZ2VyLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VjdXJpdHlNYW5hZ2VyIH0gZnJvbSAnLi4vc3JjL2JhY2tncm91bmQvU2VjdXJpdHlNYW5hZ2VyJ1xyXG5cclxuLy8gTW9jayBzZXJ2aWNlIHdvcmtlciBhZGFwdGVyXHJcbmplc3QubW9jaygnLi4vc3JjL2JhY2tncm91bmQvc2VydmljZS13b3JrZXItYWRhcHRlcicsICgpID0+ICh7XHJcbiAgc3dDcnlwdG9BUEk6IHtcclxuICAgIHN1YnRsZTogZ2xvYmFsLmNyeXB0by5zdWJ0bGUsXHJcbiAgICBnZXRSYW5kb21WYWx1ZXM6IGdsb2JhbC5jcnlwdG8uZ2V0UmFuZG9tVmFsdWVzXHJcbiAgfVxyXG59KSk7XHJcblxyXG5kZXNjcmliZSgnU2VjdXJpdHlNYW5hZ2VyJywgKCkgPT4ge1xyXG4gIGxldCBzZWN1cml0eTogU2VjdXJpdHlNYW5hZ2VyO1xyXG4gIFxyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcbiAgICBzZWN1cml0eSA9IG5ldyBTZWN1cml0eU1hbmFnZXIoKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0NoaWZmcmVtZW50L0TDqWNoaWZmcmVtZW50JywgKCkgPT4ge1xyXG4gICAgaXQoJ2NoaWZmcmUgZXQgZMOpY2hpZmZyZSBjb3JyZWN0ZW1lbnQgbGVzIGRvbm7DqWVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0RGF0YSA9IHsgZm9vOiAnYmFyJywgbjogNDIgfTtcclxuICAgICAgXHJcbiAgICAgIC8vIE1vY2sgZW5jcnlwdCBwb3VyIHJldG91cm5lciBkb25uw6llcyBlbmNvZMOpZXNcclxuICAgICAgY29uc3QgbW9ja1Jlc3VsdCA9IEpTT04uc3RyaW5naWZ5KHRlc3REYXRhKTtcclxuICAgICAgY29uc3QgbW9ja0VuY29kZWQgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUobW9ja1Jlc3VsdCk7XHJcbiAgICAgIChnbG9iYWwuY3J5cHRvLnN1YnRsZS5kZWNyeXB0IGFzIGplc3QuTW9jaykubW9ja1Jlc29sdmVkVmFsdWUobW9ja0VuY29kZWQuYnVmZmVyKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFRlc3QgZW5jcnlwdGlvblxyXG4gICAgICBjb25zdCBlbmNyeXB0ZWQgPSBhd2FpdCBzZWN1cml0eS5lbmNyeXB0U2Vuc2l0aXZlRGF0YSh0ZXN0RGF0YSk7XHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgZW5jcnlwdGVkKS50b0JlKCdzdHJpbmcnKTtcclxuICAgICAgZXhwZWN0KGdsb2JhbC5jcnlwdG8uc3VidGxlLmVuY3J5cHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFRlc3QgZGVjcnlwdGlvbiAgXHJcbiAgICAgIGNvbnN0IGRlY3J5cHRlZCA9IGF3YWl0IHNlY3VyaXR5LmRlY3J5cHRTZW5zaXRpdmVEYXRhKGVuY3J5cHRlZCk7XHJcbiAgICAgIGV4cGVjdChkZWNyeXB0ZWQpLnRvRXF1YWwodGVzdERhdGEpO1xyXG4gICAgICBleHBlY3QoZ2xvYmFsLmNyeXB0by5zdWJ0bGUuZGVjcnlwdCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2fDqHJlIGxlcyBlcnJldXJzIGRlIGNoaWZmcmVtZW50IGdyYWNpZXVzZW1lbnQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChnbG9iYWwuY3J5cHRvLnN1YnRsZS5lbmNyeXB0IGFzIGplc3QuTW9jaykubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdDcnlwdG8gZmFpbHVyZScpKTtcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGV4cGVjdChzZWN1cml0eS5lbmNyeXB0U2Vuc2l0aXZlRGF0YSh7fSkpLnJlamVjdHMudG9UaHJvdygnw4ljaGVjIGR1IGNoaWZmcmVtZW50IGRlcyBkb25uw6llcyBzZW5zaWJsZXMnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdnw6hyZSBsZXMgZXJyZXVycyBkZSBkw6ljaGlmZnJlbWVudCBncmFjaWV1c2VtZW50JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAoZ2xvYmFsLmNyeXB0by5zdWJ0bGUuZGVjcnlwdCBhcyBqZXN0Lk1vY2spLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignRGVjcnlwdCBmYWlsdXJlJykpO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZXhwZWN0KHNlY3VyaXR5LmRlY3J5cHRTZW5zaXRpdmVEYXRhKCdpbnZhbGlkJykpLnJlamVjdHMudG9UaHJvdygnw4ljaGVjIGR1IGTDqWNoaWZmcmVtZW50IGRlcyBkb25uw6llcycpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdBbm9ueW1pc2F0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ2Fub255bWlzZSBsZXMgZG9ubsOpZXMgY29tcG9ydGVtZW50YWxlcyAoYXN5bmMpJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXR0ZXJuID0geyBcclxuICAgICAgICB1cmw6ICdodHRwczovL3NlY3JldC5jb20nLCBcclxuICAgICAgICBpbnRlcmFjdGlvbnM6IDUsIFxyXG4gICAgICAgIHRpbWVTcGVudDogMTAsIFxyXG4gICAgICAgIHNjcm9sbERlcHRoOiAwLjgsIFxyXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSBcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGFub255bWl6ZWQgPSBhd2FpdCBzZWN1cml0eS5hbm9ueW1pemVGb3JTaGFyaW5nKHBhdHRlcm4pO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC51cmwpLnRvQmUoJ2Fub255bWl6ZWQnKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuaW50ZXJhY3Rpb25zKS50b0JlKHBhdHRlcm4uaW50ZXJhY3Rpb25zKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQudGltZVNwZW50KS50b0JlKHBhdHRlcm4udGltZVNwZW50KTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuc2Nyb2xsRGVwdGgpLnRvQmUocGF0dGVybi5zY3JvbGxEZXB0aCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnYW5vbnltaXNlIGxlcyBkb25uw6llcyBjb21wb3J0ZW1lbnRhbGVzIChzeW5jKScsICgpID0+IHtcclxuICAgICAgY29uc3QgcGF0dGVybiA9IHsgXHJcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9zZWNyZXQuY29tJywgXHJcbiAgICAgICAgdXNlcklkOiAndXNlcjEyMycsXHJcbiAgICAgICAgaW50ZXJhY3Rpb25zOiA1LCBcclxuICAgICAgICB0aW1lU3BlbnQ6IDEwLCBcclxuICAgICAgICBzY3JvbGxEZXB0aDogMC44LCBcclxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCkgXHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBhbm9ueW1pemVkID0gc2VjdXJpdHkuYW5vbnltaXplRm9yU2hhcmluZ1N5bmMocGF0dGVybik7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnVybCkudG9CZSgnYW5vbnltaXplZCcpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC51c2VySWQpLm5vdC50b0JlKCd1c2VyMTIzJyk7IC8vIEhhc2jDqVxyXG4gICAgICBleHBlY3QodHlwZW9mIGFub255bWl6ZWQudXNlcklkKS50b0JlKCdzdHJpbmcnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzdXBwcmltZSBsZXMgY2hhbXBzIHNlbnNpYmxlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcGF0dGVybiA9IHsgXHJcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9zZWNyZXQuY29tJyxcclxuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxyXG4gICAgICAgIG5hbWU6ICdKb2huIERvZScsXHJcbiAgICAgICAgcGhvbmU6ICcxMjM0NTY3ODknLFxyXG4gICAgICAgIGludGVyYWN0aW9uczogNVxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgY29uc3QgYW5vbnltaXplZCA9IGF3YWl0IHNlY3VyaXR5LmFub255bWl6ZUZvclNoYXJpbmcocGF0dGVybik7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLmVtYWlsKS50b0JlVW5kZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLm5hbWUpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQucGhvbmUpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuaW50ZXJhY3Rpb25zKS50b0JlKDUpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdDb250csO0bGUgZFxcJ2FjY8OocycsICgpID0+IHtcclxuICAgIGl0KCd2YWxpZGUgbFxcJ2FjY8OocyB1dGlsaXNhdGV1ciBiYXNpcXVlJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXF1ZXN0ID0geyB1c2VySWQ6ICd1c2VyMTIzJywgcmVzb3VyY2U6ICdvcmdhbmlzbXMnIH07XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MocmVxdWVzdCkpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgncmVqZXR0ZSBsXFwnYWNjw6hzIGFkbWluIHNhbnMgcsO0bGUgYWRtaW4nLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7IHVzZXJJZDogJ3VzZXIxMjMnLCByZXNvdXJjZTogJ2FkbWluJywgcm9sZTogJ3VzZXInIGFzIGNvbnN0IH07XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MocmVxdWVzdCwgJ2FkbWluJykpLnRvQmUoZmFsc2UpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2FjY2VwdGUgbFxcJ2FjY8OocyBhZG1pbiBhdmVjIHLDtGxlIGFkbWluJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXF1ZXN0ID0geyB1c2VySWQ6ICdhZG1pbjEyMycsIHJlc291cmNlOiAnYWRtaW4nLCByb2xlOiAnYWRtaW4nIGFzIGNvbnN0IH07XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MocmVxdWVzdCwgJ2FkbWluJykpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgncmVqZXR0ZSBsZXMgcmVxdcOqdGVzIGludmFsaWRlcycsICgpID0+IHtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2Vzcyh7IHVzZXJJZDogJycsIHJlc291cmNlOiAndGVzdCcgfSkpLnRvQmUoZmFsc2UpO1xyXG4gICAgICBleHBlY3Qoc2VjdXJpdHkudmFsaWRhdGVEYXRhQWNjZXNzKHsgdXNlcklkOiAndXNlcicsIHJlc291cmNlOiAnJyB9KSkudG9CZShmYWxzZSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0hhc2hhZ2UnLCAoKSA9PiB7XHJcbiAgICBpdCgnaGFzaCBkZXMgY2hhw65uZXMgYXZlYyBTSEEtMjU2JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0U3RyaW5nID0gJ3Rlc3Qtc3RyaW5nJztcclxuICAgICAgY29uc3QgaGFzaCA9IGF3YWl0IHNlY3VyaXR5Lmhhc2godGVzdFN0cmluZyk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QodHlwZW9mIGhhc2gpLnRvQmUoJ3N0cmluZycpO1xyXG4gICAgICBleHBlY3QoaGFzaC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuICAgICAgZXhwZWN0KGdsb2JhbC5jcnlwdG8uc3VidGxlLmRpZ2VzdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1NIQS0yNTYnLCBleHBlY3QuYW55KFVpbnQ4QXJyYXkpKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdwcm9kdWl0IGRlcyBoYXNocyBjb2jDqXJlbnRzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0U3RyaW5nID0gJ2NvbnNpc3RlbnQtdGVzdCc7XHJcbiAgICAgIGNvbnN0IGhhc2gxID0gYXdhaXQgc2VjdXJpdHkuaGFzaCh0ZXN0U3RyaW5nKTtcclxuICAgICAgY29uc3QgaGFzaDIgPSBhd2FpdCBzZWN1cml0eS5oYXNoKHRlc3RTdHJpbmcpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KGhhc2gxKS50b0JlKGhhc2gyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdoYXNoIHN5bmMgZm9uY3Rpb25uZSBjb21tZSBmYWxsYmFjaycsICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFN0cmluZyA9ICdzeW5jLXRlc3QnO1xyXG4gICAgICBjb25zdCBoYXNoID0gc2VjdXJpdHkuaGFzaFN5bmModGVzdFN0cmluZyk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QodHlwZW9mIGhhc2gpLnRvQmUoJ3N0cmluZycpO1xyXG4gICAgICBleHBlY3QoaGFzaC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTsgIl0sInZlcnNpb24iOjN9