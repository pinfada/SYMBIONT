3a5d1f8d800bd497d551d4bf42b991df
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('../src/background/service-worker-adapter', () => ({
    swCryptoAPI: {
        subtle: mockCryptoSubtle,
        getRandomValues: mockCryptoGetRandomValues
    }
}));
// Mock service-worker-adapter before importing SecurityManager
const mockCryptoSubtle = {
    generateKey: jest.fn().mockResolvedValue({
        type: 'secret',
        extractable: true,
        algorithm: { name: 'AES-GCM', length: 256 },
        usages: ['encrypt', 'decrypt']
    }),
    importKey: jest.fn().mockResolvedValue({
        type: 'secret',
        extractable: true,
        algorithm: { name: 'AES-GCM', length: 256 },
        usages: ['encrypt', 'decrypt']
    }),
    exportKey: jest.fn().mockResolvedValue(new ArrayBuffer(32)),
    encrypt: jest.fn().mockImplementation(async (algorithm, key, data) => {
        // Simulate realistic encryption result with proper buffer
        if (!data || !data.byteLength) {
            throw new Error('Data is required for encryption');
        }
        const ciphertext = new Uint8Array(data.byteLength + 16); // Add some auth tag bytes
        ciphertext.fill(0xBB);
        return ciphertext.buffer;
    }),
    decrypt: jest.fn().mockImplementation(async () => {
        const testData = JSON.stringify({ foo: 'bar', n: 42 });
        return new TextEncoder().encode(testData).buffer;
    }),
    digest: jest.fn().mockImplementation(async () => {
        const hash = new Uint8Array(32);
        hash.fill(0xCD);
        return hash.buffer;
    })
};
const mockCryptoGetRandomValues = jest.fn().mockImplementation((arr) => {
    // Fill with deterministic values for testing
    if (arr && arr.length) {
        for (let i = 0; i < arr.length; i++) {
            arr[i] = i % 256;
        }
    }
    return arr;
});
const SecurityManager_1 = require("../src/background/SecurityManager");
describe('SecurityManager', () => {
    let security;
    beforeEach(async () => {
        jest.clearAllMocks();
        // Reset all crypto mocks
        mockCryptoSubtle.generateKey.mockClear();
        mockCryptoSubtle.encrypt.mockClear();
        mockCryptoSubtle.decrypt.mockClear();
        mockCryptoSubtle.digest.mockClear();
        mockCryptoGetRandomValues.mockClear();
        // Create SecurityManager with manual initialization to avoid chrome.storage issues
        security = new SecurityManager_1.SecurityManager(true); // Skip auto-init
        // Manually set the encryption key for testing
        security.encryptionKey = {
            type: 'secret',
            extractable: true,
            algorithm: { name: 'AES-GCM', length: 256 },
            usages: ['encrypt', 'decrypt']
        };
    });
    describe('Chiffrement/Déchiffrement', () => {
        it('chiffre et déchiffre correctement les données', async () => {
            const testData = { foo: 'bar', n: 42 };
            // Test encryption
            try {
                const encrypted = await security.encryptSensitiveData(testData);
                expect(typeof encrypted).toBe('string');
                expect(encrypted.length).toBeGreaterThan(0);
                expect(mockCryptoSubtle.encrypt).toHaveBeenCalled();
                // Test decryption  
                const decrypted = await security.decryptSensitiveData(encrypted);
                expect(decrypted).toEqual(testData);
                expect(mockCryptoSubtle.decrypt).toHaveBeenCalled();
            }
            catch (error) {
                console.log('Mock calls:', {
                    getRandomValues: mockCryptoGetRandomValues.mock.calls,
                    encrypt: mockCryptoSubtle.encrypt.mock.calls
                });
                throw error;
            }
        });
        it('gère les erreurs de chiffrement gracieusement', async () => {
            mockCryptoSubtle.encrypt.mockRejectedValue(new Error('Crypto failure'));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('Échec du chiffrement des données sensibles');
        });
        it('gère les erreurs de déchiffrement gracieusement', async () => {
            mockCryptoSubtle.decrypt.mockRejectedValue(new Error('Decrypt failure'));
            await expect(security.decryptSensitiveData('invalid')).rejects.toThrow('Échec du déchiffrement des données');
        });
    });
    describe('Anonymisation', () => {
        it('anonymise les données comportementales (async)', async () => {
            const pattern = {
                url: 'https://secret.com',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.interactions).toBe(pattern.interactions);
            expect(anonymized.timeSpent).toBe(pattern.timeSpent);
            expect(anonymized.scrollDepth).toBe(pattern.scrollDepth);
        });
        it('anonymise les données comportementales (sync)', () => {
            const pattern = {
                url: 'https://secret.com',
                userId: 'user123',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = security.anonymizeForSharingSync(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.userId).not.toBe('user123'); // Hashé
            expect(typeof anonymized.userId).toBe('string');
        });
        it('supprime les champs sensibles', async () => {
            const pattern = {
                url: 'https://secret.com',
                email: 'test@example.com',
                name: 'John Doe',
                phone: '123456789',
                interactions: 5
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.email).toBeUndefined();
            expect(anonymized.name).toBeUndefined();
            expect(anonymized.phone).toBeUndefined();
            expect(anonymized.interactions).toBe(5);
        });
    });
    describe('Contrôle d\'accès', () => {
        it('valide l\'accès utilisateur basique', () => {
            const request = { userId: 'user123', resource: 'organisms' };
            expect(security.validateDataAccess(request)).toBe(true);
        });
        it('rejette l\'accès admin sans rôle admin', () => {
            const request = { userId: 'user123', resource: 'admin', role: 'user' };
            expect(security.validateDataAccess(request, 'admin')).toBe(false);
        });
        it('accepte l\'accès admin avec rôle admin', () => {
            const request = { userId: 'admin123', resource: 'admin', role: 'admin' };
            expect(security.validateDataAccess(request, 'admin')).toBe(true);
        });
        it('rejette les requêtes invalides', () => {
            expect(security.validateDataAccess({ userId: '', resource: 'test' })).toBe(false);
            expect(security.validateDataAccess({ userId: 'user', resource: '' })).toBe(false);
        });
    });
    describe('Hashage', () => {
        it('hash des chaînes avec SHA-256', async () => {
            const testString = 'test-string';
            const hash = await security.hash(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
            expect(mockCryptoSubtle.digest).toHaveBeenCalledWith('SHA-256', expect.any(Uint8Array));
        });
        it('produit des hashs cohérents', async () => {
            const testString = 'consistent-test';
            const hash1 = await security.hash(testString);
            const hash2 = await security.hash(testString);
            expect(hash1).toBe(hash2);
        });
        it('hash sync fonctionne comme fallback', () => {
            const testString = 'sync-test';
            const hash = security.hashSync(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
        });
    });
    describe('Initialisation', () => {
        it('peut être créé sans auto-initialisation', () => {
            const testSecurity = new SecurityManager_1.SecurityManager(true);
            expect(testSecurity).toBeInstanceOf(SecurityManager_1.SecurityManager);
        });
        it('gère gracieusement l\'absence de clé lors des opérations', async () => {
            const testSecurity = new SecurityManager_1.SecurityManager(true);
            // Sans clé définie, devrait essayer d'initialiser puis échouer proprement
            await expect(testSecurity.encryptSensitiveData({})).rejects.toThrow();
        });
        it('valide la présence de WebCrypto API', async () => {
            // Temporarily disable the crypto API
            const originalSubtle = mockCryptoSubtle;
            jest.doMock('../src/background/service-worker-adapter', () => ({
                swCryptoAPI: null
            }));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('WebCrypto API non disponible');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvX190ZXN0c19fL1NlY3VyaXR5TWFuYWdlci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBNkNBLElBQUksQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMzRCxXQUFXLEVBQUU7UUFDWCxNQUFNLEVBQUUsZ0JBQWdCO1FBQ3hCLGVBQWUsRUFBRSx5QkFBeUI7S0FDM0M7Q0FDRixDQUFDLENBQUMsQ0FBQztBQWxESiwrREFBK0Q7QUFDL0QsTUFBTSxnQkFBZ0IsR0FBRztJQUN2QixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO1FBQ3ZDLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLElBQUk7UUFDakIsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFO1FBQzNDLE1BQU0sRUFBRSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUM7S0FDbEIsQ0FBQztJQUNmLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUM7UUFDckMsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUU7UUFDM0MsTUFBTSxFQUFFLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQztLQUNsQixDQUFDO0lBQ2YsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ25FLDBEQUEwRDtRQUMxRCxJQUFJLENBQUMsSUFB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Q0FBcUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNuRCxxQ0FBcUM7WUFDckMsTUFBTSxjQUFjLEdBQUcsZ0JBQWdCLENBQUM7WUFDeEMsSUFBSSxDQUFDLE1BQU0sQ0FBQywwQ0FBMEMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUM3RCxXQUFXLEVBQUUsSUFBSTthQUNsQixDQUFDLENBQUMsQ0FBQztZQUVKLE1BQU0sTUFBTSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQztRQUNsRyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvX190ZXN0c19fL1NlY3VyaXR5TWFuYWdlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIE1vY2sgc2VydmljZS13b3JrZXItYWRhcHRlciBiZWZvcmUgaW1wb3J0aW5nIFNlY3VyaXR5TWFuYWdlclxyXG5jb25zdCBtb2NrQ3J5cHRvU3VidGxlID0ge1xyXG4gIGdlbmVyYXRlS2V5OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyBcclxuICAgIHR5cGU6ICdzZWNyZXQnLCBcclxuICAgIGV4dHJhY3RhYmxlOiB0cnVlLCBcclxuICAgIGFsZ29yaXRobTogeyBuYW1lOiAnQUVTLUdDTScsIGxlbmd0aDogMjU2IH0sIFxyXG4gICAgdXNhZ2VzOiBbJ2VuY3J5cHQnLCAnZGVjcnlwdCddIFxyXG4gIH0gYXMgQ3J5cHRvS2V5KSxcclxuICBpbXBvcnRLZXk6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IFxyXG4gICAgdHlwZTogJ3NlY3JldCcsIFxyXG4gICAgZXh0cmFjdGFibGU6IHRydWUsIFxyXG4gICAgYWxnb3JpdGhtOiB7IG5hbWU6ICdBRVMtR0NNJywgbGVuZ3RoOiAyNTYgfSwgXHJcbiAgICB1c2FnZXM6IFsnZW5jcnlwdCcsICdkZWNyeXB0J10gXHJcbiAgfSBhcyBDcnlwdG9LZXkpLFxyXG4gIGV4cG9ydEtleTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG5ldyBBcnJheUJ1ZmZlcigzMikpLFxyXG4gIGVuY3J5cHQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGFsZ29yaXRobSwga2V5LCBkYXRhKSA9PiB7XHJcbiAgICAvLyBTaW11bGF0ZSByZWFsaXN0aWMgZW5jcnlwdGlvbiByZXN1bHQgd2l0aCBwcm9wZXIgYnVmZmVyXHJcbiAgICBpZiAoIWRhdGEgfHwgIWRhdGEuYnl0ZUxlbmd0aCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGEgaXMgcmVxdWlyZWQgZm9yIGVuY3J5cHRpb24nKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGNpcGhlcnRleHQgPSBuZXcgVWludDhBcnJheShkYXRhLmJ5dGVMZW5ndGggKyAxNik7IC8vIEFkZCBzb21lIGF1dGggdGFnIGJ5dGVzXHJcbiAgICBjaXBoZXJ0ZXh0LmZpbGwoMHhCQik7XHJcbiAgICByZXR1cm4gY2lwaGVydGV4dC5idWZmZXI7XHJcbiAgfSksXHJcbiAgZGVjcnlwdDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCB0ZXN0RGF0YSA9IEpTT04uc3RyaW5naWZ5KHsgZm9vOiAnYmFyJywgbjogNDIgfSk7XHJcbiAgICByZXR1cm4gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHRlc3REYXRhKS5idWZmZXI7XHJcbiAgfSksXHJcbiAgZGlnZXN0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IGhhc2ggPSBuZXcgVWludDhBcnJheSgzMik7XHJcbiAgICBoYXNoLmZpbGwoMHhDRCk7XHJcbiAgICByZXR1cm4gaGFzaC5idWZmZXI7XHJcbiAgfSlcclxufTtcclxuXHJcbmNvbnN0IG1vY2tDcnlwdG9HZXRSYW5kb21WYWx1ZXMgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChhcnIpID0+IHtcclxuICAvLyBGaWxsIHdpdGggZGV0ZXJtaW5pc3RpYyB2YWx1ZXMgZm9yIHRlc3RpbmdcclxuICBpZiAoYXJyICYmIGFyci5sZW5ndGgpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGFycltpXSA9IGkgJSAyNTY7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBhcnI7XHJcbn0pO1xyXG5cclxuamVzdC5tb2NrKCcuLi9zcmMvYmFja2dyb3VuZC9zZXJ2aWNlLXdvcmtlci1hZGFwdGVyJywgKCkgPT4gKHtcclxuICBzd0NyeXB0b0FQSToge1xyXG4gICAgc3VidGxlOiBtb2NrQ3J5cHRvU3VidGxlLFxyXG4gICAgZ2V0UmFuZG9tVmFsdWVzOiBtb2NrQ3J5cHRvR2V0UmFuZG9tVmFsdWVzXHJcbiAgfVxyXG59KSk7XHJcblxyXG5pbXBvcnQgeyBTZWN1cml0eU1hbmFnZXIgfSBmcm9tICcuLi9zcmMvYmFja2dyb3VuZC9TZWN1cml0eU1hbmFnZXInXHJcblxyXG5kZXNjcmliZSgnU2VjdXJpdHlNYW5hZ2VyJywgKCkgPT4ge1xyXG4gIGxldCBzZWN1cml0eTogU2VjdXJpdHlNYW5hZ2VyO1xyXG4gIFxyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcbiAgICBcclxuICAgIC8vIFJlc2V0IGFsbCBjcnlwdG8gbW9ja3NcclxuICAgIG1vY2tDcnlwdG9TdWJ0bGUuZ2VuZXJhdGVLZXkubW9ja0NsZWFyKCk7XHJcbiAgICBtb2NrQ3J5cHRvU3VidGxlLmVuY3J5cHQubW9ja0NsZWFyKCk7XHJcbiAgICBtb2NrQ3J5cHRvU3VidGxlLmRlY3J5cHQubW9ja0NsZWFyKCk7XHJcbiAgICBtb2NrQ3J5cHRvU3VidGxlLmRpZ2VzdC5tb2NrQ2xlYXIoKTtcclxuICAgIG1vY2tDcnlwdG9HZXRSYW5kb21WYWx1ZXMubW9ja0NsZWFyKCk7XHJcbiAgICBcclxuICAgIC8vIENyZWF0ZSBTZWN1cml0eU1hbmFnZXIgd2l0aCBtYW51YWwgaW5pdGlhbGl6YXRpb24gdG8gYXZvaWQgY2hyb21lLnN0b3JhZ2UgaXNzdWVzXHJcbiAgICBzZWN1cml0eSA9IG5ldyBTZWN1cml0eU1hbmFnZXIodHJ1ZSk7IC8vIFNraXAgYXV0by1pbml0XHJcbiAgICBcclxuICAgIC8vIE1hbnVhbGx5IHNldCB0aGUgZW5jcnlwdGlvbiBrZXkgZm9yIHRlc3RpbmdcclxuICAgIChzZWN1cml0eSBhcyBhbnkpLmVuY3J5cHRpb25LZXkgPSB7IFxyXG4gICAgICB0eXBlOiAnc2VjcmV0JywgXHJcbiAgICAgIGV4dHJhY3RhYmxlOiB0cnVlLCBcclxuICAgICAgYWxnb3JpdGhtOiB7IG5hbWU6ICdBRVMtR0NNJywgbGVuZ3RoOiAyNTYgfSwgXHJcbiAgICAgIHVzYWdlczogWydlbmNyeXB0JywgJ2RlY3J5cHQnXSBcclxuICAgIH0gYXMgQ3J5cHRvS2V5O1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnQ2hpZmZyZW1lbnQvRMOpY2hpZmZyZW1lbnQnLCAoKSA9PiB7XHJcbiAgICBpdCgnY2hpZmZyZSBldCBkw6ljaGlmZnJlIGNvcnJlY3RlbWVudCBsZXMgZG9ubsOpZXMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3REYXRhID0geyBmb286ICdiYXInLCBuOiA0MiB9O1xyXG4gICAgICBcclxuICAgICAgLy8gVGVzdCBlbmNyeXB0aW9uXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgZW5jcnlwdGVkID0gYXdhaXQgc2VjdXJpdHkuZW5jcnlwdFNlbnNpdGl2ZURhdGEodGVzdERhdGEpO1xyXG4gICAgICAgIGV4cGVjdCh0eXBlb2YgZW5jcnlwdGVkKS50b0JlKCdzdHJpbmcnKTtcclxuICAgICAgICBleHBlY3QoZW5jcnlwdGVkLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICAgIGV4cGVjdChtb2NrQ3J5cHRvU3VidGxlLmVuY3J5cHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBUZXN0IGRlY3J5cHRpb24gIFxyXG4gICAgICAgIGNvbnN0IGRlY3J5cHRlZCA9IGF3YWl0IHNlY3VyaXR5LmRlY3J5cHRTZW5zaXRpdmVEYXRhKGVuY3J5cHRlZCk7XHJcbiAgICAgICAgZXhwZWN0KGRlY3J5cHRlZCkudG9FcXVhbCh0ZXN0RGF0YSk7XHJcbiAgICAgICAgZXhwZWN0KG1vY2tDcnlwdG9TdWJ0bGUuZGVjcnlwdCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdNb2NrIGNhbGxzOicsIHtcclxuICAgICAgICAgIGdldFJhbmRvbVZhbHVlczogbW9ja0NyeXB0b0dldFJhbmRvbVZhbHVlcy5tb2NrLmNhbGxzLFxyXG4gICAgICAgICAgZW5jcnlwdDogbW9ja0NyeXB0b1N1YnRsZS5lbmNyeXB0Lm1vY2suY2FsbHNcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2fDqHJlIGxlcyBlcnJldXJzIGRlIGNoaWZmcmVtZW50IGdyYWNpZXVzZW1lbnQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tDcnlwdG9TdWJ0bGUuZW5jcnlwdC5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0NyeXB0byBmYWlsdXJlJykpO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZXhwZWN0KHNlY3VyaXR5LmVuY3J5cHRTZW5zaXRpdmVEYXRhKHt9KSkucmVqZWN0cy50b1Rocm93KCfDiWNoZWMgZHUgY2hpZmZyZW1lbnQgZGVzIGRvbm7DqWVzIHNlbnNpYmxlcycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2fDqHJlIGxlcyBlcnJldXJzIGRlIGTDqWNoaWZmcmVtZW50IGdyYWNpZXVzZW1lbnQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tDcnlwdG9TdWJ0bGUuZGVjcnlwdC5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0RlY3J5cHQgZmFpbHVyZScpKTtcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGV4cGVjdChzZWN1cml0eS5kZWNyeXB0U2Vuc2l0aXZlRGF0YSgnaW52YWxpZCcpKS5yZWplY3RzLnRvVGhyb3coJ8OJY2hlYyBkdSBkw6ljaGlmZnJlbWVudCBkZXMgZG9ubsOpZXMnKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnQW5vbnltaXNhdGlvbicsICgpID0+IHtcclxuICAgIGl0KCdhbm9ueW1pc2UgbGVzIGRvbm7DqWVzIGNvbXBvcnRlbWVudGFsZXMgKGFzeW5jKScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcGF0dGVybiA9IHsgXHJcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9zZWNyZXQuY29tJywgXHJcbiAgICAgICAgaW50ZXJhY3Rpb25zOiA1LCBcclxuICAgICAgICB0aW1lU3BlbnQ6IDEwLCBcclxuICAgICAgICBzY3JvbGxEZXB0aDogMC44LCBcclxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCkgXHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBhbm9ueW1pemVkID0gYXdhaXQgc2VjdXJpdHkuYW5vbnltaXplRm9yU2hhcmluZyhwYXR0ZXJuKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQudXJsKS50b0JlKCdhbm9ueW1pemVkJyk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLmludGVyYWN0aW9ucykudG9CZShwYXR0ZXJuLmludGVyYWN0aW9ucyk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnRpbWVTcGVudCkudG9CZShwYXR0ZXJuLnRpbWVTcGVudCk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnNjcm9sbERlcHRoKS50b0JlKHBhdHRlcm4uc2Nyb2xsRGVwdGgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2Fub255bWlzZSBsZXMgZG9ubsOpZXMgY29tcG9ydGVtZW50YWxlcyAoc3luYyknLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhdHRlcm4gPSB7IFxyXG4gICAgICAgIHVybDogJ2h0dHBzOi8vc2VjcmV0LmNvbScsIFxyXG4gICAgICAgIHVzZXJJZDogJ3VzZXIxMjMnLFxyXG4gICAgICAgIGludGVyYWN0aW9uczogNSwgXHJcbiAgICAgICAgdGltZVNwZW50OiAxMCwgXHJcbiAgICAgICAgc2Nyb2xsRGVwdGg6IDAuOCwgXHJcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpIFxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgY29uc3QgYW5vbnltaXplZCA9IHNlY3VyaXR5LmFub255bWl6ZUZvclNoYXJpbmdTeW5jKHBhdHRlcm4pO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC51cmwpLnRvQmUoJ2Fub255bWl6ZWQnKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQudXNlcklkKS5ub3QudG9CZSgndXNlcjEyMycpOyAvLyBIYXNow6lcclxuICAgICAgZXhwZWN0KHR5cGVvZiBhbm9ueW1pemVkLnVzZXJJZCkudG9CZSgnc3RyaW5nJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc3VwcHJpbWUgbGVzIGNoYW1wcyBzZW5zaWJsZXMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhdHRlcm4gPSB7IFxyXG4gICAgICAgIHVybDogJ2h0dHBzOi8vc2VjcmV0LmNvbScsXHJcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcclxuICAgICAgICBuYW1lOiAnSm9obiBEb2UnLFxyXG4gICAgICAgIHBob25lOiAnMTIzNDU2Nzg5JyxcclxuICAgICAgICBpbnRlcmFjdGlvbnM6IDVcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGFub255bWl6ZWQgPSBhd2FpdCBzZWN1cml0eS5hbm9ueW1pemVGb3JTaGFyaW5nKHBhdHRlcm4pO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5lbWFpbCkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5uYW1lKS50b0JlVW5kZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnBob25lKS50b0JlVW5kZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLmludGVyYWN0aW9ucykudG9CZSg1KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnQ29udHLDtGxlIGRcXCdhY2PDqHMnLCAoKSA9PiB7XHJcbiAgICBpdCgndmFsaWRlIGxcXCdhY2PDqHMgdXRpbGlzYXRldXIgYmFzaXF1ZScsICgpID0+IHtcclxuICAgICAgY29uc3QgcmVxdWVzdCA9IHsgdXNlcklkOiAndXNlcjEyMycsIHJlc291cmNlOiAnb3JnYW5pc21zJyB9O1xyXG4gICAgICBleHBlY3Qoc2VjdXJpdHkudmFsaWRhdGVEYXRhQWNjZXNzKHJlcXVlc3QpKS50b0JlKHRydWUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3JlamV0dGUgbFxcJ2FjY8OocyBhZG1pbiBzYW5zIHLDtGxlIGFkbWluJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXF1ZXN0ID0geyB1c2VySWQ6ICd1c2VyMTIzJywgcmVzb3VyY2U6ICdhZG1pbicsIHJvbGU6ICd1c2VyJyBhcyBjb25zdCB9O1xyXG4gICAgICBleHBlY3Qoc2VjdXJpdHkudmFsaWRhdGVEYXRhQWNjZXNzKHJlcXVlc3QsICdhZG1pbicpKS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdhY2NlcHRlIGxcXCdhY2PDqHMgYWRtaW4gYXZlYyByw7RsZSBhZG1pbicsICgpID0+IHtcclxuICAgICAgY29uc3QgcmVxdWVzdCA9IHsgdXNlcklkOiAnYWRtaW4xMjMnLCByZXNvdXJjZTogJ2FkbWluJywgcm9sZTogJ2FkbWluJyBhcyBjb25zdCB9O1xyXG4gICAgICBleHBlY3Qoc2VjdXJpdHkudmFsaWRhdGVEYXRhQWNjZXNzKHJlcXVlc3QsICdhZG1pbicpKS50b0JlKHRydWUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3JlamV0dGUgbGVzIHJlcXXDqnRlcyBpbnZhbGlkZXMnLCAoKSA9PiB7XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MoeyB1c2VySWQ6ICcnLCByZXNvdXJjZTogJ3Rlc3QnIH0pKS50b0JlKGZhbHNlKTtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2Vzcyh7IHVzZXJJZDogJ3VzZXInLCByZXNvdXJjZTogJycgfSkpLnRvQmUoZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdIYXNoYWdlJywgKCkgPT4ge1xyXG4gICAgaXQoJ2hhc2ggZGVzIGNoYcOubmVzIGF2ZWMgU0hBLTI1NicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFN0cmluZyA9ICd0ZXN0LXN0cmluZyc7XHJcbiAgICAgIGNvbnN0IGhhc2ggPSBhd2FpdCBzZWN1cml0eS5oYXNoKHRlc3RTdHJpbmcpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHR5cGVvZiBoYXNoKS50b0JlKCdzdHJpbmcnKTtcclxuICAgICAgZXhwZWN0KGhhc2gubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcbiAgICAgIGV4cGVjdChtb2NrQ3J5cHRvU3VidGxlLmRpZ2VzdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1NIQS0yNTYnLCBleHBlY3QuYW55KFVpbnQ4QXJyYXkpKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdwcm9kdWl0IGRlcyBoYXNocyBjb2jDqXJlbnRzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0U3RyaW5nID0gJ2NvbnNpc3RlbnQtdGVzdCc7XHJcbiAgICAgIGNvbnN0IGhhc2gxID0gYXdhaXQgc2VjdXJpdHkuaGFzaCh0ZXN0U3RyaW5nKTtcclxuICAgICAgY29uc3QgaGFzaDIgPSBhd2FpdCBzZWN1cml0eS5oYXNoKHRlc3RTdHJpbmcpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KGhhc2gxKS50b0JlKGhhc2gyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdoYXNoIHN5bmMgZm9uY3Rpb25uZSBjb21tZSBmYWxsYmFjaycsICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFN0cmluZyA9ICdzeW5jLXRlc3QnO1xyXG4gICAgICBjb25zdCBoYXNoID0gc2VjdXJpdHkuaGFzaFN5bmModGVzdFN0cmluZyk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QodHlwZW9mIGhhc2gpLnRvQmUoJ3N0cmluZycpO1xyXG4gICAgICBleHBlY3QoaGFzaC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnSW5pdGlhbGlzYXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgncGV1dCDDqnRyZSBjcsOpw6kgc2FucyBhdXRvLWluaXRpYWxpc2F0aW9uJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0U2VjdXJpdHkgPSBuZXcgU2VjdXJpdHlNYW5hZ2VyKHRydWUpO1xyXG4gICAgICBleHBlY3QodGVzdFNlY3VyaXR5KS50b0JlSW5zdGFuY2VPZihTZWN1cml0eU1hbmFnZXIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2fDqHJlIGdyYWNpZXVzZW1lbnQgbFxcJ2Fic2VuY2UgZGUgY2zDqSBsb3JzIGRlcyBvcMOpcmF0aW9ucycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFNlY3VyaXR5ID0gbmV3IFNlY3VyaXR5TWFuYWdlcih0cnVlKTtcclxuICAgICAgLy8gU2FucyBjbMOpIGTDqWZpbmllLCBkZXZyYWl0IGVzc2F5ZXIgZCdpbml0aWFsaXNlciBwdWlzIMOpY2hvdWVyIHByb3ByZW1lbnRcclxuICAgICAgYXdhaXQgZXhwZWN0KHRlc3RTZWN1cml0eS5lbmNyeXB0U2Vuc2l0aXZlRGF0YSh7fSkpLnJlamVjdHMudG9UaHJvdygpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3ZhbGlkZSBsYSBwcsOpc2VuY2UgZGUgV2ViQ3J5cHRvIEFQSScsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gVGVtcG9yYXJpbHkgZGlzYWJsZSB0aGUgY3J5cHRvIEFQSVxyXG4gICAgICBjb25zdCBvcmlnaW5hbFN1YnRsZSA9IG1vY2tDcnlwdG9TdWJ0bGU7XHJcbiAgICAgIGplc3QuZG9Nb2NrKCcuLi9zcmMvYmFja2dyb3VuZC9zZXJ2aWNlLXdvcmtlci1hZGFwdGVyJywgKCkgPT4gKHtcclxuICAgICAgICBzd0NyeXB0b0FQSTogbnVsbFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VjdXJpdHkuZW5jcnlwdFNlbnNpdGl2ZURhdGEoe30pKS5yZWplY3RzLnRvVGhyb3coJ1dlYkNyeXB0byBBUEkgbm9uIGRpc3BvbmlibGUnKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTsgIl0sInZlcnNpb24iOjN9