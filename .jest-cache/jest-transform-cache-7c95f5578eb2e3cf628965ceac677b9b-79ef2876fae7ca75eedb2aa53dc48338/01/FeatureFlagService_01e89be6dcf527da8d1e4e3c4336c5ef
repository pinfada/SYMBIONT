e127908206a41a84f92ece341efeedfc
"use strict";
/**
 * FeatureFlagService - Gestion centralisÃ©e des feature flags
 * SÃ©pare proprement le comportement dev/staging/production
 */
Object.defineProperty(exports, "__esModule", { value: true });
class FeatureFlagService {
    constructor() {
        this.overrides = {};
        this.environment = this.detectEnvironment();
        this.flags = this.initializeFlags();
        this.loadOverrides();
    }
    static getInstance() {
        if (!FeatureFlagService.instance) {
            FeatureFlagService.instance = new FeatureFlagService();
        }
        return FeatureFlagService.instance;
    }
    /**
     * DÃ©tecte l'environnement actuel
     */
    detectEnvironment() {
        // 1. Variable d'environnement explicite
        const nodeEnv = process.env.NODE_ENV;
        if (nodeEnv === 'production')
            return 'production';
        if (nodeEnv === 'staging')
            return 'staging';
        if (nodeEnv === 'development')
            return 'development';
        // 2. DÃ©tection par URL (pour extensions)
        if (typeof window !== 'undefined') {
            const url = window.location.href;
            if (url.includes('staging'))
                return 'staging';
            if (url.includes('localhost') || url.includes('127.0.0.1'))
                return 'development';
            if (url.startsWith('chrome-extension://')) {
                // Extension en prod si pas de marqueur dev
                return url.includes('dev') ? 'development' : 'production';
            }
        }
        // 3. Fallback dÃ©veloppement
        return 'development';
    }
    /**
     * Initialise les flags selon l'environnement
     */
    initializeFlags() {
        const baseFlags = {
            USE_REAL_METRICS: false,
            USE_REAL_DNA: false,
            USE_REAL_BEHAVIOR: false,
            USE_BACKEND_API: false,
            ENABLE_DEBUG_LOGGING: false,
            ENABLE_PERFORMANCE_PROFILING: false,
            ENABLE_MOCK_DATA: true,
            ENABLE_SECURITY_AUDIT: false,
            ENABLE_ADVANCED_ANALYTICS: false,
            ENABLE_A_B_TESTING: false
        };
        switch (this.environment) {
            case 'development':
                return {
                    ...baseFlags,
                    ENABLE_DEBUG_LOGGING: true,
                    ENABLE_PERFORMANCE_PROFILING: true,
                    ENABLE_MOCK_DATA: true,
                    ENABLE_SECURITY_AUDIT: true,
                    // PossibilitÃ© d'activer vraies donnÃ©es en dev pour tests
                    USE_REAL_METRICS: this.getEnvBoolean('USE_REAL_METRICS', false),
                    USE_REAL_DNA: this.getEnvBoolean('USE_REAL_DNA', false),
                    USE_REAL_BEHAVIOR: this.getEnvBoolean('USE_REAL_BEHAVIOR', false),
                    USE_BACKEND_API: this.getEnvBoolean('USE_BACKEND_API', false)
                };
            case 'staging':
                return {
                    ...baseFlags,
                    USE_REAL_METRICS: true,
                    USE_REAL_DNA: true,
                    USE_REAL_BEHAVIOR: true,
                    USE_BACKEND_API: true,
                    ENABLE_DEBUG_LOGGING: false,
                    ENABLE_PERFORMANCE_PROFILING: true,
                    ENABLE_MOCK_DATA: false,
                    ENABLE_SECURITY_AUDIT: true,
                    ENABLE_ADVANCED_ANALYTICS: true,
                    ENABLE_A_B_TESTING: true
                };
            case 'production':
                return {
                    ...baseFlags,
                    USE_REAL_METRICS: true,
                    USE_REAL_DNA: true,
                    USE_REAL_BEHAVIOR: true,
                    USE_BACKEND_API: true,
                    ENABLE_DEBUG_LOGGING: false,
                    ENABLE_PERFORMANCE_PROFILING: false,
                    ENABLE_MOCK_DATA: false,
                    ENABLE_SECURITY_AUDIT: false,
                    ENABLE_ADVANCED_ANALYTICS: true,
                    ENABLE_A_B_TESTING: false // DÃ©sactivÃ© par dÃ©faut en prod
                };
            default:
                return baseFlags;
        }
    }
    /**
     * Charge les overrides depuis localStorage et variables d'env
     */
    loadOverrides() {
        // 1. Variables d'environnement
        Object.keys(this.flags).forEach(flag => {
            const envValue = process.env[`SYMBIONT_${flag}`];
            if (envValue !== undefined) {
                this.overrides[flag] = envValue === 'true';
            }
        });
        // 2. localStorage (pour tests manuels en dev)
        if (this.environment === 'development' && typeof localStorage !== 'undefined') {
            Object.keys(this.flags).forEach(flag => {
                const storageKey = `symbiont_feature_${flag.toLowerCase()}`;
                const storageValue = localStorage.getItem(storageKey);
                if (storageValue !== null) {
                    this.overrides[flag] = storageValue === 'true';
                }
            });
        }
    }
    /**
     * Obtient la valeur d'un feature flag
     */
    isEnabled(flag) {
        // 1. Override explicite
        if (this.overrides[flag] !== undefined) {
            return this.overrides[flag];
        }
        // 2. Valeur par dÃ©faut selon environnement
        return this.flags[flag];
    }
    /**
     * Override temporaire d'un flag (dev uniquement)
     */
    setFlag(flag, value) {
        if (this.environment !== 'development') {
            console.warn(`âš ï¸ Override de feature flag '${flag}' ignorÃ© en ${this.environment}`);
            return;
        }
        this.overrides[flag] = value;
        // Sauvegarder en localStorage pour persistence
        if (typeof localStorage !== 'undefined') {
            const storageKey = `symbiont_feature_${flag.toLowerCase()}`;
            localStorage.setItem(storageKey, value.toString());
        }
        console.log(`ðŸ”§ Feature flag '${flag}' dÃ©fini Ã  ${value}`);
    }
    /**
     * Remet Ã  zÃ©ro tous les overrides
     */
    resetOverrides() {
        if (this.environment !== 'development') {
            console.warn('âš ï¸ Reset des overrides ignorÃ© en production');
            return;
        }
        this.overrides = {};
        // Nettoyer localStorage
        if (typeof localStorage !== 'undefined') {
            Object.keys(this.flags).forEach(flag => {
                const storageKey = `symbiont_feature_${flag.toLowerCase()}`;
                localStorage.removeItem(storageKey);
            });
        }
        console.log('ðŸ”„ Tous les feature flags remis aux valeurs par dÃ©faut');
    }
    /**
     * Obtient l'environnement actuel
     */
    getEnvironment() {
        return this.environment;
    }
    /**
     * Obtient tous les flags actuels (pour debug)
     */
    getAllFlags() {
        const resolvedFlags = {};
        Object.keys(this.flags).forEach(flag => {
            resolvedFlags[flag] = this.isEnabled(flag);
        });
        return {
            ...resolvedFlags,
            environment: this.environment
        };
    }
    /**
     * VÃ©rifie si on est en mode dÃ©veloppement
     */
    isDevelopment() {
        return this.environment === 'development';
    }
    /**
     * VÃ©rifie si on est en mode staging
     */
    isStaging() {
        return this.environment === 'staging';
    }
    /**
     * VÃ©rifie si on est en mode production
     */
    isProduction() {
        return this.environment === 'production';
    }
    /**
     * ExÃ©cute du code conditionnel selon l'environnement
     */
    runInEnvironment(handlers) {
        const handler = handlers[this.environment] || handlers.default;
        return handler?.();
    }
    /**
     * Log conditionnel selon les feature flags
     */
    debugLog(message, ...args) {
        if (this.isEnabled('ENABLE_DEBUG_LOGGING')) {
            console.log(`ðŸ› [SYMBIONT Debug] ${message}`, ...args);
        }
    }
    /**
     * Performance profiling conditionnel
     */
    profileOperation(name, operation) {
        if (!this.isEnabled('ENABLE_PERFORMANCE_PROFILING')) {
            return operation();
        }
        const start = performance.now();
        const result = operation();
        const duration = performance.now() - start;
        console.log(`â±ï¸ [SYMBIONT Profile] ${name}: ${duration.toFixed(2)}ms`);
        return result;
    }
    /**
     * ExÃ©cution conditionnelle selon feature flag
     */
    whenEnabled(flag, operation) {
        return this.isEnabled(flag) ? operation() : undefined;
    }
    /**
     * Utilitaire pour lire variables d'environnement boolean
     */
    getEnvBoolean(key, defaultValue) {
        const value = process.env[key];
        if (value === undefined)
            return defaultValue;
        return value.toLowerCase() === 'true';
    }
    /**
     * Validation de sÃ©curitÃ© - vÃ©rifie qu'on n'utilise pas de donnÃ©es mock en prod
     */
    validateProductionSafety() {
        if (!this.isProduction())
            return;
        const unsafeFlags = [
            'ENABLE_MOCK_DATA',
            'ENABLE_DEBUG_LOGGING'
        ];
        const violations = unsafeFlags.filter(flag => this.isEnabled(flag));
        if (violations.length > 0) {
            throw new Error(`ðŸš¨ SÃ‰CURITÃ‰: Flags dangereux activÃ©s en production: ${violations.join(', ')}`);
        }
    }
}
exports.default = FeatureFlagService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvc3JjL2NvcmUvc2VydmljZXMvRmVhdHVyZUZsYWdTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBaUJILE1BQU0sa0JBQWtCO0lBTXRCO1FBRlEsY0FBUyxHQUEwQixFQUFFLENBQUM7UUFHNUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXO1FBQ2hCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNqQyxrQkFBa0IsQ0FBQyxRQUFRLEdBQUcsSUFBSSxrQkFBa0IsRUFBRSxDQUFDO1FBQ3pELENBQUM7UUFDRCxPQUFPLGtCQUFrQixDQUFDLFFBQVEsQ0FBQztJQUNyQyxDQUFDO0lBRUQ7O09BRUc7SUFDSyxpQkFBaUI7UUFDdkIsd0NBQXdDO1FBQ3hDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3JDLElBQUksT0FBTyxLQUFLLFlBQVk7WUFBRSxPQUFPLFlBQVksQ0FBQztRQUNsRCxJQUFJLE9BQU8sS0FBSyxTQUFTO1lBQUUsT0FBTyxTQUFTLENBQUM7UUFDNUMsSUFBSSxPQUFPLEtBQUssYUFBYTtZQUFFLE9BQU8sYUFBYSxDQUFDO1FBRXBELHlDQUF5QztRQUN6QyxJQUFJLE9BQU8sTUFBTSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQ2xDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ2pDLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUM7Z0JBQUUsT0FBTyxTQUFTLENBQUM7WUFDOUMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO2dCQUFFLE9BQU8sYUFBYSxDQUFDO1lBQ2pGLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUM7Z0JBQzFDLDJDQUEyQztnQkFDM0MsT0FBTyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQztZQUM1RCxDQUFDO1FBQ0gsQ0FBQztRQUVELDRCQUE0QjtRQUM1QixPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSyxlQUFlO1FBQ3JCLE1BQU0sU0FBUyxHQUFpQjtZQUM5QixnQkFBZ0IsRUFBRSxLQUFLO1lBQ3ZCLFlBQVksRUFBRSxLQUFLO1lBQ25CLGlCQUFpQixFQUFFLEtBQUs7WUFDeEIsZUFBZSxFQUFFLEtBQUs7WUFDdEIsb0JBQW9CLEVBQUUsS0FBSztZQUMzQiw0QkFBNEIsRUFBRSxLQUFLO1lBQ25DLGdCQUFnQixFQUFFLElBQUk7WUFDdEIscUJBQXFCLEVBQUUsS0FBSztZQUM1Qix5QkFBeUIsRUFBRSxLQUFLO1lBQ2hDLGtCQUFrQixFQUFFLEtBQUs7U0FDMUIsQ0FBQztRQUVGLFFBQVEsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3pCLEtBQUssYUFBYTtnQkFDaEIsT0FBTztvQkFDTCxHQUFHLFNBQVM7b0JBQ1osb0JBQW9CLEVBQUUsSUFBSTtvQkFDMUIsNEJBQTRCLEVBQUUsSUFBSTtvQkFDbEMsZ0JBQWdCLEVBQUUsSUFBSTtvQkFDdEIscUJBQXFCLEVBQUUsSUFBSTtvQkFDM0IseURBQXlEO29CQUN6RCxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixFQUFFLEtBQUssQ0FBQztvQkFDL0QsWUFBWSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQztvQkFDdkQsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLENBQUM7b0JBQ2pFLGVBQWUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixFQUFFLEtBQUssQ0FBQztpQkFDOUQsQ0FBQztZQUVKLEtBQUssU0FBUztnQkFDWixPQUFPO29CQUNMLEdBQUcsU0FBUztvQkFDWixnQkFBZ0IsRUFBRSxJQUFJO29CQUN0QixZQUFZLEVBQUUsSUFBSTtvQkFDbEIsaUJBQWlCLEVBQUUsSUFBSTtvQkFDdkIsZUFBZSxFQUFFLElBQUk7b0JBQ3JCLG9CQUFvQixFQUFFLEtBQUs7b0JBQzNCLDRCQUE0QixFQUFFLElBQUk7b0JBQ2xDLGdCQUFnQixFQUFFLEtBQUs7b0JBQ3ZCLHFCQUFxQixFQUFFLElBQUk7b0JBQzNCLHlCQUF5QixFQUFFLElBQUk7b0JBQy9CLGtCQUFrQixFQUFFLElBQUk7aUJBQ3pCLENBQUM7WUFFSixLQUFLLFlBQVk7Z0JBQ2YsT0FBTztvQkFDTCxHQUFHLFNBQVM7b0JBQ1osZ0JBQWdCLEVBQUUsSUFBSTtvQkFDdEIsWUFBWSxFQUFFLElBQUk7b0JBQ2xCLGlCQUFpQixFQUFFLElBQUk7b0JBQ3ZCLGVBQWUsRUFBRSxJQUFJO29CQUNyQixvQkFBb0IsRUFBRSxLQUFLO29CQUMzQiw0QkFBNEIsRUFBRSxLQUFLO29CQUNuQyxnQkFBZ0IsRUFBRSxLQUFLO29CQUN2QixxQkFBcUIsRUFBRSxLQUFLO29CQUM1Qix5QkFBeUIsRUFBRSxJQUFJO29CQUMvQixrQkFBa0IsRUFBRSxLQUFLLENBQUMsK0JBQStCO2lCQUMxRCxDQUFDO1lBRUo7Z0JBQ0UsT0FBTyxTQUFTLENBQUM7UUFDckIsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLGFBQWE7UUFDbkIsK0JBQStCO1FBQy9CLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNyQyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNqRCxJQUFJLFFBQVEsS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDM0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUEwQixDQUFDLEdBQUcsUUFBUSxLQUFLLE1BQU0sQ0FBQztZQUNuRSxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCw4Q0FBOEM7UUFDOUMsSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLGFBQWEsSUFBSSxPQUFPLFlBQVksS0FBSyxXQUFXLEVBQUUsQ0FBQztZQUM5RSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3JDLE1BQU0sVUFBVSxHQUFHLG9CQUFvQixJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQztnQkFDNUQsTUFBTSxZQUFZLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDdEQsSUFBSSxZQUFZLEtBQUssSUFBSSxFQUFFLENBQUM7b0JBQzFCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBMEIsQ0FBQyxHQUFHLFlBQVksS0FBSyxNQUFNLENBQUM7Z0JBQ3ZFLENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTLENBQUMsSUFBd0I7UUFDaEMsd0JBQXdCO1FBQ3hCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUN2QyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFFLENBQUM7UUFDL0IsQ0FBQztRQUVELDJDQUEyQztRQUMzQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTyxDQUFDLElBQXdCLEVBQUUsS0FBYztRQUM5QyxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssYUFBYSxFQUFFLENBQUM7WUFDdkMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsSUFBSSxlQUFlLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1lBQ3BGLE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7UUFFN0IsK0NBQStDO1FBQy9DLElBQUksT0FBTyxZQUFZLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDeEMsTUFBTSxVQUFVLEdBQUcsb0JBQW9CLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDO1lBQzVELFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixJQUFJLGNBQWMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjO1FBQ1osSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLGFBQWEsRUFBRSxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxJQUFJLENBQUMsNkNBQTZDLENBQUMsQ0FBQztZQUM1RCxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBRXBCLHdCQUF3QjtRQUN4QixJQUFJLE9BQU8sWUFBWSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDckMsTUFBTSxVQUFVLEdBQUcsb0JBQW9CLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDO2dCQUM1RCxZQUFZLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3RDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsd0RBQXdELENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjO1FBQ1osT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVc7UUFDVCxNQUFNLGFBQWEsR0FBaUIsRUFBa0IsQ0FBQztRQUV2RCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDckMsYUFBYSxDQUFDLElBQTBCLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQTBCLENBQUMsQ0FBQztRQUN6RixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxHQUFHLGFBQWE7WUFDaEIsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1NBQzlCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1gsT0FBTyxJQUFJLENBQUMsV0FBVyxLQUFLLGFBQWEsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTO1FBQ1AsT0FBTyxJQUFJLENBQUMsV0FBVyxLQUFLLFNBQVMsQ0FBQztJQUN4QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxZQUFZO1FBQ1YsT0FBTyxJQUFJLENBQUMsV0FBVyxLQUFLLFlBQVksQ0FBQztJQUMzQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQkFBZ0IsQ0FDZCxRQUtDO1FBRUQsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQy9ELE9BQU8sT0FBTyxFQUFFLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxRQUFRLENBQUMsT0FBZSxFQUFFLEdBQUcsSUFBVztRQUN0QyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsc0JBQXNCLENBQUMsRUFBRSxDQUFDO1lBQzNDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLE9BQU8sRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDekQsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILGdCQUFnQixDQUFJLElBQVksRUFBRSxTQUFrQjtRQUNsRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyw4QkFBOEIsQ0FBQyxFQUFFLENBQUM7WUFDcEQsT0FBTyxTQUFTLEVBQUUsQ0FBQztRQUNyQixDQUFDO1FBRUQsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLFNBQVMsRUFBRSxDQUFDO1FBQzNCLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFFM0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsSUFBSSxLQUFLLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXZFLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVcsQ0FBSSxJQUF3QixFQUFFLFNBQWtCO1FBQ3pELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUN4RCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxhQUFhLENBQUMsR0FBVyxFQUFFLFlBQXFCO1FBQ3RELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsSUFBSSxLQUFLLEtBQUssU0FBUztZQUFFLE9BQU8sWUFBWSxDQUFDO1FBQzdDLE9BQU8sS0FBSyxDQUFDLFdBQVcsRUFBRSxLQUFLLE1BQU0sQ0FBQztJQUN4QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCx3QkFBd0I7UUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFBRSxPQUFPO1FBRWpDLE1BQU0sV0FBVyxHQUFHO1lBQ2xCLGtCQUFrQjtZQUNsQixzQkFBc0I7U0FDdkIsQ0FBQztRQUVGLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUEwQixDQUFDLENBQzNDLENBQUM7UUFFRixJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDMUIsTUFBTSxJQUFJLEtBQUssQ0FDYix1REFBdUQsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUMvRSxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7Q0FDRjtBQUVELGtCQUFlLGtCQUFrQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9tX29saS9Qcm9qZXRzL1NZTUJJT05UL3NyYy9jb3JlL3NlcnZpY2VzL0ZlYXR1cmVGbGFnU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEZlYXR1cmVGbGFnU2VydmljZSAtIEdlc3Rpb24gY2VudHJhbGlzw6llIGRlcyBmZWF0dXJlIGZsYWdzXG4gKiBTw6lwYXJlIHByb3ByZW1lbnQgbGUgY29tcG9ydGVtZW50IGRldi9zdGFnaW5nL3Byb2R1Y3Rpb25cbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIEZlYXR1cmVGbGFncyB7XG4gIFVTRV9SRUFMX01FVFJJQ1M6IGJvb2xlYW47XG4gIFVTRV9SRUFMX0ROQTogYm9vbGVhbjtcbiAgVVNFX1JFQUxfQkVIQVZJT1I6IGJvb2xlYW47XG4gIFVTRV9CQUNLRU5EX0FQSTogYm9vbGVhbjtcbiAgRU5BQkxFX0RFQlVHX0xPR0dJTkc6IGJvb2xlYW47XG4gIEVOQUJMRV9QRVJGT1JNQU5DRV9QUk9GSUxJTkc6IGJvb2xlYW47XG4gIEVOQUJMRV9NT0NLX0RBVEE6IGJvb2xlYW47XG4gIEVOQUJMRV9TRUNVUklUWV9BVURJVDogYm9vbGVhbjtcbiAgRU5BQkxFX0FEVkFOQ0VEX0FOQUxZVElDUzogYm9vbGVhbjtcbiAgRU5BQkxFX0FfQl9URVNUSU5HOiBib29sZWFuO1xufVxuXG5leHBvcnQgdHlwZSBFbnZpcm9ubWVudCA9ICdkZXZlbG9wbWVudCcgfCAnc3RhZ2luZycgfCAncHJvZHVjdGlvbic7XG5cbmNsYXNzIEZlYXR1cmVGbGFnU2VydmljZSB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBGZWF0dXJlRmxhZ1NlcnZpY2U7XG4gIHByaXZhdGUgZW52aXJvbm1lbnQ6IEVudmlyb25tZW50O1xuICBwcml2YXRlIGZsYWdzOiBGZWF0dXJlRmxhZ3M7XG4gIHByaXZhdGUgb3ZlcnJpZGVzOiBQYXJ0aWFsPEZlYXR1cmVGbGFncz4gPSB7fTtcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuZW52aXJvbm1lbnQgPSB0aGlzLmRldGVjdEVudmlyb25tZW50KCk7XG4gICAgdGhpcy5mbGFncyA9IHRoaXMuaW5pdGlhbGl6ZUZsYWdzKCk7XG4gICAgdGhpcy5sb2FkT3ZlcnJpZGVzKCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogRmVhdHVyZUZsYWdTZXJ2aWNlIHtcbiAgICBpZiAoIUZlYXR1cmVGbGFnU2VydmljZS5pbnN0YW5jZSkge1xuICAgICAgRmVhdHVyZUZsYWdTZXJ2aWNlLmluc3RhbmNlID0gbmV3IEZlYXR1cmVGbGFnU2VydmljZSgpO1xuICAgIH1cbiAgICByZXR1cm4gRmVhdHVyZUZsYWdTZXJ2aWNlLmluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIETDqXRlY3RlIGwnZW52aXJvbm5lbWVudCBhY3R1ZWxcbiAgICovXG4gIHByaXZhdGUgZGV0ZWN0RW52aXJvbm1lbnQoKTogRW52aXJvbm1lbnQge1xuICAgIC8vIDEuIFZhcmlhYmxlIGQnZW52aXJvbm5lbWVudCBleHBsaWNpdGVcbiAgICBjb25zdCBub2RlRW52ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlY7XG4gICAgaWYgKG5vZGVFbnYgPT09ICdwcm9kdWN0aW9uJykgcmV0dXJuICdwcm9kdWN0aW9uJztcbiAgICBpZiAobm9kZUVudiA9PT0gJ3N0YWdpbmcnKSByZXR1cm4gJ3N0YWdpbmcnO1xuICAgIGlmIChub2RlRW52ID09PSAnZGV2ZWxvcG1lbnQnKSByZXR1cm4gJ2RldmVsb3BtZW50JztcblxuICAgIC8vIDIuIETDqXRlY3Rpb24gcGFyIFVSTCAocG91ciBleHRlbnNpb25zKVxuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgY29uc3QgdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7XG4gICAgICBpZiAodXJsLmluY2x1ZGVzKCdzdGFnaW5nJykpIHJldHVybiAnc3RhZ2luZyc7XG4gICAgICBpZiAodXJsLmluY2x1ZGVzKCdsb2NhbGhvc3QnKSB8fCB1cmwuaW5jbHVkZXMoJzEyNy4wLjAuMScpKSByZXR1cm4gJ2RldmVsb3BtZW50JztcbiAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgnY2hyb21lLWV4dGVuc2lvbjovLycpKSB7XG4gICAgICAgIC8vIEV4dGVuc2lvbiBlbiBwcm9kIHNpIHBhcyBkZSBtYXJxdWV1ciBkZXZcbiAgICAgICAgcmV0dXJuIHVybC5pbmNsdWRlcygnZGV2JykgPyAnZGV2ZWxvcG1lbnQnIDogJ3Byb2R1Y3Rpb24nO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIDMuIEZhbGxiYWNrIGTDqXZlbG9wcGVtZW50XG4gICAgcmV0dXJuICdkZXZlbG9wbWVudCc7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGlzZSBsZXMgZmxhZ3Mgc2Vsb24gbCdlbnZpcm9ubmVtZW50XG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVGbGFncygpOiBGZWF0dXJlRmxhZ3Mge1xuICAgIGNvbnN0IGJhc2VGbGFnczogRmVhdHVyZUZsYWdzID0ge1xuICAgICAgVVNFX1JFQUxfTUVUUklDUzogZmFsc2UsXG4gICAgICBVU0VfUkVBTF9ETkE6IGZhbHNlLFxuICAgICAgVVNFX1JFQUxfQkVIQVZJT1I6IGZhbHNlLFxuICAgICAgVVNFX0JBQ0tFTkRfQVBJOiBmYWxzZSxcbiAgICAgIEVOQUJMRV9ERUJVR19MT0dHSU5HOiBmYWxzZSxcbiAgICAgIEVOQUJMRV9QRVJGT1JNQU5DRV9QUk9GSUxJTkc6IGZhbHNlLFxuICAgICAgRU5BQkxFX01PQ0tfREFUQTogdHJ1ZSxcbiAgICAgIEVOQUJMRV9TRUNVUklUWV9BVURJVDogZmFsc2UsXG4gICAgICBFTkFCTEVfQURWQU5DRURfQU5BTFlUSUNTOiBmYWxzZSxcbiAgICAgIEVOQUJMRV9BX0JfVEVTVElORzogZmFsc2VcbiAgICB9O1xuXG4gICAgc3dpdGNoICh0aGlzLmVudmlyb25tZW50KSB7XG4gICAgICBjYXNlICdkZXZlbG9wbWVudCc6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4uYmFzZUZsYWdzLFxuICAgICAgICAgIEVOQUJMRV9ERUJVR19MT0dHSU5HOiB0cnVlLFxuICAgICAgICAgIEVOQUJMRV9QRVJGT1JNQU5DRV9QUk9GSUxJTkc6IHRydWUsXG4gICAgICAgICAgRU5BQkxFX01PQ0tfREFUQTogdHJ1ZSxcbiAgICAgICAgICBFTkFCTEVfU0VDVVJJVFlfQVVESVQ6IHRydWUsXG4gICAgICAgICAgLy8gUG9zc2liaWxpdMOpIGQnYWN0aXZlciB2cmFpZXMgZG9ubsOpZXMgZW4gZGV2IHBvdXIgdGVzdHNcbiAgICAgICAgICBVU0VfUkVBTF9NRVRSSUNTOiB0aGlzLmdldEVudkJvb2xlYW4oJ1VTRV9SRUFMX01FVFJJQ1MnLCBmYWxzZSksXG4gICAgICAgICAgVVNFX1JFQUxfRE5BOiB0aGlzLmdldEVudkJvb2xlYW4oJ1VTRV9SRUFMX0ROQScsIGZhbHNlKSxcbiAgICAgICAgICBVU0VfUkVBTF9CRUhBVklPUjogdGhpcy5nZXRFbnZCb29sZWFuKCdVU0VfUkVBTF9CRUhBVklPUicsIGZhbHNlKSxcbiAgICAgICAgICBVU0VfQkFDS0VORF9BUEk6IHRoaXMuZ2V0RW52Qm9vbGVhbignVVNFX0JBQ0tFTkRfQVBJJywgZmFsc2UpXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgJ3N0YWdpbmcnOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLmJhc2VGbGFncyxcbiAgICAgICAgICBVU0VfUkVBTF9NRVRSSUNTOiB0cnVlLFxuICAgICAgICAgIFVTRV9SRUFMX0ROQTogdHJ1ZSxcbiAgICAgICAgICBVU0VfUkVBTF9CRUhBVklPUjogdHJ1ZSxcbiAgICAgICAgICBVU0VfQkFDS0VORF9BUEk6IHRydWUsXG4gICAgICAgICAgRU5BQkxFX0RFQlVHX0xPR0dJTkc6IGZhbHNlLFxuICAgICAgICAgIEVOQUJMRV9QRVJGT1JNQU5DRV9QUk9GSUxJTkc6IHRydWUsXG4gICAgICAgICAgRU5BQkxFX01PQ0tfREFUQTogZmFsc2UsXG4gICAgICAgICAgRU5BQkxFX1NFQ1VSSVRZX0FVRElUOiB0cnVlLFxuICAgICAgICAgIEVOQUJMRV9BRFZBTkNFRF9BTkFMWVRJQ1M6IHRydWUsXG4gICAgICAgICAgRU5BQkxFX0FfQl9URVNUSU5HOiB0cnVlXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgJ3Byb2R1Y3Rpb24nOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLmJhc2VGbGFncyxcbiAgICAgICAgICBVU0VfUkVBTF9NRVRSSUNTOiB0cnVlLFxuICAgICAgICAgIFVTRV9SRUFMX0ROQTogdHJ1ZSxcbiAgICAgICAgICBVU0VfUkVBTF9CRUhBVklPUjogdHJ1ZSxcbiAgICAgICAgICBVU0VfQkFDS0VORF9BUEk6IHRydWUsXG4gICAgICAgICAgRU5BQkxFX0RFQlVHX0xPR0dJTkc6IGZhbHNlLFxuICAgICAgICAgIEVOQUJMRV9QRVJGT1JNQU5DRV9QUk9GSUxJTkc6IGZhbHNlLFxuICAgICAgICAgIEVOQUJMRV9NT0NLX0RBVEE6IGZhbHNlLFxuICAgICAgICAgIEVOQUJMRV9TRUNVUklUWV9BVURJVDogZmFsc2UsXG4gICAgICAgICAgRU5BQkxFX0FEVkFOQ0VEX0FOQUxZVElDUzogdHJ1ZSxcbiAgICAgICAgICBFTkFCTEVfQV9CX1RFU1RJTkc6IGZhbHNlIC8vIETDqXNhY3RpdsOpIHBhciBkw6lmYXV0IGVuIHByb2RcbiAgICAgICAgfTtcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGJhc2VGbGFncztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hhcmdlIGxlcyBvdmVycmlkZXMgZGVwdWlzIGxvY2FsU3RvcmFnZSBldCB2YXJpYWJsZXMgZCdlbnZcbiAgICovXG4gIHByaXZhdGUgbG9hZE92ZXJyaWRlcygpOiB2b2lkIHtcbiAgICAvLyAxLiBWYXJpYWJsZXMgZCdlbnZpcm9ubmVtZW50XG4gICAgT2JqZWN0LmtleXModGhpcy5mbGFncykuZm9yRWFjaChmbGFnID0+IHtcbiAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYFNZTUJJT05UXyR7ZmxhZ31gXTtcbiAgICAgIGlmIChlbnZWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMub3ZlcnJpZGVzW2ZsYWcgYXMga2V5b2YgRmVhdHVyZUZsYWdzXSA9IGVudlZhbHVlID09PSAndHJ1ZSc7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyAyLiBsb2NhbFN0b3JhZ2UgKHBvdXIgdGVzdHMgbWFudWVscyBlbiBkZXYpXG4gICAgaWYgKHRoaXMuZW52aXJvbm1lbnQgPT09ICdkZXZlbG9wbWVudCcgJiYgdHlwZW9mIGxvY2FsU3RvcmFnZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMuZmxhZ3MpLmZvckVhY2goZmxhZyA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JhZ2VLZXkgPSBgc3ltYmlvbnRfZmVhdHVyZV8ke2ZsYWcudG9Mb3dlckNhc2UoKX1gO1xuICAgICAgICBjb25zdCBzdG9yYWdlVmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShzdG9yYWdlS2V5KTtcbiAgICAgICAgaWYgKHN0b3JhZ2VWYWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgIHRoaXMub3ZlcnJpZGVzW2ZsYWcgYXMga2V5b2YgRmVhdHVyZUZsYWdzXSA9IHN0b3JhZ2VWYWx1ZSA9PT0gJ3RydWUnO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogT2J0aWVudCBsYSB2YWxldXIgZCd1biBmZWF0dXJlIGZsYWdcbiAgICovXG4gIGlzRW5hYmxlZChmbGFnOiBrZXlvZiBGZWF0dXJlRmxhZ3MpOiBib29sZWFuIHtcbiAgICAvLyAxLiBPdmVycmlkZSBleHBsaWNpdGVcbiAgICBpZiAodGhpcy5vdmVycmlkZXNbZmxhZ10gIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHRoaXMub3ZlcnJpZGVzW2ZsYWddITtcbiAgICB9XG5cbiAgICAvLyAyLiBWYWxldXIgcGFyIGTDqWZhdXQgc2Vsb24gZW52aXJvbm5lbWVudFxuICAgIHJldHVybiB0aGlzLmZsYWdzW2ZsYWddO1xuICB9XG5cbiAgLyoqXG4gICAqIE92ZXJyaWRlIHRlbXBvcmFpcmUgZCd1biBmbGFnIChkZXYgdW5pcXVlbWVudClcbiAgICovXG4gIHNldEZsYWcoZmxhZzoga2V5b2YgRmVhdHVyZUZsYWdzLCB2YWx1ZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICh0aGlzLmVudmlyb25tZW50ICE9PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyBPdmVycmlkZSBkZSBmZWF0dXJlIGZsYWcgJyR7ZmxhZ30nIGlnbm9yw6kgZW4gJHt0aGlzLmVudmlyb25tZW50fWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMub3ZlcnJpZGVzW2ZsYWddID0gdmFsdWU7XG4gICAgXG4gICAgLy8gU2F1dmVnYXJkZXIgZW4gbG9jYWxTdG9yYWdlIHBvdXIgcGVyc2lzdGVuY2VcbiAgICBpZiAodHlwZW9mIGxvY2FsU3RvcmFnZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGNvbnN0IHN0b3JhZ2VLZXkgPSBgc3ltYmlvbnRfZmVhdHVyZV8ke2ZsYWcudG9Mb3dlckNhc2UoKX1gO1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oc3RvcmFnZUtleSwgdmFsdWUudG9TdHJpbmcoKSk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coYPCflKcgRmVhdHVyZSBmbGFnICcke2ZsYWd9JyBkw6lmaW5pIMOgICR7dmFsdWV9YCk7XG4gIH1cblxuICAvKipcbiAgICogUmVtZXQgw6AgesOpcm8gdG91cyBsZXMgb3ZlcnJpZGVzXG4gICAqL1xuICByZXNldE92ZXJyaWRlcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5lbnZpcm9ubWVudCAhPT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgY29uc29sZS53YXJuKCfimqDvuI8gUmVzZXQgZGVzIG92ZXJyaWRlcyBpZ25vcsOpIGVuIHByb2R1Y3Rpb24nKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm92ZXJyaWRlcyA9IHt9O1xuICAgIFxuICAgIC8vIE5ldHRveWVyIGxvY2FsU3RvcmFnZVxuICAgIGlmICh0eXBlb2YgbG9jYWxTdG9yYWdlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgT2JqZWN0LmtleXModGhpcy5mbGFncykuZm9yRWFjaChmbGFnID0+IHtcbiAgICAgICAgY29uc3Qgc3RvcmFnZUtleSA9IGBzeW1iaW9udF9mZWF0dXJlXyR7ZmxhZy50b0xvd2VyQ2FzZSgpfWA7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKHN0b3JhZ2VLZXkpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coJ/CflIQgVG91cyBsZXMgZmVhdHVyZSBmbGFncyByZW1pcyBhdXggdmFsZXVycyBwYXIgZMOpZmF1dCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIE9idGllbnQgbCdlbnZpcm9ubmVtZW50IGFjdHVlbFxuICAgKi9cbiAgZ2V0RW52aXJvbm1lbnQoKTogRW52aXJvbm1lbnQge1xuICAgIHJldHVybiB0aGlzLmVudmlyb25tZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIE9idGllbnQgdG91cyBsZXMgZmxhZ3MgYWN0dWVscyAocG91ciBkZWJ1ZylcbiAgICovXG4gIGdldEFsbEZsYWdzKCk6IEZlYXR1cmVGbGFncyAmIHsgZW52aXJvbm1lbnQ6IEVudmlyb25tZW50IH0ge1xuICAgIGNvbnN0IHJlc29sdmVkRmxhZ3M6IEZlYXR1cmVGbGFncyA9IHt9IGFzIEZlYXR1cmVGbGFncztcbiAgICBcbiAgICBPYmplY3Qua2V5cyh0aGlzLmZsYWdzKS5mb3JFYWNoKGZsYWcgPT4ge1xuICAgICAgcmVzb2x2ZWRGbGFnc1tmbGFnIGFzIGtleW9mIEZlYXR1cmVGbGFnc10gPSB0aGlzLmlzRW5hYmxlZChmbGFnIGFzIGtleW9mIEZlYXR1cmVGbGFncyk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4ucmVzb2x2ZWRGbGFncyxcbiAgICAgIGVudmlyb25tZW50OiB0aGlzLmVudmlyb25tZW50XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWw6lyaWZpZSBzaSBvbiBlc3QgZW4gbW9kZSBkw6l2ZWxvcHBlbWVudFxuICAgKi9cbiAgaXNEZXZlbG9wbWVudCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5lbnZpcm9ubWVudCA9PT0gJ2RldmVsb3BtZW50JztcbiAgfVxuXG4gIC8qKlxuICAgKiBWw6lyaWZpZSBzaSBvbiBlc3QgZW4gbW9kZSBzdGFnaW5nXG4gICAqL1xuICBpc1N0YWdpbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZW52aXJvbm1lbnQgPT09ICdzdGFnaW5nJztcbiAgfVxuXG4gIC8qKlxuICAgKiBWw6lyaWZpZSBzaSBvbiBlc3QgZW4gbW9kZSBwcm9kdWN0aW9uXG4gICAqL1xuICBpc1Byb2R1Y3Rpb24oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZW52aXJvbm1lbnQgPT09ICdwcm9kdWN0aW9uJztcbiAgfVxuXG4gIC8qKlxuICAgKiBFeMOpY3V0ZSBkdSBjb2RlIGNvbmRpdGlvbm5lbCBzZWxvbiBsJ2Vudmlyb25uZW1lbnRcbiAgICovXG4gIHJ1bkluRW52aXJvbm1lbnQ8VD4oXG4gICAgaGFuZGxlcnM6IHtcbiAgICAgIGRldmVsb3BtZW50PzogKCkgPT4gVDtcbiAgICAgIHN0YWdpbmc/OiAoKSA9PiBUO1xuICAgICAgcHJvZHVjdGlvbj86ICgpID0+IFQ7XG4gICAgICBkZWZhdWx0PzogKCkgPT4gVDtcbiAgICB9XG4gICk6IFQgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGhhbmRsZXIgPSBoYW5kbGVyc1t0aGlzLmVudmlyb25tZW50XSB8fCBoYW5kbGVycy5kZWZhdWx0O1xuICAgIHJldHVybiBoYW5kbGVyPy4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb2cgY29uZGl0aW9ubmVsIHNlbG9uIGxlcyBmZWF0dXJlIGZsYWdzXG4gICAqL1xuICBkZWJ1Z0xvZyhtZXNzYWdlOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNFbmFibGVkKCdFTkFCTEVfREVCVUdfTE9HR0lORycpKSB7XG4gICAgICBjb25zb2xlLmxvZyhg8J+QmyBbU1lNQklPTlQgRGVidWddICR7bWVzc2FnZX1gLCAuLi5hcmdzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybWFuY2UgcHJvZmlsaW5nIGNvbmRpdGlvbm5lbFxuICAgKi9cbiAgcHJvZmlsZU9wZXJhdGlvbjxUPihuYW1lOiBzdHJpbmcsIG9wZXJhdGlvbjogKCkgPT4gVCk6IFQge1xuICAgIGlmICghdGhpcy5pc0VuYWJsZWQoJ0VOQUJMRV9QRVJGT1JNQU5DRV9QUk9GSUxJTkcnKSkge1xuICAgICAgcmV0dXJuIG9wZXJhdGlvbigpO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgY29uc3QgcmVzdWx0ID0gb3BlcmF0aW9uKCk7XG4gICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0O1xuICAgIFxuICAgIGNvbnNvbGUubG9nKGDij7HvuI8gW1NZTUJJT05UIFByb2ZpbGVdICR7bmFtZX06ICR7ZHVyYXRpb24udG9GaXhlZCgyKX1tc2ApO1xuICAgIFxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogRXjDqWN1dGlvbiBjb25kaXRpb25uZWxsZSBzZWxvbiBmZWF0dXJlIGZsYWdcbiAgICovXG4gIHdoZW5FbmFibGVkPFQ+KGZsYWc6IGtleW9mIEZlYXR1cmVGbGFncywgb3BlcmF0aW9uOiAoKSA9PiBUKTogVCB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuaXNFbmFibGVkKGZsYWcpID8gb3BlcmF0aW9uKCkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICAvKipcbiAgICogVXRpbGl0YWlyZSBwb3VyIGxpcmUgdmFyaWFibGVzIGQnZW52aXJvbm5lbWVudCBib29sZWFuXG4gICAqL1xuICBwcml2YXRlIGdldEVudkJvb2xlYW4oa2V5OiBzdHJpbmcsIGRlZmF1bHRWYWx1ZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHZhbHVlID0gcHJvY2Vzcy5lbnZba2V5XTtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICByZXR1cm4gdmFsdWUudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRpb24gZGUgc8OpY3VyaXTDqSAtIHbDqXJpZmllIHF1J29uIG4ndXRpbGlzZSBwYXMgZGUgZG9ubsOpZXMgbW9jayBlbiBwcm9kXG4gICAqL1xuICB2YWxpZGF0ZVByb2R1Y3Rpb25TYWZldHkoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmlzUHJvZHVjdGlvbigpKSByZXR1cm47XG5cbiAgICBjb25zdCB1bnNhZmVGbGFncyA9IFtcbiAgICAgICdFTkFCTEVfTU9DS19EQVRBJyxcbiAgICAgICdFTkFCTEVfREVCVUdfTE9HR0lORydcbiAgICBdO1xuXG4gICAgY29uc3QgdmlvbGF0aW9ucyA9IHVuc2FmZUZsYWdzLmZpbHRlcihmbGFnID0+IFxuICAgICAgdGhpcy5pc0VuYWJsZWQoZmxhZyBhcyBrZXlvZiBGZWF0dXJlRmxhZ3MpXG4gICAgKTtcblxuICAgIGlmICh2aW9sYXRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYPCfmqggU8OJQ1VSSVTDiTogRmxhZ3MgZGFuZ2VyZXV4IGFjdGl2w6lzIGVuIHByb2R1Y3Rpb246ICR7dmlvbGF0aW9ucy5qb2luKCcsICcpfWBcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEZlYXR1cmVGbGFnU2VydmljZTsiXSwidmVyc2lvbiI6M30=