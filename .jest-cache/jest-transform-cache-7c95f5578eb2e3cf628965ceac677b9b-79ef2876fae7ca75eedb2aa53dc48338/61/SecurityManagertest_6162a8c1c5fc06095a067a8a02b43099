c59dd46dc1a6b30d052490425889d947
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock service worker adapter
jest.mock('../src/background/service-worker-adapter', () => ({
    swCryptoAPI: {
        subtle: global.crypto.subtle,
        getRandomValues: global.crypto.getRandomValues
    }
}));
const SecurityManager_1 = require("../src/background/SecurityManager");
// Mocks WebCrypto complets pour les tests
const mockCryptoKey = {};
const mockEncryptedData = new ArrayBuffer(16);
const mockDecryptedData = new ArrayBuffer(8);
// Mock global crypto/WebCrypto
Object.defineProperty(global, 'crypto', {
    value: {
        subtle: {
            generateKey: jest.fn().mockResolvedValue(mockCryptoKey),
            importKey: jest.fn().mockResolvedValue(mockCryptoKey),
            exportKey: jest.fn().mockResolvedValue(mockDecryptedData),
            encrypt: jest.fn().mockResolvedValue(mockEncryptedData),
            decrypt: jest.fn().mockResolvedValue(mockDecryptedData),
            digest: jest.fn().mockResolvedValue(new ArrayBuffer(32))
        },
        getRandomValues: jest.fn().mockImplementation((arr) => {
            for (let i = 0; i < arr.length; i++) {
                arr[i] = Math.floor(Math.random() * 256);
            }
            return arr;
        })
    }
});
// Mock Chrome storage API
const mockStorage = {
    get: jest.fn().mockImplementation((keys, callback) => {
        callback({});
    }),
    set: jest.fn().mockImplementation((items, callback) => {
        if (callback)
            callback();
    })
};
Object.defineProperty(global, 'chrome', {
    value: {
        storage: {
            local: mockStorage
        }
    }
});
// Mock btoa/atob pour Node.js
Object.defineProperty(global, 'btoa', {
    value: (str) => Buffer.from(str, 'binary').toString('base64')
});
Object.defineProperty(global, 'atob', {
    value: (str) => Buffer.from(str, 'base64').toString('binary')
});
describe('SecurityManager', () => {
    let security;
    beforeEach(() => {
        jest.clearAllMocks();
        security = new SecurityManager_1.SecurityManager();
    });
    describe('Chiffrement/Déchiffrement', () => {
        it('chiffre et déchiffre correctement les données', async () => {
            const testData = { foo: 'bar', n: 42 };
            // Mock encrypt pour retourner données encodées
            const mockResult = JSON.stringify(testData);
            global.crypto.subtle.decrypt.mockResolvedValue(new TextEncoder().encode(mockResult));
            const encrypted = await security.encryptSensitiveData(testData);
            expect(typeof encrypted).toBe('string');
            expect(global.crypto.subtle.encrypt).toHaveBeenCalled();
            const decrypted = await security.decryptSensitiveData(encrypted);
            expect(decrypted).toEqual(testData);
            expect(global.crypto.subtle.decrypt).toHaveBeenCalled();
        });
        it('gère les erreurs de chiffrement gracieusement', async () => {
            global.crypto.subtle.encrypt.mockRejectedValue(new Error('Crypto failure'));
            await expect(security.encryptSensitiveData({})).rejects.toThrow('Échec du chiffrement des données sensibles');
        });
        it('gère les erreurs de déchiffrement gracieusement', async () => {
            global.crypto.subtle.decrypt.mockRejectedValue(new Error('Decrypt failure'));
            await expect(security.decryptSensitiveData('invalid')).rejects.toThrow('Échec du déchiffrement des données');
        });
    });
    describe('Anonymisation', () => {
        it('anonymise les données comportementales (async)', async () => {
            const pattern = {
                url: 'https://secret.com',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.interactions).toBe(pattern.interactions);
            expect(anonymized.timeSpent).toBe(pattern.timeSpent);
            expect(anonymized.scrollDepth).toBe(pattern.scrollDepth);
        });
        it('anonymise les données comportementales (sync)', () => {
            const pattern = {
                url: 'https://secret.com',
                userId: 'user123',
                interactions: 5,
                timeSpent: 10,
                scrollDepth: 0.8,
                timestamp: Date.now()
            };
            const anonymized = security.anonymizeForSharingSync(pattern);
            expect(anonymized.url).toBe('anonymized');
            expect(anonymized.userId).not.toBe('user123'); // Hashé
            expect(typeof anonymized.userId).toBe('string');
        });
        it('supprime les champs sensibles', async () => {
            const pattern = {
                url: 'https://secret.com',
                email: 'test@example.com',
                name: 'John Doe',
                phone: '123456789',
                interactions: 5
            };
            const anonymized = await security.anonymizeForSharing(pattern);
            expect(anonymized.email).toBeUndefined();
            expect(anonymized.name).toBeUndefined();
            expect(anonymized.phone).toBeUndefined();
            expect(anonymized.interactions).toBe(5);
        });
    });
    describe('Contrôle d\'accès', () => {
        it('valide l\'accès utilisateur basique', () => {
            const request = { userId: 'user123', resource: 'organisms' };
            expect(security.validateDataAccess(request)).toBe(true);
        });
        it('rejette l\'accès admin sans rôle admin', () => {
            const request = { userId: 'user123', resource: 'admin', role: 'user' };
            expect(security.validateDataAccess(request, 'admin')).toBe(false);
        });
        it('accepte l\'accès admin avec rôle admin', () => {
            const request = { userId: 'admin123', resource: 'admin', role: 'admin' };
            expect(security.validateDataAccess(request, 'admin')).toBe(true);
        });
        it('rejette les requêtes invalides', () => {
            expect(security.validateDataAccess({ userId: '', resource: 'test' })).toBe(false);
            expect(security.validateDataAccess({ userId: 'user', resource: '' })).toBe(false);
        });
    });
    describe('Hashage', () => {
        it('hash des chaînes avec SHA-256', async () => {
            const testString = 'test-string';
            const hash = await security.hash(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
            expect(global.crypto.subtle.digest).toHaveBeenCalledWith('SHA-256', expect.any(Uint8Array));
        });
        it('produit des hashs cohérents', async () => {
            const testString = 'consistent-test';
            const hash1 = await security.hash(testString);
            const hash2 = await security.hash(testString);
            expect(hash1).toBe(hash2);
        });
        it('hash sync fonctionne comme fallback', () => {
            const testString = 'sync-test';
            const hash = security.hashSync(testString);
            expect(typeof hash).toBe('string');
            expect(hash.length).toBeGreaterThan(0);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvX190ZXN0c19fL1NlY3VyaXR5TWFuYWdlci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBNkNBLDhCQUE4QjtBQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLDBDQUEwQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDM0QsV0FBVyxFQUFFO1FBQ1gsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTTtRQUM1QixlQUFlLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlO0tBQy9DO0NBQ0YsQ0FBQyxDQUFDLENBQUM7QUFuREosdUVBQW1FO0FBRW5FLDBDQUEwQztBQUMxQyxNQUFNLGFBQWEsR0FBRyxFQUFlLENBQUM7QUFDdEMsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM5QyxNQUFNLGlCQUFpQixHQUFHLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRTdDLCtCQUErQjtBQUMvQixNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUU7SUFDdEMsS0FBSyxFQUFFO1FBQ0wsTUFBTSxFQUFFO1lBQ04sV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUM7WUFDdkQsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUM7WUFDckQsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQztZQUN6RCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDO1lBQ3ZELE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUM7WUFDdkQsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FB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QUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvX190ZXN0c19fL1NlY3VyaXR5TWFuYWdlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlY3VyaXR5TWFuYWdlciB9IGZyb20gJy4uL3NyYy9iYWNrZ3JvdW5kL1NlY3VyaXR5TWFuYWdlcidcclxuXHJcbi8vIE1vY2tzIFdlYkNyeXB0byBjb21wbGV0cyBwb3VyIGxlcyB0ZXN0c1xyXG5jb25zdCBtb2NrQ3J5cHRvS2V5ID0ge30gYXMgQ3J5cHRvS2V5O1xyXG5jb25zdCBtb2NrRW5jcnlwdGVkRGF0YSA9IG5ldyBBcnJheUJ1ZmZlcigxNik7XHJcbmNvbnN0IG1vY2tEZWNyeXB0ZWREYXRhID0gbmV3IEFycmF5QnVmZmVyKDgpO1xyXG5cclxuLy8gTW9jayBnbG9iYWwgY3J5cHRvL1dlYkNyeXB0b1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZ2xvYmFsLCAnY3J5cHRvJywge1xyXG4gIHZhbHVlOiB7XHJcbiAgICBzdWJ0bGU6IHtcclxuICAgICAgZ2VuZXJhdGVLZXk6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ3J5cHRvS2V5KSxcclxuICAgICAgaW1wb3J0S2V5OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobW9ja0NyeXB0b0tleSksXHJcbiAgICAgIGV4cG9ydEtleTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tEZWNyeXB0ZWREYXRhKSxcclxuICAgICAgZW5jcnlwdDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tFbmNyeXB0ZWREYXRhKSxcclxuICAgICAgZGVjcnlwdDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tEZWNyeXB0ZWREYXRhKSxcclxuICAgICAgZGlnZXN0OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobmV3IEFycmF5QnVmZmVyKDMyKSlcclxuICAgIH0sXHJcbiAgICBnZXRSYW5kb21WYWx1ZXM6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGFycjogVWludDhBcnJheSkgPT4ge1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGFycltpXSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDI1Nik7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGFycjtcclxuICAgIH0pXHJcbiAgfVxyXG59KTtcclxuXHJcbi8vIE1vY2sgQ2hyb21lIHN0b3JhZ2UgQVBJXHJcbmNvbnN0IG1vY2tTdG9yYWdlID0ge1xyXG4gIGdldDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoa2V5cywgY2FsbGJhY2spID0+IHtcclxuICAgIGNhbGxiYWNrKHt9KTtcclxuICB9KSxcclxuICBzZXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGl0ZW1zLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xyXG4gIH0pXHJcbn07XHJcblxyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZ2xvYmFsLCAnY2hyb21lJywge1xyXG4gIHZhbHVlOiB7XHJcbiAgICBzdG9yYWdlOiB7XHJcbiAgICAgIGxvY2FsOiBtb2NrU3RvcmFnZVxyXG4gICAgfVxyXG4gIH1cclxufSk7XHJcblxyXG4vLyBNb2NrIHNlcnZpY2Ugd29ya2VyIGFkYXB0ZXJcclxuamVzdC5tb2NrKCcuLi9zcmMvYmFja2dyb3VuZC9zZXJ2aWNlLXdvcmtlci1hZGFwdGVyJywgKCkgPT4gKHtcclxuICBzd0NyeXB0b0FQSToge1xyXG4gICAgc3VidGxlOiBnbG9iYWwuY3J5cHRvLnN1YnRsZSxcclxuICAgIGdldFJhbmRvbVZhbHVlczogZ2xvYmFsLmNyeXB0by5nZXRSYW5kb21WYWx1ZXNcclxuICB9XHJcbn0pKTtcclxuXHJcbi8vIE1vY2sgYnRvYS9hdG9iIHBvdXIgTm9kZS5qc1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZ2xvYmFsLCAnYnRvYScsIHtcclxuICB2YWx1ZTogKHN0cjogc3RyaW5nKSA9PiBCdWZmZXIuZnJvbShzdHIsICdiaW5hcnknKS50b1N0cmluZygnYmFzZTY0JylcclxufSk7XHJcblxyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZ2xvYmFsLCAnYXRvYicsIHtcclxuICB2YWx1ZTogKHN0cjogc3RyaW5nKSA9PiBCdWZmZXIuZnJvbShzdHIsICdiYXNlNjQnKS50b1N0cmluZygnYmluYXJ5JylcclxufSk7XHJcblxyXG5kZXNjcmliZSgnU2VjdXJpdHlNYW5hZ2VyJywgKCkgPT4ge1xyXG4gIGxldCBzZWN1cml0eTogU2VjdXJpdHlNYW5hZ2VyO1xyXG4gIFxyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcbiAgICBzZWN1cml0eSA9IG5ldyBTZWN1cml0eU1hbmFnZXIoKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0NoaWZmcmVtZW50L0TDqWNoaWZmcmVtZW50JywgKCkgPT4ge1xyXG4gICAgaXQoJ2NoaWZmcmUgZXQgZMOpY2hpZmZyZSBjb3JyZWN0ZW1lbnQgbGVzIGRvbm7DqWVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0RGF0YSA9IHsgZm9vOiAnYmFyJywgbjogNDIgfTtcclxuICAgICAgXHJcbiAgICAgIC8vIE1vY2sgZW5jcnlwdCBwb3VyIHJldG91cm5lciBkb25uw6llcyBlbmNvZMOpZXNcclxuICAgICAgY29uc3QgbW9ja1Jlc3VsdCA9IEpTT04uc3RyaW5naWZ5KHRlc3REYXRhKTtcclxuICAgICAgKGdsb2JhbC5jcnlwdG8uc3VidGxlLmRlY3J5cHQgYXMgamVzdC5Nb2NrKS5tb2NrUmVzb2x2ZWRWYWx1ZShcclxuICAgICAgICBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUobW9ja1Jlc3VsdClcclxuICAgICAgKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IGF3YWl0IHNlY3VyaXR5LmVuY3J5cHRTZW5zaXRpdmVEYXRhKHRlc3REYXRhKTtcclxuICAgICAgZXhwZWN0KHR5cGVvZiBlbmNyeXB0ZWQpLnRvQmUoJ3N0cmluZycpO1xyXG4gICAgICBleHBlY3QoZ2xvYmFsLmNyeXB0by5zdWJ0bGUuZW5jcnlwdCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgZGVjcnlwdGVkID0gYXdhaXQgc2VjdXJpdHkuZGVjcnlwdFNlbnNpdGl2ZURhdGEoZW5jcnlwdGVkKTtcclxuICAgICAgZXhwZWN0KGRlY3J5cHRlZCkudG9FcXVhbCh0ZXN0RGF0YSk7XHJcbiAgICAgIGV4cGVjdChnbG9iYWwuY3J5cHRvLnN1YnRsZS5kZWNyeXB0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnZ8OocmUgbGVzIGVycmV1cnMgZGUgY2hpZmZyZW1lbnQgZ3JhY2lldXNlbWVudCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgKGdsb2JhbC5jcnlwdG8uc3VidGxlLmVuY3J5cHQgYXMgamVzdC5Nb2NrKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0NyeXB0byBmYWlsdXJlJykpO1xyXG4gICAgICBcclxuICAgICAgYXdhaXQgZXhwZWN0KHNlY3VyaXR5LmVuY3J5cHRTZW5zaXRpdmVEYXRhKHt9KSkucmVqZWN0cy50b1Rocm93KCfDiWNoZWMgZHUgY2hpZmZyZW1lbnQgZGVzIGRvbm7DqWVzIHNlbnNpYmxlcycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2fDqHJlIGxlcyBlcnJldXJzIGRlIGTDqWNoaWZmcmVtZW50IGdyYWNpZXVzZW1lbnQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChnbG9iYWwuY3J5cHRvLnN1YnRsZS5kZWNyeXB0IGFzIGplc3QuTW9jaykubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdEZWNyeXB0IGZhaWx1cmUnKSk7XHJcbiAgICAgIFxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VjdXJpdHkuZGVjcnlwdFNlbnNpdGl2ZURhdGEoJ2ludmFsaWQnKSkucmVqZWN0cy50b1Rocm93KCfDiWNoZWMgZHUgZMOpY2hpZmZyZW1lbnQgZGVzIGRvbm7DqWVzJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0Fub255bWlzYXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnYW5vbnltaXNlIGxlcyBkb25uw6llcyBjb21wb3J0ZW1lbnRhbGVzIChhc3luYyknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhdHRlcm4gPSB7IFxyXG4gICAgICAgIHVybDogJ2h0dHBzOi8vc2VjcmV0LmNvbScsIFxyXG4gICAgICAgIGludGVyYWN0aW9uczogNSwgXHJcbiAgICAgICAgdGltZVNwZW50OiAxMCwgXHJcbiAgICAgICAgc2Nyb2xsRGVwdGg6IDAuOCwgXHJcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpIFxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgY29uc3QgYW5vbnltaXplZCA9IGF3YWl0IHNlY3VyaXR5LmFub255bWl6ZUZvclNoYXJpbmcocGF0dGVybik7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnVybCkudG9CZSgnYW5vbnltaXplZCcpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5pbnRlcmFjdGlvbnMpLnRvQmUocGF0dGVybi5pbnRlcmFjdGlvbnMpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC50aW1lU3BlbnQpLnRvQmUocGF0dGVybi50aW1lU3BlbnQpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5zY3JvbGxEZXB0aCkudG9CZShwYXR0ZXJuLnNjcm9sbERlcHRoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdhbm9ueW1pc2UgbGVzIGRvbm7DqWVzIGNvbXBvcnRlbWVudGFsZXMgKHN5bmMpJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXR0ZXJuID0geyBcclxuICAgICAgICB1cmw6ICdodHRwczovL3NlY3JldC5jb20nLCBcclxuICAgICAgICB1c2VySWQ6ICd1c2VyMTIzJyxcclxuICAgICAgICBpbnRlcmFjdGlvbnM6IDUsIFxyXG4gICAgICAgIHRpbWVTcGVudDogMTAsIFxyXG4gICAgICAgIHNjcm9sbERlcHRoOiAwLjgsIFxyXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSBcclxuICAgICAgfTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGFub255bWl6ZWQgPSBzZWN1cml0eS5hbm9ueW1pemVGb3JTaGFyaW5nU3luYyhwYXR0ZXJuKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQudXJsKS50b0JlKCdhbm9ueW1pemVkJyk7XHJcbiAgICAgIGV4cGVjdChhbm9ueW1pemVkLnVzZXJJZCkubm90LnRvQmUoJ3VzZXIxMjMnKTsgLy8gSGFzaMOpXHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgYW5vbnltaXplZC51c2VySWQpLnRvQmUoJ3N0cmluZycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3N1cHByaW1lIGxlcyBjaGFtcHMgc2Vuc2libGVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBwYXR0ZXJuID0geyBcclxuICAgICAgICB1cmw6ICdodHRwczovL3NlY3JldC5jb20nLFxyXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgbmFtZTogJ0pvaG4gRG9lJyxcclxuICAgICAgICBwaG9uZTogJzEyMzQ1Njc4OScsXHJcbiAgICAgICAgaW50ZXJhY3Rpb25zOiA1XHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBhbm9ueW1pemVkID0gYXdhaXQgc2VjdXJpdHkuYW5vbnltaXplRm9yU2hhcmluZyhwYXR0ZXJuKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQuZW1haWwpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KGFub255bWl6ZWQubmFtZSkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5waG9uZSkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QoYW5vbnltaXplZC5pbnRlcmFjdGlvbnMpLnRvQmUoNSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0NvbnRyw7RsZSBkXFwnYWNjw6hzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3ZhbGlkZSBsXFwnYWNjw6hzIHV0aWxpc2F0ZXVyIGJhc2lxdWUnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7IHVzZXJJZDogJ3VzZXIxMjMnLCByZXNvdXJjZTogJ29yZ2FuaXNtcycgfTtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2VzcyhyZXF1ZXN0KSkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdyZWpldHRlIGxcXCdhY2PDqHMgYWRtaW4gc2FucyByw7RsZSBhZG1pbicsICgpID0+IHtcclxuICAgICAgY29uc3QgcmVxdWVzdCA9IHsgdXNlcklkOiAndXNlcjEyMycsIHJlc291cmNlOiAnYWRtaW4nLCByb2xlOiAndXNlcicgYXMgY29uc3QgfTtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2VzcyhyZXF1ZXN0LCAnYWRtaW4nKSkudG9CZShmYWxzZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnYWNjZXB0ZSBsXFwnYWNjw6hzIGFkbWluIGF2ZWMgcsO0bGUgYWRtaW4nLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7IHVzZXJJZDogJ2FkbWluMTIzJywgcmVzb3VyY2U6ICdhZG1pbicsIHJvbGU6ICdhZG1pbicgYXMgY29uc3QgfTtcclxuICAgICAgZXhwZWN0KHNlY3VyaXR5LnZhbGlkYXRlRGF0YUFjY2VzcyhyZXF1ZXN0LCAnYWRtaW4nKSkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdyZWpldHRlIGxlcyByZXF1w6p0ZXMgaW52YWxpZGVzJywgKCkgPT4ge1xyXG4gICAgICBleHBlY3Qoc2VjdXJpdHkudmFsaWRhdGVEYXRhQWNjZXNzKHsgdXNlcklkOiAnJywgcmVzb3VyY2U6ICd0ZXN0JyB9KSkudG9CZShmYWxzZSk7XHJcbiAgICAgIGV4cGVjdChzZWN1cml0eS52YWxpZGF0ZURhdGFBY2Nlc3MoeyB1c2VySWQ6ICd1c2VyJywgcmVzb3VyY2U6ICcnIH0pKS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnSGFzaGFnZScsICgpID0+IHtcclxuICAgIGl0KCdoYXNoIGRlcyBjaGHDrm5lcyBhdmVjIFNIQS0yNTYnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RTdHJpbmcgPSAndGVzdC1zdHJpbmcnO1xyXG4gICAgICBjb25zdCBoYXNoID0gYXdhaXQgc2VjdXJpdHkuaGFzaCh0ZXN0U3RyaW5nKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgaGFzaCkudG9CZSgnc3RyaW5nJyk7XHJcbiAgICAgIGV4cGVjdChoYXNoLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3QoZ2xvYmFsLmNyeXB0by5zdWJ0bGUuZGlnZXN0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnU0hBLTI1NicsIGV4cGVjdC5hbnkoVWludDhBcnJheSkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Byb2R1aXQgZGVzIGhhc2hzIGNvaMOpcmVudHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RTdHJpbmcgPSAnY29uc2lzdGVudC10ZXN0JztcclxuICAgICAgY29uc3QgaGFzaDEgPSBhd2FpdCBzZWN1cml0eS5oYXNoKHRlc3RTdHJpbmcpO1xyXG4gICAgICBjb25zdCBoYXNoMiA9IGF3YWl0IHNlY3VyaXR5Lmhhc2godGVzdFN0cmluZyk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QoaGFzaDEpLnRvQmUoaGFzaDIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2hhc2ggc3luYyBmb25jdGlvbm5lIGNvbW1lIGZhbGxiYWNrJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0U3RyaW5nID0gJ3N5bmMtdGVzdCc7XHJcbiAgICAgIGNvbnN0IGhhc2ggPSBzZWN1cml0eS5oYXNoU3luYyh0ZXN0U3RyaW5nKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdCh0eXBlb2YgaGFzaCkudG9CZSgnc3RyaW5nJyk7XHJcbiAgICAgIGV4cGVjdChoYXNoLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pOyAiXSwidmVyc2lvbiI6M30=