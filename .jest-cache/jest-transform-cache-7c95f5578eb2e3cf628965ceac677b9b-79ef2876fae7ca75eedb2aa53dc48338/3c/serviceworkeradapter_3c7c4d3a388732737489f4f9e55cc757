10fa9f6d44df110f417bbfe820696cf2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ServiceWorkerGlobals = exports.ServiceWorkerIndexedDB = exports.ServiceWorkerCrypto = exports.ServiceWorkerMessageChannel = exports.ServiceWorkerStorage = exports.swIndexedDB = exports.swCryptoAPI = exports.swBroadcastChannel = exports.swLocalStorage = void 0;
const secureLogger_1 = require("@shared/utils/secureLogger");
// background/service-worker-adapter.ts
// Adaptation du background script SYMBIONT pour Service Worker
// 1. Remplacement de window.localStorage par chrome.storage
class ServiceWorkerStorage {
    static getInstance() {
        if (!this.instance) {
            this.instance = new ServiceWorkerStorage();
        }
        return this.instance;
    }
    async setItem(key, value) {
        try {
            await chrome.storage.local.set({ [key]: value });
        }
        catch (error) {
            secureLogger_1.logger.error('Storage error:', error);
            throw error;
        }
    }
    async getItem(key) {
        try {
            const result = await chrome.storage.local.get([key]);
            return result[key] || null;
        }
        catch (error) {
            secureLogger_1.logger.error('Storage retrieval error:', error);
            return null;
        }
    }
    async removeItem(key) {
        try {
            await chrome.storage.local.remove([key]);
        }
        catch (error) {
            secureLogger_1.logger.error('Storage removal error:', error);
        }
    }
}
exports.ServiceWorkerStorage = ServiceWorkerStorage;
// 2. Remplacement de BroadcastChannel par chrome.runtime messaging
class ServiceWorkerMessageChannel {
    constructor(channelName) {
        this.handlers = new Map();
        this.channelName = channelName;
        this.setupMessageListener();
    }
    setupMessageListener() {
        // Écouter les messages du runtime (depuis content scripts)
        chrome.runtime.onMessage.addListener((message, _sender, _sendResponse) => {
            if (message.type === 'CRYPTO_OPERATION') {
                // Traitement spécial pour les opérations crypto
                return true;
            }
            if (message.channel === this.channelName) {
                this.handleMessage(message.data);
                return true;
            }
            return false; // Ajout du return pour tous les chemins
        });
    }
    // Fonction pour nettoyer les messages avant sérialisation
    serializeMessageData(data) {
        try {
            return JSON.parse(JSON.stringify(data));
        }
        catch (error) {
            secureLogger_1.logger.warn('Message serialization issue, cleaning object:', error);
            return this.cleanObjectForSerialization(data);
        }
    }
    cleanObjectForSerialization(obj, seen = new WeakSet()) {
        if (obj === null || obj === undefined)
            return obj;
        if (typeof obj === 'function')
            return '[Function]';
        if (obj instanceof Date)
            return obj.toISOString();
        if (obj instanceof Error)
            return { name: obj.name, message: obj.message, stack: obj.stack };
        // Objets WebGL, DOM, React non-sérialisables
        if (obj instanceof WebGLRenderingContext ||
            obj instanceof WebGL2RenderingContext ||
            obj instanceof HTMLElement ||
            obj instanceof WebGLProgram ||
            obj instanceof WebGLBuffer ||
            obj instanceof WebGLTexture ||
            (obj && obj.$$typeof) || // React elements
            (obj && obj.__reactFiber) || // React fiber
            (obj && obj._owner) // React internal
        ) {
            return '[Non-serializable Object]';
        }
        if (typeof obj !== 'object')
            return obj;
        // Vérification des références circulaires
        if (seen.has(obj)) {
            return '[Circular Reference]';
        }
        seen.add(obj);
        if (Array.isArray(obj))
            return obj.map(item => this.cleanObjectForSerialization(item, seen));
        const cleaned = {};
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                try {
                    cleaned[key] = this.cleanObjectForSerialization(obj[key], seen);
                }
                catch (error) {
                    // Supprime les logs verbeux
                    cleaned[key] = '[Non-serializable]';
                }
            }
        }
        return cleaned;
    }
    postMessage(data) {
        // Nettoyer les données avant envoi
        const cleanData = this.serializeMessageData(data);
        // Envoyer à tous les onglets
        chrome.tabs.query({}, (tabs) => {
            tabs.forEach(tab => {
                if (tab.id) {
                    chrome.tabs.sendMessage(tab.id, {
                        channel: this.channelName,
                        data: cleanData
                    }).catch(() => {
                        // Ignorer les erreurs pour les onglets non accessibles
                    });
                }
            });
        });
        // Envoyer aux autres service workers via storage
        this.broadcastViaStorage(cleanData);
    }
    async broadcastViaStorage(data) {
        const storage = ServiceWorkerStorage.getInstance();
        const timestamp = Date.now();
        const messageKey = `broadcast_${this.channelName}_${timestamp}`;
        await storage.setItem(messageKey, JSON.stringify({
            data,
            timestamp,
            channel: this.channelName
        }));
        // Auto-nettoyage après 30 secondes
        setTimeout(async () => {
            await storage.removeItem(messageKey);
        }, 30000);
    }
    handleMessage(data) {
        const handlers = this.handlers.get('message') || [];
        handlers.forEach(handler => {
            try {
                handler({ data });
            }
            catch (error) {
                secureLogger_1.logger.error('Message handler error:', error);
            }
        });
    }
    set onmessage(handler) {
        if (!this.handlers.has('message')) {
            this.handlers.set('message', []);
        }
        this.handlers.get('message').push(handler);
    }
}
exports.ServiceWorkerMessageChannel = ServiceWorkerMessageChannel;
// 3. Adaptation des APIs crypto pour Service Worker
class ServiceWorkerCrypto {
    constructor() {
        this.encryptionKey = "symbiont-key-demo";
    }
    async encryptSensitiveData(data) {
        try {
            // Utiliser les Crypto APIs natives du Service Worker
            const encoder = new TextEncoder();
            const keyMaterial = encoder.encode(this.encryptionKey.padEnd(32, '0').slice(0, 32));
            const key = await crypto.subtle.importKey('raw', keyMaterial, { name: 'AES-GCM' }, false, ['encrypt']);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encodedData = encoder.encode(JSON.stringify(data));
            const encryptedData = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encodedData);
            const combined = new Uint8Array(iv.length + encryptedData.byteLength);
            combined.set(iv, 0);
            combined.set(new Uint8Array(encryptedData), iv.length);
            return btoa(String.fromCharCode(...combined));
        }
        catch (error) {
            secureLogger_1.logger.error('Encryption failed, using fallback:', error);
            // Fallback simple pour les cas d'urgence
            const jsonString = JSON.stringify(data);
            return btoa(unescape(encodeURIComponent(jsonString)));
        }
    }
    async decryptSensitiveData(encryptedData) {
        try {
            const combined = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
            const iv = combined.slice(0, 12);
            const encrypted = combined.slice(12);
            const encoder = new TextEncoder();
            const keyMaterial = encoder.encode(this.encryptionKey.padEnd(32, '0').slice(0, 32));
            const key = await crypto.subtle.importKey('raw', keyMaterial, { name: 'AES-GCM' }, false, ['decrypt']);
            const decryptedData = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encrypted);
            const decoder = new TextDecoder();
            return JSON.parse(decoder.decode(decryptedData));
        }
        catch (error) {
            secureLogger_1.logger.error('Decryption failed, trying fallback:', error);
            // Fallback pour les données non chiffrées
            try {
                const jsonString = decodeURIComponent(escape(atob(encryptedData)));
                return JSON.parse(jsonString);
            }
            catch (fallbackError) {
                secureLogger_1.logger.error('All decryption methods failed:', fallbackError);
                throw new Error('Unable to decrypt data');
            }
        }
    }
}
exports.ServiceWorkerCrypto = ServiceWorkerCrypto;
// 4. IndexedDB adapter pour Service Worker
class ServiceWorkerIndexedDB {
    constructor() {
        this.db = null;
        this.DB_NAME = "symbiont-db";
        this.DB_VERSION = 2;
    }
    async initialize() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve();
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                // Créer les object stores nécessaires
                if (!db.objectStoreNames.contains('organism')) {
                    db.createObjectStore('organism', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('behaviors')) {
                    const behaviorStore = db.createObjectStore('behaviors', { keyPath: 'url' });
                    behaviorStore.createIndex('visitCount', 'visitCount', { unique: false });
                    behaviorStore.createIndex('lastVisit', 'lastVisit', { unique: false });
                }
                if (!db.objectStoreNames.contains('mutations')) {
                    const mutationStore = db.createObjectStore('mutations', { autoIncrement: true });
                    mutationStore.createIndex('timestamp', 'timestamp', { unique: false });
                    mutationStore.createIndex('type', 'type', { unique: false });
                }
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
                if (!db.objectStoreNames.contains('invitations')) {
                    db.createObjectStore('invitations', { keyPath: 'code' });
                }
            };
        });
    }
    // Méthodes de base pour organism, behaviors, etc.
    async getOrganism() {
        if (!this.db)
            throw new Error('Database not initialized');
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['organism'], 'readonly');
            const store = transaction.objectStore('organism');
            const request = store.get('current');
            request.onsuccess = () => resolve(request.result || null);
            request.onerror = () => reject(request.error);
        });
    }
    async saveOrganism(organism) {
        if (!this.db)
            throw new Error('Database not initialized');
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['organism'], 'readwrite');
            const store = transaction.objectStore('organism');
            const request = store.put({ ...organism, id: 'current' });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
}
exports.ServiceWorkerIndexedDB = ServiceWorkerIndexedDB;
// 5. Gestionnaire global pour remplacer les APIs manquantes
class ServiceWorkerGlobals {
    // Wrapper localStorage
    static get swLocalStorage() {
        return {
            getItem: (key) => this.storage.getItem(key),
            setItem: (key, value) => this.storage.setItem(key, value),
            removeItem: (key) => this.storage.removeItem(key)
        };
    }
    // Wrapper indexedDB (déjà disponible en Service Worker)
    static get swIndexedDB() {
        return globalThis.indexedDB;
    }
    // Crypto APIs améliorées
    static get swCryptoAPI() {
        return {
            ...globalThis.crypto,
            encryptSensitiveData: this.swCrypto.encryptSensitiveData.bind(this.swCrypto),
            decryptSensitiveData: this.swCrypto.decryptSensitiveData.bind(this.swCrypto)
        };
    }
}
exports.ServiceWorkerGlobals = ServiceWorkerGlobals;
ServiceWorkerGlobals.storage = ServiceWorkerStorage.getInstance();
ServiceWorkerGlobals.swCrypto = new ServiceWorkerCrypto();
// Wrapper BroadcastChannel
ServiceWorkerGlobals.swBroadcastChannel = ServiceWorkerMessageChannel;
// Utilisation recommandée : importer ces wrappers dans le code du service worker
exports.swLocalStorage = ServiceWorkerGlobals.swLocalStorage;
exports.swBroadcastChannel = ServiceWorkerGlobals.swBroadcastChannel;
exports.swCryptoAPI = ServiceWorkerGlobals.swCryptoAPI;
exports.swIndexedDB = ServiceWorkerGlobals.swIndexedDB;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvc3JjL2JhY2tncm91bmQvc2VydmljZS13b3JrZXItYWRhcHRlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2REFBb0Q7QUFDcEQsdUNBQXVDO0FBQ3ZDLCtEQUErRDtBQUUvRCw0REFBNEQ7QUFDNUQsTUFBTSxvQkFBb0I7SUFHeEIsTUFBTSxDQUFDLFdBQVc7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksb0JBQW9CLEVBQUUsQ0FBQztRQUM3QyxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQVcsRUFBRSxLQUFhO1FBQ3RDLElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YscUJBQU0sQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEMsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBVztRQUN2QixJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDckQsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDO1FBQzdCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YscUJBQU0sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEQsT0FBTyxJQUFJ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QU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1NBQzFELENBQUM7SUFDSixDQUFDO0lBRUQsd0RBQXdEO0lBQ3hELE1BQU0sS0FBSyxXQUFXO1FBQ3BCLE9BQU8sVUFBVSxDQUFDLFNBQVMsQ0FBQztJQUM5QixDQUFDO0lBS0QseUJBQXlCO0lBQ3pCLE1BQU0sS0FBSyxXQUFXO1FBQ3BCLE9BQU87WUFDTCxHQUFHLFVBQVUsQ0FBQyxNQUFNO1lBQ3BCLG9CQUFvQixFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDNUUsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztTQUM3RSxDQUFDO0lBQ0osQ0FBQzs7QUFlRCxvREFBb0I7QUExQ0wsNEJBQU8sR0FBRyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUM3Qyw2QkFBUSxHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQztBQWdCcEQsMkJBQTJCO0FBQ3BCLHVDQUFrQixHQUFHLDJCQUEyQixDQUFDO0FBWTFELGlGQUFpRjtBQUNwRSxRQUFBLGNBQWMsR0FBRyxvQkFBb0IsQ0FBQyxjQUFjLENBQUM7QUFDckQsUUFBQSxrQkFBa0IsR0FBRyxvQkFBb0IsQ0FBQyxrQkFBa0IsQ0FBQztBQUM3RCxRQUFBLFdBQVcsR0FBRyxvQkFBb0IsQ0FBQyxXQUFXLENBQUM7QUFDL0MsUUFBQSxXQUFXLEdBQUcsb0JBQW9CLENBQUMsV0FBVyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9tX29saS9Qcm9qZXRzL1NZTUJJT05UL3NyYy9iYWNrZ3JvdW5kL3NlcnZpY2Utd29ya2VyLWFkYXB0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnQHNoYXJlZC91dGlscy9zZWN1cmVMb2dnZXInO1xyXG4vLyBiYWNrZ3JvdW5kL3NlcnZpY2Utd29ya2VyLWFkYXB0ZXIudHNcclxuLy8gQWRhcHRhdGlvbiBkdSBiYWNrZ3JvdW5kIHNjcmlwdCBTWU1CSU9OVCBwb3VyIFNlcnZpY2UgV29ya2VyXHJcblxyXG4vLyAxLiBSZW1wbGFjZW1lbnQgZGUgd2luZG93LmxvY2FsU3RvcmFnZSBwYXIgY2hyb21lLnN0b3JhZ2VcclxuY2xhc3MgU2VydmljZVdvcmtlclN0b3JhZ2Uge1xyXG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBTZXJ2aWNlV29ya2VyU3RvcmFnZTtcclxuICBcclxuICBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogU2VydmljZVdvcmtlclN0b3JhZ2Uge1xyXG4gICAgaWYgKCF0aGlzLmluc3RhbmNlKSB7XHJcbiAgICAgIHRoaXMuaW5zdGFuY2UgPSBuZXcgU2VydmljZVdvcmtlclN0b3JhZ2UoKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmluc3RhbmNlO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2V0SXRlbShrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KHsgW2tleV06IHZhbHVlIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKCdTdG9yYWdlIGVycm9yOicsIGVycm9yKTtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRJdGVtKGtleTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoW2tleV0pO1xyXG4gICAgICByZXR1cm4gcmVzdWx0W2tleV0gfHwgbnVsbDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcignU3RvcmFnZSByZXRyaWV2YWwgZXJyb3I6JywgZXJyb3IpO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHJlbW92ZUl0ZW0oa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IGNocm9tZS5zdG9yYWdlLmxvY2FsLnJlbW92ZShba2V5XSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoJ1N0b3JhZ2UgcmVtb3ZhbCBlcnJvcjonLCBlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLyAyLiBSZW1wbGFjZW1lbnQgZGUgQnJvYWRjYXN0Q2hhbm5lbCBwYXIgY2hyb21lLnJ1bnRpbWUgbWVzc2FnaW5nXHJcbmNsYXNzIFNlcnZpY2VXb3JrZXJNZXNzYWdlQ2hhbm5lbCB7XHJcbiAgcHJpdmF0ZSBoYW5kbGVyczogTWFwPHN0cmluZywgQXJyYXk8KGRhdGE6IGFueSkgPT4gdm9pZD4+ID0gbmV3IE1hcCgpO1xyXG4gIHByaXZhdGUgY2hhbm5lbE5hbWU6IHN0cmluZztcclxuXHJcbiAgY29uc3RydWN0b3IoY2hhbm5lbE5hbWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5jaGFubmVsTmFtZSA9IGNoYW5uZWxOYW1lO1xyXG4gICAgdGhpcy5zZXR1cE1lc3NhZ2VMaXN0ZW5lcigpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXR1cE1lc3NhZ2VMaXN0ZW5lcigpOiB2b2lkIHtcclxuICAgIC8vIMOJY291dGVyIGxlcyBtZXNzYWdlcyBkdSBydW50aW1lIChkZXB1aXMgY29udGVudCBzY3JpcHRzKVxyXG4gICAgY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKChtZXNzYWdlLCBfc2VuZGVyLCBfc2VuZFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgIGlmIChtZXNzYWdlLnR5cGUgPT09ICdDUllQVE9fT1BFUkFUSU9OJykge1xyXG4gICAgICAgIC8vIFRyYWl0ZW1lbnQgc3DDqWNpYWwgcG91ciBsZXMgb3DDqXJhdGlvbnMgY3J5cHRvXHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIGlmIChtZXNzYWdlLmNoYW5uZWwgPT09IHRoaXMuY2hhbm5lbE5hbWUpIHtcclxuICAgICAgICB0aGlzLmhhbmRsZU1lc3NhZ2UobWVzc2FnZS5kYXRhKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcmV0dXJuIGZhbHNlOyAvLyBBam91dCBkdSByZXR1cm4gcG91ciB0b3VzIGxlcyBjaGVtaW5zXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIEZvbmN0aW9uIHBvdXIgbmV0dG95ZXIgbGVzIG1lc3NhZ2VzIGF2YW50IHPDqXJpYWxpc2F0aW9uXHJcbiAgcHJpdmF0ZSBzZXJpYWxpemVNZXNzYWdlRGF0YShkYXRhOiBhbnkpOiBhbnkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgbG9nZ2VyLndhcm4oJ01lc3NhZ2Ugc2VyaWFsaXphdGlvbiBpc3N1ZSwgY2xlYW5pbmcgb2JqZWN0OicsIGVycm9yKTtcclxuICAgICAgcmV0dXJuIHRoaXMuY2xlYW5PYmplY3RGb3JTZXJpYWxpemF0aW9uKGRhdGEpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbGVhbk9iamVjdEZvclNlcmlhbGl6YXRpb24ob2JqOiBhbnksIHNlZW4gPSBuZXcgV2Vha1NldCgpKTogYW55IHtcclxuICAgIGlmIChvYmogPT09IG51bGwgfHwgb2JqID09PSB1bmRlZmluZWQpIHJldHVybiBvYmo7XHJcbiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuICdbRnVuY3Rpb25dJztcclxuICAgIGlmIChvYmogaW5zdGFuY2VvZiBEYXRlKSByZXR1cm4gb2JqLnRvSVNPU3RyaW5nKCk7XHJcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgRXJyb3IpIHJldHVybiB7IG5hbWU6IG9iai5uYW1lLCBtZXNzYWdlOiBvYmoubWVzc2FnZSwgc3RhY2s6IG9iai5zdGFjayB9O1xyXG4gICAgXHJcbiAgICAvLyBPYmpldHMgV2ViR0wsIERPTSwgUmVhY3Qgbm9uLXPDqXJpYWxpc2FibGVzXHJcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgV2ViR0xSZW5kZXJpbmdDb250ZXh0IHx8IFxyXG4gICAgICAgIG9iaiBpbnN0YW5jZW9mIFdlYkdMMlJlbmRlcmluZ0NvbnRleHQgfHxcclxuICAgICAgICBvYmogaW5zdGFuY2VvZiBIVE1MRWxlbWVudCB8fFxyXG4gICAgICAgIG9iaiBpbnN0YW5jZW9mIFdlYkdMUHJvZ3JhbSB8fFxyXG4gICAgICAgIG9iaiBpbnN0YW5jZW9mIFdlYkdMQnVmZmVyIHx8XHJcbiAgICAgICAgb2JqIGluc3RhbmNlb2YgV2ViR0xUZXh0dXJlIHx8XHJcbiAgICAgICAgKG9iaiAmJiBvYmouJCR0eXBlb2YpIHx8IC8vIFJlYWN0IGVsZW1lbnRzXHJcbiAgICAgICAgKG9iaiAmJiBvYmouX19yZWFjdEZpYmVyKSB8fCAvLyBSZWFjdCBmaWJlclxyXG4gICAgICAgIChvYmogJiYgb2JqLl9vd25lcikgLy8gUmVhY3QgaW50ZXJuYWxcclxuICAgICkge1xyXG4gICAgICByZXR1cm4gJ1tOb24tc2VyaWFsaXphYmxlIE9iamVjdF0nO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcpIHJldHVybiBvYmo7XHJcbiAgICBcclxuICAgIC8vIFbDqXJpZmljYXRpb24gZGVzIHLDqWbDqXJlbmNlcyBjaXJjdWxhaXJlc1xyXG4gICAgaWYgKHNlZW4uaGFzKG9iaikpIHtcclxuICAgICAgcmV0dXJuICdbQ2lyY3VsYXIgUmVmZXJlbmNlXSc7XHJcbiAgICB9XHJcbiAgICBzZWVuLmFkZChvYmopO1xyXG4gICAgXHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gb2JqLm1hcChpdGVtID0+IHRoaXMuY2xlYW5PYmplY3RGb3JTZXJpYWxpemF0aW9uKGl0ZW0sIHNlZW4pKTtcclxuICAgIFxyXG4gICAgY29uc3QgY2xlYW5lZDogYW55ID0ge307XHJcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmopIHtcclxuICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNsZWFuZWRba2V5XSA9IHRoaXMuY2xlYW5PYmplY3RGb3JTZXJpYWxpemF0aW9uKG9ialtrZXldLCBzZWVuKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgLy8gU3VwcHJpbWUgbGVzIGxvZ3MgdmVyYmV1eFxyXG4gICAgICAgICAgY2xlYW5lZFtrZXldID0gJ1tOb24tc2VyaWFsaXphYmxlXSc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2xlYW5lZDtcclxuICB9XHJcblxyXG4gIHBvc3RNZXNzYWdlKGRhdGE6IGFueSk6IHZvaWQge1xyXG4gICAgLy8gTmV0dG95ZXIgbGVzIGRvbm7DqWVzIGF2YW50IGVudm9pXHJcbiAgICBjb25zdCBjbGVhbkRhdGEgPSB0aGlzLnNlcmlhbGl6ZU1lc3NhZ2VEYXRhKGRhdGEpO1xyXG4gICAgXHJcbiAgICAvLyBFbnZveWVyIMOgIHRvdXMgbGVzIG9uZ2xldHNcclxuICAgIGNocm9tZS50YWJzLnF1ZXJ5KHt9LCAodGFicykgPT4ge1xyXG4gICAgICB0YWJzLmZvckVhY2godGFiID0+IHtcclxuICAgICAgICBpZiAodGFiLmlkKSB7XHJcbiAgICAgICAgICBjaHJvbWUudGFicy5zZW5kTWVzc2FnZSh0YWIuaWQsIHtcclxuICAgICAgICAgICAgY2hhbm5lbDogdGhpcy5jaGFubmVsTmFtZSxcclxuICAgICAgICAgICAgZGF0YTogY2xlYW5EYXRhXHJcbiAgICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIElnbm9yZXIgbGVzIGVycmV1cnMgcG91ciBsZXMgb25nbGV0cyBub24gYWNjZXNzaWJsZXNcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBFbnZveWVyIGF1eCBhdXRyZXMgc2VydmljZSB3b3JrZXJzIHZpYSBzdG9yYWdlXHJcbiAgICB0aGlzLmJyb2FkY2FzdFZpYVN0b3JhZ2UoY2xlYW5EYXRhKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgYnJvYWRjYXN0VmlhU3RvcmFnZShkYXRhOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHN0b3JhZ2UgPSBTZXJ2aWNlV29ya2VyU3RvcmFnZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcclxuICAgIGNvbnN0IG1lc3NhZ2VLZXkgPSBgYnJvYWRjYXN0XyR7dGhpcy5jaGFubmVsTmFtZX1fJHt0aW1lc3RhbXB9YDtcclxuICAgIFxyXG4gICAgYXdhaXQgc3RvcmFnZS5zZXRJdGVtKG1lc3NhZ2VLZXksIEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgZGF0YSxcclxuICAgICAgdGltZXN0YW1wLFxyXG4gICAgICBjaGFubmVsOiB0aGlzLmNoYW5uZWxOYW1lXHJcbiAgICB9KSk7XHJcblxyXG4gICAgLy8gQXV0by1uZXR0b3lhZ2UgYXByw6hzIDMwIHNlY29uZGVzXHJcbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgc3RvcmFnZS5yZW1vdmVJdGVtKG1lc3NhZ2VLZXkpO1xyXG4gICAgfSwgMzAwMDApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVNZXNzYWdlKGRhdGE6IGFueSk6IHZvaWQge1xyXG4gICAgY29uc3QgaGFuZGxlcnMgPSB0aGlzLmhhbmRsZXJzLmdldCgnbWVzc2FnZScpIHx8IFtdO1xyXG4gICAgaGFuZGxlcnMuZm9yRWFjaChoYW5kbGVyID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBoYW5kbGVyKHsgZGF0YSB9KTtcclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoJ01lc3NhZ2UgaGFuZGxlciBlcnJvcjonLCBlcnJvcik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2V0IG9ubWVzc2FnZShoYW5kbGVyOiAoZXZlbnQ6IHsgZGF0YTogYW55IH0pID0+IHZvaWQpIHtcclxuICAgIGlmICghdGhpcy5oYW5kbGVycy5oYXMoJ21lc3NhZ2UnKSkge1xyXG4gICAgICB0aGlzLmhhbmRsZXJzLnNldCgnbWVzc2FnZScsIFtdKTtcclxuICAgIH1cclxuICAgIHRoaXMuaGFuZGxlcnMuZ2V0KCdtZXNzYWdlJykhLnB1c2goaGFuZGxlcik7XHJcbiAgfVxyXG59XHJcblxyXG4vLyAzLiBBZGFwdGF0aW9uIGRlcyBBUElzIGNyeXB0byBwb3VyIFNlcnZpY2UgV29ya2VyXHJcbmNsYXNzIFNlcnZpY2VXb3JrZXJDcnlwdG8ge1xyXG4gIHByaXZhdGUgZW5jcnlwdGlvbktleSA9IFwic3ltYmlvbnQta2V5LWRlbW9cIjtcclxuXHJcbiAgYXN5bmMgZW5jcnlwdFNlbnNpdGl2ZURhdGEoZGF0YTogYW55KTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIFV0aWxpc2VyIGxlcyBDcnlwdG8gQVBJcyBuYXRpdmVzIGR1IFNlcnZpY2UgV29ya2VyXHJcbiAgICAgIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcclxuICAgICAgY29uc3Qga2V5TWF0ZXJpYWwgPSBlbmNvZGVyLmVuY29kZSh0aGlzLmVuY3J5cHRpb25LZXkucGFkRW5kKDMyLCAnMCcpLnNsaWNlKDAsIDMyKSk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBrZXkgPSBhd2FpdCBjcnlwdG8uc3VidGxlLmltcG9ydEtleShcclxuICAgICAgICAncmF3JyxcclxuICAgICAgICBrZXlNYXRlcmlhbCxcclxuICAgICAgICB7IG5hbWU6ICdBRVMtR0NNJyB9LFxyXG4gICAgICAgIGZhbHNlLFxyXG4gICAgICAgIFsnZW5jcnlwdCddXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBjb25zdCBpdiA9IGNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQ4QXJyYXkoMTIpKTtcclxuICAgICAgY29uc3QgZW5jb2RlZERhdGEgPSBlbmNvZGVyLmVuY29kZShKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBlbmNyeXB0ZWREYXRhID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5lbmNyeXB0KFxyXG4gICAgICAgIHsgbmFtZTogJ0FFUy1HQ00nLCBpdiB9LFxyXG4gICAgICAgIGtleSxcclxuICAgICAgICBlbmNvZGVkRGF0YVxyXG4gICAgICApO1xyXG5cclxuICAgICAgY29uc3QgY29tYmluZWQgPSBuZXcgVWludDhBcnJheShpdi5sZW5ndGggKyBlbmNyeXB0ZWREYXRhLmJ5dGVMZW5ndGgpO1xyXG4gICAgICBjb21iaW5lZC5zZXQoaXYsIDApO1xyXG4gICAgICBjb21iaW5lZC5zZXQobmV3IFVpbnQ4QXJyYXkoZW5jcnlwdGVkRGF0YSksIGl2Lmxlbmd0aCk7XHJcbiAgICAgIFxyXG4gICAgICByZXR1cm4gYnRvYShTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLmNvbWJpbmVkKSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoJ0VuY3J5cHRpb24gZmFpbGVkLCB1c2luZyBmYWxsYmFjazonLCBlcnJvcik7XHJcbiAgICAgIC8vIEZhbGxiYWNrIHNpbXBsZSBwb3VyIGxlcyBjYXMgZCd1cmdlbmNlXHJcbiAgICAgIGNvbnN0IGpzb25TdHJpbmcgPSBKU09OLnN0cmluZ2lmeShkYXRhKTtcclxuICAgICAgcmV0dXJuIGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGpzb25TdHJpbmcpKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBkZWNyeXB0U2Vuc2l0aXZlRGF0YShlbmNyeXB0ZWREYXRhOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgY29tYmluZWQgPSBVaW50OEFycmF5LmZyb20oYXRvYihlbmNyeXB0ZWREYXRhKSwgYyA9PiBjLmNoYXJDb2RlQXQoMCkpO1xyXG4gICAgICBjb25zdCBpdiA9IGNvbWJpbmVkLnNsaWNlKDAsIDEyKTtcclxuICAgICAgY29uc3QgZW5jcnlwdGVkID0gY29tYmluZWQuc2xpY2UoMTIpO1xyXG5cclxuICAgICAgY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpO1xyXG4gICAgICBjb25zdCBrZXlNYXRlcmlhbCA9IGVuY29kZXIuZW5jb2RlKHRoaXMuZW5jcnlwdGlvbktleS5wYWRFbmQoMzIsICcwJykuc2xpY2UoMCwgMzIpKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGtleSA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KFxyXG4gICAgICAgICdyYXcnLFxyXG4gICAgICAgIGtleU1hdGVyaWFsLFxyXG4gICAgICAgIHsgbmFtZTogJ0FFUy1HQ00nIH0sXHJcbiAgICAgICAgZmFsc2UsXHJcbiAgICAgICAgWydkZWNyeXB0J11cclxuICAgICAgKTtcclxuXHJcbiAgICAgIGNvbnN0IGRlY3J5cHRlZERhdGEgPSBhd2FpdCBjcnlwdG8uc3VidGxlLmRlY3J5cHQoXHJcbiAgICAgICAgeyBuYW1lOiAnQUVTLUdDTScsIGl2IH0sXHJcbiAgICAgICAga2V5LFxyXG4gICAgICAgIGVuY3J5cHRlZFxyXG4gICAgICApO1xyXG5cclxuICAgICAgY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpO1xyXG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShkZWNvZGVyLmRlY29kZShkZWNyeXB0ZWREYXRhKSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoJ0RlY3J5cHRpb24gZmFpbGVkLCB0cnlpbmcgZmFsbGJhY2s6JywgZXJyb3IpO1xyXG4gICAgICAvLyBGYWxsYmFjayBwb3VyIGxlcyBkb25uw6llcyBub24gY2hpZmZyw6llc1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGpzb25TdHJpbmcgPSBkZWNvZGVVUklDb21wb25lbnQoZXNjYXBlKGF0b2IoZW5jcnlwdGVkRGF0YSkpKTtcclxuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShqc29uU3RyaW5nKTtcclxuICAgICAgfSBjYXRjaCAoZmFsbGJhY2tFcnJvcikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcignQWxsIGRlY3J5cHRpb24gbWV0aG9kcyBmYWlsZWQ6JywgZmFsbGJhY2tFcnJvcik7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gZGVjcnlwdCBkYXRhJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbi8vIDQuIEluZGV4ZWREQiBhZGFwdGVyIHBvdXIgU2VydmljZSBXb3JrZXJcclxuY2xhc3MgU2VydmljZVdvcmtlckluZGV4ZWREQiB7XHJcbiAgcHJpdmF0ZSBkYjogSURCRGF0YWJhc2UgfCBudWxsID0gbnVsbDtcclxuICBwcml2YXRlIHJlYWRvbmx5IERCX05BTUUgPSBcInN5bWJpb250LWRiXCI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBEQl9WRVJTSU9OID0gMjtcclxuXHJcbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBpbmRleGVkREIub3Blbih0aGlzLkRCX05BTUUsIHRoaXMuREJfVkVSU0lPTik7XHJcbiAgICAgIFxyXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XHJcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZGIgPSByZXF1ZXN0LnJlc3VsdDtcclxuICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICByZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRiID0gKGV2ZW50LnRhcmdldCBhcyBJREJPcGVuREJSZXF1ZXN0KS5yZXN1bHQ7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQ3LDqWVyIGxlcyBvYmplY3Qgc3RvcmVzIG7DqWNlc3NhaXJlc1xyXG4gICAgICAgIGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucygnb3JnYW5pc20nKSkge1xyXG4gICAgICAgICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ29yZ2FuaXNtJywgeyBrZXlQYXRoOiAnaWQnIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAoIWRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoJ2JlaGF2aW9ycycpKSB7XHJcbiAgICAgICAgICBjb25zdCBiZWhhdmlvclN0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ2JlaGF2aW9ycycsIHsga2V5UGF0aDogJ3VybCcgfSk7XHJcbiAgICAgICAgICBiZWhhdmlvclN0b3JlLmNyZWF0ZUluZGV4KCd2aXNpdENvdW50JywgJ3Zpc2l0Q291bnQnLCB7IHVuaXF1ZTogZmFsc2UgfSk7XHJcbiAgICAgICAgICBiZWhhdmlvclN0b3JlLmNyZWF0ZUluZGV4KCdsYXN0VmlzaXQnLCAnbGFzdFZpc2l0JywgeyB1bmlxdWU6IGZhbHNlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAoIWRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoJ211dGF0aW9ucycpKSB7XHJcbiAgICAgICAgICBjb25zdCBtdXRhdGlvblN0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ211dGF0aW9ucycsIHsgYXV0b0luY3JlbWVudDogdHJ1ZSB9KTtcclxuICAgICAgICAgIG11dGF0aW9uU3RvcmUuY3JlYXRlSW5kZXgoJ3RpbWVzdGFtcCcsICd0aW1lc3RhbXAnLCB7IHVuaXF1ZTogZmFsc2UgfSk7XHJcbiAgICAgICAgICBtdXRhdGlvblN0b3JlLmNyZWF0ZUluZGV4KCd0eXBlJywgJ3R5cGUnLCB7IHVuaXF1ZTogZmFsc2UgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucygnc2V0dGluZ3MnKSkge1xyXG4gICAgICAgICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ3NldHRpbmdzJywgeyBrZXlQYXRoOiAna2V5JyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCFkYi5vYmplY3RTdG9yZU5hbWVzLmNvbnRhaW5zKCdpbnZpdGF0aW9ucycpKSB7XHJcbiAgICAgICAgICBkYi5jcmVhdGVPYmplY3RTdG9yZSgnaW52aXRhdGlvbnMnLCB7IGtleVBhdGg6ICdjb2RlJyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIE3DqXRob2RlcyBkZSBiYXNlIHBvdXIgb3JnYW5pc20sIGJlaGF2aW9ycywgZXRjLlxyXG4gIGFzeW5jIGdldE9yZ2FuaXNtKCk6IFByb21pc2U8YW55PiB7XHJcbiAgICBpZiAoIXRoaXMuZGIpIHRocm93IG5ldyBFcnJvcignRGF0YWJhc2Ugbm90IGluaXRpYWxpemVkJyk7XHJcbiAgICBcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy5kYiEudHJhbnNhY3Rpb24oWydvcmdhbmlzbSddLCAncmVhZG9ubHknKTtcclxuICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSgnb3JnYW5pc20nKTtcclxuICAgICAgY29uc3QgcmVxdWVzdCA9IHN0b3JlLmdldCgnY3VycmVudCcpO1xyXG4gICAgICBcclxuICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiByZXNvbHZlKHJlcXVlc3QucmVzdWx0IHx8IG51bGwpO1xyXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHNhdmVPcmdhbmlzbShvcmdhbmlzbTogYW55KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAoIXRoaXMuZGIpIHRocm93IG5ldyBFcnJvcignRGF0YWJhc2Ugbm90IGluaXRpYWxpemVkJyk7XHJcbiAgICBcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy5kYiEudHJhbnNhY3Rpb24oWydvcmdhbmlzbSddLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoJ29yZ2FuaXNtJyk7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5wdXQoeyAuLi5vcmdhbmlzbSwgaWQ6ICdjdXJyZW50JyB9KTtcclxuICAgICAgXHJcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gcmVzb2x2ZSgpO1xyXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbi8vIDUuIEdlc3Rpb25uYWlyZSBnbG9iYWwgcG91ciByZW1wbGFjZXIgbGVzIEFQSXMgbWFucXVhbnRlc1xyXG5jbGFzcyBTZXJ2aWNlV29ya2VyR2xvYmFscyB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgc3RvcmFnZSA9IFNlcnZpY2VXb3JrZXJTdG9yYWdlLmdldEluc3RhbmNlKCk7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgc3dDcnlwdG8gPSBuZXcgU2VydmljZVdvcmtlckNyeXB0bygpO1xyXG4gIFxyXG4gIC8vIFdyYXBwZXIgbG9jYWxTdG9yYWdlXHJcbiAgc3RhdGljIGdldCBzd0xvY2FsU3RvcmFnZSgpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGdldEl0ZW06IChrZXk6IHN0cmluZykgPT4gdGhpcy5zdG9yYWdlLmdldEl0ZW0oa2V5KSxcclxuICAgICAgc2V0SXRlbTogKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSA9PiB0aGlzLnN0b3JhZ2Uuc2V0SXRlbShrZXksIHZhbHVlKSxcclxuICAgICAgcmVtb3ZlSXRlbTogKGtleTogc3RyaW5nKSA9PiB0aGlzLnN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpXHJcbiAgICB9O1xyXG4gIH1cclxuICBcclxuICAvLyBXcmFwcGVyIGluZGV4ZWREQiAoZMOpasOgIGRpc3BvbmlibGUgZW4gU2VydmljZSBXb3JrZXIpXHJcbiAgc3RhdGljIGdldCBzd0luZGV4ZWREQigpIHtcclxuICAgIHJldHVybiBnbG9iYWxUaGlzLmluZGV4ZWREQjtcclxuICB9XHJcbiAgXHJcbiAgLy8gV3JhcHBlciBCcm9hZGNhc3RDaGFubmVsXHJcbiAgc3RhdGljIHN3QnJvYWRjYXN0Q2hhbm5lbCA9IFNlcnZpY2VXb3JrZXJNZXNzYWdlQ2hhbm5lbDtcclxuICBcclxuICAvLyBDcnlwdG8gQVBJcyBhbcOpbGlvcsOpZXNcclxuICBzdGF0aWMgZ2V0IHN3Q3J5cHRvQVBJKCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgLi4uZ2xvYmFsVGhpcy5jcnlwdG8sXHJcbiAgICAgIGVuY3J5cHRTZW5zaXRpdmVEYXRhOiB0aGlzLnN3Q3J5cHRvLmVuY3J5cHRTZW5zaXRpdmVEYXRhLmJpbmQodGhpcy5zd0NyeXB0byksXHJcbiAgICAgIGRlY3J5cHRTZW5zaXRpdmVEYXRhOiB0aGlzLnN3Q3J5cHRvLmRlY3J5cHRTZW5zaXRpdmVEYXRhLmJpbmQodGhpcy5zd0NyeXB0bylcclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG4vLyBVdGlsaXNhdGlvbiByZWNvbW1hbmTDqWUgOiBpbXBvcnRlciBjZXMgd3JhcHBlcnMgZGFucyBsZSBjb2RlIGR1IHNlcnZpY2Ugd29ya2VyXHJcbmV4cG9ydCBjb25zdCBzd0xvY2FsU3RvcmFnZSA9IFNlcnZpY2VXb3JrZXJHbG9iYWxzLnN3TG9jYWxTdG9yYWdlO1xyXG5leHBvcnQgY29uc3Qgc3dCcm9hZGNhc3RDaGFubmVsID0gU2VydmljZVdvcmtlckdsb2JhbHMuc3dCcm9hZGNhc3RDaGFubmVsO1xyXG5leHBvcnQgY29uc3Qgc3dDcnlwdG9BUEkgPSBTZXJ2aWNlV29ya2VyR2xvYmFscy5zd0NyeXB0b0FQSTtcclxuZXhwb3J0IGNvbnN0IHN3SW5kZXhlZERCID0gU2VydmljZVdvcmtlckdsb2JhbHMuc3dJbmRleGVkREI7XHJcblxyXG4vLyBFeHBvcnQgcG91ciB1dGlsaXNhdGlvbiBhdmFuY8OpZVxyXG5leHBvcnQge1xyXG4gIFNlcnZpY2VXb3JrZXJTdG9yYWdlLFxyXG4gIFNlcnZpY2VXb3JrZXJNZXNzYWdlQ2hhbm5lbCxcclxuICBTZXJ2aWNlV29ya2VyQ3J5cHRvLFxyXG4gIFNlcnZpY2VXb3JrZXJJbmRleGVkREIsXHJcbiAgU2VydmljZVdvcmtlckdsb2JhbHNcclxufTsgIl0sInZlcnNpb24iOjN9