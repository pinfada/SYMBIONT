c43fd0108feae85c7f6ea9b1e00cce81
"use strict";
/**
 * Système de logging sécurisé
 * Remplace console.log avec protection des données sensibles et gestion des niveaux
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.secureDebug = exports.secureError = exports.secureWarn = exports.secureLog = exports.logger = exports.SecureLogger = exports.LogLevel = void 0;
var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["TRACE"] = 0] = "TRACE";
    LogLevel[LogLevel["DEBUG"] = 1] = "DEBUG";
    LogLevel[LogLevel["INFO"] = 2] = "INFO";
    LogLevel[LogLevel["WARN"] = 3] = "WARN";
    LogLevel[LogLevel["ERROR"] = 4] = "ERROR";
    LogLevel[LogLevel["FATAL"] = 5] = "FATAL";
})(LogLevel || (exports.LogLevel = LogLevel = {}));
class SecureLogger {
    constructor(config = {}) {
        this.logEntries = [];
        this.config = {
            level: LogLevel.INFO,
            enableConsole: !this.isProduction(),
            enableStorage: true,
            maxStorageEntries: 1000,
            sensitiveFields: ['password', 'token', 'key', 'secret', 'auth'],
            productionMode: this.isProduction(),
            ...config
        };
    }
    static getInstance(config) {
        if (!SecureLogger.instance) {
            SecureLogger.instance = new SecureLogger(config);
        }
        return SecureLogger.instance;
    }
    isProduction() {
        return process.env.NODE_ENV === 'production' ||
            (typeof chrome !== 'undefined' && typeof chrome.runtime?.getManifest === 'function');
    }
    /**
     * Sanitise les données pour supprimer les informations sensibles
     */
    sanitizeData(data) {
        if (typeof data === 'string') {
            return this.sanitizeString(data);
        }
        if (typeof data === 'object' && data !== null) {
            if (Array.isArray(data)) {
                return data.map(item => this.sanitizeData(item));
            }
            const sanitized = {};
            for (const [key, value] of Object.entries(data)) {
                if (this.isSensitiveField(key)) {
                    sanitized[key] = '[REDACTED]';
                }
                else {
                    sanitized[key] = this.sanitizeData(value);
                }
            }
            return sanitized;
        }
        return data;
    }
    sanitizeString(str) {
        let sanitized = str;
        for (const pattern of SecureLogger.SENSITIVE_PATTERNS) {
            sanitized = sanitized.replace(pattern, '[REDACTED]');
        }
        return sanitized;
    }
    isSensitiveField(fieldName) {
        return this.config.sensitiveFields.some(field => fieldName.toLowerCase().includes(field.toLowerCase()));
    }
    formatMessage(level, message, data, context) {
        const timestamp = new Date().toISOString();
        const levelName = LogLevel[level];
        const contextStr = context ? ` [${context}]` : '';
        const dataStr = data ? ` ${JSON.stringify(data, null, 2)}` : '';
        return `[${timestamp}] ${levelName}${contextStr}: ${message}${dataStr}`;
    }
    shouldLog(level) {
        return level >= this.config.level;
    }
    log(level, message, data, context) {
        if (!this.shouldLog(level)) {
            return;
        }
        const sanitizedData = data ? this.sanitizeData(data) : undefined;
        const sanitizedMessage = this.sanitizeString(message);
        const logEntry = {
            timestamp: Date.now(),
            level,
            message: sanitizedMessage,
            data: sanitizedData,
            context,
            sanitized: true
        };
        // Stockage des logs
        if (this.config.enableStorage) {
            this.logEntries.push(logEntry);
            // Limiter le nombre d'entrées en mémoire
            if (this.logEntries.length > this.config.maxStorageEntries) {
                this.logEntries = this.logEntries.slice(-this.config.maxStorageEntries);
            }
        }
        // Affichage console (seulement en développement par défaut)
        if (this.config.enableConsole) {
            const formattedMessage = this.formatMessage(level, sanitizedMessage, sanitizedData, context);
            switch (level) {
                case LogLevel.TRACE:
                case LogLevel.DEBUG:
                    console.debug(formattedMessage);
                    break;
                case LogLevel.INFO:
                    console.info(formattedMessage);
                    break;
                case LogLevel.WARN:
                    console.warn(formattedMessage);
                    break;
                case LogLevel.ERROR:
                case LogLevel.FATAL:
                    console.error(formattedMessage);
                    break;
            }
        }
    }
    // Méthodes publiques de logging
    trace(message, data, context) {
        this.log(LogLevel.TRACE, message, data, context);
    }
    debug(message, data, context) {
        this.log(LogLevel.DEBUG, message, data, context);
    }
    info(message, data, context) {
        this.log(LogLevel.INFO, message, data, context);
    }
    warn(message, data, context) {
        this.log(LogLevel.WARN, message, data, context);
    }
    error(message, data, context) {
        this.log(LogLevel.ERROR, message, data, context);
    }
    fatal(message, data, context) {
        this.log(LogLevel.FATAL, message, data, context);
    }
    // Méthodes utilitaires
    setLevel(level) {
        this.config.level = level;
    }
    enableConsole(enable) {
        this.config.enableConsole = enable;
    }
    getLogs(level) {
        if (level !== undefined) {
            return this.logEntries.filter(entry => entry.level >= level);
        }
        return [...this.logEntries];
    }
    clearLogs() {
        this.logEntries = [];
    }
    exportLogs() {
        return JSON.stringify(this.logEntries, null, 2);
    }
}
exports.SecureLogger = SecureLogger;
// Patterns pour détecter les données sensibles
SecureLogger.SENSITIVE_PATTERNS = [
    /password/i,
    /token/i,
    /key/i,
    /secret/i,
    /auth/i,
    /credential/i,
    /session/i,
    /cookie/i,
    /jwt/i,
    /bearer/i,
    /api[_-]?key/i,
    /access[_-]?token/i,
    /refresh[_-]?token/i,
    /private[_-]?key/i,
    /\b[A-Za-z0-9+/]{32,}={0,2}\b/, // Base64
    /\b[0-9a-f]{32,}\b/i, // Hex strings
    /\b[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}\b/, // Credit card pattern
    /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/ // Email
];
// Instance globale pour un usage facile
exports.logger = SecureLogger.getInstance();
// Aliases pour migration facile depuis console.log
exports.secureLog = exports.logger.info.bind(exports.logger);
exports.secureWarn = exports.logger.warn.bind(exports.logger);
exports.secureError = exports.logger.error.bind(exports.logger);
exports.secureDebug = exports.logger.debug.bind(exports.logger);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL21fb2xpL1Byb2pldHMvU1lNQklPTlQvc3JjL3NoYXJlZC91dGlscy9zZWN1cmVMb2dnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgsSUFBWSxRQU9YO0FBUEQsV0FBWSxRQUFRO0lBQ2xCLHlDQUFTLENBQUE7SUFDVCx5Q0FBUyxDQUFBO0lBQ1QsdUNBQVEsQ0FBQTtJQUNSLHVDQUFRLENBQUE7SUFDUix5Q0FBUyxDQUFBO0lBQ1QseUNBQVMsQ0FBQTtBQUNYLENBQUMsRUFQVyxRQUFRLHdCQUFSLFFBQVEsUUFPbkI7QUFvQkQsTUFBYSxZQUFZO0lBMkJ2QixZQUFvQixTQUE2QixFQUFFO1FBeEIzQyxlQUFVLEdBQWUsRUFBRSxDQUFDO1FBeUJsQyxJQUFJLENBQUMsTUFBTSxHQUFHO1lBQ1osS0FBSyxFQUFFLFFBQVEsQ0FBQyxJQUFJO1lBQ3BCLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDbkMsYUFBYSxFQUFFLElBQUk7WUFDbkIsaUJBQWlCLEVBQUUsSUFBSTtZQUN2QixlQUFlLEVBQUUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDO1lBQy9ELGNBQWMsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ25DLEdBQUcsTUFBTTtTQUNWLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUEyQjtRQUM1QyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzNCLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkQsQ0FBQztRQUNELE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQztJQUMvQixDQUFDO0lBRU8sWUFBWTtRQUNsQixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLFlBQVk7WUFDckMsQ0FBQyxPQUFPLE1BQU0sS0FBSyxXQUFXLElBQUksT0FBTyxN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VUFBVTtJQUNWLFNBQVM7SUFDVCxNQUFNO0lBQ04sU0FBUztJQUNULGNBQWM7SUFDZCxtQkFBbUI7SUFDbkIsb0JBQW9CO0lBQ3BCLGtCQUFrQjtJQUNsQiw4QkFBOEIsRUFBRSxTQUFTO0lBQ3pDLG9CQUFvQixFQUFFLGNBQWM7SUFDcEMscURBQXFELEVBQUUsc0JBQXNCO0lBQzdFLHFEQUFxRCxDQUFDLFFBQVE7Q0FDL0QsQUFuQnlDLENBbUJ4QztBQXNMSix3Q0FBd0M7QUFDM0IsUUFBQSxNQUFNLEdBQUcsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBRWpELG1EQUFtRDtBQUN0QyxRQUFBLFNBQVMsR0FBRyxjQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFNLENBQUMsQ0FBQztBQUNyQyxRQUFBLFVBQVUsR0FBRyxjQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFNLENBQUMsQ0FBQztBQUN0QyxRQUFBLFdBQVcsR0FBRyxjQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFNLENBQUMsQ0FBQztBQUN4QyxRQUFBLFdBQVcsR0FBRyxjQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFNLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvbW50L2MvVXNlcnMvbV9vbGkvUHJvamV0cy9TWU1CSU9OVC9zcmMvc2hhcmVkL3V0aWxzL3NlY3VyZUxvZ2dlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFN5c3TDqG1lIGRlIGxvZ2dpbmcgc8OpY3VyaXPDqVxuICogUmVtcGxhY2UgY29uc29sZS5sb2cgYXZlYyBwcm90ZWN0aW9uIGRlcyBkb25uw6llcyBzZW5zaWJsZXMgZXQgZ2VzdGlvbiBkZXMgbml2ZWF1eFxuICovXG5cbmV4cG9ydCBlbnVtIExvZ0xldmVsIHtcbiAgVFJBQ0UgPSAwLFxuICBERUJVRyA9IDEsXG4gIElORk8gPSAyLFxuICBXQVJOID0gMyxcbiAgRVJST1IgPSA0LFxuICBGQVRBTCA9IDVcbn1cblxuaW50ZXJmYWNlIExvZ0NvbmZpZyB7XG4gIGxldmVsOiBMb2dMZXZlbDtcbiAgZW5hYmxlQ29uc29sZTogYm9vbGVhbjtcbiAgZW5hYmxlU3RvcmFnZTogYm9vbGVhbjtcbiAgbWF4U3RvcmFnZUVudHJpZXM6IG51bWJlcjtcbiAgc2Vuc2l0aXZlRmllbGRzOiBzdHJpbmdbXTtcbiAgcHJvZHVjdGlvbk1vZGU6IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBMb2dFbnRyeSB7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xuICBsZXZlbDogTG9nTGV2ZWw7XG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgZGF0YT86IGFueTtcbiAgY29udGV4dD86IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgc2FuaXRpemVkOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgU2VjdXJlTG9nZ2VyIHtcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFNlY3VyZUxvZ2dlcjtcbiAgcHJpdmF0ZSBjb25maWc6IExvZ0NvbmZpZztcbiAgcHJpdmF0ZSBsb2dFbnRyaWVzOiBMb2dFbnRyeVtdID0gW107XG4gIFxuICAvLyBQYXR0ZXJucyBwb3VyIGTDqXRlY3RlciBsZXMgZG9ubsOpZXMgc2Vuc2libGVzXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFNFTlNJVElWRV9QQVRURVJOUyA9IFtcbiAgICAvcGFzc3dvcmQvaSxcbiAgICAvdG9rZW4vaSxcbiAgICAva2V5L2ksXG4gICAgL3NlY3JldC9pLFxuICAgIC9hdXRoL2ksXG4gICAgL2NyZWRlbnRpYWwvaSxcbiAgICAvc2Vzc2lvbi9pLFxuICAgIC9jb29raWUvaSxcbiAgICAvand0L2ksXG4gICAgL2JlYXJlci9pLFxuICAgIC9hcGlbXy1dP2tleS9pLFxuICAgIC9hY2Nlc3NbXy1dP3Rva2VuL2ksXG4gICAgL3JlZnJlc2hbXy1dP3Rva2VuL2ksXG4gICAgL3ByaXZhdGVbXy1dP2tleS9pLFxuICAgIC9cXGJbQS1aYS16MC05Ky9dezMyLH09ezAsMn1cXGIvLCAvLyBCYXNlNjRcbiAgICAvXFxiWzAtOWEtZl17MzIsfVxcYi9pLCAvLyBIZXggc3RyaW5nc1xuICAgIC9cXGJbMC05XXs0fVtfLV0/WzAtOV17NH1bXy1dP1swLTldezR9W18tXT9bMC05XXs0fVxcYi8sIC8vIENyZWRpdCBjYXJkIHBhdHRlcm5cbiAgICAvXFxiW0EtWmEtejAtOS5fJSstXStAW0EtWmEtejAtOS4tXStcXC5bQS1afGEtel17Mix9XFxiLyAvLyBFbWFpbFxuICBdO1xuXG4gIHByaXZhdGUgY29uc3RydWN0b3IoY29uZmlnOiBQYXJ0aWFsPExvZ0NvbmZpZz4gPSB7fSkge1xuICAgIHRoaXMuY29uZmlnID0ge1xuICAgICAgbGV2ZWw6IExvZ0xldmVsLklORk8sXG4gICAgICBlbmFibGVDb25zb2xlOiAhdGhpcy5pc1Byb2R1Y3Rpb24oKSxcbiAgICAgIGVuYWJsZVN0b3JhZ2U6IHRydWUsXG4gICAgICBtYXhTdG9yYWdlRW50cmllczogMTAwMCxcbiAgICAgIHNlbnNpdGl2ZUZpZWxkczogWydwYXNzd29yZCcsICd0b2tlbicsICdrZXknLCAnc2VjcmV0JywgJ2F1dGgnXSxcbiAgICAgIHByb2R1Y3Rpb25Nb2RlOiB0aGlzLmlzUHJvZHVjdGlvbigpLFxuICAgICAgLi4uY29uZmlnXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRJbnN0YW5jZShjb25maWc/OiBQYXJ0aWFsPExvZ0NvbmZpZz4pOiBTZWN1cmVMb2dnZXIge1xuICAgIGlmICghU2VjdXJlTG9nZ2VyLmluc3RhbmNlKSB7XG4gICAgICBTZWN1cmVMb2dnZXIuaW5zdGFuY2UgPSBuZXcgU2VjdXJlTG9nZ2VyKGNvbmZpZyk7XG4gICAgfVxuICAgIHJldHVybiBTZWN1cmVMb2dnZXIuaW5zdGFuY2U7XG4gIH1cblxuICBwcml2YXRlIGlzUHJvZHVjdGlvbigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJyB8fCBcbiAgICAgICAgICAgKHR5cGVvZiBjaHJvbWUgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBjaHJvbWUucnVudGltZT8uZ2V0TWFuaWZlc3QgPT09ICdmdW5jdGlvbicpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNhbml0aXNlIGxlcyBkb25uw6llcyBwb3VyIHN1cHByaW1lciBsZXMgaW5mb3JtYXRpb25zIHNlbnNpYmxlc1xuICAgKi9cbiAgcHJpdmF0ZSBzYW5pdGl6ZURhdGEoZGF0YTogYW55KTogYW55IHtcbiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdGhpcy5zYW5pdGl6ZVN0cmluZyhkYXRhKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmIGRhdGEgIT09IG51bGwpIHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgIHJldHVybiBkYXRhLm1hcChpdGVtID0+IHRoaXMuc2FuaXRpemVEYXRhKGl0ZW0pKTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2FuaXRpemVkOiBhbnkgPSB7fTtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEpKSB7XG4gICAgICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlRmllbGQoa2V5KSkge1xuICAgICAgICAgIHNhbml0aXplZFtrZXldID0gJ1tSRURBQ1RFRF0nO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNhbml0aXplZFtrZXldID0gdGhpcy5zYW5pdGl6ZURhdGEodmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gc2FuaXRpemVkO1xuICAgIH1cblxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgcHJpdmF0ZSBzYW5pdGl6ZVN0cmluZyhzdHI6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IHNhbml0aXplZCA9IHN0cjtcbiAgICBcbiAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgU2VjdXJlTG9nZ2VyLlNFTlNJVElWRV9QQVRURVJOUykge1xuICAgICAgc2FuaXRpemVkID0gc2FuaXRpemVkLnJlcGxhY2UocGF0dGVybiwgJ1tSRURBQ1RFRF0nKTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHNhbml0aXplZDtcbiAgfVxuXG4gIHByaXZhdGUgaXNTZW5zaXRpdmVGaWVsZChmaWVsZE5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZy5zZW5zaXRpdmVGaWVsZHMuc29tZShmaWVsZCA9PiBcbiAgICAgIGZpZWxkTmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZpZWxkLnRvTG93ZXJDYXNlKCkpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0TWVzc2FnZShsZXZlbDogTG9nTGV2ZWwsIG1lc3NhZ2U6IHN0cmluZywgZGF0YT86IGFueSwgY29udGV4dD86IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIGNvbnN0IGxldmVsTmFtZSA9IExvZ0xldmVsW2xldmVsXTtcbiAgICBjb25zdCBjb250ZXh0U3RyID0gY29udGV4dCA/IGAgWyR7Y29udGV4dH1dYCA6ICcnO1xuICAgIGNvbnN0IGRhdGFTdHIgPSBkYXRhID8gYCAke0pTT04uc3RyaW5naWZ5KGRhdGEsIG51bGwsIDIpfWAgOiAnJztcbiAgICBcbiAgICByZXR1cm4gYFske3RpbWVzdGFtcH1dICR7bGV2ZWxOYW1lfSR7Y29udGV4dFN0cn06ICR7bWVzc2FnZX0ke2RhdGFTdHJ9YDtcbiAgfVxuXG4gIHByaXZhdGUgc2hvdWxkTG9nKGxldmVsOiBMb2dMZXZlbCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBsZXZlbCA+PSB0aGlzLmNvbmZpZy5sZXZlbDtcbiAgfVxuXG4gIHByaXZhdGUgbG9nKGxldmVsOiBMb2dMZXZlbCwgbWVzc2FnZTogc3RyaW5nLCBkYXRhPzogYW55LCBjb250ZXh0Pzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnNob3VsZExvZyhsZXZlbCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzYW5pdGl6ZWREYXRhID0gZGF0YSA/IHRoaXMuc2FuaXRpemVEYXRhKGRhdGEpIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IHNhbml0aXplZE1lc3NhZ2UgPSB0aGlzLnNhbml0aXplU3RyaW5nKG1lc3NhZ2UpO1xuXG4gICAgY29uc3QgbG9nRW50cnk6IExvZ0VudHJ5ID0ge1xuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgbGV2ZWwsXG4gICAgICBtZXNzYWdlOiBzYW5pdGl6ZWRNZXNzYWdlLFxuICAgICAgZGF0YTogc2FuaXRpemVkRGF0YSxcbiAgICAgIGNvbnRleHQsXG4gICAgICBzYW5pdGl6ZWQ6IHRydWVcbiAgICB9O1xuXG4gICAgLy8gU3RvY2thZ2UgZGVzIGxvZ3NcbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlU3RvcmFnZSkge1xuICAgICAgdGhpcy5sb2dFbnRyaWVzLnB1c2gobG9nRW50cnkpO1xuICAgICAgXG4gICAgICAvLyBMaW1pdGVyIGxlIG5vbWJyZSBkJ2VudHLDqWVzIGVuIG3DqW1vaXJlXG4gICAgICBpZiAodGhpcy5sb2dFbnRyaWVzLmxlbmd0aCA+IHRoaXMuY29uZmlnLm1heFN0b3JhZ2VFbnRyaWVzKSB7XG4gICAgICAgIHRoaXMubG9nRW50cmllcyA9IHRoaXMubG9nRW50cmllcy5zbGljZSgtdGhpcy5jb25maWcubWF4U3RvcmFnZUVudHJpZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEFmZmljaGFnZSBjb25zb2xlIChzZXVsZW1lbnQgZW4gZMOpdmVsb3BwZW1lbnQgcGFyIGTDqWZhdXQpXG4gICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUNvbnNvbGUpIHtcbiAgICAgIGNvbnN0IGZvcm1hdHRlZE1lc3NhZ2UgPSB0aGlzLmZvcm1hdE1lc3NhZ2UobGV2ZWwsIHNhbml0aXplZE1lc3NhZ2UsIHNhbml0aXplZERhdGEsIGNvbnRleHQpO1xuICAgICAgXG4gICAgICBzd2l0Y2ggKGxldmVsKSB7XG4gICAgICAgIGNhc2UgTG9nTGV2ZWwuVFJBQ0U6XG4gICAgICAgIGNhc2UgTG9nTGV2ZWwuREVCVUc6XG4gICAgICAgICAgY29uc29sZS5kZWJ1Zyhmb3JtYXR0ZWRNZXNzYWdlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBMb2dMZXZlbC5JTkZPOlxuICAgICAgICAgIGNvbnNvbGUuaW5mbyhmb3JtYXR0ZWRNZXNzYWdlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBMb2dMZXZlbC5XQVJOOlxuICAgICAgICAgIGNvbnNvbGUud2Fybihmb3JtYXR0ZWRNZXNzYWdlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBMb2dMZXZlbC5FUlJPUjpcbiAgICAgICAgY2FzZSBMb2dMZXZlbC5GQVRBTDpcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGZvcm1hdHRlZE1lc3NhZ2UpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIE3DqXRob2RlcyBwdWJsaXF1ZXMgZGUgbG9nZ2luZ1xuICB0cmFjZShtZXNzYWdlOiBzdHJpbmcsIGRhdGE/OiBhbnksIGNvbnRleHQ/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmxvZyhMb2dMZXZlbC5UUkFDRSwgbWVzc2FnZSwgZGF0YSwgY29udGV4dCk7XG4gIH1cblxuICBkZWJ1ZyhtZXNzYWdlOiBzdHJpbmcsIGRhdGE/OiBhbnksIGNvbnRleHQ/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmxvZyhMb2dMZXZlbC5ERUJVRywgbWVzc2FnZSwgZGF0YSwgY29udGV4dCk7XG4gIH1cblxuICBpbmZvKG1lc3NhZ2U6IHN0cmluZywgZGF0YT86IGFueSwgY29udGV4dD86IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMubG9nKExvZ0xldmVsLklORk8sIG1lc3NhZ2UsIGRhdGEsIGNvbnRleHQpO1xuICB9XG5cbiAgd2FybihtZXNzYWdlOiBzdHJpbmcsIGRhdGE/OiBhbnksIGNvbnRleHQ/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmxvZyhMb2dMZXZlbC5XQVJOLCBtZXNzYWdlLCBkYXRhLCBjb250ZXh0KTtcbiAgfVxuXG4gIGVycm9yKG1lc3NhZ2U6IHN0cmluZywgZGF0YT86IGFueSwgY29udGV4dD86IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMubG9nKExvZ0xldmVsLkVSUk9SLCBtZXNzYWdlLCBkYXRhLCBjb250ZXh0KTtcbiAgfVxuXG4gIGZhdGFsKG1lc3NhZ2U6IHN0cmluZywgZGF0YT86IGFueSwgY29udGV4dD86IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMubG9nKExvZ0xldmVsLkZBVEFMLCBtZXNzYWdlLCBkYXRhLCBjb250ZXh0KTtcbiAgfVxuXG4gIC8vIE3DqXRob2RlcyB1dGlsaXRhaXJlc1xuICBzZXRMZXZlbChsZXZlbDogTG9nTGV2ZWwpOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZy5sZXZlbCA9IGxldmVsO1xuICB9XG5cbiAgZW5hYmxlQ29uc29sZShlbmFibGU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZy5lbmFibGVDb25zb2xlID0gZW5hYmxlO1xuICB9XG5cbiAgZ2V0TG9ncyhsZXZlbD86IExvZ0xldmVsKTogTG9nRW50cnlbXSB7XG4gICAgaWYgKGxldmVsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmxvZ0VudHJpZXMuZmlsdGVyKGVudHJ5ID0+IGVudHJ5LmxldmVsID49IGxldmVsKTtcbiAgICB9XG4gICAgcmV0dXJuIFsuLi50aGlzLmxvZ0VudHJpZXNdO1xuICB9XG5cbiAgY2xlYXJMb2dzKCk6IHZvaWQge1xuICAgIHRoaXMubG9nRW50cmllcyA9IFtdO1xuICB9XG5cbiAgZXhwb3J0TG9ncygpOiBzdHJpbmcge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLmxvZ0VudHJpZXMsIG51bGwsIDIpO1xuICB9XG59XG5cbi8vIEluc3RhbmNlIGdsb2JhbGUgcG91ciB1biB1c2FnZSBmYWNpbGVcbmV4cG9ydCBjb25zdCBsb2dnZXIgPSBTZWN1cmVMb2dnZXIuZ2V0SW5zdGFuY2UoKTtcblxuLy8gQWxpYXNlcyBwb3VyIG1pZ3JhdGlvbiBmYWNpbGUgZGVwdWlzIGNvbnNvbGUubG9nXG5leHBvcnQgY29uc3Qgc2VjdXJlTG9nID0gbG9nZ2VyLmluZm8uYmluZChsb2dnZXIpO1xuZXhwb3J0IGNvbnN0IHNlY3VyZVdhcm4gPSBsb2dnZXIud2Fybi5iaW5kKGxvZ2dlcik7XG5leHBvcnQgY29uc3Qgc2VjdXJlRXJyb3IgPSBsb2dnZXIuZXJyb3IuYmluZChsb2dnZXIpO1xuZXhwb3J0IGNvbnN0IHNlY3VyZURlYnVnID0gbG9nZ2VyLmRlYnVnLmJpbmQobG9nZ2VyKTsiXSwidmVyc2lvbiI6M30=