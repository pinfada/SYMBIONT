"use strict";(self.webpackChunksymbiont=self.webpackChunksymbiont||[]).push([[824],{526:(e,t,s)=>{s.d(t,{p:()=>n});class n{constructor(){this.db=null,this.DB_NAME="symbiont-db",this.DB_VERSION=3,this.OPERATION_TIMEOUT=1e4,this.MAX_STORAGE_SIZE_MB=50,this.quotaWarningIssued=!1}withTimeout(e,t=this.OPERATION_TIMEOUT){return Promise.race([e,new Promise(((e,s)=>setTimeout((()=>s(new Error(`Operation timed out after ${t}ms`))),t)))])}async initialize(){try{await this.checkStorageQuota()}catch(e){console.warn("Failed to check storage quota:",e)}const e=new Promise(((e,t)=>{const s=indexedDB.open(this.DB_NAME,this.DB_VERSION);s.onerror=()=>{const e=s.error;console.error("IndexedDB open failed:",{name:e?.name,message:e?.message,code:e?.code}),t(e)},s.onsuccess=()=>{this.db=s.result,this.db.onerror=e=>{console.error("Database error:",e)},this.db.onversionchange=()=>{console.warn("Database version changed, closing connection"),this.db?.close(),this.db=null},e()},s.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("organisms")){const e=t.createObjectStore("organisms",{keyPath:"id"});e.createIndex("generation","generation",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(!t.objectStoreNames.contains("behaviors")){const e=t.createObjectStore("behaviors",{keyPath:"url"});e.createIndex("lastVisit","lastVisit",{unique:!1}),e.createIndex("visitCount","visitCount",{unique:!1})}if(!t.objectStoreNames.contains("mutations")){const e=t.createObjectStore("mutations",{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}if(t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"key"}),!t.objectStoreNames.contains("invitations")){const e=t.createObjectStore("invitations",{keyPath:"code"});e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("status","status",{unique:!1})}}}));return this.withTimeout(e,15e3)}async getOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,s)=>{const n=this.db.transaction(["organisms"],"readonly").objectStore("organisms");if(e){const a=n.get(e);a.onsuccess=()=>t(a.result||null),a.onerror=()=>s(a.error)}else{const e=n.openCursor();e.onsuccess=e=>{const s=e.target.result;t(s?s.value:null)},e.onerror=()=>s(e.error)}}));return this.withTimeout(t)}async saveOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,s)=>{const n=this.db.transaction(["organisms"],"readwrite").objectStore("organisms").put(e);n.onsuccess=()=>t(),n.onerror=()=>s(n.error)}));return this.withTimeout(t)}async getBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const n=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").get(e);n.onsuccess=()=>t(n.result||null),n.onerror=()=>s(n.error)}))}async saveBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const n=this.db.transaction(["behaviors"],"readwrite").objectStore("behaviors").put(e);n.onsuccess=()=>t(),n.onerror=()=>s(n.error)}))}async addMutation(e){if(!this.db)throw new Error("Database not initialized");const t={...e,timestamp:e.timestamp||Date.now()};return new Promise(((e,s)=>{const n=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").add(t);n.onsuccess=()=>e(),n.onerror=()=>s(n.error)}))}async getRecentMutations(e=10){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const n=this.db.transaction(["mutations"],"readonly").objectStore("mutations").index("timestamp").openCursor(null,"prev"),a=[];n.onsuccess=s=>{const n=s.target.result;n&&a.length<e?(a.push(n.value),n.continue()):t(a)},n.onerror=()=>s(n.error)}))}async getSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((s,n)=>{const a=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);a.onsuccess=()=>{const e=a.result;s(e?e.value:t)},a.onerror=()=>n(a.error)}))}async setSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((s,n)=>{const a=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:e,value:t});a.onsuccess=()=>s(),a.onerror=()=>n(a.error)}))}async addInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const n=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").add({...e,createdAt:e.createdAt||Date.now()});n.onsuccess=()=>t(),n.onerror=()=>s(n.error)}))}async updateInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const n=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").put(e);n.onsuccess=()=>t(),n.onerror=()=>s(n.error)}))}async getInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const n=this.db.transaction(["invitations"],"readonly").objectStore("invitations").get(e);n.onsuccess=()=>t(n.result||null),n.onerror=()=>s(n.error)}))}async getAllInvitations(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const s=this.db.transaction(["invitations"],"readonly").objectStore("invitations").openCursor(),n=[];s.onsuccess=t=>{const s=t.target.result;s?(n.push(s.value),s.continue()):e(n)},s.onerror=()=>t(s.error)}))}async getBehaviorPatterns(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const s=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),n=[];s.onsuccess=t=>{const s=t.target.result;s?(n.push(s.value),s.continue()):(n.sort(((e,t)=>t.visitCount!==e.visitCount?t.visitCount-e.visitCount:t.lastVisit-e.lastVisit)),e(n))},s.onerror=()=>t(s.error)}))}async getRecentActivity(e=864e5){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-e;return new Promise(((e,s)=>{const n=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),a=[];n.onsuccess=s=>{const n=s.target.result;if(n){const e=n.value,s=(e.interactions||[]).filter((e=>e.timestamp>=t));for(const t of s)a.push({...t,url:e.url});n.continue()}else a.sort(((e,t)=>t.timestamp-e.timestamp)),e(a)},n.onerror=()=>s(n.error)}))}async cleanup(e=30){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-24*e*60*60*1e3;return new Promise(((e,s)=>{const n=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").index("timestamp"),a=IDBKeyRange.upperBound(t),r=n.openCursor(a);r.onsuccess=t=>{const s=t.target.result;s?(s.delete(),s.continue()):e()},r.onerror=()=>s(r.error)}))}async checkStorageQuota(){if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,s=(e.quota||0)/1048576,n=s>0?t/s*100:0;console.info("Storage quota:",{usageInMB:t.toFixed(2),quotaInMB:s.toFixed(2),usagePercent:n.toFixed(2)+"%"}),n>80&&!this.quotaWarningIssued&&(this.quotaWarningIssued=!0,console.warn("STORAGE WARNING: Usage above 80%, consider cleanup"),n>90&&(console.warn("STORAGE CRITICAL: Usage above 90%, triggering automatic cleanup"),await this.cleanup(15))),t>.9*this.MAX_STORAGE_SIZE_MB&&(console.error("STORAGE CRITICAL: Approaching maximum storage size limit"),await this.cleanup(7))}catch(e){console.error("Failed to check storage quota:",e)}else console.warn("Storage API not available, skipping quota check")}async getStorageStats(){if(!navigator.storage||!navigator.storage.estimate)return{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1};try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,s=(e.quota||0)/1048576,n=s>0?t/s*100:0;return{usageInMB:t,quotaInMB:s,usagePercent:n,needsCleanup:n>80}}catch(e){return console.error("Failed to get storage stats:",e),{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1}}}close(){this.db&&(this.db.close(),this.db=null)}}},824:(e,t,s)=>{s.r(t),s.d(t,{SettingsPanel:()=>i,default:()=>c});var n=s(848),a=s(540),r=s(526),o=s(513);const i=()=>{const{theme:e,setTheme:t}=(()=>{const[e,t]=(0,a.useState)("auto");return(0,a.useEffect)((()=>{chrome.storage.local.get(["theme"],(e=>{e.theme&&t(e.theme)}))}),[]),(0,a.useEffect)((()=>{const t=()=>{const t=window.matchMedia("(prefers-color-scheme: dark)").matches,s="auto"===e?t?"dark":"light":e;document.documentElement.setAttribute("data-theme",s)};t();const s=window.matchMedia("(prefers-color-scheme: dark)");return s.addEventListener("change",t),()=>s.removeEventListener("change",t)}),[e]),{theme:e,setTheme:e=>{t(e),chrome.storage.local.set({theme:e})}}})(),[i,c]=(0,a.useState)({theme:"auto",notifications:!0,autoMutate:!1,mutationSpeed:1,visualQuality:"high"}),[l,u]=(0,a.useState)(!1),[d,h]=(0,a.useState)({USE_REAL_DNA:!1,USE_REAL_BEHAVIOR:!1,USE_REAL_NETWORK:!1,USE_BACKEND_API:!1});(0,a.useEffect)((()=>{g(),m()}),[]);const g=async()=>{const e=new r.p;await e.initialize();const t=await e.getSetting("userPreferences",i);t&&c(t)},m=async()=>{try{const{RealDataService:e}=await s.e(605).then(s.bind(s,605)),t=e.getFeatureStatus();h(t)}catch(e){o.vF.warn("Impossible de charger les feature flags:",e)}},b=(e,t)=>{c((s=>({...s,[e]:t})))},x=async e=>{try{const{RealDataService:t}=await s.e(605).then(s.bind(s,605)),n=d[e];n?t.disableFeature(e):t.enableFeature(e),h((t=>({...t,[e]:!n}))),"USE_BACKEND_API"===e&&setTimeout((()=>window.location.reload()),100)}catch(e){o.vF.error("Erreur toggle feature flag:",e)}};return(0,n.jsxs)("div",{className:"ext-settings-panel max-w-lg mx-auto p-6 bg-white rounded-xl shadow-lg mt-8",children:[(0,n.jsx)("h2",{className:"text-2xl font-bold text-center text-[#00e0ff] mb-6",children:"ParamÃ¨tres"}),(0,n.jsxs)("section",{className:"ext-settings-section mb-6",children:[(0,n.jsx)("h3",{className:"text-lg font-bold text-[#00e0ff] mb-2",children:"PrÃ©fÃ©rences utilisateur"}),(0,n.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,n.jsxs)("label",{className:"flex items-center gap-2",children:[(0,n.jsx)("input",{type:"checkbox",checked:i.notifications,onChange:e=>b("notifications",e.target.checked)})," Notifications"]}),(0,n.jsxs)("label",{className:"flex items-center gap-2",children:[(0,n.jsx)("input",{type:"checkbox",checked:i.autoMutate,onChange:e=>b("autoMutate",e.target.checked)})," Mutation automatique"]}),(0,n.jsxs)("label",{className:"flex items-center gap-2",children:["QualitÃ© visuelleÂ :",(0,n.jsxs)("select",{value:i.visualQuality,onChange:e=>b("visualQuality",e.target.value),className:"ml-2 rounded-md border px-2 py-1",children:[(0,n.jsx)("option",{value:"high",children:"Haute"}),(0,n.jsx)("option",{value:"medium",children:"Moyenne"}),(0,n.jsx)("option",{value:"low",children:"Basse"})]})]})]})]}),(0,n.jsxs)("section",{className:"ext-settings-section",children:[(0,n.jsx)("h3",{className:"text-lg font-bold text-[#00e0ff] mb-2",children:"ThÃ¨me"}),(0,n.jsxs)("div",{className:"flex gap-4",children:[(0,n.jsx)("button",{onClick:()=>t("light"),className:"rounded-lg px-4 py-2 font-bold "+("light"===e?"bg-[#00e0ff] text-[#181c22]":"bg-[#eaf6fa] text-[#232946]"),children:"Clair"}),(0,n.jsx)("button",{onClick:()=>t("dark"),className:"rounded-lg px-4 py-2 font-bold "+("dark"===e?"bg-[#00e0ff] text-[#181c22]":"bg-[#232946] text-white"),children:"Sombre"}),(0,n.jsx)("button",{onClick:()=>t("auto"),className:"rounded-lg px-4 py-2 font-bold "+("auto"===e?"bg-[#00e0ff] text-[#181c22]":"bg-[#888] text-white"),children:"Auto"})]})]}),(0,n.jsxs)("section",{className:"ext-settings-section",children:[(0,n.jsx)("h3",{className:"text-lg font-bold text-[#00e0ff] mb-2",children:"ðŸ’¾ DonnÃ©es"}),(0,n.jsx)("div",{className:"flex flex-col gap-4",children:(0,n.jsxs)("label",{className:"flex items-center gap-2",children:[(0,n.jsx)("input",{type:"checkbox",checked:l,onChange:e=>u(e.target.checked)})," Sauvegarde automatique"]})})]}),(0,n.jsxs)("section",{className:"ext-settings-section",children:[(0,n.jsx)("h3",{className:"text-lg font-bold text-[#00e0ff] mb-2",children:"ðŸš€ DonnÃ©es RÃ©elles (Mode AvancÃ©)"}),(0,n.jsxs)("p",{className:"section-description",children:["Activez progressivement les vraies donnÃ©es pour remplacer le mode dÃ©mo.",(0,n.jsx)("br",{}),"âš ï¸ NÃ©cessite un rechargement de l'extension aprÃ¨s activation."]}),(0,n.jsxs)("div",{className:"feature-flags-grid",children:[(0,n.jsxs)("div",{className:"feature-flag-item",children:[(0,n.jsxs)("div",{className:"flag-info",children:[(0,n.jsx)("h4",{children:"ðŸ§¬ ADN Comportemental"}),(0,n.jsx)("p",{children:"GÃ©nÃ¨re l'ADN basÃ© sur vos vrais patterns de navigation"})]}),(0,n.jsxs)("label",{className:"toggle-switch",children:[(0,n.jsx)("input",{type:"checkbox",checked:d.USE_REAL_DNA,onChange:()=>x("USE_REAL_DNA").catch(console.error)}),(0,n.jsx)("span",{className:"toggle-slider"})]})]}),(0,n.jsxs)("div",{className:"feature-flag-item",children:[(0,n.jsxs)("div",{className:"flag-info",children:[(0,n.jsx)("h4",{children:"ðŸ“Š MÃ©triques SystÃ¨me"}),(0,n.jsx)("p",{children:"Collecte les vraies mÃ©triques de performance du navigateur"})]}),(0,n.jsxs)("label",{className:"toggle-switch",children:[(0,n.jsx)("input",{type:"checkbox",checked:d.USE_REAL_BEHAVIOR,onChange:()=>x("USE_REAL_BEHAVIOR").catch(console.error)}),(0,n.jsx)("span",{className:"toggle-slider"})]})]}),(0,n.jsxs)("div",{className:"feature-flag-item",children:[(0,n.jsxs)("div",{className:"flag-info",children:[(0,n.jsx)("h4",{children:"ðŸŒ RÃ©seau Social"}),(0,n.jsx)("p",{children:"Connecte au rÃ©seau SYMBIONT rÃ©el (nÃ©cessite backend)"})]}),(0,n.jsxs)("label",{className:"toggle-switch",children:[(0,n.jsx)("input",{type:"checkbox",checked:d.USE_REAL_NETWORK,onChange:()=>x("USE_REAL_NETWORK").catch(console.error)}),(0,n.jsx)("span",{className:"toggle-slider"})]})]}),(0,n.jsxs)("div",{className:"feature-flag-item",children:[(0,n.jsxs)("div",{className:"flag-info",children:[(0,n.jsx)("h4",{children:"ðŸ”Œ API Backend"}),(0,n.jsx)("p",{children:"Utilise l'API serveur pour synchroniser les donnÃ©es"})]}),(0,n.jsxs)("label",{className:"toggle-switch",children:[(0,n.jsx)("input",{type:"checkbox",checked:d.USE_BACKEND_API,onChange:()=>x("USE_BACKEND_API").catch(console.error)}),(0,n.jsx)("span",{className:"toggle-slider"})]})]})]}),(0,n.jsxs)("div",{className:"migration-actions",children:[(0,n.jsx)("button",{onClick:async()=>{try{const{realDataService:e}=await s.e(605).then(s.bind(s,605)),t=localStorage.getItem("symbiont_user_id")||"default-user";await e.migrateToRealData(t),alert("âœ… Migration vers vraies donnÃ©es rÃ©ussie ! Rechargez l'extension.")}catch(e){o.vF.error("Erreur migration:",e),alert("âŒ Erreur lors de la migration. Voir console.")}},className:"btn-primary migration-btn",disabled:!d.USE_REAL_DNA,children:"ðŸ”„ Migrer vers Vraies DonnÃ©es"}),(0,n.jsx)("p",{className:"migration-note",children:"Cette action gÃ©nÃ¨re un nouvel ADN basÃ© sur vos donnÃ©es de navigation rÃ©elles"})]})]}),(0,n.jsx)("div",{className:"flex justify-end mt-6",children:(0,n.jsx)("button",{onClick:async()=>{const e=new r.p;await e.initialize(),await e.setSetting("userPreferences",i)},className:"bg-[#00e0ff] text-[#181c22] rounded-lg px-5 py-2 font-bold cursor-pointer",children:"Enregistrer"})})]})},c=i}}]);