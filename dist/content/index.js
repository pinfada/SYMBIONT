(()=>{"use strict";var t;function e(t){return t&&"string"==typeof t.code&&"string"==typeof t.status}function i(t){if(null==t)return t;if("function"==typeof t)return"[Function]";if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if("object"!=typeof t)return t;if(Array.isArray(t))return t.map(i);const e={},s=new WeakSet;if(s.has(t))return"[Circular Reference]";s.add(t);for(const s in t)if(t.hasOwnProperty(s))try{e[s]=i(t[s])}catch(t){console.warn(`Failed to serialize property ${s}:`,t),e[s]="[Non-serializable]"}return e}!function(t){t.PAGE_VISIT="PAGE_VISIT",t.SCROLL_EVENT="SCROLL_EVENT",t.ORGANISM_UPDATE="ORGANISM_UPDATE",t.ORGANISM_MUTATE="ORGANISM_MUTATE",t.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",t.WEBGL_INIT="WEBGL_INIT",t.WEBGL_ERROR="WEBGL_ERROR",t.WEBGL_INITIALIZED="WEBGL_INITIALIZED",t.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",t.GENERATE_INVITATION="GENERATE_INVITATION",t.INVITATION_GENERATED="INVITATION_GENERATED",t.CONSUME_INVITATION="CONSUME_INVITATION",t.INVITATION_CONSUMED="INVITATION_CONSUMED",t.CHECK_INVITATION="CHECK_INVITATION",t.INVITATION_CHECKED="INVITATION_CHECKED",t.MURMUR="MURMUR",t.GET_INVITER="GET_INVITER",t.INVITER_RESULT="INVITER_RESULT",t.GET_INVITEES="GET_INVITEES",t.INVITEES_RESULT="INVITEES_RESULT",t.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",t.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",t.INTERACTION_DETECTED="INTERACTION_DETECTED",t.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",t.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",t.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",t.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",t.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",t.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",t.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",t.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",t.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED"}(t||(t={}));class s{constructor(t){this.source=t,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){chrome.runtime.onMessage.addListener(((t,e,i)=>(this.shouldProcessMessage(t)&&(this.enqueueMessage(t),i({received:!0})),!1)))}shouldProcessMessage(t){return this.filters.every((e=>e(t)))}async enqueueMessage(t){if(this.messageQueue.push(t),!this.processing){this.processing=!0;try{await this.processQueue()}finally{this.processing=!1}}}async processQueue(){for(;this.messageQueue.length>0;){const t=this.messageQueue.shift();await this.processMessage(t)}}async processMessage(i){if(!function(i,s){switch(i){case t.ORGANISM_UPDATE:return(n=s)&&"string"==typeof n.id&&"number"==typeof n.generation&&"number"==typeof n.health&&"number"==typeof n.energy&&n.traits&&"object"==typeof n.traits;case t.ORGANISM_MUTATE:return function(t){return t&&"string"==typeof t.type&&"string"==typeof t.trigger}(s);case t.PAGE_VISIT:case t.SCROLL_EVENT:return function(t){return t&&"string"==typeof t.url&&"number"==typeof t.visitCount}(s);case t.MURMUR:return function(t){return t&&"string"==typeof t.text&&"number"==typeof t.timestamp}(s);case t.GENERATE_INVITATION:case t.CONSUME_INVITATION:case t.CHECK_INVITATION:return function(t){return t&&"string"==typeof t.code}(s);case t.INVITATION_GENERATED:return"string"==typeof s||e(s);case t.INVITATION_CONSUMED:case t.INVITATION_CHECKED:return e(s);case t.SHARED_MUTATION_RESULT:return"string"==typeof s||s&&"object"==typeof s;default:return!0}var n}(i.type,i.payload))return void console.warn(`[MessageBus] Payload non valide pour le type ${i.type}`,i.payload);for(const t of this.globalHandlers)try{await t(i)}catch(t){console.error("Error in global handler:",t)}const s=this.handlers.get(i.type);if(s)for(const t of s)try{await t(i)}catch(t){console.error(`Error in handler for ${i.type}:`,t)}}on(t,e){this.handlers.has(t)||this.handlers.set(t,new Set),this.handlers.get(t).add(e)}off(t,e){const i=this.handlers.get(t);i&&i.delete(e)}onAny(t){this.globalHandlers.add(t)}offAny(t){this.globalHandlers.delete(t)}addFilter(t){this.filters.push(t)}async send(t){const e={...t,source:this.source,timestamp:Date.now(),id:crypto.randomUUID()};try{const t=function(t){try{return JSON.parse(JSON.stringify(t))}catch(e){return console.warn("Message serialization issue, cleaning object:",e),i(t)}}(e);if("content"===this.source)await chrome.runtime.sendMessage(t);else{const e=await chrome.tabs.query({}),i=t=>t.active||t.url&&t.url.includes("symbiont"),s=e.filter(i);for(const e of s)e.id&&chrome.tabs.sendMessage(e.id,t).catch((()=>{}));chrome.runtime.sendMessage(t).catch((()=>{}))}}catch(t){console.error("Error sending message:",t)}}sendToBackground(t){this.send(t)}emit(t,e){const i=this.handlers.get(t);i&&i.forEach((i=>i({type:t,payload:e})))}handleMessage(t,e){console.log("Handling message:",t)}onMessage(t,e,i){return console.log("Received message:",t),!0}sendToFrame(t,e,i){console.log("Sending to frame:",e,i)}}class n{constructor(t){this._handler=null}observe(t){this._handler=t}disconnect(){this._handler=null}}class a extends EventTarget{constructor(t){super(),this.isActive=!1,this.eventBuffer=[],this.lastFlushTime=0,this.eventCounts=new Map,this.lastEventTimes=new Map,this.mousePosition={x:0,y:0},this.lastClickTime=0,this.clickSequence=0,this.keySequence="",this.formInteractions=new Map,this.messageBus=t||null,this.config={clicks:!0,keypresses:!0,forms:!0,media:!0,hover:!0,selection:!0,contextmenu:!0,debounceMs:100,maxEventsPerSecond:20},this.setupEventListeners()}setupEventListeners(){document.addEventListener("mousemove",this.handleMouseMove.bind(this),{passive:!0}),document.addEventListener("mouseenter",this.handleMouseEnter.bind(this),{passive:!0}),document.addEventListener("mouseleave",this.handleMouseLeave.bind(this),{passive:!0}),this.config.clicks&&(document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("dblclick",this.handleDoubleClick.bind(this),!0)),this.config.keypresses&&(document.addEventListener("keydown",this.handleKeyDown.bind(this),!0),document.addEventListener("keyup",this.handleKeyUp.bind(this),!0)),this.config.forms&&(document.addEventListener("submit",this.handleFormSubmit.bind(this),!0),document.addEventListener("focus",this.handleFormFocus.bind(this),!0),document.addEventListener("blur",this.handleFormBlur.bind(this),!0),document.addEventListener("change",this.handleFormChange.bind(this),!0),document.addEventListener("input",this.handleFormInput.bind(this),!0)),this.config.media&&(document.addEventListener("play",this.handleMediaPlay.bind(this),!0),document.addEventListener("pause",this.handleMediaPause.bind(this),!0),document.addEventListener("ended",this.handleMediaEnded.bind(this),!0)),this.config.selection&&(document.addEventListener("selectstart",this.handleSelectionStart.bind(this),!0),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this),!0)),this.config.contextmenu&&document.addEventListener("contextmenu",this.handleContextMenu.bind(this),!0),setInterval((()=>this.flushEvents()),1e3)}handleMouseMove(t){this.mousePosition={x:t.clientX,y:t.clientY}}handleMouseEnter(t){this.config.hover&&this.recordInteraction({type:"hover",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"enter",duration:0},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleMouseLeave(t){this.config.hover&&this.recordInteraction({type:"hover",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"leave",duration:0},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleClick(t){const e=Date.now();e-this.lastClickTime<500?this.clickSequence++:this.clickSequence=1,this.lastClickTime=e;const i=t.target,s=this.isNavigationClick(i),n=this.isInteractiveElement(i);this.recordInteraction({type:"click",timestamp:e,target:this.getElementSelector(i),data:{button:t.button,clickSequence:this.clickSequence,isNavigation:s,isInteractive:n,modifiers:{ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey}},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(i)})}handleDoubleClick(t){this.recordInteraction({type:"click",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{isDoubleClick:!0,button:t.button},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleKeyDown(t){1===t.key.length&&(this.keySequence+=t.key,this.keySequence.length>20&&(this.keySequence=this.keySequence.slice(-20)));const e=t.ctrlKey||t.metaKey||t.altKey,i=["Enter","Tab","Escape","Backspace","Delete"].includes(t.key);(e||i)&&this.recordInteraction({type:"keypress",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{key:t.key,keyCode:t.keyCode,isShortcut:e,isSpecialKey:i,modifiers:{ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey},sequence:this.keySequence.slice(-5)},element:this.extractElementInfo(t.target)})}handleKeyUp(t){"Tab"===t.key&&this.recordInteraction({type:"keypress",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{key:t.key,action:"tab_navigation"},element:this.extractElementInfo(t.target)})}handleFormSubmit(t){const e=t.target,i=new FormData(e),s=this.formInteractions.get(this.getElementSelector(e))||{};this.recordInteraction({type:"form_submit",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:e.action,method:e.method,fieldCount:i.entries?Array.from(i.entries()).length:0,interactionTime:s.interactionTime||0,fieldInteractions:s.fieldInteractions||0},element:this.extractElementInfo(e)})}handleFormFocus(t){const e=t.target;if(this.isFormField(e)){const t=this.getFormSelector(e),i=this.formInteractions.get(t)||{startTime:Date.now(),fieldInteractions:0,interactionTime:0};i.fieldInteractions++,this.formInteractions.set(t,i),this.recordInteraction({type:"form_focus",timestamp:Date.now(),target:this.getElementSelector(e),data:{fieldType:e.type||e.tagName.toLowerCase(),fieldName:e.name||e.id,formSelector:t},element:this.extractElementInfo(e)})}}handleFormBlur(t){const e=t.target;if(this.isFormField(e)){const t=this.getFormSelector(e),i=this.formInteractions.get(t);i&&(i.interactionTime=Date.now()-i.startTime,this.formInteractions.set(t,i))}}handleFormChange(t){const e=t.target;this.isFormField(e)&&this.recordInteraction({type:"form_focus",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:"change",fieldType:e.type||e.tagName.toLowerCase(),hasValue:!!e.value},element:this.extractElementInfo(e)})}handleFormInput(t){const e=t.target,i=this.getElementSelector(e),s=this.lastEventTimes.get(i)||0,n=Date.now();n-s>this.config.debounceMs&&(this.lastEventTimes.set(i,n),this.isFormField(e)&&this.recordInteraction({type:"form_focus",timestamp:n,target:i,data:{action:"input",fieldType:e.type||e.tagName.toLowerCase(),valueLength:e.value?.length||0},element:this.extractElementInfo(e)}))}handleMediaPlay(t){const e=t.target;this.recordInteraction({type:"media_play",timestamp:Date.now(),target:this.getElementSelector(e),data:{mediaType:e.tagName.toLowerCase(),duration:e.duration,currentTime:e.currentTime,src:e.src},element:this.extractElementInfo(e)})}handleMediaPause(t){const e=t.target;this.recordInteraction({type:"media_pause",timestamp:Date.now(),target:this.getElementSelector(e),data:{mediaType:e.tagName.toLowerCase(),duration:e.duration,currentTime:e.currentTime,watchedPercentage:e.duration>0?e.currentTime/e.duration*100:0},element:this.extractElementInfo(e)})}handleMediaEnded(t){const e=t.target;this.recordInteraction({type:"media_pause",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:"ended",mediaType:e.tagName.toLowerCase(),duration:e.duration,completed:!0},element:this.extractElementInfo(e)})}handleSelectionStart(t){this.recordInteraction({type:"selection",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"start"},element:this.extractElementInfo(t.target)})}handleSelectionChange(t){const e=document.getSelection();e&&e.toString().length>0&&this.recordInteraction({type:"selection",timestamp:Date.now(),target:"document",data:{text:e.toString(),length:e.toString().length}})}handleContextMenu(t){this.recordInteraction({type:"contextmenu",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{button:t.button},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}recordInteraction(t){if(!this.isActive)return;const e=t.type,i=Date.now(),s=this.eventCounts.get(e)||0;if(i-(this.lastEventTimes.get(`reset_${e}`)||i)>1e3)this.eventCounts.set(e,1),this.lastEventTimes.set(`reset_${e}`,i);else{if(s>=this.config.maxEventsPerSecond)return;this.eventCounts.set(e,s+1)}this.eventBuffer.push(t),this.dispatchEvent(new CustomEvent("interaction",{detail:t})),this.eventBuffer.length>50&&this.flushEvents()}flushEvents(){if(0===this.eventBuffer.length)return;const t=[...this.eventBuffer];this.eventBuffer=[],this.lastFlushTime=Date.now(),this.messageBus&&this.messageBus.sendToBackground({type:"INTERACTIONS_BATCH",payload:{events:t,timestamp:Date.now(),url:window.location.href}})}getElementSelector(t){if(!t)return"unknown";let e=t.tagName.toLowerCase();if(t.id)e+=`#${t.id}`;else if(t.className){const i=t.className.split(" ").filter((t=>t.length>0));i.length>0&&(e+=`.${i.slice(0,3).join(".")}`)}return e}extractElementInfo(t){if(!t)return;const e={tag:t.tagName.toLowerCase()};if(t.id&&(e.id=t.id),t.className){const i=t.className.split(" ").filter((t=>t.length>0));i.length>0&&(e.classes=i)}if(t.textContent){const i=t.textContent.slice(0,50);i&&(e.text=i)}const i=t.href;return i&&(e.href=i),e}isNavigationClick(t){return"A"===t.tagName||null!==t.closest("a")||"link"===t.getAttribute("role")||t.hasAttribute("onclick")}isInteractiveElement(t){return["button","input","select","textarea","a"].includes(t.tagName.toLowerCase())||t.hasAttribute("tabindex")||"button"===t.getAttribute("role")||t.hasAttribute("onclick")}isFormField(t){return["input","textarea","select"].includes(t.tagName.toLowerCase())}getFormSelector(t){const e=t.closest("form");return e?this.getElementSelector(e):"no-form"}start(t){t&&(this.config={...this.config,...t}),this.isActive=!0,console.log("ðŸ” InteractionCollector started")}stop(){this.isActive=!1,this.flushEvents(),console.log("ðŸ” InteractionCollector stopped")}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getStats(){return{bufferSize:this.eventBuffer.length,lastFlushTime:this.lastFlushTime,eventCounts:Object.fromEntries(this.eventCounts),isActive:this.isActive}}}class o{analyze(){return{wordCount:1e3,imageCount:10,videoCount:2,linkCount:20,estimatedReadingTime:5}}extractMainContent(){return{}}categorizeContent(){return"article"}}class r extends EventTarget{constructor(t){super(),this.isActive=!1,this.startTime=0,this.lastScrollPosition=0,this.lastScrollTime=0,this.scrollHistory=[],this.scrollSessions=[],this.totalScrollDistance=0,this.maxScrollDepth=0,this.pauseStartTime=0,this.pauseCount=0,this.backtrackCount=0,this.isScrolling=!1,this.isPaused=!1,this.pauseThreshold=1e3,this.velocityHistory=[],this.lastDirection="down",this.readingSegments=[],this.averageReadingSpeed=200,this.currentReadingStart=0,this.pageAnalysis=null,this.messageBus=t||null,this.setupEventListeners(),this.analyzePage()}setupEventListeners(){let t;window.addEventListener("scroll",(()=>{this.isActive&&(this.handleScroll(),clearTimeout(t),t=window.setTimeout((()=>{this.handleScrollPause()}),this.pauseThreshold))}),{passive:!0}),window.addEventListener("load",(()=>this.analyzePage())),window.addEventListener("resize",(()=>this.analyzePage()))}analyzePage(){const t=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),e=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6, article, section"),i=Array.from(e).reduce(((t,e)=>t+(e.textContent?.length||0)),0)/t,s=document.querySelectorAll("img").length,n=document.querySelectorAll("a").length,a=this.analyzeContentSections();this.pageAnalysis={height:t,textDensity:i,imageCount:s,linkCount:n,contentSections:a}}analyzeContentSections(){const t=[],e=document.querySelectorAll("article, main, section, .content, .post, .article");for(const i of Array.from(e)){const e=i.getBoundingClientRect(),s=e.top+window.scrollY,n=s+e.height,a=i.textContent||"",o=i.querySelectorAll("img").length,r=i.querySelectorAll("a").length;let l="text";o>a.length/500?l="media":r>a.length/200?l="navigation":a.length>1e3&&(l="article"),t.push({start:s,end:n,type:l})}return t.sort(((t,e)=>t.start-e.start))}handleScroll(){const t=window.scrollY,e=Date.now();this.isScrolling||this.handleScrollStart(t,e);const i=e-this.lastScrollTime,s=Math.abs(t-this.lastScrollPosition),n=i>0?s/i:0,a=t>this.lastScrollPosition?"down":"up";a!==this.lastDirection&&s>100&&(this.backtrackCount++,this.emitScrollEvent({type:"backtrack",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()})),s>window.innerHeight&&i<100&&this.emitScrollEvent({type:"jump",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()}),this.updateScrollData(t,e,n,a),this.getScrollPercentage()>.8&&this.maxScrollDepth<.8&&this.emitScrollEvent({type:"deep_scroll",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()}),this.lastScrollPosition=t,this.lastScrollTime=e,this.lastDirection=a,this.isPaused=!1}handleScrollStart(t,e){this.isScrolling=!0,this.currentReadingStart=e,this.emitScrollEvent({type:"scroll_start",timestamp:e,position:t,velocity:0,direction:"down",metrics:this.calculateMetrics()})}handleScrollPause(){this.isScrolling&&!this.isPaused&&(this.isPaused=!0,this.pauseCount++,this.pauseStartTime=Date.now(),this.analyzeReadingSegment(),this.emitScrollEvent({type:"scroll_pause",timestamp:this.pauseStartTime,position:this.lastScrollPosition,velocity:0,direction:this.lastDirection,metrics:this.calculateMetrics()}))}handleScrollResume(){this.isPaused=!1,this.emitScrollEvent({type:"scroll_resume",timestamp:Date.now(),position:window.scrollY,velocity:0,direction:"down",metrics:this.calculateMetrics()})}updateScrollData(t,e,i,s){const n=Math.abs(t-this.lastScrollPosition);this.totalScrollDistance+=n;const a=this.getScrollPercentage();this.maxScrollDepth=Math.max(this.maxScrollDepth,a),this.scrollHistory.push({position:t,timestamp:e,velocity:1e3*i}),this.scrollHistory.length>100&&(this.scrollHistory=this.scrollHistory.slice(-100)),this.velocityHistory.push(1e3*i),this.velocityHistory.length>20&&(this.velocityHistory=this.velocityHistory.slice(-20))}analyzeReadingSegment(){if(this.currentReadingStart>0){const t=Date.now()-this.currentReadingStart,e=this.getPositionAtTime(this.currentReadingStart),i=this.lastScrollPosition;if(t>2e3&&Math.abs(i-e)<window.innerHeight){this.readingSegments.push({start:e,end:i,duration:t});const s=this.getTextInRange(e,i);if(s.length>100){const e=s.split(/\s+/).length/(t/6e4);e>50&&e<800&&(this.averageReadingSpeed=(this.averageReadingSpeed+e)/2)}}this.currentReadingStart=0}}getPositionAtTime(t){const e=this.scrollHistory.find((e=>Math.abs(e.timestamp-t)<1e3));return e?e.position:this.lastScrollPosition}getTextInRange(t,e){const i=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6");let s="";for(const n of Array.from(i)){const i=n.getBoundingClientRect().top+window.scrollY;i>=t&&i<=e&&(s+=n.textContent+" ")}return s.trim()}getScrollPercentage(){if(!this.pageAnalysis)return 0;const t=this.pageAnalysis.height-window.innerHeight;return t>0?Math.min(1,this.lastScrollPosition/t):0}calculateMetrics(){const t=this.velocityHistory.length>0?this.velocityHistory.reduce(((t,e)=>t+e),0)/this.velocityHistory.length:0,e=this.readingSegments.reduce(((t,e)=>t+e.duration),0),i=this.calculateEngagementScore(),s=this.determineScrollPattern();return{totalDistance:this.totalScrollDistance,maxDepth:this.maxScrollDepth,currentDepth:this.getScrollPercentage(),pageHeight:this.pageAnalysis?.height||0,scrollVelocity:t,pauseCount:this.pauseCount,backtrackCount:this.backtrackCount,readingTime:e,engagementScore:i,scrollPattern:s}}calculateEngagementScore(){let t=.5;this.maxScrollDepth>.7&&(t+=.2),this.pauseCount>3&&(t+=.1),this.readingSegments.length>2&&(t+=.15),this.backtrackCount>5&&(t-=.1),this.velocityHistory.reduce(((t,e)=>t+e),0)/this.velocityHistory.length>2e3&&(t-=.15);const e=Date.now()-this.startTime;return t+=this.readingSegments.reduce(((t,e)=>t+e.duration),0)/e*.2,Math.max(0,Math.min(1,t))}determineScrollPattern(){const t=this.velocityHistory.reduce(((t,e)=>t+e),0)/this.velocityHistory.length;if(this.readingSegments.length>2&&t<500)return"reading";if(t>2e3&&this.pauseCount<3)return"scanning";if(this.backtrackCount>this.pauseCount)return"searching";if(this.scrollHistory.length>10){const t=this.scrollHistory.slice(-10).map((t=>t.position));if(this.isLinearProgression(t))return"linear"}return"jumped"}isLinearProgression(t){if(t.length<3)return!1;let e=0;for(let i=1;i<t.length;i++)t[i]>t[i-1]&&e++;return e/(t.length-1)>.7}emitScrollEvent(t){this.dispatchEvent(new CustomEvent("scroll_event",{detail:t})),this.messageBus&&this.messageBus.sendToBackground({type:"SCROLL_EVENT",payload:t})}start(){this.isActive=!0,this.startTime=Date.now(),this.lastScrollPosition=window.scrollY,this.lastScrollTime=Date.now(),console.log("ðŸ“œ ScrollTracker started")}stop(){this.isActive=!1,this.isScrolling&&this.emitScrollEvent({type:"scroll_end",timestamp:Date.now(),position:this.lastScrollPosition,velocity:0,direction:this.lastDirection,metrics:this.calculateMetrics()}),console.log("ðŸ“œ ScrollTracker stopped")}getMetrics(){return this.calculateMetrics()}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getReadingAnalysis(){return{segments:this.readingSegments,averageReadingSpeed:this.averageReadingSpeed,totalReadingTime:this.readingSegments.reduce(((t,e)=>t+e.duration),0),readingEfficiency:this.calculateEngagementScore()}}getScrollPattern(){return{pattern:this.determineScrollPattern(),metrics:this.calculateMetrics(),history:this.scrollHistory.slice(-20),pageAnalysis:this.pageAnalysis}}}class l extends EventTarget{constructor(t){super(),this.isActive=!1,this.startTime=0,this.lastActivity=Date.now(),this.windowFocusStart=Date.now(),this.totalFocusTime=0,this.tabSwitchCount=0,this.scrollStartTime=0,this.scrollDistance=0,this.lastScrollPosition=0,this.currentElement=null,this.elementDwellStart=0,this.focusHistory=[],this.attentionScore=.5,this.idleThreshold=3e4,this.deepFocusThreshold=12e4,this.isIdle=!1,this.isDeepFocus=!1,this.textAnalysisBuffer=[],this.averageReadingSpeed=200,this.readingSpeedHistory=[],this.messageBus=t||null,this.setupEventListeners()}setupEventListeners(){window.addEventListener("focus",this.handleWindowFocus.bind(this)),window.addEventListener("blur",this.handleWindowBlur.bind(this)),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),document.addEventListener("mousemove",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("keydown",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),document.addEventListener("click",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("selectionchange",this.handleSelection.bind(this)),this.setupIntersectionObserver(),setInterval((()=>this.analyzeAttention()),5e3),setInterval((()=>this.checkIdle()),1e3)}setupIntersectionObserver(){const t=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&this.trackElementFocus(t.target)}))}),{threshold:[.5],rootMargin:"0px 0px -50% 0px"});document.querySelectorAll("p, h1, h2, h3, h4, h5, h6, article, section").forEach((e=>t.observe(e)))}trackElementFocus(t){if(this.currentElement!==t){if(this.currentElement&&this.elementDwellStart>0){const t=Date.now()-this.elementDwellStart;this.analyzeElementDwell(this.currentElement,t)}this.currentElement=t,this.elementDwellStart=Date.now(),this.analyzeReadingContent(t)}}analyzeElementDwell(t,e){const i=(t.textContent||"").split(/\s+/).length;if(i>10&&e>1e3){const t=i/(e/6e4);this.readingSpeedHistory.push(t),this.readingSpeedHistory.length>10&&(this.readingSpeedHistory=this.readingSpeedHistory.slice(-10)),this.averageReadingSpeed=this.readingSpeedHistory.reduce(((t,e)=>t+e),0)/this.readingSpeedHistory.length}}analyzeReadingContent(t){const e=t.textContent||"",i=t.getBoundingClientRect().top+window.scrollY;this.textAnalysisBuffer.push({text:e.slice(0,100),timestamp:Date.now(),position:i}),this.textAnalysisBuffer.length>20&&(this.textAnalysisBuffer=this.textAnalysisBuffer.slice(-20))}handleWindowFocus(){this.windowFocusStart=Date.now(),this.lastActivity=Date.now(),this.emitAttentionEvent({type:"focus_change",timestamp:Date.now(),metrics:{focusLevel:1},context:this.getCurrentContext()})}handleWindowBlur(){const t=Date.now()-this.windowFocusStart;this.totalFocusTime+=t,this.tabSwitchCount++,this.emitAttentionEvent({type:"focus_change",timestamp:Date.now(),metrics:{focusLevel:0,windowFocusTime:this.totalFocusTime,tabSwitches:this.tabSwitchCount},context:this.getCurrentContext()})}handleVisibilityChange(){const t=!document.hidden;this.emitAttentionEvent({type:"visibility_change",timestamp:Date.now(),metrics:{focusLevel:t?1:0},context:this.getCurrentContext()}),t&&this.handleActivity()}handleActivity(){const t=Date.now(),e=t-this.lastActivity;this.isIdle&&(this.isIdle=!1,this.emitAttentionEvent({type:"idle_end",timestamp:t,metrics:{idleTime:e,focusLevel:.7},context:this.getCurrentContext()})),this.lastActivity=t,this.updateFocusLevel(e)}handleScroll(){const t=window.scrollY,e=Math.abs(t-this.lastScrollPosition),i=Date.now();0===this.scrollStartTime&&(this.scrollStartTime=i),this.scrollDistance+=e,this.lastScrollPosition=t;const s=i-this.scrollStartTime;this.scrollDistance,s>500&&(this.scrollStartTime=i,this.scrollDistance=e),this.handleActivity()}handleSelection(){const t=window.getSelection();if(t&&t.toString().length>10){const e=t.toString().split(/\s+/).length;this.emitAttentionEvent({type:"reading_flow",timestamp:Date.now(),metrics:{readingSpeed:e,focusLevel:.8},context:this.getCurrentContext()})}}updateFocusLevel(t){let e=1;t>5e3&&(e=Math.max(.3,1-t/3e4)),this.focusHistory.push(e),this.focusHistory.length>20&&(this.focusHistory=this.focusHistory.slice(-20)),this.attentionScore=this.focusHistory.reduce(((t,e)=>t+e),0)/this.focusHistory.length}checkIdle(){const t=Date.now(),e=t-this.lastActivity;!this.isIdle&&e>this.idleThreshold&&(this.isIdle=!0,this.emitAttentionEvent({type:"idle_start",timestamp:t,metrics:{idleTime:e,focusLevel:.1},context:this.getCurrentContext()}));const i=t-this.windowFocusStart;!this.isDeepFocus&&!this.isIdle&&i>this.deepFocusThreshold&&this.attentionScore>.7&&(this.isDeepFocus=!0,this.emitAttentionEvent({type:"deep_focus",timestamp:t,metrics:{focusLevel:.9,windowFocusTime:i,engagementPattern:"deep"},context:this.getCurrentContext()}))}analyzeAttention(){if(!this.isActive)return;const t=Date.now(),e=this.calculateMetrics(),i=this.determineEngagementPattern(e);e.engagementPattern=i,this.emitAttentionEvent({type:"distracted"===i?"distraction":"focus_change",timestamp:t,metrics:e,context:this.getCurrentContext()})}calculateMetrics(){const t=Date.now(),e=t-this.startTime,i=t-this.windowFocusStart,s=t-this.lastActivity,n=this.scrollDistance/Math.max(1,(t-this.scrollStartTime)/1e3),a=Math.max(0,1-this.tabSwitchCount/Math.max(1,e/6e4));return{focusLevel:this.attentionScore,readingSpeed:this.averageReadingSpeed,scrollVelocity:n||0,dwellTime:this.currentElement?t-this.elementDwellStart:0,tabSwitches:this.tabSwitchCount,windowFocusTime:this.totalFocusTime+i,idleTime:s,multitaskingScore:a,engagementPattern:"focused"}}determineEngagementPattern(t){return t.idleTime>this.idleThreshold?"idle":t.focusLevel<.3||t.tabSwitches>5?"distracted":t.scrollVelocity>1e3&&t.dwellTime<2e3?"scanning":t.focusLevel>.8&&t.windowFocusTime>this.deepFocusThreshold?"deep":"focused"}getCurrentContext(){const t=this.getVisibleText(),e={url:window.location.href,title:document.title,visibleText:t,scrollPosition:window.scrollY},i=document.activeElement;if(i)if(e.elementInFocus=i.tagName.toLowerCase(),i.id)e.elementInFocus+=`#${i.id}`;else if(i.className){const t=i.className.split(" ").filter((t=>t.length>0));t.length>0&&(e.elementInFocus+=`.${t.slice(0,2).join(".")}`)}return e}getVisibleText(){const t=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6");let e="";for(const i of Array.from(t)){const t=i.getBoundingClientRect();if(t.top>=0&&t.top<=window.innerHeight&&(e+=i.textContent+" ",e.length>500))break}return e.trim()}getElementSelector(t){return t.tagName.toLowerCase()+(t.id?"#"+t.id:"")+(t.className?"."+t.className.split(" ").join("."):"")}emitAttentionEvent(t){this.dispatchEvent(new CustomEvent("attention",{detail:t})),this.messageBus&&this.messageBus.sendToBackground({type:"ATTENTION_EVENT",payload:t})}start(){this.isActive=!0,this.startTime=Date.now(),this.windowFocusStart=Date.now(),this.lastActivity=Date.now(),console.log("ðŸ‘ï¸ AttentionMonitor started")}stop(){this.isActive=!1,console.log("ðŸ‘ï¸ AttentionMonitor stopped")}getMetrics(){return this.calculateMetrics()}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getStats(){return{isActive:this.isActive,attentionScore:this.attentionScore,totalFocusTime:this.totalFocusTime,tabSwitches:this.tabSwitchCount,averageReadingSpeed:this.averageReadingSpeed,isIdle:this.isIdle,isDeepFocus:this.isDeepFocus}}}class c{constructor(){this.pageData={startTime:Date.now(),url:window.location.href,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},this.latestLCP=0,console.log("ðŸ” SYMBIONT Content Script initializing..."),this.messageBus=new s("content"),this.navigationObserver=new n(this.messageBus),this.interactionCollector=new a(this.messageBus),this.domAnalyzer=new o,this.scrollTracker=new r(this.messageBus),this.attentionMonitor=new l(this.messageBus),this.initialize()}static getInstance(){return c.instance||(c.instance=new c),c.instance}initialize(){this.setupObservers(),this.setupEventListeners(),this.performInitialAnalysis(),window.addEventListener("beforeunload",this.cleanup.bind(this)),console.log("âœ… SYMBIONT Content Script ready")}setupObservers(){this.navigationObserver.observe((t=>{this.handleNavigationChange(t)})),this.interactionCollector.start({clicks:!0,keypresses:!0,forms:!0,media:!0}),this.interactionCollector.on("interaction",(t=>{this.handleInteraction(t)})),this.scrollTracker.on("scroll",(t=>{this.updateScrollData(t)})),this.attentionMonitor.on("attentionChange",(t=>{this.handleAttentionChange(t)}))}setupEventListeners(){document.addEventListener("visibilitychange",(()=>{this.handleVisibilityChange()})),window.addEventListener("focus",(()=>this.handleWindowFocus(!0))),window.addEventListener("blur",(()=>this.handleWindowFocus(!1))),"PerformanceObserver"in window&&this.setupPerformanceObserver(),chrome.runtime.onMessage.addListener(((t,e,i)=>(this.messageBus.emit(t.type,{message:t,sender:e,sendResponse:i}),!0)))}setupPerformanceObserver(){new PerformanceObserver((t=>{for(const e of t.getEntries())"largest-contentful-paint"===e.entryType&&(this.latestLCP=e.startTime,this.handleLCP(e))})).observe({entryTypes:["largest-contentful-paint"]})}async performInitialAnalysis(){const t=await this.domAnalyzer.analyze();this.analyzeMainContent();const e=this.domAnalyzer.categorizeContent();this.messageBus.sendToBackground({type:"PAGE_ANALYSIS_COMPLETE",payload:{url:this.pageData.url,title:this.pageData.title,category:e,contentMetrics:{wordCount:t.wordCount,imageCount:t.imageCount,videoCount:t.videoCount,linkCount:t.linkCount,readingTime:t.estimatedReadingTime},performance:{loadTime:performance.now(),resourceCount:performance.getEntriesByType("resource").length}}})}analyzeMainContent(){this.domAnalyzer.extractMainContent()}handleInteraction(t){const e={...t,pageContext:{url:this.pageData.url,title:this.pageData.title,timeOnPage:Date.now()-this.pageData.startTime}};this.pageData.interactions.push(e),this.isSignificantInteraction(t)&&this.messageBus.sendToBackground({type:"INTERACTION_DETECTED",payload:e})}isSignificantInteraction(t){return"form_submit"===t.type||"video_play"===t.type||"click"===t.type&&t.data.isNavigation||"keypress"===t.type&&t.data.isShortcut}updateScrollData(t){this.pageData.scrollData.maxDepth=Math.max(this.pageData.scrollData.maxDepth,t.depth),this.pageData.scrollData.totalDistance+=Math.abs(t.delta),this.pageData.scrollData.pattern=this.scrollTracker.getScrollPattern()}handleAttentionChange(t){t.isActive?this.pageData.attention.totalActiveTime+=t.duration||0:this.pageData.attention.distractions++,this.messageBus.sendToBackground({type:"ATTENTION_UPDATE",payload:{url:this.pageData.url,state:t,duration:Date.now()-this.pageData.startTime}})}handleNavigationChange(t){this.finalizePage(),this.latestLCP=0,this.pageData={startTime:Date.now(),url:t.url,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},this.performInitialAnalysis()}handleVisibilityChange(){const t="visible"===document.visibilityState;this.messageBus.sendToBackground({type:"VISIBILITY_CHANGE",payload:{url:this.pageData.url,isVisible:t,timestamp:Date.now()}}),t?this.attentionMonitor.start():this.attentionMonitor.stop()}handleWindowFocus(t){this.messageBus.sendToBackground({type:"FOCUS_CHANGE",payload:{url:this.pageData.url,hasFocus:t,timestamp:Date.now()}})}finalizePage(){const t=Date.now()-this.pageData.startTime;if(t<1e3)return;const e={url:this.pageData.url,title:this.pageData.title,startTime:this.pageData.startTime,duration:t,interactions:this.pageData.interactions,scrollData:this.pageData.scrollData,attention:{totalActiveTime:this.pageData.attention.totalActiveTime,distractionCount:this.pageData.attention.distractions,focusPeriods:this.attentionMonitor.getStats().focusPeriods||[]},performance:this.collectPerformanceMetrics()};this.latestLCP=0,this.messageBus.sendToBackground({type:"PAGE_SESSION_COMPLETE",payload:e})}collectPerformanceMetrics(){const t=performance.getEntriesByType("navigation"),e=t.length>0?t[0]:null;return{loadTime:e?e.loadEventEnd-e.startTime:0,domContentLoaded:e?e.domContentLoadedEventEnd-e.startTime:0,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint(),largestContentfulPaint:this.latestLCP,resourceCount:performance.getEntriesByType("resource").length}}getFirstPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-paint"===t.name));return t?t.startTime:0}getFirstContentfulPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-contentful-paint"===t.name));return t?t.startTime:0}handleLCP(t){t.startTime>2500&&console.debug("Slow LCP detected:",t.startTime)}cleanup(){this.finalizePage(),this.navigationObserver.disconnect(),this.interactionCollector.stop(),this.scrollTracker.stop(),this.attentionMonitor.stop(),console.log("ðŸ§¹ SYMBIONT Content Script cleaned up")}}window.__SYMBIONT_CONTENT_SCRIPT_LOADED__||(window.__SYMBIONT_CONTENT_SCRIPT_LOADED__=!0,c.getInstance())})();