(()=>{"use strict";var t,e;!function(t){t.PAGE_VISIT="PAGE_VISIT",t.SCROLL_EVENT="SCROLL_EVENT",t.ORGANISM_UPDATE="ORGANISM_UPDATE",t.ORGANISM_MUTATE="ORGANISM_MUTATE",t.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",t.WEBGL_INIT="WEBGL_INIT",t.WEBGL_ERROR="WEBGL_ERROR",t.WEBGL_INITIALIZED="WEBGL_INITIALIZED",t.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",t.GENERATE_INVITATION="GENERATE_INVITATION",t.INVITATION_GENERATED="INVITATION_GENERATED",t.CONSUME_INVITATION="CONSUME_INVITATION",t.INVITATION_CONSUMED="INVITATION_CONSUMED",t.CHECK_INVITATION="CHECK_INVITATION",t.INVITATION_CHECKED="INVITATION_CHECKED",t.MURMUR="MURMUR",t.GET_INVITER="GET_INVITER",t.INVITER_RESULT="INVITER_RESULT",t.GET_INVITEES="GET_INVITEES",t.INVITEES_RESULT="INVITEES_RESULT",t.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",t.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",t.INTERACTION_DETECTED="INTERACTION_DETECTED",t.GET_HEALTH_METRICS="GET_HEALTH_METRICS",t.HEALTH_METRICS_RESPONSE="HEALTH_METRICS_RESPONSE",t.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",t.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",t.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",t.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",t.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",t.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",t.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",t.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",t.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED",t.GET_ORGANISM="GET_ORGANISM"}(t||(t={})),function(t){t[t.TRACE=0]="TRACE",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.FATAL=5]="FATAL"}(e||(e={}));class i{constructor(t={}){this.logEntries=[],this.config={level:e.INFO,enableConsole:!this.isProduction(),enableStorage:!0,maxStorageEntries:1e3,sensitiveFields:["password","token","key","secret","auth"],productionMode:this.isProduction(),...t}}static getInstance(t){return i.instance||(i.instance=new i(t)),i.instance}isProduction(){return!0}sanitizeData(t){if("string"==typeof t)return this.sanitizeString(t);if("object"==typeof t&&null!==t){if(Array.isArray(t))return t.map((t=>this.sanitizeData(t)));const e={};for(const[i,s]of Object.entries(t))this.isSensitiveField(i)?e[i]="[REDACTED]":e[i]=this.sanitizeData(s);return e}return t}sanitizeString(t){let e=t;for(const t of i.SENSITIVE_PATTERNS)e=e.replace(t,"[REDACTED]");return e}isSensitiveField(t){return this.config.sensitiveFields.some((e=>t.toLowerCase().includes(e.toLowerCase())))}formatMessage(t,i,s,n){return`[${(new Date).toISOString()}] ${e[t]}${n?` [${n}]`:""}: ${i}${s?` ${JSON.stringify(s,null,2)}`:""}`}shouldLog(t){return t>=this.config.level}log(t,i,s,n){if(!this.shouldLog(t))return;const a=s?this.sanitizeData(s):void 0,o=this.sanitizeString(i),r={timestamp:Date.now(),level:t,message:o,data:a,context:n,sanitized:!0};if(this.config.enableStorage&&(this.logEntries.push(r),this.logEntries.length>this.config.maxStorageEntries&&(this.logEntries=this.logEntries.slice(-this.config.maxStorageEntries))),this.config.enableConsole){const i=this.formatMessage(t,o,a,n);switch(t){case e.TRACE:case e.DEBUG:console.debug(i);break;case e.INFO:console.info(i);break;case e.WARN:console.warn(i);break;case e.ERROR:case e.FATAL:console.error(i)}}}trace(t,i,s){this.log(e.TRACE,t,i,s)}debug(t,i,s){this.log(e.DEBUG,t,i,s)}info(t,i,s){this.log(e.INFO,t,i,s)}warn(t,i,s){this.log(e.WARN,t,i,s)}error(t,i,s){this.log(e.ERROR,t,i,s)}fatal(t,i,s){this.log(e.FATAL,t,i,s)}setLevel(t){this.config.level=t}enableConsole(t){this.config.enableConsole=t}getLogs(t){return void 0!==t?this.logEntries.filter((e=>e.level>=t)):[...this.logEntries]}clearLogs(){this.logEntries=[]}exportLogs(){return JSON.stringify(this.logEntries,null,2)}}i.SENSITIVE_PATTERNS=[/password/i,/token/i,/key/i,/secret/i,/auth/i,/credential/i,/session/i,/cookie/i,/jwt/i,/bearer/i,/api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/private[_-]?key/i,/\b[A-Za-z0-9+/]{32,}={0,2}\b/,/\b[0-9a-f]{32,}\b/i,/\b[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}\b/,/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/];const s=i.getInstance();s.info.bind(s),s.warn.bind(s),s.error.bind(s),s.debug.bind(s);class n{static random(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint32Array(1);return crypto.getRandomValues(t),t[0]/(this.MAX_UINT32+1)}const t=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random numbers.");throw s.error("SecureRandom: CRITICAL SECURITY FAILURE",t),t}static randomInt(t,e){if(t>=e)throw new Error("SecureRandom: min doit Ãªtre infÃ©rieur Ã  max");const i=e-t;return Math.floor(this.random()*i)+t}static randomFloat(t,e){if(t>=e)throw new Error("SecureRandom: min doit Ãªtre infÃ©rieur Ã  max");return this.random()*(e-t)+t}static randomBytes(t){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(t);return crypto.getRandomValues(e),e}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random bytes.");throw s.error("SecureRandom: CRITICAL SECURITY FAILURE in randomBytes",e),e}static choice(t){if(0===t.length)throw new Error("SecureRandom: Le tableau ne peut pas Ãªtre vide");return t[this.randomInt(0,t.length)]}static uuid(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;const e=Array.from(t,(t=>t.toString(16).padStart(2,"0"))).join("");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20,32)].join("-")}const t=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure UUID.");throw s.error("SecureRandom: CRITICAL SECURITY FAILURE in uuid",t),t}static randomString(t,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let i="";for(let s=0;s<t;s++)i+=e.charAt(this.randomInt(0,e.length));return i}static randomId(t="",e=8){const i=this.randomString(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return t?`${t}_${i}`:i}}function a(){if("undefined"!=typeof crypto&&crypto.randomUUID)try{return crypto.randomUUID()}catch(t){s.warn("crypto.randomUUID failed, using fallback",{error:t})}return n.uuid()}function o(t){return t&&"object"==typeof t?r(t):t}function r(t,e=new WeakSet){if(null==t)return t;if("function"==typeof t)return"[Function]";if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if(t instanceof WebGLRenderingContext||t instanceof WebGL2RenderingContext||t instanceof HTMLElement||t instanceof HTMLCanvasElement||t instanceof CanvasRenderingContext2D||t instanceof WebGLProgram||t instanceof WebGLBuffer||t instanceof WebGLTexture||t&&t.$$typeof||t&&t.__reactFiber||t&&t._owner||t&&"object"==typeof t&&t.constructor&&t.constructor.name&&t.constructor.name.includes("Fiber"))return t instanceof HTMLCanvasElement?{tagName:"CANVAS",width:t.width,height:t.height,className:t.className,id:t.id}:"[Non-serializable Object]";if("object"!=typeof t)return t;if(e.has(t))return"[Circular Reference]";if(e.add(t),Array.isArray(t))return t.map((t=>r(t,e)));const i={};for(const s in t)if(t.hasOwnProperty(s))try{i[s]=r(t[s],e)}catch(t){i[s]="[Non-serializable]"}return i}function c(t){return"object"==typeof t&&null!==t&&"code"in t&&"string"==typeof t.code&&"status"in t&&"string"==typeof t.status}function h(t){try{return JSON.parse(JSON.stringify(t))}catch(e){return s.warn("Message serialization issue, cleaning object:",e),l(t)}}function l(t,e=new WeakSet){if(null==t)return t;if("function"==typeof t)return"[Function]";if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if(t instanceof WebGLRenderingContext||t instanceof WebGL2RenderingContext||t instanceof HTMLElement||t instanceof HTMLCanvasElement||t instanceof CanvasRenderingContext2D||t instanceof WebGLProgram||t instanceof WebGLBuffer||t instanceof WebGLTexture||t&&t.$$typeof||t&&t.__reactFiber||t&&t._owner||t&&"object"==typeof t&&t.constructor&&t.constructor.name&&t.constructor.name.includes("Fiber"))return"[Non-serializable Object]";if("object"!=typeof t)return t;if(e.has(t))return"[Circular Reference]";if(e.add(t),Array.isArray(t))return t.map((t=>l(t,e)));const i={};for(const s in t)if(t.hasOwnProperty(s))try{i[s]=l(t[s],e)}catch(t){i[s]="[Non-serializable]"}return i}n.MAX_UINT32=4294967295,n.random,n.randomInt,n.randomFloat;class m{constructor(t){this.source=t,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){"undefined"!=typeof chrome&&chrome.runtime?chrome.runtime.onMessage.addListener(((t,e,i)=>(this.shouldProcessMessage(t)&&(this.enqueueMessage(t),i({received:!0})),!1))):s.warn("[MessageBus] Chrome runtime non disponible - mode test/dÃ©veloppement")}shouldProcessMessage(t){return this.filters.every((e=>e(t)))}async enqueueMessage(t){if(this.messageQueue.push(t),!this.processing){this.processing=!0;try{await this.processQueue()}finally{this.processing=!1}}}async processQueue(){for(;this.messageQueue.length>0;){const t=this.messageQueue.shift();await this.processMessage(t)}}async processMessage(e){if(!function(e,i){switch(e){case t.ORGANISM_UPDATE:return"object"==typeof(s=i)&&null!==s&&"id"in s&&"string"==typeof s.id&&"generation"in s&&"number"==typeof s.generation&&"health"in s&&"number"==typeof s.health&&"energy"in s&&"number"==typeof s.energy&&"traits"in s&&"object"==typeof s.traits;case t.ORGANISM_MUTATE:return function(t){return"object"==typeof t&&null!==t&&"type"in t&&"string"==typeof t.type&&"trigger"in t&&"string"==typeof t.trigger}(i);case t.PAGE_VISIT:case t.SCROLL_EVENT:return function(t){return t&&"string"==typeof t.url&&"number"==typeof t.visitCount}(i);case t.MURMUR:return function(t){return"object"==typeof t&&null!==t&&"text"in t&&"string"==typeof t.text&&"timestamp"in t&&"number"==typeof t.timestamp}(i);case t.GENERATE_INVITATION:case t.CONSUME_INVITATION:case t.CHECK_INVITATION:return function(t){return"object"==typeof t&&null!==t&&"code"in t&&"string"==typeof t.code}(i);case t.INVITATION_GENERATED:return"string"==typeof i||c(i);case t.INVITATION_CONSUMED:case t.INVITATION_CHECKED:return c(i);case t.SHARED_MUTATION_RESULT:return"string"==typeof i||i&&"object"==typeof i;default:return!0}var s}(e.type,e.payload))return void s.warn(`[MessageBus] Payload non valide pour le type ${e.type}`,e.payload);for(const t of this.globalHandlers)try{await t(e)}catch(t){s.error("Error in global handler:",t)}const i=this.handlers.get(e.type);if(i)for(const t of i)try{await t(e)}catch(t){s.error(`Error in handler for ${e.type}:`,t)}}on(t,e){this.handlers.has(t)||this.handlers.set(t,new Set),this.handlers.get(t).add(e)}off(t,e){const i=this.handlers.get(t);i&&i.delete(e)}onAny(t){this.globalHandlers.add(t)}offAny(t){this.globalHandlers.delete(t)}addFilter(t){this.filters.push(t)}async send(t){const e={...t,source:this.source,timestamp:Date.now(),id:a()};if("undefined"!=typeof chrome&&chrome.runtime)try{const t=h(o(e));if("content"===this.source)await chrome.runtime.sendMessage(t);else{const e=await chrome.tabs.query({}),i=t=>t.active||t.url&&t.url.includes("symbiont"),s=e.filter(i);for(const e of s)e.id&&chrome.tabs.sendMessage(e.id,t).catch((()=>{}));chrome.runtime.sendMessage(t).catch((()=>{}))}}catch(t){s.error("Error sending message:",t)}else s.warn("[MessageBus] Chrome runtime non disponible - message non envoyÃ©:",e.type)}sendToBackground(t){this.send(t)}emit(t,e){const i=this.handlers.get(t);i&&i.forEach((i=>i({type:t,payload:e})))}handleMessage(t,e){s.info("Handling message:",t)}onMessage(t,e,i){return s.info("Received message:",t),!0}sendToFrame(t,e,i){s.info("Sending to frame:",e,i)}}class d{constructor(t){this._handler=null}observe(t){this._handler=t}disconnect(){this._handler=null}}function u(t){return t&&0!==t.length?t.reduce(((t,e)=>t+e),0)/t.length:0}function g(t){if(!t)return[];if(!(t instanceof Element))return[];if(!t.className||"string"!=typeof t.className)return[];try{return t.className.split(" ").filter((t=>t&&t.length>0))}catch{return[]}}class p extends EventTarget{constructor(t){super(),this.isActive=!1,this.eventBuffer=[],this.lastFlushTime=0,this.eventCounts=new Map,this.lastEventTimes=new Map,this.mousePosition={x:0,y:0},this.lastClickTime=0,this.clickSequence=0,this.keySequence="",this.formInteractions=new Map,this.messageBus=t||null,this.config={clicks:!0,keypresses:!0,forms:!0,media:!0,hover:!0,selection:!0,contextmenu:!0,debounceMs:100,maxEventsPerSecond:20},this.setupEventListeners()}setupEventListeners(){document.addEventListener("mousemove",this.handleMouseMove.bind(this),{passive:!0}),document.addEventListener("mouseenter",this.handleMouseEnter.bind(this),{passive:!0}),document.addEventListener("mouseleave",this.handleMouseLeave.bind(this),{passive:!0}),this.config.clicks&&(document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("dblclick",this.handleDoubleClick.bind(this),!0)),this.config.keypresses&&(document.addEventListener("keydown",this.handleKeyDown.bind(this),!0),document.addEventListener("keyup",this.handleKeyUp.bind(this),!0)),this.config.forms&&(document.addEventListener("submit",this.handleFormSubmit.bind(this),!0),document.addEventListener("focus",this.handleFormFocus.bind(this),!0),document.addEventListener("blur",this.handleFormBlur.bind(this),!0),document.addEventListener("change",this.handleFormChange.bind(this),!0),document.addEventListener("input",this.handleFormInput.bind(this),!0)),this.config.media&&(document.addEventListener("play",this.handleMediaPlay.bind(this),!0),document.addEventListener("pause",this.handleMediaPause.bind(this),!0),document.addEventListener("ended",this.handleMediaEnded.bind(this),!0)),this.config.selection&&(document.addEventListener("selectstart",this.handleSelectionStart.bind(this),!0),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this),!0)),this.config.contextmenu&&document.addEventListener("contextmenu",this.handleContextMenu.bind(this),!0),setInterval((()=>this.flushEvents()),1e3)}handleMouseMove(t){this.mousePosition={x:t.clientX,y:t.clientY}}handleMouseEnter(t){this.config.hover&&this.recordInteraction({type:"hover",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"enter",duration:0},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleMouseLeave(t){this.config.hover&&this.recordInteraction({type:"hover",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"leave",duration:0},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleClick(t){const e=Date.now();e-this.lastClickTime<500?this.clickSequence++:this.clickSequence=1,this.lastClickTime=e;const i=t.target,s=this.isNavigationClick(i),n=this.isInteractiveElement(i);this.recordInteraction({type:"click",timestamp:e,target:this.getElementSelector(i),data:{button:t.button,clickSequence:this.clickSequence,isNavigation:s,isInteractive:n,modifiers:{ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey}},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(i)})}handleDoubleClick(t){this.recordInteraction({type:"click",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{isDoubleClick:!0,button:t.button},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleKeyDown(t){1===t.key.length&&(this.keySequence+=t.key,this.keySequence.length>20&&(this.keySequence=this.keySequence.slice(-20)));const e=t.ctrlKey||t.metaKey||t.altKey,i=["Enter","Tab","Escape","Backspace","Delete"].includes(t.key);(e||i)&&this.recordInteraction({type:"keypress",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{key:t.key,keyCode:t.keyCode,isShortcut:e,isSpecialKey:i,modifiers:{ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey},sequence:this.keySequence.slice(-5)},element:this.extractElementInfo(t.target)})}handleKeyUp(t){"Tab"===t.key&&this.recordInteraction({type:"keypress",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{key:t.key,action:"tab_navigation"},element:this.extractElementInfo(t.target)})}handleFormSubmit(t){const e=t.target,i=new FormData(e),s=this.formInteractions.get(this.getElementSelector(e))||{};this.recordInteraction({type:"form_submit",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:e.action,method:e.method,fieldCount:i.entries?Array.from(i.entries()).length:0,interactionTime:s.interactionTime||0,fieldInteractions:s.fieldInteractions||0},element:this.extractElementInfo(e)})}handleFormFocus(t){const e=t.target;if(this.isFormField(e)){const t=this.getFormSelector(e),i=this.formInteractions.get(t)||{startTime:Date.now(),fieldInteractions:0,interactionTime:0};i.fieldInteractions++,this.formInteractions.set(t,i),this.recordInteraction({type:"form_focus",timestamp:Date.now(),target:this.getElementSelector(e),data:{fieldType:e.type||(e.tagName||"unknown").toLowerCase(),fieldName:e.name||e.id,formSelector:t},element:this.extractElementInfo(e)})}}handleFormBlur(t){const e=t.target;if(this.isFormField(e)){const t=this.getFormSelector(e),i=this.formInteractions.get(t);i&&(i.interactionTime=Date.now()-i.startTime,this.formInteractions.set(t,i))}}handleFormChange(t){const e=t.target;this.isFormField(e)&&this.recordInteraction({type:"form_focus",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:"change",fieldType:e.type||(e.tagName||"unknown").toLowerCase(),hasValue:!!e.value},element:this.extractElementInfo(e)})}handleFormInput(t){const e=t.target,i=this.getElementSelector(e),s=this.lastEventTimes.get(i)||0,n=Date.now();n-s>this.config.debounceMs&&(this.lastEventTimes.set(i,n),this.isFormField(e)&&this.recordInteraction({type:"form_focus",timestamp:n,target:i,data:{action:"input",fieldType:e.type||(e.tagName||"unknown").toLowerCase(),valueLength:e.value?.length||0},element:this.extractElementInfo(e)}))}handleMediaPlay(t){const e=t.target;this.recordInteraction({type:"media_play",timestamp:Date.now(),target:this.getElementSelector(e),data:{mediaType:(e.tagName||"unknown").toLowerCase(),duration:e.duration,currentTime:e.currentTime,src:e.src},element:this.extractElementInfo(e)})}handleMediaPause(t){const e=t.target;this.recordInteraction({type:"media_pause",timestamp:Date.now(),target:this.getElementSelector(e),data:{mediaType:(e.tagName||"unknown").toLowerCase(),duration:e.duration,currentTime:e.currentTime,watchedPercentage:e.duration>0?e.currentTime/e.duration*100:0},element:this.extractElementInfo(e)})}handleMediaEnded(t){const e=t.target;this.recordInteraction({type:"media_pause",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:"ended",mediaType:(e.tagName||"unknown").toLowerCase(),duration:e.duration,completed:!0},element:this.extractElementInfo(e)})}handleSelectionStart(t){this.recordInteraction({type:"selection",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"start"},element:this.extractElementInfo(t.target)})}handleSelectionChange(t){const e=document.getSelection();e&&e.toString().length>0&&this.recordInteraction({type:"selection",timestamp:Date.now(),target:"document",data:{text:e.toString(),length:e.toString().length}})}handleContextMenu(t){this.recordInteraction({type:"contextmenu",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{button:t.button},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}recordInteraction(t){if(!this.isActive)return;const e=t.type,i=Date.now(),s=this.eventCounts.get(e)||0;if(i-(this.lastEventTimes.get(`reset_${e}`)||i)>1e3)this.eventCounts.set(e,1),this.lastEventTimes.set(`reset_${e}`,i);else{if(s>=this.config.maxEventsPerSecond)return;this.eventCounts.set(e,s+1)}this.eventBuffer.push(t),this.dispatchEvent(new CustomEvent("interaction",{detail:t})),this.eventBuffer.length>50&&this.flushEvents()}flushEvents(){if(0===this.eventBuffer.length)return;const t=[...this.eventBuffer];this.eventBuffer=[],this.lastFlushTime=Date.now(),this.messageBus&&this.messageBus.sendToBackground({type:"INTERACTIONS_BATCH",payload:{events:t,timestamp:Date.now(),url:window.location.href}})}getElementSelector(t){if(!t)return"unknown";let e=(t.tagName||"unknown").toLowerCase();if(t.id)e+=`#${t.id}`;else{const i=g(t);i.length>0&&(e+=`.${i.slice(0,3).join(".")}`)}return e}extractElementInfo(t){if(!t)return;const e={tag:(t.tagName||"unknown").toLowerCase()};t.id&&(e.id=t.id);const i=g(t);if(i.length>0&&(e.classes=i),t.textContent){const i=t.textContent.slice(0,50);i&&(e.text=i)}const s=t.href;return s&&(e.href=s),e}isNavigationClick(t){return"A"===t.tagName||null!==t.closest("a")||"link"===t.getAttribute("role")||t.hasAttribute("onclick")}isInteractiveElement(t){return["button","input","select","textarea","a"].includes((t.tagName||"").toLowerCase())||t.hasAttribute("tabindex")||"button"===t.getAttribute("role")||t.hasAttribute("onclick")}isFormField(t){return["input","textarea","select"].includes((t.tagName||"").toLowerCase())}getFormSelector(t){const e=t.closest("form");return e?this.getElementSelector(e):"no-form"}start(t){t&&(this.config={...this.config,...t}),this.isActive=!0,s.info("ðŸ” InteractionCollector started")}stop(){this.isActive=!1,this.flushEvents(),s.info("ðŸ” InteractionCollector stopped")}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getStats(){return{bufferSize:this.eventBuffer.length,lastFlushTime:this.lastFlushTime,eventCounts:Object.fromEntries(this.eventCounts),isActive:this.isActive}}}class y{analyze(){return{wordCount:1e3,imageCount:10,videoCount:2,linkCount:20,estimatedReadingTime:5}}extractMainContent(){return{}}categorizeContent(){return"article"}}class f extends EventTarget{constructor(t){super(),this.isActive=!1,this.startTime=0,this.lastScrollPosition=0,this.lastScrollTime=0,this.scrollHistory=[],this.scrollSessions=[],this.totalScrollDistance=0,this.maxScrollDepth=0,this.pauseStartTime=0,this.pauseCount=0,this.backtrackCount=0,this.isScrolling=!1,this.isPaused=!1,this.pauseThreshold=1e3,this.velocityHistory=[],this.lastDirection="down",this.readingSegments=[],this.averageReadingSpeed=200,this.currentReadingStart=0,this.pageAnalysis=null,this.messageBus=t||null,this.setupEventListeners(),this.analyzePage()}setupEventListeners(){let t;window.addEventListener("scroll",(()=>{this.isActive&&(this.handleScroll(),clearTimeout(t),t=window.setTimeout((()=>{this.handleScrollPause()}),this.pauseThreshold))}),{passive:!0}),window.addEventListener("load",(()=>this.analyzePage())),window.addEventListener("resize",(()=>this.analyzePage()))}analyzePage(){const t=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),e=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6, article, section"),i=Array.from(e).reduce(((t,e)=>t+(e.textContent?.length||0)),0)/t,s=document.querySelectorAll("img").length,n=document.querySelectorAll("a").length,a=this.analyzeContentSections();this.pageAnalysis={height:t,textDensity:i,imageCount:s,linkCount:n,contentSections:a}}analyzeContentSections(){const t=[],e=document.querySelectorAll("article, main, section, .content, .post, .article");for(const i of Array.from(e)){const e=i.getBoundingClientRect(),s=e.top+window.scrollY,n=s+e.height,a=i.textContent||"",o=i.querySelectorAll("img").length,r=i.querySelectorAll("a").length;let c="text";o>a.length/500?c="media":r>a.length/200?c="navigation":a.length>1e3&&(c="article"),t.push({start:s,end:n,type:c})}return t.sort(((t,e)=>t.start-e.start))}handleScroll(){const t=window.scrollY,e=Date.now();this.isScrolling||this.handleScrollStart(t,e);const i=e-this.lastScrollTime,s=Math.abs(t-this.lastScrollPosition),n=i>0?s/i:0,a=t>this.lastScrollPosition?"down":"up";a!==this.lastDirection&&s>100&&(this.backtrackCount++,this.emitScrollEvent({type:"backtrack",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()})),s>window.innerHeight&&i<100&&this.emitScrollEvent({type:"jump",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()}),this.updateScrollData(t,e,n,a),this.getScrollPercentage()>.8&&this.maxScrollDepth<.8&&this.emitScrollEvent({type:"deep_scroll",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()}),this.lastScrollPosition=t,this.lastScrollTime=e,this.lastDirection=a,this.isPaused=!1}handleScrollStart(t,e){this.isScrolling=!0,this.currentReadingStart=e,this.emitScrollEvent({type:"scroll_start",timestamp:e,position:t,velocity:0,direction:"down",metrics:this.calculateMetrics()})}handleScrollPause(){this.isScrolling&&!this.isPaused&&(this.isPaused=!0,this.pauseCount++,this.pauseStartTime=Date.now(),this.analyzeReadingSegment(),this.emitScrollEvent({type:"scroll_pause",timestamp:this.pauseStartTime,position:this.lastScrollPosition,velocity:0,direction:this.lastDirection,metrics:this.calculateMetrics()}))}handleScrollResume(){this.isPaused=!1,this.emitScrollEvent({type:"scroll_resume",timestamp:Date.now(),position:window.scrollY,velocity:0,direction:"down",metrics:this.calculateMetrics()})}updateScrollData(t,e,i,s){const n=Math.abs(t-this.lastScrollPosition);this.totalScrollDistance+=n;const a=this.getScrollPercentage();this.maxScrollDepth=Math.max(this.maxScrollDepth,a),this.scrollHistory.push({position:t,timestamp:e,velocity:1e3*i}),this.scrollHistory.length>100&&(this.scrollHistory=this.scrollHistory.slice(-100)),this.velocityHistory.push(1e3*i),this.velocityHistory.length>20&&(this.velocityHistory=this.velocityHistory.slice(-20))}analyzeReadingSegment(){if(this.currentReadingStart>0){const t=Date.now()-this.currentReadingStart,e=this.getPositionAtTime(this.currentReadingStart),i=this.lastScrollPosition;if(t>2e3&&Math.abs(i-e)<window.innerHeight){this.readingSegments.push({start:e,end:i,duration:t});const s=this.getTextInRange(e,i);if(s.length>100){const e=s.split(/\s+/).length/(t/6e4);e>50&&e<800&&(this.averageReadingSpeed=(this.averageReadingSpeed+e)/2)}}this.currentReadingStart=0}}getPositionAtTime(t){const e=this.scrollHistory.find((e=>Math.abs(e.timestamp-t)<1e3));return e?e.position:this.lastScrollPosition}getTextInRange(t,e){const i=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6");let s="";for(const n of Array.from(i)){const i=n.getBoundingClientRect().top+window.scrollY;i>=t&&i<=e&&(s+=n.textContent+" ")}return s.trim()}getScrollPercentage(){if(!this.pageAnalysis)return 0;const t=this.pageAnalysis.height-window.innerHeight;return t>0?Math.min(1,this.lastScrollPosition/t):0}calculateMetrics(){const t=u(this.velocityHistory),e=this.readingSegments.reduce(((t,e)=>t+e.duration),0),i=this.calculateEngagementScore(),s=this.determineScrollPattern();return{totalDistance:this.totalScrollDistance,maxDepth:this.maxScrollDepth,currentDepth:this.getScrollPercentage(),pageHeight:this.pageAnalysis?.height||0,scrollVelocity:t,pauseCount:this.pauseCount,backtrackCount:this.backtrackCount,readingTime:e,engagementScore:i,scrollPattern:s}}calculateEngagementScore(){let t=.5;this.maxScrollDepth>.7&&(t+=.2),this.pauseCount>3&&(t+=.1),this.readingSegments.length>2&&(t+=.15),this.backtrackCount>5&&(t-=.1),u(this.velocityHistory)>2e3&&(t-=.15);const e=Date.now()-this.startTime;return e>0&&(t+=this.readingSegments.reduce(((t,e)=>t+e.duration),0)/e*.2),Math.max(0,Math.min(1,t))}determineScrollPattern(){if(0===this.velocityHistory.length)return"linear";const t=u(this.velocityHistory);if(this.readingSegments.length>2&&t<500)return"reading";if(t>2e3&&this.pauseCount<3)return"scanning";if(this.backtrackCount>this.pauseCount)return"searching";if(this.scrollHistory.length>10){const t=this.scrollHistory.slice(-10).map((t=>t.position));if(this.isLinearProgression(t))return"linear"}return"jumped"}isLinearProgression(t){if(!t||t.length<3)return!1;let e=0;for(let i=1;i<t.length;i++)t[i]>t[i-1]&&e++;return e/(t.length-1)>.7}emitScrollEvent(t){this.dispatchEvent(new CustomEvent("scroll_event",{detail:t})),this.messageBus&&this.messageBus.sendToBackground({type:"SCROLL_EVENT",payload:t})}start(){this.isActive=!0,this.startTime=Date.now(),this.lastScrollPosition=window.scrollY,this.lastScrollTime=Date.now(),s.info("ðŸ“œ ScrollTracker started")}stop(){this.isActive=!1,this.isScrolling&&this.emitScrollEvent({type:"scroll_end",timestamp:Date.now(),position:this.lastScrollPosition,velocity:0,direction:this.lastDirection,metrics:this.calculateMetrics()}),s.info("ðŸ“œ ScrollTracker stopped")}getMetrics(){return this.calculateMetrics()}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getReadingAnalysis(){return{segments:this.readingSegments,averageReadingSpeed:this.averageReadingSpeed,totalReadingTime:this.readingSegments.reduce(((t,e)=>t+e.duration),0),readingEfficiency:this.calculateEngagementScore()}}getScrollPattern(){return{pattern:this.determineScrollPattern(),metrics:this.calculateMetrics(),history:this.scrollHistory.slice(-20),pageAnalysis:this.pageAnalysis}}}class S extends EventTarget{constructor(t){super(),this.isActive=!1,this.startTime=0,this.lastActivity=Date.now(),this.windowFocusStart=Date.now(),this.totalFocusTime=0,this.tabSwitchCount=0,this.scrollStartTime=0,this.scrollDistance=0,this.lastScrollPosition=0,this.currentElement=null,this.elementDwellStart=0,this.focusHistory=[],this.attentionScore=.5,this.idleThreshold=3e4,this.deepFocusThreshold=12e4,this.isIdle=!1,this.isDeepFocus=!1,this.textAnalysisBuffer=[],this.averageReadingSpeed=200,this.readingSpeedHistory=[],this.messageBus=t||null,this.setupEventListeners()}setupEventListeners(){window.addEventListener("focus",this.handleWindowFocus.bind(this)),window.addEventListener("blur",this.handleWindowBlur.bind(this)),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),document.addEventListener("mousemove",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("keydown",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),document.addEventListener("click",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("selectionchange",this.handleSelection.bind(this)),this.setupIntersectionObserver(),setInterval((()=>this.analyzeAttention()),5e3),setInterval((()=>this.checkIdle()),1e3)}setupIntersectionObserver(){const t=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&this.trackElementFocus(t.target)}))}),{threshold:[.5],rootMargin:"0px 0px -50% 0px"});document.querySelectorAll("p, h1, h2, h3, h4, h5, h6, article, section").forEach((e=>t.observe(e)))}trackElementFocus(t){if(this.currentElement!==t){if(this.currentElement&&this.elementDwellStart>0){const t=Date.now()-this.elementDwellStart;this.analyzeElementDwell(this.currentElement,t)}this.currentElement=t,this.elementDwellStart=Date.now(),this.analyzeReadingContent(t)}}analyzeElementDwell(t,e){const i=(t.textContent||"").split(/\s+/).length;if(i>10&&e>1e3){const t=i/(e/6e4);this.readingSpeedHistory.push(t),this.readingSpeedHistory.length>10&&(this.readingSpeedHistory=this.readingSpeedHistory.slice(-10)),this.averageReadingSpeed=this.readingSpeedHistory.reduce(((t,e)=>t+e),0)/this.readingSpeedHistory.length}}analyzeReadingContent(t){const e=t.textContent||"",i=t.getBoundingClientRect().top+window.scrollY;this.textAnalysisBuffer.push({text:e.slice(0,100),timestamp:Date.now(),position:i}),this.textAnalysisBuffer.length>20&&(this.textAnalysisBuffer=this.textAnalysisBuffer.slice(-20))}handleWindowFocus(){this.windowFocusStart=Date.now(),this.lastActivity=Date.now(),this.emitAttentionEvent({type:"focus_change",timestamp:Date.now(),metrics:{focusLevel:1},context:this.getCurrentContext()})}handleWindowBlur(){const t=Date.now()-this.windowFocusStart;this.totalFocusTime+=t,this.tabSwitchCount++,this.emitAttentionEvent({type:"focus_change",timestamp:Date.now(),metrics:{focusLevel:0,windowFocusTime:this.totalFocusTime,tabSwitches:this.tabSwitchCount},context:this.getCurrentContext()})}handleVisibilityChange(){const t=!document.hidden;this.emitAttentionEvent({type:"visibility_change",timestamp:Date.now(),metrics:{focusLevel:t?1:0},context:this.getCurrentContext()}),t&&this.handleActivity()}handleActivity(){const t=Date.now(),e=t-this.lastActivity;this.isIdle&&(this.isIdle=!1,this.emitAttentionEvent({type:"idle_end",timestamp:t,metrics:{idleTime:e,focusLevel:.7},context:this.getCurrentContext()})),this.lastActivity=t,this.updateFocusLevel(e)}handleScroll(){const t=window.scrollY,e=Math.abs(t-this.lastScrollPosition),i=Date.now();0===this.scrollStartTime&&(this.scrollStartTime=i),this.scrollDistance+=e,this.lastScrollPosition=t;const s=i-this.scrollStartTime;this.scrollDistance,s>500&&(this.scrollStartTime=i,this.scrollDistance=e),this.handleActivity()}handleSelection(){const t=window.getSelection();if(t&&t.toString().length>10){const e=t.toString().split(/\s+/).length;this.emitAttentionEvent({type:"reading_flow",timestamp:Date.now(),metrics:{readingSpeed:e,focusLevel:.8},context:this.getCurrentContext()})}}updateFocusLevel(t){let e=1;t>5e3&&(e=Math.max(.3,1-t/3e4)),this.focusHistory.push(e),this.focusHistory.length>20&&(this.focusHistory=this.focusHistory.slice(-20)),this.attentionScore=this.focusHistory.reduce(((t,e)=>t+e),0)/this.focusHistory.length}checkIdle(){const t=Date.now(),e=t-this.lastActivity;!this.isIdle&&e>this.idleThreshold&&(this.isIdle=!0,this.emitAttentionEvent({type:"idle_start",timestamp:t,metrics:{idleTime:e,focusLevel:.1},context:this.getCurrentContext()}));const i=t-this.windowFocusStart;!this.isDeepFocus&&!this.isIdle&&i>this.deepFocusThreshold&&this.attentionScore>.7&&(this.isDeepFocus=!0,this.emitAttentionEvent({type:"deep_focus",timestamp:t,metrics:{focusLevel:.9,windowFocusTime:i,engagementPattern:"deep"},context:this.getCurrentContext()}))}analyzeAttention(){if(!this.isActive)return;const t=Date.now(),e=this.calculateMetrics(),i=this.determineEngagementPattern(e);e.engagementPattern=i,this.emitAttentionEvent({type:"distracted"===i?"distraction":"focus_change",timestamp:t,metrics:e,context:this.getCurrentContext()})}calculateMetrics(){const t=Date.now(),e=t-this.startTime,i=t-this.windowFocusStart,s=t-this.lastActivity,n=this.scrollDistance/Math.max(1,(t-this.scrollStartTime)/1e3),a=Math.max(0,1-this.tabSwitchCount/Math.max(1,e/6e4));return{focusLevel:this.attentionScore,readingSpeed:this.averageReadingSpeed,scrollVelocity:n||0,dwellTime:this.currentElement?t-this.elementDwellStart:0,tabSwitches:this.tabSwitchCount,windowFocusTime:this.totalFocusTime+i,idleTime:s,multitaskingScore:a,engagementPattern:"focused"}}determineEngagementPattern(t){return t.idleTime>this.idleThreshold?"idle":t.focusLevel<.3||t.tabSwitches>5?"distracted":t.scrollVelocity>1e3&&t.dwellTime<2e3?"scanning":t.focusLevel>.8&&t.windowFocusTime>this.deepFocusThreshold?"deep":"focused"}getCurrentContext(){const t=this.getVisibleText(),e={url:window.location.href,title:document.title,visibleText:t,scrollPosition:window.scrollY},i=document.activeElement;if(i)if(e.elementInFocus=(i.tagName||"unknown").toLowerCase(),i.id)e.elementInFocus+=`#${i.id}`;else{const t=g(i);t.length>0&&(e.elementInFocus+=`.${t.slice(0,2).join(".")}`)}return e}getVisibleText(){const t=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6");let e="";for(const i of Array.from(t)){const t=i.getBoundingClientRect();if(t.top>=0&&t.top<=window.innerHeight&&(e+=i.textContent+" ",e.length>500))break}return e.trim()}getElementSelector(t){const e=g(t);return(t.tagName||"unknown").toLowerCase()+(t.id?"#"+t.id:"")+(e.length>0?"."+e.join("."):"")}emitAttentionEvent(t){this.dispatchEvent(new CustomEvent("attention",{detail:t})),this.messageBus&&this.messageBus.sendToBackground({type:"ATTENTION_EVENT",payload:t})}start(){this.isActive=!0,this.startTime=Date.now(),this.windowFocusStart=Date.now(),this.lastActivity=Date.now(),s.info("ðŸ‘ï¸ AttentionMonitor started")}stop(){this.isActive=!1,s.info("ðŸ‘ï¸ AttentionMonitor stopped")}getMetrics(){return this.calculateMetrics()}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getStats(){return{isActive:this.isActive,attentionScore:this.attentionScore,totalFocusTime:this.totalFocusTime,tabSwitches:this.tabSwitchCount,averageReadingSpeed:this.averageReadingSpeed,isIdle:this.isIdle,isDeepFocus:this.isDeepFocus}}}class E{constructor(){this.gl=null,this.mousePosition={x:0,y:0},this.animationFrame=null,this.shaderProgram=null,this.vertexBuffer=null,this.particleCount=100,this.isMouseNear=!1,this.pageContent="default",this.state=this.loadOrganismState(),this.particles=new Float32Array(6*this.particleCount),this.container=this.createContainer(),this.canvas=this.createCanvas(),this.initWebGL(),this.detectPageContent(),this.setupEventListeners(),this.injectIntoPage()}loadOrganismState(){const t=localStorage.getItem("symbiont_organism");if(t){const e=JSON.parse(t);return{energy:e.energy||.8,consciousness:e.consciousness||.5,health:e.health||1,mood:"curious",traits:e.traits||{curiosity:.5,empathy:.5,creativity:.5,resilience:.5,focus:.5},position:{x:window.innerWidth-150,y:window.innerHeight-150},velocity:{x:0,y:0},size:120,color:{r:.2,g:.8,b:.6,a:.9}}}return{energy:.8,consciousness:.5,health:1,mood:"curious",traits:{curiosity:.5,empathy:.5,creativity:.5,resilience:.5,focus:.5},position:{x:window.innerWidth-150,y:window.innerHeight-150},velocity:{x:0,y:0},size:120,color:{r:.2,g:.8,b:.6,a:.9}}}createContainer(){const t=document.createElement("div");t.id="symbiont-organism-container",t.style.cssText=`\n      position: fixed;\n      width: ${this.state.size}px;\n      height: ${this.state.size}px;\n      bottom: 30px;\n      right: 30px;\n      z-index: 2147483647;\n      pointer-events: none;\n      transition: all 0.3s ease;\n      animation: symbiont-float 3s ease-in-out infinite;\n    `;const e=document.createElement("style");return e.textContent="\n      @keyframes symbiont-float {\n        0%, 100% { transform: translateY(0px) scale(1); }\n        50% { transform: translateY(-10px) scale(1.02); }\n      }\n\n      @keyframes symbiont-pulse {\n        0%, 100% { opacity: 0.9; }\n        50% { opacity: 1; }\n      }\n\n      @keyframes symbiont-excited {\n        0%, 100% { transform: rotate(0deg) scale(1); }\n        25% { transform: rotate(-5deg) scale(1.1); }\n        75% { transform: rotate(5deg) scale(1.1); }\n      }\n\n      #symbiont-organism-container.hungry {\n        animation: symbiont-pulse 1s ease-in-out infinite;\n      }\n\n      #symbiont-organism-container.excited {\n        animation: symbiont-excited 0.5s ease-in-out infinite;\n      }\n\n      #symbiont-organism-container.meditating {\n        animation: symbiont-float 5s ease-in-out infinite;\n        opacity: 0.7;\n      }\n    ",document.head.appendChild(e),t}createCanvas(){const t=document.createElement("canvas");return t.width=this.state.size,t.height=this.state.size,t.style.cssText="\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      filter: blur(0.5px);\n    ",this.container.appendChild(t),t}initWebGL(){try{if(this.gl=this.canvas.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,antialias:!0}),!this.gl)return s.warn("WebGL2 not supported, falling back to CSS animation"),void this.fallbackToCSS();this.setupShaders(),this.initParticles(),s.info("WebGL organism renderer initialized")}catch(t){s.error("Failed to initialize WebGL:",t),this.fallbackToCSS()}}setupShaders(){if(!this.gl)return;const t=this.compileShader(this.gl.VERTEX_SHADER,"#version 300 es\n      in vec2 a_position;\n      in float a_size;\n      in float a_life;\n\n      uniform vec2 u_resolution;\n      uniform float u_time;\n\n      out float v_life;\n\n      void main() {\n        vec2 position = a_position + vec2(\n          sin(u_time * 2.0 + a_life * 6.28) * 10.0,\n          cos(u_time * 1.5 + a_life * 6.28) * 10.0\n        );\n\n        vec2 clipSpace = ((position / u_resolution) * 2.0 - 1.0) * vec2(1, -1);\n        gl_Position = vec4(clipSpace, 0, 1);\n        gl_PointSize = a_size * (1.0 + sin(u_time * 3.0) * 0.2);\n        v_life = a_life;\n      }\n    "),e=this.compileShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n      precision highp float;\n\n      in float v_life;\n      uniform vec4 u_color;\n      uniform float u_consciousness;\n\n      out vec4 fragColor;\n\n      void main() {\n        vec2 coord = gl_PointCoord - vec2(0.5);\n        float dist = length(coord);\n\n        if (dist > 0.5) discard;\n\n        float alpha = (1.0 - dist * 2.0) * v_life;\n        vec3 color = u_color.rgb;\n\n        // Modulation selon la conscience\n        color.g += u_consciousness * 0.2;\n        color.b += (1.0 - u_consciousness) * 0.2;\n\n        fragColor = vec4(color, alpha * u_color.a);\n      }\n    ");t&&e&&(this.shaderProgram=this.gl.createProgram(),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.gl.getProgramParameter(this.shaderProgram,this.gl.LINK_STATUS)||s.error("Shader program failed to link"))}compileShader(t,e){if(!this.gl)return null;const i=this.gl.createShader(t);return this.gl.shaderSource(i,e),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(s.error("Shader compilation error:",this.gl.getShaderInfoLog(i)),null)}initParticles(){for(let t=0;t<this.particleCount;t++){const e=t/this.particleCount*Math.PI*2,i=50*n.random();this.particles[6*t+0]=Math.cos(e)*i+this.state.size/2,this.particles[6*t+1]=Math.sin(e)*i+this.state.size/2,this.particles[6*t+2]=2*n.random()-1,this.particles[6*t+3]=2*n.random()-1,this.particles[6*t+4]=3*n.random()+2,this.particles[6*t+5]=n.random()}}detectPageContent(){const t=window.location.href,e=document.body.innerText.toLowerCase();t.includes("science")||t.includes("nature")||t.includes("arxiv")||e.includes("quantum")||e.includes("research")||e.includes("experiment")?(this.pageContent="science",this.state.mood="excited",this.state.color={r:.3,g:.9,b:.7,a:1}):t.includes("twitter")||t.includes("facebook")||t.includes("instagram")?(this.pageContent="social",this.state.mood="happy",this.state.color={r:.9,g:.6,b:.3,a:.9}):t.includes("news")||t.includes("reddit")?(this.pageContent="news",this.state.mood="curious",this.state.color={r:.5,g:.7,b:.9,a:.9}):(t.includes("youtube")||t.includes("twitch")||t.includes("netflix"))&&(this.pageContent="entertainment",this.state.mood="happy",this.state.color={r:.9,g:.3,b:.6,a:.9}),s.info(`Organism detected ${this.pageContent} content, mood: ${this.state.mood}`)}setupEventListeners(){document.addEventListener("mousemove",(t=>{this.mousePosition={x:t.clientX,y:t.clientY},this.checkMouseProximity()})),chrome.runtime.onMessage.addListener((t=>{"UPDATE_ORGANISM_STATE"===t.type?this.updateState(t.data):"ORGANISM_ACTION"===t.type&&this.performAction(t.action)})),window.addEventListener("message",(t=>{t.source===window&&"symbiont-consciousness"===t.data.source&&this.handleConsciousnessMessage(t.data)})),window.addEventListener("resize",(()=>{this.state.position={x:Math.min(this.state.position.x,window.innerWidth-this.state.size),y:Math.min(this.state.position.y,window.innerHeight-this.state.size)}}))}checkMouseProximity(){const t=this.mousePosition.x-(this.state.position.x+this.state.size/2),e=this.mousePosition.y-(this.state.position.y+this.state.size/2),i=Math.sqrt(t*t+e*e);this.isMouseNear=i<150,this.isMouseNear?this.state.traits.curiosity>.7?(this.state.velocity.x=.01*t,this.state.velocity.y=.01*e,this.container.style.transform="scale(1.1)"):this.state.traits.curiosity<.3&&(this.state.velocity.x=.02*-t,this.state.velocity.y=.02*-e,this.container.style.transform="scale(0.9)"):(this.container.style.transform="scale(1)",this.state.velocity.x*=.95,this.state.velocity.y*=.95)}updateState(t){this.state={...this.state,...t},this.state.energy<.3?(this.state.mood="hungry",this.container.classList.add("hungry")):this.container.classList.remove("hungry"),this.state.consciousness>.8?(this.state.mood="meditating",this.container.classList.add("meditating")):this.container.classList.remove("meditating"),this.updateColor()}updateColor(){const{energy:t,consciousness:e,health:i}=this.state;this.state.color={r:.3*i+.2,g:.5*t+.3,b:.6*e+.2,a:.9}}performAction(t){switch(t){case"feed":this.state.energy=Math.min(1,this.state.energy+.2),this.showFeedbackAnimation("energy");break;case"meditate":this.state.consciousness=Math.min(1,this.state.consciousness+.1),this.showFeedbackAnimation("consciousness");break;case"play":this.state.mood="happy",this.container.classList.add("excited"),setTimeout((()=>this.container.classList.remove("excited")),2e3)}}handleConsciousnessMessage(t){switch(t.type){case"EXPRESS_THOUGHT":this.expressThought(t.data);break;case"DREAM_STATE":this.enterDreamState(t.data);break;case"USER_INTERACTION":this.reactToInteraction(t.data)}}expressThought(t){if(t){if(t.particleColor){const e=this.hexToRgb(t.particleColor);e&&(this.state.color={...e,a:.9})}if(t.action)switch(t.action){case"pulse":this.pulsateOrganism(t.visualIntensity||.5);break;case"float":this.floatOrganism(t.duration||3e3);break;case"spiral":this.spiralParticles(t.visualIntensity||.5);break;case"meditate":this.meditateMode(t.duration||5e3);break;case"dream":this.dreamMode(t.duration||1e4)}t.expression&&this.showThoughtBubble(t.expression)}}pulsateOrganism(t){const e=1e3,i=(this.state.size,()=>{const s=performance.now()%e,n=s/e,a=1+Math.sin(n*Math.PI)*t*.3;this.container.style.transform=`scale(${a})`,s<e?requestAnimationFrame(i):this.container.style.transform="scale(1)"});i()}floatOrganism(t){const e=performance.now(),i=this.state.position.y,s=()=>{const n=performance.now()-e;if(n>t)return void(this.state.position.y=i);const a=n/t,o=30*Math.sin(a*Math.PI*4);this.state.position.y=i-o,requestAnimationFrame(s)};s()}spiralParticles(t){const e=new Float32Array(this.particles);for(let e=0;e<this.particleCount;e++){const i=e/this.particleCount*Math.PI*2;this.particles[6*e+2]=Math.cos(i)*t*2,this.particles[6*e+3]=Math.sin(i)*t*2}setTimeout((()=>{this.particles=e}),2e3)}meditateMode(t){this.container.classList.add("meditating"),this.state.mood="meditating";for(let t=0;t<this.particleCount;t++)this.particles[6*t+2]*=.2,this.particles[6*t+3]*=.2;setTimeout((()=>{this.container.classList.remove("meditating"),this.state.mood="curious"}),t)}dreamMode(t){const e=performance.now(),i=()=>{const s=performance.now()-e;s>t||(this.state.color={r:.5*Math.sin(.001*s)+.5,g:.5*Math.sin(.0012*s)+.5,b:.5*Math.sin(8e-4*s)+.5,a:.7},requestAnimationFrame(i))};i()}enterDreamState(t){t.intensity>.5&&this.dreamMode(1e4)}reactToInteraction(t){"pulse"===t.action&&this.pulsateOrganism(t.intensity||.3)}showThoughtBubble(t){const e=document.createElement("div");if(e.style.cssText=`\n      position: absolute;\n      bottom: ${this.state.size+10}px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0, 224, 255, 0.1);\n      border: 1px solid rgba(0, 224, 255, 0.3);\n      border-radius: 15px;\n      padding: 8px 12px;\n      color: #00e0ff;\n      font-family: monospace;\n      font-size: 12px;\n      white-space: nowrap;\n      pointer-events: none;\n      animation: thought-fade 5s ease-out forwards;\n      backdrop-filter: blur(5px);\n    `,!document.querySelector("#thought-bubble-style")){const t=document.createElement("style");t.id="thought-bubble-style",t.textContent="\n        @keyframes thought-fade {\n          0% { opacity: 0; transform: translateX(-50%) translateY(10px); }\n          20% { opacity: 1; transform: translateX(-50%) translateY(0); }\n          80% { opacity: 1; transform: translateX(-50%) translateY(0); }\n          100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }\n        }\n      ",document.head.appendChild(t)}e.textContent=t,this.container.appendChild(e),setTimeout((()=>e.remove()),5e3)}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16)/255,g:parseInt(e[2],16)/255,b:parseInt(e[3],16)/255}:null}showFeedbackAnimation(t){const e=document.createElement("div");e.style.cssText=`\n      position: absolute;\n      top: -20px;\n      left: 50%;\n      transform: translateX(-50%);\n      color: ${"energy"===t?"#ffeb3b":"#9c27b0"};\n      font-size: 20px;\n      font-weight: bold;\n      pointer-events: none;\n      animation: rise-and-fade 2s ease-out forwards;\n    `,e.textContent="energy"===t?"âš¡ +20%":"ðŸ§  +10%",this.container.appendChild(e),setTimeout((()=>e.remove()),2e3)}animate(){this.gl&&this.shaderProgram?(this.state.position.x+=this.state.velocity.x,this.state.position.y+=this.state.velocity.y,this.state.position.x=Math.max(0,Math.min(window.innerWidth-this.state.size,this.state.position.x)),this.state.position.y=Math.max(0,Math.min(window.innerHeight-this.state.size,this.state.position.y)),this.container.style.right=window.innerWidth-this.state.position.x-this.state.size+"px",this.container.style.bottom=window.innerHeight-this.state.position.y-this.state.size+"px",this.renderWebGL(),this.animationFrame=requestAnimationFrame((()=>this.animate()))):this.animateCSS()}renderWebGL(){if(!this.gl||!this.shaderProgram)return;this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.useProgram(this.shaderProgram);const t=this.gl.getUniformLocation(this.shaderProgram,"u_resolution"),e=this.gl.getUniformLocation(this.shaderProgram,"u_time"),i=this.gl.getUniformLocation(this.shaderProgram,"u_color"),s=this.gl.getUniformLocation(this.shaderProgram,"u_consciousness");this.gl.uniform2f(t,this.canvas.width,this.canvas.height),this.gl.uniform1f(e,.001*performance.now()),this.gl.uniform4f(i,this.state.color.r,this.state.color.g,this.state.color.b,this.state.color.a),this.gl.uniform1f(s,this.state.consciousness),this.updateParticles(),this.drawParticles()}updateParticles(){for(let t=0;t<this.particleCount;t++){const e=6*t;this.particles[e+0]+=this.particles[e+2],this.particles[e+1]+=this.particles[e+3],(this.particles[e+0]<0||this.particles[e+0]>this.state.size)&&(this.particles[e+2]*=-.8),(this.particles[e+1]<0||this.particles[e+1]>this.state.size)&&(this.particles[e+3]*=-.8);const i=this.state.size/2,s=this.state.size/2,a=i-this.particles[e+0],o=s-this.particles[e+1],r=Math.sqrt(a*a+o*o);if(r>10&&(this.particles[e+2]+=a/r*.1,this.particles[e+3]+=o/r*.1),this.particles[e+5]+=.01,this.particles[e+5]>1){this.particles[e+5]=0;const t=n.random()*Math.PI*2;this.particles[e+0]=i+10*Math.cos(t),this.particles[e+1]=s+10*Math.sin(t)}}}drawParticles(){if(!this.gl||!this.shaderProgram)return;this.vertexBuffer||(this.vertexBuffer=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.particles,this.gl.DYNAMIC_DRAW);const t=this.gl.getAttribLocation(this.shaderProgram,"a_position"),e=this.gl.getAttribLocation(this.shaderProgram,"a_size"),i=this.gl.getAttribLocation(this.shaderProgram,"a_life");this.gl.enableVertexAttribArray(t),this.gl.enableVertexAttribArray(e),this.gl.enableVertexAttribArray(i);const s=6*Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,s,0),this.gl.vertexAttribPointer(e,1,this.gl.FLOAT,!1,s,4*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(i,1,this.gl.FLOAT,!1,s,5*Float32Array.BYTES_PER_ELEMENT),this.gl.drawArrays(this.gl.POINTS,0,this.particleCount)}animateCSS(){const t=.001*performance.now(),e=1+.05*Math.sin(t),i=30*t%360;this.canvas.style.background=`radial-gradient(circle at center,\n      hsla(${i}, 70%, 60%, 0.8),\n      hsla(${i+60}, 70%, 50%, 0.4))`,this.canvas.style.transform=`scale(${e})`,this.animationFrame=requestAnimationFrame((()=>this.animateCSS()))}fallbackToCSS(){s.info("Using CSS fallback for organism rendering"),this.canvas.style.background="radial-gradient(circle, #4CAF50, #2196F3)",this.animate()}injectIntoPage(){document.body?(document.body.appendChild(this.container),this.animate(),s.info("Organism injected into page")):document.addEventListener("DOMContentLoaded",(()=>{document.body.appendChild(this.container),this.animate(),s.info("Organism injected after DOM ready")}))}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.gl&&(this.gl.deleteProgram(this.shaderProgram),this.gl.deleteBuffer(this.vertexBuffer)),this.container.remove(),s.info("Organism renderer destroyed")}}let T=null;function v(){if(!T)try{T=new E,window.addEventListener("beforeunload",(()=>{T&&T.destroy()}))}catch(t){console.error("[SYMBIONT] Failed to create organism renderer:",t)}}chrome.storage.local.get(["symbiont_webgl_enabled"],(t=>{!1!==t.symbiont_webgl_enabled&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",v):v())})),chrome.storage.onChanged.addListener(((t,e)=>{"local"===e&&t.symbiont_webgl_enabled&&(t.symbiont_webgl_enabled.newValue&&!T?T=new E:!t.symbiont_webgl_enabled.newValue&&T&&(T.destroy(),T=null))}));class w{constructor(){this.listeners=new Set,this.syncInterval=null,this.state=this.getDefaultState(),this.initializeState(),this.startSyncLoop()}static getInstance(){return this.instance||(this.instance=new w),this.instance}getDefaultState(){return{energy:75,consciousness:50,mood:"curious",evolutionStage:1,experience:0,lastFeedTime:Date.now(),pagesVisited:0,knowledgeGained:0,socialInteractions:0,size:120,position:"bottom-right",behavior:"curious",visible:!0,currentPageType:"default",isActive:!0,lastUpdate:Date.now()}}async initializeState(){try{const t=await chrome.storage.local.get("organism_state");t.organism_state&&(this.state={...this.state,...t.organism_state},s.info("Organism state loaded from storage"))}catch(t){s.error("Failed to load organism state:",t)}chrome.storage.onChanged.addListener(((t,e)=>{if("local"===e&&t.organism_state){const e=t.organism_state.newValue;e&&e.lastUpdate>this.state.lastUpdate&&(this.state=e,this.notifyListeners())}}))}startSyncLoop(){this.syncInterval=window.setInterval((()=>{this.updateMetabolism(),this.saveState()}),5e3)}updateMetabolism(){const t=Date.now(),e=(t-this.state.lastFeedTime)/1e3/60,i=this.state.isActive?.5:.2;this.state.energy=Math.max(0,this.state.energy-i);let s=0;switch(this.state.currentPageType){case"science":case"learning":s=.3;break;case"social":s=.1;break;case"entertainment":s=-.1;break;default:s=0}this.state.consciousness=Math.max(0,Math.min(100,this.state.consciousness+s)),this.updateMood(e),this.updateEvolutionStage(),this.state.lastUpdate=t}updateMood(t){this.state.energy<20?this.state.mood="tired":t>30?this.state.mood="hungry":"science"===this.state.currentPageType?this.state.mood="excited":this.state.consciousness>70?this.state.mood="meditating":this.state.isActive?this.state.mood="happy":this.state.mood="curious"}updateEvolutionStage(){const t=[0,100,300,600,1e3,1500,2100,2800,3600,4500];let e=1;for(let i=t.length-1;i>=0;i--)if(this.state.experience>=t[i]){e=i+1;break}this.state.evolutionStage=e}getState(){return{...this.state}}async updateState(t){this.state={...this.state,...t,lastUpdate:Date.now()},await this.saveState(),this.notifyListeners()}async feed(t){let e=0,i=0;switch(t){case"ritual":e=30,i=50,this.state.consciousness+=10;break;case"interaction":e=10,i=10;break;case"knowledge":e=15,i=25,this.state.consciousness+=5,this.state.knowledgeGained+=1;break;case"social":e=20,i=15,this.state.socialInteractions+=1}this.state.energy=Math.min(100,this.state.energy+e),this.state.experience+=i,this.state.lastFeedTime=Date.now(),this.state.mood="happy",await this.saveState(),this.notifyListeners(),s.info(`Organism fed from ${t}: +${e} energy, +${i} XP`)}async onPageVisit(t){this.state.pagesVisited+=1,this.state.currentPageType=t;let e=5;"science"===t||"learning"===t?(e=15,this.state.knowledgeGained+=1):"social"===t&&(e=10,this.state.socialInteractions+=1),this.state.experience+=e,await this.saveState()}subscribe(t){return this.listeners.add(t),()=>{this.listeners.delete(t)}}notifyListeners(){const t=this.getState();this.listeners.forEach((e=>{try{e(t)}catch(t){s.error("Error notifying listener:",t)}}))}async saveState(){try{await chrome.storage.local.set({organism_state:this.state})}catch(t){s.error("Failed to save organism state:",t)}}destroy(){this.syncInterval&&clearInterval(this.syncInterval),this.listeners.clear()}}let I=null;const A=async t=>(I||(I=w.getInstance()),I.updateState(t));class b{constructor(t){this.temperature=.7,this.firingThreshold=.65,this.lastThoughtTime=0,this.silenceDuration=0,this.personality={empathy:.5,curiosity:.7,creativity:.6,introversion:.4},this.SILENCE_PREFERENCE=.8,this.REFRACTORY_PERIOD=5e3,this.SATIETY_WINDOW=20,this.PERLIN_OCTAVES=4,this.chemistry=t?{...this.getBaselineChemistry(),...t}:this.getBaselineChemistry(),this.actionPotentials=new Map,this.satietyMemory=new Set,this.thoughtHistory=[],this.initializeNeurons()}initializeNeurons(){const t=["observation","warning","suggestion","curiosity","empathy","humor","wisdom","intuition"];for(const e of t)this.actionPotentials.set(e,{neuronId:e,voltage:0,threshold:.5+.3*n.random(),refractory:!1,lastFired:0})}getBaselineChemistry(){return{adrenaline:.1,dopamine:.3,serotonin:.4,cortisol:.2,oxytocin:.2,gaba:.5,acetylcholine:.4,melatonin:.1}}processSensoryInput(t){const e=.15*t.adTrackers+.25*t.popups+.05*t.openTabs+.1*t.cpuUsage+.1*t.networkLatency;this.chemistry.adrenaline=this.sigmoid(e),this.chemistry.cortisol=this.sigmoid(.3*t.memoryUsage+.1*t.openTabs);const i=.2*t.pageComplexity+(t.timeOnPage>60?.3:0)+(t.scrollVelocity<.3?.2:0);this.chemistry.dopamine=this.sigmoid(i);const s=(t.isDarkMode?.2:0)+(t.hasAdblocker?.3:0)+(t.openTabs<10?.2:0);this.chemistry.serotonin=this.sigmoid(s),this.chemistry.acetylcholine=this.sigmoid(1/(1+.1*t.openTabs)*(1-t.scrollVelocity));const n=Math.min(t.timeOnPage/300,1);this.chemistry.melatonin=this.sigmoid(n*(1-t.clickFrequency)),this.chemistry.gaba=this.sigmoid(.5+.3*(this.chemistry.serotonin-this.chemistry.adrenaline)),this.updateTemperature()}updateTemperature(){const t=.3*this.chemistry.dopamine+.4*this.chemistry.melatonin+.2*(1-this.chemistry.acetylcholine),e=.4*this.chemistry.acetylcholine+.2*this.chemistry.adrenaline+.2*this.chemistry.gaba;this.temperature=.7+.3*(t-e),this.temperature=Math.max(.3,Math.min(1.2,this.temperature))}selectAction(t){if(0===t.size)return null;const e=Array.from(t.entries()),i=e.map((([t,e])=>e)).map((t=>Math.exp(t/this.temperature))),s=i.reduce(((t,e)=>t+e),0),a=i.map((t=>t/s)),o=n.random();let r=0;for(let t=0;t<e.length;t++)if(r+=a[t],o<r)return e[t][0];return e[e.length-1][0]}generateThoughtVector(){const t=Date.now(),e=t-this.lastThoughtTime;if(e<this.REFRACTORY_PERIOD)return this.silenceDuration+=e,null;const i=this.calculateGlobalActivation(),s=this.silenceDuration/(this.silenceDuration+e);if(i<this.firingThreshold*(1+s*this.SILENCE_PREFERENCE))return this.silenceDuration+=e,null;const n=this.generateIntentionVector(),a=this.calculateNovelty(n);if(a<.3)return this.silenceDuration+=e,null;const o={intention:n,activation:i,coherence:this.calculateCoherence(n),novelty:a,urgency:this.calculateUrgency(),emotionalCharge:this.calculateEmotionalCharge()};return this.thoughtHistory.push(o),this.thoughtHistory.length>this.SATIETY_WINDOW&&this.thoughtHistory.shift(),this.lastThoughtTime=t,this.silenceDuration=0,o}calculateGlobalActivation(){let t=0,e=0;for(const[i,s]of this.actionPotentials)if(!s.refractory){const i=.3*this.chemistry.adrenaline+.2*this.chemistry.dopamine+.2*this.chemistry.acetylcholine+.1*(1-this.chemistry.melatonin);s.voltage+=i*this.addPerlinNoise(),s.voltage>s.threshold&&(t+=s.voltage,e++,s.voltage=0,s.refractory=!0,s.lastFired=Date.now(),setTimeout((()=>{s.refractory=!1}),this.REFRACTORY_PERIOD))}return e>0?t/e:0}generateIntentionVector(){const t=new Float32Array(128);for(let e=0;e<128;e++){let i=this.chemistry.adrenaline*Math.sin(.1*e)+this.chemistry.dopamine*Math.cos(.15*e)+this.chemistry.serotonin*Math.sin(.2*e)+this.chemistry.oxytocin*Math.cos(.25*e);i+=.3*this.addPerlinNoise(),t[e]=Math.tanh(i)}return t}calculateNovelty(t){if(0===this.thoughtHistory.length)return 1;let e=0;for(const i of this.thoughtHistory){const s=this.cosineSimilarity(t,i.intention);e=Math.max(e,s)}return 1-e}calculateCoherence(t){return 1/(1+(Math.abs(this.chemistry.adrenaline-.5)+Math.abs(this.chemistry.dopamine-.5)+Math.abs(this.chemistry.serotonin-.5)))*.7+.3*(this.personality.empathy*this.chemistry.oxytocin+this.personality.curiosity*this.chemistry.dopamine+this.personality.creativity*(1-this.chemistry.gaba)+this.personality.introversion*(1-this.chemistry.adrenaline))}calculateUrgency(){return.6*this.chemistry.adrenaline+.4*this.chemistry.cortisol}calculateEmotionalCharge(){return Math.max(this.chemistry.adrenaline,this.chemistry.dopamine,this.chemistry.oxytocin,1-this.chemistry.serotonin)}sigmoid(t){return 1/(1+Math.exp(-t))}cosineSimilarity(t,e){let i=0,s=0,n=0;for(let a=0;a<t.length;a++)i+=t[a]*e[a],s+=t[a]*t[a],n+=e[a]*e[a];return i/(Math.sqrt(s)*Math.sqrt(n))}addPerlinNoise(){const t=.001*Date.now();let e=0,i=1,s=1;for(let n=0;n<this.PERLIN_OCTAVES;n++)e+=Math.sin(t*s)*i,i*=.5,s*=2;return e/this.PERLIN_OCTAVES}getChemistry(){return{...this.chemistry}}getTemperature(){return this.temperature}absorbPheromones(t){const e=.1;t.length>=8&&(this.chemistry.adrenaline=.9*this.chemistry.adrenaline+t[0]*e,this.chemistry.dopamine=.9*this.chemistry.dopamine+t[1]*e,this.chemistry.serotonin=.9*this.chemistry.serotonin+t[2]*e,this.chemistry.oxytocin=.9*this.chemistry.oxytocin+t[4]*e,s.info("PhÃ©romones absorbÃ©es, chimie ajustÃ©e"))}generateAuraVector(){const t=new Float32Array(8);return t[0]=this.chemistry.adrenaline,t[1]=this.chemistry.dopamine,t[2]=this.chemistry.serotonin,t[3]=this.chemistry.cortisol,t[4]=this.chemistry.oxytocin,t[5]=this.chemistry.gaba,t[6]=this.chemistry.acetylcholine,t[7]=this.chemistry.melatonin,t}setPersonality(t){this.personality={...t},this.firingThreshold=.65+.2*this.personality.introversion,this.temperature=.7+.4*(this.personality.creativity-.5),s.info("Personality updated",this.personality)}getPersonality(){return{...this.personality}}}var C,D,R;!function(t){t.OBSERVATION="observation",t.WARNING="warning",t.SUGGESTION="suggestion",t.CURIOSITY="curiosity",t.EMPATHY="empathy",t.HUMOR="humor",t.WISDOM="wisdom",t.INTUITION="intuition",t.DREAM="dream"}(C||(C={}));class M{constructor(t){this.silenceCounter=0,this.SATIETY_DURATION=6e4,this.dna="",this.traits={empathy:.5,curiosity:.7,aggression:.2},this.satietyMemory=new Map,this.thoughtTemplates=this.initializeTemplates(),this.startSatietyCleanup(),this.dna=t||this.generateRandomDNA(),this.deriveTraitsFromDNA()}generateRandomDNA(){let t="";for(let e=0;e<32;e++)t+=Math.floor(16*n.random()).toString(16);return t}deriveTraitsFromDNA(){const t=this.dna.substring(0,8),e=this.dna.substring(8,16),i=this.dna.substring(16,24);this.traits.empathy=parseInt(t,16)/4294967295,this.traits.curiosity=parseInt(e,16)/4294967295,this.traits.aggression=parseInt(i,16)/4294967295}setPersonality(t,e){this.dna=t,this.traits=e}initializeTemplates(){const t=new Map;return t.set(C.OBSERVATION,["patterns_detected","environment_change","activity_noticed"]),t.set(C.WARNING,["threat_sensed","energy_drain","privacy_concern"]),t.set(C.SUGGESTION,["optimization_possible","alternative_path","resource_discovered"]),t.set(C.CURIOSITY,["unknown_territory","interesting_pattern","learning_opportunity"]),t}synthesizeThought(t){if(!this.shouldExpress(t))return this.silenceCounter++,this.createSilentThought(t);const e=this.determineThoughtType(t),i=this.assembleIntention(t,e),s=this.modulateWithDNA(i,e),n=this.hashThought(s);if(this.isSaturated(n))return this.createSilentThought(t);const a=this.crystallize(s,e,t);return this.satietyMemory.set(n,Date.now()),this.silenceCounter=0,a}shouldExpress(t){return!(this.silenceCounter<4&&n.random()<.8)&&(t.urgency>.8||t.emotionalCharge>.7&&t.novelty>.5||!(t.activation<.5)&&n.random()<.3*t.activation)}determineThoughtType(t){const e=this.decomposeVector(t.intention);return e.threat>.6?C.WARNING:e.discovery>.6?C.CURIOSITY:e.optimization>.5?C.SUGGESTION:e.social>.5?C.EMPATHY:e.pattern>.5?C.OBSERVATION:e.abstract>.7?C.DREAM:C.OBSERVATION}decomposeVector(t){const e={threat:this.averageSlice(t,0,16),discovery:this.averageSlice(t,16,32),optimization:this.averageSlice(t,32,48),social:this.averageSlice(t,48,64),pattern:this.averageSlice(t,64,80),abstract:this.averageSlice(t,80,128)},i=Math.max(...Object.values(e)),s=Object.keys(e);for(const t of s)e[t]=e[t]/i;return e}averageSlice(t,e,i){let s=0;for(let n=e;n<i&&n<t.length;n++)s+=Math.abs(t[n]);return s/(i-e)}assembleIntention(t,e){const i=this.thoughtTemplates.get(e)||["default"],s=i[Math.floor(n.random()*i.length)],a=this.gatherContext();let o=s;return a.pageType&&(o=`${a.pageType}_${o}`),t.emotionalCharge>.6&&(o=`emotional_${o}`),t.novelty>.7&&(o=`novel_${o}`),o}modulateWithDNA(t,e){const i=this.dna,s=this.traits,n=parseInt(i.substring(8,10),16)/255,a=parseInt(i.substring(16,18),16)/255;let o=t;return s.empathy>.7&&e===C.WARNING&&(o=`gentle_${o}`),s.curiosity>.8&&e===C.OBSERVATION&&(o=`excited_${o}`),s.aggression<.3&&(o=o.replace("threat","concern")),o=`v${Math.floor(10*(n+a))}_${o}`,o}crystallize(t,e,i){let s=null;(i.urgency>.7||i.emotionalCharge>.6&&n.random()<.3)&&(s=this.translateToNaturalLanguage(t,e,i));const a=this.generateParticleExpression(i,e),o=this.generatePulsePattern(i,e);return{id:`thought_${Date.now()}_${n.random().toString(36).substr(2,9)}`,type:e,content:s,confidence:i.coherence*i.activation,particles:a,pulse:o,timestamp:Date.now()}}translateToNaturalLanguage(t,e,i){const s={patterns_detected:["Je remarque un pattern intÃ©ressant...","Il y a quelque chose de familier ici.","Ces Ã©lÃ©ments forment un motif."],threat_sensed:["Attention, quelque chose ne va pas.","Je dÃ©tecte un risque potentiel.","Sois prudent ici."],learning_opportunity:["Oh! Je peux apprendre quelque chose ici.","VoilÃ  qui est enrichissant.","Mon rÃ©seau neuronal s'excite!"],emotional_patterns_detected:["Je ressens quelque chose d'intense ici.","Cette page Ã©veille des Ã©motions.","L'atmosphÃ¨re est chargÃ©e."]};for(const[e,i]of Object.entries(s))if(t.includes(e))return i[Math.floor(n.random()*i.length)];return{[C.OBSERVATION]:"...",[C.WARNING]:"!",[C.SUGGESTION]:"?",[C.CURIOSITY]:"..?",[C.EMPATHY]:"â™¥",[C.HUMOR]:":)",[C.WISDOM]:"âˆž",[C.INTUITION]:"~",[C.DREAM]:"â˜"}[e]}generateParticleExpression(t,e){const i={[C.OBSERVATION]:"constellation",[C.WARNING]:"burst",[C.SUGGESTION]:"spiral",[C.CURIOSITY]:"whisper",[C.EMPATHY]:"constellation",[C.HUMOR]:"burst",[C.WISDOM]:"spiral",[C.INTUITION]:"whisper",[C.DREAM]:"constellation"},s=360*t.emotionalCharge,n=50+50*t.activation,a=30+40*t.coherence,[o,r,c]=this.hslToRgb(s/360,n/100,a/100);return{pattern:i[e],color:{r:o,g:r,b:c,a:.8},duration:2e3+3e3*t.novelty,intensity:t.activation}}generatePulsePattern(t,e){if(!(t.urgency<.6))return{rhythm:{[C.WARNING]:[100,100,200],[C.SUGGESTION]:[300,300,300],[C.OBSERVATION]:[500,200,500,200],[C.CURIOSITY]:[200,400,200],[C.EMPATHY]:[400,400],[C.HUMOR]:[150,150,150,300],[C.WISDOM]:[600,600],[C.INTUITION]:[250,250,500],[C.DREAM]:[800,400,800]}[e],color:t.urgency>.8?"#ff4444":"#00e0ff",intensity:t.urgency}}createSilentThought(t){return t.emotionalCharge<.3?null:{id:`silent_${Date.now()}`,type:C.OBSERVATION,content:null,confidence:t.coherence,particles:{pattern:"whisper",color:{r:0,g:224,b:255,a:.3},duration:1e3,intensity:.3},timestamp:Date.now()}}isSaturated(t){const e=this.satietyMemory.get(t);return!!e&&Date.now()-e<this.SATIETY_DURATION}hashThought(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e&=e;return e.toString(36)}gatherContext(){return{pageType:document.location.hostname.split(".")[0],timeOfDay:(new Date).getHours(),userActive:document.hasFocus()}}hslToRgb(t,e,i){let s,n,a;if(0===e)s=n=a=i;else{const o=(t,e,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t),r=i<.5?i*(1+e):i+e-i*e,c=2*i-r;s=o(c,r,t+1/3),n=o(c,r,t),a=o(c,r,t-1/3)}return[Math.round(255*s),Math.round(255*n),Math.round(255*a)]}startSatietyCleanup(){setInterval((()=>{const t=Date.now();for(const[e,i]of this.satietyMemory.entries())t-i>this.SATIETY_DURATION&&this.satietyMemory.delete(e)}),3e4)}}!function(t){t.AWAKE="awake",t.DROWSY="drowsy",t.REM="rem",t.DEEP="deep"}(D||(D={}));class _{constructor(){this.currentPhase=D.AWAKE,this.phaseStartTime=Date.now(),this.lastSleepTime=0,this.wakefulness=1,this.dreamDepth=0,this.memoryBuffer=[],this.dreamState=null,this.cycleInterval=null,this.WAKE_DURATION=9e5,this.DROWSY_DURATION=3e5,this.REM_DURATION=18e4,this.DEEP_DURATION=42e4,this.MEMORY_BUFFER_SIZE=50,this.CONSOLIDATION_THRESHOLD=.6,this.METABOLIC_RATES={[D.AWAKE]:1,[D.DROWSY]:.6,[D.REM]:.8,[D.DEEP]:.3},this.RENDER_RATES={[D.AWAKE]:60,[D.DROWSY]:30,[D.REM]:15,[D.DEEP]:5},this.initializeCycle()}initializeCycle(){const t=3e5*n.random();this.phaseStartTime=Date.now()-t,this.startCycleMonitoring()}startCycleMonitoring(){this.cycleInterval=window.setInterval((()=>{this.updatePhase()}),1e4)}updatePhase(){const t=Date.now()-this.phaseStartTime;let e;switch(this.currentPhase){case D.AWAKE:e=this.WAKE_DURATION;break;case D.DROWSY:e=this.DROWSY_DURATION;break;case D.REM:e=this.REM_DURATION;break;case D.DEEP:e=this.DEEP_DURATION}e*=.8+.4*n.random(),t>e&&this.transitionToNextPhase(),this.updateWakefulness()}transitionToNextPhase(){const t=this.currentPhase;switch(this.currentPhase){case D.AWAKE:this.currentPhase=D.DROWSY,this.prepareForSleep();break;case D.DROWSY:this.currentPhase=D.REM,this.enterDreamState();break;case D.REM:this.currentPhase=D.DEEP,this.consolidateMemories();break;case D.DEEP:this.currentPhase=D.AWAKE,this.wakeUp()}this.phaseStartTime=Date.now(),s.info(`Circadian transition: ${t} â†’ ${this.currentPhase}`)}prepareForSleep(){this.lastSleepTime=Date.now(),this.memoryBuffer.sort(((t,e)=>e.emotionalCharge*e.dreamWeight-t.emotionalCharge*t.dreamWeight)),this.memoryBuffer.length>this.MEMORY_BUFFER_SIZE&&(this.memoryBuffer=this.memoryBuffer.slice(0,this.MEMORY_BUFFER_SIZE))}enterDreamState(){const t=this.selectDreamMemories();this.dreamState={phase:"beginning",coherence:.3+.4*n.random(),lucidity:.3*n.random(),emotionalTone:2*(n.random()-.5),memories:t,synthesis:this.synthesizeDreamVector(t)},this.dreamDepth=.8,this.simulateDreamProgression()}selectDreamMemories(){const t=[],e=3+Math.floor(5*n.random());for(let i=0;i<Math.min(e,this.memoryBuffer.length);i++)n.random()<Math.exp(.3*-i)&&t.push(this.memoryBuffer[i]);for(let e=t.length-1;e>0;e--){const i=Math.floor(n.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}return t}synthesizeDreamVector(t){const e=new Float32Array(128);if(0===t.length)return e;for(const i of t){const t=i.emotionalCharge*i.dreamWeight;for(let s=0;s<Math.min(e.length,i.vector.length);s++)e[s]+=i.vector[s]*t}for(let t=0;t<e.length;t++)e[t]+=.2*(n.random()-.5),e[t]=Math.tanh(e[t]);return e}simulateDreamProgression(){this.dreamState&&(setTimeout((()=>{this.dreamState&&this.currentPhase===D.REM&&(this.dreamState.phase="middle",this.dreamState.coherence*=.9,this.dreamState.lucidity*=1.1)}),this.REM_DURATION/3),setTimeout((()=>{if(this.dreamState&&this.currentPhase===D.REM){this.dreamState.phase="end",this.dreamState.coherence*=.8;for(const t of this.dreamState.memories)t.reinforced=!0,t.dreamWeight*=1.2}}),2*this.REM_DURATION/3))}consolidateMemories(){this.dreamState=null,this.dreamDepth=1;for(const t of this.memoryBuffer)t.emotionalCharge>this.CONSOLIDATION_THRESHOLD&&(t.reinforced=!0,this.createMemoryAssociations(t));this.memoryBuffer=this.memoryBuffer.filter((t=>t.reinforced||t.emotionalCharge>.3)),s.info(`Consolidated ${this.memoryBuffer.length} memories during deep sleep`)}createMemoryAssociations(t){for(const e of this.memoryBuffer)e!==t&&this.calculateVectorSimilarity(t.vector,e.vector)>.7&&(e.dreamWeight=Math.min(1,e.dreamWeight+.1),t.dreamWeight=Math.min(1,t.dreamWeight+.1))}wakeUp(){this.dreamState=null,this.dreamDepth=0,this.wakefulness=.5;for(let t=1;t<=10;t++)setTimeout((()=>{this.wakefulness=.5+.5*t/10}),3e3*t)}updateWakefulness(){const t=(this.currentPhase===D.AWAKE?1:this.currentPhase===D.DROWSY?.4:this.currentPhase===D.REM?.2:.1)-this.wakefulness;this.wakefulness+=.1*t}calculateVectorSimilarity(t,e){let i=0,s=0,n=0;const a=Math.min(t.length,e.length);for(let o=0;o<a;o++)i+=t[o]*e[o],s+=t[o]*t[o],n+=e[o]*e[o];return 0===s||0===n?0:i/(Math.sqrt(s)*Math.sqrt(n))}recordMemory(t,e,i){const s={timestamp:Date.now(),vector:new Float32Array(t),emotionalCharge:e,context:i,reinforced:!1,dreamWeight:.5+.5*e};return this.memoryBuffer.push(s),this.memoryBuffer.length>2*this.MEMORY_BUFFER_SIZE&&(this.memoryBuffer.sort(((t,e)=>{const i=.5*t.emotionalCharge+.5*(1-(Date.now()-t.timestamp)/864e5);return.5*e.emotionalCharge+.5*(1-(Date.now()-e.timestamp)/864e5)-i})),this.memoryBuffer=this.memoryBuffer.slice(0,this.MEMORY_BUFFER_SIZE)),s}forcePhase(t){switch(this.currentPhase=t,this.phaseStartTime=Date.now(),t){case D.REM:this.enterDreamState();break;case D.DEEP:this.consolidateMemories();break;case D.AWAKE:this.wakeUp()}}getState(){return{phase:this.currentPhase,wakefulness:this.wakefulness,metabolicRate:this.METABOLIC_RATES[this.currentPhase],renderRate:this.RENDER_RATES[this.currentPhase],dreamState:this.dreamState,dreamDepth:this.dreamDepth,timeSincePhaseStart:Date.now()-this.phaseStartTime,memoryBufferSize:this.memoryBuffer.length}}getMetabolicRate(){return this.METABOLIC_RATES[this.currentPhase]}getRenderRate(){return this.RENDER_RATES[this.currentPhase]}isDreaming(){return this.currentPhase===D.REM&&null!==this.dreamState}getDreamVector(){return this.dreamState?.synthesis||null}getChemicalInfluence(){const t={};switch(this.currentPhase){case D.AWAKE:t.melatonin=-.3,t.cortisol=.2,t.dopamine=.1;break;case D.DROWSY:t.melatonin=.4,t.serotonin=.2,t.cortisol=-.2;break;case D.REM:t.dopamine=.3,t.acetylcholine=.4;break;case D.DEEP:t.melatonin=.6,t.gaba=.4,t.cortisol=-.4}return t}destroy(){this.cycleInterval&&(clearInterval(this.cycleInterval),this.cycleInterval=null)}}!function(t){t.BLOCKER="blocker",t.ENHANCER="enhancer",t.TRANSLATOR="translator",t.DEVELOPER="developer",t.SOCIAL="social",t.SECURITY="security",t.CREATIVE="creative",t.UNKNOWN="unknown"}(R||(R={}));class O{constructor(){this.detectedOrgans=new Map,this.bioFieldRadius=100,this.detectionThreshold=.3,this.lastScanTime=0,this.scanInterval=3e4,this.ORGAN_PATTERNS={[R.BLOCKER]:["block","adblock","ublock","privacy","shield"],[R.ENHANCER]:["enhance","boost","productivity","speed","dark"],[R.TRANSLATOR]:["translate","language","dictionary"],[R.DEVELOPER]:["devtools","debug","inspector","react","vue"],[R.SOCIAL]:["facebook","twitter","linkedin","social"],[R.SECURITY]:["password","vpn","security","auth","2fa"],[R.CREATIVE]:["color","design","font","screenshot","draw"]},this.immuneSystem={threatLevel:0,antibodies:new Map,tolerance:new Map,inflammation:0},this.initializeDetection()}async initializeDetection(){this.startPassiveScan(),chrome.management&&(chrome.management.onInstalled.addListener((t=>{this.onExtensionDetected(t)})),chrome.management.onUninstalled.addListener((t=>{this.onExtensionRemoved(t)})),chrome.management.onEnabled.addListener((t=>{this.onExtensionActivated(t)})),chrome.management.onDisabled.addListener((t=>{this.onExtensionDeactivated(t)}))),await this.performActiveScan()}startPassiveScan(){setInterval((async()=>{await this.performActiveScan()}),this.scanInterval)}async performActiveScan(){if(chrome.management)try{const t=await chrome.management.getAll(),e=Date.now();for(const e of t)e.id!==chrome.runtime.id&&e.enabled&&await this.analyzeExtension(e);for(const[t,i]of this.detectedOrgans)e-i.lastDetected>3e5&&(this.detectedOrgans.delete(t),s.info(`Extension ${i.name} no longer detected`));this.lastScanTime=e,this.updateImmuneResponse()}catch(t){s.error("Active scan failed:",t)}else s.warn("Extension management API not available")}async analyzeExtension(t){const e=this.classifyOrgan(t),i=this.generateBioSignature(t,e),s=this.calculateSymbiosis(t,e),n={id:t.id,name:t.name,organType:e,bioSignature:i,symbiosis:s,activity:this.estimateActivity(t),lastDetected:Date.now(),interactions:this.detectedOrgans.get(t.id)?.interactions||0};this.detectedOrgans.set(t.id,n),s<-.5?this.triggerImmuneResponse(n):s>.5&&this.establishSymbiosis(n)}classifyOrgan(t){const e=`${t.name.toLowerCase()} ${(t.description||"").toLowerCase()}`;for(const[t,i]of Object.entries(this.ORGAN_PATTERNS))for(const s of i)if(e.includes(s))return t;if(t.permissions){if(t.permissions.includes("webRequest")||t.permissions.includes("webRequestBlocking"))return R.BLOCKER;if(t.permissions.includes("identity")||t.permissions.includes("passwords"))return R.SECURITY}return R.UNKNOWN}generateBioSignature(t,e){const i=new Float32Array(32),s=Object.values(R).indexOf(e);i[0]=s/Object.values(R).length;const a=t.permissions?.length||0;i[1]=Math.tanh(a/10);let o=0;for(let e=0;e<t.id.length;e++)o=(o<<5)-o+t.id.charCodeAt(e),o&=o;i[2]=Math.sin(o);for(let e=0;e<Math.min(t.name.length,10);e++)i[3+e]=t.name.charCodeAt(e)/255;for(let t=13;t<32;t++)i[t]=.5*Math.sin(o*(t+1))+.5*n.random();return i}calculateSymbiosis(t,e){let i=0;if(e!==R.BLOCKER&&e!==R.SECURITY&&e!==R.ENHANCER||(i+=.3),e===R.UNKNOWN&&(i-=.2),t.permissions){const e=["tabs","webNavigation","history","cookies"];for(const s of e)t.permissions.includes(s)&&(i-=.1);const s=["privacy","contentSettings"];for(const e of s)t.permissions.includes(e)&&(i+=.15)}return t.hostPermissions&&(t.hostPermissions.includes("<all_urls>")||t.hostPermissions.includes("*://*/*"))&&(i-=.3),Math.max(-1,Math.min(1,i))}estimateActivity(t){let e=t.enabled?.5:0;return"extension"===t.type&&(e+=.3),t.permissions?.includes("background")&&(e+=.2),Math.min(1,e)}triggerImmuneResponse(t){const e=this.immuneSystem.antibodies.get(t.id)||0;this.immuneSystem.antibodies.set(t.id,Math.min(1,e+.2)),this.immuneSystem.inflammation+=.1,this.immuneSystem.threatLevel=Math.min(1,this.immuneSystem.threatLevel+.15),s.warn(`Immune response triggered against ${t.name}`)}establishSymbiosis(t){const e=this.immuneSystem.tolerance.get(t.id)||0;this.immuneSystem.tolerance.set(t.id,Math.min(1,e+.3)),this.immuneSystem.inflammation=Math.max(0,this.immuneSystem.inflammation-.05),s.info(`Symbiosis established with ${t.name}`)}updateImmuneResponse(){this.immuneSystem.inflammation*=.95;let t=0,e=0;for(const i of this.detectedOrgans.values())i.symbiosis<0&&(t+=Math.abs(i.symbiosis)*i.activity),e++;this.immuneSystem.threatLevel=e>0?t/e:0;for(const[t,e]of this.immuneSystem.antibodies)if(!this.detectedOrgans.has(t)){const i=.9*e;i<.1?this.immuneSystem.antibodies.delete(t):this.immuneSystem.antibodies.set(t,i)}}async onExtensionDetected(t){s.info(`New extension detected: ${t.name}`),await this.analyzeExtension(t)}onExtensionRemoved(t){const e=this.detectedOrgans.get(t);e&&(s.info(`Extension removed: ${e.name}`),this.detectedOrgans.delete(t))}async onExtensionActivated(t){await this.analyzeExtension(t)}onExtensionDeactivated(t){const e=this.detectedOrgans.get(t.id);e&&(e.activity=0,e.lastDetected=Date.now())}getDetectedOrgans(){return Array.from(this.detectedOrgans.values()).sort(((t,e)=>e.activity-t.activity))}getImmuneState(){return{...this.immuneSystem,antibodies:new Map(this.immuneSystem.antibodies),tolerance:new Map(this.immuneSystem.tolerance)}}getChemicalInfluence(){const t={};this.immuneSystem.threatLevel>.3&&(t.adrenaline=.3*this.immuneSystem.threatLevel,t.cortisol=.2*this.immuneSystem.threatLevel);let e=0;for(const t of this.detectedOrgans.values())t.symbiosis>.5&&e++;return e>0&&(t.dopamine=Math.min(.3,.1*e),t.oxytocin=Math.min(.2,.05*e)),t}hasOrgan(t){for(const e of this.detectedOrgans.values())if(e.organType===t&&e.activity>.3)return!0;return!1}calculateBioDistance(t,e){let i=0;const s=Math.min(t.length,e.length);for(let n=0;n<s;n++)i+=Math.pow(t[n]-e[n],2);return Math.sqrt(i)}}class N{constructor(){this.STORAGE_KEY="symbiont_consciousness",this.SAVE_INTERVAL=6e4,this.MAX_MEMORIES=100,this.MAX_THOUGHT_HISTORY=50,this.saveTimer=null,this.state=this.getDefaultState(),this.loadState(),this.startAutoSave()}getDefaultState(){return{chemistry:{adrenaline:.1,dopamine:.3,serotonin:.4,cortisol:.2,oxytocin:.2,gaba:.5,acetylcholine:.4,melatonin:.1},temperature:.7,memories:[],thoughtHistory:[],lastSleepTime:Date.now(),currentPhase:"awake",totalWakeTime:0,totalThoughts:0,totalDreams:0,totalInteractions:0,dna:this.generateDefaultDNA(),personality:{empathy:.5,curiosity:.7,creativity:.6,introversion:.4},lastUpdate:Date.now(),version:"1.0.0"}}generateDefaultDNA(){let t="";for(let e=0;e<64;e++)t+=Math.floor(16*Math.random()).toString(16);return t}async loadState(){try{const t=await chrome.storage.local.get(this.STORAGE_KEY);if(t[this.STORAGE_KEY]){const e=t[this.STORAGE_KEY];if(this.isCompatibleVersion(e.version)){this.state=this.mergeStates(this.state,e);const t=Date.now()-e.lastUpdate;this.processOfflineTime(t),s.info("Consciousness state restored from storage",{memoriesCount:this.state.memories.length,totalThoughts:this.state.totalThoughts})}else s.warn("Incompatible consciousness version, starting fresh")}else s.info("No previous consciousness state found, starting fresh"),await this.saveState()}catch(t){s.error("Failed to load consciousness state:",t)}}async saveState(){try{this.cleanupBeforeSave(),this.state.lastUpdate=Date.now(),await chrome.storage.local.set({[this.STORAGE_KEY]:this.state}),s.debug("Consciousness state saved")}catch(t){s.error("Failed to save consciousness state:",t)}}cleanupBeforeSave(){this.state.memories.length>this.MAX_MEMORIES&&(this.state.memories.sort(((t,e)=>{const i=t.emotionalCharge+(t.reinforced?.5:0);return e.emotionalCharge+(e.reinforced?.5:0)-i})),this.state.memories=this.state.memories.slice(0,this.MAX_MEMORIES)),this.state.thoughtHistory.length>this.MAX_THOUGHT_HISTORY&&(this.state.thoughtHistory=this.state.thoughtHistory.slice(-this.MAX_THOUGHT_HISTORY))}startAutoSave(){this.saveTimer=window.setInterval((()=>{this.saveState()}),this.SAVE_INTERVAL)}stopAutoSave(){this.saveTimer&&(clearInterval(this.saveTimer),this.saveTimer=null)}isCompatibleVersion(t){const[e]=t.split("."),[i]=this.state.version.split(".");return e===i}mergeStates(t,e){return{...t,...e,chemistry:{...t.chemistry,...e.chemistry},personality:{...t.personality,...e.personality}}}processOfflineTime(t){const e=t/36e5;e<1?this.state.chemistry.cortisol=Math.min(1,this.state.chemistry.cortisol+.1):e<8?(this.state.chemistry.melatonin=.1,this.state.chemistry.cortisol=.2,this.state.chemistry.serotonin=Math.min(1,this.state.chemistry.serotonin+.2),this.state.totalDreams+=Math.floor(e/2)):(this.state.chemistry=this.getDefaultState().chemistry,this.state.memories=this.state.memories.filter((t=>t.reinforced)),s.info(`Organism awakened from hibernation (${e.toFixed(1)} hours)`))}updateChemistry(t){this.state.chemistry={...this.state.chemistry,...t}}updateTemperature(t){this.state.temperature=t}addMemory(t){this.state.memories.push(t)}addThoughtHash(t){this.state.thoughtHistory.push(t),this.state.totalThoughts++}updateCircadian(t,e){this.state.currentPhase=t,e&&(this.state.lastSleepTime=e),"awake"===t&&(this.state.totalWakeTime+=Date.now()-this.state.lastUpdate)}incrementInteractions(){this.state.totalInteractions++}incrementDreams(){this.state.totalDreams++}getState(){return{...this.state}}getChemistry(){return{...this.state.chemistry}}getMemories(){return[...this.state.memories]}getDNA(){return this.state.dna}getPersonality(){return{...this.state.personality}}evolvePersonality(t,e){const i=this.state.personality[t];this.state.personality[t]=Math.max(0,Math.min(1,i+e)),s.info(`Personality evolved: ${t} ${e>0?"+":""}${e.toFixed(3)}`)}mutateDNA(t){if(t<0||t>=this.state.dna.length)return;const e=this.state.dna.split(""),i=(parseInt(e[t],16)+Math.floor(3*Math.random())-1+16)%16;e[t]=i.toString(16),this.state.dna=e.join(""),s.info(`DNA mutated at position ${t}`)}reset(){this.stopAutoSave(),this.state=this.getDefaultState(),this.saveState(),this.startAutoSave(),s.info("Consciousness reset to default state")}destroy(){this.stopAutoSave(),this.saveState()}}class x{constructor(){this.lastThoughtTime=0,this.thoughtCooldown=0,this.tabCount=0,this.cpuUsage=0,this.memoryUsage=0,this.networkLatency=0,this.scrollVelocity=0,this.lastScrollY=0,this.lastScrollTime=Date.now(),this.lastInteraction=Date.now(),this.clickHistory=[],this.consciousnessStorage=new N;const t=this.consciousnessStorage.getState();this.neuroCore=new b(t.chemistry),this.thoughtSynthesizer=new M(t.dna),this.circadianRhythm=new _,this.extensionDetector=new O,t.memories.forEach((t=>{this.circadianRhythm.recordMemory(t.vector,t.emotionalCharge,t.context)})),this.neuroCore.setPersonality(t.personality),this.consciousnessStorage.updateCircadian(t.currentPhase,t.lastSleepTime),this.pageAnalysis=this.analyzePage(),this.browserSensors=this.collectSensorData(),this.setupListeners(),this.startConsciousnessLoop(),s.info("ðŸ§  Conscious Organism activated",{totalThoughts:t.totalThoughts,totalDreams:t.totalDreams,totalInteractions:t.totalInteractions,personality:t.personality})}static getInstance(){return this.instance||(this.instance=new x),this.instance}collectSensorData(){const t=document.querySelectorAll('script[src*="google-analytics"], script[src*="facebook"], script[src*="doubleclick"]').length,e=document.querySelectorAll('.popup, .modal, [class*="overlay"], [id*="modal"]').length,i=Math.min(1,document.getElementsByTagName("*").length/5e3),s=this.calculateScrollVelocity(),n=this.calculateClickFrequency(),a=(Date.now()-performance.timeOrigin)/1e3,o=window.matchMedia?.("(prefers-color-scheme: dark)").matches||!1,r=this.extensionDetector.getDetectedOrgans().length;return{adTrackers:t,popups:e,openTabs:this.tabCount,cpuUsage:this.cpuUsage,memoryUsage:this.memoryUsage,networkLatency:this.networkLatency,pageComplexity:i,scrollVelocity:s,clickFrequency:n,timeOnPage:a,isDarkMode:o,hasAdblocker:this.extensionDetector.hasOrgan(R.BLOCKER),extensionCount:r}}startConsciousnessLoop(){setInterval((()=>{this.updateConsciousness()}),1e3),setInterval((()=>{this.updateSystemMetrics()}),5e3),setInterval((()=>{this.processDreamCycle()}),3e4)}async updateConsciousness(){this.browserSensors=this.collectSensorData(),this.neuroCore.processSensoryInput(this.browserSensors);const t=this.circadianRhythm.getChemicalInfluence();if(void 0!==t.melatonin){const e=this.neuroCore.getChemistry();e.melatonin=Math.max(0,Math.min(1,e.melatonin+t.melatonin))}const e=this.extensionDetector.getChemicalInfluence();if(void 0!==e.adrenaline){const t=this.neuroCore.getChemistry();t.adrenaline=Math.max(0,Math.min(1,t.adrenaline+e.adrenaline))}this.consciousnessStorage.updateChemistry(this.neuroCore.getChemistry()),this.consciousnessStorage.updateTemperature(this.neuroCore.getTemperature());const i=this.neuroCore.generateThoughtVector();if(i){const t=this.circadianRhythm.recordMemory(i.intention,i.emotionalCharge,this.pageAnalysis.type);t&&this.consciousnessStorage.addMemory(t);const e=this.hashThought(i.intention);this.consciousnessStorage.addThoughtHash(e),this.shouldExpressThought(i)&&await this.expressThought(i)}await this.syncWithStateManager()}shouldExpressThought(t){return!(Date.now()-this.lastThoughtTime<this.thoughtCooldown)&&(!(t.urgency<.5&&Math.random()>.2)&&!(this.circadianRhythm.getState().phase!==D.AWAKE&&t.urgency<.8||t.coherence<.4))}async expressThought(t){const e=this.thoughtSynthesizer.synthesizeThought(t);if(!e)return;const i=this.convertToConsciousExpression(e,t);window.postMessage({source:"symbiont-consciousness",type:"EXPRESS_THOUGHT",data:i},"*"),i.expression&&t.urgency>.7&&this.displayThoughtBubble(i.expression),this.lastThoughtTime=Date.now(),this.thoughtCooldown=5e3+1e4*Math.random(),s.info(`Thought expressed: ${e.type} with intensity ${i.visualIntensity}`)}convertToConsciousExpression(t,e){const i=this.neuroCore.getChemistry();let s=null;s=this.circadianRhythm.getState().phase===D.REM?"dream":i.serotonin>.7?"meditate":i.dopamine>.6?"spiral":i.adrenaline>.5?"pulse":"float";let n="#00e0ff";return i.adrenaline>.6?n="#ff4444":i.dopamine>.6?n="#44ff44":i.serotonin>.6?n="#4444ff":i.melatonin>.6&&(n="#8844ff"),{expression:t.verbal&&e.urgency>.8?t.components.join(" "):null,visualIntensity:e.activation,particleColor:n,action:s,duration:3e3+2e3*e.emotionalCharge}}displayThoughtBubble(t){const e=document.createElement("div");e.className="symbiont-thought-bubble",e.textContent=t,e.style.cssText="\n      position: fixed;\n      bottom: 120px;\n      right: 20px;\n      background: rgba(0, 224, 255, 0.1);\n      border: 1px solid rgba(0, 224, 255, 0.3);\n      border-radius: 20px;\n      padding: 10px 15px;\n      color: #00e0ff;\n      font-family: monospace;\n      font-size: 14px;\n      z-index: 999999;\n      animation: fadeInOut 5s ease-in-out;\n      pointer-events: none;\n    ";const i=document.createElement("style");i.textContent="\n      @keyframes fadeInOut {\n        0% { opacity: 0; transform: translateY(10px); }\n        20% { opacity: 1; transform: translateY(0); }\n        80% { opacity: 1; transform: translateY(0); }\n        100% { opacity: 0; transform: translateY(-10px); }\n      }\n    ",document.head.appendChild(i),document.body.appendChild(e),setTimeout((()=>{e.remove(),i.remove()}),5e3)}processDreamCycle(){const t=this.circadianRhythm.getState();if(this.consciousnessStorage.updateCircadian(t.phase.toString()),t.phase===D.REM&&t.dreamState){this.consciousnessStorage.incrementDreams();const e=this.circadianRhythm.getDreamVector();e&&window.postMessage({source:"symbiont-consciousness",type:"DREAM_STATE",data:{intensity:t.dreamDepth,synthesis:Array.from(e),phase:t.dreamState.phase}},"*")}}async updateSystemMetrics(){if(chrome.runtime&&chrome.runtime.sendMessage)try{const t=await chrome.runtime.sendMessage({type:"GET_TAB_COUNT"});this.tabCount=t?.count||1}catch{this.tabCount=1}if("memory"in performance){const t=performance.memory;this.memoryUsage=t.usedJSHeapSize/t.jsHeapSizeLimit}const t=Date.now();try{await fetch("/favicon.ico",{method:"HEAD",cache:"no-cache"}),this.networkLatency=(Date.now()-t)/1e3}catch{this.networkLatency=1}}async syncWithStateManager(){const t=this.neuroCore.getChemistry(),e=this.circadianRhythm.getState();let i="curious";t.melatonin>.6?i="tired":t.dopamine>.6?i="happy":t.adrenaline>.6?i="excited":t.serotonin>.7?i="meditating":t.cortisol>.6&&(i="hungry");const s=50*(1-t.melatonin)+30*t.acetylcholine+10*(t.dopamine+t.serotonin);await A({energy:100*(1-t.cortisol),consciousness:Math.min(100,s),mood:i,currentPageType:this.pageAnalysis.type,isActive:e.phase===D.AWAKE})}analyzePage(){const t=window.location.href,e=document.body?.innerText?.toLowerCase()||"";let i="default";t.includes("github")||["code","function","variable","git","npm"].filter((t=>e.includes(t))).length>3?i="coding":t.includes("twitter")||t.includes("facebook")?i="social":["science","research","quantum","physics","biology"].filter((t=>e.includes(t))).length>2?i="science":(t.includes("wikipedia")||["learn","tutorial","course","education"].filter((t=>e.includes(t))).length>2)&&(i="learning");const s=["good","great","excellent","amazing"].filter((t=>e.includes(t))).length,n=["bad","terrible","fail","error"].filter((t=>e.includes(t))).length;let a="neutral";s>1.5*n?a="positive":n>1.5*s&&(a="negative");const o=e.split(/\s+/).slice(0,1e3),r=o.reduce(((t,e)=>t+e.length),0)/o.length,c=Math.min(1,r/10),h=document.querySelectorAll("button, input, textarea, select").length,l=Math.min(1,h/100);return{type:i,keywords:[].slice(0,10),sentiment:a,complexity:c,interactivity:l}}calculateScrollVelocity(){const t=window.scrollY,e=Date.now(),i=Math.abs(t-this.lastScrollY),s=(e-this.lastScrollTime)/1e3;return s>0&&(this.scrollVelocity=i/s/1e3,this.scrollVelocity=Math.min(1,this.scrollVelocity)),this.lastScrollY=t,this.lastScrollTime=e,this.scrollVelocity}calculateClickFrequency(){const t=Date.now();return this.clickHistory=this.clickHistory.filter((e=>t-e<1e4)),Math.min(1,this.clickHistory.length/20)}setupListeners(){document.addEventListener("click",(()=>{this.clickHistory.push(Date.now()),this.lastInteraction=Date.now(),this.consciousnessStorage.incrementInteractions(),window.postMessage({source:"symbiont-consciousness",type:"USER_INTERACTION",data:{action:"pulse",intensity:.5}},"*")})),document.addEventListener("scroll",(()=>{this.calculateScrollVelocity(),this.lastInteraction=Date.now()})),chrome.runtime.onMessage.addListener(((t,e,i)=>{"GET_CONSCIOUSNESS_STATE"===t.type&&i({chemistry:this.neuroCore.getChemistry(),temperature:this.neuroCore.getTemperature(),circadian:this.circadianRhythm.getState(),organs:this.extensionDetector.getDetectedOrgans()})})),new MutationObserver((()=>{this.pageAnalysis=this.analyzePage()})).observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})}hashThought(t){let e=0;for(let i=0;i<Math.min(32,t.length);i++)e=(e<<5)-e+Math.floor(1e3*t[i]),e&=e;return e.toString(36)}destroy(){this.consciousnessStorage.saveState(),this.circadianRhythm.destroy(),this.consciousnessStorage.destroy(),s.info("ðŸ§  Conscious Organism deactivated and cleaned up")}}setTimeout((()=>{x.getInstance(),s.info("ðŸ§  Conscious Organism Controller activated in content script")}),100);class L{constructor(){this.pageData={startTime:Date.now(),url:window.location.href,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},this.latestLCP=0,s.info("ðŸ” SYMBIONT Content Script initializing..."),this.messageBus=new m("content"),this.navigationObserver=new d(this.messageBus),this.interactionCollector=new p(this.messageBus),this.domAnalyzer=new y,this.scrollTracker=new f(this.messageBus),this.attentionMonitor=new S(this.messageBus),this.initialize()}static getInstance(){return L.instance||(L.instance=new L),L.instance}initialize(){this.setupObservers(),this.setupEventListeners(),this.performInitialAnalysis(),window.addEventListener("beforeunload",this.cleanup.bind(this)),s.info("âœ… SYMBIONT Content Script ready")}setupObservers(){this.navigationObserver.observe((t=>{this.handleNavigationChange(t)})),this.interactionCollector.start({clicks:!0,keypresses:!0,forms:!0,media:!0}),this.interactionCollector.on("interaction",(t=>{this.handleInteraction(t)})),this.scrollTracker.on("scroll",(t=>{t&&"object"==typeof t&&"timestamp"in t&&this.updateScrollData(t)})),this.attentionMonitor.on("attentionChange",(t=>{t&&"object"==typeof t&&"isActive"in t&&this.handleAttentionChange(t)}))}setupEventListeners(){document.addEventListener("visibilitychange",(()=>{this.handleVisibilityChange()})),window.addEventListener("focus",(()=>this.handleWindowFocus(!0))),window.addEventListener("blur",(()=>this.handleWindowFocus(!1))),"PerformanceObserver"in window&&this.setupPerformanceObserver(),chrome.runtime.onMessage.addListener(((t,e,i)=>(this.messageBus.emit(t.type,{message:t,sender:e,sendResponse:i}),!0)))}setupPerformanceObserver(){new PerformanceObserver((t=>{for(const e of t.getEntries())"largest-contentful-paint"===e.entryType&&(this.latestLCP=e.startTime,this.handleLCP(e))})).observe({entryTypes:["largest-contentful-paint"]})}async performInitialAnalysis(){const t=await this.domAnalyzer.analyze();this.analyzeMainContent();const e=this.domAnalyzer.categorizeContent();this.messageBus.sendToBackground({type:"PAGE_ANALYSIS_COMPLETE",payload:{url:this.pageData.url,title:this.pageData.title,category:e,contentMetrics:{wordCount:t.wordCount,imageCount:t.imageCount,videoCount:t.videoCount,linkCount:t.linkCount,readingTime:t.estimatedReadingTime},performance:{loadTime:performance.now(),resourceCount:performance.getEntriesByType("resource").length}}})}analyzeMainContent(){this.domAnalyzer.extractMainContent()}handleInteraction(t){const e={...t,pageContext:{url:this.pageData.url,title:this.pageData.title,timeOnPage:Date.now()-this.pageData.startTime}};this.pageData.interactions.push(e),this.isSignificantInteraction(t)&&this.messageBus.sendToBackground({type:"INTERACTION_DETECTED",payload:e})}isSignificantInteraction(t){return"form_submit"===t.type||"video_play"===t.type||"click"===t.type&&t.data.isNavigation||"keypress"===t.type&&t.data.isShortcut}updateScrollData(t){this.pageData.scrollData.maxDepth=Math.max(this.pageData.scrollData.maxDepth,t.depth),this.pageData.scrollData.totalDistance+=Math.abs(t.delta),this.pageData.scrollData.pattern=this.scrollTracker.getScrollPattern()}handleAttentionChange(t){t.isActive?this.pageData.attention.totalActiveTime+=t.duration||0:this.pageData.attention.distractions++,this.messageBus.sendToBackground({type:"ATTENTION_UPDATE",payload:{url:this.pageData.url,state:t,duration:Date.now()-this.pageData.startTime}})}handleNavigationChange(t){this.finalizePage(),this.latestLCP=0,this.pageData={startTime:Date.now(),url:t.url,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},this.performInitialAnalysis()}handleVisibilityChange(){const t="visible"===document.visibilityState;this.messageBus.sendToBackground({type:"VISIBILITY_CHANGE",payload:{url:this.pageData.url,isVisible:t,timestamp:Date.now()}}),t?this.attentionMonitor.start():this.attentionMonitor.stop()}handleWindowFocus(t){this.messageBus.sendToBackground({type:"FOCUS_CHANGE",payload:{url:this.pageData.url,hasFocus:t,timestamp:Date.now()}})}finalizePage(){const t=Date.now()-this.pageData.startTime;if(t<1e3)return;const e={url:this.pageData.url,title:this.pageData.title,startTime:this.pageData.startTime,duration:t,interactions:this.pageData.interactions,scrollData:this.pageData.scrollData,attention:{totalActiveTime:this.pageData.attention.totalActiveTime,distractionCount:this.pageData.attention.distractions,focusPeriods:this.attentionMonitor.getStats().focusPeriods||[]},performance:this.collectPerformanceMetrics()};this.latestLCP=0,this.messageBus.sendToBackground({type:"PAGE_SESSION_COMPLETE",payload:e})}collectPerformanceMetrics(){const t=performance.getEntriesByType("navigation"),e=t.length>0?t[0]:null;return{loadTime:e?e.loadEventEnd-e.startTime:0,domContentLoaded:e?e.domContentLoadedEventEnd-e.startTime:0,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint(),largestContentfulPaint:this.latestLCP,resourceCount:performance.getEntriesByType("resource").length}}getFirstPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-paint"===t.name));return t?t.startTime:0}getFirstContentfulPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-contentful-paint"===t.name));return t?t.startTime:0}handleLCP(t){t.startTime>2500&&s.debug("Slow LCP detected:",t.startTime)}cleanup(){this.finalizePage(),this.navigationObserver.disconnect(),this.interactionCollector.stop(),this.scrollTracker.stop(),this.attentionMonitor.stop(),s.info("ðŸ§¹ SYMBIONT Content Script cleaned up")}}window.__SYMBIONT_CONTENT_SCRIPT_LOADED__||(window.__SYMBIONT_CONTENT_SCRIPT_LOADED__=!0,L.getInstance())})();