(()=>{"use strict";var t,e;!function(t){t.PAGE_VISIT="PAGE_VISIT",t.SCROLL_EVENT="SCROLL_EVENT",t.ORGANISM_UPDATE="ORGANISM_UPDATE",t.ORGANISM_MUTATE="ORGANISM_MUTATE",t.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",t.WEBGL_INIT="WEBGL_INIT",t.WEBGL_ERROR="WEBGL_ERROR",t.WEBGL_INITIALIZED="WEBGL_INITIALIZED",t.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",t.GENERATE_INVITATION="GENERATE_INVITATION",t.INVITATION_GENERATED="INVITATION_GENERATED",t.CONSUME_INVITATION="CONSUME_INVITATION",t.INVITATION_CONSUMED="INVITATION_CONSUMED",t.CHECK_INVITATION="CHECK_INVITATION",t.INVITATION_CHECKED="INVITATION_CHECKED",t.MURMUR="MURMUR",t.GET_INVITER="GET_INVITER",t.INVITER_RESULT="INVITER_RESULT",t.GET_INVITEES="GET_INVITEES",t.INVITEES_RESULT="INVITEES_RESULT",t.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",t.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",t.INTERACTION_DETECTED="INTERACTION_DETECTED",t.GET_HEALTH_METRICS="GET_HEALTH_METRICS",t.HEALTH_METRICS_RESPONSE="HEALTH_METRICS_RESPONSE",t.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",t.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",t.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",t.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",t.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",t.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",t.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",t.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",t.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED",t.GET_ORGANISM="GET_ORGANISM"}(t||(t={})),function(t){t[t.TRACE=0]="TRACE",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.FATAL=5]="FATAL"}(e||(e={}));class i{constructor(t={}){this.logEntries=[],this.config={level:e.INFO,enableConsole:!this.isProduction(),enableStorage:!0,maxStorageEntries:1e3,sensitiveFields:["password","token","key","secret","auth"],productionMode:this.isProduction(),...t}}static getInstance(t){return i.instance||(i.instance=new i(t)),i.instance}isProduction(){return!0}sanitizeData(t){if("string"==typeof t)return this.sanitizeString(t);if("object"==typeof t&&null!==t){if(Array.isArray(t))return t.map((t=>this.sanitizeData(t)));const e={};for(const[i,s]of Object.entries(t))this.isSensitiveField(i)?e[i]="[REDACTED]":e[i]=this.sanitizeData(s);return e}return t}sanitizeString(t){let e=t;for(const t of i.SENSITIVE_PATTERNS)e=e.replace(t,"[REDACTED]");return e}isSensitiveField(t){return this.config.sensitiveFields.some((e=>t.toLowerCase().includes(e.toLowerCase())))}formatMessage(t,i,s,n){return`[${(new Date).toISOString()}] ${e[t]}${n?` [${n}]`:""}: ${i}${s?` ${JSON.stringify(s,null,2)}`:""}`}shouldLog(t){return t>=this.config.level}log(t,i,s,n){if(!this.shouldLog(t))return;const a=s?this.sanitizeData(s):void 0,o=this.sanitizeString(i),r={timestamp:Date.now(),level:t,message:o,data:a,context:n,sanitized:!0};if(this.config.enableStorage&&(this.logEntries.push(r),this.logEntries.length>this.config.maxStorageEntries&&(this.logEntries=this.logEntries.slice(-this.config.maxStorageEntries))),this.config.enableConsole){const i=this.formatMessage(t,o,a,n);switch(t){case e.TRACE:case e.DEBUG:console.debug(i);break;case e.INFO:console.info(i);break;case e.WARN:console.warn(i);break;case e.ERROR:case e.FATAL:console.error(i)}}}trace(t,i,s){this.log(e.TRACE,t,i,s)}debug(t,i,s){this.log(e.DEBUG,t,i,s)}info(t,i,s){this.log(e.INFO,t,i,s)}warn(t,i,s){this.log(e.WARN,t,i,s)}error(t,i,s){this.log(e.ERROR,t,i,s)}fatal(t,i,s){this.log(e.FATAL,t,i,s)}setLevel(t){this.config.level=t}enableConsole(t){this.config.enableConsole=t}getLogs(t){return void 0!==t?this.logEntries.filter((e=>e.level>=t)):[...this.logEntries]}clearLogs(){this.logEntries=[]}exportLogs(){return JSON.stringify(this.logEntries,null,2)}}i.SENSITIVE_PATTERNS=[/password/i,/token/i,/key/i,/secret/i,/auth/i,/credential/i,/session/i,/cookie/i,/jwt/i,/bearer/i,/api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/private[_-]?key/i,/\b[A-Za-z0-9+/]{32,}={0,2}\b/,/\b[0-9a-f]{32,}\b/i,/\b[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}\b/,/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/];const s=i.getInstance();s.info.bind(s),s.warn.bind(s),s.error.bind(s),s.debug.bind(s);class n{static random(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint32Array(1);return crypto.getRandomValues(t),t[0]/(this.MAX_UINT32+1)}const t=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random numbers.");throw s.error("SecureRandom: CRITICAL SECURITY FAILURE",t),t}static randomInt(t,e){if(t>=e)throw new Error("SecureRandom: min doit Ãªtre infÃ©rieur Ã  max");const i=e-t;return Math.floor(this.random()*i)+t}static randomFloat(t,e){if(t>=e)throw new Error("SecureRandom: min doit Ãªtre infÃ©rieur Ã  max");return this.random()*(e-t)+t}static randomBytes(t){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(t);return crypto.getRandomValues(e),e}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random bytes.");throw s.error("SecureRandom: CRITICAL SECURITY FAILURE in randomBytes",e),e}static choice(t){if(0===t.length)throw new Error("SecureRandom: Le tableau ne peut pas Ãªtre vide");return t[this.randomInt(0,t.length)]}static uuid(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;const e=Array.from(t,(t=>t.toString(16).padStart(2,"0"))).join("");return[e.slice(0,8),e.slice(8,12),e.slice(12,16),e.slice(16,20),e.slice(20,32)].join("-")}const t=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure UUID.");throw s.error("SecureRandom: CRITICAL SECURITY FAILURE in uuid",t),t}static randomString(t,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let i="";for(let s=0;s<t;s++)i+=e.charAt(this.randomInt(0,e.length));return i}static randomId(t="",e=8){const i=this.randomString(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return t?`${t}_${i}`:i}}function a(){if("undefined"!=typeof crypto&&crypto.randomUUID)try{return crypto.randomUUID()}catch(t){s.warn("crypto.randomUUID failed, using fallback",{error:t})}return n.uuid()}function o(t){return t&&"object"==typeof t?r(t):t}function r(t,e=new WeakSet){if(null==t)return t;if("function"==typeof t)return"[Function]";if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if(t instanceof WebGLRenderingContext||t instanceof WebGL2RenderingContext||t instanceof HTMLElement||t instanceof HTMLCanvasElement||t instanceof CanvasRenderingContext2D||t instanceof WebGLProgram||t instanceof WebGLBuffer||t instanceof WebGLTexture||t&&t.$$typeof||t&&t.__reactFiber||t&&t._owner||t&&"object"==typeof t&&t.constructor&&t.constructor.name&&t.constructor.name.includes("Fiber"))return t instanceof HTMLCanvasElement?{tagName:"CANVAS",width:t.width,height:t.height,className:t.className,id:t.id}:"[Non-serializable Object]";if("object"!=typeof t)return t;if(e.has(t))return"[Circular Reference]";if(e.add(t),Array.isArray(t))return t.map((t=>r(t,e)));const i={};for(const s in t)if(t.hasOwnProperty(s))try{i[s]=r(t[s],e)}catch(t){i[s]="[Non-serializable]"}return i}function c(t){return"object"==typeof t&&null!==t&&"code"in t&&"string"==typeof t.code&&"status"in t&&"string"==typeof t.status}function l(t){try{return JSON.parse(JSON.stringify(t))}catch(e){return s.warn("Message serialization issue, cleaning object:",e),h(t)}}function h(t,e=new WeakSet){if(null==t)return t;if("function"==typeof t)return"[Function]";if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if(t instanceof WebGLRenderingContext||t instanceof WebGL2RenderingContext||t instanceof HTMLElement||t instanceof HTMLCanvasElement||t instanceof CanvasRenderingContext2D||t instanceof WebGLProgram||t instanceof WebGLBuffer||t instanceof WebGLTexture||t&&t.$$typeof||t&&t.__reactFiber||t&&t._owner||t&&"object"==typeof t&&t.constructor&&t.constructor.name&&t.constructor.name.includes("Fiber"))return"[Non-serializable Object]";if("object"!=typeof t)return t;if(e.has(t))return"[Circular Reference]";if(e.add(t),Array.isArray(t))return t.map((t=>h(t,e)));const i={};for(const s in t)if(t.hasOwnProperty(s))try{i[s]=h(t[s],e)}catch(t){i[s]="[Non-serializable]"}return i}n.MAX_UINT32=4294967295,n.random,n.randomInt,n.randomFloat;class d{constructor(t){this.source=t,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){"undefined"!=typeof chrome&&chrome.runtime?chrome.runtime.onMessage.addListener(((t,e,i)=>(this.shouldProcessMessage(t)&&(this.enqueueMessage(t),i({received:!0})),!1))):s.warn("[MessageBus] Chrome runtime non disponible - mode test/dÃ©veloppement")}shouldProcessMessage(t){return this.filters.every((e=>e(t)))}async enqueueMessage(t){if(this.messageQueue.push(t),!this.processing){this.processing=!0;try{await this.processQueue()}finally{this.processing=!1}}}async processQueue(){for(;this.messageQueue.length>0;){const t=this.messageQueue.shift();await this.processMessage(t)}}async processMessage(e){if(!function(e,i){switch(e){case t.ORGANISM_UPDATE:return"object"==typeof(s=i)&&null!==s&&"id"in s&&"string"==typeof s.id&&"generation"in s&&"number"==typeof s.generation&&"health"in s&&"number"==typeof s.health&&"energy"in s&&"number"==typeof s.energy&&"traits"in s&&"object"==typeof s.traits;case t.ORGANISM_MUTATE:return function(t){return"object"==typeof t&&null!==t&&"type"in t&&"string"==typeof t.type&&"trigger"in t&&"string"==typeof t.trigger}(i);case t.PAGE_VISIT:case t.SCROLL_EVENT:return function(t){return t&&"string"==typeof t.url&&"number"==typeof t.visitCount}(i);case t.MURMUR:return function(t){return"object"==typeof t&&null!==t&&"text"in t&&"string"==typeof t.text&&"timestamp"in t&&"number"==typeof t.timestamp}(i);case t.GENERATE_INVITATION:case t.CONSUME_INVITATION:case t.CHECK_INVITATION:return function(t){return"object"==typeof t&&null!==t&&"code"in t&&"string"==typeof t.code}(i);case t.INVITATION_GENERATED:return"string"==typeof i||c(i);case t.INVITATION_CONSUMED:case t.INVITATION_CHECKED:return c(i);case t.SHARED_MUTATION_RESULT:return"string"==typeof i||i&&"object"==typeof i;default:return!0}var s}(e.type,e.payload))return void s.warn(`[MessageBus] Payload non valide pour le type ${e.type}`,e.payload);for(const t of this.globalHandlers)try{await t(e)}catch(t){s.error("Error in global handler:",t)}const i=this.handlers.get(e.type);if(i)for(const t of i)try{await t(e)}catch(t){s.error(`Error in handler for ${e.type}:`,t)}}on(t,e){this.handlers.has(t)||this.handlers.set(t,new Set),this.handlers.get(t).add(e)}off(t,e){const i=this.handlers.get(t);i&&i.delete(e)}onAny(t){this.globalHandlers.add(t)}offAny(t){this.globalHandlers.delete(t)}addFilter(t){this.filters.push(t)}async send(t){const e={...t,source:this.source,timestamp:Date.now(),id:a()};if("undefined"!=typeof chrome&&chrome.runtime)try{const t=l(o(e));if("content"===this.source)await chrome.runtime.sendMessage(t);else{const e=await chrome.tabs.query({}),i=t=>t.active||t.url&&t.url.includes("symbiont"),s=e.filter(i);for(const e of s)e.id&&chrome.tabs.sendMessage(e.id,t).catch((()=>{}));chrome.runtime.sendMessage(t).catch((()=>{}))}}catch(t){s.error("Error sending message:",t)}else s.warn("[MessageBus] Chrome runtime non disponible - message non envoyÃ©:",e.type)}sendToBackground(t){this.send(t)}emit(t,e){const i=this.handlers.get(t);i&&i.forEach((i=>i({type:t,payload:e})))}handleMessage(t,e){s.info("Handling message:",t)}onMessage(t,e,i){return s.info("Received message:",t),!0}sendToFrame(t,e,i){s.info("Sending to frame:",e,i)}}class u{constructor(t){this._handler=null}observe(t){this._handler=t}disconnect(){this._handler=null}}function g(t){return t&&0!==t.length?t.reduce(((t,e)=>t+e),0)/t.length:0}function m(t){if(!t)return[];if(!(t instanceof Element))return[];if(!t.className||"string"!=typeof t.className)return[];try{return t.className.split(" ").filter((t=>t&&t.length>0))}catch{return[]}}class p extends EventTarget{constructor(t){super(),this.isActive=!1,this.eventBuffer=[],this.lastFlushTime=0,this.eventCounts=new Map,this.lastEventTimes=new Map,this.mousePosition={x:0,y:0},this.lastClickTime=0,this.clickSequence=0,this.keySequence="",this.formInteractions=new Map,this.messageBus=t||null,this.config={clicks:!0,keypresses:!0,forms:!0,media:!0,hover:!0,selection:!0,contextmenu:!0,debounceMs:100,maxEventsPerSecond:20},this.setupEventListeners()}setupEventListeners(){document.addEventListener("mousemove",this.handleMouseMove.bind(this),{passive:!0}),document.addEventListener("mouseenter",this.handleMouseEnter.bind(this),{passive:!0}),document.addEventListener("mouseleave",this.handleMouseLeave.bind(this),{passive:!0}),this.config.clicks&&(document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("dblclick",this.handleDoubleClick.bind(this),!0)),this.config.keypresses&&(document.addEventListener("keydown",this.handleKeyDown.bind(this),!0),document.addEventListener("keyup",this.handleKeyUp.bind(this),!0)),this.config.forms&&(document.addEventListener("submit",this.handleFormSubmit.bind(this),!0),document.addEventListener("focus",this.handleFormFocus.bind(this),!0),document.addEventListener("blur",this.handleFormBlur.bind(this),!0),document.addEventListener("change",this.handleFormChange.bind(this),!0),document.addEventListener("input",this.handleFormInput.bind(this),!0)),this.config.media&&(document.addEventListener("play",this.handleMediaPlay.bind(this),!0),document.addEventListener("pause",this.handleMediaPause.bind(this),!0),document.addEventListener("ended",this.handleMediaEnded.bind(this),!0)),this.config.selection&&(document.addEventListener("selectstart",this.handleSelectionStart.bind(this),!0),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this),!0)),this.config.contextmenu&&document.addEventListener("contextmenu",this.handleContextMenu.bind(this),!0),setInterval((()=>this.flushEvents()),1e3)}handleMouseMove(t){this.mousePosition={x:t.clientX,y:t.clientY}}handleMouseEnter(t){this.config.hover&&this.recordInteraction({type:"hover",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"enter",duration:0},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleMouseLeave(t){this.config.hover&&this.recordInteraction({type:"hover",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"leave",duration:0},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleClick(t){const e=Date.now();e-this.lastClickTime<500?this.clickSequence++:this.clickSequence=1,this.lastClickTime=e;const i=t.target,s=this.isNavigationClick(i),n=this.isInteractiveElement(i);this.recordInteraction({type:"click",timestamp:e,target:this.getElementSelector(i),data:{button:t.button,clickSequence:this.clickSequence,isNavigation:s,isInteractive:n,modifiers:{ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey}},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(i)})}handleDoubleClick(t){this.recordInteraction({type:"click",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{isDoubleClick:!0,button:t.button},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}handleKeyDown(t){1===t.key.length&&(this.keySequence+=t.key,this.keySequence.length>20&&(this.keySequence=this.keySequence.slice(-20)));const e=t.ctrlKey||t.metaKey||t.altKey,i=["Enter","Tab","Escape","Backspace","Delete"].includes(t.key);(e||i)&&this.recordInteraction({type:"keypress",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{key:t.key,keyCode:t.keyCode,isShortcut:e,isSpecialKey:i,modifiers:{ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey},sequence:this.keySequence.slice(-5)},element:this.extractElementInfo(t.target)})}handleKeyUp(t){"Tab"===t.key&&this.recordInteraction({type:"keypress",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{key:t.key,action:"tab_navigation"},element:this.extractElementInfo(t.target)})}handleFormSubmit(t){const e=t.target,i=new FormData(e),s=this.formInteractions.get(this.getElementSelector(e))||{};this.recordInteraction({type:"form_submit",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:e.action,method:e.method,fieldCount:i.entries?Array.from(i.entries()).length:0,interactionTime:s.interactionTime||0,fieldInteractions:s.fieldInteractions||0},element:this.extractElementInfo(e)})}handleFormFocus(t){const e=t.target;if(this.isFormField(e)){const t=this.getFormSelector(e),i=this.formInteractions.get(t)||{startTime:Date.now(),fieldInteractions:0,interactionTime:0};i.fieldInteractions++,this.formInteractions.set(t,i),this.recordInteraction({type:"form_focus",timestamp:Date.now(),target:this.getElementSelector(e),data:{fieldType:e.type||(e.tagName||"unknown").toLowerCase(),fieldName:e.name||e.id,formSelector:t},element:this.extractElementInfo(e)})}}handleFormBlur(t){const e=t.target;if(this.isFormField(e)){const t=this.getFormSelector(e),i=this.formInteractions.get(t);i&&(i.interactionTime=Date.now()-i.startTime,this.formInteractions.set(t,i))}}handleFormChange(t){const e=t.target;this.isFormField(e)&&this.recordInteraction({type:"form_focus",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:"change",fieldType:e.type||(e.tagName||"unknown").toLowerCase(),hasValue:!!e.value},element:this.extractElementInfo(e)})}handleFormInput(t){const e=t.target,i=this.getElementSelector(e),s=this.lastEventTimes.get(i)||0,n=Date.now();n-s>this.config.debounceMs&&(this.lastEventTimes.set(i,n),this.isFormField(e)&&this.recordInteraction({type:"form_focus",timestamp:n,target:i,data:{action:"input",fieldType:e.type||(e.tagName||"unknown").toLowerCase(),valueLength:e.value?.length||0},element:this.extractElementInfo(e)}))}handleMediaPlay(t){const e=t.target;this.recordInteraction({type:"media_play",timestamp:Date.now(),target:this.getElementSelector(e),data:{mediaType:(e.tagName||"unknown").toLowerCase(),duration:e.duration,currentTime:e.currentTime,src:e.src},element:this.extractElementInfo(e)})}handleMediaPause(t){const e=t.target;this.recordInteraction({type:"media_pause",timestamp:Date.now(),target:this.getElementSelector(e),data:{mediaType:(e.tagName||"unknown").toLowerCase(),duration:e.duration,currentTime:e.currentTime,watchedPercentage:e.duration>0?e.currentTime/e.duration*100:0},element:this.extractElementInfo(e)})}handleMediaEnded(t){const e=t.target;this.recordInteraction({type:"media_pause",timestamp:Date.now(),target:this.getElementSelector(e),data:{action:"ended",mediaType:(e.tagName||"unknown").toLowerCase(),duration:e.duration,completed:!0},element:this.extractElementInfo(e)})}handleSelectionStart(t){this.recordInteraction({type:"selection",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{action:"start"},element:this.extractElementInfo(t.target)})}handleSelectionChange(t){const e=document.getSelection();e&&e.toString().length>0&&this.recordInteraction({type:"selection",timestamp:Date.now(),target:"document",data:{text:e.toString(),length:e.toString().length}})}handleContextMenu(t){this.recordInteraction({type:"contextmenu",timestamp:Date.now(),target:this.getElementSelector(t.target),data:{button:t.button},coordinates:{x:t.clientX,y:t.clientY},element:this.extractElementInfo(t.target)})}recordInteraction(t){if(!this.isActive)return;const e=t.type,i=Date.now(),s=this.eventCounts.get(e)||0;if(i-(this.lastEventTimes.get(`reset_${e}`)||i)>1e3)this.eventCounts.set(e,1),this.lastEventTimes.set(`reset_${e}`,i);else{if(s>=this.config.maxEventsPerSecond)return;this.eventCounts.set(e,s+1)}this.eventBuffer.push(t),this.dispatchEvent(new CustomEvent("interaction",{detail:t})),this.eventBuffer.length>50&&this.flushEvents()}flushEvents(){if(0===this.eventBuffer.length)return;const t=[...this.eventBuffer];this.eventBuffer=[],this.lastFlushTime=Date.now(),this.messageBus&&this.messageBus.sendToBackground({type:"INTERACTIONS_BATCH",payload:{events:t,timestamp:Date.now(),url:window.location.href}})}getElementSelector(t){if(!t)return"unknown";let e=(t.tagName||"unknown").toLowerCase();if(t.id)e+=`#${t.id}`;else{const i=m(t);i.length>0&&(e+=`.${i.slice(0,3).join(".")}`)}return e}extractElementInfo(t){if(!t)return;const e={tag:(t.tagName||"unknown").toLowerCase()};t.id&&(e.id=t.id);const i=m(t);if(i.length>0&&(e.classes=i),t.textContent){const i=t.textContent.slice(0,50);i&&(e.text=i)}const s=t.href;return s&&(e.href=s),e}isNavigationClick(t){return"A"===t.tagName||null!==t.closest("a")||"link"===t.getAttribute("role")||t.hasAttribute("onclick")}isInteractiveElement(t){return["button","input","select","textarea","a"].includes((t.tagName||"").toLowerCase())||t.hasAttribute("tabindex")||"button"===t.getAttribute("role")||t.hasAttribute("onclick")}isFormField(t){return["input","textarea","select"].includes((t.tagName||"").toLowerCase())}getFormSelector(t){const e=t.closest("form");return e?this.getElementSelector(e):"no-form"}start(t){t&&(this.config={...this.config,...t}),this.isActive=!0,s.info("ðŸ” InteractionCollector started")}stop(){this.isActive=!1,this.flushEvents(),s.info("ðŸ” InteractionCollector stopped")}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getStats(){return{bufferSize:this.eventBuffer.length,lastFlushTime:this.lastFlushTime,eventCounts:Object.fromEntries(this.eventCounts),isActive:this.isActive}}}class y{analyze(){return{wordCount:1e3,imageCount:10,videoCount:2,linkCount:20,estimatedReadingTime:5}}extractMainContent(){return{}}categorizeContent(){return"article"}}class f extends EventTarget{constructor(t){super(),this.isActive=!1,this.startTime=0,this.lastScrollPosition=0,this.lastScrollTime=0,this.scrollHistory=[],this.scrollSessions=[],this.totalScrollDistance=0,this.maxScrollDepth=0,this.pauseStartTime=0,this.pauseCount=0,this.backtrackCount=0,this.isScrolling=!1,this.isPaused=!1,this.pauseThreshold=1e3,this.velocityHistory=[],this.lastDirection="down",this.readingSegments=[],this.averageReadingSpeed=200,this.currentReadingStart=0,this.pageAnalysis=null,this.messageBus=t||null,this.setupEventListeners(),this.analyzePage()}setupEventListeners(){let t;window.addEventListener("scroll",(()=>{this.isActive&&(this.handleScroll(),clearTimeout(t),t=window.setTimeout((()=>{this.handleScrollPause()}),this.pauseThreshold))}),{passive:!0}),window.addEventListener("load",(()=>this.analyzePage())),window.addEventListener("resize",(()=>this.analyzePage()))}analyzePage(){const t=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),e=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6, article, section"),i=Array.from(e).reduce(((t,e)=>t+(e.textContent?.length||0)),0)/t,s=document.querySelectorAll("img").length,n=document.querySelectorAll("a").length,a=this.analyzeContentSections();this.pageAnalysis={height:t,textDensity:i,imageCount:s,linkCount:n,contentSections:a}}analyzeContentSections(){const t=[],e=document.querySelectorAll("article, main, section, .content, .post, .article");for(const i of Array.from(e)){const e=i.getBoundingClientRect(),s=e.top+window.scrollY,n=s+e.height,a=i.textContent||"",o=i.querySelectorAll("img").length,r=i.querySelectorAll("a").length;let c="text";o>a.length/500?c="media":r>a.length/200?c="navigation":a.length>1e3&&(c="article"),t.push({start:s,end:n,type:c})}return t.sort(((t,e)=>t.start-e.start))}handleScroll(){const t=window.scrollY,e=Date.now();this.isScrolling||this.handleScrollStart(t,e);const i=e-this.lastScrollTime,s=Math.abs(t-this.lastScrollPosition),n=i>0?s/i:0,a=t>this.lastScrollPosition?"down":"up";a!==this.lastDirection&&s>100&&(this.backtrackCount++,this.emitScrollEvent({type:"backtrack",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()})),s>window.innerHeight&&i<100&&this.emitScrollEvent({type:"jump",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()}),this.updateScrollData(t,e,n,a),this.getScrollPercentage()>.8&&this.maxScrollDepth<.8&&this.emitScrollEvent({type:"deep_scroll",timestamp:e,position:t,velocity:1e3*n,direction:a,metrics:this.calculateMetrics()}),this.lastScrollPosition=t,this.lastScrollTime=e,this.lastDirection=a,this.isPaused=!1}handleScrollStart(t,e){this.isScrolling=!0,this.currentReadingStart=e,this.emitScrollEvent({type:"scroll_start",timestamp:e,position:t,velocity:0,direction:"down",metrics:this.calculateMetrics()})}handleScrollPause(){this.isScrolling&&!this.isPaused&&(this.isPaused=!0,this.pauseCount++,this.pauseStartTime=Date.now(),this.analyzeReadingSegment(),this.emitScrollEvent({type:"scroll_pause",timestamp:this.pauseStartTime,position:this.lastScrollPosition,velocity:0,direction:this.lastDirection,metrics:this.calculateMetrics()}))}handleScrollResume(){this.isPaused=!1,this.emitScrollEvent({type:"scroll_resume",timestamp:Date.now(),position:window.scrollY,velocity:0,direction:"down",metrics:this.calculateMetrics()})}updateScrollData(t,e,i,s){const n=Math.abs(t-this.lastScrollPosition);this.totalScrollDistance+=n;const a=this.getScrollPercentage();this.maxScrollDepth=Math.max(this.maxScrollDepth,a),this.scrollHistory.push({position:t,timestamp:e,velocity:1e3*i}),this.scrollHistory.length>100&&(this.scrollHistory=this.scrollHistory.slice(-100)),this.velocityHistory.push(1e3*i),this.velocityHistory.length>20&&(this.velocityHistory=this.velocityHistory.slice(-20))}analyzeReadingSegment(){if(this.currentReadingStart>0){const t=Date.now()-this.currentReadingStart,e=this.getPositionAtTime(this.currentReadingStart),i=this.lastScrollPosition;if(t>2e3&&Math.abs(i-e)<window.innerHeight){this.readingSegments.push({start:e,end:i,duration:t});const s=this.getTextInRange(e,i);if(s.length>100){const e=s.split(/\s+/).length/(t/6e4);e>50&&e<800&&(this.averageReadingSpeed=(this.averageReadingSpeed+e)/2)}}this.currentReadingStart=0}}getPositionAtTime(t){const e=this.scrollHistory.find((e=>Math.abs(e.timestamp-t)<1e3));return e?e.position:this.lastScrollPosition}getTextInRange(t,e){const i=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6");let s="";for(const n of Array.from(i)){const i=n.getBoundingClientRect().top+window.scrollY;i>=t&&i<=e&&(s+=n.textContent+" ")}return s.trim()}getScrollPercentage(){if(!this.pageAnalysis)return 0;const t=this.pageAnalysis.height-window.innerHeight;return t>0?Math.min(1,this.lastScrollPosition/t):0}calculateMetrics(){const t=g(this.velocityHistory),e=this.readingSegments.reduce(((t,e)=>t+e.duration),0),i=this.calculateEngagementScore(),s=this.determineScrollPattern();return{totalDistance:this.totalScrollDistance,maxDepth:this.maxScrollDepth,currentDepth:this.getScrollPercentage(),pageHeight:this.pageAnalysis?.height||0,scrollVelocity:t,pauseCount:this.pauseCount,backtrackCount:this.backtrackCount,readingTime:e,engagementScore:i,scrollPattern:s}}calculateEngagementScore(){let t=.5;this.maxScrollDepth>.7&&(t+=.2),this.pauseCount>3&&(t+=.1),this.readingSegments.length>2&&(t+=.15),this.backtrackCount>5&&(t-=.1),g(this.velocityHistory)>2e3&&(t-=.15);const e=Date.now()-this.startTime;return e>0&&(t+=this.readingSegments.reduce(((t,e)=>t+e.duration),0)/e*.2),Math.max(0,Math.min(1,t))}determineScrollPattern(){if(0===this.velocityHistory.length)return"linear";const t=g(this.velocityHistory);if(this.readingSegments.length>2&&t<500)return"reading";if(t>2e3&&this.pauseCount<3)return"scanning";if(this.backtrackCount>this.pauseCount)return"searching";if(this.scrollHistory.length>10){const t=this.scrollHistory.slice(-10).map((t=>t.position));if(this.isLinearProgression(t))return"linear"}return"jumped"}isLinearProgression(t){if(!t||t.length<3)return!1;let e=0;for(let i=1;i<t.length;i++)t[i]>t[i-1]&&e++;return e/(t.length-1)>.7}emitScrollEvent(t){this.dispatchEvent(new CustomEvent("scroll_event",{detail:t})),this.messageBus&&this.messageBus.sendToBackground({type:"SCROLL_EVENT",payload:t})}start(){this.isActive=!0,this.startTime=Date.now(),this.lastScrollPosition=window.scrollY,this.lastScrollTime=Date.now(),s.info("ðŸ“œ ScrollTracker started")}stop(){this.isActive=!1,this.isScrolling&&this.emitScrollEvent({type:"scroll_end",timestamp:Date.now(),position:this.lastScrollPosition,velocity:0,direction:this.lastDirection,metrics:this.calculateMetrics()}),s.info("ðŸ“œ ScrollTracker stopped")}getMetrics(){return this.calculateMetrics()}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getReadingAnalysis(){return{segments:this.readingSegments,averageReadingSpeed:this.averageReadingSpeed,totalReadingTime:this.readingSegments.reduce(((t,e)=>t+e.duration),0),readingEfficiency:this.calculateEngagementScore()}}getScrollPattern(){return{pattern:this.determineScrollPattern(),metrics:this.calculateMetrics(),history:this.scrollHistory.slice(-20),pageAnalysis:this.pageAnalysis}}}class E extends EventTarget{constructor(t){super(),this.isActive=!1,this.startTime=0,this.lastActivity=Date.now(),this.windowFocusStart=Date.now(),this.totalFocusTime=0,this.tabSwitchCount=0,this.scrollStartTime=0,this.scrollDistance=0,this.lastScrollPosition=0,this.currentElement=null,this.elementDwellStart=0,this.focusHistory=[],this.attentionScore=.5,this.idleThreshold=3e4,this.deepFocusThreshold=12e4,this.isIdle=!1,this.isDeepFocus=!1,this.textAnalysisBuffer=[],this.averageReadingSpeed=200,this.readingSpeedHistory=[],this.messageBus=t||null,this.setupEventListeners()}setupEventListeners(){window.addEventListener("focus",this.handleWindowFocus.bind(this)),window.addEventListener("blur",this.handleWindowBlur.bind(this)),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),document.addEventListener("mousemove",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("keydown",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),document.addEventListener("click",this.handleActivity.bind(this),{passive:!0}),document.addEventListener("selectionchange",this.handleSelection.bind(this)),this.setupIntersectionObserver(),setInterval((()=>this.analyzeAttention()),5e3),setInterval((()=>this.checkIdle()),1e3)}setupIntersectionObserver(){const t=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&this.trackElementFocus(t.target)}))}),{threshold:[.5],rootMargin:"0px 0px -50% 0px"});document.querySelectorAll("p, h1, h2, h3, h4, h5, h6, article, section").forEach((e=>t.observe(e)))}trackElementFocus(t){if(this.currentElement!==t){if(this.currentElement&&this.elementDwellStart>0){const t=Date.now()-this.elementDwellStart;this.analyzeElementDwell(this.currentElement,t)}this.currentElement=t,this.elementDwellStart=Date.now(),this.analyzeReadingContent(t)}}analyzeElementDwell(t,e){const i=(t.textContent||"").split(/\s+/).length;if(i>10&&e>1e3){const t=i/(e/6e4);this.readingSpeedHistory.push(t),this.readingSpeedHistory.length>10&&(this.readingSpeedHistory=this.readingSpeedHistory.slice(-10)),this.averageReadingSpeed=this.readingSpeedHistory.reduce(((t,e)=>t+e),0)/this.readingSpeedHistory.length}}analyzeReadingContent(t){const e=t.textContent||"",i=t.getBoundingClientRect().top+window.scrollY;this.textAnalysisBuffer.push({text:e.slice(0,100),timestamp:Date.now(),position:i}),this.textAnalysisBuffer.length>20&&(this.textAnalysisBuffer=this.textAnalysisBuffer.slice(-20))}handleWindowFocus(){this.windowFocusStart=Date.now(),this.lastActivity=Date.now(),this.emitAttentionEvent({type:"focus_change",timestamp:Date.now(),metrics:{focusLevel:1},context:this.getCurrentContext()})}handleWindowBlur(){const t=Date.now()-this.windowFocusStart;this.totalFocusTime+=t,this.tabSwitchCount++,this.emitAttentionEvent({type:"focus_change",timestamp:Date.now(),metrics:{focusLevel:0,windowFocusTime:this.totalFocusTime,tabSwitches:this.tabSwitchCount},context:this.getCurrentContext()})}handleVisibilityChange(){const t=!document.hidden;this.emitAttentionEvent({type:"visibility_change",timestamp:Date.now(),metrics:{focusLevel:t?1:0},context:this.getCurrentContext()}),t&&this.handleActivity()}handleActivity(){const t=Date.now(),e=t-this.lastActivity;this.isIdle&&(this.isIdle=!1,this.emitAttentionEvent({type:"idle_end",timestamp:t,metrics:{idleTime:e,focusLevel:.7},context:this.getCurrentContext()})),this.lastActivity=t,this.updateFocusLevel(e)}handleScroll(){const t=window.scrollY,e=Math.abs(t-this.lastScrollPosition),i=Date.now();0===this.scrollStartTime&&(this.scrollStartTime=i),this.scrollDistance+=e,this.lastScrollPosition=t;const s=i-this.scrollStartTime;this.scrollDistance,s>500&&(this.scrollStartTime=i,this.scrollDistance=e),this.handleActivity()}handleSelection(){const t=window.getSelection();if(t&&t.toString().length>10){const e=t.toString().split(/\s+/).length;this.emitAttentionEvent({type:"reading_flow",timestamp:Date.now(),metrics:{readingSpeed:e,focusLevel:.8},context:this.getCurrentContext()})}}updateFocusLevel(t){let e=1;t>5e3&&(e=Math.max(.3,1-t/3e4)),this.focusHistory.push(e),this.focusHistory.length>20&&(this.focusHistory=this.focusHistory.slice(-20)),this.attentionScore=this.focusHistory.reduce(((t,e)=>t+e),0)/this.focusHistory.length}checkIdle(){const t=Date.now(),e=t-this.lastActivity;!this.isIdle&&e>this.idleThreshold&&(this.isIdle=!0,this.emitAttentionEvent({type:"idle_start",timestamp:t,metrics:{idleTime:e,focusLevel:.1},context:this.getCurrentContext()}));const i=t-this.windowFocusStart;!this.isDeepFocus&&!this.isIdle&&i>this.deepFocusThreshold&&this.attentionScore>.7&&(this.isDeepFocus=!0,this.emitAttentionEvent({type:"deep_focus",timestamp:t,metrics:{focusLevel:.9,windowFocusTime:i,engagementPattern:"deep"},context:this.getCurrentContext()}))}analyzeAttention(){if(!this.isActive)return;const t=Date.now(),e=this.calculateMetrics(),i=this.determineEngagementPattern(e);e.engagementPattern=i,this.emitAttentionEvent({type:"distracted"===i?"distraction":"focus_change",timestamp:t,metrics:e,context:this.getCurrentContext()})}calculateMetrics(){const t=Date.now(),e=t-this.startTime,i=t-this.windowFocusStart,s=t-this.lastActivity,n=this.scrollDistance/Math.max(1,(t-this.scrollStartTime)/1e3),a=Math.max(0,1-this.tabSwitchCount/Math.max(1,e/6e4));return{focusLevel:this.attentionScore,readingSpeed:this.averageReadingSpeed,scrollVelocity:n||0,dwellTime:this.currentElement?t-this.elementDwellStart:0,tabSwitches:this.tabSwitchCount,windowFocusTime:this.totalFocusTime+i,idleTime:s,multitaskingScore:a,engagementPattern:"focused"}}determineEngagementPattern(t){return t.idleTime>this.idleThreshold?"idle":t.focusLevel<.3||t.tabSwitches>5?"distracted":t.scrollVelocity>1e3&&t.dwellTime<2e3?"scanning":t.focusLevel>.8&&t.windowFocusTime>this.deepFocusThreshold?"deep":"focused"}getCurrentContext(){const t=this.getVisibleText(),e={url:window.location.href,title:document.title,visibleText:t,scrollPosition:window.scrollY},i=document.activeElement;if(i)if(e.elementInFocus=(i.tagName||"unknown").toLowerCase(),i.id)e.elementInFocus+=`#${i.id}`;else{const t=m(i);t.length>0&&(e.elementInFocus+=`.${t.slice(0,2).join(".")}`)}return e}getVisibleText(){const t=document.querySelectorAll("p, h1, h2, h3, h4, h5, h6");let e="";for(const i of Array.from(t)){const t=i.getBoundingClientRect();if(t.top>=0&&t.top<=window.innerHeight&&(e+=i.textContent+" ",e.length>500))break}return e.trim()}getElementSelector(t){const e=m(t);return(t.tagName||"unknown").toLowerCase()+(t.id?"#"+t.id:"")+(e.length>0?"."+e.join("."):"")}emitAttentionEvent(t){this.dispatchEvent(new CustomEvent("attention",{detail:t})),this.messageBus&&this.messageBus.sendToBackground({type:"ATTENTION_EVENT",payload:t})}start(){this.isActive=!0,this.startTime=Date.now(),this.windowFocusStart=Date.now(),this.lastActivity=Date.now(),s.info("ðŸ‘ï¸ AttentionMonitor started")}stop(){this.isActive=!1,s.info("ðŸ‘ï¸ AttentionMonitor stopped")}getMetrics(){return this.calculateMetrics()}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getStats(){return{isActive:this.isActive,attentionScore:this.attentionScore,totalFocusTime:this.totalFocusTime,tabSwitches:this.tabSwitchCount,averageReadingSpeed:this.averageReadingSpeed,isIdle:this.isIdle,isDeepFocus:this.isDeepFocus}}}class S{constructor(){this.gl=null,this.mousePosition={x:0,y:0},this.animationFrame=null,this.shaderProgram=null,this.vertexBuffer=null,this.particleCount=100,this.isMouseNear=!1,this.pageContent="default",console.log("[SYMBIONT] OrganismRenderer constructor called"),this.state=this.loadOrganismState(),this.particles=new Float32Array(6*this.particleCount),console.log("[SYMBIONT] Creating container..."),this.container=this.createContainer(),console.log("[SYMBIONT] Creating canvas..."),this.canvas=this.createCanvas(),console.log("[SYMBIONT] Initializing WebGL..."),this.initWebGL(),console.log("[SYMBIONT] Detecting page content..."),this.detectPageContent(),console.log("[SYMBIONT] Setting up event listeners..."),this.setupEventListeners(),console.log("[SYMBIONT] Injecting into page..."),this.injectIntoPage()}loadOrganismState(){const t=localStorage.getItem("symbiont_organism");if(t){const e=JSON.parse(t);return{energy:e.energy||.8,consciousness:e.consciousness||.5,health:e.health||1,mood:"curious",traits:e.traits||{curiosity:.5,empathy:.5,creativity:.5,resilience:.5,focus:.5},position:{x:window.innerWidth-150,y:window.innerHeight-150},velocity:{x:0,y:0},size:120,color:{r:.2,g:.8,b:.6,a:.9}}}return{energy:.8,consciousness:.5,health:1,mood:"curious",traits:{curiosity:.5,empathy:.5,creativity:.5,resilience:.5,focus:.5},position:{x:window.innerWidth-150,y:window.innerHeight-150},velocity:{x:0,y:0},size:120,color:{r:.2,g:.8,b:.6,a:.9}}}createContainer(){const t=document.createElement("div");t.id="symbiont-organism-container",t.style.cssText=`\n      position: fixed;\n      width: ${this.state.size}px;\n      height: ${this.state.size}px;\n      bottom: 30px;\n      right: 30px;\n      z-index: 2147483647;\n      pointer-events: none;\n      transition: all 0.3s ease;\n      animation: symbiont-float 3s ease-in-out infinite;\n    `;const e=document.createElement("style");return e.textContent="\n      @keyframes symbiont-float {\n        0%, 100% { transform: translateY(0px) scale(1); }\n        50% { transform: translateY(-10px) scale(1.02); }\n      }\n\n      @keyframes symbiont-pulse {\n        0%, 100% { opacity: 0.9; }\n        50% { opacity: 1; }\n      }\n\n      @keyframes symbiont-excited {\n        0%, 100% { transform: rotate(0deg) scale(1); }\n        25% { transform: rotate(-5deg) scale(1.1); }\n        75% { transform: rotate(5deg) scale(1.1); }\n      }\n\n      #symbiont-organism-container.hungry {\n        animation: symbiont-pulse 1s ease-in-out infinite;\n      }\n\n      #symbiont-organism-container.excited {\n        animation: symbiont-excited 0.5s ease-in-out infinite;\n      }\n\n      #symbiont-organism-container.meditating {\n        animation: symbiont-float 5s ease-in-out infinite;\n        opacity: 0.7;\n      }\n    ",document.head.appendChild(e),t}createCanvas(){const t=document.createElement("canvas");return t.width=this.state.size,t.height=this.state.size,t.style.cssText="\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      filter: blur(0.5px);\n    ",this.container.appendChild(t),t}initWebGL(){try{if(this.gl=this.canvas.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,antialias:!0}),!this.gl)return s.warn("WebGL2 not supported, falling back to CSS animation"),void this.fallbackToCSS();this.setupShaders(),this.initParticles(),s.info("WebGL organism renderer initialized")}catch(t){s.error("Failed to initialize WebGL:",t),this.fallbackToCSS()}}setupShaders(){if(!this.gl)return;const t=this.compileShader(this.gl.VERTEX_SHADER,"#version 300 es\n      in vec2 a_position;\n      in float a_size;\n      in float a_life;\n\n      uniform vec2 u_resolution;\n      uniform float u_time;\n\n      out float v_life;\n\n      void main() {\n        vec2 position = a_position + vec2(\n          sin(u_time * 2.0 + a_life * 6.28) * 10.0,\n          cos(u_time * 1.5 + a_life * 6.28) * 10.0\n        );\n\n        vec2 clipSpace = ((position / u_resolution) * 2.0 - 1.0) * vec2(1, -1);\n        gl_Position = vec4(clipSpace, 0, 1);\n        gl_PointSize = a_size * (1.0 + sin(u_time * 3.0) * 0.2);\n        v_life = a_life;\n      }\n    "),e=this.compileShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n      precision highp float;\n\n      in float v_life;\n      uniform vec4 u_color;\n      uniform float u_consciousness;\n\n      out vec4 fragColor;\n\n      void main() {\n        vec2 coord = gl_PointCoord - vec2(0.5);\n        float dist = length(coord);\n\n        if (dist > 0.5) discard;\n\n        float alpha = (1.0 - dist * 2.0) * v_life;\n        vec3 color = u_color.rgb;\n\n        // Modulation selon la conscience\n        color.g += u_consciousness * 0.2;\n        color.b += (1.0 - u_consciousness) * 0.2;\n\n        fragColor = vec4(color, alpha * u_color.a);\n      }\n    ");t&&e&&(this.shaderProgram=this.gl.createProgram(),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.gl.getProgramParameter(this.shaderProgram,this.gl.LINK_STATUS)||s.error("Shader program failed to link"))}compileShader(t,e){if(!this.gl)return null;const i=this.gl.createShader(t);return this.gl.shaderSource(i,e),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(s.error("Shader compilation error:",this.gl.getShaderInfoLog(i)),null)}initParticles(){for(let t=0;t<this.particleCount;t++){const e=t/this.particleCount*Math.PI*2,i=50*n.random();this.particles[6*t+0]=Math.cos(e)*i+this.state.size/2,this.particles[6*t+1]=Math.sin(e)*i+this.state.size/2,this.particles[6*t+2]=2*n.random()-1,this.particles[6*t+3]=2*n.random()-1,this.particles[6*t+4]=3*n.random()+2,this.particles[6*t+5]=n.random()}}detectPageContent(){const t=window.location.href,e=document.body.innerText.toLowerCase();t.includes("science")||t.includes("nature")||t.includes("arxiv")||e.includes("quantum")||e.includes("research")||e.includes("experiment")?(this.pageContent="science",this.state.mood="excited",this.state.color={r:.3,g:.9,b:.7,a:1}):t.includes("twitter")||t.includes("facebook")||t.includes("instagram")?(this.pageContent="social",this.state.mood="happy",this.state.color={r:.9,g:.6,b:.3,a:.9}):t.includes("news")||t.includes("reddit")?(this.pageContent="news",this.state.mood="curious",this.state.color={r:.5,g:.7,b:.9,a:.9}):(t.includes("youtube")||t.includes("twitch")||t.includes("netflix"))&&(this.pageContent="entertainment",this.state.mood="happy",this.state.color={r:.9,g:.3,b:.6,a:.9}),s.info(`Organism detected ${this.pageContent} content, mood: ${this.state.mood}`)}setupEventListeners(){document.addEventListener("mousemove",(t=>{this.mousePosition={x:t.clientX,y:t.clientY},this.checkMouseProximity()})),chrome.runtime.onMessage.addListener((t=>{"UPDATE_ORGANISM_STATE"===t.type?this.updateState(t.data):"ORGANISM_ACTION"===t.type&&this.performAction(t.action)})),window.addEventListener("resize",(()=>{this.state.position={x:Math.min(this.state.position.x,window.innerWidth-this.state.size),y:Math.min(this.state.position.y,window.innerHeight-this.state.size)}}))}checkMouseProximity(){const t=this.mousePosition.x-(this.state.position.x+this.state.size/2),e=this.mousePosition.y-(this.state.position.y+this.state.size/2),i=Math.sqrt(t*t+e*e);this.isMouseNear=i<150,this.isMouseNear?this.state.traits.curiosity>.7?(this.state.velocity.x=.01*t,this.state.velocity.y=.01*e,this.container.style.transform="scale(1.1)"):this.state.traits.curiosity<.3&&(this.state.velocity.x=.02*-t,this.state.velocity.y=.02*-e,this.container.style.transform="scale(0.9)"):(this.container.style.transform="scale(1)",this.state.velocity.x*=.95,this.state.velocity.y*=.95)}updateState(t){this.state={...this.state,...t},this.state.energy<.3?(this.state.mood="hungry",this.container.classList.add("hungry")):this.container.classList.remove("hungry"),this.state.consciousness>.8?(this.state.mood="meditating",this.container.classList.add("meditating")):this.container.classList.remove("meditating"),this.updateColor()}updateColor(){const{energy:t,consciousness:e,health:i}=this.state;this.state.color={r:.3*i+.2,g:.5*t+.3,b:.6*e+.2,a:.9}}performAction(t){switch(t){case"feed":this.state.energy=Math.min(1,this.state.energy+.2),this.showFeedbackAnimation("energy");break;case"meditate":this.state.consciousness=Math.min(1,this.state.consciousness+.1),this.showFeedbackAnimation("consciousness");break;case"play":this.state.mood="happy",this.container.classList.add("excited"),setTimeout((()=>this.container.classList.remove("excited")),2e3)}}showFeedbackAnimation(t){const e=document.createElement("div");e.style.cssText=`\n      position: absolute;\n      top: -20px;\n      left: 50%;\n      transform: translateX(-50%);\n      color: ${"energy"===t?"#ffeb3b":"#9c27b0"};\n      font-size: 20px;\n      font-weight: bold;\n      pointer-events: none;\n      animation: rise-and-fade 2s ease-out forwards;\n    `,e.textContent="energy"===t?"âš¡ +20%":"ðŸ§  +10%",this.container.appendChild(e),setTimeout((()=>e.remove()),2e3)}animate(){this.gl&&this.shaderProgram?(this.state.position.x+=this.state.velocity.x,this.state.position.y+=this.state.velocity.y,this.state.position.x=Math.max(0,Math.min(window.innerWidth-this.state.size,this.state.position.x)),this.state.position.y=Math.max(0,Math.min(window.innerHeight-this.state.size,this.state.position.y)),this.container.style.right=window.innerWidth-this.state.position.x-this.state.size+"px",this.container.style.bottom=window.innerHeight-this.state.position.y-this.state.size+"px",this.renderWebGL(),this.animationFrame=requestAnimationFrame((()=>this.animate()))):this.animateCSS()}renderWebGL(){if(!this.gl||!this.shaderProgram)return;this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.useProgram(this.shaderProgram);const t=this.gl.getUniformLocation(this.shaderProgram,"u_resolution"),e=this.gl.getUniformLocation(this.shaderProgram,"u_time"),i=this.gl.getUniformLocation(this.shaderProgram,"u_color"),s=this.gl.getUniformLocation(this.shaderProgram,"u_consciousness");this.gl.uniform2f(t,this.canvas.width,this.canvas.height),this.gl.uniform1f(e,.001*performance.now()),this.gl.uniform4f(i,this.state.color.r,this.state.color.g,this.state.color.b,this.state.color.a),this.gl.uniform1f(s,this.state.consciousness),this.updateParticles(),this.drawParticles()}updateParticles(){for(let t=0;t<this.particleCount;t++){const e=6*t;this.particles[e+0]+=this.particles[e+2],this.particles[e+1]+=this.particles[e+3],(this.particles[e+0]<0||this.particles[e+0]>this.state.size)&&(this.particles[e+2]*=-.8),(this.particles[e+1]<0||this.particles[e+1]>this.state.size)&&(this.particles[e+3]*=-.8);const i=this.state.size/2,s=this.state.size/2,a=i-this.particles[e+0],o=s-this.particles[e+1],r=Math.sqrt(a*a+o*o);if(r>10&&(this.particles[e+2]+=a/r*.1,this.particles[e+3]+=o/r*.1),this.particles[e+5]+=.01,this.particles[e+5]>1){this.particles[e+5]=0;const t=n.random()*Math.PI*2;this.particles[e+0]=i+10*Math.cos(t),this.particles[e+1]=s+10*Math.sin(t)}}}drawParticles(){if(!this.gl||!this.shaderProgram)return;this.vertexBuffer||(this.vertexBuffer=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.particles,this.gl.DYNAMIC_DRAW);const t=this.gl.getAttribLocation(this.shaderProgram,"a_position"),e=this.gl.getAttribLocation(this.shaderProgram,"a_size"),i=this.gl.getAttribLocation(this.shaderProgram,"a_life");this.gl.enableVertexAttribArray(t),this.gl.enableVertexAttribArray(e),this.gl.enableVertexAttribArray(i);const s=6*Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,s,0),this.gl.vertexAttribPointer(e,1,this.gl.FLOAT,!1,s,4*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(i,1,this.gl.FLOAT,!1,s,5*Float32Array.BYTES_PER_ELEMENT),this.gl.drawArrays(this.gl.POINTS,0,this.particleCount)}animateCSS(){const t=.001*performance.now(),e=1+.05*Math.sin(t),i=30*t%360;this.canvas.style.background=`radial-gradient(circle at center,\n      hsla(${i}, 70%, 60%, 0.8),\n      hsla(${i+60}, 70%, 50%, 0.4))`,this.canvas.style.transform=`scale(${e})`,this.animationFrame=requestAnimationFrame((()=>this.animateCSS()))}fallbackToCSS(){s.info("Using CSS fallback for organism rendering"),this.canvas.style.background="radial-gradient(circle, #4CAF50, #2196F3)",this.animate()}injectIntoPage(){console.log("[SYMBIONT] injectIntoPage called, document.body exists:",!!document.body),document.body?(console.log("[SYMBIONT] Appending container to body..."),document.body.appendChild(this.container),console.log("[SYMBIONT] Container appended, starting animation..."),this.animate(),console.log("[SYMBIONT] Organism successfully injected into page"),s.info("Organism injected into page")):(console.log("[SYMBIONT] document.body not ready, waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",(()=>{console.log("[SYMBIONT] DOMContentLoaded fired, injecting organism..."),document.body.appendChild(this.container),this.animate(),console.log("[SYMBIONT] Organism injected after DOM ready"),s.info("Organism injected after DOM ready")})))}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.gl&&(this.gl.deleteProgram(this.shaderProgram),this.gl.deleteBuffer(this.vertexBuffer)),this.container.remove(),s.info("Organism renderer destroyed")}}let T=null;function v(){if(console.log("[SYMBIONT] Attempting to initialize organism..."),T)console.log("[SYMBIONT] Organism already initialized");else try{T=new S,console.log("[SYMBIONT] Organism renderer created successfully"),window.addEventListener("beforeunload",(()=>{T&&T.destroy()}))}catch(t){console.error("[SYMBIONT] Failed to create organism renderer:",t)}}console.log("[SYMBIONT] OrganismRenderer module loaded"),chrome.storage.local.get(["symbiont_webgl_enabled"],(t=>{console.log("[SYMBIONT] WebGL enabled status:",t.symbiont_webgl_enabled),!1!==t.symbiont_webgl_enabled?(console.log("[SYMBIONT] WebGL is enabled, initializing organism..."),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",v):v()):console.log("[SYMBIONT] WebGL is disabled")})),chrome.storage.onChanged.addListener(((t,e)=>{"local"===e&&t.symbiont_webgl_enabled&&(t.symbiont_webgl_enabled.newValue&&!T?T=new S:!t.symbiont_webgl_enabled.newValue&&T&&(T.destroy(),T=null))}));class w{constructor(){this.listeners=new Set,this.syncInterval=null,this.state=this.getDefaultState(),this.initializeState(),this.startSyncLoop()}static getInstance(){return this.instance||(this.instance=new w),this.instance}getDefaultState(){return{energy:75,consciousness:50,mood:"curious",evolutionStage:1,experience:0,lastFeedTime:Date.now(),pagesVisited:0,knowledgeGained:0,socialInteractions:0,size:120,position:"bottom-right",behavior:"curious",visible:!0,currentPageType:"default",isActive:!0,lastUpdate:Date.now()}}async initializeState(){try{const t=await chrome.storage.local.get("organism_state");t.organism_state&&(this.state={...this.state,...t.organism_state},s.info("Organism state loaded from storage"))}catch(t){s.error("Failed to load organism state:",t)}chrome.storage.onChanged.addListener(((t,e)=>{if("local"===e&&t.organism_state){const e=t.organism_state.newValue;e&&e.lastUpdate>this.state.lastUpdate&&(this.state=e,this.notifyListeners())}}))}startSyncLoop(){this.syncInterval=window.setInterval((()=>{this.updateMetabolism(),this.saveState()}),5e3)}updateMetabolism(){const t=Date.now(),e=(t-this.state.lastFeedTime)/1e3/60,i=this.state.isActive?.5:.2;this.state.energy=Math.max(0,this.state.energy-i);let s=0;switch(this.state.currentPageType){case"science":case"learning":s=.3;break;case"social":s=.1;break;case"entertainment":s=-.1;break;default:s=0}this.state.consciousness=Math.max(0,Math.min(100,this.state.consciousness+s)),this.updateMood(e),this.updateEvolutionStage(),this.state.lastUpdate=t}updateMood(t){this.state.energy<20?this.state.mood="tired":t>30?this.state.mood="hungry":"science"===this.state.currentPageType?this.state.mood="excited":this.state.consciousness>70?this.state.mood="meditating":this.state.isActive?this.state.mood="happy":this.state.mood="curious"}updateEvolutionStage(){const t=[0,100,300,600,1e3,1500,2100,2800,3600,4500];let e=1;for(let i=t.length-1;i>=0;i--)if(this.state.experience>=t[i]){e=i+1;break}this.state.evolutionStage=e}getState(){return{...this.state}}async updateState(t){this.state={...this.state,...t,lastUpdate:Date.now()},await this.saveState(),this.notifyListeners()}async feed(t){let e=0,i=0;switch(t){case"ritual":e=30,i=50,this.state.consciousness+=10;break;case"interaction":e=10,i=10;break;case"knowledge":e=15,i=25,this.state.consciousness+=5,this.state.knowledgeGained+=1;break;case"social":e=20,i=15,this.state.socialInteractions+=1}this.state.energy=Math.min(100,this.state.energy+e),this.state.experience+=i,this.state.lastFeedTime=Date.now(),this.state.mood="happy",await this.saveState(),this.notifyListeners(),s.info(`Organism fed from ${t}: +${e} energy, +${i} XP`)}async onPageVisit(t){this.state.pagesVisited+=1,this.state.currentPageType=t;let e=5;"science"===t||"learning"===t?(e=15,this.state.knowledgeGained+=1):"social"===t&&(e=10,this.state.socialInteractions+=1),this.state.experience+=e,await this.saveState()}subscribe(t){return this.listeners.add(t),()=>{this.listeners.delete(t)}}notifyListeners(){const t=this.getState();this.listeners.forEach((e=>{try{e(t)}catch(t){s.error("Error notifying listener:",t)}}))}async saveState(){try{await chrome.storage.local.set({organism_state:this.state})}catch(t){s.error("Failed to save organism state:",t)}}destroy(){this.syncInterval&&clearInterval(this.syncInterval),this.listeners.clear()}}let I=null;const b=()=>(I||(I=w.getInstance()),I.getState()),C=async t=>(I||(I=w.getInstance()),I.updateState(t)),A=async t=>(I||(I=w.getInstance()),I.onPageVisit(t));class _{constructor(){this.updateInterval=null,this.lastInteraction=Date.now(),this.pageAnalysis=this.analyzePage(),this.setupListeners(),this.startMonitoring()}static getInstance(){return this.instance||(this.instance=new _),this.instance}analyzePage(){const t=window.location.href,e=document.title.toLowerCase(),i=document.body?.innerText?.toLowerCase()||"",s=[],n=["science","research","quantum","physics","biology","chemistry","experiment","theory","discovery"],a=["code","function","variable","git","npm","debug","api","framework","javascript","python"],o=["learn","tutorial","course","education","study","lesson","teach","knowledge"];let r="default",c=0;const l=n.filter((t=>i.includes(t))).length;l>c&&(c=l,r="science",s.push(...n.filter((t=>i.includes(t))))),(t.includes("twitter")||t.includes("facebook")||t.includes("instagram")||t.includes("linkedin")||t.includes("reddit"))&&(r="social",s.push(...["friend","share","like","comment","post","follow","message","profile"].filter((t=>i.includes(t))))),(t.includes("github")||t.includes("stackoverflow")||t.includes("codepen")||a.filter((t=>i.includes(t))).length>3)&&(r="coding",s.push(...a.filter((t=>i.includes(t))))),(t.includes("wikipedia")||t.includes("coursera")||t.includes("udemy")||o.filter((t=>i.includes(t))).length>2)&&(r="learning",s.push(...o.filter((t=>i.includes(t))))),(t.includes("news")||t.includes("bbc")||t.includes("cnn")||e.includes("news"))&&(r="news"),(t.includes("youtube")||t.includes("netflix")||t.includes("twitch")||t.includes("spotify"))&&(r="entertainment");const h=["good","great","excellent","amazing","love","happy","success"].filter((t=>i.includes(t))).length,d=["bad","terrible","hate","fail","error","problem","issue"].filter((t=>i.includes(t))).length;let u="neutral";h>1.5*d?u="positive":d>1.5*h&&(u="negative");const g=i.split(/\s+/).slice(0,1e3),m=g.reduce(((t,e)=>t+e.length),0)/g.length,p=Math.min(1,m/10),y=document.querySelectorAll("button, input, textarea, select, a, video, audio").length,f=Math.min(1,y/100);return{type:r,keywords:s.slice(0,10),sentiment:u,complexity:p,interactivity:f}}setupListeners(){chrome.runtime.onMessage.addListener(((t,e,i)=>{switch(t.type){case"GET_PAGE_ANALYSIS":i(this.pageAnalysis);break;case"FEED_ORGANISM":this.feedOrganism(),i({success:!0});break;case"TOGGLE_ORGANISM":this.toggleOrganismVisibility(),i({success:!0});break;case"GET_ORGANISM_POSITION":i(this.getOrganismPosition())}})),document.addEventListener("click",(()=>this.onUserInteraction("click"))),document.addEventListener("scroll",(()=>this.onUserInteraction("scroll"))),document.addEventListener("keypress",(()=>this.onUserInteraction("type"))),new MutationObserver((()=>{this.onPageChange()})).observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})}startMonitoring(){this.updateInterval=window.setInterval((()=>{this.updateOrganismState()}),5e3),setInterval((()=>{this.pageAnalysis=this.analyzePage(),this.notifyBackgroundOfPageChange()}),3e4)}async updateOrganismState(){const t=Date.now()-this.lastInteraction<3e4;await C({currentPageType:this.pageAnalysis.type,isActive:t}),await A(this.pageAnalysis.type);const e=b();window.postMessage({source:"symbiont-controller",type:"UPDATE_ORGANISM_STATE",data:{energy:e.energy,consciousness:e.consciousness,mood:e.mood,size:e.size,position:e.position,behavior:e.behavior}},"*")}onUserInteraction(t){this.lastInteraction=Date.now(),window.postMessage({source:"symbiont-controller",type:"USER_INTERACTION",data:{click:{action:"pulse",intensity:.5},scroll:{action:"float",intensity:.3},type:{action:"wiggle",intensity:.2}}[t]||{action:"none",intensity:0}},"*")}onPageChange(){const t=this.analyzePage();t.type!==this.pageAnalysis.type&&(s.info(`Page type changed from ${this.pageAnalysis.type} to ${t.type}`),this.pageAnalysis=t,window.postMessage({source:"symbiont-controller",type:"PAGE_TYPE_CHANGED",data:{newType:t.type,keywords:t.keywords}},"*"))}feedOrganism(){window.postMessage({source:"symbiont-controller",type:"ORGANISM_ACTION",data:{action:"feed"}},"*")}toggleOrganismVisibility(){window.postMessage({source:"symbiont-controller",type:"TOGGLE_VISIBILITY",data:{}},"*")}getOrganismPosition(){const t=document.getElementById("symbiont-organism-container");if(t){const e=t.getBoundingClientRect();return{x:e.left,y:e.top}}return{x:0,y:0}}notifyBackgroundOfPageChange(){chrome.runtime.sendMessage({type:"PAGE_ANALYSIS_UPDATE",data:this.pageAnalysis}).catch((()=>{}))}destroy(){this.updateInterval&&clearInterval(this.updateInterval)}}chrome.storage.local.get(["symbiont_webgl_enabled"],(t=>{!1!==t.symbiont_webgl_enabled&&_.getInstance()})),console.log("[SYMBIONT] Content script loading..."),console.log("[SYMBIONT] Importing WebGL modules..."),console.log("[SYMBIONT] WebGL modules imported");class L{constructor(){this.pageData={startTime:Date.now(),url:window.location.href,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},this.latestLCP=0,s.info("ðŸ” SYMBIONT Content Script initializing..."),this.messageBus=new d("content"),this.navigationObserver=new u(this.messageBus),this.interactionCollector=new p(this.messageBus),this.domAnalyzer=new y,this.scrollTracker=new f(this.messageBus),this.attentionMonitor=new E(this.messageBus),this.initialize()}static getInstance(){return L.instance||(L.instance=new L),L.instance}initialize(){this.setupObservers(),this.setupEventListeners(),this.performInitialAnalysis(),window.addEventListener("beforeunload",this.cleanup.bind(this)),s.info("âœ… SYMBIONT Content Script ready")}setupObservers(){this.navigationObserver.observe((t=>{this.handleNavigationChange(t)})),this.interactionCollector.start({clicks:!0,keypresses:!0,forms:!0,media:!0}),this.interactionCollector.on("interaction",(t=>{this.handleInteraction(t)})),this.scrollTracker.on("scroll",(t=>{t&&"object"==typeof t&&"timestamp"in t&&this.updateScrollData(t)})),this.attentionMonitor.on("attentionChange",(t=>{t&&"object"==typeof t&&"isActive"in t&&this.handleAttentionChange(t)}))}setupEventListeners(){document.addEventListener("visibilitychange",(()=>{this.handleVisibilityChange()})),window.addEventListener("focus",(()=>this.handleWindowFocus(!0))),window.addEventListener("blur",(()=>this.handleWindowFocus(!1))),"PerformanceObserver"in window&&this.setupPerformanceObserver(),chrome.runtime.onMessage.addListener(((t,e,i)=>(this.messageBus.emit(t.type,{message:t,sender:e,sendResponse:i}),!0)))}setupPerformanceObserver(){new PerformanceObserver((t=>{for(const e of t.getEntries())"largest-contentful-paint"===e.entryType&&(this.latestLCP=e.startTime,this.handleLCP(e))})).observe({entryTypes:["largest-contentful-paint"]})}async performInitialAnalysis(){const t=await this.domAnalyzer.analyze();this.analyzeMainContent();const e=this.domAnalyzer.categorizeContent();this.messageBus.sendToBackground({type:"PAGE_ANALYSIS_COMPLETE",payload:{url:this.pageData.url,title:this.pageData.title,category:e,contentMetrics:{wordCount:t.wordCount,imageCount:t.imageCount,videoCount:t.videoCount,linkCount:t.linkCount,readingTime:t.estimatedReadingTime},performance:{loadTime:performance.now(),resourceCount:performance.getEntriesByType("resource").length}}})}analyzeMainContent(){this.domAnalyzer.extractMainContent()}handleInteraction(t){const e={...t,pageContext:{url:this.pageData.url,title:this.pageData.title,timeOnPage:Date.now()-this.pageData.startTime}};this.pageData.interactions.push(e),this.isSignificantInteraction(t)&&this.messageBus.sendToBackground({type:"INTERACTION_DETECTED",payload:e})}isSignificantInteraction(t){return"form_submit"===t.type||"video_play"===t.type||"click"===t.type&&t.data.isNavigation||"keypress"===t.type&&t.data.isShortcut}updateScrollData(t){this.pageData.scrollData.maxDepth=Math.max(this.pageData.scrollData.maxDepth,t.depth),this.pageData.scrollData.totalDistance+=Math.abs(t.delta),this.pageData.scrollData.pattern=this.scrollTracker.getScrollPattern()}handleAttentionChange(t){t.isActive?this.pageData.attention.totalActiveTime+=t.duration||0:this.pageData.attention.distractions++,this.messageBus.sendToBackground({type:"ATTENTION_UPDATE",payload:{url:this.pageData.url,state:t,duration:Date.now()-this.pageData.startTime}})}handleNavigationChange(t){this.finalizePage(),this.latestLCP=0,this.pageData={startTime:Date.now(),url:t.url,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},this.performInitialAnalysis()}handleVisibilityChange(){const t="visible"===document.visibilityState;this.messageBus.sendToBackground({type:"VISIBILITY_CHANGE",payload:{url:this.pageData.url,isVisible:t,timestamp:Date.now()}}),t?this.attentionMonitor.start():this.attentionMonitor.stop()}handleWindowFocus(t){this.messageBus.sendToBackground({type:"FOCUS_CHANGE",payload:{url:this.pageData.url,hasFocus:t,timestamp:Date.now()}})}finalizePage(){const t=Date.now()-this.pageData.startTime;if(t<1e3)return;const e={url:this.pageData.url,title:this.pageData.title,startTime:this.pageData.startTime,duration:t,interactions:this.pageData.interactions,scrollData:this.pageData.scrollData,attention:{totalActiveTime:this.pageData.attention.totalActiveTime,distractionCount:this.pageData.attention.distractions,focusPeriods:this.attentionMonitor.getStats().focusPeriods||[]},performance:this.collectPerformanceMetrics()};this.latestLCP=0,this.messageBus.sendToBackground({type:"PAGE_SESSION_COMPLETE",payload:e})}collectPerformanceMetrics(){const t=performance.getEntriesByType("navigation"),e=t.length>0?t[0]:null;return{loadTime:e?e.loadEventEnd-e.startTime:0,domContentLoaded:e?e.domContentLoadedEventEnd-e.startTime:0,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint(),largestContentfulPaint:this.latestLCP,resourceCount:performance.getEntriesByType("resource").length}}getFirstPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-paint"===t.name));return t?t.startTime:0}getFirstContentfulPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-contentful-paint"===t.name));return t?t.startTime:0}handleLCP(t){t.startTime>2500&&s.debug("Slow LCP detected:",t.startTime)}cleanup(){this.finalizePage(),this.navigationObserver.disconnect(),this.interactionCollector.stop(),this.scrollTracker.stop(),this.attentionMonitor.stop(),s.info("ðŸ§¹ SYMBIONT Content Script cleaned up")}}window.__SYMBIONT_CONTENT_SCRIPT_LOADED__||(window.__SYMBIONT_CONTENT_SCRIPT_LOADED__=!0,L.getInstance())})();