(()=>{"use strict";var t;!function(t){t.PAGE_VISIT="PAGE_VISIT",t.SCROLL_EVENT="SCROLL_EVENT",t.ORGANISM_UPDATE="ORGANISM_UPDATE",t.ORGANISM_MUTATE="ORGANISM_MUTATE",t.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",t.WEBGL_INIT="WEBGL_INIT",t.WEBGL_ERROR="WEBGL_ERROR",t.WEBGL_INITIALIZED="WEBGL_INITIALIZED",t.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",t.GENERATE_INVITATION="GENERATE_INVITATION",t.INVITATION_GENERATED="INVITATION_GENERATED",t.CONSUME_INVITATION="CONSUME_INVITATION",t.INVITATION_CONSUMED="INVITATION_CONSUMED",t.CHECK_INVITATION="CHECK_INVITATION",t.INVITATION_CHECKED="INVITATION_CHECKED",t.MURMUR="MURMUR",t.GET_INVITER="GET_INVITER",t.INVITER_RESULT="INVITER_RESULT",t.GET_INVITEES="GET_INVITEES",t.INVITEES_RESULT="INVITEES_RESULT",t.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",t.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",t.INTERACTION_DETECTED="INTERACTION_DETECTED",t.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",t.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",t.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",t.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",t.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",t.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",t.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",t.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",t.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED"}(t||(t={}));class e{constructor(t){this.source=t,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){chrome.runtime.onMessage.addListener(((t,e,n)=>(this.shouldProcessMessage(t)&&(this.enqueueMessage(t),n({received:!0})),!1)))}shouldProcessMessage(t){return this.filters.every((e=>e(t)))}async enqueueMessage(t){this.messageQueue.push(t),this.processing||(this.processing=!0,await this.processQueue(),this.processing=!1)}async processQueue(){for(;this.messageQueue.length>0;){const t=this.messageQueue.shift();await this.processMessage(t)}}async processMessage(e){if(!function(e,n){switch(e){case t.ORGANISM_UPDATE:return(s=n)&&"string"==typeof s.id&&"number"==typeof s.generation;case t.ORGANISM_MUTATE:return function(t){return t&&"string"==typeof t.type&&"string"==typeof t.trigger}(n);case t.PAGE_VISIT:case t.SCROLL_EVENT:return function(t){return t&&"string"==typeof t.url&&"number"==typeof t.visitCount}(n);case t.MURMUR:return function(t){return t&&"string"==typeof t.text&&"number"==typeof t.timestamp}(n);case t.GENERATE_INVITATION:case t.CONSUME_INVITATION:case t.CHECK_INVITATION:return function(t){return t&&"string"==typeof t.code}(n);case t.INVITATION_GENERATED:case t.INVITATION_CONSUMED:case t.INVITATION_CHECKED:return function(t){return t&&"string"==typeof t.code&&"string"==typeof t.status}(n);default:return!0}var s}(e.type,e.payload))return void console.warn(`[MessageBus] Payload non valide pour le type ${e.type}`,e.payload);for(const t of this.globalHandlers)try{await t(e)}catch(t){console.error("Error in global handler:",t)}const n=this.handlers.get(e.type);if(n)for(const t of n)try{await t(e)}catch(t){console.error(`Error in handler for ${e.type}:`,t)}}on(t,e){this.handlers.has(t)||this.handlers.set(t,new Set),this.handlers.get(t).add(e)}off(t,e){const n=this.handlers.get(t);n&&n.delete(e)}onAny(t){this.globalHandlers.add(t)}offAny(t){this.globalHandlers.delete(t)}addFilter(t){this.filters.push(t)}async send(t){const e={...t,source:this.source,timestamp:Date.now(),id:crypto.randomUUID()};try{if("content"===this.source)await chrome.runtime.sendMessage(e);else{const t=await chrome.tabs.query({});for(const n of t)n.id&&chrome.tabs.sendMessage(n.id,e).catch((()=>{}));chrome.runtime.sendMessage(e).catch((()=>{}))}}catch(t){console.error("Error sending message:",t)}}sendToBackground(t){this.send(t)}emit(t,e){const n=this.handlers.get(t);n&&n.forEach((n=>n({type:t,payload:e})))}}class n{constructor(t){this.handler=null}observe(t){this.handler=t}disconnect(){this.handler=null}}class s{on(t,e){}start(t){}stop(){}}class a{analyze(){return{wordCount:1e3,imageCount:10,videoCount:2,linkCount:20,estimatedReadingTime:5}}extractMainContent(){return{}}categorizeContent(){return"article"}}class i{on(t,e){}detectPattern(){return"unknown"}stop(){}}class r{on(t,e){}resume(){}pause(){}stop(){}getSessionSummary(){return{focusPeriods:[]}}}class o{constructor(){this.pageData={startTime:Date.now(),url:window.location.href,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},console.log("🔍 SYMBIONT Content Script initializing..."),this.messageBus=new e("content"),this.navigationObserver=new n,this.interactionCollector=new s,this.domAnalyzer=new a,this.scrollTracker=new i,this.attentionMonitor=new r,this.initialize()}static getInstance(){return o.instance||(o.instance=new o),o.instance}initialize(){this.setupObservers(),this.setupEventListeners(),this.performInitialAnalysis(),window.addEventListener("beforeunload",this.cleanup.bind(this)),console.log("✅ SYMBIONT Content Script ready")}setupObservers(){this.navigationObserver.observe((t=>{this.handleNavigationChange(t)})),this.interactionCollector.start({clicks:!0,keypresses:!0,forms:!0,media:!0}),this.interactionCollector.on("interaction",(t=>{this.handleInteraction(t)})),this.scrollTracker.on("scroll",(t=>{this.updateScrollData(t)})),this.attentionMonitor.on("attentionChange",(t=>{this.handleAttentionChange(t)}))}setupEventListeners(){document.addEventListener("visibilitychange",(()=>{this.handleVisibilityChange()})),window.addEventListener("focus",(()=>this.handleWindowFocus(!0))),window.addEventListener("blur",(()=>this.handleWindowFocus(!1))),"PerformanceObserver"in window&&this.setupPerformanceObserver(),chrome.runtime.onMessage.addListener(((t,e,n)=>(this.messageBus.emit(t.type,{message:t,sender:e,sendResponse:n}),!0)))}setupPerformanceObserver(){new PerformanceObserver((t=>{for(const e of t.getEntries())"largest-contentful-paint"===e.entryType&&this.handleLCP(e)})).observe({entryTypes:["largest-contentful-paint"]})}async performInitialAnalysis(){const t=await this.domAnalyzer.analyze(),e=(this.domAnalyzer.extractMainContent(),this.domAnalyzer.categorizeContent());this.messageBus.sendToBackground({type:"PAGE_ANALYSIS_COMPLETE",payload:{url:this.pageData.url,title:this.pageData.title,category:e,contentMetrics:{wordCount:t.wordCount,imageCount:t.imageCount,videoCount:t.videoCount,linkCount:t.linkCount,readingTime:t.estimatedReadingTime},performance:{loadTime:performance.now(),resourceCount:performance.getEntriesByType("resource").length}}})}handleInteraction(t){const e={...t,pageContext:{url:this.pageData.url,title:this.pageData.title,timeOnPage:Date.now()-this.pageData.startTime}};this.pageData.interactions.push(e),this.isSignificantInteraction(t)&&this.messageBus.sendToBackground({type:"INTERACTION_DETECTED",payload:e})}isSignificantInteraction(t){return"form_submit"===t.type||"video_play"===t.type||"click"===t.type&&t.data.isNavigation||"keypress"===t.type&&t.data.isShortcut}updateScrollData(t){this.pageData.scrollData.maxDepth=Math.max(this.pageData.scrollData.maxDepth,t.depth),this.pageData.scrollData.totalDistance+=Math.abs(t.delta),this.pageData.scrollData.pattern=this.scrollTracker.detectPattern()}handleAttentionChange(t){t.isActive?this.pageData.attention.totalActiveTime+=t.duration||0:this.pageData.attention.distractions++,this.messageBus.sendToBackground({type:"ATTENTION_UPDATE",payload:{url:this.pageData.url,state:t,duration:Date.now()-this.pageData.startTime}})}handleNavigationChange(t){this.finalizePage(),this.pageData={startTime:Date.now(),url:t.url,title:document.title,interactions:[],scrollData:{maxDepth:0,totalDistance:0,pattern:"unknown"},attention:{totalActiveTime:0,distractions:0}},this.performInitialAnalysis()}handleVisibilityChange(){const t="visible"===document.visibilityState;this.messageBus.sendToBackground({type:"VISIBILITY_CHANGE",payload:{url:this.pageData.url,isVisible:t,timestamp:Date.now()}}),t?this.attentionMonitor.resume():this.attentionMonitor.pause()}handleWindowFocus(t){this.messageBus.sendToBackground({type:"FOCUS_CHANGE",payload:{url:this.pageData.url,hasFocus:t,timestamp:Date.now()}})}finalizePage(){const t=Date.now()-this.pageData.startTime;if(t<1e3)return;const e={url:this.pageData.url,title:this.pageData.title,startTime:this.pageData.startTime,duration:t,interactions:this.pageData.interactions,scrollData:this.pageData.scrollData,attention:{totalActiveTime:this.pageData.attention.totalActiveTime,distractionCount:this.pageData.attention.distractions,focusPeriods:this.attentionMonitor.getSessionSummary().focusPeriods},performance:this.collectPerformanceMetrics()};this.messageBus.sendToBackground({type:"PAGE_SESSION_COMPLETE",payload:e})}collectPerformanceMetrics(){const t=performance.getEntriesByType("navigation"),e=t.length>0?t[0]:null;return{loadTime:e?e.loadEventEnd-e.startTime:0,domContentLoaded:e?e.domContentLoadedEventEnd-e.startTime:0,firstPaint:this.getFirstPaint(),firstContentfulPaint:this.getFirstContentfulPaint(),largestContentfulPaint:this.getLargestContentfulPaint(),resourceCount:performance.getEntriesByType("resource").length}}getFirstPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-paint"===t.name));return t?t.startTime:0}getFirstContentfulPaint(){const t=performance.getEntriesByType("paint").find((t=>"first-contentful-paint"===t.name));return t?t.startTime:0}getLargestContentfulPaint(){const t=performance.getEntriesByType("largest-contentful-paint");return t.length>0?t[t.length-1].startTime:0}handleLCP(t){t.startTime>2500&&console.debug("Slow LCP detected:",t.startTime)}cleanup(){this.finalizePage(),this.navigationObserver.disconnect(),this.interactionCollector.stop(),this.scrollTracker.stop(),this.attentionMonitor.stop(),console.log("🧹 SYMBIONT Content Script cleaned up")}}window.__SYMBIONT_CONTENT_SCRIPT_LOADED__||(window.__SYMBIONT_CONTENT_SCRIPT_LOADED__=!0,o.getInstance())})();