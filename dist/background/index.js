(()=>{"use strict";var e,t={18:(e,t,r)=>{r.d(t,{Dm:()=>n});var i=r(513);class n{static random(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/(this.MAX_UINT32+1)}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random numbers.");throw i.vF.error("SecureRandom: CRITICAL SECURITY FAILURE",e),e}static randomInt(e,t){if(e>=t)throw new Error("SecureRandom: min doit √™tre inf√©rieur √† max");const r=t-e;return Math.floor(this.random()*r)+e}static randomFloat(e,t){if(e>=t)throw new Error("SecureRandom: min doit √™tre inf√©rieur √† max");return this.random()*(t-e)+e}static randomBytes(e){if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}const t=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random bytes.");throw i.vF.error("SecureRandom: CRITICAL SECURITY FAILURE in randomBytes",t),t}static choice(e){if(0===e.length)throw new Error("SecureRandom: Le tableau ne peut pas √™tre vide");return e[this.randomInt(0,e.length)]}static uuid(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20,32)].join("-")}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure UUID.");throw i.vF.error("SecureRandom: CRITICAL SECURITY FAILURE in uuid",e),e}static randomString(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r="";for(let i=0;i<e;i++)r+=t.charAt(this.randomInt(0,t.length));return r}static randomId(e="",t=8){const r=this.randomString(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return e?`${e}_${r}`:r}}n.MAX_UINT32=4294967295,n.random,n.randomInt,n.randomFloat},194:(e,t,r)=>{r.r(t),r.d(t,{NeuralMesh:()=>s});var i=r(849),n=r(513);class s{constructor(){this.nodes=new Map,this.connections=new Map,this.activations=new Map,this.learningRate=.01}addNode(e,t,r=0){const i={type:t,activation:0,bias:r};this.nodes.set(e,i),this.activations.set(e,0)}addConnection(e,t,r){if(!this.nodes.has(e)||!this.nodes.has(t))throw new Error(`Cannot connect non-existent nodes: ${e} -> ${t}`);this.connections.has(e)||this.connections.set(e,new Map),this.connections.get(e).set(t,r)}stimulate(e,t){const r=this.nodes.get(e);r&&"input"===r.type?this.activations.set(e,t):n.vF.warn(`Cannot stimulate non-input node: ${e}`)}propagate(){for(const[e,t]of this.nodes)if("input"!==t.type){const r=Number.isFinite(t.bias)?t.bias:0;this.activations.set(e,r)}for(const[e,t]of this.connections){const r=this.activations.get(e)||0;if(Number.isFinite(r))for(const[i,s]of t){if(!Number.isFinite(s)){n.vF.warn(`NeuralMesh: Invalid weight from ${e} to ${i}: ${s}, skipping connection`);continue}const t=this.activations.get(i)||0;if(!Number.isFinite(t)){n.vF.warn(`NeuralMesh: Invalid current activation for node ${i}: ${t}, resetting to 0`),this.activations.set(i,0);continue}const a=r*s;if(!Number.isFinite(a)){n.vF.warn(`NeuralMesh: Invalid weighted input from ${e} to ${i}, skipping`);continue}const o=t+a;if(!Number.isFinite(o)){n.vF.warn(`NeuralMesh: Invalid new activation for node ${i}: ${o}, using current`);continue}const c=this.sigmoid(o);this.activations.set(i,c)}else n.vF.warn(`NeuralMesh: Invalid activation from node ${e}: ${r}, skipping`)}for(const[e,t]of this.activations)Number.isFinite(t)||(n.vF.error(`NeuralMesh: CRITICAL - Node ${e} has invalid activation ${t}, resetting to 0`),this.activations.set(e,0))}sigmoid(e){if(!Number.isFinite(e))return n.vF.warn(`NeuralMesh: Invalid sigmoid input: ${e}, using 0.5 as fallback`),.5;const t=Math.max(-500,Math.min(500,e));try{const r=1/(1+Math.exp(-t));return Number.isFinite(r)?r:(n.vF.warn(`NeuralMesh: Invalid sigmoid output for input ${e}, using 0.5 as fallback`),.5)}catch(t){return n.vF.error("NeuralMesh: Sigmoid computation error",{input:e,error:t}),.5}}getActivation(e){return this.activations.get(e)||0}mutate(e=.05){for(const t of this.connections.values())for(const[r,n]of t)i.tm.random()<e&&(t.set(r,n+.2*(i.tm.random()-.5)),t.set(r,Math.max(-2,Math.min(2,t.get(r)||0))));for(const t of this.nodes.values())i.tm.random()<e&&(t.bias+=.1*(i.tm.random()-.5),t.bias=Math.max(-1,Math.min(1,t.bias)))}getNeuralActivity(){let e=0,t=0;for(const r of this.activations.values())e+=Math.abs(r),t++;return t>0?e/t:0}getConnectionStrength(){let e=0,t=0;for(const r of this.connections.values())for(const i of r.values())e+=Math.abs(i),t++;return t>0?e/t:0}toJSON(){return{nodes:Array.from(this.nodes.values()),connections:Array.from(this.connections.values()).map((e=>Array.from(e.entries()))),activations:Object.fromEntries(this.activations)}}async initialize(){0===this.nodes.size&&this.setupDefaultNetwork(),this.propagate()}setupDefaultNetwork(){this.addNode("sensory_input","input"),this.addNode("memory_input","input"),this.addNode("processing_1","hidden",.1),this.addNode("processing_2","hidden",-.1),this.addNode("motor_output","output"),this.addNode("emotion_output","output"),this.addConnection("sensory_input","processing_1",.8),this.addConnection("memory_input","processing_2",.6),this.addConnection("processing_1","motor_output",.9),this.addConnection("processing_2","emotion_output",.7),this.addConnection("processing_1","processing_2",.3)}async suspend(){this.activations.clear(),n.vF.info("Neural mesh suspended")}async getCPUUsage(){const e=this.nodes.size*this.connections.size;return Math.min(1,e/1e3)}async getMemoryUsage(){const e=64*(this.nodes.size+this.connections.size);return Math.min(1,e/1048576)}saveState(){return{nodes:Object.fromEntries(this.nodes),connections:Object.fromEntries(Array.from(this.connections.entries()).map((([e,t])=>[e,Object.fromEntries(t)]))),activations:Object.fromEntries(this.activations)}}loadState(e){if(e.nodes){this.nodes.clear();for(const[t,r]of Object.entries(e.nodes))this.nodes.set(t,r)}if(e.connections){this.connections.clear();for(const[t,r]of Object.entries(e.connections))this.connections.set(t,new Map(Object.entries(r)))}if(e.activations){this.activations.clear();for(const[t,r]of Object.entries(e.activations))this.activations.set(t,r)}}reset(){this.nodes.clear(),this.connections.clear(),this.activations.clear(),this.setupDefaultNetwork()}healthCheck(){const e=[];0===this.nodes.size&&e.push("No nodes in neural mesh"),0===this.connections.size&&e.push("No connections in neural mesh");const t=new Set;for(const[e,r]of this.connections){t.add(e);for(const e of r.keys())t.add(e)}const r=Array.from(this.nodes.keys()).filter((e=>!t.has(e)));return r.length>0&&e.push(`Orphaned nodes: ${r.join(", ")}`),{healthy:0===e.length,issues:e}}cleanup(){this.nodes.clear(),this.connections.clear(),this.activations.clear()}async processPattern(e){if(e&&"object"==typeof e){const t=Array.from(this.nodes.entries()).filter((([,e])=>"input"===e.type)).map((([e])=>e));Object.entries(e).forEach((([,e],r)=>{r<t.length&&"number"==typeof e&&this.stimulate(t[r],e)})),this.propagate();const r=Array.from(this.nodes.entries()).filter((([,e])=>"output"===e.type));return Object.fromEntries(r.map((([e])=>[e,this.getActivation(e)])))}return{}}async learn(e){if(e&&"object"==typeof e&&"feedback"in e&&"number"==typeof e.feedback){const t=.01*Math.abs(e.feedback);this.mutate(t)}}getPerformanceMetrics(){return{nodeCount:this.nodes.size,connectionCount:Array.from(this.connections.values()).reduce(((e,t)=>e+t.size),0),neuralActivity:this.getNeuralActivity(),connectionStrength:this.getConnectionStrength()}}}},455:(e,t,r)=>{r.d(t,{lk:()=>s,wP:()=>a});var i=r(18),n=r(513);function s(){if("undefined"!=typeof crypto&&crypto.randomUUID)try{return crypto.randomUUID()}catch(e){n.vF.warn("crypto.randomUUID failed, using fallback",{error:e})}return i.Dm.uuid()}function a(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():i.Dm.uuid()}},502:(e,t,r)=>{r.r(t),r.d(t,{OrganismCore:()=>p});var i=r(513);class n{constructor(){this.errorQueue=[],this.maxQueueSize=1e3,this.logLevel="warning",this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0}}static getInstance(){return n.instance||(n.instance=new n),n.instance}setLogLevel(e){this.logLevel=e}logError(e){this.updateMetrics(e),this.addToQueue(e),this.outputError(e)}logSimpleError(e,t,r,i="error",n){const s=r instanceof Error?r.message:String(r),a={component:e,method:t,timestamp:Date.now(),severity:i,details:{message:s,context:n,originalError:r instanceof Error?{name:r.name,stack:r.stack}:void 0}};console["warning"===i?"warn":"debug"===i?"debug":"info"===i?"info":"error"](`[${e}][${t}] ${s}`,n||""),this.recordError(a)}validateRequired(e,t,r,i){const n=[];null==e&&n.push(`${t} is required`);const s={isValid:0===n.length,errors:n,warnings:[],context:{component:r,method:i,timestamp:Date.now(),severity:n.length>0?"error":"info"}};return s.isValid||this.logError(s.context),s}validateType(e,t,r={},i,n,s){const a=[];if(r.required&&null==e&&a.push(`${i} is required`),null!=e){const n=typeof e;n!==t&&a.push(`${i} must be of type ${t}, got ${n}`),"number"===t&&"number"==typeof e&&(void 0!==r.min&&e<r.min&&a.push(`${i} must be >= ${r.min}`),void 0!==r.max&&e>r.max&&a.push(`${i} must be <= ${r.max}`),Number.isFinite(e)||a.push(`${i} must be a finite number`)),"string"===t&&"string"==typeof e&&(void 0!==r.min&&e.length<r.min&&a.push(`${i} must be at least ${r.min} characters long`),void 0!==r.max&&e.length>r.max&&a.push(`${i} must be at most ${r.max} characters long`),r.pattern&&!r.pattern.test(e)&&a.push(`${i} does not match required pattern`))}const o={isValid:0===a.length,errors:a,warnings:[],context:{component:n,method:s,timestamp:Date.now(),severity:a.length>0?"error":"warning",details:{fieldName:i,expectedType:t,actualValue:e}}};return o.isValid||this.logError(o.context),o}async withRetry(e,t,r){let i=null;for(let n=1;n<=t.maxRetries;n++){this.metrics.recoveryAttempts++;try{const t=await e();return n>1&&(this.metrics.recoverySuccesses++,this.logSimpleError(r.component,r.method,`Recovery successful after ${n} attempts`,"info")),t}catch(e){if(i=e instanceof Error?e:new Error(String(e)),this.logSimpleError(r.component,r.method,`Attempt ${n}/${t.maxRetries} failed: ${i.message}`,"warning"),n<t.maxRetries&&t.shouldRetry(i,n)){await this.delay(t.backoffMs*n);continue}break}}if(this.logSimpleError(r.component,r.method,`All ${t.maxRetries} retry attempts failed. Last error: ${i?.message}`,"error"),void 0!==t.fallbackValue)return t.fallbackValue;throw i}safeExecute(e,t,r){try{return e()}catch(e){return this.logSimpleError(r.component,r.method,e,"error"),t}}async safeExecuteAsync(e,t,r){try{return await e()}catch(e){return this.logSimpleError(r.component,r.method,e,"error"),t}}getMetrics(){return{...this.metrics}}getRecentErrors(e=50){return this.errorQueue.slice(-e)}reset(){this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0},this.errorQueue=[]}updateMetrics(e){this.metrics.errorCount++,this.metrics.lastErrorTime=e.timestamp;const t=this.metrics.errorsByComponent.get(e.component)||0;this.metrics.errorsByComponent.set(e.component,t+1);const r=`${e.component}.${e.method}`,i=this.metrics.errorsByMethod.get(r)||0;this.metrics.errorsByMethod.set(r,i+1)}addToQueue(e){this.errorQueue.push(e),this.errorQueue.length>this.maxQueueSize&&(this.errorQueue=this.errorQueue.slice(-this.maxQueueSize))}outputError(e){if(!this.shouldLog(e.severity))return;const t=`[${new Date(e.timestamp).toISOString()}] ${e.severity.toUpperCase()} ${e.component}.${e.method}`;switch(e.severity){case"critical":case"error":i.vF.error(t,e.details);break;case"warning":i.vF.warn(t,e.details);break;case"info":console.info(t,e.details);break;case"debug":i.vF.debug(t,e.details)}}shouldLog(e){const t=["debug","info","warning","error","critical"],r=t.indexOf(this.logLevel);return t.indexOf(e)>=r}delay(e){return new Promise((t=>setTimeout(t,e)))}recordError(e){this.updateMetrics(e),this.addToQueue(e)}}n.instance=null;const s=n.getInstance();class a{constructor(e){this.history=[],this.listeners=[],this.traits={curiosity:.5,focus:.5,rhythm:.5,empathy:.5,creativity:.5,memory:.5,intuition:.5,resilience:.5,adaptability:.5,collaboration:.5,...e}}updateTrait(e,t,r="manual"){const i=this.traits[e],n=Math.max(0,Math.min(1,t));this.traits[e]=n,this.history.push({trait:e,value:n,timestamp:Date.now(),trigger:r});const s={traitName:e,oldValue:i,newValue:n,timestamp:Date.now()};this.listeners.forEach((e=>e(s)))}updateTraits(e,t="batch"){Object.entries(e).forEach((([e,r])=>{"number"==typeof r&&this.updateTrait(e,r,t)}))}getTrait(e){return this.traits[e]}getAllTraits(){return{...this.traits}}getTraitHistory(e){return this.history.filter((t=>t.trait===e))}getFullHistory(e=100){return this.history.slice(-e)}normalizeTraits(){Object.keys(this.traits).forEach((e=>{const t=e,r=this.traits[t];(r<0||r>1)&&this.updateTrait(t,Math.max(0,Math.min(1,r)),"normalization")}))}calculateBalance(){const e=Object.values(this.traits),t=e.reduce(((e,t)=>e+t),0)/e.length,r=e.reduce(((e,r)=>e+Math.pow(r-t,2)),0)/e.length;return Math.max(0,1-r)}addTraitChangeListener(e){this.listeners.push(e)}removeTraitChangeListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}cleanup(e=864e5){const t=Date.now()-e;this.history=this.history.filter((e=>e.timestamp>t))}toJSON(){return{traits:{...this.traits},history:[...this.history]}}fromJSON(e){this.traits={...e.traits},this.history=[...e.history]}}class o{constructor(e,t="BoundedArray"){this.items=[],this.maxSize=Math.max(1,e),this.name=t}add(e){if(this.items.push(e),this.items.length>this.maxSize){const e=this.items.splice(0,this.items.length-this.maxSize);i.vF.debug(`${this.name}: Cleaned ${e.length} old items, keeping ${this.items.length}/${this.maxSize}`)}}addBatch(e){if(this.items.push(...e),this.items.length>this.maxSize){const e=this.items.splice(0,this.items.length-this.maxSize);i.vF.debug(`${this.name}: Batch cleaned ${e.length} old items`)}}getAll(){return this.items}getRecent(e){return this.items.slice(-Math.min(e,this.items.length))}slice(e,t){return this.items.slice(e,t)}filter(e){return this.items.filter(e)}reduce(e,t){return this.items.reduce(e,t)}[Symbol.iterator](){return this.items[Symbol.iterator]()}get length(){return this.items.length}clear(){const e=this.items.length;this.items=[],i.vF.debug(`${this.name}: Cleared ${e} items`)}size(){return this.items.length}isFull(){return this.items.length>=this.maxSize}getMemoryUsage(){return{count:this.items.length,maxSize:this.maxSize,utilizationPercent:this.items.length/this.maxSize*100}}}class c{constructor(e=100,t){this.listeners=[],this.regenerationTimer=null,this.config={baseRegenRate:1,maxEnergy:100,decayRate:.1,efficiencyFactor:1,...t},this.maxEnergy=this.config.maxEnergy,this.energy=Math.min(e,this.maxEnergy),this.metabolismRate=this.config.baseRegenRate,this.history=new o(100,"EnergyHistory"),this.startMetabolism()}startMetabolism(){this.regenerationTimer||(this.regenerationTimer=setInterval((()=>{this.passiveRegeneration()}),1e3))}stopMetabolism(){this.regenerationTimer&&(clearInterval(this.regenerationTimer),this.regenerationTimer=null)}passiveRegeneration(){const e=this.metabolismRate*this.config.efficiencyFactor-this.config.decayRate;if(e>0&&this.energy<this.maxEnergy){const t=this.energy;this.energy=Math.min(this.maxEnergy,this.energy+e),this.recordEvent({type:"regeneration",amount:this.energy-t,source:"passive_metabolism",timestamp:Date.now(),energyBefore:t,energyAfter:this.energy})}else if(e<0){const t=this.energy;this.energy=Math.max(0,this.energy+e),this.recordEvent({type:"drain",amount:Math.abs(e),source:"natural_decay",timestamp:Date.now(),energyBefore:t,energyAfter:this.energy})}}consumeEnergy(e,t="unknown"){if(e<=0)return!0;if(this.energy<e)return!1;const r=this.energy;return this.energy-=e,this.recordEvent({type:"consumption",amount:e,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy}),!0}forceConsumeEnergy(e,t="forced"){const r=this.energy,i=Math.min(e,this.energy);return this.energy-=i,this.recordEvent({type:"consumption",amount:i,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy}),i}addEnergy(e,t="boost"){if(e<=0)return;const r=this.energy;this.energy=Math.min(this.maxEnergy,this.energy+e),this.recordEvent({type:"boost",amount:this.energy-r,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy})}regenerateEnergy(e){const t=e||this.metabolismRate;this.addEnergy(t,"manual_regeneration")}getEnergyLevel(){return this.energy}getEnergyPercentage(){return this.energy/this.maxEnergy*100}getMaxEnergy(){return this.maxEnergy}hasEnergy(e){return this.energy>=e}isExhausted(){return 0===this.energy}isFullEnergy(){return this.energy===this.maxEnergy}setMetabolismRate(e){this.metabolismRate=Math.max(0,e)}setEfficiency(e){this.config.efficiencyFactor=Math.max(.1,Math.min(2,e))}increaseMaxEnergy(e){this.maxEnergy+=e,this.config.maxEnergy=this.maxEnergy}recordEvent(e){this.history.add(e),this.listeners.forEach((t=>t(e)))}getEnergyHistory(e=50){return this.history.slice(-e)}getEnergyStats(){const e=this.history.filter((e=>"consumption"===e.type)),t=this.history.filter((e=>"regeneration"===e.type||"boost"===e.type)),r=e.reduce(((e,t)=>e+t.amount),0),i=t.reduce(((e,t)=>e+t.amount),0);return{current:this.energy,max:this.maxEnergy,percentage:this.getEnergyPercentage(),metabolismRate:this.metabolismRate,efficiency:this.config.efficiencyFactor,totalConsumed:r,totalRegenerated:i}}addEnergyListener(e){this.listeners.push(e)}removeEnergyListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}cleanup(e=864e5){const t=Date.now()-e,r=this.history.filter((e=>e.timestamp>t));this.history.clear(),this.history.addBatch(r)}toJSON(){return{energy:this.energy,maxEnergy:this.maxEnergy,metabolismRate:this.metabolismRate,config:{...this.config},history:[...this.history]}}fromJSON(e){this.energy=e.energy,this.maxEnergy=e.maxEnergy,this.metabolismRate=e.metabolismRate,this.config={...e.config},this.history.clear(),this.history.addBatch(e.history)}destroy(){this.stopMetabolism(),this.listeners=[],this.history.clear()}}class h{constructor(e){this.processingQueue=[],this.isProcessing=!1,this.MAX_QUEUE_SIZE=1e3,this.BATCH_SIZE=10,this.mesh=e}async processStimulus(e,t){const r=Date.now();try{const i=this.convertStimulusToPattern(e),n=this.mesh.processPattern?await this.mesh.processPattern(i):{},s=this.convertResultToTraitAdaptations(n,t),a=Date.now()-r;return{success:!0,adaptations:s,confidence:n.confidence||.8,processingTime:a}}catch(e){return i.vF.error("Erreur de traitement neural:",e),{success:!1,adaptations:{},confidence:0,processingTime:Date.now()-r}}}queuePattern(e){this.processingQueue.length>=this.MAX_QUEUE_SIZE&&(i.vF.warn("Neural processing queue at maximum capacity, dropping oldest pattern"),this.processingQueue.shift()),this.processingQueue.push(e),this.isProcessing||this.processQueue()}async processQueue(){if(!this.isProcessing&&0!==this.processingQueue.length){for(this.isProcessing=!0;this.processingQueue.length>0;){const e=Math.min(this.BATCH_SIZE,this.processingQueue.length);for(let t=0;t<e;t++){const e=this.processingQueue.shift();if(e)try{this.mesh.learn&&await this.mesh.learn(e.data)}catch(e){i.vF.error("Erreur apprentissage neural:",e)}}this.processingQueue.length>0&&await new Promise((e=>setTimeout(e,0)))}this.isProcessing=!1}}convertStimulusToPattern(e){return"object"==typeof e&&null!==e?{type:e.type||"unknown",intensity:e.intensity||.5,context:e.context||{},timestamp:Date.now()}:{type:"simple",intensity:.5,data:e,timestamp:Date.now()}}convertResultToTraitAdaptations(e,t){const r={};if(e&&"object"==typeof e&&(e.traitSuggestions&&Object.entries(e.traitSuggestions).forEach((([e,i])=>{if(e in t&&"number"==typeof i){const n=t[e],s=.1,a=Math.max(-s,Math.min(s,i-n));r[e]=n+a}})),e.activityType))switch(e.activityType){case"exploration":r.curiosity=this.adjustTrait(t.curiosity,.05),r.adaptability=this.adjustTrait(t.adaptability,.03);break;case"focus":r.focus=this.adjustTrait(t.focus,.05),r.memory=this.adjustTrait(t.memory,.02);break;case"social":r.empathy=this.adjustTrait(t.empathy,.04),r.collaboration=this.adjustTrait(t.collaboration,.04);break;case"creative":r.creativity=this.adjustTrait(t.creativity,.05),r.intuition=this.adjustTrait(t.intuition,.03)}return r}adjustTrait(e,t){return Math.max(0,Math.min(1,e+t))}async learn(e){try{return this.mesh.learn&&await this.mesh.learn(e),!0}catch(e){return i.vF.error("Erreur apprentissage:",e),!1}}getPerformanceMetrics(){try{return this.mesh.getPerformanceMetrics?this.mesh.getPerformanceMetrics():{nodeCount:0,connectionCount:0,neuralActivity:0,connectionStrength:0}}catch(e){return i.vF.error("Erreur m√©triques:",e),{processingTime:0,accuracy:0,memoryUsage:0}}}saveState(){try{return this.mesh.saveState()}catch(e){return i.vF.error("Erreur sauvegarde √©tat neural:",e),null}}loadState(e){try{return this.mesh.loadState(e),!0}catch(e){return i.vF.error("Erreur chargement √©tat neural:",e),!1}}reset(){try{this.mesh.reset(),this.processingQueue=[],this.isProcessing=!1}catch(e){i.vF.error("Erreur reset neural:",e)}}cleanup(){this.processingQueue=[],this.isProcessing=!1,"function"==typeof this.mesh.cleanup&&this.mesh.cleanup()}healthCheck(){const e=[];this.mesh||e.push("R√©seau neural non initialis√©"),this.processingQueue.length>1e3&&e.push("Queue de traitement surcharg√©e");try{this.getPerformanceMetrics().processingTime>1e3&&e.push("Temps de traitement √©lev√©")}catch{e.push("M√©triques non disponibles")}return{healthy:0===e.length,issues:e}}async initialize(){await this.mesh.initialize()}async suspend(){await this.mesh.suspend()}update(e){const t=e/16.67,r=Math.ceil(t);for(let e=0;e<r&&this.processingQueue.length>0;e++){const e=this.processingQueue.shift();e&&this.mesh.learn&&this.mesh.learn(e.data).catch((e=>{i.vF.error("Neural processing error:",e)}))}}stimulate(e,t){this.mesh.stimulate(e,t)}getNeuralActivity(){return this.mesh.getNeuralActivity()}}class l{constructor(){this.metricsCache=new Map,this.isProduction=!0}static getInstance(){return l.instance||(l.instance=new l),l.instance}async getMemoryMetrics(){try{if("memory"in performance){const e=performance.memory;return{used:e.usedJSHeapSize,total:e.totalJSHeapSize,percentage:e.usedJSHeapSize/e.jsHeapSizeLimit*100}}const e=this.estimateMemoryUsage();return{used:e,total:2*e,percentage:50}}catch(e){return i.vF.warn("Erreur collecte m√©moire, fallback estimation:",e),this.getFallbackMemoryMetrics()}}async getTimingMetrics(){try{const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint"),r=t.find((e=>"first-paint"===e.name))?.startTime||0,i=t.find((e=>"first-contentful-paint"===e.name))?.startTime||0;return{loadTime:e?e.loadEventEnd-e.fetchStart:0,domReady:e?e.domContentLoadedEventEnd-e.fetchStart:0,firstPaint:r,firstContentfulPaint:i}}catch(e){return i.vF.warn("Erreur collecte timing, fallback estimation:",e),this.getFallbackTimingMetrics()}}async getNetworkMetrics(){try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return{latency:await this.measureNetworkLatency(),bandwidth:e?.downlink||0,connectionType:e?.effectiveType||"unknown"}}catch(e){return i.vF.warn("Erreur collecte r√©seau, fallback estimation:",e),this.getFallbackNetworkMetrics()}}async getCPUMetrics(){try{return{usage:await this.estimateCPUUsage(),cores:navigator.hardwareConcurrency||4}}catch(e){return i.vF.warn("Erreur collecte CPU, fallback estimation:",e),this.getFallbackCPUMetrics()}}async getSystemMetrics(){const e="system_metrics",t=this.metricsCache.get(e);if(t&&Date.now()-t.timestamp<3e4)return t.value;try{const[t,r,i]=await Promise.all([this.getMemoryMetrics(),this.getNetworkMetrics(),this.getCPUMetrics()]),n=this.measureFrameRate(),s={cpu:i.usage,memory:t.percentage,latency:r.latency,frameRate:await n,timestamp:Date.now()};return this.metricsCache.set(e,{value:s,timestamp:Date.now()}),s}catch(e){return i.vF.error("Erreur collecte m√©triques syst√®me:",e),this.getFallbackSystemMetrics()}}async getWebVitals(){try{const[e,t,r,i,n]=await Promise.all([this.measureLCP(),this.measureFID(),this.measureCLS(),this.measureFCP(),this.measureTTFB()]);return{lcp:e,fid:t,cls:r,fcp:i,ttfb:n}}catch(e){return i.vF.warn("Erreur Web Vitals, fallback defaults:",e),this.getFallbackWebVitals()}}async measureNetworkLatency(){try{const e=performance.now();return await fetch("/favicon.ico",{method:"HEAD"}),performance.now()-e}catch{return 50}}async estimateCPUUsage(){return new Promise((e=>{const t=performance.now();let r=0,i=0;const n=()=>{const s=Math.min(r+1e3,5e4);for(let e=r;e<s;e++)i+=Math.sqrt(e)*Math.sin(e);if(r=s,r<5e4)setTimeout(n,0);else{const r=performance.now()-t,i=Math.min(r/20,1);e(i)}};n()}))}async measureFrameRate(){return new Promise((e=>{let t=0;const r=performance.now(),i=()=>{t++,performance.now()-r<1e3?requestAnimationFrame(i):e(t)};requestAnimationFrame(i)}))}estimateMemoryUsage(){return 1e3*document.querySelectorAll("*").length}async measureLCP(){try{const e=performance.getEntriesByType("largest-contentful-paint");return e.length>0?e[e.length-1].startTime:0}catch{return 2500}}async measureFID(){try{const e=performance.getEntriesByType("first-input");return e.length>0?e[0].processingStart-e[0].startTime:0}catch{return 100}}async measureCLS(){try{let e=0;const t=new PerformanceObserver((t=>{for(const r of t.getEntries())r.hadRecentInput||(e+=r.value)}));return t.observe({type:"layout-shift",buffered:!0}),await new Promise((e=>setTimeout(e,100))),t.disconnect(),e}catch{return.1}}async measureFCP(){try{const e=performance.getEntriesByName("first-contentful-paint")[0];return e?e.startTime:0}catch{return 1500}}async measureTTFB(){try{const e=performance.getEntriesByType("navigation")[0];return e?e.responseStart-e.requestStart:0}catch{return 200}}getFallbackMemoryMetrics(){return{used:26214400,total:104857600,percentage:25}}getFallbackTimingMetrics(){return{loadTime:1500,domReady:800,firstPaint:1200,firstContentfulPaint:1400}}getFallbackNetworkMetrics(){return{latency:50,bandwidth:10,connectionType:"4g"}}getFallbackCPUMetrics(){return{usage:.15,cores:4}}getFallbackSystemMetrics(){return{cpu:.15,memory:25,latency:50,frameRate:60,timestamp:Date.now()}}getFallbackWebVitals(){return{lcp:2500,fid:100,cls:.1,fcp:1500,ttfb:200}}async getRandomReplacementValue(e="generic"){const t=await this.getSystemMetrics();switch(e){case"cpu":return t.cpu;case"memory":return t.memory/100;case"latency":return t.latency/1e3;default:return(t.cpu+t.memory/100+t.latency/1e3)/3}}refreshMetrics(){this.metricsCache.clear()}async getDevMetrics(){return this.isProduction?this.getSystemMetrics():(i.vF.warn("üöß MODE D√âVELOPPEMENT: Utilisation m√©triques simul√©es pour les tests"),this.getFallbackSystemMetrics())}async getCPUUsage(){return(await this.getSystemMetrics()).cpu}async getMemoryUsage(){return(await this.getSystemMetrics()).memory/100}}const u=l;class d{constructor(){this.overrides={},this.environment=this.detectEnvironment(),this.flags=this.initializeFlags(),this.loadOverrides()}static getInstance(){return d.instance||(d.instance=new d),d.instance}detectEnvironment(){return"production"}initializeFlags(){const e={USE_REAL_METRICS:!1,USE_REAL_DNA:!1,USE_REAL_BEHAVIOR:!1,USE_BACKEND_API:!1,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!1,ENABLE_MOCK_DATA:!0,ENABLE_SECURITY_AUDIT:!1,ENABLE_ADVANCED_ANALYTICS:!1,ENABLE_A_B_TESTING:!1};switch(this.environment){case"development":return{...e,ENABLE_DEBUG_LOGGING:!0,ENABLE_PERFORMANCE_PROFILING:!0,ENABLE_MOCK_DATA:!0,ENABLE_SECURITY_AUDIT:!0,USE_REAL_METRICS:this.getEnvBoolean("USE_REAL_METRICS",!1),USE_REAL_DNA:this.getEnvBoolean("USE_REAL_DNA",!1),USE_REAL_BEHAVIOR:this.getEnvBoolean("USE_REAL_BEHAVIOR",!1),USE_BACKEND_API:this.getEnvBoolean("USE_BACKEND_API",!1)};case"staging":return{...e,USE_REAL_METRICS:!0,USE_REAL_DNA:!0,USE_REAL_BEHAVIOR:!0,USE_BACKEND_API:!0,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!0,ENABLE_MOCK_DATA:!1,ENABLE_SECURITY_AUDIT:!0,ENABLE_ADVANCED_ANALYTICS:!0,ENABLE_A_B_TESTING:!0};case"production":return{...e,USE_REAL_METRICS:!0,USE_REAL_DNA:!0,USE_REAL_BEHAVIOR:!0,USE_BACKEND_API:!0,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!1,ENABLE_MOCK_DATA:!1,ENABLE_SECURITY_AUDIT:!1,ENABLE_ADVANCED_ANALYTICS:!0,ENABLE_A_B_TESTING:!1};default:return e}}loadOverrides(){Object.keys(this.flags).forEach((e=>{const t=process.env[`SYMBIONT_${e}`];void 0!==t&&(this.overrides[e]="true"===t)})),"development"===this.environment&&"undefined"!=typeof localStorage&&Object.keys(this.flags).forEach((e=>{const t=`symbiont_feature_${e.toLowerCase()}`,r=localStorage.getItem(t);null!==r&&(this.overrides[e]="true"===r)}))}isEnabled(e){return void 0!==this.overrides[e]?this.overrides[e]:this.flags[e]}setFlag(e,t){if("development"===this.environment){if(this.overrides[e]=t,"undefined"!=typeof localStorage){const r=`symbiont_feature_${e.toLowerCase()}`;localStorage.setItem(r,t.toString())}i.vF.info(`üîß Feature flag '${e}' d√©fini √† ${t}`)}else i.vF.warn(`‚ö†Ô∏è Override de feature flag '${e}' ignor√© en ${this.environment}`)}resetOverrides(){"development"===this.environment?(this.overrides={},"undefined"!=typeof localStorage&&Object.keys(this.flags).forEach((e=>{const t=`symbiont_feature_${e.toLowerCase()}`;localStorage.removeItem(t)})),i.vF.info("üîÑ Tous les feature flags remis aux valeurs par d√©faut")):i.vF.warn("‚ö†Ô∏è Reset des overrides ignor√© en production")}getEnvironment(){return this.environment}getAllFlags(){const e={};return Object.keys(this.flags).forEach((t=>{e[t]=this.isEnabled(t)})),{...e,environment:this.environment}}isDevelopment(){return"development"===this.environment}isStaging(){return"staging"===this.environment}isProduction(){return"production"===this.environment}runInEnvironment(e){const t=e[this.environment]||e.default;return t?.()}debugLog(e,...t){this.isEnabled("ENABLE_DEBUG_LOGGING")&&i.vF.info(`üêõ [SYMBIONT Debug] ${e}`,...t)}profileOperation(e,t){if(!this.isEnabled("ENABLE_PERFORMANCE_PROFILING"))return t();const r=performance.now(),n=t(),s=performance.now()-r;return i.vF.info(`‚è±Ô∏è [SYMBIONT Profile] ${e}: ${s.toFixed(2)}ms`),n}whenEnabled(e,t){return this.isEnabled(e)?t():void 0}getEnvBoolean(e,t){const r=process.env[e];return void 0===r?t:"true"===r.toLowerCase()}validateProductionSafety(){if(!this.isProduction())return;const e=["ENABLE_MOCK_DATA","ENABLE_DEBUG_LOGGING"].filter((e=>this.isEnabled(e)));if(e.length>0)throw new Error(`üö® S√âCURIT√â: Flags dangereux activ√©s en production: ${e.join(", ")}`)}}const m=d;var g=r(455),y=r(849);class p{constructor(e,t,i){this.health=100,this.lastMutation=Date.now();const n=this.validateInput(e,t);if(!n.isValid)throw new Error(`OrganismCore creation failed: ${n.errors.join(", ")}`);if(this.id=(0,g.wP)(),this.dna=e,this.logger=i?.logger,this.metricsService=u.getInstance(),this.featureFlags=m.getInstance(),this.traitService=new a(t),this.energyService=new c(100),i?.neuralMesh)this.neuralService=new h(i.neuralMesh);else{const{NeuralMesh:e}=r(194);this.neuralService=new h(new e)}this.setupServiceListeners(),this.logger?.debug("OrganismCore initialized",{id:this.id,dna:this.dna})}setupServiceListeners(){this.traitService.addTraitChangeListener((e=>{this.onTraitChanged(e)})),this.energyService.addEnergyListener((e=>{"consumption"===e.type&&e.energyAfter<10&&this.logger?.debug("Low energy warning",{energy:e.energyAfter})}))}onTraitChanged(e){const t=this.traitService.getAllTraits(),r=(t.resilience+t.adaptability)/2;this.energyService.setEfficiency(r),this.logger?.debug("Trait changed, metabolism adjusted",{trait:e.traitName,newValue:e.newValue,efficiency:r})}validateInput(e,t){const r=[];return e&&"string"==typeof e||r.push("DNA must be a non-empty string"),e&&e.length<10&&r.push("DNA must be at least 10 characters long"),t&&Object.entries(t).forEach((([e,t])=>{("number"!=typeof t||t<0||t>1)&&r.push(`Trait ${e} must be a number between 0 and 1`)})),{isValid:0===r.length,errors:r}}getId(){return this.id}getDNA(){return this.dna}getTraits(){return this.traitService.getAllTraits()}updateTrait(e,t){if(!this.energyService.consumeEnergy(1,`trait_update_${e}`))throw new Error("Insufficient energy to update trait");this.traitService.updateTrait(e,t,"manual_update"),this.logger?.debug("Trait updated",{trait:e,value:t})}getEnergyLevel(){return this.energyService.getEnergyLevel()}getHealth(){return this.health}async evolve(e){if(this.energyService.consumeEnergy(5,"evolution"))try{const t=this.traitService.getAllTraits(),r=await this.neuralService.processStimulus(e,t);r.success&&Object.keys(r.adaptations).length>0&&(this.traitService.updateTraits(r.adaptations,"evolution"),this.lastMutation=Date.now(),this.logger?.debug("Evolution successful",{adaptations:r.adaptations,confidence:r.confidence}))}catch(e){this.logger?.error("Evolution failed",e),s.logSimpleError("OrganismCore","evolve",e,"error")}else this.logger?.debug("Evolution skipped: insufficient energy")}async learn(e){if(!this.energyService.consumeEnergy(2,"learning"))return;const t=await this.neuralService.learn(e);if(t){const e=this.traitService.getTrait("memory");this.traitService.updateTrait("memory",e+.01,"learning")}this.logger?.debug("Learning completed",{success:t,data:e})}processStimulus(e){this.energyService.consumeEnergy(1,"stimulus_processing")&&(this.neuralService.queuePattern({id:`pattern_${Date.now()}`,type:"behavioral",data:e,timestamp:Date.now(),confidence:.8}),this.logger?.debug("Stimulus processed",{stimulus:e}))}getState(){const e=this.traitService.getAllTraits(),t=this.energyService.getEnergyStats();return{id:this.id,traits:e,energy:t.current,maxEnergy:t.max,health:this.health,dna:this.dna,lastMutation:this.lastMutation,balance:this.traitService.calculateBalance(),metabolismRate:t.metabolismRate,age:Date.now()-parseInt(this.id.split("_")[1])}}generateShaderParameters(){const e=this.traitService.getAllTraits();return{energy:this.energyService.getEnergyPercentage()/100,health:this.health/100,neuralActivity:this.neuralService.getNeuralActivity(),creativity:e.creativity,focus:e.focus,time:Date.now()/1e3,colorPrimary:[e.creativity,e.empathy,e.intuition],colorSecondary:[e.focus,e.resilience,e.adaptability],morphology:e.adaptability,complexity:e.creativity*e.memory}}toJSON(){return{mesh:this.neuralService.saveState()||{},dna:this.dna,health:this.health,lastMutation:this.lastMutation,traits:this.traitService.toJSON()||{traits:this.traitService.getAllTraits(),history:[]},energy:this.energyService.toJSON()||{energy:100,maxEnergy:100,metabolismRate:1,config:{efficiency:1,baseConsumption:.1},history:[]},neural:this.neuralService.saveState(),timestamp:Date.now()}}fromJSON(e){e.traits&&"object"==typeof e.traits&&this.traitService.fromJSON(e.traits),e.energy&&"object"==typeof e.energy&&this.energyService.fromJSON(e.energy),e.neural&&this.neuralService.loadState(e.neural),this.health=e.health||100,this.lastMutation=e.lastMutation||Date.now(),this.logger?.debug("State restored from JSON",{id:this.id})}cleanup(){this.energyService.destroy(),this.traitService.cleanup(),this.neuralService.cleanup(),this.logger?.debug("OrganismCore cleaned up",{id:this.id})}healthCheck(){const e=[];this.health<20&&e.push("Low health"),this.energyService.getEnergyLevel()<10&&e.push("Low energy");const t=this.neuralService.healthCheck();return t.healthy||e.push(...t.issues),{healthy:0===e.length,issues:e}}async boot(){try{await this.neuralService.initialize(),this.logger?.debug("Organism booted successfully",{id:this.id})}catch(e){throw this.logger?.error("Failed to boot organism",{id:this.id,_error:e}),e}}async hibernate(){try{this.energyService.setEfficiency(.1),await this.neuralService.suspend(),this.logger?.debug("Organism hibernated",{id:this.id})}catch(e){throw this.logger?.error("Failed to hibernate organism",{id:this.id,_error:e}),e}}update(e=16.67){const t=e/16.67;this.energyService.consumeEnergy(.1*t,"metabolism"),this.neuralService.update(e),this.energyService.getEnergyLevel()>80&&(this.health=Math.min(100,this.health+.1*t))}stimulate(e,t){this.neuralService.stimulate(e,t),this.energyService.consumeEnergy(.5,`stimulation_${e}`)}mutate(e=.01){const t=this.traitService.getAllTraits(),r={};Object.keys(t).forEach((i=>{if(y.tm.random()<e){const e=t[i],n=.1*(y.tm.random()-.5),s=Math.max(0,Math.min(1,e+n));r[i]=s}})),Object.keys(r).length>0&&(this.traitService.updateTraits(r,"mutation"),this.lastMutation=Date.now(),this.logger?.debug("Mutation applied",{id:this.id,mutations:r}))}feed(e=10){this.energyService.addEnergy(e),this.logger?.debug("Organism fed",{id:this.id,amount:e})}setTraits(e){this.traitService.updateTraits(e,"external_update")}async getPerformanceMetrics(){const e=this.neuralService.getPerformanceMetrics();return{cpu:await this.metricsService.getCPUUsage(),memory:await this.metricsService.getMemoryUsage(),neuralActivity:e?.neuralActivity||0,connectionStrength:e?.connectionStrength||0}}getShaderParameters(){const e=this.getTraits();return{energy:this.energyService.getEnergyLevel()/100,health:this.health/100,neuralActivity:this.neuralService.getNeuralActivity()||0,creativity:e.creativity,focus:e.focus,time:Date.now()/1e3}}}},513:(e,t,r)=>{var i;r.d(t,{vF:()=>s}),function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.FATAL=5]="FATAL"}(i||(i={}));class n{constructor(e={}){this.logEntries=[],this.config={level:i.INFO,enableConsole:!this.isProduction(),enableStorage:!0,maxStorageEntries:1e3,sensitiveFields:["password","token","key","secret","auth"],productionMode:this.isProduction(),...e}}static getInstance(e){return n.instance||(n.instance=new n(e)),n.instance}isProduction(){return!0}sanitizeData(e){if("string"==typeof e)return this.sanitizeString(e);if("object"==typeof e&&null!==e){if(Array.isArray(e))return e.map((e=>this.sanitizeData(e)));const t={};for(const[r,i]of Object.entries(e))this.isSensitiveField(r)?t[r]="[REDACTED]":t[r]=this.sanitizeData(i);return t}return e}sanitizeString(e){let t=e;for(const e of n.SENSITIVE_PATTERNS)t=t.replace(e,"[REDACTED]");return t}isSensitiveField(e){return this.config.sensitiveFields.some((t=>e.toLowerCase().includes(t.toLowerCase())))}formatMessage(e,t,r,n){return`[${(new Date).toISOString()}] ${i[e]}${n?` [${n}]`:""}: ${t}${r?` ${JSON.stringify(r,null,2)}`:""}`}shouldLog(e){return e>=this.config.level}log(e,t,r,n){if(!this.shouldLog(e))return;const s=r?this.sanitizeData(r):void 0,a=this.sanitizeString(t),o={timestamp:Date.now(),level:e,message:a,data:s,context:n,sanitized:!0};if(this.config.enableStorage&&(this.logEntries.push(o),this.logEntries.length>this.config.maxStorageEntries&&(this.logEntries=this.logEntries.slice(-this.config.maxStorageEntries))),this.config.enableConsole){const t=this.formatMessage(e,a,s,n);switch(e){case i.TRACE:case i.DEBUG:console.debug(t);break;case i.INFO:console.info(t);break;case i.WARN:console.warn(t);break;case i.ERROR:case i.FATAL:console.error(t)}}}trace(e,t,r){this.log(i.TRACE,e,t,r)}debug(e,t,r){this.log(i.DEBUG,e,t,r)}info(e,t,r){this.log(i.INFO,e,t,r)}warn(e,t,r){this.log(i.WARN,e,t,r)}error(e,t,r){this.log(i.ERROR,e,t,r)}fatal(e,t,r){this.log(i.FATAL,e,t,r)}setLevel(e){this.config.level=e}enableConsole(e){this.config.enableConsole=e}getLogs(e){return void 0!==e?this.logEntries.filter((t=>t.level>=e)):[...this.logEntries]}clearLogs(){this.logEntries=[]}exportLogs(){return JSON.stringify(this.logEntries,null,2)}}n.SENSITIVE_PATTERNS=[/password/i,/token/i,/key/i,/secret/i,/auth/i,/credential/i,/session/i,/cookie/i,/jwt/i,/bearer/i,/api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/private[_-]?key/i,/\b[A-Za-z0-9+/]{32,}={0,2}\b/,/\b[0-9a-f]{32,}\b/i,/\b[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}\b/,/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/];const s=n.getInstance();s.info.bind(s),s.warn.bind(s),s.error.bind(s),s.debug.bind(s)},849:(e,t,r)=>{r.d(t,{tm:()=>h});var i,n,s=r(513);!function(e){e.CRYPTOGRAPHIC="cryptographic",e.MODERATE="moderate",e.PERFORMANCE="performance"}(i||(i={})),function(e){e.NEURAL_NETWORK="neural_network",e.WEBGL_RENDERING="webgl_rendering",e.GENETIC_MUTATIONS="genetic_mutations",e.SOCIAL_EVENTS="social_events",e.CRYPTOGRAPHIC_OPS="cryptographic_ops",e.MONITORING="monitoring"}(n||(n={}));class a{constructor(e=123456789,t=987654321){this.state0=e,this.state1=t}random(){let e=this.state0;const t=this.state1;return this.state0=t,e^=e<<23,e^=e>>>17,e^=t,e^=t>>>26,this.state1=e,(t+e>>>0)/4294967296}reseed(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(2);crypto.getRandomValues(e),this.state0=e[0],this.state1=e[1]}}}class o{constructor(e=1e4,t=2e3){this.pool=[],this.isRefilling=!1,this.totalGenerated=0,this.totalConsumed=0,this.poolSize=e,this.refillThreshold=t}async initialize(){await this.fillPool()}async fillPool(){if(!this.isRefilling){this.isRefilling=!0;try{const e=Math.min(5e3,this.poolSize-this.pool.length),t=new Uint32Array(e);if("undefined"!=typeof crypto&&crypto.getRandomValues){crypto.getRandomValues(t);for(const e of t)this.pool.push(e/4294967296);this.totalGenerated+=e}}catch(e){s.vF.error("RandomPool: Erreur g√©n√©ration batch",{error:e})}finally{this.isRefilling=!1}}}getNext(){if(0===this.pool.length)return null;const e=this.pool.pop();return this.totalConsumed++,this.pool.length<=this.refillThreshold&&!this.isRefilling&&this.fillPool(),e}getStats(){return{poolSize:this.pool.length,totalGenerated:this.totalGenerated,totalConsumed:this.totalConsumed,hitRate:this.totalConsumed>0?(this.totalConsumed-this.pool.length)/this.totalConsumed:0,isRefilling:this.isRefilling}}}class c{constructor(){this.configs=new Map([[n.CRYPTOGRAPHIC_OPS,{securityLevel:i.CRYPTOGRAPHIC,poolSize:1e3,refillThreshold:200,batchGeneration:!0,metricsEnabled:!0}],[n.NEURAL_NETWORK,{securityLevel:i.PERFORMANCE,poolSize:5e4,refillThreshold:1e4,batchGeneration:!0,metricsEnabled:!0}],[n.WEBGL_RENDERING,{securityLevel:i.PERFORMANCE,poolSize:1e4,refillThreshold:2e3,batchGeneration:!0,metricsEnabled:!1}],[n.GENETIC_MUTATIONS,{securityLevel:i.MODERATE,poolSize:5e3,refillThreshold:1e3,batchGeneration:!0,metricsEnabled:!0}]]),this.metrics={totalCalls:0,secureCalls:0,poolCalls:0,fastCalls:0,avgLatencyMs:0,lastReseedTime:Date.now()},this.securePool=new o(1e4,2e3),this.fastPRNG=new a,this.initialize()}static getInstance(){return c.instance||(c.instance=new c),c.instance}async initialize(){await this.securePool.initialize(),setInterval((()=>{this.fastPRNG.reseed(),this.metrics.lastReseedTime=Date.now()}),3e5)}random(e=n.GENETIC_MUTATIONS){const t=performance.now();this.metrics.totalCalls++;const r=this.configs.get(e)||this.configs.get(n.GENETIC_MUTATIONS);let s;switch(r.securityLevel){case i.CRYPTOGRAPHIC:s=this.getSecureRandom(),this.metrics.secureCalls++;break;case i.MODERATE:s=this.getPooledRandom(),this.metrics.poolCalls++;break;case i.PERFORMANCE:s=this.getFastRandom(),this.metrics.fastCalls++;break;default:s=this.getPooledRandom(),this.metrics.poolCalls++}if(r.metricsEnabled){const e=performance.now()-t;this.metrics.avgLatencyMs=(this.metrics.avgLatencyMs+e)/2}return s}getSecureRandom(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available for secure random generation");throw s.vF.error("HybridRandom: CRITICAL FAILURE in getSecureRandom",e),e}getPooledRandom(){const e=this.securePool.getNext();if(null!==e)return e;if(s.vF.warn("HybridRandom: Pool empty, attempting direct crypto generation"),"undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}const t=new Error("SECURITY CRITICAL: Pool empty and crypto.getRandomValues unavailable");throw s.vF.error("HybridRandom: CRITICAL FAILURE - no secure random source available",t),t}getFastRandom(){return this.fastPRNG.random()}neuralRandom(){return this.random(n.NEURAL_NETWORK)}renderingRandom(){return this.random(n.WEBGL_RENDERING)}cryptoRandom(){return this.random(n.CRYPTOGRAPHIC_OPS)}mutationRandom(){return this.random(n.GENETIC_MUTATIONS)}async generateBatch(e,t){const r=this.configs.get(t);if(!r?.batchGeneration)return Array.from({length:e},(()=>this.random(t)));if(r.securityLevel===i.PERFORMANCE)return Array.from({length:e},(()=>this.fastPRNG.random()));{const t=new Uint32Array(e);return"undefined"!=typeof crypto&&crypto.getRandomValues?(crypto.getRandomValues(t),Array.from(t,(e=>e/4294967296))):Array.from({length:e},(()=>this.getSecureRandom()))}}getPerformanceMetrics(){return{...this.metrics,poolStats:this.securePool.getStats(),distribution:{secure:(this.metrics.secureCalls/this.metrics.totalCalls*100).toFixed(1)+"%",pooled:(this.metrics.poolCalls/this.metrics.totalCalls*100).toFixed(1)+"%",fast:(this.metrics.fastCalls/this.metrics.totalCalls*100).toFixed(1)+"%"}}}configureContext(e,t){const r=this.configs.get(e)||this.configs.get(n.GENETIC_MUTATIONS);this.configs.set(e,{...r,...t})}shutdown(){s.vF.info("HybridRandomProvider: Arr√™t avec m√©triques",this.getPerformanceMetrics())}}c.getInstance();class h{static random(){const e=this.detectUsageContext();return this.provider.random(e)}static detectUsageContext(){try{const e=(new Error).stack;return e?e.includes("NeuralMesh")||e.includes("NeuralCore")||e.includes("neural")||e.includes("evolve")||e.includes("mutate")?n.NEURAL_NETWORK:e.includes("WebGL")||e.includes("render")||e.includes("draw")||e.includes("Batcher")?n.WEBGL_RENDERING:e.includes("uuid")||e.includes("UUID")||e.includes("token")||e.includes("encrypt")||e.includes("crypto")?n.CRYPTOGRAPHIC_OPS:e.includes("Social")||e.includes("Mystical")||e.includes("Collective")?n.SOCIAL_EVENTS:e.includes("Monitor")||e.includes("Health")||e.includes("metrics")?n.MONITORING:n.GENETIC_MUTATIONS:n.GENETIC_MUTATIONS}catch{return n.GENETIC_MUTATIONS}}static randomInt(e,t){if(e>=t)throw new Error("PerformanceOptimizedRandom: min doit √™tre inf√©rieur √† max");const r=t-e,i=this.detectUsageContext();return Math.floor(this.provider.random(i)*r)+e}static randomFloat(e,t){if(e>=t)throw new Error("PerformanceOptimizedRandom: min doit √™tre inf√©rieur √† max");const r=this.detectUsageContext();return this.provider.random(r)*(t-e)+e}static async randomBatch(e,t){const r=t||this.detectUsageContext();return this.provider.generateBatch(e,r)}static randomBytes(e){const t=this.detectUsageContext();if(t!==n.CRYPTOGRAPHIC_OPS){const r=new Uint8Array(e);for(let i=0;i<e;i++)r[i]=Math.floor(256*this.provider.random(t));return r}if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}s.vF.warn("PerformanceOptimizedRandom: crypto.getRandomValues non disponible");const r=new Uint8Array(e);for(let t=0;t<e;t++)r[t]=Math.floor(256*this.provider.cryptoRandom());return r}static choice(e){if(0===e.length)throw new Error("PerformanceOptimizedRandom: Le tableau ne peut pas √™tre vide");return e[this.randomInt(0,e.length)]}static uuid(){return this.generateSecureUUID()}static generateSecureUUID(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20,32)].join("-")}return s.vF.warn("PerformanceOptimizedRandom: crypto.getRandomValues non disponible, fallback provider"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*this.provider.cryptoRandom()|0;return("x"===e?t:3&t|8).toString(16)}))}static randomString(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r="";for(let i=0;i<e;i++)r+=t.charAt(this.randomInt(0,t.length));return r}static randomId(e="",t=8){const r=this.randomString(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return e?`${e}_${r}`:r}static neuralRandom(){return this.provider.neuralRandom()}static renderingRandom(){return this.provider.renderingRandom()}static mutationRandom(){return this.provider.mutationRandom()}static cryptoRandom(){return this.provider.cryptoRandom()}static async neuralBatch(e){return this.provider.generateBatch(e,n.NEURAL_NETWORK)}static async renderingBatch(e){return this.provider.generateBatch(e,n.WEBGL_RENDERING)}static getPerformanceMetrics(){return this.provider.getPerformanceMetrics()}static configurePerformance(e,t){this.provider.configureContext(e,{securityLevel:t})}static async warmup(){s.vF.info("PerformanceOptimizedRandom: Initialisation pools performance..."),await Promise.all([this.provider.generateBatch(1e3,n.NEURAL_NETWORK),this.provider.generateBatch(500,n.WEBGL_RENDERING),this.provider.generateBatch(300,n.GENETIC_MUTATIONS)]),s.vF.info("PerformanceOptimizedRandom: Warmup termin√©, performance optimale pr√™te")}static async benchmarkVsSecureRandom(e=1e4){const t=performance.now();for(let t=0;t<e;t++){const e=new Uint32Array(1);"undefined"!=typeof crypto&&crypto.getRandomValues&&(crypto.getRandomValues(e),e[0],this.MAX_UINT32)}const r=performance.now()-t,i=performance.now();for(let t=0;t<e;t++)this.neuralRandom();const n=performance.now()-i,s=r/n;return{secureRandomMs:Math.round(100*r)/100,optimizedMs:Math.round(100*n)/100,speedupRatio:Math.round(10*s)/10,recommendation:s>100?`üöÄ Gain massif ${s.toFixed(0)}x - Migration recommand√©e`:s>10?`‚ö° Gain significatif ${s.toFixed(0)}x - Migration b√©n√©fique`:`‚úÖ Gain mod√©r√© ${s.toFixed(1)}x - Migration optionnelle`}}}h.provider=c.getInstance(),h.MAX_UINT32=4294967295,h.random,h.randomInt,h.randomFloat,h.neuralRandom,h.renderingRandom,h.mutationRandom,h.cryptoRandom}},r={};function i(e){var n=r[e];if(void 0!==n)return n.exports;var s=r[e]={exports:{}};return t[e](s,s.exports,i),s.exports}i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},function(e){e.PAGE_VISIT="PAGE_VISIT",e.SCROLL_EVENT="SCROLL_EVENT",e.ORGANISM_UPDATE="ORGANISM_UPDATE",e.ORGANISM_MUTATE="ORGANISM_MUTATE",e.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",e.WEBGL_INIT="WEBGL_INIT",e.WEBGL_ERROR="WEBGL_ERROR",e.WEBGL_INITIALIZED="WEBGL_INITIALIZED",e.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",e.GENERATE_INVITATION="GENERATE_INVITATION",e.INVITATION_GENERATED="INVITATION_GENERATED",e.CONSUME_INVITATION="CONSUME_INVITATION",e.INVITATION_CONSUMED="INVITATION_CONSUMED",e.CHECK_INVITATION="CHECK_INVITATION",e.INVITATION_CHECKED="INVITATION_CHECKED",e.MURMUR="MURMUR",e.GET_INVITER="GET_INVITER",e.INVITER_RESULT="INVITER_RESULT",e.GET_INVITEES="GET_INVITEES",e.INVITEES_RESULT="INVITEES_RESULT",e.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",e.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",e.INTERACTION_DETECTED="INTERACTION_DETECTED",e.GET_HEALTH_METRICS="GET_HEALTH_METRICS",e.HEALTH_METRICS_RESPONSE="HEALTH_METRICS_RESPONSE",e.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",e.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",e.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",e.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",e.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",e.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",e.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",e.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",e.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED",e.GET_ORGANISM="GET_ORGANISM"}(e||(e={}));var n=i(455),s=i(513);function a(e){return e&&"object"==typeof e?o(e):e}function o(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof HTMLCanvasElement||e instanceof CanvasRenderingContext2D||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner||e&&"object"==typeof e&&e.constructor&&e.constructor.name&&e.constructor.name.includes("Fiber"))return e instanceof HTMLCanvasElement?{tagName:"CANVAS",width:e.width,height:e.height,className:e.className,id:e.id}:"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>o(e,t)));const r={};for(const i in e)if(e.hasOwnProperty(i))try{r[i]=o(e[i],t)}catch(e){r[i]="[Non-serializable]"}return r}function c(e){return"object"==typeof e&&null!==e&&"code"in e&&"string"==typeof e.code&&"status"in e&&"string"==typeof e.status}function h(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return s.vF.warn("Message serialization issue, cleaning object:",t),l(e)}}function l(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof HTMLCanvasElement||e instanceof CanvasRenderingContext2D||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner||e&&"object"==typeof e&&e.constructor&&e.constructor.name&&e.constructor.name.includes("Fiber"))return"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>l(e,t)));const r={};for(const i in e)if(e.hasOwnProperty(i))try{r[i]=l(e[i],t)}catch(e){r[i]="[Non-serializable]"}return r}class u{constructor(e){this.source=e,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){"undefined"!=typeof chrome&&chrome.runtime?chrome.runtime.onMessage.addListener(((e,t,r)=>(this.shouldProcessMessage(e)&&(this.enqueueMessage(e),r({received:!0})),!1))):s.vF.warn("[MessageBus] Chrome runtime non disponible - mode test/d√©veloppement")}shouldProcessMessage(e){return this.filters.every((t=>t(e)))}async enqueueMessage(e){if(this.messageQueue.push(e),!this.processing){this.processing=!0;try{await this.processQueue()}finally{this.processing=!1}}}async processQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();await this.processMessage(e)}}async processMessage(t){if(!function(t,r){switch(t){case e.ORGANISM_UPDATE:return"object"==typeof(i=r)&&null!==i&&"id"in i&&"string"==typeof i.id&&"generation"in i&&"number"==typeof i.generation&&"health"in i&&"number"==typeof i.health&&"energy"in i&&"number"==typeof i.energy&&"traits"in i&&"object"==typeof i.traits;case e.ORGANISM_MUTATE:return function(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"trigger"in e&&"string"==typeof e.trigger}(r);case e.PAGE_VISIT:case e.SCROLL_EVENT:return function(e){return e&&"string"==typeof e.url&&"number"==typeof e.visitCount}(r);case e.MURMUR:return function(e){return"object"==typeof e&&null!==e&&"text"in e&&"string"==typeof e.text&&"timestamp"in e&&"number"==typeof e.timestamp}(r);case e.GENERATE_INVITATION:case e.CONSUME_INVITATION:case e.CHECK_INVITATION:return function(e){return"object"==typeof e&&null!==e&&"code"in e&&"string"==typeof e.code}(r);case e.INVITATION_GENERATED:return"string"==typeof r||c(r);case e.INVITATION_CONSUMED:case e.INVITATION_CHECKED:return c(r);case e.SHARED_MUTATION_RESULT:return"string"==typeof r||r&&"object"==typeof r;default:return!0}var i}(t.type,t.payload))return void s.vF.warn(`[MessageBus] Payload non valide pour le type ${t.type}`,t.payload);for(const e of this.globalHandlers)try{await e(t)}catch(e){s.vF.error("Error in global handler:",e)}const r=this.handlers.get(t.type);if(r)for(const e of r)try{await e(t)}catch(e){s.vF.error(`Error in handler for ${t.type}:`,e)}}on(e,t){this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t)}off(e,t){const r=this.handlers.get(e);r&&r.delete(t)}onAny(e){this.globalHandlers.add(e)}offAny(e){this.globalHandlers.delete(e)}addFilter(e){this.filters.push(e)}async send(e){const t={...e,source:this.source,timestamp:Date.now(),id:(0,n.lk)()};if("undefined"!=typeof chrome&&chrome.runtime)try{const e=h(a(t));if("content"===this.source)await chrome.runtime.sendMessage(e);else{const t=await chrome.tabs.query({}),r=e=>e.active||e.url&&e.url.includes("symbiont"),i=t.filter(r);for(const t of i)t.id&&chrome.tabs.sendMessage(t.id,e).catch((()=>{}));chrome.runtime.sendMessage(e).catch((()=>{}))}}catch(e){s.vF.error("Error sending message:",e)}else s.vF.warn("[MessageBus] Chrome runtime non disponible - message non envoy√©:",t.type)}sendToBackground(e){this.send(e)}emit(e,t){const r=this.handlers.get(e);r&&r.forEach((r=>r({type:e,payload:t})))}handleMessage(e,t){s.vF.info("Handling message:",e)}onMessage(e,t,r){return s.vF.info("Received message:",e),!0}sendToFrame(e,t,r){s.vF.info("Sending to frame:",t,r)}}var d=i(18);class m{static getInstance(e){return this.instances.get(e)||null}static registerInstance(e,t){const r=this.instances.get(e);r&&r.db&&(s.vF.warn(`[StorageInstanceManager] Closing existing ${e} instance before registering new one`),r.close()),this.instances.set(e,t)}static removeInstance(e){this.instances.delete(e)}static closeAll(){s.vF.info("[StorageInstanceManager] Closing all storage instances"),this.instances.forEach(((e,t)=>{s.vF.info(`[StorageInstanceManager] Closing ${t} instance`),e.close()})),this.instances.clear()}}m.instances=new Map;class g{constructor(){this.db=null,this.DB_NAME="symbiont-db",this.DB_VERSION=3,this.MAX_STORAGE_SIZE_MB=50,this.quotaWarningIssued=!1,this.broadcastChannel=null,this.isClosing=!1,this.initializationPromise=null,this.heartbeatInterval=null,this.isPlaywrightContext=this.detectPlaywrightContext(),this.OPERATION_TIMEOUT=3e4,this.contextType=this.getContextType(),this.contextId=`${this.contextType}-${Date.now()}-${d.Dm.random().toString(36).substr(2,9)}`,s.vF.info("[SymbiontStorage] Created instance",{contextId:this.contextId,contextType:this.contextType,isPlaywright:this.isPlaywrightContext,timeout:this.OPERATION_TIMEOUT}),m.registerInstance(this.contextType,this),this.setupBroadcastChannel(),this.startHeartbeat()}startHeartbeat(){this.heartbeatInterval=setInterval((()=>{this.broadcastChannel&&this.db&&this.broadcastChannel.postMessage({type:"HEARTBEAT",senderId:this.contextId,contextType:this.contextType,timestamp:Date.now()})}),5e3)}detectPlaywrightContext(){try{const e="undefined"!=typeof navigator?navigator:null,t=e?.userAgent||"",r=t.includes("Playwright")||t.includes("SYMBIONT-TEST")||t.includes("HeadlessChrome");return s.vF.info("[SymbiontStorage] Playwright detection",{isPlaywright:r,userAgent:t.substring(0,120)}),r&&s.vF.info("[SymbiontStorage] Playwright/Test environment detected - using extended timeouts"),r}catch(e){return s.vF.warn("[SymbiontStorage] Error detecting Playwright context",e),!1}}getContextType(){return"undefined"==typeof window?"service-worker":window.location.href.includes("popup.html")?"popup":window===window.top?"content-script-top":"content-script-frame"}setupBroadcastChannel(){try{this.broadcastChannel=new BroadcastChannel("symbiont-storage-coordination");const e=new Map;this.broadcastChannel.onmessage=t=>{const{type:r,requestId:i,senderId:n,contextType:a}=t.data;if(n!==this.contextId)switch(s.vF.debug(`[SymbiontStorage:${this.contextId}] Received message`,{type:r,from:n}),r){case"HEARTBEAT":e.set(n,{timestamp:Date.now(),contextType:a});const t=Date.now();for(const[r,i]of e.entries())t-i.timestamp>15e3&&(s.vF.warn(`[SymbiontStorage:${this.contextId}] Context ${r} (${i.contextType}) appears dead (no heartbeat for >15s)`),e.delete(r));break;case"REQUEST_CLOSE":s.vF.info(`[SymbiontStorage:${this.contextId}] Received close request from ${n}`),this.db&&!this.isClosing?(s.vF.info(`[SymbiontStorage:${this.contextId}] Closing database connection as requested`),this.close(),this.broadcastChannel?.postMessage({type:"CLOSE_ACK",requestId:i,senderId:this.contextId,contextType:this.contextType})):s.vF.debug(`[SymbiontStorage:${this.contextId}] No active connection to close`);break;case"FORCE_SHUTDOWN":if(s.vF.warn(`[SymbiontStorage:${this.contextId}] Received FORCE_SHUTDOWN - closing immediately`),this.db)try{this.db.close(),this.db=null}catch(e){s.vF.error(`[SymbiontStorage:${this.contextId}] Error during force shutdown`,e)}if(this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null),this.broadcastChannel)try{this.broadcastChannel.close(),this.broadcastChannel=null}catch(e){s.vF.error(`[SymbiontStorage:${this.contextId}] Error closing broadcast channel`,e)}break;case"CLOSE_ACK":s.vF.debug(`[SymbiontStorage:${this.contextId}] Context ${n} closed their connection`);break;case"PING":this.broadcastChannel?.postMessage({type:"PONG",requestId:i,senderId:this.contextId,contextType:this.contextType,hasConnection:!!this.db})}}}catch(e){s.vF.warn("[SymbiontStorage] BroadcastChannel not available",e)}}async requestOtherContextsToClose(){if(!this.broadcastChannel)return void console.log("[SymbiontStorage] No BroadcastChannel, skipping close request");const e=Date.now().toString();return console.log(`[SymbiontStorage:${this.contextId}] Broadcasting close request to all contexts`),new Promise((t=>{const r=new Set;let i;const n=()=>{this.broadcastChannel&&(this.broadcastChannel.onmessage=null),clearTimeout(i)},s=this.broadcastChannel?.onmessage;this.broadcastChannel&&(this.broadcastChannel.onmessage=t=>{const{type:i,requestId:n,senderId:a}=t.data;a!==this.contextId&&(s&&this.broadcastChannel&&s.call(this.broadcastChannel,t),"CLOSE_ACK"===i&&n===e&&(r.add(a),console.log(`[SymbiontStorage:${this.contextId}] Received acknowledgment from ${a} (${r.size} total)`)))}),i=setTimeout((()=>{console.log(`[SymbiontStorage:${this.contextId}] Close request timeout, received ${r.size} acknowledgments`),n(),t()}),2e3),this.broadcastChannel?.postMessage({type:"REQUEST_CLOSE",requestId:e,senderId:this.contextId}),setTimeout((()=>{0===r.size&&(console.log(`[SymbiontStorage:${this.contextId}] No acknowledgments after 500ms, assuming no other contexts`),n(),t())}),500)}))}async pingOtherContexts(){if(!this.broadcastChannel)return[];const e=Date.now().toString();return s.vF.debug(`[SymbiontStorage:${this.contextId}] Pinging other contexts...`),new Promise((t=>{const r=[];let i;const n=()=>{this.broadcastChannel&&(this.broadcastChannel.onmessage=null),clearTimeout(i)},a=this.broadcastChannel?.onmessage;this.broadcastChannel&&(this.broadcastChannel.onmessage=t=>{const{type:i,requestId:n,senderId:o,hasConnection:c,contextType:h}=t.data;o!==this.contextId&&(a&&this.broadcastChannel&&a.call(this.broadcastChannel,t),"PONG"===i&&n===e&&(r.push({contextId:o,hasConnection:c,contextType:h}),s.vF.debug(`[SymbiontStorage:${this.contextId}] Got pong from ${o} (${h}), hasConnection: ${c}`)))}),i=setTimeout((()=>{s.vF.debug(`[SymbiontStorage:${this.contextId}] Ping timeout, got ${r.length} responses`),n(),t(r)}),1e3),this.broadcastChannel?.postMessage({type:"PING",requestId:e,senderId:this.contextId,contextType:this.contextType})}))}withTimeout(e,t=this.OPERATION_TIMEOUT){return Promise.race([e,new Promise(((e,r)=>setTimeout((()=>r(new Error(`Operation timed out after ${t}ms`))),t)))])}async initialize(){if(this.initializationPromise)return s.vF.info(`[SymbiontStorage:${this.contextId}] Initialization already in progress, waiting...`),this.initializationPromise;if(this.db)s.vF.debug(`[SymbiontStorage:${this.contextId}] Already initialized`);else{if("undefined"==typeof indexedDB)throw new Error("IndexedDB is not available in this environment");this.initializationPromise=this.performInitialization();try{await this.initializationPromise}finally{this.initializationPromise=null}}}async performInitialization(){s.vF.info(`[SymbiontStorage:${this.contextId}] Starting initialization`,{dbName:this.DB_NAME,dbVersion:this.DB_VERSION,contextType:this.contextType});const e=this.db;if(e){s.vF.info(`[SymbiontStorage:${this.contextId}] Closing existing database connection`);try{e.close()}catch(e){s.vF.warn(`[SymbiontStorage:${this.contextId}] Error closing existing connection`,e)}this.db=null}try{const e=this.checkStorageQuota();await Promise.race([e,new Promise(((e,t)=>setTimeout((()=>t(new Error("Storage quota check timeout"))),3e3)))])}catch(e){s.vF.warn(`[SymbiontStorage:${this.contextId}] Failed to check storage quota (continuing anyway)`,e)}const t=await this.pingOtherContexts();if(t.length>0){s.vF.info(`[SymbiontStorage:${this.contextId}] Found ${t.length} other active contexts`,t);const e=t.filter((e=>e.hasConnection));e.length>0&&s.vF.info(`[SymbiontStorage:${this.contextId}] ${e.length} context(s) have active database connections`,{contexts:e.map((e=>e.contextId))})}s.vF.info(`[SymbiontStorage:${this.contextId}] Requesting other contexts to close connections...`),await this.requestOtherContextsToClose(),s.vF.debug(`[SymbiontStorage:${this.contextId}] Waiting 500ms for connections to fully close...`),await new Promise((e=>setTimeout(e,500)));let r=null;for(let e=1;e<=3;e++)try{return s.vF.info(`[SymbiontStorage:${this.contextId}] Initialization attempt ${e}/3`),await this.attemptInitialize(3===e),void s.vF.info(`[SymbiontStorage:${this.contextId}] Initialization completed successfully`)}catch(t){if(r=t instanceof Error?t:new Error(String(t)),s.vF.error(`[SymbiontStorage:${this.contextId}] Initialization attempt ${e} failed`,r),!(e<3&&(r.message.includes("blocked")||r.message.includes("timeout"))))break;{r.message.includes("blocked")&&(s.vF.warn(`[SymbiontStorage:${this.contextId}] Database still blocked, requesting close again...`),await this.requestOtherContextsToClose());const t=r.message.includes("blocked")?2e3+1e3*e:1e3+500*e;s.vF.info(`[SymbiontStorage:${this.contextId}] Waiting ${t}ms before retry`,{blocked:r.message.includes("blocked")}),await new Promise((e=>setTimeout(e,t)));const i=this.db;if(i){try{i.close()}catch(e){s.vF.warn(`[SymbiontStorage:${this.contextId}] Error closing connection before retry`,e)}this.db=null}if(r.message.includes("blocked")&&2===e){s.vF.warn(`[SymbiontStorage:${this.contextId}] Attempting to force close blocked database...`);try{await this.forceCloseDatabase()}catch(e){s.vF.warn(`[SymbiontStorage:${this.contextId}] Could not force close database`,e)}}}}s.vF.error(`[SymbiontStorage:${this.contextId}] All initialization attempts failed`);const i=this.db;if(i){try{i.close()}catch(e){s.vF.error(`[SymbiontStorage:${this.contextId}] Error closing database after failed init`,e)}this.db=null}throw r||new Error("IndexedDB initialization failed after all retries")}attemptInitialize(e){return new Promise(((t,r)=>{let i=null,n=!1,s=null;const a=()=>{i&&(clearTimeout(i),i=null),s&&(clearTimeout(s),s=null)},o=e=>{n||(n=!0,a(),r(e))},c=e?6e4:3e4;i=setTimeout((()=>{console.error(`[SymbiontStorage:${this.contextId}] IndexedDB open request timeout (no response after ${c}ms)`),console.error(`[SymbiontStorage:${this.contextId}] Environment: ${this.isPlaywrightContext?"Playwright/Test":"Production"}`),o(new Error(`IndexedDB open request timeout - no response from browser after ${c}ms`))}),c),console.log(`[SymbiontStorage:${this.contextId}] Opening IndexedDB...`);const h=indexedDB.open(this.DB_NAME,this.DB_VERSION);h.onerror=()=>{const e=h.error;console.error(`[SymbiontStorage:${this.contextId}] IndexedDB open failed:`,{name:e?.name,message:e?.message,code:e?.code}),o(e||new Error("Unknown IndexedDB error"))},h.onsuccess=()=>{console.log(`[SymbiontStorage:${this.contextId}] IndexedDB opened successfully`);try{if(this.db=h.result,!this.db)return void o(new Error("IndexedDB opened but result is null"));this.db.onerror=e=>{console.error(`[SymbiontStorage:${this.contextId}] Database error:`,e)},this.db.onversionchange=()=>{console.warn(`[SymbiontStorage:${this.contextId}] Database version changed, closing connection`),this.db?.close(),this.db=null},console.log(`[SymbiontStorage:${this.contextId}] Database initialized successfully`,{objectStores:Array.from(this.db.objectStoreNames)}),n||(n=!0,a(),t())}catch(e){console.error(`[SymbiontStorage:${this.contextId}] Error setting up database:`,e),o(e instanceof Error?e:new Error("Unknown error during database setup"))}},h.onupgradeneeded=e=>{console.log(`[SymbiontStorage:${this.contextId}] Database upgrade needed`);try{const t=e.target.result;if(!t)return void console.error(`[SymbiontStorage:${this.contextId}] Database upgrade: result is null`);if(!t.objectStoreNames.contains("organisms")){console.log(`[SymbiontStorage:${this.contextId}] Creating organisms store`);const e=t.createObjectStore("organisms",{keyPath:"id"});e.createIndex("generation","generation",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(!t.objectStoreNames.contains("behaviors")){console.log(`[SymbiontStorage:${this.contextId}] Creating behaviors store`);const e=t.createObjectStore("behaviors",{keyPath:"url"});e.createIndex("lastVisit","lastVisit",{unique:!1}),e.createIndex("visitCount","visitCount",{unique:!1})}if(!t.objectStoreNames.contains("mutations")){console.log(`[SymbiontStorage:${this.contextId}] Creating mutations store`);const e=t.createObjectStore("mutations",{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}if(t.objectStoreNames.contains("settings")||(console.log(`[SymbiontStorage:${this.contextId}] Creating settings store`),t.createObjectStore("settings",{keyPath:"key"})),!t.objectStoreNames.contains("invitations")){console.log(`[SymbiontStorage:${this.contextId}] Creating invitations store`);const e=t.createObjectStore("invitations",{keyPath:"code"});e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("status","status",{unique:!1})}console.log(`[SymbiontStorage:${this.contextId}] Database upgrade completed`)}catch(e){console.error(`[SymbiontStorage:${this.contextId}] Error during database upgrade:`,e),o(e instanceof Error?e:new Error("Unknown error during database upgrade"))}},h.onblocked=()=>{if(console.warn(`[SymbiontStorage:${this.contextId}] IndexedDB open blocked - another connection is still open`),console.warn(`[SymbiontStorage:${this.contextId}] Waiting for other connection to close...`),console.warn(`[SymbiontStorage:${this.contextId}] This may indicate another tab/context didn't respond to close request`),s&&clearTimeout(s),i){clearTimeout(i);const t=e?9e4:45e3;i=setTimeout((()=>{console.error(`[SymbiontStorage:${this.contextId}] IndexedDB still blocked after ${t}ms wait`),console.error(`[SymbiontStorage:${this.contextId}] This usually means another tab/context has the database open and didn't close it`),console.error(`[SymbiontStorage:${this.contextId}] Environment: ${this.isPlaywrightContext?"Playwright/Test":"Production"}`),o(new Error(`IndexedDB blocked - another connection preventing access after ${t}ms`))}),t)}}}))}async getOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,r)=>{const i=this.db.transaction(["organisms"],"readonly").objectStore("organisms");if(e){const n=i.get(e);n.onsuccess=()=>t(n.result||null),n.onerror=()=>r(n.error)}else{const e=i.openCursor();e.onsuccess=e=>{const r=e.target.result;t(r?r.value:null)},e.onerror=()=>r(e.error)}}));return this.withTimeout(t)}async saveOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,r)=>{const i=this.db.transaction(["organisms"],"readwrite").objectStore("organisms").put(e);i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}));return this.withTimeout(t)}async getBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").get(e);i.onsuccess=()=>t(i.result||null),i.onerror=()=>r(i.error)}))}async saveBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["behaviors"],"readwrite").objectStore("behaviors").put(e);i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}))}async addMutation(e){if(!this.db)throw new Error("Database not initialized");const t={...e,timestamp:e.timestamp||Date.now()};return new Promise(((e,r)=>{const i=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").add(t);i.onsuccess=()=>e(),i.onerror=()=>r(i.error)}))}async getRecentMutations(e=10){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["mutations"],"readonly").objectStore("mutations").index("timestamp").openCursor(null,"prev"),n=[];i.onsuccess=r=>{const i=r.target.result;i&&n.length<e?(n.push(i.value),i.continue()):t(n)},i.onerror=()=>r(i.error)}))}async getSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((r,i)=>{const n=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);n.onsuccess=()=>{const e=n.result;r(e?e.value:t)},n.onerror=()=>i(n.error)}))}async setSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((r,i)=>{const n=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:e,value:t});n.onsuccess=()=>r(),n.onerror=()=>i(n.error)}))}async addInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").add({...e,createdAt:e.createdAt||Date.now()});i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}))}async updateInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").put(e);i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}))}async getInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["invitations"],"readonly").objectStore("invitations").get(e);i.onsuccess=()=>t(i.result||null),i.onerror=()=>r(i.error)}))}async getAllInvitations(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const r=this.db.transaction(["invitations"],"readonly").objectStore("invitations").openCursor(),i=[];r.onsuccess=t=>{const r=t.target.result;r?(i.push(r.value),r.continue()):e(i)},r.onerror=()=>t(r.error)}))}async getBehaviorPatterns(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const r=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),i=[];r.onsuccess=t=>{const r=t.target.result;r?(i.push(r.value),r.continue()):(i.sort(((e,t)=>t.visitCount!==e.visitCount?t.visitCount-e.visitCount:t.lastVisit-e.lastVisit)),e(i))},r.onerror=()=>t(r.error)}))}async getRecentActivity(e=864e5){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-e;return new Promise(((e,r)=>{const i=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),n=[];i.onsuccess=r=>{const i=r.target.result;if(i){const e=i.value,r=(e.interactions||[]).filter((e=>e.timestamp>=t));for(const t of r)n.push({...t,url:e.url});i.continue()}else n.sort(((e,t)=>t.timestamp-e.timestamp)),e(n)},i.onerror=()=>r(i.error)}))}async cleanup(e=30){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-24*e*60*60*1e3;return new Promise(((e,r)=>{const i=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").index("timestamp"),n=IDBKeyRange.upperBound(t),s=i.openCursor(n);s.onsuccess=t=>{const r=t.target.result;r?(r.delete(),r.continue()):e()},s.onerror=()=>r(s.error)}))}async checkStorageQuota(){if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,r=(e.quota||0)/1048576,i=r>0?t/r*100:0;console.info("Storage quota:",{usageInMB:t.toFixed(2),quotaInMB:r.toFixed(2),usagePercent:i.toFixed(2)+"%"}),i>80&&!this.quotaWarningIssued&&(this.quotaWarningIssued=!0,console.warn("STORAGE WARNING: Usage above 80%, consider cleanup"),i>90&&(console.warn("STORAGE CRITICAL: Usage above 90%, triggering automatic cleanup"),await this.cleanup(15))),t>.9*this.MAX_STORAGE_SIZE_MB&&(console.error("STORAGE CRITICAL: Approaching maximum storage size limit"),await this.cleanup(7))}catch(e){console.error("Failed to check storage quota:",e)}else console.warn("Storage API not available, skipping quota check")}async getStorageStats(){if(!navigator.storage||!navigator.storage.estimate)return{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1};try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,r=(e.quota||0)/1048576,i=r>0?t/r*100:0;return{usageInMB:t,quotaInMB:r,usagePercent:i,needsCleanup:i>80}}catch(e){return console.error("Failed to get storage stats:",e),{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1}}}close(){s.vF.info(`[SymbiontStorage:${this.contextId}] Closing database connection`),this.isClosing=!0,this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null,s.vF.debug(`[SymbiontStorage:${this.contextId}] Heartbeat stopped`));const e=this.db;if(e){try{e.close(),s.vF.info(`[SymbiontStorage:${this.contextId}] Database connection closed successfully`)}catch(e){s.vF.error(`[SymbiontStorage:${this.contextId}] Error closing database`,e)}this.db=null}if(this.broadcastChannel){try{this.broadcastChannel.close(),s.vF.debug(`[SymbiontStorage:${this.contextId}] BroadcastChannel closed`)}catch(e){s.vF.error(`[SymbiontStorage:${this.contextId}] Error closing BroadcastChannel`,e)}this.broadcastChannel=null}m.removeInstance(this.contextType),this.isClosing=!1}async forceCloseDatabase(){console.warn(`[SymbiontStorage:${this.contextId}] Attempting to force close database by deleting and recreating...`);const e=this.db;if(e){try{e.close()}catch(e){console.warn(`[SymbiontStorage:${this.contextId}] Error closing our connection:`,e)}this.db=null}return console.log(`[SymbiontStorage:${this.contextId}] Requesting other contexts to close before deletion...`),await this.requestOtherContextsToClose(),await new Promise((e=>setTimeout(e,1e3))),new Promise((e=>{const t=indexedDB.deleteDatabase(this.DB_NAME);let r=!1;const i=()=>{r||(r=!0,e())};t.onsuccess=()=>{console.log(`[SymbiontStorage:${this.contextId}] Database deleted successfully, will be recreated on next open`),i()},t.onerror=()=>{const e=t.error;console.warn(`[SymbiontStorage:${this.contextId}] Could not delete database:`,e),i()},t.onblocked=()=>{console.warn(`[SymbiontStorage:${this.contextId}] Database delete blocked - another connection still open`),console.warn(`[SymbiontStorage:${this.contextId}] Waiting up to 5 seconds for connections to close...`),setTimeout((()=>{console.warn(`[SymbiontStorage:${this.contextId}] Database delete still blocked after 5s, giving up`),i()}),5e3)},setTimeout((()=>{console.warn(`[SymbiontStorage:${this.contextId}] Database deletion timeout after 10s`),i()}),1e4)}))}static async forceCloseAllConnections(e="symbiont-db"){s.vF.warn("[SymbiontStorage] Force closing ALL IndexedDB connections globally..."),m.closeAll();try{const e=new BroadcastChannel("symbiont-storage-coordination");e.postMessage({type:"FORCE_SHUTDOWN",requestId:Date.now().toString(),senderId:"global-cleanup"}),await new Promise((e=>setTimeout(e,500))),e.close()}catch(e){s.vF.warn("[SymbiontStorage] BroadcastChannel not available for cleanup",e)}return new Promise((t=>{const r=indexedDB.deleteDatabase(e);let i=!1;const n=()=>{i||(i=!0,s.vF.info("[SymbiontStorage] Global cleanup completed"),t())};r.onsuccess=()=>{s.vF.info("[SymbiontStorage] Database deleted during global cleanup"),n()},r.onerror=()=>{s.vF.warn("[SymbiontStorage] Database deletion failed during cleanup",r.error),n()},r.onblocked=()=>{s.vF.warn("[SymbiontStorage] Database deletion blocked - forcing timeout"),setTimeout((()=>n()),3e3)},setTimeout((()=>n()),5e3)}))}}class y{constructor(){this.primaryStorage=null,this.isPrimaryContext=!1,this.initPromise=null,this.pendingRequests=new Map}static async getInstance(){return this.instance||(this.instance=new y,await this.instance.initialize()),this.instance}static reset(){this.instance&&(this.instance.close(),this.instance=null)}async initialize(){return this.initPromise||(this.initPromise=this._performInitialization()),this.initPromise}async _performInitialization(){if(this.isPrimaryContext=this.isBackgroundContext(),s.vF.info("[IndexedDBCoordinator] Initializing",{isPrimary:this.isPrimaryContext,contextType:this.getContextType()}),this.isPrimaryContext){s.vF.info("[IndexedDBCoordinator] Primary context - opening IndexedDB"),this.primaryStorage=new g;try{await this.primaryStorage.initialize(),s.vF.info("[IndexedDBCoordinator] IndexedDB initialized successfully"),this.setupMessageHandler()}catch(e){throw s.vF.error("[IndexedDBCoordinator] Failed to initialize IndexedDB",e),e}}else s.vF.info("[IndexedDBCoordinator] Secondary context - using message proxy"),this.setupMessageProxy()}isBackgroundContext(){if("undefined"==typeof window)return!0;try{if("undefined"!=typeof ServiceWorkerGlobalScope&&self instanceof ServiceWorkerGlobalScope)return!0}catch(e){}return!1}getContextType(){return this.isBackgroundContext()?"background":"undefined"!=typeof window?window.location.href.includes("popup.html")?"popup":"content-script":"unknown"}setupMessageHandler(){"undefined"!=typeof chrome&&chrome.runtime?(chrome.runtime.onMessage.addListener(((e,t,r)=>!!e.type?.startsWith("STORAGE_")&&(s.vF.debug("[IndexedDBCoordinator] Received storage request",{type:e.type,requestId:e.requestId}),this.handleStorageRequest(e).then((t=>{r({success:!0,data:t,requestId:e.requestId})})).catch((t=>{s.vF.error("[IndexedDBCoordinator] Request failed",{type:e.type,error:t}),r({success:!1,error:t instanceof Error?t.message:String(t),requestId:e.requestId})})),!0))),s.vF.info("[IndexedDBCoordinator] Message handler setup complete")):s.vF.warn("[IndexedDBCoordinator] Chrome runtime not available")}setupMessageProxy(){s.vF.info("[IndexedDBCoordinator] Message proxy setup complete")}async handleStorageRequest(e){if(!this.primaryStorage)throw new Error("Storage not initialized in primary context");const{type:t,payload:r}=e;switch(t){case"STORAGE_GET_ORGANISM":return await this.primaryStorage.getOrganism(r?.id);case"STORAGE_SAVE_ORGANISM":return await this.primaryStorage.saveOrganism(r.organism),{success:!0};case"STORAGE_GET_BEHAVIOR":return await this.primaryStorage.getBehavior(r.url);case"STORAGE_SAVE_BEHAVIOR":return await this.primaryStorage.saveBehavior(r.behavior),{success:!0};case"STORAGE_ADD_MUTATION":return await this.primaryStorage.addMutation(r.mutation),{success:!0};case"STORAGE_GET_RECENT_MUTATIONS":return await this.primaryStorage.getRecentMutations(r.limit||10);case"STORAGE_GET_SETTING":return await this.primaryStorage.getSetting(r.key,r.defaultValue);case"STORAGE_SET_SETTING":return await this.primaryStorage.setSetting(r.key,r.value),{success:!0};case"STORAGE_ADD_INVITATION":return await this.primaryStorage.addInvitation(r.invitation),{success:!0};case"STORAGE_UPDATE_INVITATION":return await this.primaryStorage.updateInvitation(r.invitation),{success:!0};case"STORAGE_GET_INVITATION":return await this.primaryStorage.getInvitation(r.code);case"STORAGE_GET_ALL_INVITATIONS":return await this.primaryStorage.getAllInvitations();case"STORAGE_GET_BEHAVIOR_PATTERNS":return await this.primaryStorage.getBehaviorPatterns();case"STORAGE_GET_RECENT_ACTIVITY":return await this.primaryStorage.getRecentActivity(r.periodMs);case"STORAGE_CLEANUP":return await this.primaryStorage.cleanup(r.retentionDays),{success:!0};case"STORAGE_GET_STATS":return await this.primaryStorage.getStorageStats();default:throw new Error(`Unknown storage request type: ${t}`)}}async sendMessageToBackground(e,t){if("undefined"==typeof chrome||!chrome.runtime)throw new Error("Chrome runtime not available");const r=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i={type:e,payload:t,requestId:r};return new Promise(((t,n)=>{const s=setTimeout((()=>{this.pendingRequests.delete(r),n(new Error(`Storage request timeout: ${e}`))}),3e4);this.pendingRequests.set(r,{resolve:t,reject:n,timeout:s}),chrome.runtime.sendMessage(i,(e=>{const i=this.pendingRequests.get(r);i&&(clearTimeout(i.timeout),this.pendingRequests.delete(r)),chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):e?e.success?t(e.data):n(new Error(e.error||"Unknown error")):n(new Error("No response from background"))}))}))}async getOrganism(e){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getOrganism(e):this.sendMessageToBackground("STORAGE_GET_ORGANISM",{id:e})}async saveOrganism(e){this.isPrimaryContext&&this.primaryStorage?await this.primaryStorage.saveOrganism(e):await this.sendMessageToBackground("STORAGE_SAVE_ORGANISM",{organism:e})}async getBehavior(e){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getBehavior(e):this.sendMessageToBackground("STORAGE_GET_BEHAVIOR",{url:e})}async saveBehavior(e){this.isPrimaryContext&&this.primaryStorage?await this.primaryStorage.saveBehavior(e):await this.sendMessageToBackground("STORAGE_SAVE_BEHAVIOR",{behavior:e})}async addMutation(e){this.isPrimaryContext&&this.primaryStorage?await this.primaryStorage.addMutation(e):await this.sendMessageToBackground("STORAGE_ADD_MUTATION",{mutation:e})}async getRecentMutations(e=10){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getRecentMutations(e):this.sendMessageToBackground("STORAGE_GET_RECENT_MUTATIONS",{limit:e})}async getSetting(e,t){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getSetting(e,t):this.sendMessageToBackground("STORAGE_GET_SETTING",{key:e,defaultValue:t})}async setSetting(e,t){this.isPrimaryContext&&this.primaryStorage?await this.primaryStorage.setSetting(e,t):await this.sendMessageToBackground("STORAGE_SET_SETTING",{key:e,value:t})}async addInvitation(e){this.isPrimaryContext&&this.primaryStorage?await this.primaryStorage.addInvitation(e):await this.sendMessageToBackground("STORAGE_ADD_INVITATION",{invitation:e})}async updateInvitation(e){this.isPrimaryContext&&this.primaryStorage?await this.primaryStorage.updateInvitation(e):await this.sendMessageToBackground("STORAGE_UPDATE_INVITATION",{invitation:e})}async getInvitation(e){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getInvitation(e):this.sendMessageToBackground("STORAGE_GET_INVITATION",{code:e})}async getAllInvitations(){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getAllInvitations():this.sendMessageToBackground("STORAGE_GET_ALL_INVITATIONS")}async getBehaviorPatterns(){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getBehaviorPatterns():this.sendMessageToBackground("STORAGE_GET_BEHAVIOR_PATTERNS")}async getRecentActivity(e=864e5){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getRecentActivity(e):this.sendMessageToBackground("STORAGE_GET_RECENT_ACTIVITY",{periodMs:e})}async cleanup(e=30){this.isPrimaryContext&&this.primaryStorage?await this.primaryStorage.cleanup(e):await this.sendMessageToBackground("STORAGE_CLEANUP",{retentionDays:e})}async getStorageStats(){return this.isPrimaryContext&&this.primaryStorage?this.primaryStorage.getStorageStats():this.sendMessageToBackground("STORAGE_GET_STATS")}close(){s.vF.info("[IndexedDBCoordinator] Closing");for(const[e,t]of this.pendingRequests)clearTimeout(t.timeout),t.reject(new Error("Coordinator closing"));this.pendingRequests.clear(),this.isPrimaryContext&&this.primaryStorage&&(this.primaryStorage.close(),this.primaryStorage=null),this.initPromise=null}}y.instance=null;class p{constructor(e=2e3,t=1e4){this.pendingOrganisms=new Map,this.pendingBehaviors=new Map,this.coordinator=null,this.DEBOUNCE_MS=e,this.MAX_PENDING_TIME_MS=t}static getInstance(e,t){return this.instance||(this.instance=new p(e,t)),this.instance}async setCoordinator(e){this.coordinator=e}async saveOrganism(e){if(!this.coordinator)throw new Error("Coordinator not set");const t="organism-"+e.id,r=Date.now(),i=this.pendingOrganisms.get(t);return i&&(clearTimeout(i.timer),r-i.timestamp>this.MAX_PENDING_TIME_MS)?(s.vF.debug("[StorageDebouncer] Max pending time reached, flushing immediately",{organismId:e.id,pendingTime:r-i.timestamp}),void await this._flushOrganism(t,e)):new Promise(((n,a)=>{const o=setTimeout((async()=>{try{await this._flushOrganism(t,e),n()}catch(e){s.vF.error("[StorageDebouncer] Failed to flush organism",e),a(e)}}),this.DEBOUNCE_MS);this.pendingOrganisms.set(t,{data:e,timer:o,timestamp:i?.timestamp||r,flushCallback:()=>n()}),s.vF.debug("[StorageDebouncer] Organism save debounced",{organismId:e.id,debounceMs:this.DEBOUNCE_MS})}))}async saveBehavior(e){if(!this.coordinator)throw new Error("Coordinator not set");const t="behavior-"+e.url,r=Date.now(),i=this.pendingBehaviors.get(t);return i&&(clearTimeout(i.timer),r-i.timestamp>this.MAX_PENDING_TIME_MS)?(s.vF.debug("[StorageDebouncer] Max pending time reached for behavior, flushing",{url:e.url}),void await this._flushBehavior(t,e)):new Promise(((n,a)=>{const o=setTimeout((async()=>{try{await this._flushBehavior(t,e),n()}catch(e){s.vF.error("[StorageDebouncer] Failed to flush behavior",e),a(e)}}),this.DEBOUNCE_MS);this.pendingBehaviors.set(t,{data:e,timer:o,timestamp:i?.timestamp||r,flushCallback:()=>n()}),s.vF.debug("[StorageDebouncer] Behavior save debounced",{url:e.url,debounceMs:this.DEBOUNCE_MS})}))}async _flushOrganism(e,t){if(!this.coordinator)throw new Error("Coordinator not set");try{s.vF.debug("[StorageDebouncer] Flushing organism",{organismId:t.id}),await this.coordinator.saveOrganism(t),this.pendingOrganisms.delete(e),s.vF.debug("[StorageDebouncer] Organism flushed successfully",{organismId:t.id})}catch(e){throw s.vF.error("[StorageDebouncer] Failed to flush organism",e),e}}async _flushBehavior(e,t){if(!this.coordinator)throw new Error("Coordinator not set");try{s.vF.debug("[StorageDebouncer] Flushing behavior",{url:t.url}),await this.coordinator.saveBehavior(t),this.pendingBehaviors.delete(e),s.vF.debug("[StorageDebouncer] Behavior flushed successfully",{url:t.url})}catch(e){throw s.vF.error("[StorageDebouncer] Failed to flush behavior",e),e}}async flushAll(){s.vF.info("[StorageDebouncer] Flushing all pending operations",{pendingOrganisms:this.pendingOrganisms.size,pendingBehaviors:this.pendingBehaviors.size});const e=[];for(const[t,r]of this.pendingOrganisms)clearTimeout(r.timer),e.push(this._flushOrganism(t,r.data));for(const[t,r]of this.pendingBehaviors)clearTimeout(r.timer),e.push(this._flushBehavior(t,r.data));try{await Promise.all(e),s.vF.info("[StorageDebouncer] All operations flushed successfully")}catch(e){throw s.vF.error("[StorageDebouncer] Some operations failed during flush",e),e}}getPendingCount(){const e=this.pendingOrganisms.size,t=this.pendingBehaviors.size;return{organisms:e,behaviors:t,total:e+t}}async dispose(){s.vF.info("[StorageDebouncer] Disposing"),await this.flushAll();for(const[e,t]of this.pendingOrganisms)clearTimeout(t.timer);for(const[e,t]of this.pendingBehaviors)clearTimeout(t.timer);this.pendingOrganisms.clear(),this.pendingBehaviors.clear(),this.coordinator=null,s.vF.info("[StorageDebouncer] Disposed")}static reset(){this.instance&&(this.instance.dispose().catch((e=>s.vF.error("[StorageDebouncer] Error during reset",e))),this.instance=null)}}p.instance=null;const f={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let v;const S=new Uint8Array(16),E=[];for(let e=0;e<256;++e)E.push((e+256).toString(16).slice(1));const b=function(e,t,r){if(f.randomUUID&&!t&&!e)return f.randomUUID();const i=(e=e||{}).random??e.rng?.()??function(){if(!v){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");v=crypto.getRandomValues.bind(crypto)}return v(S)}();if(i.length<16)throw new Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){if((r=r||0)<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=i[e];return t}return function(e,t=0){return(E[e[t+0]]+E[e[t+1]]+E[e[t+2]]+E[e[t+3]]+"-"+E[e[t+4]]+E[e[t+5]]+"-"+E[e[t+6]]+E[e[t+7]]+"-"+E[e[t+8]]+E[e[t+9]]+"-"+E[e[t+10]]+E[e[t+11]]+E[e[t+12]]+E[e[t+13]]+E[e[t+14]]+E[e[t+15]]).toLowerCase()}(i)};class w{constructor(e){this.storage=e}async generateInvitation(e){const t={code:b().slice(0,8).toUpperCase(),donorId:e,symbolicLink:this.generateSymbolicLink(),used:!1,createdAt:Date.now()};return await this.storage.addInvitation(t),t}async consumeInvitation(e,t){const r=await this.storage.getInvitation(e);return!r||r.used?null:(r.used=!0,r.receiverId=t,r.usedAt=Date.now(),await this.storage.updateInvitation(r),r)}async isValid(e){const t=await this.storage.getInvitation(e);return!!t&&!t.used}generateSymbolicLink(){const e=["#FF00FF","#00FFFF","#FFFF00","#FF8800","#00FF88","#8800FF"];return e[Math.floor(d.Dm.random()*e.length)]}async getAllInvitations(){return await this.storage.getAllInvitations()}}const I={loop:["Encore ce m√™me chemin... Qu'y cherches-tu ?","La boucle se r√©p√®te, intention ou habitude ?","Revenir, encore et encore. Un besoin de rep√®re ?"],idle:["Un temps de pause... ou d'h√©sitation ?","Le silence aussi fait partie du voyage.","L'inactivit√©, pr√©lude √† une nouvelle exploration ?"],exploration:["Nouveau territoire, nouvelle perspective.","L'exploration nourrit la curiosit√©.","Tu t'aventures hors des sentiers battus."],routine:["Les habitudes forgent des chemins familiers.","La routine rassure, mais l'inattendu surprend.","Encore ce site, comme un rituel quotidien."],default:["Tu reviens souvent ici quand tu doutes.","Pourquoi cette boucle ?","As-tu remarqu√© ce sch√©ma dans ta navigation ?","Un autre d√©tour, ou une qu√™te de sens ?","Ce site semble t'attirer dans les moments de r√©flexion.","Encore une fois, tu explores ce chemin familier.","Et si tu essayais une nouvelle direction ?","La r√©p√©tition cache-t-elle une intention ?","Un murmure dans le flux de tes habitudes...","Parfois, la boucle est une porte vers l'inattendu."]},T={morning:["Un nouveau jour, une nouvelle boucle commence.","Le matin invite √† la d√©couverte.","L'aube de tes habitudes num√©riques."],afternoon:["L'apr√®s-midi, la routine s'installe.","Un moment propice √† l'exploration ou √† la r√©p√©tition ?","Le soleil haut, l'esprit vagabonde."],evening:["Le soir, tu reviens √† l'essentiel.","La nuit favorise les d√©tours int√©rieurs.","Encore connect√©, m√™me √† la tomb√©e du jour."],weekend:["Le week-end, les chemins changent.","Un rythme diff√©rent, des envies nouvelles.","La libert√© du week-end se lit dans ta navigation."]};class A{generateMurmur(e){if(function(){const e=(new Date).getDay();return 0===e||6===e}()){const e=T.weekend;if(d.Dm.random()<.5)return e[Math.floor(d.Dm.random()*e.length)]}else{const e=function(){const e=(new Date).getHours();return e<12?"morning":e<18?"afternoon":"evening"}();if(T[e]&&d.Dm.random()<.4){const t=T[e];return t[Math.floor(d.Dm.random()*t.length)]}}const t=e&&I[e]?I[e]:I.default;return t[Math.floor(d.Dm.random()*t.length)]}}class R{static detectRepetition(e,t=3){const r={};for(const t of e)r[t.type]=(r[t.type]||0)+1;return Object.entries(r).filter((([e,r])=>r>=t)).map((([e,t])=>({type:"repetition",score:t,details:{eventType:e}})))}static detectAlternance(e,t,r,i=4){let n=0,s=null;for(const i of e)i.type!==t&&i.type!==r||i.type===s?i.type===s&&(n=1,s=i.type):(n++,s=i.type);return n>=i?[{type:"alternance",score:n,details:{typeA:t,typeB:r}}]:[]}static detectBurst(e,t=1e3,r=3){if(e.length<r)return[];let i=1,n=1;for(let r=1;r<e.length;r++)e[r].timestamp-e[r-1].timestamp<=t?(i++,n=Math.max(n,i)):i=1;return n>=r?[{type:"burst",score:n,details:{maxInterval:t}}]:[]}static detectTemporalPattern(e,t=1e3,r=.2){if(e.length<3)return[];const i=[];for(let t=1;t<e.length;t++)i.push(e[t].timestamp-e[t-1].timestamp);const n=i.reduce(((e,t)=>e+t),0)/i.length,s=i.reduce(((e,t)=>e+Math.pow(t-n,2)),0)/i.length,a=Math.sqrt(s);return n>=t&&a/n<r?[{type:"temporal",score:n,details:{std:a,count:e.length}}]:[]}}class C{static getInstance(){return this.instance||(this.instance=new C),this.instance}async setItem(e,t){try{await chrome.storage.local.set({[e]:t})}catch(e){throw s.vF.error("Storage error:",e),e}}async getItem(e){try{return(await chrome.storage.local.get([e]))[e]||null}catch(e){return s.vF.error("Storage retrieval error:",e),null}}async removeItem(e){try{await chrome.storage.local.remove([e])}catch(e){s.vF.error("Storage removal error:",e)}}}class _{static get swLocalStorage(){return{getItem:e=>this.storage.getItem(e),setItem:(e,t)=>this.storage.setItem(e,t),removeItem:e=>this.storage.removeItem(e)}}static get swIndexedDB(){return globalThis.indexedDB}static get swCryptoAPI(){return"undefined"!=typeof globalThis&&globalThis.crypto&&globalThis.crypto.subtle&&"function"==typeof globalThis.crypto.getRandomValues?{...globalThis.crypto,encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)}:(s.vF.warn("WebCrypto API non disponible - utilisation du mode de d√©veloppement"),{subtle:null,getRandomValues:e=>{for(let t=0;t<e.length;t++){const r=Date.now()+t;e[t]=Math.floor(1e4*Math.sin(r)%256)}return e},encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)})}}_.storage=C.getInstance(),_.swCrypto=new class{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(e){try{const t=new TextEncoder,r=t.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),i=await crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt"]),n=crypto.getRandomValues(new Uint8Array(12)),s=t.encode(JSON.stringify(e)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},i,s),o=new Uint8Array(n.length+a.byteLength);return o.set(n,0),o.set(new Uint8Array(a),n.length),btoa(String.fromCharCode(...o))}catch(t){s.vF.error("Encryption failed, using fallback:",t);const r=JSON.stringify(e);return btoa(unescape(encodeURIComponent(r)))}}async decryptSensitiveData(e){try{const t=Uint8Array.from(atob(e),(e=>e.charCodeAt(0))),r=t.slice(0,12),i=t.slice(12),n=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),s=await crypto.subtle.importKey("raw",n,{name:"AES-GCM"},!1,["decrypt"]),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},s,i),o=new TextDecoder;return JSON.parse(o.decode(a))}catch(t){s.vF.error("Decryption failed, trying fallback:",t);try{const t=decodeURIComponent(escape(atob(e)));return JSON.parse(t)}catch(e){throw s.vF.error("All decryption methods failed:",e),new Error("Unable to decrypt data")}}}},_.swBroadcastChannel=class{constructor(e){this.handlers=new Map,this.channelName=e,this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener(((e,t,r)=>"CRYPTO_OPERATION"===e.type||e.channel===this.channelName&&(this.handleMessage(e.data),!0)))}serializeMessageData(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return s.vF.warn("Message serialization issue, cleaning object:",t),this.cleanObjectForSerialization(e)}}cleanObjectForSerialization(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner)return"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>this.cleanObjectForSerialization(e,t)));const r={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i))try{r[i]=this.cleanObjectForSerialization(e[i],t)}catch(e){r[i]="[Non-serializable]"}return r}postMessage(e){const t=this.serializeMessageData(e);chrome.tabs.query({},(e=>{e.forEach((e=>{e.id&&chrome.tabs.sendMessage(e.id,{channel:this.channelName,data:t}).catch((()=>{}))}))})),this.broadcastViaStorage(t)}async broadcastViaStorage(e){const t=C.getInstance(),r=Date.now(),i=`broadcast_${this.channelName}_${r}`;await t.setItem(i,JSON.stringify({data:e,timestamp:r,channel:this.channelName})),setTimeout((async()=>{await t.removeItem(i)}),3e4)}handleMessage(e){(this.handlers.get("message")||[]).forEach((t=>{try{t({data:e})}catch(e){s.vF.error("Message handler error:",e)}}))}set onmessage(e){this.handlers.has("message")||this.handlers.set("message",[]),this.handlers.get("message").push((t=>e(t)))}};const N=_.swLocalStorage,M=(_.swBroadcastChannel,_.swCryptoAPI);_.swIndexedDB;class D{constructor(e){this.activeRequests=0,this.circuitBreakerOpen=!1,this.lastFailureTime=0,this.circuitBreakerTimeout=3e4,this.config=e}async execute(e){if(this.circuitBreakerOpen){if(Date.now()-this.lastFailureTime<this.circuitBreakerTimeout)throw new Error(`Circuit breaker ouvert pour ${this.config.name}`);this.circuitBreakerOpen=!1,s.vF.info(`Circuit breaker ferm√© pour ${this.config.name}`)}if(this.activeRequests>=this.config.maxConcurrentRequests){if("fail-fast"===this.config.fallbackStrategy)throw new Error(`Bulkhead satur√©: ${this.config.name}`);await this.waitForSlot()}this.activeRequests++;try{return await this.executeWithTimeout(e)}catch(e){throw this.handleFailure(e),e}finally{this.activeRequests--}}async executeWithTimeout(e){return new Promise(((t,r)=>{const i=setTimeout((()=>{r(new Error(`Timeout dans bulkhead ${this.config.name}`))}),this.config.timeout);e().then((e=>{clearTimeout(i),t(e)})).catch((e=>{clearTimeout(i),r(e)}))}))}async waitForSlot(){const e=this.config.timeout,t=Date.now();for(;this.activeRequests>=this.config.maxConcurrentRequests;){if(Date.now()-t>e)throw new Error(`Timeout d'attente pour bulkhead ${this.config.name}`);await new Promise((e=>setTimeout(e,10)))}}handleFailure(e){"circuit-breaker"===this.config.fallbackStrategy&&(this.circuitBreakerOpen=!0,this.lastFailureTime=Date.now(),s.vF.warn(`Circuit breaker ouvert pour ${this.config.name}:`,e))}}const O=new class{constructor(){this.bulkheads=new Map,this.metrics=new Map}createBulkhead(e){if(this.bulkheads.has(e.name))return this.bulkheads.get(e.name);const t=new D(e);return this.bulkheads.set(e.name,t),this.metrics.set(e.name,{name:e.name,activeRequests:0,totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0}),s.vF.info(`Bulkhead cr√©√©: ${e.name}`,e),t}async execute(e,t,r){const i=this.bulkheads.get(e);if(!i)throw new Error(`Bulkhead non trouv√©: ${e}`);const n=Date.now();this.updateMetrics(e,"start");try{const r=await i.execute(t),s=Date.now()-n;return this.updateMetrics(e,"success",s),r}catch(t){const r=Date.now()-n;throw this.updateMetrics(e,"error",r,t),t}}updateMetrics(e,t,r,i){const n=this.metrics.get(e);if(n)switch(t){case"start":n.activeRequests++,n.totalRequests++;break;case"success":n.activeRequests--,n.successfulRequests++,r&&(n.averageResponseTime=(n.averageResponseTime*(n.successfulRequests-1)+r)/n.successfulRequests);break;case"error":n.activeRequests--,n.failedRequests++,i&&(n.lastError=i instanceof Error?i.message:String(i),n.lastErrorTime=Date.now())}}getMetrics(){return Array.from(this.metrics.values())}getBulkheadMetrics(e){return this.metrics.get(e)||null}getHealthStatus(){const e={};for(const[t,r]of this.metrics){const i=r.totalRequests>0?r.failedRequests/r.totalRequests:0;i>.5?e[t]="failed":i>.2||r.averageResponseTime>5e3?e[t]="degraded":e[t]="healthy"}return e}};class x{constructor(e=!1){this.encryptionKey=null,this.keyPromise=null,this.setupBulkheads(),e||this.initializeSecureKey()}setupBulkheads(){O.createBulkhead({name:"crypto-operations",maxConcurrentRequests:5,timeout:1e4,fallbackStrategy:"circuit-breaker",retryAttempts:2}),O.createBulkhead({name:"secure-storage",maxConcurrentRequests:10,timeout:5e3,fallbackStrategy:"fail-fast"}),O.createBulkhead({name:"data-anonymization",maxConcurrentRequests:3,timeout:3e3,fallbackStrategy:"retry",retryAttempts:3})}async initializeSecureKey(){this.keyPromise||(this.keyPromise=this.generateSecureKey(),this.encryptionKey=await this.keyPromise)}async generateSecureKey(){if(!M?.subtle)return s.vF.warn("WebCrypto API non disponible - mode d√©veloppement activ√© (NON S√âCURIS√â)"),this.createDevelopmentKey();const e=await this.getStoredKey();if(e)return await M.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"]);const t=await M.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return await this.storeKey(t),t}createDevelopmentKey(){return{type:"secret",extractable:!1,algorithm:{name:"AES-GCM"},usages:["encrypt","decrypt"]}}async getStoredKey(){try{return new Promise((e=>{chrome.storage.local.get(["symbiont_key_v2"],(t=>{if(t.symbiont_key_v2){const r=new Uint8Array(t.symbiont_key_v2);e(r.buffer)}else e(null)}))}))}catch{return null}}async storeKey(e){try{if(!M?.subtle)return void s.vF.warn("Mode d√©veloppement: pas de stockage de cl√© r√©el");const t=await M.subtle.exportKey("raw",e),r=Array.from(new Uint8Array(t));chrome.storage.local.set({symbiont_key_v2:r,symbiont_key_created:Date.now()})}catch(e){s.vF.error("Erreur lors du stockage de la cl√©:",e)}}async ensureKeyReady(){if(this.encryptionKey||await this.initializeSecureKey(),!this.encryptionKey)throw new Error("Impossible d'initialiser la cl√© de chiffrement");return this.encryptionKey}async encryptSensitiveData(e){return O.execute("crypto-operations",(async()=>this._encryptSensitiveData(e)),"encryptSensitiveData")}async _encryptSensitiveData(e){if(!M?.subtle)return s.vF.warn("WebCrypto API non disponible - chiffrement factice pour d√©veloppement"),"DEV_MODE:"+btoa(JSON.stringify(e));try{const t=await this.ensureKeyReady(),r=new TextEncoder,i=M.getRandomValues(new Uint8Array(12)),n=r.encode(JSON.stringify(e)),s=await M.subtle.encrypt({name:"AES-GCM",iv:i},t,n),a=new Uint8Array(i.length+s.byteLength);return a.set(i,0),a.set(new Uint8Array(s),i.length),btoa(String.fromCharCode(...a))}catch(e){throw s.vF.error("Erreur de chiffrement:",e),new Error("√âchec du chiffrement des donn√©es sensibles")}}async decryptSensitiveData(e){return O.execute("crypto-operations",(async()=>this._decryptSensitiveData(e)),"decryptSensitiveData")}async _decryptSensitiveData(e){if("string"!=typeof e)throw new Error("decryptSensitiveData attend une cha√Æne de caract√®res.");if(e.startsWith("DEV_MODE:")){s.vF.warn("D√©chiffrement en mode d√©veloppement (non s√©curis√©)");try{return JSON.parse(atob(e.substring(9)))}catch(e){return s.vF.error("Erreur d√©chiffrement mode d√©veloppement:",e),null}}if(!M?.subtle)return s.vF.warn("WebCrypto API non disponible - d√©chiffrement factice pour d√©veloppement"),null;try{const t=await this.ensureKeyReady(),r=Uint8Array.from(atob(String(e)),(e=>e.charCodeAt(0))),i=r.slice(0,12),n=r.slice(12),s=await M.subtle.decrypt({name:"AES-GCM",iv:i},t,n),a=(new TextDecoder).decode(s);return JSON.parse(a)}catch(e){throw s.vF.error("Erreur de d√©chiffrement:",e),new Error("√âchec du d√©chiffrement des donn√©es - donn√©es corrompues ou cl√© invalide")}}async anonymizeForSharing(e){return O.execute("data-anonymization",(async()=>this._anonymizeForSharing(e)),"anonymizeForSharing")}async _anonymizeForSharing(e){const t={...e};return"url"in t&&(t.url="anonymized"),"userId"in t&&"string"==typeof t.userId&&(t.userId=await this.hash(t.userId)),"id"in t&&"string"==typeof t.id&&(t.id=await this.hash(t.id)),["email","name","address","phone","ip","ssn","creditCard","passport","nationalId","birthDate","age","location","coordinates","biometric","medical","financial","salary"].forEach((e=>{e in t&&delete t[e]})),"timestamp"in t&&"number"==typeof t.timestamp&&(t.timestamp=36e5*Math.floor(t.timestamp/36e5)),t}anonymizeForSharingSync(e){const t={...e};return"url"in t&&(t.url="anonymized"),"userId"in t&&"string"==typeof t.userId&&(t.userId=this.hashSync(t.userId)),"id"in t&&"string"==typeof t.id&&(t.id=this.hashSync(t.id)),t}validateDataAccess(e,t="user"){return!(!e.userId||!e.resource||"admin"===t&&"admin"!==e.role)}async hash(e){if(!M?.subtle){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return btoa(t.toString())}try{const t=(new TextEncoder).encode(e),r=await M.subtle.digest("SHA-256",t),i=new Uint8Array(r);return btoa(String.fromCharCode(...i))}catch(e){throw s.vF.error("Erreur de hashage:",e),new Error("√âchec du hashage s√©curis√©")}}hashSync(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return btoa(t.toString())}}class F{static setDependencies(e){this.dependencies=e}static createOrganism(e,t){if(!this.dependencies)throw new Error("OrganismFactory dependencies not set. Call setDependencies() first.");const{OrganismCore:r}=i(502);return new r(e,t,this.dependencies.createNeuralMesh)}static createNeuralMesh(){const{NeuralMesh:e}=i(194);return new e}}F.dependencies=null;class k{constructor(){this.failureCount=0,this.open=!1,this.lastFailure=0,this.failureThreshold=5,this.recoveryTimeout=3e4}isOpen(){return this.open&&Date.now()-this.lastFailure>this.recoveryTimeout&&(this.open=!1,this.failureCount=0),this.open}recordSuccess(){this.failureCount=0,this.open=!1}recordFailure(){this.failureCount++,this.lastFailure=Date.now(),this.failureCount>=this.failureThreshold&&(this.open=!0)}}class B{constructor(){this.key="symbiont_messages"}async enqueue(e){s.vF.info("[ResilientMessageBus] enqueue",e);const t=JSON.parse(await N.getItem(this.key)||"[]");t.push(e),await N.setItem(this.key,JSON.stringify(t)),s.vF.info("[ResilientMessageBus] enqueue OK",t.length)}async dequeue(){const e=JSON.parse(await N.getItem(this.key)||"[]"),t=e.shift();return await N.setItem(this.key,JSON.stringify(e)),s.vF.info("[ResilientMessageBus] dequeue",t),t}async getAll(){const e=JSON.parse(await N.getItem(this.key)||"[]");return s.vF.info("[ResilientMessageBus] getAll",e.length),e}}const P={getItem:e=>{try{return"undefined"!=typeof localStorage?localStorage.getItem(e):null}catch{return null}},setItem:(e,t)=>{try{"undefined"!=typeof localStorage&&localStorage.setItem(e,t)}catch{}},removeItem:e=>{try{"undefined"!=typeof localStorage&&localStorage.removeItem(e)}catch{}},clear:()=>{try{"undefined"!=typeof localStorage&&localStorage.clear()}catch{}}},L="undefined"!=typeof indexedDB?indexedDB:null;class U{constructor(e,t){this.config=e,this.checkFunction=t}async execute(){return this.checkFunction()}}const G=new class{constructor(){this.checks=new Map,this.results=new Map,this.intervals=new Map,this.isRunning=!1,this.setupDefaultChecks()}setupDefaultChecks(){this.registerCheck("message-bus",{name:"message-bus",interval:3e4,timeout:5e3,retryAttempts:2,criticalLevel:"high"},(async()=>{const e=Date.now();try{return await new Promise((e=>setTimeout(e,50))),{status:"healthy",message:"MessageBus op√©rationnel",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`MessageBus en erreur: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("storage",{name:"storage",interval:6e4,timeout:1e4,retryAttempts:3,criticalLevel:"high"},(async()=>{const e=Date.now();try{const t="health_check_test",r={timestamp:Date.now()};return"undefined"!=typeof chrome&&chrome.storage&&(await new Promise(((e,i)=>{chrome.storage.local.set({[t]:r},(()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):e()}))})),await new Promise(((e,r)=>{chrome.storage.local.get([t],(i=>{chrome.runtime.lastError?r(chrome.runtime.lastError):i&&i[t]?e():r(new Error("Failed to read test value from storage"))}))})),await new Promise(((e,r)=>{chrome.storage.local.remove(t,(()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):e()}))}))),{status:"healthy",message:"Stockage op√©rationnel",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`Stockage en erreur: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("bulkheads",{name:"bulkheads",interval:45e3,timeout:3e3,retryAttempts:1,criticalLevel:"medium"},(async()=>{const e=Date.now();try{const t=O.getHealthStatus(),r=Object.entries(t).filter((([,e])=>"failed"===e));return r.length>0?{status:"warning",message:`Bulkheads d√©grad√©s: ${r.map((([e])=>e)).join(", ")}`,responseTime:Date.now()-e,timestamp:Date.now(),details:{healthStatus:t}}:{status:"healthy",message:"Tous les bulkheads op√©rationnels",responseTime:Date.now()-e,timestamp:Date.now(),details:{healthStatus:t}}}catch(t){return{status:"warning",message:`Erreur check bulkheads: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("security",{name:"security",interval:12e4,timeout:5e3,retryAttempts:2,criticalLevel:"high"},(async()=>{const e=Date.now();try{return"undefined"!=typeof crypto&&void 0!==crypto.subtle?{status:"healthy",message:"S√©curit√© op√©rationnelle",responseTime:Date.now()-e,timestamp:Date.now()}:{status:"critical",message:"WebCrypto API indisponible",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`Erreur s√©curit√©: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}}))}registerCheck(e,t,r){const i=new U(t,r);this.checks.set(e,i),this.isRunning&&this.startCheck(e),s.vF.info(`Health check enregistr√©: ${e}`,t)}start(){if(this.isRunning)s.vF.warn("HealthCheckManager d√©j√† d√©marr√©");else{this.isRunning=!0;for(const e of this.checks.keys())this.startCheck(e);s.vF.info("HealthCheckManager d√©marr√©",{totalChecks:this.checks.size})}}stop(){this.isRunning=!1;for(const[e,t]of this.intervals)clearInterval(t),this.intervals.delete(e);s.vF.info("HealthCheckManager arr√™t√©")}startCheck(e){const t=this.checks.get(e);if(!t)return;this.executeCheck(e);const r=setInterval((()=>{this.executeCheck(e)}),t.config.interval);this.intervals.set(e,r)}async executeCheck(e){const t=this.checks.get(e);if(!t)return;let r,i=0;for(;i<=t.config.retryAttempts;)try{const r=await Promise.race([t.execute(),new Promise(((e,r)=>setTimeout((()=>r(new Error("Timeout"))),t.config.timeout)))]),i={name:e,...r};this.results.set(e,i);const n=this.results.get(e);return void(n&&n.status===r.status||s.vF.info(`Health check ${e}: ${r.status}`,{message:r.message,responseTime:r.responseTime}))}catch(e){r=e,i++,i<=t.config.retryAttempts&&await new Promise((e=>setTimeout(e,1e3*i)))}const n={name:e,status:"high"===t.config.criticalLevel?"critical":"warning",message:`Check √©chou√© apr√®s ${t.config.retryAttempts+1} tentatives: ${r}`,responseTime:t.config.timeout,timestamp:Date.now()};this.results.set(e,n),s.vF.error(`Health check ${e} √©chou√© d√©finitivement`,n)}getSystemHealth(){const e=Array.from(this.results.values()),t=e.length,r=e.filter((e=>"healthy"===e.status)).length,i=e.filter((e=>"critical"===e.status)).length;let n="unknown";return n=0===t?"unknown":i>0?"critical":r===t?"healthy":"degraded",{overallStatus:n,checks:e,lastUpdate:Date.now(),totalChecks:t,healthyChecks:r,criticalChecks:i}}getCheckResult(e){return this.results.get(e)||null}async forceCheck(e){return await this.executeCheck(e),this.getCheckResult(e)}},$=new class{constructor(){this.memoryCache=new Map,this.persistentStorage=chrome.storage?.local,this.indexedDB=null,this.emergencyLocalStorage=P,this.indexedDBReady=this.setupMultiLayerStorage(),this.setupDataReplication(),this.setupIntegrityMonitoring()}async store(e,t){if(e.includes("symbiont_health_alert_"))s.vF.info("[HybridStorageManager] Skipping health alert storage to prevent quota issues");else{s.vF.info("[HybridStorageManager] store - M√©moire",{key:e,data:t}),this.memoryCache.set(e,t);try{await new Promise(((r,i)=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?chrome.runtime.lastError.message?.includes("quota")?(s.vF.warn("[HybridStorageManager] Chrome storage quota exceeded, cleaning old data"),this.cleanOldStorageData().then((()=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):r(!0)}))})).catch(i)):i(chrome.runtime.lastError):r(!0)}))})),s.vF.info("[HybridStorageManager] store - chrome.storage.local OK",e)}catch(t){s.vF.warn("[HybridStorageManager] store - chrome.storage.local failed, fallback IndexedDB",{key:e,error:String(t)})}try{if(await this.indexedDBReady,!this.indexedDB)throw new Error("IndexedDB not ready");await new Promise(((r,i)=>{const n=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(t,e);n.onsuccess=()=>r(!0),n.onerror=()=>i(n.error)})),s.vF.info("[HybridStorageManager] store - IndexedDB OK",e)}catch(r){s.vF.warn("[HybridStorageManager] store - IndexedDB failed, fallback localStorage",{key:e,error:String(r)}),await this.emergencyLocalStorage.setItem(e,JSON.stringify(t)),s.vF.info("[HybridStorageManager] store - localStorage d'urgence OK",e)}}}async retrieve(e){if(this.memoryCache.has(e))return s.vF.info("[HybridStorageManager] retrieve - M√©moire HIT",e),this.memoryCache.get(e);try{const t=await new Promise(((t,r)=>{this.persistentStorage.get([e],(i=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t(i[e])}))}));if(void 0!==t)return this.memoryCache.set(e,t),s.vF.info("[HybridStorageManager] retrieve - chrome.storage.local OK",e),t}catch(t){s.vF.warn("[HybridStorageManager] retrieve - chrome.storage.local failed",{key:e,error:String(t)})}try{if(await this.indexedDBReady,this.indexedDB){const t=await new Promise(((t,r)=>{const i=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(e);i.onsuccess=()=>t(i.result),i.onerror=()=>r(i.error)}));if(void 0!==t)return this.memoryCache.set(e,t),s.vF.info("[HybridStorageManager] retrieve - IndexedDB OK",e),t}}catch(t){s.vF.warn("[HybridStorageManager] retrieve - IndexedDB failed",{key:e,error:String(t)})}try{const t=await this.emergencyLocalStorage.getItem(e);if(t)return s.vF.info("[HybridStorageManager] retrieve - localStorage d'urgence OK",e),JSON.parse(t)}catch(t){s.vF.warn("[HybridStorageManager] retrieve - localStorage d'urgence failed",{key:e,error:String(t)})}return null}setupMultiLayerStorage(){return new Promise((e=>{let t=!1;const r=setTimeout((()=>{t||(s.vF.warn("[HybridStorageManager] IndexedDB init timeout (5s), fallback only"),this.indexedDB=null,t=!0,e(!1))}),5e3);try{const i=L?.open("symbiont-db",1);if(!i)throw new Error("IndexedDB not available");i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("symbiont")||t.createObjectStore("symbiont")},i.onsuccess=()=>{this.indexedDB=i.result,t||(clearTimeout(r),t=!0,s.vF.info("[HybridStorageManager] IndexedDB ready"),e(!0))},i.onerror=()=>{this.indexedDB=null,t||(clearTimeout(r),t=!0,s.vF.warn("[HybridStorageManager] IndexedDB failed to open"),e(!1))}}catch(i){this.indexedDB=null,t||(clearTimeout(r),t=!0,s.vF.warn("[HybridStorageManager] IndexedDB exception",i),e(!1))}}))}async cleanOldStorageData(){try{const e=(await new Promise(((e,t)=>{this.persistentStorage.get(null,(r=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(Object.keys(r))}))}))).filter((e=>e.includes("symbiont_health_alert_")||e.includes("broadcast_")||e.includes("_temp_")));e.length>0&&(await new Promise(((t,r)=>{this.persistentStorage.remove(e,(()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t()}))})),s.vF.info(`[HybridStorageManager] Cleaned ${e.length} old storage items`))}catch(e){s.vF.error("[HybridStorageManager] Failed to clean old storage data:",e)}}isIndexedDBReady(){return!!this.indexedDB}async syncData(){}async syncKeyAcrossLayers(e,t){this.memoryCache.set(e,t);try{await new Promise(((r,i)=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):r(!0)}))}))}catch(e){console.warn("Storage operation failed:",e)}try{await this.indexedDBReady,this.indexedDB&&await new Promise(((r,i)=>{const n=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(t,e);n.onsuccess=()=>r(!0),n.onerror=()=>i(n.error)}))}catch(e){console.warn("Storage operation failed:",e)}try{await this.emergencyLocalStorage.setItem(e,JSON.stringify(t))}catch(e){console.warn("Storage operation failed:",e)}}setupDataReplication(){chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener(((e,t)=>{if("local"===t)for(const t in e){const{newValue:r}=e[t];this.syncKeyAcrossLayers(t,r),s.vF.info("[HybridStorageManager] DataReplication - Synchronisation des couches",t)}}))}setupIntegrityMonitoring(){setInterval((async()=>{for(const e of this.memoryCache.keys())try{const t=this.memoryCache.get(e),r=await new Promise((t=>{this.persistentStorage.get([e],(r=>t(r[e])))}));let i;await this.indexedDBReady,this.indexedDB&&(i=await new Promise((t=>{const r=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(e);r.onsuccess=()=>t(r.result),r.onerror=()=>t(void 0)})));const n=await this.emergencyLocalStorage.getItem(e),a=[t,r,i,n?JSON.parse(n):void 0].filter((e=>void 0!==e));if(!a.every((e=>JSON.stringify(e)===JSON.stringify(a[0])))){s.vF.warn("[HybridStorageManager] IntegrityMonitoring - Divergence d√©tect√©e pour",e);const t={};for(const e of a){const r=JSON.stringify(e);t[r]=(t[r]||0)+1}const[r]=Object.entries(t).sort(((e,t)=>t[1]-e[1]))[0],i=JSON.parse(r);if(this.memoryCache.set(e,i),this.persistentStorage.set({[e]:i}),this.indexedDB){this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(i,e)}this.emergencyLocalStorage.setItem(e,JSON.stringify(i)),s.vF.info("[HybridStorageManager] IntegrityMonitoring - Auto-r√©paration appliqu√©e pour",e)}}catch(t){s.vF.warn("[HybridStorageManager] IntegrityMonitoring - Erreur sur",{key:e,error:String(t)})}}),6e4)}},z=new class{constructor(){this.connectionState="offline",this.messageQueue=new B,this.failureStrategies=new Map,this.circuitBreaker=new k,this.failureQueue=[],this.isConnected=!1,this.connectionAttempts=0,this.setupFailureStrategies()}setupFailureStrategies(){this.failureStrategies.set("ORGANISM_UPDATE",{maxRetries:3,backoffStrategy:"exponential",fallbackAction:this.cacheOrganismState,criticalLevel:"high"}),this.failureStrategies.set("INTERACTION_DETECTED",{maxRetries:5,backoffStrategy:"linear",fallbackAction:this.queueForLaterSync,criticalLevel:"medium"}),this.failureStrategies.set("PAGE_ANALYSIS_COMPLETE",{maxRetries:2,backoffStrategy:"immediate",fallbackAction:this.processLocally,criticalLevel:"low"})}async send(e){if(this.circuitBreaker.isOpen())return await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:"Circuit breaker open"};let t=0;const r=this.failureStrategies.get(e.type),i=r?.maxRetries||2;for(;t<=i;)try{return await this.simulateSend(e),this.circuitBreaker.recordSuccess(),{success:!0}}catch(n){if(this.circuitBreaker.recordFailure(),t++,t>i)return r&&await r.fallbackAction.call(this,e),await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:n};await this.wait(this.getBackoff(r?.backoffStrategy,t))}return{success:!1,queued:!0,error:"Unknown error"}}async simulateSend(e){return{success:!0,id:`sim_${Date.now()}`}}getBackoff(e="immediate",t){return"exponential"===e?500*Math.pow(2,t):"linear"===e?500*t:0}wait(e){return new Promise((t=>setTimeout(t,e)))}async cacheOrganismState(e){s.vF.info("[ResilientMessageBus] fallback cacheOrganismState",e),await N.setItem("symbiont_organism_cache",JSON.stringify(e))}async queueForLaterSync(e){s.vF.info("[ResilientMessageBus] fallback queueForLaterSync",e),await this.messageQueue.enqueue(e)}async processLocally(e){s.vF.info("[ResilientMessageBus] fallback processLocally",e),await N.setItem("symbiont_local_processing",JSON.stringify(e))}_attemptConnection(){return Promise.resolve(!0)}_processMessage(e){}};async function V(e){return await $.retrieve(e)}async function H(e,t){await $.store(e,t)}new class{constructor(e){this.metrics={cpu:[],memory:[],latency:[],errors:0},this.alertCallback=null,this.lastAlerts=new Map,this.alertCooldown=3e4,e&&(this.alertCallback=e),this.setupMonitoring()}setupMonitoring(){setInterval((()=>{this.collectMetrics(),this.checkHealth()}),3e4)}collectMetrics(){const e=.2*d.Dm.random(),t=20*d.Dm.random(),r=5*d.Dm.random();this.metrics.cpu.push(e),this.metrics.memory.push(t),this.metrics.latency.push(r),this.metrics.cpu.length>20&&this.metrics.cpu.shift(),this.metrics.memory.length>20&&this.metrics.memory.shift(),this.metrics.latency.length>20&&this.metrics.latency.shift()}checkHealth(){const e=e=>e.reduce(((e,t)=>e+t),0)/(e.length||1),t=e(this.metrics.cpu),r=e(this.metrics.memory),i=e(this.metrics.latency);t>.5&&this.alert("CPU √©lev√© : "+t.toFixed(3)),r>50&&this.alert("M√©moire √©lev√©e : "+r.toFixed(2)+"MB"),i>10&&this.alert("Latence √©lev√©e : "+i.toFixed(2)+"ms"),this.metrics.errors>5&&this.alert("Erreurs d√©tect√©es : "+this.metrics.errors)}logError(){this.metrics.errors++}alert(e){const t=e.split(":")[0],r=Date.now(),i=this.lastAlerts.get(t);(!i||r-i>this.alertCooldown)&&(s.vF.warn("üõë [HealthMonitor]",e),this.lastAlerts.set(t,r),this.alertCallback&&this.alertCallback(e))}}((async e=>{await $.store("symbiont_health_alert_"+Date.now(),{msg:e,timestamp:Date.now()})})),(async()=>{const e={type:"ORGANISM_UPDATE",payload:{state:{id:"demo",traits:{focus:1}},timestamp:Date.now()}};(await z.send(e)).success||s.vF.warn("Message ORGANISM_UPDATE fallback, voir la queue persistante.")})();let q=null;class j{constructor(){this.storage=null,this.debouncer=null,this.organism=null,this.invitationService=null,this.activated=!1,this.events=[],this.collectiveThresholds=[10,50,100,250,500],this.reachedThresholds=[],this.security=new x,this.initialized=!1,this.messageBus=new u("background"),this.murmureService=new A,this._organismFactory=new F,s.vF.info("[BackgroundService] Instance cr√©√©e - en attente d'initialisation")}async ensureInitialized(){if(this.initialized)return;s.vF.info("[BackgroundService] D√©marrage de l'initialisation lazy");const e=await V("symbiont_collective_thresholds");this.reachedThresholds=e?JSON.parse(e):[],await this.initialize(),this.initialized=!0}async initialize(){let e=!1;try{s.vF.info("[BackgroundService] Initializing IndexedDBCoordinator...");try{this.storage=await y.getInstance(),this.debouncer=p.getInstance(),await this.debouncer.setCoordinator(this.storage),this.invitationService=new w(this.storage),e=!0,s.vF.info("[BackgroundService] Storage and debouncer initialized successfully")}catch(t){const r={errorType:t instanceof Error?t.constructor.name:typeof t,errorMessage:t instanceof Error?t.message:String(t),errorStack:t instanceof Error?t.stack:void 0,timestamp:Date.now()};s.vF.error("CRITICAL: Storage initialization failed, entering degraded mode",r);try{await $.store("symbiont_init_error_"+Date.now(),r)}catch(e){s.vF.error("Failed to log error to hybrid storage:",e)}"undefined"!=typeof chrome&&chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"SYMBIONT Storage Error",message:"Failed to initialize storage. Running in limited mode.",priority:2}),this.organism=null,e=!1}if(this.activated="true"===await V("symbiont_activated"),this.activated&&e)try{s.vF.info("Loading organism from storage..."),this.organism=await this.storage.getOrganism(),this.organism?s.vF.info("Organism loaded successfully",{id:this.organism.id}):(s.vF.info("No organism found, creating new one..."),this.organism=this.createNewOrganism(),await this.debouncer.saveOrganism(this.organism),s.vF.info("New organism created and saved"))}catch(e){s.vF.error("Failed to load/create organism:",e),this.organism=this.createNewOrganism(),s.vF.warn("Created organism in memory only (storage unavailable)")}else this.activated&&!e?(this.organism=this.createNewOrganism(),s.vF.warn("Storage unavailable - organism created in memory only")):(this.organism=null,s.vF.info("Symbiont not activated, skipping organism creation"));this.setupMessageHandlers(e),this.startPeriodicTasks(e),G.start(),s.vF.info("Background service initialized",{healthCheckActive:!0,bulkheadManagerActive:!0,organismLoaded:!!this.organism,activated:this.activated})}catch(e){s.vF.error("Failed to initialize background service:",e);try{this.setupMessageHandlers()}catch(e){s.vF.error("Failed to setup message handlers:",e)}}}createNewOrganism(){const e=this.generateVisualDNA();return{id:(0,n.lk)(),generation:1,health:100,energy:100,traits:{curiosity:100*d.Dm.random(),focus:100*d.Dm.random(),rhythm:100*d.Dm.random(),empathy:100*d.Dm.random(),creativity:100*d.Dm.random(),resilience:100*d.Dm.random(),adaptability:100*d.Dm.random(),memory:100*d.Dm.random(),intuition:100*d.Dm.random()},visualDNA:e,lastMutation:Date.now(),mutations:[],createdAt:Date.now(),dna:e,birthTime:Date.now(),socialConnections:[],memoryFragments:[]}}generateVisualDNA(){let e="";for(let t=0;t<64;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*d.Dm.random()));return e}isStorageReady(){return null!==this.storage&&null!==this.debouncer}setupMessageHandlers(t=!1){this.messageBus.on(e.GET_ORGANISM,(async t=>{if(s.vF.info("[BackgroundService] GET_ORGANISM request received"),this.organism)await z.send({type:e.ORGANISM_UPDATE,payload:{state:this.organism,mutations:this.isStorageReady()?await this.storage.getRecentMutations(5):[]}}),s.vF.info("[BackgroundService] Organism sent to popup");else if(s.vF.info("[BackgroundService] No organism available, attempting to create one"),this.isStorageReady())try{this.organism=await this.storage.getOrganism(),this.organism||(this.organism=this.createNewOrganism(),await this.debouncer.saveOrganism(this.organism),s.vF.info("[BackgroundService] New organism created on GET_ORGANISM request")),await z.send({type:e.ORGANISM_UPDATE,payload:{state:this.organism,mutations:[]}})}catch(t){s.vF.error("[BackgroundService] Failed to handle GET_ORGANISM:",t),this.organism=this.createNewOrganism(),await z.send({type:e.ORGANISM_UPDATE,payload:{state:this.organism,mutations:[]}})}else this.organism=this.createNewOrganism(),await z.send({type:e.ORGANISM_UPDATE,payload:{state:this.organism,mutations:[]}}),s.vF.warn("[BackgroundService] Sent temporary organism (storage not ready)")})),this.messageBus.on(e.PAGE_VISIT,(async e=>{const{url:t,title:r}=e.payload;if(this.isStorageReady())try{const e=await this.storage.getBehavior(t)||{url:t,visitCount:0,totalTime:0,scrollDepth:0,lastVisit:Date.now(),interactions:[]};e.visitCount++,e.lastVisit=Date.now(),await this.storage.saveBehavior(e)}catch(e){s.vF.error("Failed to save behavior data:",e)}this.events.push({type:"visit",timestamp:Date.now(),url:t}),this.updateOrganismTraits(t,r),this.analyzeContextualPatterns()})),this.messageBus.on(e.SCROLL_EVENT,(async e=>{const{url:t,scrollDepth:r}=e.payload;if(this.isStorageReady())try{const e=await this.storage.getBehavior(t);e&&(e.scrollDepth=Math.max(e.scrollDepth,r),await this.storage.saveBehavior(e))}catch(e){s.vF.error("Failed to update scroll depth:",e)}this.events.push({type:"scroll",timestamp:Date.now(),url:t}),this.analyzeContextualPatterns()})),this.messageBus.on(e.INTERACTION_DETECTED,(e=>{const{type:t,timestamp:r,target:i,data:n}=e.payload;this.events.push({type:t,timestamp:r,target:i,...n}),this.analyzeContextualPatterns()})),this.messageBus.on(e.GET_HEALTH_METRICS,(async t=>{try{const r={systemHealth:G.getSystemHealth(),bulkheadMetrics:O.getMetrics(),timestamp:Date.now()};t.sender&&this.messageBus.emit(e.HEALTH_METRICS_RESPONSE,{payload:r,requestId:t.requestId})}catch(e){s.vF.error("Erreur r√©cup√©ration m√©triques sant√©:",e)}})),this.messageBus.on(e.GENERATE_INVITATION,(async t=>{if(!this.isStorageReady())return s.vF.warn("Storage not initialized, cannot generate invitation"),void await z.send({type:e.INVITATION_GENERATED,payload:{error:"Database not initialized"}});try{const{donorId:r}=t.payload,i=await this.invitationService.generateInvitation(r),n={code:i.code,createdAt:i.createdAt,consumed:i.used??!1,inviter:i.donorId,...i.usedAt&&{consumedAt:i.usedAt},...i.receiverId&&{invitee:i.receiverId}};let s=n;try{s=await this.security.encryptSensitiveData(n)}catch(e){s=n}await z.send({type:e.INVITATION_GENERATED,payload:s})}catch(t){s.vF.error("Failed to generate invitation:",t),await z.send({type:e.INVITATION_GENERATED,payload:{error:t instanceof Error?t.message:"Unknown error"}})}})),this.messageBus.on(e.CONSUME_INVITATION,(async t=>{if(!this.isStorageReady())return s.vF.warn("Storage not initialized, cannot consume invitation"),void await z.send({type:e.INVITATION_CONSUMED,payload:{error:"Database not initialized"}});try{const{code:r,receiverId:i,role:n}=t.payload;if(!this.security.validateDataAccess({userId:i,resource:r,role:n},"user"))return void z.send({type:e.INVITATION_CONSUMED,payload:{error:"Acc√®s refus√©."}});const s=await this.invitationService.consumeInvitation(r,i);s&&(this.activated=!0,await H("symbiont_activated","true"),this.organism||(this.organism=this.createNewOrganism(),this.isStorageReady()&&await this.debouncer.saveOrganism(this.organism))),z.send({type:e.INVITATION_CONSUMED,payload:s})}catch(t){s.vF.error("Failed to consume invitation:",t),await z.send({type:e.INVITATION_CONSUMED,payload:{error:t instanceof Error?t.message:"Unknown error"}})}})),this.messageBus.on(e.CHECK_INVITATION,(async t=>{if(!this.isStorageReady())return s.vF.warn("Storage not initialized, cannot check invitation"),void await z.send({type:e.INVITATION_CHECKED,payload:{code:t.payload?.code,valid:!1,error:"Database not initialized"}});try{const{code:r}=t.payload,i=await this.invitationService.isValid(r);z.send({type:e.INVITATION_CHECKED,payload:{code:r,valid:i}})}catch(r){s.vF.error("Failed to check invitation:",r),await z.send({type:e.INVITATION_CHECKED,payload:{code:t.payload?.code,valid:!1,error:r instanceof Error?r.message:"Unknown error"}})}})),this.messageBus.on(e.GET_INVITER,(async t=>{if(!this.isStorageReady())return s.vF.warn("Storage not initialized, cannot get inviter"),void await z.send({type:e.INVITER_RESULT,payload:null});try{const{userId:r}=t.payload,i=(await this.invitationService.getAllInvitations()).find((e=>e.receiverId===r));z.send({type:e.INVITER_RESULT,payload:i||null})}catch(t){s.vF.error("Failed to get inviter:",t),await z.send({type:e.INVITER_RESULT,payload:null})}})),this.messageBus.on(e.GET_INVITEES,(async t=>{if(!this.isStorageReady())return s.vF.warn("Storage not initialized, cannot get invitees"),void await z.send({type:e.INVITEES_RESULT,payload:[]});try{const{userId:r}=t.payload,i=(await this.invitationService.getAllInvitations()).filter((e=>e.donorId===r));z.send({type:e.INVITEES_RESULT,payload:i})}catch(t){s.vF.error("Failed to get invitees:",t),await z.send({type:e.INVITEES_RESULT,payload:[]})}})),this.messageBus.on(e.GET_INVITATION_HISTORY,(async t=>{if(!this.isStorageReady())return s.vF.warn("Storage not initialized, cannot get invitation history"),void await z.send({type:e.INVITATION_HISTORY_RESULT,payload:[]});try{const{userId:r}=t.payload,i=await this.invitationService.getAllInvitations(),n=[...i.filter((e=>e.receiverId===r)).map((e=>({...e,type:"re√ßue"}))),...i.filter((e=>e.donorId===r)).map((e=>({...e,type:"envoy√©e"})))];z.send({type:e.INVITATION_HISTORY_RESULT,payload:n})}catch(t){s.vF.error("Failed to get invitation history:",t),await z.send({type:e.INVITATION_HISTORY_RESULT,payload:[]})}}));const r=new Map;this.messageBus.on(e.REQUEST_SHARED_MUTATION,(t=>{const{initiatorId:i,traits:n}=t.payload,s=d.Dm.random().toString(36).substr(2,6).toUpperCase(),a=Date.now()+3e5;r.set(s,{initiatorId:i,traits:n,expiresAt:a}),z.send({type:e.SHARED_MUTATION_CODE,payload:{code:s,initiatorId:i,expiresAt:a}})})),this.messageBus.on(e.ACCEPT_SHARED_MUTATION,(async t=>{const{code:i,receiverId:n,traits:s,role:a}=t.payload;if(!this.security.validateDataAccess({userId:n,resource:i,role:a},"user"))return void z.send({type:e.SHARED_MUTATION_RESULT,payload:{error:"Acc√®s refus√©."}});const o=r.get(i);if(!o||o.expiresAt<Date.now())return void z.send({type:e.SHARED_MUTATION_RESULT,payload:{error:"Code expir√© ou invalide."}});const c={...o.traits};for(const e of Object.keys(s))c[e]=(c[e]??0+s[e]??0)/2;r.delete(i);let h={initiatorId:o.initiatorId,receiverId:n,mergedTraits:c,timestamp:Date.now()};try{h=await this.security.encryptSensitiveData(h)}catch(e){}z.send({type:e.SHARED_MUTATION_RESULT,payload:h})}));const i=new Set;let n=null;this.messageBus.on(e.COLLECTIVE_WAKE_REQUEST,(t=>{const{userId:r}=t.payload;i.add(r),n||(n=setTimeout((()=>{z.send({type:e.COLLECTIVE_WAKE_RESULT,payload:{participants:Array.from(i),triggeredAt:Date.now()}}),i.clear(),n=null}),1e4))}));const a=async t=>{const r={code:"TEMP_CODE",donorId:await V("symbiont_user_id")||"unknown",symbolicLink:"",used:!1,createdAt:Date.now()};await z.send({type:e.CONTEXTUAL_INVITATION,payload:{invitation:r,context:t}})},o=this.generateMutation.bind(this);this.generateMutation=()=>{const e=o();return"cognitive"===e.type&&a("mutation_cognitive"),e};const c=this.updateOrganismTraits.bind(this);this.updateOrganismTraits=async(e,t)=>{await c(e,t),this.organism&&this.organism.traits.curiosity>90&&await a("curiosity_threshold")};let h=Date.now();chrome.idle.onStateChanged.addListener((e=>{"idle"===e?h=Date.now():"active"===e&&Date.now()-h>18e5&&a("long_inactivity")}));const l=["SYMBIOSE","AWAKEN","ECHO"];this.messageBus.on(e.SECRET_CODE_ENTERED,(t=>{const{code:r}=t.payload;l.includes(r.toUpperCase())&&z.send({type:e.SECRET_RITUAL_TRIGGERED,payload:{code:r,effect:"mutation_unique",timestamp:Date.now()}})}))}async updateOrganismTraits(t,r){if(!this.organism)return;const i=t.toLowerCase(),n=r.toLowerCase();(i.includes("github")||i.includes("stackoverflow")||i.includes("codepen")||i.includes("dribbble"))&&(this.organism.traits.creativity+=.5),(i.includes("docs")||i.includes("wiki")||i.includes("tutorial")||n.includes("guide"))&&(this.organism.traits.focus+=.3),(i.includes("twitter")||i.includes("linkedin")||i.includes("facebook")||i.includes("reddit"))&&(this.organism.traits.empathy+=.4);const a=new URL(t).hostname;if(!await this.hasVisitedDomain(a)&&(this.organism.traits.curiosity+=1),!this.organism)return;const o=this.organism.traits;if(!o)return;if(Object.keys(o).forEach((e=>{o[e]=Math.max(0,Math.min(100,o[e]))})),await this.checkForMutations(),this.isStorageReady())try{await this.debouncer.saveOrganism(this.organism)}catch(e){s.vF.error("Failed to save organism:",e)}let c="default";if(await this.isLoop(t)?c="loop":await this.isIdle()?c="idle":await this.isExploration(t)?c="exploration":await this.isRoutine(t)&&(c="routine"),!this.organism)return;const h=this.organism;await z.send({type:e.ORGANISM_UPDATE,payload:{state:h,mutations:await this.storage.getRecentMutations(5)}});const l=this.murmureService.generateMurmur(c);await z.send({type:e.MURMUR,payload:{text:l,pattern:c,timestamp:Date.now()}})}async hasVisitedDomain(e){return(await chrome.tabs.query({})).some((t=>t.url&&new URL(t.url).hostname===e))}async checkForMutations(){if(!this.organism)return;const e=this.organism,t=Date.now(),r=t-(e.lastMutation??0),i=Math.min(.5,r/36e5);if(d.Dm.random()<i){const r=this.generateMutation();if(this.isStorageReady())try{await this.storage.addMutation(r)}catch(e){s.vF.error("Failed to save mutation:",e)}e.lastMutation=t,this.applyMutation(r)}}generateMutation(){const e=["visual","behavioral","cognitive"],t=e[Math.floor(d.Dm.random()*e.length)];return{type:t,trigger:this.getMutationTrigger(t),magnitude:.5*d.Dm.random()+.1,timestamp:Date.now()}}getMutationTrigger(e){const t={visual:["color_shift","pattern_change","size_fluctuation","opacity_variation"],behavioral:["navigation_speed","content_preference","interaction_pattern"],cognitive:["memory_retention","pattern_recognition","association_strength"]}[e];return t[Math.floor(d.Dm.random()*t.length)]}applyMutation(e){if(this.organism)switch(e.type){case"visual":this.organism.visualDNA=this.mutateVisualDNA(this.organism.visualDNA??"",e.magnitude);break;case"behavioral":{const t=Object.keys(this.organism.traits),r=t[Math.floor(d.Dm.random()*t.length)];this.organism.traits[r]+=(d.Dm.random()-.5)*e.magnitude*20;break}case"cognitive":{if(!this.organism)return;const t=this.organism.traits;if(!t)return;Object.keys(t).forEach((r=>{t[r]+=(d.Dm.random()-.5)*e.magnitude*5}));break}}}mutateVisualDNA(e,t){const r=Math.floor(e.length*t),i=e.split("");for(let t=0;t<r;t++)i[Math.floor(d.Dm.random()*e.length)]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*d.Dm.random()));return i.join("")}startPeriodicTasks(t=!1){setInterval((()=>{this.organism&&(this.organism.health??0)>0&&(this.organism.health=Math.max(0,(this.organism.health??0)-.5),this.organism.energy=Math.max(0,(this.organism.energy??0)-.25))}),3e5),setInterval((async()=>{if(this.organism&&this.isStorageReady())try{await this.debouncer.saveOrganism(this.organism);const t=await this.storage.getRecentMutations(5);await z.send({type:e.ORGANISM_UPDATE,payload:{state:this.organism,mutations:t}}),s.vF.debug("[BackgroundService] Periodic sync completed")}catch(e){s.vF.error("Failed to perform periodic sync:",e)}}),3e5)}async isLoop(e){if(!this.isStorageReady())return!1;try{const t=await this.storage.getBehavior(e);return!!t&&t.visitCount>=3}catch(e){return s.vF.error("Failed to check loop pattern:",e),!1}}async isIdle(){return!1}async isExploration(e){if(!this.isStorageReady())return!1;try{const t=await this.storage.getBehavior(e);return!!t&&t.visitCount<=1}catch(e){return s.vF.error("Failed to check exploration pattern:",e),!1}}async isRoutine(e){if(!this.isStorageReady())return!1;try{const t=await this.storage.getBehavior(e);return!!t&&Date.now()-t.lastVisit<1728e5}catch(e){return s.vF.error("Failed to check routine pattern:",e),!1}}async analyzeContextualPatterns(){const e=Date.now();this.events=this.events.filter((t=>e-t.timestamp<18e5)),R.detectBurst(this.events,1e4,5).length>0?this.triggerContextualInvitation("burst_activity"):R.detectTemporalPattern(this.events,6e4,.15).length>0?this.triggerContextualInvitation("temporal_cycle"):R.detectAlternance(this.events,"visit","scroll",6).length>0?this.triggerContextualInvitation("alternance_nav_scroll"):R.detectRepetition(this.events,7).length>0?this.triggerContextualInvitation("repetition_action"):this.checkCollectiveThreshold()}async checkCollectiveThreshold(){if(this.isStorageReady())try{const e=(await this.invitationService.getAllInvitations()).length;for(const t of this.collectiveThresholds)if(e>=t&&!this.reachedThresholds.includes(t)){this.reachedThresholds.push(t),await H("symbiont_collective_thresholds",JSON.stringify(this.reachedThresholds)),await this.triggerContextualInvitation("collective_threshold_"+t);break}}catch(e){s.vF.error("Failed to check collective threshold:",e)}else s.vF.debug("Storage not ready, skipping collective threshold check")}async triggerContextualInvitation(t){if(this.isStorageReady())try{const r=await V("symbiont_user_id")||"unknown",i=await this.invitationService.generateInvitation(r);await z.send({type:e.CONTEXTUAL_INVITATION,payload:{invitation:i,context:t}})}catch(e){s.vF.error("Failed to generate contextual invitation:",e)}else s.vF.warn("Storage not initialized, skipping contextual invitation generation",{context:t})}dispose(){try{G.stop(),this.events=[],s.vF.info("BackgroundService disposed successfully")}catch(e){s.vF.error("Erreur lors du dispose du BackgroundService:",e)}}}async function W(){return q||(s.vF.info("[Background] Lazy initialization triggered - creating BackgroundService"),q=new j,await q.ensureInitialized(),globalThis._backgroundService=q),q}"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage?(chrome.runtime.onMessage.addListener(((e,t,r)=>(W().then((e=>{s.vF.debug("[Background] Service initialized via lazy loading")})).catch((e=>{s.vF.error("[Background] Failed to initialize service on message:",e)})),!1))),setTimeout((()=>{s.vF.info("[Background] Proactive initialization starting..."),W().then((e=>{s.vF.info("[Background] Service initialized proactively",{hasOrganism:!!e.organism,organismId:e.organism?.id})})).catch((e=>{s.vF.error("[Background] Failed to initialize service proactively:",e)}))}),500),s.vF.info("[Background] Lazy initialization listener registered + proactive init scheduled")):s.vF.warn("[Background] Chrome runtime not available - service will not auto-initialize")})();