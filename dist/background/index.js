(()=>{"use strict";var e,t={18:(e,t,r)=>{r.d(t,{Dm:()=>s});var i=r(513);class s{static random(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/(this.MAX_UINT32+1)}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random numbers.");throw i.vF.error("SecureRandom: CRITICAL SECURITY FAILURE",e),e}static randomInt(e,t){if(e>=t)throw new Error("SecureRandom: min doit √™tre inf√©rieur √† max");const r=t-e;return Math.floor(this.random()*r)+e}static randomFloat(e,t){if(e>=t)throw new Error("SecureRandom: min doit √™tre inf√©rieur √† max");return this.random()*(t-e)+e}static randomBytes(e){if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}const t=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random bytes.");throw i.vF.error("SecureRandom: CRITICAL SECURITY FAILURE in randomBytes",t),t}static choice(e){if(0===e.length)throw new Error("SecureRandom: Le tableau ne peut pas √™tre vide");return e[this.randomInt(0,e.length)]}static uuid(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20,32)].join("-")}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure UUID.");throw i.vF.error("SecureRandom: CRITICAL SECURITY FAILURE in uuid",e),e}static randomString(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r="";for(let i=0;i<e;i++)r+=t.charAt(this.randomInt(0,t.length));return r}static randomId(e="",t=8){const r=this.randomString(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return e?`${e}_${r}`:r}}s.MAX_UINT32=4294967295,s.random,s.randomInt,s.randomFloat},194:(e,t,r)=>{r.r(t),r.d(t,{NeuralMesh:()=>n});var i=r(849),s=r(513);class n{constructor(){this.nodes=new Map,this.connections=new Map,this.activations=new Map,this.learningRate=.01}addNode(e,t,r=0){const i={type:t,activation:0,bias:r};this.nodes.set(e,i),this.activations.set(e,0)}addConnection(e,t,r){if(!this.nodes.has(e)||!this.nodes.has(t))throw new Error(`Cannot connect non-existent nodes: ${e} -> ${t}`);this.connections.has(e)||this.connections.set(e,new Map),this.connections.get(e).set(t,r)}stimulate(e,t){const r=this.nodes.get(e);r&&"input"===r.type?this.activations.set(e,t):s.vF.warn(`Cannot stimulate non-input node: ${e}`)}propagate(){for(const[e,t]of this.nodes)if("input"!==t.type){const r=Number.isFinite(t.bias)?t.bias:0;this.activations.set(e,r)}for(const[e,t]of this.connections){const r=this.activations.get(e)||0;if(Number.isFinite(r))for(const[i,n]of t){if(!Number.isFinite(n)){s.vF.warn(`NeuralMesh: Invalid weight from ${e} to ${i}: ${n}, skipping connection`);continue}const t=this.activations.get(i)||0;if(!Number.isFinite(t)){s.vF.warn(`NeuralMesh: Invalid current activation for node ${i}: ${t}, resetting to 0`),this.activations.set(i,0);continue}const a=r*n;if(!Number.isFinite(a)){s.vF.warn(`NeuralMesh: Invalid weighted input from ${e} to ${i}, skipping`);continue}const o=t+a;if(!Number.isFinite(o)){s.vF.warn(`NeuralMesh: Invalid new activation for node ${i}: ${o}, using current`);continue}const c=this.sigmoid(o);this.activations.set(i,c)}else s.vF.warn(`NeuralMesh: Invalid activation from node ${e}: ${r}, skipping`)}for(const[e,t]of this.activations)Number.isFinite(t)||(s.vF.error(`NeuralMesh: CRITICAL - Node ${e} has invalid activation ${t}, resetting to 0`),this.activations.set(e,0))}sigmoid(e){if(!Number.isFinite(e))return s.vF.warn(`NeuralMesh: Invalid sigmoid input: ${e}, using 0.5 as fallback`),.5;const t=Math.max(-500,Math.min(500,e));try{const r=1/(1+Math.exp(-t));return Number.isFinite(r)?r:(s.vF.warn(`NeuralMesh: Invalid sigmoid output for input ${e}, using 0.5 as fallback`),.5)}catch(t){return s.vF.error("NeuralMesh: Sigmoid computation error",{input:e,error:t}),.5}}getActivation(e){return this.activations.get(e)||0}mutate(e=.05){for(const t of this.connections.values())for(const[r,s]of t)i.tm.random()<e&&(t.set(r,s+.2*(i.tm.random()-.5)),t.set(r,Math.max(-2,Math.min(2,t.get(r)||0))));for(const t of this.nodes.values())i.tm.random()<e&&(t.bias+=.1*(i.tm.random()-.5),t.bias=Math.max(-1,Math.min(1,t.bias)))}getNeuralActivity(){let e=0,t=0;for(const r of this.activations.values())e+=Math.abs(r),t++;return t>0?e/t:0}getConnectionStrength(){let e=0,t=0;for(const r of this.connections.values())for(const i of r.values())e+=Math.abs(i),t++;return t>0?e/t:0}toJSON(){return{nodes:Array.from(this.nodes.values()),connections:Array.from(this.connections.values()).map((e=>Array.from(e.entries()))),activations:Object.fromEntries(this.activations)}}async initialize(){0===this.nodes.size&&this.setupDefaultNetwork(),this.propagate()}setupDefaultNetwork(){this.addNode("sensory_input","input"),this.addNode("memory_input","input"),this.addNode("processing_1","hidden",.1),this.addNode("processing_2","hidden",-.1),this.addNode("motor_output","output"),this.addNode("emotion_output","output"),this.addConnection("sensory_input","processing_1",.8),this.addConnection("memory_input","processing_2",.6),this.addConnection("processing_1","motor_output",.9),this.addConnection("processing_2","emotion_output",.7),this.addConnection("processing_1","processing_2",.3)}async suspend(){this.activations.clear(),s.vF.info("Neural mesh suspended")}async getCPUUsage(){const e=this.nodes.size*this.connections.size;return Math.min(1,e/1e3)}async getMemoryUsage(){const e=64*(this.nodes.size+this.connections.size);return Math.min(1,e/1048576)}saveState(){return{nodes:Object.fromEntries(this.nodes),connections:Object.fromEntries(Array.from(this.connections.entries()).map((([e,t])=>[e,Object.fromEntries(t)]))),activations:Object.fromEntries(this.activations)}}loadState(e){if(e.nodes){this.nodes.clear();for(const[t,r]of Object.entries(e.nodes))this.nodes.set(t,r)}if(e.connections){this.connections.clear();for(const[t,r]of Object.entries(e.connections))this.connections.set(t,new Map(Object.entries(r)))}if(e.activations){this.activations.clear();for(const[t,r]of Object.entries(e.activations))this.activations.set(t,r)}}reset(){this.nodes.clear(),this.connections.clear(),this.activations.clear(),this.setupDefaultNetwork()}healthCheck(){const e=[];0===this.nodes.size&&e.push("No nodes in neural mesh"),0===this.connections.size&&e.push("No connections in neural mesh");const t=new Set;for(const[e,r]of this.connections){t.add(e);for(const e of r.keys())t.add(e)}const r=Array.from(this.nodes.keys()).filter((e=>!t.has(e)));return r.length>0&&e.push(`Orphaned nodes: ${r.join(", ")}`),{healthy:0===e.length,issues:e}}cleanup(){this.nodes.clear(),this.connections.clear(),this.activations.clear()}async processPattern(e){if(e&&"object"==typeof e){const t=Array.from(this.nodes.entries()).filter((([,e])=>"input"===e.type)).map((([e])=>e));Object.entries(e).forEach((([,e],r)=>{r<t.length&&"number"==typeof e&&this.stimulate(t[r],e)})),this.propagate();const r=Array.from(this.nodes.entries()).filter((([,e])=>"output"===e.type));return Object.fromEntries(r.map((([e])=>[e,this.getActivation(e)])))}return{}}async learn(e){if(e&&"object"==typeof e&&"feedback"in e&&"number"==typeof e.feedback){const t=.01*Math.abs(e.feedback);this.mutate(t)}}getPerformanceMetrics(){return{nodeCount:this.nodes.size,connectionCount:Array.from(this.connections.values()).reduce(((e,t)=>e+t.size),0),neuralActivity:this.getNeuralActivity(),connectionStrength:this.getConnectionStrength()}}}},455:(e,t,r)=>{r.d(t,{lk:()=>n,wP:()=>a});var i=r(18),s=r(513);function n(){if("undefined"!=typeof crypto&&crypto.randomUUID)try{return crypto.randomUUID()}catch(e){s.vF.warn("crypto.randomUUID failed, using fallback",{error:e})}return i.Dm.uuid()}function a(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():i.Dm.uuid()}},502:(e,t,r)=>{r.r(t),r.d(t,{OrganismCore:()=>p});var i=r(513);class s{constructor(){this.errorQueue=[],this.maxQueueSize=1e3,this.logLevel="warning",this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0}}static getInstance(){return s.instance||(s.instance=new s),s.instance}setLogLevel(e){this.logLevel=e}logError(e){this.updateMetrics(e),this.addToQueue(e),this.outputError(e)}logSimpleError(e,t,r,i="error",s){const n=r instanceof Error?r.message:String(r),a={component:e,method:t,timestamp:Date.now(),severity:i,details:{message:n,context:s,originalError:r instanceof Error?{name:r.name,stack:r.stack}:void 0}};console["warning"===i?"warn":"debug"===i?"debug":"info"===i?"info":"error"](`[${e}][${t}] ${n}`,s||""),this.recordError(a)}validateRequired(e,t,r,i){const s=[];null==e&&s.push(`${t} is required`);const n={isValid:0===s.length,errors:s,warnings:[],context:{component:r,method:i,timestamp:Date.now(),severity:s.length>0?"error":"info"}};return n.isValid||this.logError(n.context),n}validateType(e,t,r={},i,s,n){const a=[];if(r.required&&null==e&&a.push(`${i} is required`),null!=e){const s=typeof e;s!==t&&a.push(`${i} must be of type ${t}, got ${s}`),"number"===t&&"number"==typeof e&&(void 0!==r.min&&e<r.min&&a.push(`${i} must be >= ${r.min}`),void 0!==r.max&&e>r.max&&a.push(`${i} must be <= ${r.max}`),Number.isFinite(e)||a.push(`${i} must be a finite number`)),"string"===t&&"string"==typeof e&&(void 0!==r.min&&e.length<r.min&&a.push(`${i} must be at least ${r.min} characters long`),void 0!==r.max&&e.length>r.max&&a.push(`${i} must be at most ${r.max} characters long`),r.pattern&&!r.pattern.test(e)&&a.push(`${i} does not match required pattern`))}const o={isValid:0===a.length,errors:a,warnings:[],context:{component:s,method:n,timestamp:Date.now(),severity:a.length>0?"error":"warning",details:{fieldName:i,expectedType:t,actualValue:e}}};return o.isValid||this.logError(o.context),o}async withRetry(e,t,r){let i=null;for(let s=1;s<=t.maxRetries;s++){this.metrics.recoveryAttempts++;try{const t=await e();return s>1&&(this.metrics.recoverySuccesses++,this.logSimpleError(r.component,r.method,`Recovery successful after ${s} attempts`,"info")),t}catch(e){if(i=e instanceof Error?e:new Error(String(e)),this.logSimpleError(r.component,r.method,`Attempt ${s}/${t.maxRetries} failed: ${i.message}`,"warning"),s<t.maxRetries&&t.shouldRetry(i,s)){await this.delay(t.backoffMs*s);continue}break}}if(this.logSimpleError(r.component,r.method,`All ${t.maxRetries} retry attempts failed. Last error: ${i?.message}`,"error"),void 0!==t.fallbackValue)return t.fallbackValue;throw i}safeExecute(e,t,r){try{return e()}catch(e){return this.logSimpleError(r.component,r.method,e,"error"),t}}async safeExecuteAsync(e,t,r){try{return await e()}catch(e){return this.logSimpleError(r.component,r.method,e,"error"),t}}getMetrics(){return{...this.metrics}}getRecentErrors(e=50){return this.errorQueue.slice(-e)}reset(){this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0},this.errorQueue=[]}updateMetrics(e){this.metrics.errorCount++,this.metrics.lastErrorTime=e.timestamp;const t=this.metrics.errorsByComponent.get(e.component)||0;this.metrics.errorsByComponent.set(e.component,t+1);const r=`${e.component}.${e.method}`,i=this.metrics.errorsByMethod.get(r)||0;this.metrics.errorsByMethod.set(r,i+1)}addToQueue(e){this.errorQueue.push(e),this.errorQueue.length>this.maxQueueSize&&(this.errorQueue=this.errorQueue.slice(-this.maxQueueSize))}outputError(e){if(!this.shouldLog(e.severity))return;const t=`[${new Date(e.timestamp).toISOString()}] ${e.severity.toUpperCase()} ${e.component}.${e.method}`;switch(e.severity){case"critical":case"error":i.vF.error(t,e.details);break;case"warning":i.vF.warn(t,e.details);break;case"info":console.info(t,e.details);break;case"debug":i.vF.debug(t,e.details)}}shouldLog(e){const t=["debug","info","warning","error","critical"],r=t.indexOf(this.logLevel);return t.indexOf(e)>=r}delay(e){return new Promise((t=>setTimeout(t,e)))}recordError(e){this.updateMetrics(e),this.addToQueue(e)}}s.instance=null;const n=s.getInstance();class a{constructor(e){this.history=[],this.listeners=[],this.traits={curiosity:.5,focus:.5,rhythm:.5,empathy:.5,creativity:.5,memory:.5,intuition:.5,resilience:.5,adaptability:.5,collaboration:.5,...e}}updateTrait(e,t,r="manual"){const i=this.traits[e],s=Math.max(0,Math.min(1,t));this.traits[e]=s,this.history.push({trait:e,value:s,timestamp:Date.now(),trigger:r});const n={traitName:e,oldValue:i,newValue:s,timestamp:Date.now()};this.listeners.forEach((e=>e(n)))}updateTraits(e,t="batch"){Object.entries(e).forEach((([e,r])=>{"number"==typeof r&&this.updateTrait(e,r,t)}))}getTrait(e){return this.traits[e]}getAllTraits(){return{...this.traits}}getTraitHistory(e){return this.history.filter((t=>t.trait===e))}getFullHistory(e=100){return this.history.slice(-e)}normalizeTraits(){Object.keys(this.traits).forEach((e=>{const t=e,r=this.traits[t];(r<0||r>1)&&this.updateTrait(t,Math.max(0,Math.min(1,r)),"normalization")}))}calculateBalance(){const e=Object.values(this.traits),t=e.reduce(((e,t)=>e+t),0)/e.length,r=e.reduce(((e,r)=>e+Math.pow(r-t,2)),0)/e.length;return Math.max(0,1-r)}addTraitChangeListener(e){this.listeners.push(e)}removeTraitChangeListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}cleanup(e=864e5){const t=Date.now()-e;this.history=this.history.filter((e=>e.timestamp>t))}toJSON(){return{traits:{...this.traits},history:[...this.history]}}fromJSON(e){this.traits={...e.traits},this.history=[...e.history]}}class o{constructor(e,t="BoundedArray"){this.items=[],this.maxSize=Math.max(1,e),this.name=t}add(e){if(this.items.push(e),this.items.length>this.maxSize){const e=this.items.splice(0,this.items.length-this.maxSize);i.vF.debug(`${this.name}: Cleaned ${e.length} old items, keeping ${this.items.length}/${this.maxSize}`)}}addBatch(e){if(this.items.push(...e),this.items.length>this.maxSize){const e=this.items.splice(0,this.items.length-this.maxSize);i.vF.debug(`${this.name}: Batch cleaned ${e.length} old items`)}}getAll(){return this.items}getRecent(e){return this.items.slice(-Math.min(e,this.items.length))}slice(e,t){return this.items.slice(e,t)}filter(e){return this.items.filter(e)}reduce(e,t){return this.items.reduce(e,t)}[Symbol.iterator](){return this.items[Symbol.iterator]()}get length(){return this.items.length}clear(){const e=this.items.length;this.items=[],i.vF.debug(`${this.name}: Cleared ${e} items`)}size(){return this.items.length}isFull(){return this.items.length>=this.maxSize}getMemoryUsage(){return{count:this.items.length,maxSize:this.maxSize,utilizationPercent:this.items.length/this.maxSize*100}}}class c{constructor(e=100,t){this.listeners=[],this.regenerationTimer=null,this.config={baseRegenRate:1,maxEnergy:100,decayRate:.1,efficiencyFactor:1,...t},this.maxEnergy=this.config.maxEnergy,this.energy=Math.min(e,this.maxEnergy),this.metabolismRate=this.config.baseRegenRate,this.history=new o(100,"EnergyHistory"),this.startMetabolism()}startMetabolism(){this.regenerationTimer||(this.regenerationTimer=setInterval((()=>{this.passiveRegeneration()}),1e3))}stopMetabolism(){this.regenerationTimer&&(clearInterval(this.regenerationTimer),this.regenerationTimer=null)}passiveRegeneration(){const e=this.metabolismRate*this.config.efficiencyFactor-this.config.decayRate;if(e>0&&this.energy<this.maxEnergy){const t=this.energy;this.energy=Math.min(this.maxEnergy,this.energy+e),this.recordEvent({type:"regeneration",amount:this.energy-t,source:"passive_metabolism",timestamp:Date.now(),energyBefore:t,energyAfter:this.energy})}else if(e<0){const t=this.energy;this.energy=Math.max(0,this.energy+e),this.recordEvent({type:"drain",amount:Math.abs(e),source:"natural_decay",timestamp:Date.now(),energyBefore:t,energyAfter:this.energy})}}consumeEnergy(e,t="unknown"){if(e<=0)return!0;if(this.energy<e)return!1;const r=this.energy;return this.energy-=e,this.recordEvent({type:"consumption",amount:e,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy}),!0}forceConsumeEnergy(e,t="forced"){const r=this.energy,i=Math.min(e,this.energy);return this.energy-=i,this.recordEvent({type:"consumption",amount:i,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy}),i}addEnergy(e,t="boost"){if(e<=0)return;const r=this.energy;this.energy=Math.min(this.maxEnergy,this.energy+e),this.recordEvent({type:"boost",amount:this.energy-r,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy})}regenerateEnergy(e){const t=e||this.metabolismRate;this.addEnergy(t,"manual_regeneration")}getEnergyLevel(){return this.energy}getEnergyPercentage(){return this.energy/this.maxEnergy*100}getMaxEnergy(){return this.maxEnergy}hasEnergy(e){return this.energy>=e}isExhausted(){return 0===this.energy}isFullEnergy(){return this.energy===this.maxEnergy}setMetabolismRate(e){this.metabolismRate=Math.max(0,e)}setEfficiency(e){this.config.efficiencyFactor=Math.max(.1,Math.min(2,e))}increaseMaxEnergy(e){this.maxEnergy+=e,this.config.maxEnergy=this.maxEnergy}recordEvent(e){this.history.add(e),this.listeners.forEach((t=>t(e)))}getEnergyHistory(e=50){return this.history.slice(-e)}getEnergyStats(){const e=this.history.filter((e=>"consumption"===e.type)),t=this.history.filter((e=>"regeneration"===e.type||"boost"===e.type)),r=e.reduce(((e,t)=>e+t.amount),0),i=t.reduce(((e,t)=>e+t.amount),0);return{current:this.energy,max:this.maxEnergy,percentage:this.getEnergyPercentage(),metabolismRate:this.metabolismRate,efficiency:this.config.efficiencyFactor,totalConsumed:r,totalRegenerated:i}}addEnergyListener(e){this.listeners.push(e)}removeEnergyListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}cleanup(e=864e5){const t=Date.now()-e,r=this.history.filter((e=>e.timestamp>t));this.history.clear(),this.history.addBatch(r)}toJSON(){return{energy:this.energy,maxEnergy:this.maxEnergy,metabolismRate:this.metabolismRate,config:{...this.config},history:[...this.history]}}fromJSON(e){this.energy=e.energy,this.maxEnergy=e.maxEnergy,this.metabolismRate=e.metabolismRate,this.config={...e.config},this.history.clear(),this.history.addBatch(e.history)}destroy(){this.stopMetabolism(),this.listeners=[],this.history.clear()}}class l{constructor(e){this.processingQueue=[],this.isProcessing=!1,this.MAX_QUEUE_SIZE=1e3,this.BATCH_SIZE=10,this.mesh=e}async processStimulus(e,t){const r=Date.now();try{const i=this.convertStimulusToPattern(e),s=this.mesh.processPattern?await this.mesh.processPattern(i):{},n=this.convertResultToTraitAdaptations(s,t),a=Date.now()-r;return{success:!0,adaptations:n,confidence:s.confidence||.8,processingTime:a}}catch(e){return i.vF.error("Erreur de traitement neural:",e),{success:!1,adaptations:{},confidence:0,processingTime:Date.now()-r}}}queuePattern(e){this.processingQueue.length>=this.MAX_QUEUE_SIZE&&(i.vF.warn("Neural processing queue at maximum capacity, dropping oldest pattern"),this.processingQueue.shift()),this.processingQueue.push(e),this.isProcessing||this.processQueue()}async processQueue(){if(!this.isProcessing&&0!==this.processingQueue.length){for(this.isProcessing=!0;this.processingQueue.length>0;){const e=Math.min(this.BATCH_SIZE,this.processingQueue.length);for(let t=0;t<e;t++){const e=this.processingQueue.shift();if(e)try{this.mesh.learn&&await this.mesh.learn(e.data)}catch(e){i.vF.error("Erreur apprentissage neural:",e)}}this.processingQueue.length>0&&await new Promise((e=>setTimeout(e,0)))}this.isProcessing=!1}}convertStimulusToPattern(e){return"object"==typeof e&&null!==e?{type:e.type||"unknown",intensity:e.intensity||.5,context:e.context||{},timestamp:Date.now()}:{type:"simple",intensity:.5,data:e,timestamp:Date.now()}}convertResultToTraitAdaptations(e,t){const r={};if(e&&"object"==typeof e&&(e.traitSuggestions&&Object.entries(e.traitSuggestions).forEach((([e,i])=>{if(e in t&&"number"==typeof i){const s=t[e],n=.1,a=Math.max(-n,Math.min(n,i-s));r[e]=s+a}})),e.activityType))switch(e.activityType){case"exploration":r.curiosity=this.adjustTrait(t.curiosity,.05),r.adaptability=this.adjustTrait(t.adaptability,.03);break;case"focus":r.focus=this.adjustTrait(t.focus,.05),r.memory=this.adjustTrait(t.memory,.02);break;case"social":r.empathy=this.adjustTrait(t.empathy,.04),r.collaboration=this.adjustTrait(t.collaboration,.04);break;case"creative":r.creativity=this.adjustTrait(t.creativity,.05),r.intuition=this.adjustTrait(t.intuition,.03)}return r}adjustTrait(e,t){return Math.max(0,Math.min(1,e+t))}async learn(e){try{return this.mesh.learn&&await this.mesh.learn(e),!0}catch(e){return i.vF.error("Erreur apprentissage:",e),!1}}getPerformanceMetrics(){try{return this.mesh.getPerformanceMetrics?this.mesh.getPerformanceMetrics():{nodeCount:0,connectionCount:0,neuralActivity:0,connectionStrength:0}}catch(e){return i.vF.error("Erreur m√©triques:",e),{processingTime:0,accuracy:0,memoryUsage:0}}}saveState(){try{return this.mesh.saveState()}catch(e){return i.vF.error("Erreur sauvegarde √©tat neural:",e),null}}loadState(e){try{return this.mesh.loadState(e),!0}catch(e){return i.vF.error("Erreur chargement √©tat neural:",e),!1}}reset(){try{this.mesh.reset(),this.processingQueue=[],this.isProcessing=!1}catch(e){i.vF.error("Erreur reset neural:",e)}}cleanup(){this.processingQueue=[],this.isProcessing=!1,"function"==typeof this.mesh.cleanup&&this.mesh.cleanup()}healthCheck(){const e=[];this.mesh||e.push("R√©seau neural non initialis√©"),this.processingQueue.length>1e3&&e.push("Queue de traitement surcharg√©e");try{this.getPerformanceMetrics().processingTime>1e3&&e.push("Temps de traitement √©lev√©")}catch{e.push("M√©triques non disponibles")}return{healthy:0===e.length,issues:e}}async initialize(){await this.mesh.initialize()}async suspend(){await this.mesh.suspend()}update(e){const t=e/16.67,r=Math.ceil(t);for(let e=0;e<r&&this.processingQueue.length>0;e++){const e=this.processingQueue.shift();e&&this.mesh.learn&&this.mesh.learn(e.data).catch((e=>{i.vF.error("Neural processing error:",e)}))}}stimulate(e,t){this.mesh.stimulate(e,t)}getNeuralActivity(){return this.mesh.getNeuralActivity()}}class h{constructor(){this.metricsCache=new Map,this.isProduction=!0}static getInstance(){return h.instance||(h.instance=new h),h.instance}async getMemoryMetrics(){try{if("memory"in performance){const e=performance.memory;return{used:e.usedJSHeapSize,total:e.totalJSHeapSize,percentage:e.usedJSHeapSize/e.jsHeapSizeLimit*100}}const e=this.estimateMemoryUsage();return{used:e,total:2*e,percentage:50}}catch(e){return i.vF.warn("Erreur collecte m√©moire, fallback estimation:",e),this.getFallbackMemoryMetrics()}}async getTimingMetrics(){try{const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint"),r=t.find((e=>"first-paint"===e.name))?.startTime||0,i=t.find((e=>"first-contentful-paint"===e.name))?.startTime||0;return{loadTime:e?e.loadEventEnd-e.fetchStart:0,domReady:e?e.domContentLoadedEventEnd-e.fetchStart:0,firstPaint:r,firstContentfulPaint:i}}catch(e){return i.vF.warn("Erreur collecte timing, fallback estimation:",e),this.getFallbackTimingMetrics()}}async getNetworkMetrics(){try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return{latency:await this.measureNetworkLatency(),bandwidth:e?.downlink||0,connectionType:e?.effectiveType||"unknown"}}catch(e){return i.vF.warn("Erreur collecte r√©seau, fallback estimation:",e),this.getFallbackNetworkMetrics()}}async getCPUMetrics(){try{return{usage:await this.estimateCPUUsage(),cores:navigator.hardwareConcurrency||4}}catch(e){return i.vF.warn("Erreur collecte CPU, fallback estimation:",e),this.getFallbackCPUMetrics()}}async getSystemMetrics(){const e="system_metrics",t=this.metricsCache.get(e);if(t&&Date.now()-t.timestamp<3e4)return t.value;try{const[t,r,i]=await Promise.all([this.getMemoryMetrics(),this.getNetworkMetrics(),this.getCPUMetrics()]),s=this.measureFrameRate(),n={cpu:i.usage,memory:t.percentage,latency:r.latency,frameRate:await s,timestamp:Date.now()};return this.metricsCache.set(e,{value:n,timestamp:Date.now()}),n}catch(e){return i.vF.error("Erreur collecte m√©triques syst√®me:",e),this.getFallbackSystemMetrics()}}async getWebVitals(){try{const[e,t,r,i,s]=await Promise.all([this.measureLCP(),this.measureFID(),this.measureCLS(),this.measureFCP(),this.measureTTFB()]);return{lcp:e,fid:t,cls:r,fcp:i,ttfb:s}}catch(e){return i.vF.warn("Erreur Web Vitals, fallback defaults:",e),this.getFallbackWebVitals()}}async measureNetworkLatency(){try{const e=performance.now();return await fetch("/favicon.ico",{method:"HEAD"}),performance.now()-e}catch{return 50}}async estimateCPUUsage(){return new Promise((e=>{const t=performance.now();let r=0,i=0;const s=()=>{const n=Math.min(r+1e3,5e4);for(let e=r;e<n;e++)i+=Math.sqrt(e)*Math.sin(e);if(r=n,r<5e4)setTimeout(s,0);else{const r=performance.now()-t,i=Math.min(r/20,1);e(i)}};s()}))}async measureFrameRate(){return new Promise((e=>{let t=0;const r=performance.now(),i=()=>{t++,performance.now()-r<1e3?requestAnimationFrame(i):e(t)};requestAnimationFrame(i)}))}estimateMemoryUsage(){return 1e3*document.querySelectorAll("*").length}async measureLCP(){try{const e=performance.getEntriesByType("largest-contentful-paint");return e.length>0?e[e.length-1].startTime:0}catch{return 2500}}async measureFID(){try{const e=performance.getEntriesByType("first-input");return e.length>0?e[0].processingStart-e[0].startTime:0}catch{return 100}}async measureCLS(){try{let e=0;const t=new PerformanceObserver((t=>{for(const r of t.getEntries())r.hadRecentInput||(e+=r.value)}));return t.observe({type:"layout-shift",buffered:!0}),await new Promise((e=>setTimeout(e,100))),t.disconnect(),e}catch{return.1}}async measureFCP(){try{const e=performance.getEntriesByName("first-contentful-paint")[0];return e?e.startTime:0}catch{return 1500}}async measureTTFB(){try{const e=performance.getEntriesByType("navigation")[0];return e?e.responseStart-e.requestStart:0}catch{return 200}}getFallbackMemoryMetrics(){return{used:26214400,total:104857600,percentage:25}}getFallbackTimingMetrics(){return{loadTime:1500,domReady:800,firstPaint:1200,firstContentfulPaint:1400}}getFallbackNetworkMetrics(){return{latency:50,bandwidth:10,connectionType:"4g"}}getFallbackCPUMetrics(){return{usage:.15,cores:4}}getFallbackSystemMetrics(){return{cpu:.15,memory:25,latency:50,frameRate:60,timestamp:Date.now()}}getFallbackWebVitals(){return{lcp:2500,fid:100,cls:.1,fcp:1500,ttfb:200}}async getRandomReplacementValue(e="generic"){const t=await this.getSystemMetrics();switch(e){case"cpu":return t.cpu;case"memory":return t.memory/100;case"latency":return t.latency/1e3;default:return(t.cpu+t.memory/100+t.latency/1e3)/3}}refreshMetrics(){this.metricsCache.clear()}async getDevMetrics(){return this.isProduction?this.getSystemMetrics():(i.vF.warn("üöß MODE D√âVELOPPEMENT: Utilisation m√©triques simul√©es pour les tests"),this.getFallbackSystemMetrics())}async getCPUUsage(){return(await this.getSystemMetrics()).cpu}async getMemoryUsage(){return(await this.getSystemMetrics()).memory/100}}const u=h;class d{constructor(){this.overrides={},this.environment=this.detectEnvironment(),this.flags=this.initializeFlags(),this.loadOverrides()}static getInstance(){return d.instance||(d.instance=new d),d.instance}detectEnvironment(){return"production"}initializeFlags(){const e={USE_REAL_METRICS:!1,USE_REAL_DNA:!1,USE_REAL_BEHAVIOR:!1,USE_BACKEND_API:!1,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!1,ENABLE_MOCK_DATA:!0,ENABLE_SECURITY_AUDIT:!1,ENABLE_ADVANCED_ANALYTICS:!1,ENABLE_A_B_TESTING:!1};switch(this.environment){case"development":return{...e,ENABLE_DEBUG_LOGGING:!0,ENABLE_PERFORMANCE_PROFILING:!0,ENABLE_MOCK_DATA:!0,ENABLE_SECURITY_AUDIT:!0,USE_REAL_METRICS:this.getEnvBoolean("USE_REAL_METRICS",!1),USE_REAL_DNA:this.getEnvBoolean("USE_REAL_DNA",!1),USE_REAL_BEHAVIOR:this.getEnvBoolean("USE_REAL_BEHAVIOR",!1),USE_BACKEND_API:this.getEnvBoolean("USE_BACKEND_API",!1)};case"staging":return{...e,USE_REAL_METRICS:!0,USE_REAL_DNA:!0,USE_REAL_BEHAVIOR:!0,USE_BACKEND_API:!0,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!0,ENABLE_MOCK_DATA:!1,ENABLE_SECURITY_AUDIT:!0,ENABLE_ADVANCED_ANALYTICS:!0,ENABLE_A_B_TESTING:!0};case"production":return{...e,USE_REAL_METRICS:!0,USE_REAL_DNA:!0,USE_REAL_BEHAVIOR:!0,USE_BACKEND_API:!0,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!1,ENABLE_MOCK_DATA:!1,ENABLE_SECURITY_AUDIT:!1,ENABLE_ADVANCED_ANALYTICS:!0,ENABLE_A_B_TESTING:!1};default:return e}}loadOverrides(){Object.keys(this.flags).forEach((e=>{const t=process.env[`SYMBIONT_${e}`];void 0!==t&&(this.overrides[e]="true"===t)})),"development"===this.environment&&"undefined"!=typeof localStorage&&Object.keys(this.flags).forEach((e=>{const t=`symbiont_feature_${e.toLowerCase()}`,r=localStorage.getItem(t);null!==r&&(this.overrides[e]="true"===r)}))}isEnabled(e){return void 0!==this.overrides[e]?this.overrides[e]:this.flags[e]}setFlag(e,t){if("development"===this.environment){if(this.overrides[e]=t,"undefined"!=typeof localStorage){const r=`symbiont_feature_${e.toLowerCase()}`;localStorage.setItem(r,t.toString())}i.vF.info(`üîß Feature flag '${e}' d√©fini √† ${t}`)}else i.vF.warn(`‚ö†Ô∏è Override de feature flag '${e}' ignor√© en ${this.environment}`)}resetOverrides(){"development"===this.environment?(this.overrides={},"undefined"!=typeof localStorage&&Object.keys(this.flags).forEach((e=>{const t=`symbiont_feature_${e.toLowerCase()}`;localStorage.removeItem(t)})),i.vF.info("üîÑ Tous les feature flags remis aux valeurs par d√©faut")):i.vF.warn("‚ö†Ô∏è Reset des overrides ignor√© en production")}getEnvironment(){return this.environment}getAllFlags(){const e={};return Object.keys(this.flags).forEach((t=>{e[t]=this.isEnabled(t)})),{...e,environment:this.environment}}isDevelopment(){return"development"===this.environment}isStaging(){return"staging"===this.environment}isProduction(){return"production"===this.environment}runInEnvironment(e){const t=e[this.environment]||e.default;return t?.()}debugLog(e,...t){this.isEnabled("ENABLE_DEBUG_LOGGING")&&i.vF.info(`üêõ [SYMBIONT Debug] ${e}`,...t)}profileOperation(e,t){if(!this.isEnabled("ENABLE_PERFORMANCE_PROFILING"))return t();const r=performance.now(),s=t(),n=performance.now()-r;return i.vF.info(`‚è±Ô∏è [SYMBIONT Profile] ${e}: ${n.toFixed(2)}ms`),s}whenEnabled(e,t){return this.isEnabled(e)?t():void 0}getEnvBoolean(e,t){const r=process.env[e];return void 0===r?t:"true"===r.toLowerCase()}validateProductionSafety(){if(!this.isProduction())return;const e=["ENABLE_MOCK_DATA","ENABLE_DEBUG_LOGGING"].filter((e=>this.isEnabled(e)));if(e.length>0)throw new Error(`üö® S√âCURIT√â: Flags dangereux activ√©s en production: ${e.join(", ")}`)}}const m=d;var g=r(455),y=r(849);class p{constructor(e,t,i){this.health=100,this.lastMutation=Date.now();const s=this.validateInput(e,t);if(!s.isValid)throw new Error(`OrganismCore creation failed: ${s.errors.join(", ")}`);if(this.id=(0,g.wP)(),this.dna=e,this.logger=i?.logger,this.metricsService=u.getInstance(),this.featureFlags=m.getInstance(),this.traitService=new a(t),this.energyService=new c(100),i?.neuralMesh)this.neuralService=new l(i.neuralMesh);else{const{NeuralMesh:e}=r(194);this.neuralService=new l(new e)}this.setupServiceListeners(),this.logger?.debug("OrganismCore initialized",{id:this.id,dna:this.dna})}setupServiceListeners(){this.traitService.addTraitChangeListener((e=>{this.onTraitChanged(e)})),this.energyService.addEnergyListener((e=>{"consumption"===e.type&&e.energyAfter<10&&this.logger?.debug("Low energy warning",{energy:e.energyAfter})}))}onTraitChanged(e){const t=this.traitService.getAllTraits(),r=(t.resilience+t.adaptability)/2;this.energyService.setEfficiency(r),this.logger?.debug("Trait changed, metabolism adjusted",{trait:e.traitName,newValue:e.newValue,efficiency:r})}validateInput(e,t){const r=[];return e&&"string"==typeof e||r.push("DNA must be a non-empty string"),e&&e.length<10&&r.push("DNA must be at least 10 characters long"),t&&Object.entries(t).forEach((([e,t])=>{("number"!=typeof t||t<0||t>1)&&r.push(`Trait ${e} must be a number between 0 and 1`)})),{isValid:0===r.length,errors:r}}getId(){return this.id}getDNA(){return this.dna}getTraits(){return this.traitService.getAllTraits()}updateTrait(e,t){if(!this.energyService.consumeEnergy(1,`trait_update_${e}`))throw new Error("Insufficient energy to update trait");this.traitService.updateTrait(e,t,"manual_update"),this.logger?.debug("Trait updated",{trait:e,value:t})}getEnergyLevel(){return this.energyService.getEnergyLevel()}getHealth(){return this.health}async evolve(e){if(this.energyService.consumeEnergy(5,"evolution"))try{const t=this.traitService.getAllTraits(),r=await this.neuralService.processStimulus(e,t);r.success&&Object.keys(r.adaptations).length>0&&(this.traitService.updateTraits(r.adaptations,"evolution"),this.lastMutation=Date.now(),this.logger?.debug("Evolution successful",{adaptations:r.adaptations,confidence:r.confidence}))}catch(e){this.logger?.error("Evolution failed",e),n.logSimpleError("OrganismCore","evolve",e,"error")}else this.logger?.debug("Evolution skipped: insufficient energy")}async learn(e){if(!this.energyService.consumeEnergy(2,"learning"))return;const t=await this.neuralService.learn(e);if(t){const e=this.traitService.getTrait("memory");this.traitService.updateTrait("memory",e+.01,"learning")}this.logger?.debug("Learning completed",{success:t,data:e})}processStimulus(e){this.energyService.consumeEnergy(1,"stimulus_processing")&&(this.neuralService.queuePattern({id:`pattern_${Date.now()}`,type:"behavioral",data:e,timestamp:Date.now(),confidence:.8}),this.logger?.debug("Stimulus processed",{stimulus:e}))}getState(){const e=this.traitService.getAllTraits(),t=this.energyService.getEnergyStats();return{id:this.id,traits:e,energy:t.current,maxEnergy:t.max,health:this.health,dna:this.dna,lastMutation:this.lastMutation,balance:this.traitService.calculateBalance(),metabolismRate:t.metabolismRate,age:Date.now()-parseInt(this.id.split("_")[1])}}generateShaderParameters(){const e=this.traitService.getAllTraits();return{energy:this.energyService.getEnergyPercentage()/100,health:this.health/100,neuralActivity:this.neuralService.getNeuralActivity(),creativity:e.creativity,focus:e.focus,time:Date.now()/1e3,colorPrimary:[e.creativity,e.empathy,e.intuition],colorSecondary:[e.focus,e.resilience,e.adaptability],morphology:e.adaptability,complexity:e.creativity*e.memory}}toJSON(){return{mesh:this.neuralService.saveState()||{},dna:this.dna,health:this.health,lastMutation:this.lastMutation,traits:this.traitService.toJSON()||{traits:this.traitService.getAllTraits(),history:[]},energy:this.energyService.toJSON()||{energy:100,maxEnergy:100,metabolismRate:1,config:{efficiency:1,baseConsumption:.1},history:[]},neural:this.neuralService.saveState(),timestamp:Date.now()}}fromJSON(e){e.traits&&"object"==typeof e.traits&&this.traitService.fromJSON(e.traits),e.energy&&"object"==typeof e.energy&&this.energyService.fromJSON(e.energy),e.neural&&this.neuralService.loadState(e.neural),this.health=e.health||100,this.lastMutation=e.lastMutation||Date.now(),this.logger?.debug("State restored from JSON",{id:this.id})}cleanup(){this.energyService.destroy(),this.traitService.cleanup(),this.neuralService.cleanup(),this.logger?.debug("OrganismCore cleaned up",{id:this.id})}healthCheck(){const e=[];this.health<20&&e.push("Low health"),this.energyService.getEnergyLevel()<10&&e.push("Low energy");const t=this.neuralService.healthCheck();return t.healthy||e.push(...t.issues),{healthy:0===e.length,issues:e}}async boot(){try{await this.neuralService.initialize(),this.logger?.debug("Organism booted successfully",{id:this.id})}catch(e){throw this.logger?.error("Failed to boot organism",{id:this.id,_error:e}),e}}async hibernate(){try{this.energyService.setEfficiency(.1),await this.neuralService.suspend(),this.logger?.debug("Organism hibernated",{id:this.id})}catch(e){throw this.logger?.error("Failed to hibernate organism",{id:this.id,_error:e}),e}}update(e=16.67){const t=e/16.67;this.energyService.consumeEnergy(.1*t,"metabolism"),this.neuralService.update(e),this.energyService.getEnergyLevel()>80&&(this.health=Math.min(100,this.health+.1*t))}stimulate(e,t){this.neuralService.stimulate(e,t),this.energyService.consumeEnergy(.5,`stimulation_${e}`)}mutate(e=.01){const t=this.traitService.getAllTraits(),r={};Object.keys(t).forEach((i=>{if(y.tm.random()<e){const e=t[i],s=.1*(y.tm.random()-.5),n=Math.max(0,Math.min(1,e+s));r[i]=n}})),Object.keys(r).length>0&&(this.traitService.updateTraits(r,"mutation"),this.lastMutation=Date.now(),this.logger?.debug("Mutation applied",{id:this.id,mutations:r}))}feed(e=10){this.energyService.addEnergy(e),this.logger?.debug("Organism fed",{id:this.id,amount:e})}setTraits(e){this.traitService.updateTraits(e,"external_update")}async getPerformanceMetrics(){const e=this.neuralService.getPerformanceMetrics();return{cpu:await this.metricsService.getCPUUsage(),memory:await this.metricsService.getMemoryUsage(),neuralActivity:e?.neuralActivity||0,connectionStrength:e?.connectionStrength||0}}getShaderParameters(){const e=this.getTraits();return{energy:this.energyService.getEnergyLevel()/100,health:this.health/100,neuralActivity:this.neuralService.getNeuralActivity()||0,creativity:e.creativity,focus:e.focus,time:Date.now()/1e3}}}},513:(e,t,r)=>{var i;r.d(t,{vF:()=>n}),function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.FATAL=5]="FATAL"}(i||(i={}));class s{constructor(e={}){this.logEntries=[],this.config={level:i.INFO,enableConsole:!this.isProduction(),enableStorage:!0,maxStorageEntries:1e3,sensitiveFields:["password","token","key","secret","auth"],productionMode:this.isProduction(),...e}}static getInstance(e){return s.instance||(s.instance=new s(e)),s.instance}isProduction(){return!0}sanitizeData(e){if("string"==typeof e)return this.sanitizeString(e);if("object"==typeof e&&null!==e){if(Array.isArray(e))return e.map((e=>this.sanitizeData(e)));const t={};for(const[r,i]of Object.entries(e))this.isSensitiveField(r)?t[r]="[REDACTED]":t[r]=this.sanitizeData(i);return t}return e}sanitizeString(e){let t=e;for(const e of s.SENSITIVE_PATTERNS)t=t.replace(e,"[REDACTED]");return t}isSensitiveField(e){return this.config.sensitiveFields.some((t=>e.toLowerCase().includes(t.toLowerCase())))}formatMessage(e,t,r,s){return`[${(new Date).toISOString()}] ${i[e]}${s?` [${s}]`:""}: ${t}${r?` ${JSON.stringify(r,null,2)}`:""}`}shouldLog(e){return e>=this.config.level}log(e,t,r,s){if(!this.shouldLog(e))return;const n=r?this.sanitizeData(r):void 0,a=this.sanitizeString(t),o={timestamp:Date.now(),level:e,message:a,data:n,context:s,sanitized:!0};if(this.config.enableStorage&&(this.logEntries.push(o),this.logEntries.length>this.config.maxStorageEntries&&(this.logEntries=this.logEntries.slice(-this.config.maxStorageEntries))),this.config.enableConsole){const t=this.formatMessage(e,a,n,s);switch(e){case i.TRACE:case i.DEBUG:console.debug(t);break;case i.INFO:console.info(t);break;case i.WARN:console.warn(t);break;case i.ERROR:case i.FATAL:console.error(t)}}}trace(e,t,r){this.log(i.TRACE,e,t,r)}debug(e,t,r){this.log(i.DEBUG,e,t,r)}info(e,t,r){this.log(i.INFO,e,t,r)}warn(e,t,r){this.log(i.WARN,e,t,r)}error(e,t,r){this.log(i.ERROR,e,t,r)}fatal(e,t,r){this.log(i.FATAL,e,t,r)}setLevel(e){this.config.level=e}enableConsole(e){this.config.enableConsole=e}getLogs(e){return void 0!==e?this.logEntries.filter((t=>t.level>=e)):[...this.logEntries]}clearLogs(){this.logEntries=[]}exportLogs(){return JSON.stringify(this.logEntries,null,2)}}s.SENSITIVE_PATTERNS=[/password/i,/token/i,/key/i,/secret/i,/auth/i,/credential/i,/session/i,/cookie/i,/jwt/i,/bearer/i,/api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/private[_-]?key/i,/\b[A-Za-z0-9+/]{32,}={0,2}\b/,/\b[0-9a-f]{32,}\b/i,/\b[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}\b/,/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/];const n=s.getInstance();n.info.bind(n),n.warn.bind(n),n.error.bind(n),n.debug.bind(n)},849:(e,t,r)=>{r.d(t,{tm:()=>l});var i,s,n=r(513);!function(e){e.CRYPTOGRAPHIC="cryptographic",e.MODERATE="moderate",e.PERFORMANCE="performance"}(i||(i={})),function(e){e.NEURAL_NETWORK="neural_network",e.WEBGL_RENDERING="webgl_rendering",e.GENETIC_MUTATIONS="genetic_mutations",e.SOCIAL_EVENTS="social_events",e.CRYPTOGRAPHIC_OPS="cryptographic_ops",e.MONITORING="monitoring"}(s||(s={}));class a{constructor(e=123456789,t=987654321){this.state0=e,this.state1=t}random(){let e=this.state0;const t=this.state1;return this.state0=t,e^=e<<23,e^=e>>>17,e^=t,e^=t>>>26,this.state1=e,(t+e>>>0)/4294967296}reseed(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(2);crypto.getRandomValues(e),this.state0=e[0],this.state1=e[1]}}}class o{constructor(e=1e4,t=2e3){this.pool=[],this.isRefilling=!1,this.totalGenerated=0,this.totalConsumed=0,this.poolSize=e,this.refillThreshold=t}async initialize(){await this.fillPool()}async fillPool(){if(!this.isRefilling){this.isRefilling=!0;try{const e=Math.min(5e3,this.poolSize-this.pool.length),t=new Uint32Array(e);if("undefined"!=typeof crypto&&crypto.getRandomValues){crypto.getRandomValues(t);for(const e of t)this.pool.push(e/4294967296);this.totalGenerated+=e}}catch(e){n.vF.error("RandomPool: Erreur g√©n√©ration batch",{error:e})}finally{this.isRefilling=!1}}}getNext(){if(0===this.pool.length)return null;const e=this.pool.pop();return this.totalConsumed++,this.pool.length<=this.refillThreshold&&!this.isRefilling&&this.fillPool(),e}getStats(){return{poolSize:this.pool.length,totalGenerated:this.totalGenerated,totalConsumed:this.totalConsumed,hitRate:this.totalConsumed>0?(this.totalConsumed-this.pool.length)/this.totalConsumed:0,isRefilling:this.isRefilling}}}class c{constructor(){this.configs=new Map([[s.CRYPTOGRAPHIC_OPS,{securityLevel:i.CRYPTOGRAPHIC,poolSize:1e3,refillThreshold:200,batchGeneration:!0,metricsEnabled:!0}],[s.NEURAL_NETWORK,{securityLevel:i.PERFORMANCE,poolSize:5e4,refillThreshold:1e4,batchGeneration:!0,metricsEnabled:!0}],[s.WEBGL_RENDERING,{securityLevel:i.PERFORMANCE,poolSize:1e4,refillThreshold:2e3,batchGeneration:!0,metricsEnabled:!1}],[s.GENETIC_MUTATIONS,{securityLevel:i.MODERATE,poolSize:5e3,refillThreshold:1e3,batchGeneration:!0,metricsEnabled:!0}]]),this.metrics={totalCalls:0,secureCalls:0,poolCalls:0,fastCalls:0,avgLatencyMs:0,lastReseedTime:Date.now()},this.securePool=new o(1e4,2e3),this.fastPRNG=new a,this.initialize()}static getInstance(){return c.instance||(c.instance=new c),c.instance}async initialize(){await this.securePool.initialize(),setInterval((()=>{this.fastPRNG.reseed(),this.metrics.lastReseedTime=Date.now()}),3e5)}random(e=s.GENETIC_MUTATIONS){const t=performance.now();this.metrics.totalCalls++;const r=this.configs.get(e)||this.configs.get(s.GENETIC_MUTATIONS);let n;switch(r.securityLevel){case i.CRYPTOGRAPHIC:n=this.getSecureRandom(),this.metrics.secureCalls++;break;case i.MODERATE:n=this.getPooledRandom(),this.metrics.poolCalls++;break;case i.PERFORMANCE:n=this.getFastRandom(),this.metrics.fastCalls++;break;default:n=this.getPooledRandom(),this.metrics.poolCalls++}if(r.metricsEnabled){const e=performance.now()-t;this.metrics.avgLatencyMs=(this.metrics.avgLatencyMs+e)/2}return n}getSecureRandom(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available for secure random generation");throw n.vF.error("HybridRandom: CRITICAL FAILURE in getSecureRandom",e),e}getPooledRandom(){const e=this.securePool.getNext();if(null!==e)return e;if(n.vF.warn("HybridRandom: Pool empty, attempting direct crypto generation"),"undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}const t=new Error("SECURITY CRITICAL: Pool empty and crypto.getRandomValues unavailable");throw n.vF.error("HybridRandom: CRITICAL FAILURE - no secure random source available",t),t}getFastRandom(){return this.fastPRNG.random()}neuralRandom(){return this.random(s.NEURAL_NETWORK)}renderingRandom(){return this.random(s.WEBGL_RENDERING)}cryptoRandom(){return this.random(s.CRYPTOGRAPHIC_OPS)}mutationRandom(){return this.random(s.GENETIC_MUTATIONS)}async generateBatch(e,t){const r=this.configs.get(t);if(!r?.batchGeneration)return Array.from({length:e},(()=>this.random(t)));if(r.securityLevel===i.PERFORMANCE)return Array.from({length:e},(()=>this.fastPRNG.random()));{const t=new Uint32Array(e);return"undefined"!=typeof crypto&&crypto.getRandomValues?(crypto.getRandomValues(t),Array.from(t,(e=>e/4294967296))):Array.from({length:e},(()=>this.getSecureRandom()))}}getPerformanceMetrics(){return{...this.metrics,poolStats:this.securePool.getStats(),distribution:{secure:(this.metrics.secureCalls/this.metrics.totalCalls*100).toFixed(1)+"%",pooled:(this.metrics.poolCalls/this.metrics.totalCalls*100).toFixed(1)+"%",fast:(this.metrics.fastCalls/this.metrics.totalCalls*100).toFixed(1)+"%"}}}configureContext(e,t){const r=this.configs.get(e)||this.configs.get(s.GENETIC_MUTATIONS);this.configs.set(e,{...r,...t})}shutdown(){n.vF.info("HybridRandomProvider: Arr√™t avec m√©triques",this.getPerformanceMetrics())}}c.getInstance();class l{static random(){const e=this.detectUsageContext();return this.provider.random(e)}static detectUsageContext(){try{const e=(new Error).stack;return e?e.includes("NeuralMesh")||e.includes("NeuralCore")||e.includes("neural")||e.includes("evolve")||e.includes("mutate")?s.NEURAL_NETWORK:e.includes("WebGL")||e.includes("render")||e.includes("draw")||e.includes("Batcher")?s.WEBGL_RENDERING:e.includes("uuid")||e.includes("UUID")||e.includes("token")||e.includes("encrypt")||e.includes("crypto")?s.CRYPTOGRAPHIC_OPS:e.includes("Social")||e.includes("Mystical")||e.includes("Collective")?s.SOCIAL_EVENTS:e.includes("Monitor")||e.includes("Health")||e.includes("metrics")?s.MONITORING:s.GENETIC_MUTATIONS:s.GENETIC_MUTATIONS}catch{return s.GENETIC_MUTATIONS}}static randomInt(e,t){if(e>=t)throw new Error("PerformanceOptimizedRandom: min doit √™tre inf√©rieur √† max");const r=t-e,i=this.detectUsageContext();return Math.floor(this.provider.random(i)*r)+e}static randomFloat(e,t){if(e>=t)throw new Error("PerformanceOptimizedRandom: min doit √™tre inf√©rieur √† max");const r=this.detectUsageContext();return this.provider.random(r)*(t-e)+e}static async randomBatch(e,t){const r=t||this.detectUsageContext();return this.provider.generateBatch(e,r)}static randomBytes(e){const t=this.detectUsageContext();if(t!==s.CRYPTOGRAPHIC_OPS){const r=new Uint8Array(e);for(let i=0;i<e;i++)r[i]=Math.floor(256*this.provider.random(t));return r}if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}n.vF.warn("PerformanceOptimizedRandom: crypto.getRandomValues non disponible");const r=new Uint8Array(e);for(let t=0;t<e;t++)r[t]=Math.floor(256*this.provider.cryptoRandom());return r}static choice(e){if(0===e.length)throw new Error("PerformanceOptimizedRandom: Le tableau ne peut pas √™tre vide");return e[this.randomInt(0,e.length)]}static uuid(){return this.generateSecureUUID()}static generateSecureUUID(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20,32)].join("-")}return n.vF.warn("PerformanceOptimizedRandom: crypto.getRandomValues non disponible, fallback provider"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*this.provider.cryptoRandom()|0;return("x"===e?t:3&t|8).toString(16)}))}static randomString(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r="";for(let i=0;i<e;i++)r+=t.charAt(this.randomInt(0,t.length));return r}static randomId(e="",t=8){const r=this.randomString(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return e?`${e}_${r}`:r}static neuralRandom(){return this.provider.neuralRandom()}static renderingRandom(){return this.provider.renderingRandom()}static mutationRandom(){return this.provider.mutationRandom()}static cryptoRandom(){return this.provider.cryptoRandom()}static async neuralBatch(e){return this.provider.generateBatch(e,s.NEURAL_NETWORK)}static async renderingBatch(e){return this.provider.generateBatch(e,s.WEBGL_RENDERING)}static getPerformanceMetrics(){return this.provider.getPerformanceMetrics()}static configurePerformance(e,t){this.provider.configureContext(e,{securityLevel:t})}static async warmup(){n.vF.info("PerformanceOptimizedRandom: Initialisation pools performance..."),await Promise.all([this.provider.generateBatch(1e3,s.NEURAL_NETWORK),this.provider.generateBatch(500,s.WEBGL_RENDERING),this.provider.generateBatch(300,s.GENETIC_MUTATIONS)]),n.vF.info("PerformanceOptimizedRandom: Warmup termin√©, performance optimale pr√™te")}static async benchmarkVsSecureRandom(e=1e4){const t=performance.now();for(let t=0;t<e;t++){const e=new Uint32Array(1);"undefined"!=typeof crypto&&crypto.getRandomValues&&(crypto.getRandomValues(e),e[0],this.MAX_UINT32)}const r=performance.now()-t,i=performance.now();for(let t=0;t<e;t++)this.neuralRandom();const s=performance.now()-i,n=r/s;return{secureRandomMs:Math.round(100*r)/100,optimizedMs:Math.round(100*s)/100,speedupRatio:Math.round(10*n)/10,recommendation:n>100?`üöÄ Gain massif ${n.toFixed(0)}x - Migration recommand√©e`:n>10?`‚ö° Gain significatif ${n.toFixed(0)}x - Migration b√©n√©fique`:`‚úÖ Gain mod√©r√© ${n.toFixed(1)}x - Migration optionnelle`}}}l.provider=c.getInstance(),l.MAX_UINT32=4294967295,l.random,l.randomInt,l.randomFloat,l.neuralRandom,l.renderingRandom,l.mutationRandom,l.cryptoRandom}},r={};function i(e){var s=r[e];if(void 0!==s)return s.exports;var n=r[e]={exports:{}};return t[e](n,n.exports,i),n.exports}i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},function(e){e.PAGE_VISIT="PAGE_VISIT",e.SCROLL_EVENT="SCROLL_EVENT",e.ORGANISM_UPDATE="ORGANISM_UPDATE",e.ORGANISM_MUTATE="ORGANISM_MUTATE",e.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",e.WEBGL_INIT="WEBGL_INIT",e.WEBGL_ERROR="WEBGL_ERROR",e.WEBGL_INITIALIZED="WEBGL_INITIALIZED",e.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",e.GENERATE_INVITATION="GENERATE_INVITATION",e.INVITATION_GENERATED="INVITATION_GENERATED",e.CONSUME_INVITATION="CONSUME_INVITATION",e.INVITATION_CONSUMED="INVITATION_CONSUMED",e.CHECK_INVITATION="CHECK_INVITATION",e.INVITATION_CHECKED="INVITATION_CHECKED",e.MURMUR="MURMUR",e.GET_INVITER="GET_INVITER",e.INVITER_RESULT="INVITER_RESULT",e.GET_INVITEES="GET_INVITEES",e.INVITEES_RESULT="INVITEES_RESULT",e.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",e.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",e.INTERACTION_DETECTED="INTERACTION_DETECTED",e.GET_HEALTH_METRICS="GET_HEALTH_METRICS",e.HEALTH_METRICS_RESPONSE="HEALTH_METRICS_RESPONSE",e.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",e.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",e.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",e.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",e.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",e.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",e.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",e.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",e.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED"}(e||(e={}));var s=i(455),n=i(513);function a(e){return e&&"object"==typeof e?o(e):e}function o(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof HTMLCanvasElement||e instanceof CanvasRenderingContext2D||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner||e&&"object"==typeof e&&e.constructor&&e.constructor.name&&e.constructor.name.includes("Fiber"))return e instanceof HTMLCanvasElement?{tagName:"CANVAS",width:e.width,height:e.height,className:e.className,id:e.id}:"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>o(e,t)));const r={};for(const i in e)if(e.hasOwnProperty(i))try{r[i]=o(e[i],t)}catch(e){r[i]="[Non-serializable]"}return r}function c(e){return"object"==typeof e&&null!==e&&"code"in e&&"string"==typeof e.code&&"status"in e&&"string"==typeof e.status}function l(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return n.vF.warn("Message serialization issue, cleaning object:",t),h(e)}}function h(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof HTMLCanvasElement||e instanceof CanvasRenderingContext2D||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner||e&&"object"==typeof e&&e.constructor&&e.constructor.name&&e.constructor.name.includes("Fiber"))return"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>h(e,t)));const r={};for(const i in e)if(e.hasOwnProperty(i))try{r[i]=h(e[i],t)}catch(e){r[i]="[Non-serializable]"}return r}class u{constructor(e){this.source=e,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){chrome.runtime.onMessage.addListener(((e,t,r)=>(this.shouldProcessMessage(e)&&(this.enqueueMessage(e),r({received:!0})),!1)))}shouldProcessMessage(e){return this.filters.every((t=>t(e)))}async enqueueMessage(e){if(this.messageQueue.push(e),!this.processing){this.processing=!0;try{await this.processQueue()}finally{this.processing=!1}}}async processQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();await this.processMessage(e)}}async processMessage(t){if(!function(t,r){switch(t){case e.ORGANISM_UPDATE:return"object"==typeof(i=r)&&null!==i&&"id"in i&&"string"==typeof i.id&&"generation"in i&&"number"==typeof i.generation&&"health"in i&&"number"==typeof i.health&&"energy"in i&&"number"==typeof i.energy&&"traits"in i&&"object"==typeof i.traits;case e.ORGANISM_MUTATE:return function(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"trigger"in e&&"string"==typeof e.trigger}(r);case e.PAGE_VISIT:case e.SCROLL_EVENT:return function(e){return e&&"string"==typeof e.url&&"number"==typeof e.visitCount}(r);case e.MURMUR:return function(e){return"object"==typeof e&&null!==e&&"text"in e&&"string"==typeof e.text&&"timestamp"in e&&"number"==typeof e.timestamp}(r);case e.GENERATE_INVITATION:case e.CONSUME_INVITATION:case e.CHECK_INVITATION:return function(e){return"object"==typeof e&&null!==e&&"code"in e&&"string"==typeof e.code}(r);case e.INVITATION_GENERATED:return"string"==typeof r||c(r);case e.INVITATION_CONSUMED:case e.INVITATION_CHECKED:return c(r);case e.SHARED_MUTATION_RESULT:return"string"==typeof r||r&&"object"==typeof r;default:return!0}var i}(t.type,t.payload))return void n.vF.warn(`[MessageBus] Payload non valide pour le type ${t.type}`,t.payload);for(const e of this.globalHandlers)try{await e(t)}catch(e){n.vF.error("Error in global handler:",e)}const r=this.handlers.get(t.type);if(r)for(const e of r)try{await e(t)}catch(e){n.vF.error(`Error in handler for ${t.type}:`,e)}}on(e,t){this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t)}off(e,t){const r=this.handlers.get(e);r&&r.delete(t)}onAny(e){this.globalHandlers.add(e)}offAny(e){this.globalHandlers.delete(e)}addFilter(e){this.filters.push(e)}async send(e){const t={...e,source:this.source,timestamp:Date.now(),id:(0,s.lk)()};try{const e=l(a(t));if("content"===this.source)await chrome.runtime.sendMessage(e);else{const t=await chrome.tabs.query({}),r=e=>e.active||e.url&&e.url.includes("symbiont"),i=t.filter(r);for(const t of i)t.id&&chrome.tabs.sendMessage(t.id,e).catch((()=>{}));chrome.runtime.sendMessage(e).catch((()=>{}))}}catch(e){n.vF.error("Error sending message:",e)}}sendToBackground(e){this.send(e)}emit(e,t){const r=this.handlers.get(e);r&&r.forEach((r=>r({type:e,payload:t})))}handleMessage(e,t){n.vF.info("Handling message:",e)}onMessage(e,t,r){return n.vF.info("Received message:",e),!0}sendToFrame(e,t,r){n.vF.info("Sending to frame:",t,r)}}class d{constructor(){this.db=null,this.DB_NAME="symbiont-db",this.DB_VERSION=3,this.OPERATION_TIMEOUT=1e4,this.MAX_STORAGE_SIZE_MB=50,this.quotaWarningIssued=!1}withTimeout(e,t=this.OPERATION_TIMEOUT){return Promise.race([e,new Promise(((e,r)=>setTimeout((()=>r(new Error(`Operation timed out after ${t}ms`))),t)))])}async initialize(){if("undefined"==typeof indexedDB)throw new Error("IndexedDB is not available in this environment");console.log("[SymbiontStorage] Starting initialization...",{dbName:this.DB_NAME,dbVersion:this.DB_VERSION});const e=this.db;if(e){console.log("[SymbiontStorage] Closing existing database connection");try{e.close()}catch(e){console.warn("[SymbiontStorage] Error closing existing connection:",e)}this.db=null}try{const e=this.checkStorageQuota();await Promise.race([e,new Promise(((e,t)=>setTimeout((()=>t(new Error("Storage quota check timeout"))),3e3)))])}catch(e){console.warn("[SymbiontStorage] Failed to check storage quota (continuing anyway):",e)}let t=null;for(let e=1;e<=3;e++)try{return console.log(`[SymbiontStorage] Initialization attempt ${e}/3`),await this.attemptInitialize(3===e),void console.log("[SymbiontStorage] Initialization completed successfully")}catch(r){if(t=r instanceof Error?r:new Error(String(r)),console.error(`[SymbiontStorage] Initialization attempt ${e} failed:`,t),!(e<3&&(t.message.includes("blocked")||t.message.includes("timeout"))))break;{const r=t.message.includes("blocked")?2e3*e:1e3*e;console.log(`[SymbiontStorage] Waiting ${r}ms before retry (blocked: ${t.message.includes("blocked")})...`),await new Promise((e=>setTimeout(e,r)));const i=this.db;if(i){try{i.close()}catch(e){console.warn("[SymbiontStorage] Error closing connection before retry:",e)}this.db=null}if(t.message.includes("blocked")&&2===e){console.warn("[SymbiontStorage] Attempting to force close blocked database...");try{await this.forceCloseDatabase()}catch(e){console.warn("[SymbiontStorage] Could not force close database:",e)}}}}console.error("[SymbiontStorage] All initialization attempts failed");const r=this.db;if(r){try{r.close()}catch(e){console.error("[SymbiontStorage] Error closing database after failed init:",e)}this.db=null}throw t||new Error("IndexedDB initialization failed after all retries")}attemptInitialize(e){return new Promise(((t,r)=>{let i=null,s=!1,n=null;const a=()=>{i&&(clearTimeout(i),i=null),n&&(clearTimeout(n),n=null)},o=e=>{s||(s=!0,a(),r(e))},c=e?2e4:1e4;i=setTimeout((()=>{console.error(`[SymbiontStorage] IndexedDB open request timeout (no response after ${c}ms)`),o(new Error(`IndexedDB open request timeout - no response from browser after ${c}ms`))}),c),console.log("[SymbiontStorage] Opening IndexedDB...");const l=indexedDB.open(this.DB_NAME,this.DB_VERSION);l.onerror=()=>{const e=l.error;console.error("[SymbiontStorage] IndexedDB open failed:",{name:e?.name,message:e?.message,code:e?.code}),o(e||new Error("Unknown IndexedDB error"))},l.onsuccess=()=>{console.log("[SymbiontStorage] IndexedDB opened successfully");try{if(this.db=l.result,!this.db)return void o(new Error("IndexedDB opened but result is null"));this.db.onerror=e=>{console.error("[SymbiontStorage] Database error:",e)},this.db.onversionchange=()=>{console.warn("[SymbiontStorage] Database version changed, closing connection"),this.db?.close(),this.db=null},console.log("[SymbiontStorage] Database initialized successfully",{objectStores:Array.from(this.db.objectStoreNames)}),s||(s=!0,a(),t())}catch(e){console.error("[SymbiontStorage] Error setting up database:",e),o(e instanceof Error?e:new Error("Unknown error during database setup"))}},l.onupgradeneeded=e=>{console.log("[SymbiontStorage] Database upgrade needed");try{const t=e.target.result;if(!t)return void console.error("[SymbiontStorage] Database upgrade: result is null");if(!t.objectStoreNames.contains("organisms")){console.log("[SymbiontStorage] Creating organisms store");const e=t.createObjectStore("organisms",{keyPath:"id"});e.createIndex("generation","generation",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(!t.objectStoreNames.contains("behaviors")){console.log("[SymbiontStorage] Creating behaviors store");const e=t.createObjectStore("behaviors",{keyPath:"url"});e.createIndex("lastVisit","lastVisit",{unique:!1}),e.createIndex("visitCount","visitCount",{unique:!1})}if(!t.objectStoreNames.contains("mutations")){console.log("[SymbiontStorage] Creating mutations store");const e=t.createObjectStore("mutations",{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}if(t.objectStoreNames.contains("settings")||(console.log("[SymbiontStorage] Creating settings store"),t.createObjectStore("settings",{keyPath:"key"})),!t.objectStoreNames.contains("invitations")){console.log("[SymbiontStorage] Creating invitations store");const e=t.createObjectStore("invitations",{keyPath:"code"});e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("status","status",{unique:!1})}console.log("[SymbiontStorage] Database upgrade completed")}catch(e){console.error("[SymbiontStorage] Error during database upgrade:",e),o(e instanceof Error?e:new Error("Unknown error during database upgrade"))}},l.onblocked=()=>{if(console.warn("[SymbiontStorage] IndexedDB open blocked - another connection is open"),console.warn("[SymbiontStorage] Waiting for other connection to close..."),n&&clearTimeout(n),i){clearTimeout(i);const t=e?3e4:2e4;i=setTimeout((()=>{console.error(`[SymbiontStorage] IndexedDB still blocked after ${t}ms wait`),console.error("[SymbiontStorage] This usually means another tab/context has the database open"),o(new Error(`IndexedDB blocked - another connection preventing access after ${t}ms`))}),t)}}}))}async getOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,r)=>{const i=this.db.transaction(["organisms"],"readonly").objectStore("organisms");if(e){const s=i.get(e);s.onsuccess=()=>t(s.result||null),s.onerror=()=>r(s.error)}else{const e=i.openCursor();e.onsuccess=e=>{const r=e.target.result;t(r?r.value:null)},e.onerror=()=>r(e.error)}}));return this.withTimeout(t)}async saveOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,r)=>{const i=this.db.transaction(["organisms"],"readwrite").objectStore("organisms").put(e);i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}));return this.withTimeout(t)}async getBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").get(e);i.onsuccess=()=>t(i.result||null),i.onerror=()=>r(i.error)}))}async saveBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["behaviors"],"readwrite").objectStore("behaviors").put(e);i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}))}async addMutation(e){if(!this.db)throw new Error("Database not initialized");const t={...e,timestamp:e.timestamp||Date.now()};return new Promise(((e,r)=>{const i=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").add(t);i.onsuccess=()=>e(),i.onerror=()=>r(i.error)}))}async getRecentMutations(e=10){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["mutations"],"readonly").objectStore("mutations").index("timestamp").openCursor(null,"prev"),s=[];i.onsuccess=r=>{const i=r.target.result;i&&s.length<e?(s.push(i.value),i.continue()):t(s)},i.onerror=()=>r(i.error)}))}async getSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((r,i)=>{const s=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);s.onsuccess=()=>{const e=s.result;r(e?e.value:t)},s.onerror=()=>i(s.error)}))}async setSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((r,i)=>{const s=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:e,value:t});s.onsuccess=()=>r(),s.onerror=()=>i(s.error)}))}async addInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").add({...e,createdAt:e.createdAt||Date.now()});i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}))}async updateInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").put(e);i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}))}async getInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const i=this.db.transaction(["invitations"],"readonly").objectStore("invitations").get(e);i.onsuccess=()=>t(i.result||null),i.onerror=()=>r(i.error)}))}async getAllInvitations(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const r=this.db.transaction(["invitations"],"readonly").objectStore("invitations").openCursor(),i=[];r.onsuccess=t=>{const r=t.target.result;r?(i.push(r.value),r.continue()):e(i)},r.onerror=()=>t(r.error)}))}async getBehaviorPatterns(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const r=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),i=[];r.onsuccess=t=>{const r=t.target.result;r?(i.push(r.value),r.continue()):(i.sort(((e,t)=>t.visitCount!==e.visitCount?t.visitCount-e.visitCount:t.lastVisit-e.lastVisit)),e(i))},r.onerror=()=>t(r.error)}))}async getRecentActivity(e=864e5){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-e;return new Promise(((e,r)=>{const i=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),s=[];i.onsuccess=r=>{const i=r.target.result;if(i){const e=i.value,r=(e.interactions||[]).filter((e=>e.timestamp>=t));for(const t of r)s.push({...t,url:e.url});i.continue()}else s.sort(((e,t)=>t.timestamp-e.timestamp)),e(s)},i.onerror=()=>r(i.error)}))}async cleanup(e=30){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-24*e*60*60*1e3;return new Promise(((e,r)=>{const i=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").index("timestamp"),s=IDBKeyRange.upperBound(t),n=i.openCursor(s);n.onsuccess=t=>{const r=t.target.result;r?(r.delete(),r.continue()):e()},n.onerror=()=>r(n.error)}))}async checkStorageQuota(){if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,r=(e.quota||0)/1048576,i=r>0?t/r*100:0;console.info("Storage quota:",{usageInMB:t.toFixed(2),quotaInMB:r.toFixed(2),usagePercent:i.toFixed(2)+"%"}),i>80&&!this.quotaWarningIssued&&(this.quotaWarningIssued=!0,console.warn("STORAGE WARNING: Usage above 80%, consider cleanup"),i>90&&(console.warn("STORAGE CRITICAL: Usage above 90%, triggering automatic cleanup"),await this.cleanup(15))),t>.9*this.MAX_STORAGE_SIZE_MB&&(console.error("STORAGE CRITICAL: Approaching maximum storage size limit"),await this.cleanup(7))}catch(e){console.error("Failed to check storage quota:",e)}else console.warn("Storage API not available, skipping quota check")}async getStorageStats(){if(!navigator.storage||!navigator.storage.estimate)return{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1};try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,r=(e.quota||0)/1048576,i=r>0?t/r*100:0;return{usageInMB:t,quotaInMB:r,usagePercent:i,needsCleanup:i>80}}catch(e){return console.error("Failed to get storage stats:",e),{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1}}}close(){const e=this.db;e&&(e.close(),this.db=null)}async forceCloseDatabase(){console.warn("[SymbiontStorage] Attempting to force close database by deleting and recreating...");const e=this.db;if(e){try{e.close()}catch(e){console.warn("[SymbiontStorage] Error closing our connection:",e)}this.db=null}return await new Promise((e=>setTimeout(e,1e3))),new Promise((e=>{const t=indexedDB.deleteDatabase(this.DB_NAME);t.onsuccess=()=>{console.log("[SymbiontStorage] Database deleted successfully, will be recreated on next open"),e()},t.onerror=()=>{const r=t.error;console.warn("[SymbiontStorage] Could not delete database:",r),e()},t.onblocked=()=>{console.warn("[SymbiontStorage] Database delete blocked - another connection still open"),setTimeout((()=>{setTimeout((()=>{console.warn("[SymbiontStorage] Database delete still blocked, giving up"),e()}),5e3)}),1e3)}}))}}var m=i(18);const g={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let y;const p=new Uint8Array(16),f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));const v=function(e,t,r){if(g.randomUUID&&!t&&!e)return g.randomUUID();const i=(e=e||{}).random??e.rng?.()??function(){if(!y){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");y=crypto.getRandomValues.bind(crypto)}return y(p)}();if(i.length<16)throw new Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){if((r=r||0)<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=i[e];return t}return function(e,t=0){return(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase()}(i)};class E{constructor(e){this.storage=e}async generateInvitation(e){const t={code:v().slice(0,8).toUpperCase(),donorId:e,symbolicLink:this.generateSymbolicLink(),used:!1,createdAt:Date.now()};return await this.storage.addInvitation(t),t}async consumeInvitation(e,t){const r=await this.storage.getInvitation(e);return!r||r.used?null:(r.used=!0,r.receiverId=t,r.usedAt=Date.now(),await this.storage.updateInvitation(r),r)}async isValid(e){const t=await this.storage.getInvitation(e);return!!t&&!t.used}generateSymbolicLink(){const e=["#FF00FF","#00FFFF","#FFFF00","#FF8800","#00FF88","#8800FF"];return e[Math.floor(m.Dm.random()*e.length)]}async getAllInvitations(){return await this.storage.getAllInvitations()}}const S={loop:["Encore ce m√™me chemin... Qu'y cherches-tu ?","La boucle se r√©p√®te, intention ou habitude ?","Revenir, encore et encore. Un besoin de rep√®re ?"],idle:["Un temps de pause... ou d'h√©sitation ?","Le silence aussi fait partie du voyage.","L'inactivit√©, pr√©lude √† une nouvelle exploration ?"],exploration:["Nouveau territoire, nouvelle perspective.","L'exploration nourrit la curiosit√©.","Tu t'aventures hors des sentiers battus."],routine:["Les habitudes forgent des chemins familiers.","La routine rassure, mais l'inattendu surprend.","Encore ce site, comme un rituel quotidien."],default:["Tu reviens souvent ici quand tu doutes.","Pourquoi cette boucle ?","As-tu remarqu√© ce sch√©ma dans ta navigation ?","Un autre d√©tour, ou une qu√™te de sens ?","Ce site semble t'attirer dans les moments de r√©flexion.","Encore une fois, tu explores ce chemin familier.","Et si tu essayais une nouvelle direction ?","La r√©p√©tition cache-t-elle une intention ?","Un murmure dans le flux de tes habitudes...","Parfois, la boucle est une porte vers l'inattendu."]},w={morning:["Un nouveau jour, une nouvelle boucle commence.","Le matin invite √† la d√©couverte.","L'aube de tes habitudes num√©riques."],afternoon:["L'apr√®s-midi, la routine s'installe.","Un moment propice √† l'exploration ou √† la r√©p√©tition ?","Le soleil haut, l'esprit vagabonde."],evening:["Le soir, tu reviens √† l'essentiel.","La nuit favorise les d√©tours int√©rieurs.","Encore connect√©, m√™me √† la tomb√©e du jour."],weekend:["Le week-end, les chemins changent.","Un rythme diff√©rent, des envies nouvelles.","La libert√© du week-end se lit dans ta navigation."]};class b{generateMurmur(e){if(function(){const e=(new Date).getDay();return 0===e||6===e}()){const e=w.weekend;if(m.Dm.random()<.5)return e[Math.floor(m.Dm.random()*e.length)]}else{const e=function(){const e=(new Date).getHours();return e<12?"morning":e<18?"afternoon":"evening"}();if(w[e]&&m.Dm.random()<.4){const t=w[e];return t[Math.floor(m.Dm.random()*t.length)]}}const t=e&&S[e]?S[e]:S.default;return t[Math.floor(m.Dm.random()*t.length)]}}class I{static detectRepetition(e,t=3){const r={};for(const t of e)r[t.type]=(r[t.type]||0)+1;return Object.entries(r).filter((([e,r])=>r>=t)).map((([e,t])=>({type:"repetition",score:t,details:{eventType:e}})))}static detectAlternance(e,t,r,i=4){let s=0,n=null;for(const i of e)i.type!==t&&i.type!==r||i.type===n?i.type===n&&(s=1,n=i.type):(s++,n=i.type);return s>=i?[{type:"alternance",score:s,details:{typeA:t,typeB:r}}]:[]}static detectBurst(e,t=1e3,r=3){if(e.length<r)return[];let i=1,s=1;for(let r=1;r<e.length;r++)e[r].timestamp-e[r-1].timestamp<=t?(i++,s=Math.max(s,i)):i=1;return s>=r?[{type:"burst",score:s,details:{maxInterval:t}}]:[]}static detectTemporalPattern(e,t=1e3,r=.2){if(e.length<3)return[];const i=[];for(let t=1;t<e.length;t++)i.push(e[t].timestamp-e[t-1].timestamp);const s=i.reduce(((e,t)=>e+t),0)/i.length,n=i.reduce(((e,t)=>e+Math.pow(t-s,2)),0)/i.length,a=Math.sqrt(n);return s>=t&&a/s<r?[{type:"temporal",score:s,details:{std:a,count:e.length}}]:[]}}class T{static getInstance(){return this.instance||(this.instance=new T),this.instance}async setItem(e,t){try{await chrome.storage.local.set({[e]:t})}catch(e){throw n.vF.error("Storage error:",e),e}}async getItem(e){try{return(await chrome.storage.local.get([e]))[e]||null}catch(e){return n.vF.error("Storage retrieval error:",e),null}}async removeItem(e){try{await chrome.storage.local.remove([e])}catch(e){n.vF.error("Storage removal error:",e)}}}class R{static get swLocalStorage(){return{getItem:e=>this.storage.getItem(e),setItem:(e,t)=>this.storage.setItem(e,t),removeItem:e=>this.storage.removeItem(e)}}static get swIndexedDB(){return globalThis.indexedDB}static get swCryptoAPI(){return"undefined"!=typeof globalThis&&globalThis.crypto&&globalThis.crypto.subtle&&"function"==typeof globalThis.crypto.getRandomValues?{...globalThis.crypto,encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)}:(n.vF.warn("WebCrypto API non disponible - utilisation du mode de d√©veloppement"),{subtle:null,getRandomValues:e=>{for(let t=0;t<e.length;t++){const r=Date.now()+t;e[t]=Math.floor(1e4*Math.sin(r)%256)}return e},encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)})}}R.storage=T.getInstance(),R.swCrypto=new class{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(e){try{const t=new TextEncoder,r=t.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),i=await crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt"]),s=crypto.getRandomValues(new Uint8Array(12)),n=t.encode(JSON.stringify(e)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},i,n),o=new Uint8Array(s.length+a.byteLength);return o.set(s,0),o.set(new Uint8Array(a),s.length),btoa(String.fromCharCode(...o))}catch(t){n.vF.error("Encryption failed, using fallback:",t);const r=JSON.stringify(e);return btoa(unescape(encodeURIComponent(r)))}}async decryptSensitiveData(e){try{const t=Uint8Array.from(atob(e),(e=>e.charCodeAt(0))),r=t.slice(0,12),i=t.slice(12),s=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),n=await crypto.subtle.importKey("raw",s,{name:"AES-GCM"},!1,["decrypt"]),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},n,i),o=new TextDecoder;return JSON.parse(o.decode(a))}catch(t){n.vF.error("Decryption failed, trying fallback:",t);try{const t=decodeURIComponent(escape(atob(e)));return JSON.parse(t)}catch(e){throw n.vF.error("All decryption methods failed:",e),new Error("Unable to decrypt data")}}}},R.swBroadcastChannel=class{constructor(e){this.handlers=new Map,this.channelName=e,this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener(((e,t,r)=>"CRYPTO_OPERATION"===e.type||e.channel===this.channelName&&(this.handleMessage(e.data),!0)))}serializeMessageData(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return n.vF.warn("Message serialization issue, cleaning object:",t),this.cleanObjectForSerialization(e)}}cleanObjectForSerialization(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner)return"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>this.cleanObjectForSerialization(e,t)));const r={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i))try{r[i]=this.cleanObjectForSerialization(e[i],t)}catch(e){r[i]="[Non-serializable]"}return r}postMessage(e){const t=this.serializeMessageData(e);chrome.tabs.query({},(e=>{e.forEach((e=>{e.id&&chrome.tabs.sendMessage(e.id,{channel:this.channelName,data:t}).catch((()=>{}))}))})),this.broadcastViaStorage(t)}async broadcastViaStorage(e){const t=T.getInstance(),r=Date.now(),i=`broadcast_${this.channelName}_${r}`;await t.setItem(i,JSON.stringify({data:e,timestamp:r,channel:this.channelName})),setTimeout((async()=>{await t.removeItem(i)}),3e4)}handleMessage(e){(this.handlers.get("message")||[]).forEach((t=>{try{t({data:e})}catch(e){n.vF.error("Message handler error:",e)}}))}set onmessage(e){this.handlers.has("message")||this.handlers.set("message",[]),this.handlers.get("message").push((t=>e(t)))}};const A=R.swLocalStorage,C=(R.swBroadcastChannel,R.swCryptoAPI);R.swIndexedDB;class M{constructor(e){this.activeRequests=0,this.circuitBreakerOpen=!1,this.lastFailureTime=0,this.circuitBreakerTimeout=3e4,this.config=e}async execute(e){if(this.circuitBreakerOpen){if(Date.now()-this.lastFailureTime<this.circuitBreakerTimeout)throw new Error(`Circuit breaker ouvert pour ${this.config.name}`);this.circuitBreakerOpen=!1,n.vF.info(`Circuit breaker ferm√© pour ${this.config.name}`)}if(this.activeRequests>=this.config.maxConcurrentRequests){if("fail-fast"===this.config.fallbackStrategy)throw new Error(`Bulkhead satur√©: ${this.config.name}`);await this.waitForSlot()}this.activeRequests++;try{return await this.executeWithTimeout(e)}catch(e){throw this.handleFailure(e),e}finally{this.activeRequests--}}async executeWithTimeout(e){return new Promise(((t,r)=>{const i=setTimeout((()=>{r(new Error(`Timeout dans bulkhead ${this.config.name}`))}),this.config.timeout);e().then((e=>{clearTimeout(i),t(e)})).catch((e=>{clearTimeout(i),r(e)}))}))}async waitForSlot(){const e=this.config.timeout,t=Date.now();for(;this.activeRequests>=this.config.maxConcurrentRequests;){if(Date.now()-t>e)throw new Error(`Timeout d'attente pour bulkhead ${this.config.name}`);await new Promise((e=>setTimeout(e,10)))}}handleFailure(e){"circuit-breaker"===this.config.fallbackStrategy&&(this.circuitBreakerOpen=!0,this.lastFailureTime=Date.now(),n.vF.warn(`Circuit breaker ouvert pour ${this.config.name}:`,e))}}const N=new class{constructor(){this.bulkheads=new Map,this.metrics=new Map}createBulkhead(e){if(this.bulkheads.has(e.name))return this.bulkheads.get(e.name);const t=new M(e);return this.bulkheads.set(e.name,t),this.metrics.set(e.name,{name:e.name,activeRequests:0,totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0}),n.vF.info(`Bulkhead cr√©√©: ${e.name}`,e),t}async execute(e,t,r){const i=this.bulkheads.get(e);if(!i)throw new Error(`Bulkhead non trouv√©: ${e}`);const s=Date.now();this.updateMetrics(e,"start");try{const r=await i.execute(t),n=Date.now()-s;return this.updateMetrics(e,"success",n),r}catch(t){const r=Date.now()-s;throw this.updateMetrics(e,"error",r,t),t}}updateMetrics(e,t,r,i){const s=this.metrics.get(e);if(s)switch(t){case"start":s.activeRequests++,s.totalRequests++;break;case"success":s.activeRequests--,s.successfulRequests++,r&&(s.averageResponseTime=(s.averageResponseTime*(s.successfulRequests-1)+r)/s.successfulRequests);break;case"error":s.activeRequests--,s.failedRequests++,i&&(s.lastError=i instanceof Error?i.message:String(i),s.lastErrorTime=Date.now())}}getMetrics(){return Array.from(this.metrics.values())}getBulkheadMetrics(e){return this.metrics.get(e)||null}getHealthStatus(){const e={};for(const[t,r]of this.metrics){const i=r.totalRequests>0?r.failedRequests/r.totalRequests:0;i>.5?e[t]="failed":i>.2||r.averageResponseTime>5e3?e[t]="degraded":e[t]="healthy"}return e}};class _{constructor(e=!1){this.encryptionKey=null,this.keyPromise=null,this.setupBulkheads(),e||this.initializeSecureKey()}setupBulkheads(){N.createBulkhead({name:"crypto-operations",maxConcurrentRequests:5,timeout:1e4,fallbackStrategy:"circuit-breaker",retryAttempts:2}),N.createBulkhead({name:"secure-storage",maxConcurrentRequests:10,timeout:5e3,fallbackStrategy:"fail-fast"}),N.createBulkhead({name:"data-anonymization",maxConcurrentRequests:3,timeout:3e3,fallbackStrategy:"retry",retryAttempts:3})}async initializeSecureKey(){this.keyPromise||(this.keyPromise=this.generateSecureKey(),this.encryptionKey=await this.keyPromise)}async generateSecureKey(){if(!C?.subtle)return n.vF.warn("WebCrypto API non disponible - mode d√©veloppement activ√© (NON S√âCURIS√â)"),this.createDevelopmentKey();const e=await this.getStoredKey();if(e)return await C.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"]);const t=await C.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return await this.storeKey(t),t}createDevelopmentKey(){return{type:"secret",extractable:!1,algorithm:{name:"AES-GCM"},usages:["encrypt","decrypt"]}}async getStoredKey(){try{return new Promise((e=>{chrome.storage.local.get(["symbiont_key_v2"],(t=>{if(t.symbiont_key_v2){const r=new Uint8Array(t.symbiont_key_v2);e(r.buffer)}else e(null)}))}))}catch{return null}}async storeKey(e){try{if(!C?.subtle)return void n.vF.warn("Mode d√©veloppement: pas de stockage de cl√© r√©el");const t=await C.subtle.exportKey("raw",e),r=Array.from(new Uint8Array(t));chrome.storage.local.set({symbiont_key_v2:r,symbiont_key_created:Date.now()})}catch(e){n.vF.error("Erreur lors du stockage de la cl√©:",e)}}async ensureKeyReady(){if(this.encryptionKey||await this.initializeSecureKey(),!this.encryptionKey)throw new Error("Impossible d'initialiser la cl√© de chiffrement");return this.encryptionKey}async encryptSensitiveData(e){return N.execute("crypto-operations",(async()=>this._encryptSensitiveData(e)),"encryptSensitiveData")}async _encryptSensitiveData(e){if(!C?.subtle)return n.vF.warn("WebCrypto API non disponible - chiffrement factice pour d√©veloppement"),"DEV_MODE:"+btoa(JSON.stringify(e));try{const t=await this.ensureKeyReady(),r=new TextEncoder,i=C.getRandomValues(new Uint8Array(12)),s=r.encode(JSON.stringify(e)),n=await C.subtle.encrypt({name:"AES-GCM",iv:i},t,s),a=new Uint8Array(i.length+n.byteLength);return a.set(i,0),a.set(new Uint8Array(n),i.length),btoa(String.fromCharCode(...a))}catch(e){throw n.vF.error("Erreur de chiffrement:",e),new Error("√âchec du chiffrement des donn√©es sensibles")}}async decryptSensitiveData(e){return N.execute("crypto-operations",(async()=>this._decryptSensitiveData(e)),"decryptSensitiveData")}async _decryptSensitiveData(e){if("string"!=typeof e)throw new Error("decryptSensitiveData attend une cha√Æne de caract√®res.");if(e.startsWith("DEV_MODE:")){n.vF.warn("D√©chiffrement en mode d√©veloppement (non s√©curis√©)");try{return JSON.parse(atob(e.substring(9)))}catch(e){return n.vF.error("Erreur d√©chiffrement mode d√©veloppement:",e),null}}if(!C?.subtle)return n.vF.warn("WebCrypto API non disponible - d√©chiffrement factice pour d√©veloppement"),null;try{const t=await this.ensureKeyReady(),r=Uint8Array.from(atob(String(e)),(e=>e.charCodeAt(0))),i=r.slice(0,12),s=r.slice(12),n=await C.subtle.decrypt({name:"AES-GCM",iv:i},t,s),a=(new TextDecoder).decode(n);return JSON.parse(a)}catch(e){throw n.vF.error("Erreur de d√©chiffrement:",e),new Error("√âchec du d√©chiffrement des donn√©es - donn√©es corrompues ou cl√© invalide")}}async anonymizeForSharing(e){return N.execute("data-anonymization",(async()=>this._anonymizeForSharing(e)),"anonymizeForSharing")}async _anonymizeForSharing(e){const t={...e};return"url"in t&&(t.url="anonymized"),"userId"in t&&"string"==typeof t.userId&&(t.userId=await this.hash(t.userId)),"id"in t&&"string"==typeof t.id&&(t.id=await this.hash(t.id)),["email","name","address","phone","ip","ssn","creditCard","passport","nationalId","birthDate","age","location","coordinates","biometric","medical","financial","salary"].forEach((e=>{e in t&&delete t[e]})),"timestamp"in t&&"number"==typeof t.timestamp&&(t.timestamp=36e5*Math.floor(t.timestamp/36e5)),t}anonymizeForSharingSync(e){const t={...e};return"url"in t&&(t.url="anonymized"),"userId"in t&&"string"==typeof t.userId&&(t.userId=this.hashSync(t.userId)),"id"in t&&"string"==typeof t.id&&(t.id=this.hashSync(t.id)),t}validateDataAccess(e,t="user"){return!(!e.userId||!e.resource||"admin"===t&&"admin"!==e.role)}async hash(e){if(!C?.subtle){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return btoa(t.toString())}try{const t=(new TextEncoder).encode(e),r=await C.subtle.digest("SHA-256",t),i=new Uint8Array(r);return btoa(String.fromCharCode(...i))}catch(e){throw n.vF.error("Erreur de hashage:",e),new Error("√âchec du hashage s√©curis√©")}}hashSync(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return btoa(t.toString())}}class D{static setDependencies(e){this.dependencies=e}static createOrganism(e,t){if(!this.dependencies)throw new Error("OrganismFactory dependencies not set. Call setDependencies() first.");const{OrganismCore:r}=i(502);return new r(e,t,this.dependencies.createNeuralMesh)}static createNeuralMesh(){const{NeuralMesh:e}=i(194);return new e}}D.dependencies=null;class O{constructor(){this.failureCount=0,this.open=!1,this.lastFailure=0,this.failureThreshold=5,this.recoveryTimeout=3e4}isOpen(){return this.open&&Date.now()-this.lastFailure>this.recoveryTimeout&&(this.open=!1,this.failureCount=0),this.open}recordSuccess(){this.failureCount=0,this.open=!1}recordFailure(){this.failureCount++,this.lastFailure=Date.now(),this.failureCount>=this.failureThreshold&&(this.open=!0)}}class F{constructor(){this.key="symbiont_messages"}async enqueue(e){n.vF.info("[ResilientMessageBus] enqueue",e);const t=JSON.parse(await A.getItem(this.key)||"[]");t.push(e),await A.setItem(this.key,JSON.stringify(t)),n.vF.info("[ResilientMessageBus] enqueue OK",t.length)}async dequeue(){const e=JSON.parse(await A.getItem(this.key)||"[]"),t=e.shift();return await A.setItem(this.key,JSON.stringify(e)),n.vF.info("[ResilientMessageBus] dequeue",t),t}async getAll(){const e=JSON.parse(await A.getItem(this.key)||"[]");return n.vF.info("[ResilientMessageBus] getAll",e.length),e}}const k={getItem:e=>{try{return"undefined"!=typeof localStorage?localStorage.getItem(e):null}catch{return null}},setItem:(e,t)=>{try{"undefined"!=typeof localStorage&&localStorage.setItem(e,t)}catch{}},removeItem:e=>{try{"undefined"!=typeof localStorage&&localStorage.removeItem(e)}catch{}},clear:()=>{try{"undefined"!=typeof localStorage&&localStorage.clear()}catch{}}},x="undefined"!=typeof indexedDB?indexedDB:null;class L{constructor(e,t){this.config=e,this.checkFunction=t}async execute(){return this.checkFunction()}}const U=new class{constructor(){this.checks=new Map,this.results=new Map,this.intervals=new Map,this.isRunning=!1,this.setupDefaultChecks()}setupDefaultChecks(){this.registerCheck("message-bus",{name:"message-bus",interval:3e4,timeout:5e3,retryAttempts:2,criticalLevel:"high"},(async()=>{const e=Date.now();try{return await new Promise((e=>setTimeout(e,50))),{status:"healthy",message:"MessageBus op√©rationnel",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`MessageBus en erreur: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("storage",{name:"storage",interval:6e4,timeout:1e4,retryAttempts:3,criticalLevel:"high"},(async()=>{const e=Date.now();try{const t="health_check_test",r={timestamp:Date.now()};return"undefined"!=typeof chrome&&chrome.storage&&(await new Promise(((e,i)=>{chrome.storage.local.set({[t]:r},(()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):e()}))})),await new Promise(((e,r)=>{chrome.storage.local.get([t],(i=>{chrome.runtime.lastError?r(chrome.runtime.lastError):i&&i[t]?e():r(new Error("Failed to read test value from storage"))}))})),await new Promise(((e,r)=>{chrome.storage.local.remove(t,(()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):e()}))}))),{status:"healthy",message:"Stockage op√©rationnel",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`Stockage en erreur: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("bulkheads",{name:"bulkheads",interval:45e3,timeout:3e3,retryAttempts:1,criticalLevel:"medium"},(async()=>{const e=Date.now();try{const t=N.getHealthStatus(),r=Object.entries(t).filter((([,e])=>"failed"===e));return r.length>0?{status:"warning",message:`Bulkheads d√©grad√©s: ${r.map((([e])=>e)).join(", ")}`,responseTime:Date.now()-e,timestamp:Date.now(),details:{healthStatus:t}}:{status:"healthy",message:"Tous les bulkheads op√©rationnels",responseTime:Date.now()-e,timestamp:Date.now(),details:{healthStatus:t}}}catch(t){return{status:"warning",message:`Erreur check bulkheads: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("security",{name:"security",interval:12e4,timeout:5e3,retryAttempts:2,criticalLevel:"high"},(async()=>{const e=Date.now();try{return"undefined"!=typeof crypto&&void 0!==crypto.subtle?{status:"healthy",message:"S√©curit√© op√©rationnelle",responseTime:Date.now()-e,timestamp:Date.now()}:{status:"critical",message:"WebCrypto API indisponible",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`Erreur s√©curit√©: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}}))}registerCheck(e,t,r){const i=new L(t,r);this.checks.set(e,i),this.isRunning&&this.startCheck(e),n.vF.info(`Health check enregistr√©: ${e}`,t)}start(){if(this.isRunning)n.vF.warn("HealthCheckManager d√©j√† d√©marr√©");else{this.isRunning=!0;for(const e of this.checks.keys())this.startCheck(e);n.vF.info("HealthCheckManager d√©marr√©",{totalChecks:this.checks.size})}}stop(){this.isRunning=!1;for(const[e,t]of this.intervals)clearInterval(t),this.intervals.delete(e);n.vF.info("HealthCheckManager arr√™t√©")}startCheck(e){const t=this.checks.get(e);if(!t)return;this.executeCheck(e);const r=setInterval((()=>{this.executeCheck(e)}),t.config.interval);this.intervals.set(e,r)}async executeCheck(e){const t=this.checks.get(e);if(!t)return;let r,i=0;for(;i<=t.config.retryAttempts;)try{const r=await Promise.race([t.execute(),new Promise(((e,r)=>setTimeout((()=>r(new Error("Timeout"))),t.config.timeout)))]),i={name:e,...r};this.results.set(e,i);const s=this.results.get(e);return void(s&&s.status===r.status||n.vF.info(`Health check ${e}: ${r.status}`,{message:r.message,responseTime:r.responseTime}))}catch(e){r=e,i++,i<=t.config.retryAttempts&&await new Promise((e=>setTimeout(e,1e3*i)))}const s={name:e,status:"high"===t.config.criticalLevel?"critical":"warning",message:`Check √©chou√© apr√®s ${t.config.retryAttempts+1} tentatives: ${r}`,responseTime:t.config.timeout,timestamp:Date.now()};this.results.set(e,s),n.vF.error(`Health check ${e} √©chou√© d√©finitivement`,s)}getSystemHealth(){const e=Array.from(this.results.values()),t=e.length,r=e.filter((e=>"healthy"===e.status)).length,i=e.filter((e=>"critical"===e.status)).length;let s="unknown";return s=0===t?"unknown":i>0?"critical":r===t?"healthy":"degraded",{overallStatus:s,checks:e,lastUpdate:Date.now(),totalChecks:t,healthyChecks:r,criticalChecks:i}}getCheckResult(e){return this.results.get(e)||null}async forceCheck(e){return await this.executeCheck(e),this.getCheckResult(e)}},B=new class{constructor(){this.memoryCache=new Map,this.persistentStorage=chrome.storage?.local,this.indexedDB=null,this.emergencyLocalStorage=k,this.indexedDBReady=this.setupMultiLayerStorage(),this.setupDataReplication(),this.setupIntegrityMonitoring()}async store(e,t){if(e.includes("symbiont_health_alert_"))n.vF.info("[HybridStorageManager] Skipping health alert storage to prevent quota issues");else{n.vF.info("[HybridStorageManager] store - M√©moire",{key:e,data:t}),this.memoryCache.set(e,t);try{await new Promise(((r,i)=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?chrome.runtime.lastError.message?.includes("quota")?(n.vF.warn("[HybridStorageManager] Chrome storage quota exceeded, cleaning old data"),this.cleanOldStorageData().then((()=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):r(!0)}))})).catch(i)):i(chrome.runtime.lastError):r(!0)}))})),n.vF.info("[HybridStorageManager] store - chrome.storage.local OK",e)}catch(t){n.vF.warn("[HybridStorageManager] store - chrome.storage.local failed, fallback IndexedDB",{key:e,error:String(t)})}try{if(await this.indexedDBReady,!this.indexedDB)throw new Error("IndexedDB not ready");await new Promise(((r,i)=>{const s=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(t,e);s.onsuccess=()=>r(!0),s.onerror=()=>i(s.error)})),n.vF.info("[HybridStorageManager] store - IndexedDB OK",e)}catch(r){n.vF.warn("[HybridStorageManager] store - IndexedDB failed, fallback localStorage",{key:e,error:String(r)}),await this.emergencyLocalStorage.setItem(e,JSON.stringify(t)),n.vF.info("[HybridStorageManager] store - localStorage d'urgence OK",e)}}}async retrieve(e){if(this.memoryCache.has(e))return n.vF.info("[HybridStorageManager] retrieve - M√©moire HIT",e),this.memoryCache.get(e);try{const t=await new Promise(((t,r)=>{this.persistentStorage.get([e],(i=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t(i[e])}))}));if(void 0!==t)return this.memoryCache.set(e,t),n.vF.info("[HybridStorageManager] retrieve - chrome.storage.local OK",e),t}catch(t){n.vF.warn("[HybridStorageManager] retrieve - chrome.storage.local failed",{key:e,error:String(t)})}try{if(await this.indexedDBReady,this.indexedDB){const t=await new Promise(((t,r)=>{const i=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(e);i.onsuccess=()=>t(i.result),i.onerror=()=>r(i.error)}));if(void 0!==t)return this.memoryCache.set(e,t),n.vF.info("[HybridStorageManager] retrieve - IndexedDB OK",e),t}}catch(t){n.vF.warn("[HybridStorageManager] retrieve - IndexedDB failed",{key:e,error:String(t)})}try{const t=await this.emergencyLocalStorage.getItem(e);if(t)return n.vF.info("[HybridStorageManager] retrieve - localStorage d'urgence OK",e),JSON.parse(t)}catch(t){n.vF.warn("[HybridStorageManager] retrieve - localStorage d'urgence failed",{key:e,error:String(t)})}return null}setupMultiLayerStorage(){return new Promise((e=>{let t=!1;const r=setTimeout((()=>{t||(n.vF.warn("[HybridStorageManager] IndexedDB init timeout (5s), fallback only"),this.indexedDB=null,t=!0,e(!1))}),5e3);try{const i=x?.open("symbiont-db",1);if(!i)throw new Error("IndexedDB not available");i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("symbiont")||t.createObjectStore("symbiont")},i.onsuccess=()=>{this.indexedDB=i.result,t||(clearTimeout(r),t=!0,n.vF.info("[HybridStorageManager] IndexedDB ready"),e(!0))},i.onerror=()=>{this.indexedDB=null,t||(clearTimeout(r),t=!0,n.vF.warn("[HybridStorageManager] IndexedDB failed to open"),e(!1))}}catch(i){this.indexedDB=null,t||(clearTimeout(r),t=!0,n.vF.warn("[HybridStorageManager] IndexedDB exception",i),e(!1))}}))}async cleanOldStorageData(){try{const e=(await new Promise(((e,t)=>{this.persistentStorage.get(null,(r=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(Object.keys(r))}))}))).filter((e=>e.includes("symbiont_health_alert_")||e.includes("broadcast_")||e.includes("_temp_")));e.length>0&&(await new Promise(((t,r)=>{this.persistentStorage.remove(e,(()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t()}))})),n.vF.info(`[HybridStorageManager] Cleaned ${e.length} old storage items`))}catch(e){n.vF.error("[HybridStorageManager] Failed to clean old storage data:",e)}}isIndexedDBReady(){return!!this.indexedDB}async syncData(){}async syncKeyAcrossLayers(e,t){this.memoryCache.set(e,t);try{await new Promise(((r,i)=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):r(!0)}))}))}catch(e){console.warn("Storage operation failed:",e)}try{await this.indexedDBReady,this.indexedDB&&await new Promise(((r,i)=>{const s=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(t,e);s.onsuccess=()=>r(!0),s.onerror=()=>i(s.error)}))}catch(e){console.warn("Storage operation failed:",e)}try{await this.emergencyLocalStorage.setItem(e,JSON.stringify(t))}catch(e){console.warn("Storage operation failed:",e)}}setupDataReplication(){chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener(((e,t)=>{if("local"===t)for(const t in e){const{newValue:r}=e[t];this.syncKeyAcrossLayers(t,r),n.vF.info("[HybridStorageManager] DataReplication - Synchronisation des couches",t)}}))}setupIntegrityMonitoring(){setInterval((async()=>{for(const e of this.memoryCache.keys())try{const t=this.memoryCache.get(e),r=await new Promise((t=>{this.persistentStorage.get([e],(r=>t(r[e])))}));let i;await this.indexedDBReady,this.indexedDB&&(i=await new Promise((t=>{const r=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(e);r.onsuccess=()=>t(r.result),r.onerror=()=>t(void 0)})));const s=await this.emergencyLocalStorage.getItem(e),a=[t,r,i,s?JSON.parse(s):void 0].filter((e=>void 0!==e));if(!a.every((e=>JSON.stringify(e)===JSON.stringify(a[0])))){n.vF.warn("[HybridStorageManager] IntegrityMonitoring - Divergence d√©tect√©e pour",e);const t={};for(const e of a){const r=JSON.stringify(e);t[r]=(t[r]||0)+1}const[r]=Object.entries(t).sort(((e,t)=>t[1]-e[1]))[0],i=JSON.parse(r);if(this.memoryCache.set(e,i),this.persistentStorage.set({[e]:i}),this.indexedDB){this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(i,e)}this.emergencyLocalStorage.setItem(e,JSON.stringify(i)),n.vF.info("[HybridStorageManager] IntegrityMonitoring - Auto-r√©paration appliqu√©e pour",e)}}catch(t){n.vF.warn("[HybridStorageManager] IntegrityMonitoring - Erreur sur",{key:e,error:String(t)})}}),6e4)}},P=new class{constructor(){this.connectionState="offline",this.messageQueue=new F,this.failureStrategies=new Map,this.circuitBreaker=new O,this.failureQueue=[],this.isConnected=!1,this.connectionAttempts=0,this.setupFailureStrategies()}setupFailureStrategies(){this.failureStrategies.set("ORGANISM_UPDATE",{maxRetries:3,backoffStrategy:"exponential",fallbackAction:this.cacheOrganismState,criticalLevel:"high"}),this.failureStrategies.set("INTERACTION_DETECTED",{maxRetries:5,backoffStrategy:"linear",fallbackAction:this.queueForLaterSync,criticalLevel:"medium"}),this.failureStrategies.set("PAGE_ANALYSIS_COMPLETE",{maxRetries:2,backoffStrategy:"immediate",fallbackAction:this.processLocally,criticalLevel:"low"})}async send(e){if(this.circuitBreaker.isOpen())return await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:"Circuit breaker open"};let t=0;const r=this.failureStrategies.get(e.type),i=r?.maxRetries||2;for(;t<=i;)try{return await this.simulateSend(e),this.circuitBreaker.recordSuccess(),{success:!0}}catch(s){if(this.circuitBreaker.recordFailure(),t++,t>i)return r&&await r.fallbackAction.call(this,e),await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:s};await this.wait(this.getBackoff(r?.backoffStrategy,t))}return{success:!1,queued:!0,error:"Unknown error"}}async simulateSend(e){return{success:!0,id:`sim_${Date.now()}`}}getBackoff(e="immediate",t){return"exponential"===e?500*Math.pow(2,t):"linear"===e?500*t:0}wait(e){return new Promise((t=>setTimeout(t,e)))}async cacheOrganismState(e){n.vF.info("[ResilientMessageBus] fallback cacheOrganismState",e),await A.setItem("symbiont_organism_cache",JSON.stringify(e))}async queueForLaterSync(e){n.vF.info("[ResilientMessageBus] fallback queueForLaterSync",e),await this.messageQueue.enqueue(e)}async processLocally(e){n.vF.info("[ResilientMessageBus] fallback processLocally",e),await A.setItem("symbiont_local_processing",JSON.stringify(e))}_attemptConnection(){return Promise.resolve(!0)}_processMessage(e){}};async function G(e){return await B.retrieve(e)}async function V(e,t){await B.store(e,t)}new class{constructor(e){this.metrics={cpu:[],memory:[],latency:[],errors:0},this.alertCallback=null,this.lastAlerts=new Map,this.alertCooldown=3e4,e&&(this.alertCallback=e),this.setupMonitoring()}setupMonitoring(){setInterval((()=>{this.collectMetrics(),this.checkHealth()}),3e4)}collectMetrics(){const e=.2*m.Dm.random(),t=20*m.Dm.random(),r=5*m.Dm.random();this.metrics.cpu.push(e),this.metrics.memory.push(t),this.metrics.latency.push(r),this.metrics.cpu.length>20&&this.metrics.cpu.shift(),this.metrics.memory.length>20&&this.metrics.memory.shift(),this.metrics.latency.length>20&&this.metrics.latency.shift()}checkHealth(){const e=e=>e.reduce(((e,t)=>e+t),0)/(e.length||1),t=e(this.metrics.cpu),r=e(this.metrics.memory),i=e(this.metrics.latency);t>.5&&this.alert("CPU √©lev√© : "+t.toFixed(3)),r>50&&this.alert("M√©moire √©lev√©e : "+r.toFixed(2)+"MB"),i>10&&this.alert("Latence √©lev√©e : "+i.toFixed(2)+"ms"),this.metrics.errors>5&&this.alert("Erreurs d√©tect√©es : "+this.metrics.errors)}logError(){this.metrics.errors++}alert(e){const t=e.split(":")[0],r=Date.now(),i=this.lastAlerts.get(t);(!i||r-i>this.alertCooldown)&&(n.vF.warn("üõë [HealthMonitor]",e),this.lastAlerts.set(t,r),this.alertCallback&&this.alertCallback(e))}}((async e=>{await B.store("symbiont_health_alert_"+Date.now(),{msg:e,timestamp:Date.now()})})),(async()=>{const e={type:"ORGANISM_UPDATE",payload:{state:{id:"demo",traits:{focus:1}},timestamp:Date.now()}};(await P.send(e)).success||n.vF.warn("Message ORGANISM_UPDATE fallback, voir la queue persistante.")})();let z=null;z=new class{constructor(){this.organism=null,this.activated=!1,this.events=[],this.collectiveThresholds=[10,50,100,250,500],this.reachedThresholds=[],this.security=new _,this.messageBus=new u("background"),this.storage=new d,this.invitationService=new E(this.storage),this.murmureService=new b,this._organismFactory=new D,G("symbiont_collective_thresholds").then((e=>{this.reachedThresholds=e?JSON.parse(e):[],this.initialize()}))}async initialize(){let e=!1;try{n.vF.info("Initializing storage...");try{await this.storage.initialize(),e=!0,n.vF.info("Storage initialized successfully")}catch(t){const r={errorType:t instanceof Error?t.constructor.name:typeof t,errorMessage:t instanceof Error?t.message:String(t),errorStack:t instanceof Error?t.stack:void 0,timestamp:Date.now()};n.vF.error("CRITICAL: Storage initialization failed, entering degraded mode",r);try{await B.store("symbiont_init_error_"+Date.now(),r)}catch(e){n.vF.error("Failed to log error to hybrid storage:",e)}"undefined"!=typeof chrome&&chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"SYMBIONT Storage Error",message:"Failed to initialize storage. Running in limited mode.",priority:2}),this.organism=null,e=!1}if(this.activated="true"===await G("symbiont_activated"),this.activated&&e)try{n.vF.info("Loading organism from storage..."),this.organism=await this.storage.getOrganism(),this.organism?n.vF.info("Organism loaded successfully",{id:this.organism.id}):(n.vF.info("No organism found, creating new one..."),this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism),n.vF.info("New organism created and saved"))}catch(e){n.vF.error("Failed to load/create organism:",e),this.organism=this.createNewOrganism(),n.vF.warn("Created organism in memory only (storage unavailable)")}else this.activated&&!e?(this.organism=this.createNewOrganism(),n.vF.warn("Storage unavailable - organism created in memory only")):(this.organism=null,n.vF.info("Symbiont not activated, skipping organism creation"));this.setupMessageHandlers(e),this.startPeriodicTasks(e),U.start(),n.vF.info("Background service initialized",{healthCheckActive:!0,bulkheadManagerActive:!0,organismLoaded:!!this.organism,activated:this.activated})}catch(e){n.vF.error("Failed to initialize background service:",e);try{this.setupMessageHandlers()}catch(e){n.vF.error("Failed to setup message handlers:",e)}}}createNewOrganism(){const e=this.generateVisualDNA();return{id:(0,s.lk)(),generation:1,health:100,energy:100,traits:{curiosity:100*m.Dm.random(),focus:100*m.Dm.random(),rhythm:100*m.Dm.random(),empathy:100*m.Dm.random(),creativity:100*m.Dm.random(),resilience:100*m.Dm.random(),adaptability:100*m.Dm.random(),memory:100*m.Dm.random(),intuition:100*m.Dm.random()},visualDNA:e,lastMutation:Date.now(),mutations:[],createdAt:Date.now(),dna:e,birthTime:Date.now(),socialConnections:[],memoryFragments:[]}}generateVisualDNA(){let e="";for(let t=0;t<64;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*m.Dm.random()));return e}isStorageReady(){return null!==this.storage.db&&void 0!==this.storage.db}setupMessageHandlers(t=!1){this.messageBus.on(e.PAGE_VISIT,(async e=>{const{url:t,title:r}=e.payload;if(this.isStorageReady())try{const e=await this.storage.getBehavior(t)||{url:t,visitCount:0,totalTime:0,scrollDepth:0,lastVisit:Date.now(),interactions:[]};e.visitCount++,e.lastVisit=Date.now(),await this.storage.saveBehavior(e)}catch(e){n.vF.error("Failed to save behavior data:",e)}this.events.push({type:"visit",timestamp:Date.now(),url:t}),this.updateOrganismTraits(t,r),this.analyzeContextualPatterns()})),this.messageBus.on(e.SCROLL_EVENT,(async e=>{const{url:t,scrollDepth:r}=e.payload;if(this.isStorageReady())try{const e=await this.storage.getBehavior(t);e&&(e.scrollDepth=Math.max(e.scrollDepth,r),await this.storage.saveBehavior(e))}catch(e){n.vF.error("Failed to update scroll depth:",e)}this.events.push({type:"scroll",timestamp:Date.now(),url:t}),this.analyzeContextualPatterns()})),this.messageBus.on(e.INTERACTION_DETECTED,(e=>{const{type:t,timestamp:r,target:i,data:s}=e.payload;this.events.push({type:t,timestamp:r,target:i,...s}),this.analyzeContextualPatterns()})),this.messageBus.on(e.GET_HEALTH_METRICS,(async t=>{try{const r={systemHealth:U.getSystemHealth(),bulkheadMetrics:N.getMetrics(),timestamp:Date.now()};t.sender&&this.messageBus.emit(e.HEALTH_METRICS_RESPONSE,{payload:r,requestId:t.requestId})}catch(e){n.vF.error("Erreur r√©cup√©ration m√©triques sant√©:",e)}})),this.messageBus.on(e.GENERATE_INVITATION,(async t=>{if(!this.isStorageReady())return n.vF.warn("Storage not initialized, cannot generate invitation"),void await P.send({type:e.INVITATION_GENERATED,payload:{error:"Database not initialized"}});try{const{donorId:r}=t.payload,i=await this.invitationService.generateInvitation(r),s={code:i.code,createdAt:i.createdAt,consumed:i.used??!1,inviter:i.donorId,...i.usedAt&&{consumedAt:i.usedAt},...i.receiverId&&{invitee:i.receiverId}};let n=s;try{n=await this.security.encryptSensitiveData(s)}catch(e){n=s}await P.send({type:e.INVITATION_GENERATED,payload:n})}catch(t){n.vF.error("Failed to generate invitation:",t),await P.send({type:e.INVITATION_GENERATED,payload:{error:t instanceof Error?t.message:"Unknown error"}})}})),this.messageBus.on(e.CONSUME_INVITATION,(async t=>{if(!this.isStorageReady())return n.vF.warn("Storage not initialized, cannot consume invitation"),void await P.send({type:e.INVITATION_CONSUMED,payload:{error:"Database not initialized"}});try{const{code:r,receiverId:i,role:s}=t.payload;if(!this.security.validateDataAccess({userId:i,resource:r,role:s},"user"))return void P.send({type:e.INVITATION_CONSUMED,payload:{error:"Acc√®s refus√©."}});const n=await this.invitationService.consumeInvitation(r,i);n&&(this.activated=!0,await V("symbiont_activated","true"),this.organism||(this.organism=this.createNewOrganism(),this.isStorageReady()&&await this.storage.saveOrganism(this.organism))),P.send({type:e.INVITATION_CONSUMED,payload:n})}catch(t){n.vF.error("Failed to consume invitation:",t),await P.send({type:e.INVITATION_CONSUMED,payload:{error:t instanceof Error?t.message:"Unknown error"}})}})),this.messageBus.on(e.CHECK_INVITATION,(async t=>{if(!this.isStorageReady())return n.vF.warn("Storage not initialized, cannot check invitation"),void await P.send({type:e.INVITATION_CHECKED,payload:{code:t.payload?.code,valid:!1,error:"Database not initialized"}});try{const{code:r}=t.payload,i=await this.invitationService.isValid(r);P.send({type:e.INVITATION_CHECKED,payload:{code:r,valid:i}})}catch(r){n.vF.error("Failed to check invitation:",r),await P.send({type:e.INVITATION_CHECKED,payload:{code:t.payload?.code,valid:!1,error:r instanceof Error?r.message:"Unknown error"}})}})),this.messageBus.on(e.GET_INVITER,(async t=>{if(!this.isStorageReady())return n.vF.warn("Storage not initialized, cannot get inviter"),void await P.send({type:e.INVITER_RESULT,payload:null});try{const{userId:r}=t.payload,i=(await this.invitationService.getAllInvitations()).find((e=>e.receiverId===r));P.send({type:e.INVITER_RESULT,payload:i||null})}catch(t){n.vF.error("Failed to get inviter:",t),await P.send({type:e.INVITER_RESULT,payload:null})}})),this.messageBus.on(e.GET_INVITEES,(async t=>{if(!this.isStorageReady())return n.vF.warn("Storage not initialized, cannot get invitees"),void await P.send({type:e.INVITEES_RESULT,payload:[]});try{const{userId:r}=t.payload,i=(await this.invitationService.getAllInvitations()).filter((e=>e.donorId===r));P.send({type:e.INVITEES_RESULT,payload:i})}catch(t){n.vF.error("Failed to get invitees:",t),await P.send({type:e.INVITEES_RESULT,payload:[]})}})),this.messageBus.on(e.GET_INVITATION_HISTORY,(async t=>{if(!this.isStorageReady())return n.vF.warn("Storage not initialized, cannot get invitation history"),void await P.send({type:e.INVITATION_HISTORY_RESULT,payload:[]});try{const{userId:r}=t.payload,i=await this.invitationService.getAllInvitations(),s=[...i.filter((e=>e.receiverId===r)).map((e=>({...e,type:"re√ßue"}))),...i.filter((e=>e.donorId===r)).map((e=>({...e,type:"envoy√©e"})))];P.send({type:e.INVITATION_HISTORY_RESULT,payload:s})}catch(t){n.vF.error("Failed to get invitation history:",t),await P.send({type:e.INVITATION_HISTORY_RESULT,payload:[]})}}));const r=new Map;this.messageBus.on(e.REQUEST_SHARED_MUTATION,(t=>{const{initiatorId:i,traits:s}=t.payload,n=m.Dm.random().toString(36).substr(2,6).toUpperCase(),a=Date.now()+3e5;r.set(n,{initiatorId:i,traits:s,expiresAt:a}),P.send({type:e.SHARED_MUTATION_CODE,payload:{code:n,initiatorId:i,expiresAt:a}})})),this.messageBus.on(e.ACCEPT_SHARED_MUTATION,(async t=>{const{code:i,receiverId:s,traits:n,role:a}=t.payload;if(!this.security.validateDataAccess({userId:s,resource:i,role:a},"user"))return void P.send({type:e.SHARED_MUTATION_RESULT,payload:{error:"Acc√®s refus√©."}});const o=r.get(i);if(!o||o.expiresAt<Date.now())return void P.send({type:e.SHARED_MUTATION_RESULT,payload:{error:"Code expir√© ou invalide."}});const c={...o.traits};for(const e of Object.keys(n))c[e]=(c[e]??0+n[e]??0)/2;r.delete(i);let l={initiatorId:o.initiatorId,receiverId:s,mergedTraits:c,timestamp:Date.now()};try{l=await this.security.encryptSensitiveData(l)}catch(e){}P.send({type:e.SHARED_MUTATION_RESULT,payload:l})}));const i=new Set;let s=null;this.messageBus.on(e.COLLECTIVE_WAKE_REQUEST,(t=>{const{userId:r}=t.payload;i.add(r),s||(s=setTimeout((()=>{P.send({type:e.COLLECTIVE_WAKE_RESULT,payload:{participants:Array.from(i),triggeredAt:Date.now()}}),i.clear(),s=null}),1e4))}));const a=async t=>{const r={code:"TEMP_CODE",donorId:await G("symbiont_user_id")||"unknown",symbolicLink:"",used:!1,createdAt:Date.now()};await P.send({type:e.CONTEXTUAL_INVITATION,payload:{invitation:r,context:t}})},o=this.generateMutation.bind(this);this.generateMutation=()=>{const e=o();return"cognitive"===e.type&&a("mutation_cognitive"),e};const c=this.updateOrganismTraits.bind(this);this.updateOrganismTraits=async(e,t)=>{await c(e,t),this.organism&&this.organism.traits.curiosity>90&&await a("curiosity_threshold")};let l=Date.now();chrome.idle.onStateChanged.addListener((e=>{"idle"===e?l=Date.now():"active"===e&&Date.now()-l>18e5&&a("long_inactivity")}));const h=["SYMBIOSE","AWAKEN","ECHO"];this.messageBus.on(e.SECRET_CODE_ENTERED,(t=>{const{code:r}=t.payload;h.includes(r.toUpperCase())&&P.send({type:e.SECRET_RITUAL_TRIGGERED,payload:{code:r,effect:"mutation_unique",timestamp:Date.now()}})}))}async updateOrganismTraits(t,r){if(!this.organism)return;const i=t.toLowerCase(),s=r.toLowerCase();(i.includes("github")||i.includes("stackoverflow")||i.includes("codepen")||i.includes("dribbble"))&&(this.organism.traits.creativity+=.5),(i.includes("docs")||i.includes("wiki")||i.includes("tutorial")||s.includes("guide"))&&(this.organism.traits.focus+=.3),(i.includes("twitter")||i.includes("linkedin")||i.includes("facebook")||i.includes("reddit"))&&(this.organism.traits.empathy+=.4);const a=new URL(t).hostname;if(!await this.hasVisitedDomain(a)&&(this.organism.traits.curiosity+=1),!this.organism)return;const o=this.organism.traits;if(!o)return;if(Object.keys(o).forEach((e=>{o[e]=Math.max(0,Math.min(100,o[e]))})),await this.checkForMutations(),this.isStorageReady())try{await this.storage.saveOrganism(this.organism)}catch(e){n.vF.error("Failed to save organism:",e)}let c="default";if(await this.isLoop(t)?c="loop":await this.isIdle()?c="idle":await this.isExploration(t)?c="exploration":await this.isRoutine(t)&&(c="routine"),!this.organism)return;const l=this.organism;await P.send({type:e.ORGANISM_UPDATE,payload:{state:l,mutations:await this.storage.getRecentMutations(5)}});const h=this.murmureService.generateMurmur(c);await P.send({type:e.MURMUR,payload:{text:h,pattern:c,timestamp:Date.now()}})}async hasVisitedDomain(e){return(await chrome.tabs.query({})).some((t=>t.url&&new URL(t.url).hostname===e))}async checkForMutations(){if(!this.organism)return;const e=this.organism,t=Date.now(),r=t-(e.lastMutation??0),i=Math.min(.5,r/36e5);if(m.Dm.random()<i){const r=this.generateMutation();if(this.isStorageReady())try{await this.storage.addMutation(r)}catch(e){n.vF.error("Failed to save mutation:",e)}e.lastMutation=t,this.applyMutation(r)}}generateMutation(){const e=["visual","behavioral","cognitive"],t=e[Math.floor(m.Dm.random()*e.length)];return{type:t,trigger:this.getMutationTrigger(t),magnitude:.5*m.Dm.random()+.1,timestamp:Date.now()}}getMutationTrigger(e){const t={visual:["color_shift","pattern_change","size_fluctuation","opacity_variation"],behavioral:["navigation_speed","content_preference","interaction_pattern"],cognitive:["memory_retention","pattern_recognition","association_strength"]}[e];return t[Math.floor(m.Dm.random()*t.length)]}applyMutation(e){if(this.organism)switch(e.type){case"visual":this.organism.visualDNA=this.mutateVisualDNA(this.organism.visualDNA??"",e.magnitude);break;case"behavioral":{const t=Object.keys(this.organism.traits),r=t[Math.floor(m.Dm.random()*t.length)];this.organism.traits[r]+=(m.Dm.random()-.5)*e.magnitude*20;break}case"cognitive":{if(!this.organism)return;const t=this.organism.traits;if(!t)return;Object.keys(t).forEach((r=>{t[r]+=(m.Dm.random()-.5)*e.magnitude*5}));break}}}mutateVisualDNA(e,t){const r=Math.floor(e.length*t),i=e.split("");for(let t=0;t<r;t++)i[Math.floor(m.Dm.random()*e.length)]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*m.Dm.random()));return i.join("")}startPeriodicTasks(t=!1){setInterval((()=>{this.organism&&(this.organism.health??0)>0&&(this.organism.health=Math.max(0,(this.organism.health??0)-.1),this.organism.energy=Math.max(0,(this.organism.energy??0)-.05))}),6e4),setInterval((async()=>{if(this.organism&&this.isStorageReady())try{await this.storage.saveOrganism(this.organism);const t=await this.storage.getRecentMutations(5);await P.send({type:e.ORGANISM_UPDATE,payload:{state:this.organism,mutations:t}})}catch(e){n.vF.error("Failed to perform periodic sync:",e)}}),3e4)}async isLoop(e){if(!this.isStorageReady())return!1;try{const t=await this.storage.getBehavior(e);return!!t&&t.visitCount>=3}catch(e){return n.vF.error("Failed to check loop pattern:",e),!1}}async isIdle(){return!1}async isExploration(e){if(!this.isStorageReady())return!1;try{const t=await this.storage.getBehavior(e);return!!t&&t.visitCount<=1}catch(e){return n.vF.error("Failed to check exploration pattern:",e),!1}}async isRoutine(e){if(!this.isStorageReady())return!1;try{const t=await this.storage.getBehavior(e);return!!t&&Date.now()-t.lastVisit<1728e5}catch(e){return n.vF.error("Failed to check routine pattern:",e),!1}}async analyzeContextualPatterns(){const e=Date.now();this.events=this.events.filter((t=>e-t.timestamp<18e5)),I.detectBurst(this.events,1e4,5).length>0?this.triggerContextualInvitation("burst_activity"):I.detectTemporalPattern(this.events,6e4,.15).length>0?this.triggerContextualInvitation("temporal_cycle"):I.detectAlternance(this.events,"visit","scroll",6).length>0?this.triggerContextualInvitation("alternance_nav_scroll"):I.detectRepetition(this.events,7).length>0?this.triggerContextualInvitation("repetition_action"):this.checkCollectiveThreshold()}async checkCollectiveThreshold(){if(this.isStorageReady())try{const e=(await this.invitationService.getAllInvitations()).length;for(const t of this.collectiveThresholds)if(e>=t&&!this.reachedThresholds.includes(t)){this.reachedThresholds.push(t),await V("symbiont_collective_thresholds",JSON.stringify(this.reachedThresholds)),await this.triggerContextualInvitation("collective_threshold_"+t);break}}catch(e){n.vF.error("Failed to check collective threshold:",e)}else n.vF.debug("Storage not ready, skipping collective threshold check")}async triggerContextualInvitation(t){if(this.isStorageReady())try{const r=await G("symbiont_user_id")||"unknown",i=await this.invitationService.generateInvitation(r);await P.send({type:e.CONTEXTUAL_INVITATION,payload:{invitation:i,context:t}})}catch(e){n.vF.error("Failed to generate contextual invitation:",e)}else n.vF.warn("Storage not initialized, skipping contextual invitation generation",{context:t})}dispose(){try{U.stop(),this.events=[],n.vF.info("BackgroundService disposed successfully")}catch(e){n.vF.error("Erreur lors du dispose du BackgroundService:",e)}}},globalThis._backgroundService=z,new class{constructor(){this.peers=new Set,this.organismState=null,this.peerId="peer_"+m.Dm.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_network"),this.channel.onmessage=e=>this.handleMessage(e.data),this.announce()}announce(){this.channel.postMessage({type:"announce",peerId:this.peerId})}joinNetwork(e){this.peers.add(e),this.channel.postMessage({type:"join",peerId:this.peerId}),n.vF.info(`[Network] Pair rejoint : ${e}`)}leaveNetwork(e){this.peers.delete(e),this.channel.postMessage({type:"leave",peerId:this.peerId}),n.vF.info(`[Network] Pair quitt√© : ${e}`)}broadcastMutation(e){this.channel.postMessage({type:"mutation",from:this.peerId,mutation:e}),n.vF.info(`[Network] Diffusion mutation √† ${this.peers.size} pairs`)}receiveMutation(e,t){n.vF.info(`[Network] Mutation re√ßue de ${t}`,e)}performCommunityBackup(e){this.channel.postMessage({type:"backup",from:this.peerId,state:e}),n.vF.info("[Network] Backup communautaire lanc√©")}handleMessage(e){if(e.peerId!==this.peerId)switch(e.type){case"announce":case"join":this.peers.add(e.peerId);break;case"leave":this.peers.delete(e.peerId);break;case"mutation":this.receiveMutation(e.mutation,e.from);break;case"backup":n.vF.info(`[Network] Backup re√ßu de ${e.from}`,e.state)}}},new class{constructor(e){this.proposals=new Map,this.votes=new Map,this.onCollectiveMutation=null,this.peerId="peer_"+m.Dm.random().toString(36).substr(2,8),e&&(this.onCollectiveMutation=e)}proposeMutation(e,t){this.proposals.has(e.id)||(this.proposals.set(e.id,[]),this.votes.set(e.id,new Set)),this.proposals.get(e.id).push({mutation:e,proposerId:t}),this.vote(e.id,t),n.vF.info(`[Collective] Mutation propos√©e par ${t}`)}vote(e,t){this.votes.has(e)||this.votes.set(e,new Set),this.votes.get(e).add(t),n.vF.info(`[Collective] Vote de ${t} pour mutation ${e}`)}aggregateVotes(e){return this.votes.get(e)?.size||0}triggerCollectiveMutation(e,t){const r=this.aggregateVotes(e);return r>Math.max(1,Math.floor(t/2))?(n.vF.info(`[Collective] Mutation collective d√©clench√©e : ${e}`),this.onCollectiveMutation&&this.onCollectiveMutation(e),!0):(n.vF.info(`[Collective] Consensus non atteint pour ${e} (${r}/${t})`),!1)}},new class{constructor(){this.peerId="peer_"+m.Dm.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_resilience"),this.channel.onmessage=e=>this.handleMessage(e.data)}requestCommunityBackup(e){this.channel.postMessage({type:"backup_request",from:this.peerId,organismId:e}),n.vF.info(`[SocialResilience] Demande de backup pour ${e}`)}restoreFromCommunity(e){n.vF.info(`[SocialResilience] Restauration depuis la communaut√© pour ${e}`)}detectMassiveFailure(){n.vF.info("[SocialResilience] D√©tection de panne massive")}launchCommunityAlert(e){this.channel.postMessage({type:"alert",from:this.peerId,message:e}),n.vF.info(`[SocialResilience] Alerte communautaire : ${e}`)}handleMessage(e){if(e.from!==this.peerId)switch(e.type){case"backup_request":n.vF.info(`[SocialResilience] Backup demand√© par ${e.from} pour ${e.organismId}`);break;case"alert":n.vF.info(`[SocialResilience] Alerte re√ßue : ${e.message}`)}}},new class{constructor(){this.peerId="peer_"+m.Dm.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_mystical"),this.channel.onmessage=e=>this.handleMessage(e.data)}triggerMysticalEvent(e,t){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:e,payload:t}),n.vF.info(`[MysticalEvents] √âv√©nement mystique d√©clench√© : ${e}`)}propagateToCommunity(e,t){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:e,payload:t}),n.vF.info(`[MysticalEvents] Propagation √† la communaut√© : ${e}`)}applySpecialEffect(e){n.vF.info(`[MysticalEvents] Effet sp√©cial appliqu√© : ${e}`)}handleMessage(e){e.from!==this.peerId&&"mystical"===e.type&&this.applySpecialEffect(`Effet mystique re√ßu : ${e.eventId}`)}}})();