var e,t,s,a={},i={};function r(e){var t=i[e];if(void 0!==t)return t.exports;var s=i[e]={exports:{}};return a[e](s,s.exports,r),s.exports}r.m=a,r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>"background/"+e+".index.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e={792:0},t=t=>{var s,a,{__webpack_ids__:i,__webpack_modules__:n,__webpack_runtime__:o}=t,c=0;for(s in n)r.o(n,s)&&(r.m[s]=n[s]);for(o&&o(r);c<i.length;c++)a=i[c],r.o(e,a)&&e[a]&&e[a][0](),e[i[c]]=0},r.f.j=(s,a)=>{var i=r.o(e,s)?e[s]:void 0;if(0!==i)if(i)a.push(i[1]);else{var n=import("../"+r.u(s)).then(t,(t=>{throw 0!==e[s]&&(e[s]=void 0),t}));n=Promise.race([n,new Promise((t=>i=e[s]=[t]))]),a.push(i[1]=n)}},function(e){e.PAGE_VISIT="PAGE_VISIT",e.SCROLL_EVENT="SCROLL_EVENT",e.ORGANISM_UPDATE="ORGANISM_UPDATE",e.ORGANISM_MUTATE="ORGANISM_MUTATE",e.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",e.WEBGL_INIT="WEBGL_INIT",e.WEBGL_ERROR="WEBGL_ERROR",e.WEBGL_INITIALIZED="WEBGL_INITIALIZED",e.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",e.GENERATE_INVITATION="GENERATE_INVITATION",e.INVITATION_GENERATED="INVITATION_GENERATED",e.CONSUME_INVITATION="CONSUME_INVITATION",e.INVITATION_CONSUMED="INVITATION_CONSUMED",e.CHECK_INVITATION="CHECK_INVITATION",e.INVITATION_CHECKED="INVITATION_CHECKED",e.MURMUR="MURMUR",e.GET_INVITER="GET_INVITER",e.INVITER_RESULT="INVITER_RESULT",e.GET_INVITEES="GET_INVITEES",e.INVITEES_RESULT="INVITEES_RESULT",e.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",e.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",e.INTERACTION_DETECTED="INTERACTION_DETECTED",e.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",e.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",e.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",e.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",e.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",e.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",e.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",e.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",e.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED"}(s||(s={}));class n{constructor(e){}on(e,t){}send(e){}subscribe(e,t){this.on(e,t)}}class o{constructor(){this.db=null,this.DB_NAME="symbiont-db",this.DB_VERSION=2}async initialize(){return new Promise(((e,t)=>{const s=indexedDB.open(this.DB_NAME,this.DB_VERSION);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=e=>{const t=e.target.result;if(t.objectStoreNames.contains("organism")||t.createObjectStore("organism",{keyPath:"id"}),!t.objectStoreNames.contains("behaviors")){const e=t.createObjectStore("behaviors",{keyPath:"url"});e.createIndex("visitCount","visitCount",{unique:!1}),e.createIndex("lastVisit","lastVisit",{unique:!1})}if(!t.objectStoreNames.contains("mutations")){const e=t.createObjectStore("mutations",{autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"key"}),t.objectStoreNames.contains("invitations")||t.createObjectStore("invitations",{keyPath:"code"})}}))}async getOrganism(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const s=this.db.transaction(["organism"],"readonly").objectStore("organism").get("current");s.onsuccess=()=>e(s.result||null),s.onerror=()=>t(s.error)}))}async saveOrganism(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["organism"],"readwrite").objectStore("organism").put({...e,id:"current"});a.onsuccess=()=>t(),a.onerror=()=>s(a.error)}))}async getBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").get(e);a.onsuccess=()=>t(a.result||null),a.onerror=()=>s(a.error)}))}async saveBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["behaviors"],"readwrite").objectStore("behaviors").put(e);a.onsuccess=()=>t(),a.onerror=()=>s(a.error)}))}async addMutation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").add(e);a.onsuccess=()=>t(),a.onerror=()=>s(a.error)}))}async getRecentMutations(e=10){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["mutations"],"readonly").objectStore("mutations").index("timestamp").openCursor(null,"prev"),i=[];a.onsuccess=s=>{const a=s.target.result;a&&i.length<e?(i.push(a.value),a.continue()):t(i)},a.onerror=()=>s(a.error)}))}async getSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((s,a)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{const e=i.result;s(e?e.value:t)},i.onerror=()=>a(i.error)}))}async setSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((s,a)=>{const i=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:e,value:t});i.onsuccess=()=>s(),i.onerror=()=>a(i.error)}))}async addInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").add(e);a.onsuccess=()=>t(),a.onerror=()=>s(a.error)}))}async updateInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").put(e);a.onsuccess=()=>t(),a.onerror=()=>s(a.error)}))}async getInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,s)=>{const a=this.db.transaction(["invitations"],"readonly").objectStore("invitations").get(e);a.onsuccess=()=>t(a.result||null),a.onerror=()=>s(a.error)}))}async getAllInvitations(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const s=this.db.transaction(["invitations"],"readonly").objectStore("invitations").openCursor(),a=[];s.onsuccess=t=>{const s=t.target.result;s?(a.push(s.value),s.continue()):e(a)},s.onerror=()=>t(s.error)}))}async getBehaviorPatterns(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const s=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),a=[];s.onsuccess=t=>{const s=t.target.result;s?(a.push(s.value),s.continue()):(a.sort(((e,t)=>t.visitCount!==e.visitCount?t.visitCount-e.visitCount:t.lastVisit-e.lastVisit)),e(a))},s.onerror=()=>t(s.error)}))}async getRecentActivity(e=864e5){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-e;return new Promise(((e,s)=>{const a=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),i=[];a.onsuccess=s=>{const a=s.target.result;if(a){const e=a.value,s=(e.interactions||[]).filter((e=>e.timestamp>=t));for(const t of s)i.push({...t,url:e.url});a.continue()}else i.sort(((e,t)=>t.timestamp-e.timestamp)),e(i)},a.onerror=()=>s(a.error)}))}}class c{constructor(e){this.handler=null}observe(e){this.handler=e}disconnect(){this.handler=null}}class l{constructor(e){this.storage=e}async generateInvitation(e){const t={code:(await r.e(221).then(r.bind(r,221))).v4().slice(0,8).toUpperCase(),donorId:e,symbolicLink:this.generateSymbolicLink(),used:!1,createdAt:Date.now()};return await this.storage.addInvitation(t),t}async consumeInvitation(e,t){const s=await this.storage.getInvitation(e);return!s||s.used?null:(s.used=!0,s.receiverId=t,s.usedAt=Date.now(),await this.storage.updateInvitation(s),s)}async isValid(e){const t=await this.storage.getInvitation(e);return!!t&&!t.used}generateSymbolicLink(){const e=["#FF00FF","#00FFFF","#FFFF00","#FF8800","#00FF88","#8800FF"];return e[Math.floor(Math.random()*e.length)]}async getAllInvitations(){return await this.storage.getAllInvitations()}}const h={loop:["Encore ce m√™me chemin... Qu'y cherches-tu ?","La boucle se r√©p√®te, intention ou habitude ?","Revenir, encore et encore. Un besoin de rep√®re ?"],idle:["Un temps de pause... ou d'h√©sitation ?","Le silence aussi fait partie du voyage.","L'inactivit√©, pr√©lude √† une nouvelle exploration ?"],exploration:["Nouveau territoire, nouvelle perspective.","L'exploration nourrit la curiosit√©.","Tu t'aventures hors des sentiers battus."],routine:["Les habitudes forgent des chemins familiers.","La routine rassure, mais l'inattendu surprend.","Encore ce site, comme un rituel quotidien."],default:["Tu reviens souvent ici quand tu doutes.","Pourquoi cette boucle ?","As-tu remarqu√© ce sch√©ma dans ta navigation ?","Un autre d√©tour, ou une qu√™te de sens ?","Ce site semble t'attirer dans les moments de r√©flexion.","Encore une fois, tu explores ce chemin familier.","Et si tu essayais une nouvelle direction ?","La r√©p√©tition cache-t-elle une intention ?","Un murmure dans le flux de tes habitudes...","Parfois, la boucle est une porte vers l'inattendu."]},u={morning:["Un nouveau jour, une nouvelle boucle commence.","Le matin invite √† la d√©couverte.","L'aube de tes habitudes num√©riques."],afternoon:["L'apr√®s-midi, la routine s'installe.","Un moment propice √† l'exploration ou √† la r√©p√©tition ?","Le soleil haut, l'esprit vagabonde."],evening:["Le soir, tu reviens √† l'essentiel.","La nuit favorise les d√©tours int√©rieurs.","Encore connect√©, m√™me √† la tomb√©e du jour."],weekend:["Le week-end, les chemins changent.","Un rythme diff√©rent, des envies nouvelles.","La libert√© du week-end se lit dans ta navigation."]};class d{generateMurmur(e){if(function(){const e=(new Date).getDay();return 0===e||6===e}()){const e=u.weekend;if(Math.random()<.5)return e[Math.floor(Math.random()*e.length)]}else{const e=function(){const e=(new Date).getHours();return e<12?"morning":e<18?"afternoon":"evening"}();if(u[e]&&Math.random()<.4){const t=u[e];return t[Math.floor(Math.random()*t.length)]}}const t=e&&h[e]?h[e]:h.default;return t[Math.floor(Math.random()*t.length)]}}class m{static detectRepetition(e,t=3){const s={};for(const t of e)s[t.type]=(s[t.type]||0)+1;return Object.entries(s).filter((([e,s])=>s>=t)).map((([e,t])=>({type:"repetition",score:t,details:{eventType:e}})))}static detectAlternance(e,t,s,a=4){let i=0,r=null;for(const a of e)a.type!==t&&a.type!==s||a.type===r?a.type===r&&(i=1,r=a.type):(i++,r=a.type);return i>=a?[{type:"alternance",score:i,details:{typeA:t,typeB:s}}]:[]}static detectBurst(e,t=1e3,s=3){if(e.length<s)return[];let a=1,i=1;for(let s=1;s<e.length;s++)e[s].timestamp-e[s-1].timestamp<=t?(a++,i=Math.max(i,a)):a=1;return i>=s?[{type:"burst",score:i,details:{maxInterval:t}}]:[]}static detectTemporalPattern(e,t=1e3,s=.2){if(e.length<3)return[];const a=[];for(let t=1;t<e.length;t++)a.push(e[t].timestamp-e[t-1].timestamp);const i=a.reduce(((e,t)=>e+t),0)/a.length,r=a.reduce(((e,t)=>e+Math.pow(t-i,2)),0)/a.length,n=Math.sqrt(r);return i>=t&&n/i<s?[{type:"temporal",score:i,details:{std:n,count:e.length}}]:[]}}class g{static getInstance(){return this.instance||(this.instance=new g),this.instance}async setItem(e,t){try{await chrome.storage.local.set({[e]:t})}catch(e){throw console.error("Storage error:",e),e}}async getItem(e){try{return(await chrome.storage.local.get([e]))[e]||null}catch(e){return console.error("Storage retrieval error:",e),null}}async removeItem(e){try{await chrome.storage.local.remove([e])}catch(e){console.error("Storage removal error:",e)}}}class p{static get swLocalStorage(){return{getItem:e=>this.storage.getItem(e),setItem:(e,t)=>this.storage.setItem(e,t),removeItem:e=>this.storage.removeItem(e)}}static get swIndexedDB(){return globalThis.indexedDB}static get swCryptoAPI(){return{...globalThis.crypto,encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)}}}p.storage=g.getInstance(),p.swCrypto=new class{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(e){try{const t=new TextEncoder,s=t.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),a=await crypto.subtle.importKey("raw",s,{name:"AES-GCM"},!1,["encrypt"]),i=crypto.getRandomValues(new Uint8Array(12)),r=t.encode(JSON.stringify(e)),n=await crypto.subtle.encrypt({name:"AES-GCM",iv:i},a,r),o=new Uint8Array(i.length+n.byteLength);return o.set(i,0),o.set(new Uint8Array(n),i.length),btoa(String.fromCharCode(...o))}catch(t){console.error("Encryption failed, using fallback:",t);const s=JSON.stringify(e);return btoa(unescape(encodeURIComponent(s)))}}async decryptSensitiveData(e){try{const t=Uint8Array.from(atob(e),(e=>e.charCodeAt(0))),s=t.slice(0,12),a=t.slice(12),i=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),r=await crypto.subtle.importKey("raw",i,{name:"AES-GCM"},!1,["decrypt"]),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:s},r,a),o=new TextDecoder;return JSON.parse(o.decode(n))}catch(t){console.error("Decryption failed, trying fallback:",t);try{const t=decodeURIComponent(escape(atob(e)));return JSON.parse(t)}catch(e){throw console.error("All decryption methods failed:",e),new Error("Unable to decrypt data")}}}},p.swBroadcastChannel=class{constructor(e){this.handlers=new Map,this.channelName=e,this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener(((e,t,s)=>{e.channel===this.channelName&&this.handleMessage(e.data)}))}postMessage(e){chrome.tabs.query({},(t=>{t.forEach((t=>{t.id&&chrome.tabs.sendMessage(t.id,{channel:this.channelName,data:e}).catch((()=>{}))}))})),this.broadcastViaStorage(e)}async broadcastViaStorage(e){const t=g.getInstance(),s=Date.now(),a=`broadcast_${this.channelName}_${s}`;await t.setItem(a,JSON.stringify({data:e,timestamp:s,channel:this.channelName})),setTimeout((async()=>{await t.removeItem(a)}),3e4)}handleMessage(e){(this.handlers.get("message")||[]).forEach((t=>{try{t({data:e})}catch(e){console.error("Message handler error:",e)}}))}set onmessage(e){this.handlers.has("message")||this.handlers.set("message",[]),this.handlers.get("message").push(e)}};const y=p.swLocalStorage,I=(p.swBroadcastChannel,p.swCryptoAPI),v=p.swIndexedDB;class w{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(e){if(I&&I.subtle){const t=new TextEncoder,s=t.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),a=await I.subtle.importKey("raw",s,{name:"AES-GCM"},!1,["encrypt"]),i=I.getRandomValues(new Uint8Array(12)),r=t.encode(JSON.stringify(e)),n=await I.subtle.encrypt({name:"AES-GCM",iv:i},a,r),o=new Uint8Array(i.length+n.byteLength);return o.set(i,0),o.set(new Uint8Array(n),i.length),btoa(String.fromCharCode(...o))}{const t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t)))}}async decryptSensitiveData(e){if("string"!=typeof e)throw new Error("decryptSensitiveData attend une cha√Æne de caract√®res.");if(!I||!I.subtle){const t=decodeURIComponent(escape(atob(String(e))));return JSON.parse(t)}try{const t=Uint8Array.from(atob(String(e)),(e=>e.charCodeAt(0))),s=t.slice(0,12),a=t.slice(12),i=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),r=await I.subtle.importKey("raw",i,{name:"AES-GCM"},!1,["decrypt"]),n=await I.subtle.decrypt({name:"AES-GCM",iv:s},r,a);return JSON.parse((new TextDecoder).decode(n))}catch{const t=decodeURIComponent(escape(atob(String(e))));return JSON.parse(t)}}anonymizeForSharing(e){const t={...e};return"url"in t&&(t.url="anonymized"),"userId"in t&&"string"==typeof t.userId&&(t.userId=this.hash(t.userId)),"id"in t&&"string"==typeof t.id&&(t.id=this.hash(t.id)),t}validateDataAccess(e,t="user"){return!(!e.userId||!e.resource||"admin"===t&&"admin"!==e.role)}hash(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return btoa(t.toString())}}class E{constructor(){this.failureCount=0,this.open=!1,this.lastFailure=0,this.failureThreshold=5,this.recoveryTimeout=3e4}isOpen(){return this.open&&Date.now()-this.lastFailure>this.recoveryTimeout&&(this.open=!1,this.failureCount=0),this.open}recordSuccess(){this.failureCount=0,this.open=!1}recordFailure(){this.failureCount++,this.lastFailure=Date.now(),this.failureCount>=this.failureThreshold&&(this.open=!0)}}class T{constructor(){this.key="symbiont_messages"}async enqueue(e){console.log("[ResilientMessageBus] enqueue",e);const t=JSON.parse(await y.getItem(this.key)||"[]");t.push(e),await y.setItem(this.key,JSON.stringify(t)),console.log("[ResilientMessageBus] enqueue OK",t.length)}async dequeue(){const e=JSON.parse(await y.getItem(this.key)||"[]"),t=e.shift();return await y.setItem(this.key,JSON.stringify(e)),console.log("[ResilientMessageBus] dequeue",t),t}async getAll(){const e=JSON.parse(await y.getItem(this.key)||"[]");return console.log("[ResilientMessageBus] getAll",e.length),e}}const S=new class{constructor(){this.memoryCache=new Map,this.persistentStorage=chrome.storage?.local,this.indexedDB=null,this.emergencyLocalStorage=y,this.setupMultiLayerStorage(),this.setupDataReplication(),this.setupIntegrityMonitoring()}async store(e,t,s={}){console.log("[HybridStorageManager] store - M√©moire",e,t),this.memoryCache.set(e,t);try{await new Promise(((s,a)=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?a(chrome.runtime.lastError):s(!0)}))})),console.log("[HybridStorageManager] store - chrome.storage.local OK",e)}catch(t){console.warn("[HybridStorageManager] store - chrome.storage.local failed, fallback IndexedDB",e,t)}try{if(!this.indexedDB)throw new Error("IndexedDB not ready");this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(t,e),console.log("[HybridStorageManager] store - IndexedDB OK",e)}catch(s){console.warn("[HybridStorageManager] store - IndexedDB failed, fallback localStorage",e,s),await this.emergencyLocalStorage.setItem(e,JSON.stringify(t)),console.log("[HybridStorageManager] store - localStorage d'urgence OK",e)}}async retrieve(e){if(this.memoryCache.has(e))return console.log("[HybridStorageManager] retrieve - M√©moire HIT",e),this.memoryCache.get(e);try{const t=await new Promise(((t,s)=>{this.persistentStorage.get([e],(a=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(a[e])}))}));if(void 0!==t)return this.memoryCache.set(e,t),console.log("[HybridStorageManager] retrieve - chrome.storage.local OK",e),t}catch(t){console.warn("[HybridStorageManager] retrieve - chrome.storage.local failed",e,t)}try{if(this.indexedDB){const t=await new Promise(((t,s)=>{const a=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(e);a.onsuccess=()=>t(a.result),a.onerror=()=>s(a.error)}));if(void 0!==t)return this.memoryCache.set(e,t),console.log("[HybridStorageManager] retrieve - IndexedDB OK",e),t}}catch(t){console.warn("[HybridStorageManager] retrieve - IndexedDB failed",e,t)}try{const t=await this.emergencyLocalStorage.getItem(e);if(t)return console.log("[HybridStorageManager] retrieve - localStorage d'urgence OK",e),JSON.parse(t)}catch(t){console.warn("[HybridStorageManager] retrieve - localStorage d'urgence failed",e,t)}return null}setupMultiLayerStorage(){const e=v.open("symbiont-db",1);e.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("symbiont")||t.createObjectStore("symbiont")},e.onsuccess=()=>{this.indexedDB=e.result},e.onerror=()=>{this.indexedDB=null}}setupDataReplication(){}setupIntegrityMonitoring(){}},b=new class{constructor(){this.connectionState="offline",this.messageQueue=new T,this.failureStrategies=new Map,this.circuitBreaker=new E,this.setupFailureStrategies()}setupFailureStrategies(){this.failureStrategies.set("ORGANISM_UPDATE",{maxRetries:3,backoffStrategy:"exponential",fallbackAction:this.cacheOrganismState,criticalLevel:"high"}),this.failureStrategies.set("INTERACTION_DETECTED",{maxRetries:5,backoffStrategy:"linear",fallbackAction:this.queueForLaterSync,criticalLevel:"medium"}),this.failureStrategies.set("PAGE_ANALYSIS_COMPLETE",{maxRetries:2,backoffStrategy:"immediate",fallbackAction:this.processLocally,criticalLevel:"low"})}async send(e){if(this.circuitBreaker.isOpen())return await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:"Circuit breaker open"};let t=0;const s=this.failureStrategies.get(e.type),a=s?.maxRetries||2;for(;t<=a;)try{return await this.simulateSend(e),this.circuitBreaker.recordSuccess(),{success:!0}}catch(i){if(this.circuitBreaker.recordFailure(),t++,t>a)return s&&await s.fallbackAction.call(this,e),await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:i};await this.wait(this.getBackoff(s?.backoffStrategy,t))}return{success:!1,queued:!0,error:"Unknown error"}}async simulateSend(e){if(Math.random()<.2)throw new Error("Simulated send failure")}getBackoff(e="immediate",t){return"exponential"===e?500*Math.pow(2,t):"linear"===e?500*t:0}wait(e){return new Promise((t=>setTimeout(t,e)))}async cacheOrganismState(e){console.log("[ResilientMessageBus] fallback cacheOrganismState",e),await y.setItem("symbiont_organism_cache",JSON.stringify(e))}async queueForLaterSync(e){console.log("[ResilientMessageBus] fallback queueForLaterSync",e),await this.messageQueue.enqueue(e)}async processLocally(e){console.log("[ResilientMessageBus] fallback processLocally",e),await y.setItem("symbiont_local_processing",JSON.stringify(e))}};async function f(e){return await S.retrieve(e)}async function M(e,t){await S.store(e,t)}new class{constructor(e){this.metrics={cpu:[],memory:[],latency:[],errors:0},this.alertCallback=null,e&&(this.alertCallback=e),this.setupMonitoring()}setupMonitoring(){setInterval((()=>{this.collectMetrics(),this.checkHealth()}),5e3)}collectMetrics(){const e=.2*Math.random(),t=20*Math.random(),s=5*Math.random();this.metrics.cpu.push(e),this.metrics.memory.push(t),this.metrics.latency.push(s),this.metrics.cpu.length>20&&this.metrics.cpu.shift(),this.metrics.memory.length>20&&this.metrics.memory.shift(),this.metrics.latency.length>20&&this.metrics.latency.shift()}checkHealth(){const e=e=>e.reduce(((e,t)=>e+t),0)/(e.length||1),t=e(this.metrics.cpu),s=e(this.metrics.memory),a=e(this.metrics.latency);t>.18&&this.alert("CPU √©lev√© : "+t.toFixed(3)),s>18&&this.alert("M√©moire √©lev√©e : "+s.toFixed(2)+"MB"),a>4&&this.alert("Latence √©lev√©e : "+a.toFixed(2)+"ms"),this.metrics.errors>0&&this.alert("Erreurs d√©tect√©es : "+this.metrics.errors)}logError(){this.metrics.errors++}alert(e){console.warn("üõë [HealthMonitor]",e),this.alertCallback&&this.alertCallback(e)}}((async e=>{await S.store("symbiont_health_alert_"+Date.now(),{msg:e,timestamp:Date.now()})})),(async()=>{const e={type:"ORGANISM_UPDATE",payload:{state:{id:"demo",traits:{focus:1}},timestamp:Date.now()}};(await b.send(e)).success||console.warn("Message ORGANISM_UPDATE fallback, voir la queue persistante.")})();let _=null;_=new class{constructor(){this.organism=null,this.activated=!1,this.events=[],this.collectiveThresholds=[10,50,100,250,500],this.reachedThresholds=[],this.security=new w,this.messageBus=new n("background"),this.storage=new o,this.navigationObserver=new c(this.messageBus),this.invitationService=new l(this.storage),this.murmureService=new d,f("symbiont_collective_thresholds").then((e=>{this.reachedThresholds=e?JSON.parse(e):[],this.initialize()}))}async initialize(){try{await this.storage.initialize(),this.activated="true"===await f("symbiont_activated"),this.activated?(this.organism=await this.storage.getOrganism(),this.organism||(this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism))):this.organism=null,this.setupMessageHandlers(),this.startPeriodicTasks(),console.log("Background service initialized")}catch(e){console.error("Failed to initialize background service:",e)}}createNewOrganism(){const e=this.generateVisualDNA();return{id:crypto.randomUUID(),generation:1,health:100,energy:100,traits:{curiosity:100*Math.random(),focus:100*Math.random(),rhythm:100*Math.random(),empathy:100*Math.random(),creativity:100*Math.random()},visualDNA:e,lastMutation:Date.now(),mutations:[],createdAt:Date.now(),dna:e,birthTime:Date.now(),socialConnections:[],memoryFragments:[]}}generateVisualDNA(){let e="";for(let t=0;t<64;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return e}setupMessageHandlers(){this.messageBus.on(s.PAGE_VISIT,(async e=>{const{url:t,title:s}=e.payload;let a=await this.storage.getBehavior(t)||{url:t,visitCount:0,totalTime:0,scrollDepth:0,lastVisit:Date.now(),interactions:[]};a.visitCount++,a.lastVisit=Date.now(),await this.storage.saveBehavior(a),this.events.push({type:"visit",timestamp:Date.now(),url:t}),this.updateOrganismTraits(t,s),this.analyzeContextualPatterns()})),this.messageBus.on(s.SCROLL_EVENT,(async e=>{const{url:t,scrollDepth:s}=e.payload,a=await this.storage.getBehavior(t);a&&(a.scrollDepth=Math.max(a.scrollDepth,s),await this.storage.saveBehavior(a)),this.events.push({type:"scroll",timestamp:Date.now(),url:t}),this.analyzeContextualPatterns()})),this.messageBus.on(s.INTERACTION_DETECTED,(e=>{const{type:t,timestamp:s,target:a,data:i}=e.payload;this.events.push({type:t,timestamp:s,target:a,...i}),this.analyzeContextualPatterns()})),this.messageBus.on(s.GENERATE_INVITATION,(async e=>{const{donorId:t}=e.payload,a=await this.invitationService.generateInvitation(t),i={code:a.code,createdAt:a.createdAt,consumed:a.used??!1,consumedAt:a.usedAt,inviter:a.donorId,invitee:a.receiverId};let r=i;try{r=await this.security.encryptSensitiveData(i)}catch(e){r=i}await b.send({type:s.INVITATION_GENERATED,payload:r})})),this.messageBus.on(s.CONSUME_INVITATION,(async e=>{const{code:t,receiverId:a,role:i}=e.payload;if(!this.security.validateDataAccess({userId:a,resource:t,role:i},"user"))return void b.send({type:s.INVITATION_CONSUMED,payload:{error:"Acc√®s refus√©."}});const r=await this.invitationService.consumeInvitation(t,a);r&&(this.activated=!0,await M("symbiont_activated","true"),this.organism||(this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism))),b.send({type:s.INVITATION_CONSUMED,payload:r})})),this.messageBus.on(s.CHECK_INVITATION,(async e=>{const{code:t}=e.payload,a=await this.invitationService.isValid(t);b.send({type:s.INVITATION_CHECKED,payload:{code:t,valid:a}})})),this.messageBus.on(s.GET_INVITER,(async e=>{const{userId:t}=e.payload,a=(await this.invitationService.getAllInvitations()).find((e=>e.receiverId===t));b.send({type:s.INVITER_RESULT,payload:a||null})})),this.messageBus.on(s.GET_INVITEES,(async e=>{const{userId:t}=e.payload,a=(await this.invitationService.getAllInvitations()).filter((e=>e.donorId===t));b.send({type:s.INVITEES_RESULT,payload:a})})),this.messageBus.on(s.GET_INVITATION_HISTORY,(async e=>{const{userId:t}=e.payload,a=await this.invitationService.getAllInvitations(),i=[...a.filter((e=>e.receiverId===t)).map((e=>({...e,type:"re√ßue"}))),...a.filter((e=>e.donorId===t)).map((e=>({...e,type:"envoy√©e"})))];b.send({type:s.INVITATION_HISTORY_RESULT,payload:i})}));const e=new Map;this.messageBus.on(s.REQUEST_SHARED_MUTATION,(t=>{const{initiatorId:a,traits:i}=t.payload,r=Math.random().toString(36).substr(2,6).toUpperCase(),n=Date.now()+3e5;e.set(r,{initiatorId:a,traits:i,expiresAt:n}),b.send({type:s.SHARED_MUTATION_CODE,payload:{code:r,initiatorId:a,expiresAt:n}})})),this.messageBus.on(s.ACCEPT_SHARED_MUTATION,(async t=>{const{code:a,receiverId:i,traits:r,role:n}=t.payload;if(!this.security.validateDataAccess({userId:i,resource:a,role:n},"user"))return void b.send({type:s.SHARED_MUTATION_RESULT,payload:{error:"Acc√®s refus√©."}});const o=e.get(a);if(!o||o.expiresAt<Date.now())return void b.send({type:s.SHARED_MUTATION_RESULT,payload:{error:"Code expir√© ou invalide."}});const c={...o.traits};for(const e of Object.keys(r))c[e]=(c[e]??0+r[e]??0)/2;e.delete(a);let l={initiatorId:o.initiatorId,receiverId:i,mergedTraits:c,timestamp:Date.now()};try{l=await this.security.encryptSensitiveData(l)}catch(e){}b.send({type:s.SHARED_MUTATION_RESULT,payload:l})}));let t=new Set,a=null;this.messageBus.on(s.COLLECTIVE_WAKE_REQUEST,(e=>{const{userId:i}=e.payload;t.add(i),a||(a=setTimeout((()=>{b.send({type:s.COLLECTIVE_WAKE_RESULT,payload:{participants:Array.from(t),triggeredAt:Date.now()}}),t.clear(),a=null}),1e4))}));const i=async e=>{const t=await f("symbiont_user_id")||"unknown",a=await this.invitationService.generateInvitation(t);await b.send({type:s.CONTEXTUAL_INVITATION,payload:{invitation:a,context:e}})},r=this.generateMutation.bind(this);this.generateMutation=()=>{const e=r();return"cognitive"===e.type&&i("mutation_cognitive"),e};const n=this.updateOrganismTraits.bind(this);this.updateOrganismTraits=async(e,t)=>{await n(e,t),this.organism&&this.organism.traits.curiosity>90&&await i("curiosity_threshold")};let o=Date.now();chrome.idle.onStateChanged.addListener((e=>{"idle"===e?o=Date.now():"active"===e&&Date.now()-o>18e5&&i("long_inactivity")}));const c=["SYMBIOSE","AWAKEN","ECHO"];this.messageBus.on(s.SECRET_CODE_ENTERED,(e=>{const{code:t}=e.payload;c.includes(t.toUpperCase())&&b.send({type:s.SECRET_RITUAL_TRIGGERED,payload:{code:t,effect:"mutation_unique",timestamp:Date.now()}})}))}async updateOrganismTraits(e,t){if(!this.organism)return;const a=e.toLowerCase(),i=t.toLowerCase();(a.includes("github")||a.includes("stackoverflow")||a.includes("codepen")||a.includes("dribbble"))&&(this.organism.traits.creativity+=.5),(a.includes("docs")||a.includes("wiki")||a.includes("tutorial")||i.includes("guide"))&&(this.organism.traits.focus+=.3),(a.includes("twitter")||a.includes("linkedin")||a.includes("facebook")||a.includes("reddit"))&&(this.organism.traits.empathy+=.4);const r=new URL(e).hostname;if(!await this.hasVisitedDomain(r)&&(this.organism.traits.curiosity+=1),!this.organism)return;const n=this.organism.traits;if(!n)return;Object.keys(n).forEach((e=>{n[e]=Math.max(0,Math.min(100,n[e]))})),await this.checkForMutations(),await this.storage.saveOrganism(this.organism);let o="default";if(await this.isLoop(e)?o="loop":await this.isIdle()?o="idle":await this.isExploration(e)?o="exploration":await this.isRoutine(e)&&(o="routine"),!this.organism)return;const c=this.organism;await b.send({type:s.ORGANISM_UPDATE,payload:{state:c,mutations:await this.storage.getRecentMutations(5)}});const l=this.murmureService.generateMurmur(o);await b.send({type:s.MURMUR,payload:{text:l,pattern:o,timestamp:Date.now()}})}async hasVisitedDomain(e){return(await chrome.tabs.query({})).some((t=>t.url&&new URL(t.url).hostname===e))}async checkForMutations(){if(!this.organism)return;const e=this.organism,t=Date.now(),s=t-(e.lastMutation??0),a=Math.min(.5,s/36e5);if(Math.random()<a){const s=this.generateMutation();await this.storage.addMutation(s),e.lastMutation=t,this.applyMutation(s)}}generateMutation(){const e=["visual","behavioral","cognitive"],t=e[Math.floor(Math.random()*e.length)];return{type:t,trigger:this.getMutationTrigger(t),magnitude:.5*Math.random()+.1,timestamp:Date.now()}}getMutationTrigger(e){const t={visual:["color_shift","pattern_change","size_fluctuation","opacity_variation"],behavioral:["navigation_speed","content_preference","interaction_pattern"],cognitive:["memory_retention","pattern_recognition","association_strength"]}[e];return t[Math.floor(Math.random()*t.length)]}applyMutation(e){if(this.organism)switch(e.type){case"visual":this.organism.visualDNA=this.mutateVisualDNA(this.organism.visualDNA??"",e.magnitude);break;case"behavioral":const t=Object.keys(this.organism.traits),s=t[Math.floor(Math.random()*t.length)];this.organism.traits[s]+=(Math.random()-.5)*e.magnitude*20;break;case"cognitive":if(!this.organism)return;const a=this.organism.traits;if(!a)return;Object.keys(a).forEach((t=>{a[t]+=(Math.random()-.5)*e.magnitude*5}))}}mutateVisualDNA(e,t){const s=Math.floor(e.length*t);let a=e.split("");for(let t=0;t<s;t++)a[Math.floor(Math.random()*e.length)]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return a.join("")}startPeriodicTasks(){setInterval((()=>{this.organism&&(this.organism.health??0)>0&&(this.organism.health=Math.max(0,(this.organism.health??0)-.1),this.organism.energy=Math.max(0,(this.organism.energy??0)-.05))}),6e4),setInterval((async()=>{this.organism&&(await this.storage.saveOrganism(this.organism),await b.send({type:s.ORGANISM_UPDATE,payload:{state:this.organism,mutations:await this.storage.getRecentMutations(5)}}))}),3e4)}async isLoop(e){const t=await this.storage.getBehavior(e);return!!t&&t.visitCount>=3}async isIdle(){return!1}async isExploration(e){const t=await this.storage.getBehavior(e);return!!t&&t.visitCount<=1}async isRoutine(e){const t=await this.storage.getBehavior(e);return!!t&&Date.now()-t.lastVisit<1728e5}async analyzeContextualPatterns(){const e=Date.now();this.events=this.events.filter((t=>e-t.timestamp<18e5)),m.detectBurst(this.events,1e4,5).length>0?this.triggerContextualInvitation("burst_activity"):m.detectTemporalPattern(this.events,6e4,.15).length>0?this.triggerContextualInvitation("temporal_cycle"):m.detectAlternance(this.events,"visit","scroll",6).length>0?this.triggerContextualInvitation("alternance_nav_scroll"):m.detectRepetition(this.events,7).length>0?this.triggerContextualInvitation("repetition_action"):this.checkCollectiveThreshold()}async checkCollectiveThreshold(){const e=(await this.invitationService.getAllInvitations()).length;for(const t of this.collectiveThresholds)if(e>=t&&!this.reachedThresholds.includes(t)){this.reachedThresholds.push(t),await M("symbiont_collective_thresholds",JSON.stringify(this.reachedThresholds)),this.triggerContextualInvitation("collective_threshold_"+t);break}}async triggerContextualInvitation(e){const t=await f("symbiont_user_id")||"unknown",a=await this.invitationService.generateInvitation(t);await b.send({type:s.CONTEXTUAL_INVITATION,payload:{invitation:a,context:e}})}},new class{constructor(){this.peers=new Set,this.organismState=null,this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_network"),this.channel.onmessage=e=>this.handleMessage(e.data),this.announce()}announce(){this.channel.postMessage({type:"announce",peerId:this.peerId})}joinNetwork(e){this.peers.add(e),this.channel.postMessage({type:"join",peerId:this.peerId}),console.log(`[Network] Pair rejoint : ${e}`)}leaveNetwork(e){this.peers.delete(e),this.channel.postMessage({type:"leave",peerId:this.peerId}),console.log(`[Network] Pair quitt√© : ${e}`)}broadcastMutation(e){this.channel.postMessage({type:"mutation",from:this.peerId,mutation:e}),console.log(`[Network] Diffusion mutation √† ${this.peers.size} pairs`)}receiveMutation(e,t){console.log(`[Network] Mutation re√ßue de ${t}`,e)}performCommunityBackup(e){this.channel.postMessage({type:"backup",from:this.peerId,state:e}),console.log("[Network] Backup communautaire lanc√©")}handleMessage(e){if(e.peerId!==this.peerId)switch(e.type){case"announce":case"join":this.peers.add(e.peerId);break;case"leave":this.peers.delete(e.peerId);break;case"mutation":this.receiveMutation(e.mutation,e.from);break;case"backup":console.log(`[Network] Backup re√ßu de ${e.from}`,e.state)}}},new class{constructor(e){this.proposals=new Map,this.votes=new Map,this.onCollectiveMutation=null,this.peerId="peer_"+Math.random().toString(36).substr(2,8),e&&(this.onCollectiveMutation=e)}proposeMutation(e,t){this.proposals.has(e.id)||(this.proposals.set(e.id,[]),this.votes.set(e.id,new Set)),this.proposals.get(e.id).push({mutation:e,proposerId:t}),this.vote(e.id,t),console.log(`[Collective] Mutation propos√©e par ${t}`)}vote(e,t){this.votes.has(e)||this.votes.set(e,new Set),this.votes.get(e).add(t),console.log(`[Collective] Vote de ${t} pour mutation ${e}`)}aggregateVotes(e){return this.votes.get(e)?.size||0}triggerCollectiveMutation(e,t){const s=this.aggregateVotes(e);return s>Math.max(1,Math.floor(t/2))?(console.log(`[Collective] Mutation collective d√©clench√©e : ${e}`),this.onCollectiveMutation&&this.onCollectiveMutation(e),!0):(console.log(`[Collective] Consensus non atteint pour ${e} (${s}/${t})`),!1)}},new class{constructor(){this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_resilience"),this.channel.onmessage=e=>this.handleMessage(e.data)}requestCommunityBackup(e){this.channel.postMessage({type:"backup_request",from:this.peerId,organismId:e}),console.log(`[SocialResilience] Demande de backup pour ${e}`)}restoreFromCommunity(e){console.log(`[SocialResilience] Restauration depuis la communaut√© pour ${e}`)}detectMassiveFailure(){console.log("[SocialResilience] D√©tection de panne massive")}launchCommunityAlert(e){this.channel.postMessage({type:"alert",from:this.peerId,message:e}),console.log(`[SocialResilience] Alerte communautaire : ${e}`)}handleMessage(e){if(e.from!==this.peerId)switch(e.type){case"backup_request":console.log(`[SocialResilience] Backup demand√© par ${e.from} pour ${e.organismId}`);break;case"alert":console.log(`[SocialResilience] Alerte re√ßue : ${e.message}`)}}},new class{constructor(){this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_mystical"),this.channel.onmessage=e=>this.handleMessage(e.data)}triggerMysticalEvent(e,t){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:e,payload:t}),console.log(`[MysticalEvents] √âv√©nement mystique d√©clench√© : ${e}`)}propagateToCommunity(e,t){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:e,payload:t}),console.log(`[MysticalEvents] Propagation √† la communaut√© : ${e}`)}applySpecialEffect(e){console.log(`[MysticalEvents] Effet sp√©cial appliqu√© : ${e}`)}handleMessage(e){e.from!==this.peerId&&"mystical"===e.type&&this.applySpecialEffect(`Effet mystique re√ßu : ${e.eventId}`)}};