var t,e,i,s={194:(t,e,i)=>{i.r(e),i.d(e,{NeuralMesh:()=>s});class s{constructor(){this.nodes=new Map,this.connections=new Map,this.activations=new Map,this.learningRate=.01}addNode(t,e,i=0){const s={type:e,activation:0,bias:i};this.nodes.set(t,s),this.activations.set(t,0)}addConnection(t,e,i){if(!this.nodes.has(t)||!this.nodes.has(e))throw new Error(`Cannot connect non-existent nodes: ${t} -> ${e}`);this.connections.has(t)||this.connections.set(t,new Map),this.connections.get(t).set(e,i)}stimulate(t,e){const i=this.nodes.get(t);i&&"input"===i.type?this.activations.set(t,e):console.warn(`Cannot stimulate non-input node: ${t}`)}propagate(){for(const[t,e]of this.nodes)"input"!==e.type&&this.activations.set(t,e.bias);for(const[t,e]of this.connections){const i=this.activations.get(t)||0;for(const[t,s]of e){const e=(this.activations.get(t)||0)+i*s;this.activations.set(t,this.sigmoid(e))}}}sigmoid(t){return 1/(1+Math.exp(-t))}getActivation(t){return this.activations.get(t)||0}mutate(t=.05){for(const e of this.connections.values())for(const[i,s]of e)Math.random()<t&&(e.set(i,s+.2*(Math.random()-.5)),e.set(i,Math.max(-2,Math.min(2,e.get(i)||0))));for(const e of this.nodes.values())Math.random()<t&&(e.bias+=.1*(Math.random()-.5),e.bias=Math.max(-1,Math.min(1,e.bias)))}getNeuralActivity(){let t=0,e=0;for(const i of this.activations.values())t+=Math.abs(i),e++;return e>0?t/e:0}getConnectionStrength(){let t=0,e=0;for(const i of this.connections.values())for(const s of i.values())t+=Math.abs(s),e++;return e>0?t/e:0}toJSON(){return{nodes:Array.from(this.nodes.values()),connections:Array.from(this.connections.values()).map((t=>Array.from(t.entries()))),activations:Object.fromEntries(this.activations)}}async initialize(){0===this.nodes.size&&this.setupDefaultNetwork(),this.propagate()}setupDefaultNetwork(){this.addNode("sensory_input","input"),this.addNode("memory_input","input"),this.addNode("processing_1","hidden",.1),this.addNode("processing_2","hidden",-.1),this.addNode("motor_output","output"),this.addNode("emotion_output","output"),this.addConnection("sensory_input","processing_1",.8),this.addConnection("memory_input","processing_2",.6),this.addConnection("processing_1","motor_output",.9),this.addConnection("processing_2","emotion_output",.7),this.addConnection("processing_1","processing_2",.3)}async suspend(){this.activations.clear(),console.log("Neural mesh suspended")}async getCPUUsage(){const t=this.nodes.size*this.connections.size;return Math.min(1,t/1e3)}async getMemoryUsage(){const t=64*(this.nodes.size+this.connections.size);return Math.min(1,t/1048576)}}},326:(t,e,i)=>{i.r(e),i.d(e,{OrganismCore:()=>n});class s{constructor(){this.errorQueue=[],this.maxQueueSize=1e3,this.logLevel="warning",this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0}}static getInstance(){return s.instance||(s.instance=new s),s.instance}setLogLevel(t){this.logLevel=t}logError(t){this.updateMetrics(t),this.addToQueue(t),this.outputError(t)}logSimpleError(t,e,i,s="error",a){const r=i instanceof Error?i.message:String(i),n={component:t,method:e,timestamp:Date.now(),severity:s,details:{message:r,context:a,originalError:i instanceof Error?{name:i.name,stack:i.stack}:void 0}};console["warning"===s?"warn":"debug"===s?"debug":"info"===s?"info":"error"](`[${t}][${e}] ${r}`,a||""),this.recordError(n)}validateRequired(t,e,i,s){const a=[];null==t&&a.push(`${e} is required`);const r={isValid:0===a.length,errors:a,warnings:[],context:{component:i,method:s,timestamp:Date.now(),severity:a.length>0?"error":"info"}};return r.isValid||this.logError(r.context),r}validateType(t,e,i={},s,a,r){const n=[];if(i.required&&null==t&&n.push(`${s} is required`),null!=t){const a=typeof t;a!==e&&n.push(`${s} must be of type ${e}, got ${a}`),"number"===e&&"number"==typeof t&&(void 0!==i.min&&t<i.min&&n.push(`${s} must be >= ${i.min}`),void 0!==i.max&&t>i.max&&n.push(`${s} must be <= ${i.max}`),Number.isFinite(t)||n.push(`${s} must be a finite number`)),"string"===e&&"string"==typeof t&&(void 0!==i.min&&t.length<i.min&&n.push(`${s} must be at least ${i.min} characters long`),void 0!==i.max&&t.length>i.max&&n.push(`${s} must be at most ${i.max} characters long`),i.pattern&&!i.pattern.test(t)&&n.push(`${s} does not match required pattern`))}const o={isValid:0===n.length,errors:n,warnings:[],context:{component:a,method:r,timestamp:Date.now(),severity:n.length>0?"error":"warning",details:{fieldName:s,expectedType:e,actualValue:t}}};return o.isValid||this.logError(o.context),o}async withRetry(t,e,i){let s=null;for(let a=1;a<=e.maxRetries;a++){this.metrics.recoveryAttempts++;try{const e=await t();return a>1&&(this.metrics.recoverySuccesses++,this.logSimpleError(i.component,i.method,`Recovery successful after ${a} attempts`,"info")),e}catch(t){if(s=t instanceof Error?t:new Error(String(t)),this.logSimpleError(i.component,i.method,`Attempt ${a}/${e.maxRetries} failed: ${s.message}`,"warning"),a<e.maxRetries&&e.shouldRetry(s,a)){await this.delay(e.backoffMs*a);continue}break}}if(this.logSimpleError(i.component,i.method,`All ${e.maxRetries} retry attempts failed. Last error: ${s?.message}`,"error"),void 0!==e.fallbackValue)return e.fallbackValue;throw s}safeExecute(t,e,i){try{return t()}catch(t){return this.logSimpleError(i.component,i.method,t,"error"),e}}async safeExecuteAsync(t,e,i){try{return await t()}catch(t){return this.logSimpleError(i.component,i.method,t,"error"),e}}getMetrics(){return{...this.metrics}}getRecentErrors(t=50){return this.errorQueue.slice(-t)}reset(){this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0},this.errorQueue=[]}updateMetrics(t){this.metrics.errorCount++,this.metrics.lastErrorTime=t.timestamp;const e=this.metrics.errorsByComponent.get(t.component)||0;this.metrics.errorsByComponent.set(t.component,e+1);const i=`${t.component}.${t.method}`,s=this.metrics.errorsByMethod.get(i)||0;this.metrics.errorsByMethod.set(i,s+1)}addToQueue(t){this.errorQueue.push(t),this.errorQueue.length>this.maxQueueSize&&(this.errorQueue=this.errorQueue.slice(-this.maxQueueSize))}outputError(t){if(!this.shouldLog(t.severity))return;const e=`[${new Date(t.timestamp).toISOString()}] ${t.severity.toUpperCase()} ${t.component}.${t.method}`;switch(t.severity){case"critical":case"error":console.error(e,t.details);break;case"warning":console.warn(e,t.details);break;case"info":console.info(e,t.details);break;case"debug":console.debug(e,t.details)}}shouldLog(t){const e=["debug","info","warning","error","critical"],i=e.indexOf(this.logLevel);return e.indexOf(t)>=i}delay(t){return new Promise((e=>setTimeout(e,t)))}recordError(t){this.updateMetrics(t),this.addToQueue(t)}}s.instance=null;const a=s.getInstance();class r{constructor(t,e={}){this.pendingMutations=new Map,this.debounceTimer=null,this.totalRequests=0,this.totalBatches=0,this.averageBatchSize=0,this.lastBatchTime=0,this.onBatchReady=t,this.config={debounceMs:50,maxBatchSize:10,maxWaitTimeMs:200,combinationStrategy:"weighted",...e}}addMutation(t,e="normal"){const i=`mutation_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s={id:i,rate:Math.max(0,Math.min(1,t)),timestamp:Date.now(),priority:e};return this.pendingMutations.set(i,s),this.totalRequests++,this.scheduleBatchProcessing(),i}cancelMutation(t){return this.pendingMutations.delete(t)}async flushBatch(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),await this.processPendingMutations()}scheduleBatchProcessing(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.pendingMutations.size>=this.config.maxBatchSize||this.hasHighPriorityMutation()||this.hasOldestMutationExceededMaxWait()?this.processPendingMutations().catch((t=>{a.logSimpleError("MutationBatcher","scheduleBatchProcessing",t)})):this.debounceTimer=setTimeout((()=>{this.processPendingMutations().catch((t=>{a.logSimpleError("MutationBatcher","debounceTimer",t)}))}),this.config.debounceMs)}hasHighPriorityMutation(){return Array.from(this.pendingMutations.values()).some((t=>"high"===t.priority))}hasOldestMutationExceededMaxWait(){const t=Date.now(),e=Array.from(this.pendingMutations.values()).reduce(((t,e)=>e.timestamp<t.timestamp?e:t));return e&&t-e.timestamp>this.config.maxWaitTimeMs}async processPendingMutations(){if(0===this.pendingMutations.size)return;const t=Array.from(this.pendingMutations.values());this.pendingMutations.clear();try{const e=this.combineMutations(t);await this.onBatchReady(e),this.updateStatistics(t.length),this.lastBatchTime=Date.now()}catch(e){a.logSimpleError("MutationBatcher","processPendingMutations",e),t.forEach((t=>{this.pendingMutations.set(t.id,t)}))}}combineMutations(t){if(0===t.length)throw new Error("Cannot combine empty mutations array");const e=t.map((t=>t.rate)),i=t.map((t=>t.priority)),s=t.map((t=>t.timestamp));let a;switch(this.config.combinationStrategy){case"average":default:a=e.reduce(((t,e)=>t+e),0)/e.length;break;case"max":a=Math.max(...e);break;case"sum":a=Math.min(1,e.reduce(((t,e)=>t+e),0));break;case"weighted":a=this.calculateWeightedRate(t)}const r=i.includes("high"),n=i.includes("normal"),o=r?"high":n?"normal":"low",c=Math.max(...s)-Math.min(...s);return{combinedRate:Math.max(0,Math.min(1,a)),requestCount:t.length,timespan:c,priority:o}}calculateWeightedRate(t){let e=0,i=0;const s=Date.now();return t.forEach((t=>{let a=1;switch(t.priority){case"high":a=3;break;case"normal":a=2;break;case"low":a=1}const r=s-t.timestamp,n=a*Math.exp(-r/1e3);i+=t.rate*n,e+=n})),e>0?i/e:0}updateStatistics(t){this.totalBatches++,this.averageBatchSize=.9*this.averageBatchSize+.1*t}getStatistics(){const t=this.totalBatches>0?this.totalRequests/this.totalBatches:1;return{totalRequests:this.totalRequests,totalBatches:this.totalBatches,averageBatchSize:this.averageBatchSize,compressionRatio:t,pendingMutations:this.pendingMutations.size,lastBatchTime:this.lastBatchTime,config:{...this.config}}}updateConfig(t){this.config={...this.config,...t}}dispose(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.pendingMutations.clear()}}class n{constructor(t,e,s){this.interpreter=null,this.id=Math.random().toString(36).substr(2,9),this.isBooted=!1;const n=this.validateInput(t,e);if(!n.isValid)throw new Error(`OrganismCore creation failed: ${n.errors.join(", ")}`);if(this.dna=t,s)this.mesh=s(),this.neuralMesh=this.mesh;else{const{NeuralMesh:t}=i(194);this.mesh=new t,this.neuralMesh=this.mesh}this.traits={curiosity:.5,focus:.5,rhythm:.5,empathy:.5,creativity:.5,energy:.5,harmony:.5,wisdom:.1,...e},this.energy=1,this.health=1,this.lastMutation=Date.now(),this.metabolismRate=.01,this.mutationBatcher=new r(this.processBatchedMutation.bind(this),{debounceMs:100,maxBatchSize:5,maxWaitTimeMs:500,combinationStrategy:"weighted"}),this.initializeNeuralNetwork().catch((t=>{a.logSimpleError("OrganismCore","constructor",t,"error")}))}validateInput(t,e){const i=a.validateType(t,"string",{required:!0,min:10,pattern:/^[ATCG]+$/i},"dna","OrganismCore","validateInput");if(!i.isValid)return i;if(!/^[ATCG]+$/i.test(t))return{isValid:!1,errors:["DNA must contain only valid nucleotide characters (A, T, C, G)"],warnings:[],context:{component:"OrganismCore",method:"validateInput",timestamp:Date.now(),severity:"error",details:{fieldName:"dna",invalidCharacters:t.replace(/[ATCG]/gi,"")}}};if(e)for(const[t,i]of Object.entries(e)){const e=a.validateType(i,"number",{required:!0,min:0,max:1},`trait.${t}`,"OrganismCore","validateInput");if(!e.isValid)return e}return{isValid:!0,errors:[],warnings:[]}}async initializeNeuralNetwork(){return a.withRetry((async()=>{await this.mesh.initialize(),this.mesh.stimulate("sensory_input",this.traits.curiosity),this.mesh.stimulate("memory_input",this.traits.focus)}),{maxRetries:3,backoffMs:100,shouldRetry:(t,e)=>e<3},{component:"OrganismCore",method:"initializeNeuralNetwork"})}update(t=1){a.safeExecute((()=>{const e=a.validateType(t,"number",{required:!0,min:.001,max:1e3},"deltaTime","OrganismCore","update");if(!e.isValid)throw new Error(`Invalid deltaTime: ${e.errors.join(", ")}`);this.mesh.propagate(),this.updateEnergy(t),this.updateHealth(),this.evolveTraits()}),void 0,{component:"OrganismCore",method:"update"})}updateEnergy(t){a.safeExecute((()=>{const e=this.mesh.getNeuralActivity()*this.metabolismRate*t;this.energy=Math.max(0,Math.min(1,this.energy-e)),this.energy<.2&&(this.health*=.999)}),void 0,{component:"OrganismCore",method:"updateEnergy"})}updateHealth(){a.safeExecute((()=>{this.energy>.8&&(this.health=Math.min(1,this.health+.001)),this.health=Math.max(0,this.health)}),void 0,{component:"OrganismCore",method:"updateHealth"})}evolveTraits(){a.safeExecute((()=>{const t=this.mesh.getNeuralActivity(),e=this.mesh.getConnectionStrength();this.traits.focus+=.001*(t-.5),this.traits.creativity+=.001*(e-.5),Object.keys(this.traits).forEach((t=>{const e=t;this.traits[e]=Math.max(0,Math.min(1,this.traits[e]))}))}),void 0,{component:"OrganismCore",method:"evolveTraits"})}stimulate(t,e){a.safeExecute((()=>{const i=a.validateType(t,"string",{required:!0},"inputId","OrganismCore","stimulate"),s=a.validateType(e,"number",{required:!0},"value","OrganismCore","stimulate");if(!i.isValid||!s.isValid)throw new Error("Invalid stimulate parameters");this.mesh.stimulate(t,e)}),void 0,{component:"OrganismCore",method:"stimulate"})}async processBatchedMutation(t){return a.safeExecuteAsync((async()=>{await this.mesh.mutate(t.combinedRate);const e=.5*t.combinedRate;Object.keys(this.traits).forEach((i=>{if(Math.random()<e){const e=.1*(Math.random()-.5)*t.combinedRate,s=i;this.traits[s]=Math.max(0,Math.min(1,this.traits[s]+e))}})),this.lastMutation=Date.now(),a.logSimpleError("OrganismCore","processBatchedMutation",`Processed batched mutation: rate=${t.combinedRate.toFixed(3)}, requests=${t.requestCount}`,"info")}),void 0,{component:"OrganismCore",method:"processBatchedMutation"})}mutate(t=.05){a.safeExecute((()=>{const e=a.validateType(t,"number",{required:!0,min:0,max:1},"rate","OrganismCore","mutate");if(!e.isValid)throw new Error(`Invalid mutation rate: ${e.errors.join(", ")}`);let i="normal";t>.3?i="high":t<.01&&(i="low");const s=this.mutationBatcher.addMutation(t,i);a.logSimpleError("OrganismCore","mutate",`Queued mutation: id=${s}, rate=${t}, priority=${i}`,"debug")}),void 0,{component:"OrganismCore",method:"mutate"})}async flushMutations(){return a.safeExecuteAsync((async()=>{await this.mutationBatcher.flushBatch()}),void 0,{component:"OrganismCore",method:"flushMutations"})}feed(t=.3){a.safeExecute((()=>{const e=a.validateType(t,"number",{required:!0,min:0,max:1},"amount","OrganismCore","feed");if(!e.isValid)throw new Error(`Invalid feed amount: ${e.errors.join(", ")}`);this.energy=Math.min(1,this.energy+t)}),void 0,{component:"OrganismCore",method:"feed"})}getTraits(){return{...this.traits}}setTraits(t){a.safeExecute((()=>{const e=this.validateInput(this.dna,t);if(!e.isValid)throw new Error(`Invalid traits: ${e.errors.join(", ")}`);Object.keys(t).forEach((e=>{const i=t[e];"number"!=typeof i||isNaN(i)||(this.traits[e]=i)}))}),void 0,{component:"OrganismCore",method:"setTraits"})}getState(){return{id:"core",generation:1,health:this.health,energy:this.energy,traits:this.getTraits(),visualDNA:this.dna,lastMutation:this.lastMutation,mutations:[],createdAt:Date.now(),dna:this.dna,birthTime:Date.now(),socialConnections:[],memoryFragments:[]}}async getPerformanceMetrics(){try{return{...await this.measurePerformance(),neuralActivity:this.calculateNeuralActivity(),connectionStrength:this.calculateConnectionStrength(),mutationStats:this.mutationBatcher.getStatistics()}}catch(t){return this.logger?.error("Failed to get performance metrics",{organismId:this.id,err:t}),{cpu:0,memory:0,neuralActivity:0,connectionStrength:0,mutationStats:this.mutationBatcher.getStatistics()}}}toJSON(){return{mesh:this.mesh.toJSON(),traits:this.traits,energy:this.energy,health:this.health,dna:this.dna,timestamp:Date.now()}}getShaderParameters(){return{energy:this.energy,health:this.health,neuralActivity:this.mesh.getNeuralActivity(),creativity:this.traits.creativity,focus:this.traits.focus,time:Date.now()/1e3}}async boot(){try{if(this.logger?.debug("Starting organism boot sequence",this.id),!this.neuralMesh)throw new Error("Neural mesh not provided");this.neuralMesh.addNode("sensory_input","input"),this.neuralMesh.addNode("memory_input","input"),this.neuralMesh.addNode("decision_output","output"),this.neuralMesh.addNode("emotion_output","output"),this.neuralMesh.addConnection("sensory_input","decision_output",.5),this.neuralMesh.addConnection("memory_input","emotion_output",.3),this.isBooted=!0,this.logger?.info("Organism boot completed successfully",this.id)}catch(t){throw this.logger?.error("Failed to boot organism",{organismId:this.id,error:t}),a.logSimpleError("OrganismCore","boot",t instanceof Error?t.message:"Boot failed","error"),t}}async hibernate(){return a.safeExecuteAsync((async()=>{await this.mutationBatcher.flushBatch(),this.mutationBatcher.dispose(),await this.mesh.suspend(),console.log("Organism core hibernating...")}),void 0,{component:"OrganismCore",method:"hibernate"})}async measurePerformance(){try{return{cpu:await this.mesh.getCPUUsage(),memory:await this.mesh.getMemoryUsage(),neuralActivity:this.calculateNeuralActivity(),connectionStrength:this.calculateConnectionStrength()}}catch(t){return{cpu:0,memory:0,neuralActivity:0,connectionStrength:0}}}calculateNeuralActivity(){try{return this.mesh.getNeuralActivity()}catch(t){return 0}}calculateConnectionStrength(){try{return this.mesh.getConnectionStrength()}catch(t){return 0}}handleBootError(){}}}},a={};function r(t){var e=a[t];if(void 0!==e)return e.exports;var i=a[t]={exports:{}};return s[t](i,i.exports,r),i.exports}function n(t){return t&&"string"==typeof t.code&&"string"==typeof t.status}function o(t){if(null==t)return t;if("function"==typeof t)return"[Function]";if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if("object"!=typeof t)return t;if(Array.isArray(t))return t.map(o);const e={},i=new WeakSet;if(i.has(t))return"[Circular Reference]";i.add(t);for(const i in t)if(t.hasOwnProperty(i))try{e[i]=o(t[i])}catch(t){console.warn(`Failed to serialize property ${i}:`,t),e[i]="[Non-serializable]"}return e}r.m=s,r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((e,i)=>(r.f[i](t,e),e)),[])),r.u=t=>"background/"+t+".index.js",r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},t={792:0},e=e=>{var i,s,{__webpack_ids__:a,__webpack_modules__:n,__webpack_runtime__:o}=e,c=0;for(i in n)r.o(n,i)&&(r.m[i]=n[i]);for(o&&o(r);c<a.length;c++)s=a[c],r.o(t,s)&&t[s]&&t[s][0](),t[a[c]]=0},r.f.j=(i,s)=>{var a=r.o(t,i)?t[i]:void 0;if(0!==a)if(a)s.push(a[1]);else{var n=import("../"+r.u(i)).then(e,(e=>{throw 0!==t[i]&&(t[i]=void 0),e}));n=Promise.race([n,new Promise((e=>a=t[i]=[e]))]),s.push(a[1]=n)}},function(t){t.PAGE_VISIT="PAGE_VISIT",t.SCROLL_EVENT="SCROLL_EVENT",t.ORGANISM_UPDATE="ORGANISM_UPDATE",t.ORGANISM_MUTATE="ORGANISM_MUTATE",t.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",t.WEBGL_INIT="WEBGL_INIT",t.WEBGL_ERROR="WEBGL_ERROR",t.WEBGL_INITIALIZED="WEBGL_INITIALIZED",t.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",t.GENERATE_INVITATION="GENERATE_INVITATION",t.INVITATION_GENERATED="INVITATION_GENERATED",t.CONSUME_INVITATION="CONSUME_INVITATION",t.INVITATION_CONSUMED="INVITATION_CONSUMED",t.CHECK_INVITATION="CHECK_INVITATION",t.INVITATION_CHECKED="INVITATION_CHECKED",t.MURMUR="MURMUR",t.GET_INVITER="GET_INVITER",t.INVITER_RESULT="INVITER_RESULT",t.GET_INVITEES="GET_INVITEES",t.INVITEES_RESULT="INVITEES_RESULT",t.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",t.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",t.INTERACTION_DETECTED="INTERACTION_DETECTED",t.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",t.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",t.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",t.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",t.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",t.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",t.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",t.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",t.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED"}(i||(i={}));class c{constructor(t){this.source=t,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){chrome.runtime.onMessage.addListener(((t,e,i)=>(this.shouldProcessMessage(t)&&(this.enqueueMessage(t),i({received:!0})),!1)))}shouldProcessMessage(t){return this.filters.every((e=>e(t)))}async enqueueMessage(t){if(this.messageQueue.push(t),!this.processing){this.processing=!0;try{await this.processQueue()}finally{this.processing=!1}}}async processQueue(){for(;this.messageQueue.length>0;){const t=this.messageQueue.shift();await this.processMessage(t)}}async processMessage(t){if(!function(t,e){switch(t){case i.ORGANISM_UPDATE:return(s=e)&&"string"==typeof s.id&&"number"==typeof s.generation&&"number"==typeof s.health&&"number"==typeof s.energy&&s.traits&&"object"==typeof s.traits;case i.ORGANISM_MUTATE:return function(t){return t&&"string"==typeof t.type&&"string"==typeof t.trigger}(e);case i.PAGE_VISIT:case i.SCROLL_EVENT:return function(t){return t&&"string"==typeof t.url&&"number"==typeof t.visitCount}(e);case i.MURMUR:return function(t){return t&&"string"==typeof t.text&&"number"==typeof t.timestamp}(e);case i.GENERATE_INVITATION:case i.CONSUME_INVITATION:case i.CHECK_INVITATION:return function(t){return t&&"string"==typeof t.code}(e);case i.INVITATION_GENERATED:return"string"==typeof e||n(e);case i.INVITATION_CONSUMED:case i.INVITATION_CHECKED:return n(e);case i.SHARED_MUTATION_RESULT:return"string"==typeof e||e&&"object"==typeof e;default:return!0}var s}(t.type,t.payload))return void console.warn(`[MessageBus] Payload non valide pour le type ${t.type}`,t.payload);for(const e of this.globalHandlers)try{await e(t)}catch(t){console.error("Error in global handler:",t)}const e=this.handlers.get(t.type);if(e)for(const i of e)try{await i(t)}catch(e){console.error(`Error in handler for ${t.type}:`,e)}}on(t,e){this.handlers.has(t)||this.handlers.set(t,new Set),this.handlers.get(t).add(e)}off(t,e){const i=this.handlers.get(t);i&&i.delete(e)}onAny(t){this.globalHandlers.add(t)}offAny(t){this.globalHandlers.delete(t)}addFilter(t){this.filters.push(t)}async send(t){const e={...t,source:this.source,timestamp:Date.now(),id:crypto.randomUUID()};try{const t=function(t){try{return JSON.parse(JSON.stringify(t))}catch(e){return console.warn("Message serialization issue, cleaning object:",e),o(t)}}(e);if("content"===this.source)await chrome.runtime.sendMessage(t);else{const e=await chrome.tabs.query({}),i=t=>t.active||t.url&&t.url.includes("symbiont"),s=e.filter(i);for(const e of s)e.id&&chrome.tabs.sendMessage(e.id,t).catch((()=>{}));chrome.runtime.sendMessage(t).catch((()=>{}))}}catch(t){console.error("Error sending message:",t)}}sendToBackground(t){this.send(t)}emit(t,e){const i=this.handlers.get(t);i&&i.forEach((i=>i({type:t,payload:e})))}handleMessage(t,e){console.log("Handling message:",t)}onMessage(t,e,i){return console.log("Received message:",t),!0}sendToFrame(t,e,i){console.log("Sending to frame:",e,i)}}class h{constructor(){this.db=null,this.DB_NAME="symbiont-db",this.DB_VERSION=3}async initialize(){return new Promise(((t,e)=>{const i=indexedDB.open(this.DB_NAME,this.DB_VERSION);i.onerror=()=>e(i.error),i.onsuccess=()=>{this.db=i.result,t()},i.onupgradeneeded=t=>{const e=t.target.result;if(!e.objectStoreNames.contains("organisms")){const t=e.createObjectStore("organisms",{keyPath:"id"});t.createIndex("generation","generation",{unique:!1}),t.createIndex("createdAt","createdAt",{unique:!1})}if(!e.objectStoreNames.contains("behaviors")){const t=e.createObjectStore("behaviors",{keyPath:"url"});t.createIndex("lastVisit","lastVisit",{unique:!1}),t.createIndex("visitCount","visitCount",{unique:!1})}if(!e.objectStoreNames.contains("mutations")){const t=e.createObjectStore("mutations",{keyPath:"id",autoIncrement:!0});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("type","type",{unique:!1})}if(e.objectStoreNames.contains("settings")||e.createObjectStore("settings",{keyPath:"key"}),!e.objectStoreNames.contains("invitations")){const t=e.createObjectStore("invitations",{keyPath:"code"});t.createIndex("createdAt","createdAt",{unique:!1}),t.createIndex("status","status",{unique:!1})}}}))}async getOrganism(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["organisms"],"readonly").objectStore("organisms");if(t){const a=s.get(t);a.onsuccess=()=>e(a.result||null),a.onerror=()=>i(a.error)}else{const t=s.openCursor();t.onsuccess=t=>{const i=t.target.result;e(i?i.value:null)},t.onerror=()=>i(t.error)}}))}async saveOrganism(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["organisms"],"readwrite").objectStore("organisms").put(t);s.onsuccess=()=>e(),s.onerror=()=>i(s.error)}))}async getBehavior(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").get(t);s.onsuccess=()=>e(s.result||null),s.onerror=()=>i(s.error)}))}async saveBehavior(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["behaviors"],"readwrite").objectStore("behaviors").put(t);s.onsuccess=()=>e(),s.onerror=()=>i(s.error)}))}async addMutation(t){if(!this.db)throw new Error("Database not initialized");const e={...t,timestamp:t.timestamp||Date.now()};return new Promise(((t,i)=>{const s=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").add(e);s.onsuccess=()=>t(),s.onerror=()=>i(s.error)}))}async getRecentMutations(t=10){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["mutations"],"readonly").objectStore("mutations").index("timestamp").openCursor(null,"prev"),a=[];s.onsuccess=i=>{const s=i.target.result;s&&a.length<t?(a.push(s.value),s.continue()):e(a)},s.onerror=()=>i(s.error)}))}async getSetting(t,e){if(!this.db)throw new Error("Database not initialized");return new Promise(((i,s)=>{const a=this.db.transaction(["settings"],"readonly").objectStore("settings").get(t);a.onsuccess=()=>{const t=a.result;i(t?t.value:e)},a.onerror=()=>s(a.error)}))}async setSetting(t,e){if(!this.db)throw new Error("Database not initialized");return new Promise(((i,s)=>{const a=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:t,value:e});a.onsuccess=()=>i(),a.onerror=()=>s(a.error)}))}async addInvitation(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").add({...t,createdAt:t.createdAt||Date.now()});s.onsuccess=()=>e(),s.onerror=()=>i(s.error)}))}async updateInvitation(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").put(t);s.onsuccess=()=>e(),s.onerror=()=>i(s.error)}))}async getInvitation(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,i)=>{const s=this.db.transaction(["invitations"],"readonly").objectStore("invitations").get(t);s.onsuccess=()=>e(s.result||null),s.onerror=()=>i(s.error)}))}async getAllInvitations(){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,e)=>{const i=this.db.transaction(["invitations"],"readonly").objectStore("invitations").openCursor(),s=[];i.onsuccess=e=>{const i=e.target.result;i?(s.push(i.value),i.continue()):t(s)},i.onerror=()=>e(i.error)}))}async getBehaviorPatterns(){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,e)=>{const i=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),s=[];i.onsuccess=e=>{const i=e.target.result;i?(s.push(i.value),i.continue()):(s.sort(((t,e)=>e.visitCount!==t.visitCount?e.visitCount-t.visitCount:e.lastVisit-t.lastVisit)),t(s))},i.onerror=()=>e(i.error)}))}async getRecentActivity(t=864e5){if(!this.db)throw new Error("Database not initialized");const e=Date.now()-t;return new Promise(((t,i)=>{const s=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),a=[];s.onsuccess=i=>{const s=i.target.result;if(s){const t=s.value,i=(t.interactions||[]).filter((t=>t.timestamp>=e));for(const e of i)a.push({...e,url:t.url});s.continue()}else a.sort(((t,e)=>e.timestamp-t.timestamp)),t(a)},s.onerror=()=>i(s.error)}))}async cleanup(t=30){if(!this.db)throw new Error("Database not initialized");const e=Date.now()-24*t*60*60*1e3;return new Promise(((t,i)=>{const s=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").index("timestamp"),a=IDBKeyRange.upperBound(e),r=s.openCursor(a);r.onsuccess=e=>{const i=e.target.result;i?(i.delete(),i.continue()):t()},r.onerror=()=>i(r.error)}))}close(){this.db&&(this.db.close(),this.db=null)}}class l extends EventTarget{constructor(t){super(),this.isActive=!1,this.sessionStart=0,this.currentUrl="",this.previousUrl="",this.pageStartTime=0,this.navigationHistory=[],this.pageDurations=[],this.domainHistory=new Set,this.backNavigationCount=0,this.forwardNavigationCount=0,this.formNavigationCount=0,this.linkClickCount=0,this.lastNavigationTime=0,this.navigationGaps=[],this.bounceThreshold=1e4,this.deepEngagementThreshold=12e4,this.messageBus=t||null,this.setupEventListeners(),this.initializeCurrentPage()}setupEventListeners(){window.addEventListener("load",this.handlePageLoad.bind(this)),window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this)),window.addEventListener("unload",this.handlePageUnload.bind(this)),window.addEventListener("popstate",this.handlePopState.bind(this)),window.addEventListener("hashchange",this.handleHashChange.bind(this)),document.addEventListener("click",this.handleLinkClick.bind(this),!0),document.addEventListener("submit",this.handleFormSubmit.bind(this),!0),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),"PerformanceObserver"in window&&this.setupPerformanceObserver()}setupPerformanceObserver(){try{new PerformanceObserver((t=>{for(const e of t.getEntries())"navigation"===e.entryType&&this.handleNavigationTiming(e)})).observe({entryTypes:["navigation"]})}catch(t){console.warn("Performance Observer not available:",t)}}initializeCurrentPage(){this.currentUrl=window.location.href,this.pageStartTime=Date.now(),this.sessionStart=Date.now(),this.domainHistory.add(this.getDomain(this.currentUrl)),this.emitNavigationEvent({type:"page_load",timestamp:this.pageStartTime,url:{from:document.referrer||"direct",to:this.currentUrl,domain:this.getDomain(this.currentUrl),path:window.location.pathname,params:this.parseUrlParams(this.currentUrl),hash:window.location.hash||void 0},method:this.determineNavigationMethod(document.referrer),data:{referrer:document.referrer,userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}}})}handlePageLoad(){const t=Date.now()-this.pageStartTime;this.emitNavigationEvent({type:"navigation_end",timestamp:Date.now(),url:{from:this.previousUrl,to:this.currentUrl,domain:this.getDomain(this.currentUrl),path:window.location.pathname,params:this.parseUrlParams(this.currentUrl),hash:window.location.hash||void 0},method:"programmatic",duration:t,data:{loadTime:t,readyState:document.readyState}})}handleBeforeUnload(){this.recordPageDuration()}handlePageUnload(){this.recordPageDuration(),this.emitNavigationEvent({type:"page_unload",timestamp:Date.now(),url:{from:this.currentUrl,to:"unknown",domain:this.getDomain(this.currentUrl),path:window.location.pathname,params:this.parseUrlParams(this.currentUrl),hash:window.location.hash||void 0},method:"programmatic",duration:Date.now()-this.pageStartTime})}handlePopState(t){const e=window.location.href,i=this.isBackNavigation(e),s=this.isForwardNavigation(e);i&&this.backNavigationCount++,s&&this.forwardNavigationCount++,this.recordPageDuration(!1),this.updateUrlState(e);const a=window.location.hash||void 0;this.emitNavigationEvent({type:i||s?"back_forward":"state_change",timestamp:Date.now(),url:{from:this.previousUrl,to:e,domain:this.getDomain(e),path:window.location.pathname,params:this.parseUrlParams(e),hash:a},method:i?"back":s?"forward":"programmatic",data:{state:t.state,direction:i?"back":s?"forward":"unknown"}})}handleHashChange(){const t=window.location.href;this.emitNavigationEvent({type:"hash_change",timestamp:Date.now(),url:{from:this.currentUrl,to:t,domain:this.getDomain(t),path:window.location.pathname,params:this.parseUrlParams(t),hash:window.location.hash||void 0},method:"programmatic",data:{oldHash:this.getHash(this.currentUrl),newHash:window.location.hash||void 0}}),this.currentUrl=t}handleLinkClick(t){const e=this.findLinkElement(t.target);if(!e)return;const i=e.href;if(!i||i.startsWith("javascript:")||i.startsWith("mailto:")||i.startsWith("tel:"))return;this.linkClickCount++;const s=this.getDomain(i)!==this.getDomain(this.currentUrl);i.split("#")[0]===this.currentUrl.split("#")[0]||(this.recordPageDuration(),this.updateUrlState(i),this.emitNavigationEvent({type:"link_click",timestamp:Date.now(),url:{from:this.currentUrl,to:i,domain:this.getDomain(i),path:new URL(i).pathname,params:this.parseUrlParams(i),hash:new URL(i).hash||void 0},method:"click",data:{linkText:e.textContent?.slice(0,100),linkClass:e.className,isExternal:s,target:e.target,modifiers:{ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey}}}))}handleFormSubmit(t){const e=t.target;if(!e||"FORM"!==e.tagName)return;this.formNavigationCount++;const i=e.action||this.currentUrl,s=e.method.toLowerCase();this.recordPageDuration(),this.emitNavigationEvent({type:"form_navigation",timestamp:Date.now(),url:{from:this.currentUrl,to:i,domain:this.getDomain(i),path:new URL(i).pathname,params:this.parseUrlParams(i),hash:new URL(i).hash||void 0},method:"form",data:{formMethod:s,formAction:i,fieldCount:e.elements.length,hasFileInput:Array.from(e.elements).some((t=>"file"===t.type))}})}handleVisibilityChange(){document.hidden?this.recordPageDuration(!1):this.pageStartTime=Date.now()}handleNavigationTiming(t){const e={loadType:t.type,redirectCount:t.redirectCount,domContentLoaded:t.domContentLoadedEventEnd-t.domContentLoadedEventStart,loadComplete:t.loadEventEnd-t.loadEventStart,networkTime:t.responseEnd-t.requestStart,serverTime:t.responseStart-t.requestStart,transferSize:t.transferSize,decodedBodySize:t.decodedBodySize};this.emitNavigationEvent({type:"navigation_start",timestamp:Date.now(),url:{from:this.previousUrl,to:this.currentUrl,domain:this.getDomain(this.currentUrl),path:window.location.pathname,params:this.parseUrlParams(this.currentUrl),hash:window.location.hash||void 0},method:"programmatic",data:e})}recordPageDuration(t=!0){if(this.pageStartTime>0){const e=Date.now()-this.pageStartTime;if(this.pageDurations.push(e),this.pageDurations.length>100&&(this.pageDurations=this.pageDurations.slice(-100)),this.navigationHistory.push({url:this.currentUrl,timestamp:this.pageStartTime,duration:e,method:"recorded",referrer:this.previousUrl}),t&&(this.pageStartTime=Date.now()),this.lastNavigationTime>0){const t=Date.now()-this.lastNavigationTime;this.navigationGaps.push(t),this.navigationGaps.length>20&&(this.navigationGaps=this.navigationGaps.slice(-20))}this.lastNavigationTime=Date.now()}}updateUrlState(t){this.previousUrl=this.currentUrl,this.currentUrl=t,this.domainHistory.add(this.getDomain(t))}isBackNavigation(t){return this.navigationHistory.slice(-5).map((t=>t.url)).includes(t)&&t!==this.currentUrl}isForwardNavigation(t){return!0}findLinkElement(t){for(;t&&t!==document.body;){if("A"===t.tagName&&t.href)return t;t=t.parentElement}return null}getDomain(t){try{return new URL(t).hostname}catch{return"unknown"}}getHash(t){try{return new URL(t).hash}catch{return""}}parseUrlParams(t){try{const e=new URL(t),i={};for(const[t,s]of e.searchParams.entries())i[t]=s;return i}catch{return{}}}determineNavigationMethod(t){return t?(t.includes("google.com")||t.includes("bing.com")||t.includes("search")||(this.getDomain(t),this.getDomain(this.currentUrl)),"click"):"typed"}calculateMetrics(){const t=Date.now()-this.sessionStart,e=this.pageDurations.length>0?this.pageDurations.reduce(((t,e)=>t+e),0)/this.pageDurations.length:0,i=this.pageDurations.length/Math.max(1,t/6e4),s=this.pageDurations.filter((t=>t<this.bounceThreshold)).length,a=this.pageDurations.length>0?s/this.pageDurations.length:0,r=this.pageDurations.filter((t=>t>this.deepEngagementThreshold)).length,n=this.determineNavigationPattern();return{sessionStart:this.sessionStart,pageCount:this.pageDurations.length,domainCount:this.domainHistory.size,backCount:this.backNavigationCount,forwardCount:this.forwardNavigationCount,averagePageDuration:e,navigationVelocity:i,bounceRate:a,deepEngagementPages:r,navigationPattern:n}}determineNavigationPattern(){if(this.pageDurations.length<3)return"exploring";const t=this.pageDurations.reduce(((t,e)=>t+e),0)/this.pageDurations.length;return this.pageDurations.filter((t=>t<this.bounceThreshold)).length/this.pageDurations.length>.7?"bouncing":t>this.deepEngagementThreshold?"focused":this.backNavigationCount>.3*this.pageDurations.length?"lost":1===this.domainHistory.size?"focused":"linear"}emitNavigationEvent(t){this.dispatchEvent(new CustomEvent("navigation",{detail:t})),this.messageBus&&this.messageBus.sendToBackground({type:"NAVIGATION_EVENT",payload:t})}start(){this.isActive=!0,console.log("🧭 NavigationObserver started")}stop(){this.isActive=!1,this.recordPageDuration(),console.log("🧭 NavigationObserver stopped")}getMetrics(){return this.calculateMetrics()}on(t,e){this.addEventListener(t,(t=>e(t.detail)))}getNavigationHistory(){return{history:this.navigationHistory.slice(-20),currentSession:{duration:Date.now()-this.sessionStart,pageCount:this.pageDurations.length,domains:Array.from(this.domainHistory)},patterns:{averagePageDuration:this.pageDurations.reduce(((t,e)=>t+e),0)/this.pageDurations.length,navigationVelocity:this.pageDurations.length/Math.max(1,(Date.now()-this.sessionStart)/6e4),bounceRate:this.pageDurations.filter((t=>t<this.bounceThreshold)).length/this.pageDurations.length}}}getCurrentPageInfo(){return{url:this.currentUrl,domain:this.getDomain(this.currentUrl),timeOnPage:Date.now()-this.pageStartTime,isActive:this.isActive,referrer:this.previousUrl}}}class u{constructor(t){this.storage=t}async generateInvitation(t){const e={code:(await r.e(221).then(r.bind(r,221))).v4().slice(0,8).toUpperCase(),donorId:t,symbolicLink:this.generateSymbolicLink(),used:!1,createdAt:Date.now()};return await this.storage.addInvitation(e),e}async consumeInvitation(t,e){const i=await this.storage.getInvitation(t);return!i||i.used?null:(i.used=!0,i.receiverId=e,i.usedAt=Date.now(),await this.storage.updateInvitation(i),i)}async isValid(t){const e=await this.storage.getInvitation(t);return!!e&&!e.used}generateSymbolicLink(){const t=["#FF00FF","#00FFFF","#FFFF00","#FF8800","#00FF88","#8800FF"];return t[Math.floor(Math.random()*t.length)]}async getAllInvitations(){return await this.storage.getAllInvitations()}}const d={loop:["Encore ce même chemin... Qu'y cherches-tu ?","La boucle se répète, intention ou habitude ?","Revenir, encore et encore. Un besoin de repère ?"],idle:["Un temps de pause... ou d'hésitation ?","Le silence aussi fait partie du voyage.","L'inactivité, prélude à une nouvelle exploration ?"],exploration:["Nouveau territoire, nouvelle perspective.","L'exploration nourrit la curiosité.","Tu t'aventures hors des sentiers battus."],routine:["Les habitudes forgent des chemins familiers.","La routine rassure, mais l'inattendu surprend.","Encore ce site, comme un rituel quotidien."],default:["Tu reviens souvent ici quand tu doutes.","Pourquoi cette boucle ?","As-tu remarqué ce schéma dans ta navigation ?","Un autre détour, ou une quête de sens ?","Ce site semble t'attirer dans les moments de réflexion.","Encore une fois, tu explores ce chemin familier.","Et si tu essayais une nouvelle direction ?","La répétition cache-t-elle une intention ?","Un murmure dans le flux de tes habitudes...","Parfois, la boucle est une porte vers l'inattendu."]},m={morning:["Un nouveau jour, une nouvelle boucle commence.","Le matin invite à la découverte.","L'aube de tes habitudes numériques."],afternoon:["L'après-midi, la routine s'installe.","Un moment propice à l'exploration ou à la répétition ?","Le soleil haut, l'esprit vagabonde."],evening:["Le soir, tu reviens à l'essentiel.","La nuit favorise les détours intérieurs.","Encore connecté, même à la tombée du jour."],weekend:["Le week-end, les chemins changent.","Un rythme différent, des envies nouvelles.","La liberté du week-end se lit dans ta navigation."]};class g{generateMurmur(t){if(function(){const t=(new Date).getDay();return 0===t||6===t}()){const t=m.weekend;if(Math.random()<.5)return t[Math.floor(Math.random()*t.length)]}else{const t=function(){const t=(new Date).getHours();return t<12?"morning":t<18?"afternoon":"evening"}();if(m[t]&&Math.random()<.4){const e=m[t];return e[Math.floor(Math.random()*e.length)]}}const e=t&&d[t]?d[t]:d.default;return e[Math.floor(Math.random()*e.length)]}}class p{static detectRepetition(t,e=3){const i={};for(const e of t)i[e.type]=(i[e.type]||0)+1;return Object.entries(i).filter((([t,i])=>i>=e)).map((([t,e])=>({type:"repetition",score:e,details:{eventType:t}})))}static detectAlternance(t,e,i,s=4){let a=0,r=null;for(const s of t)s.type!==e&&s.type!==i||s.type===r?s.type===r&&(a=1,r=s.type):(a++,r=s.type);return a>=s?[{type:"alternance",score:a,details:{typeA:e,typeB:i}}]:[]}static detectBurst(t,e=1e3,i=3){if(t.length<i)return[];let s=1,a=1;for(let i=1;i<t.length;i++)t[i].timestamp-t[i-1].timestamp<=e?(s++,a=Math.max(a,s)):s=1;return a>=i?[{type:"burst",score:a,details:{maxInterval:e}}]:[]}static detectTemporalPattern(t,e=1e3,i=.2){if(t.length<3)return[];const s=[];for(let e=1;e<t.length;e++)s.push(t[e].timestamp-t[e-1].timestamp);const a=s.reduce(((t,e)=>t+e),0)/s.length,r=s.reduce(((t,e)=>t+Math.pow(e-a,2)),0)/s.length,n=Math.sqrt(r);return a>=e&&n/a<i?[{type:"temporal",score:a,details:{std:n,count:t.length}}]:[]}}class y{static getInstance(){return this.instance||(this.instance=new y),this.instance}async setItem(t,e){try{await chrome.storage.local.set({[t]:e})}catch(t){throw console.error("Storage error:",t),t}}async getItem(t){try{return(await chrome.storage.local.get([t]))[t]||null}catch(t){return console.error("Storage retrieval error:",t),null}}async removeItem(t){try{await chrome.storage.local.remove([t])}catch(t){console.error("Storage removal error:",t)}}}class v{static get swLocalStorage(){return{getItem:t=>this.storage.getItem(t),setItem:(t,e)=>this.storage.setItem(t,e),removeItem:t=>this.storage.removeItem(t)}}static get swIndexedDB(){return globalThis.indexedDB}static get swCryptoAPI(){return{...globalThis.crypto,encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)}}}v.storage=y.getInstance(),v.swCrypto=new class{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(t){try{const e=new TextEncoder,i=e.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),s=await crypto.subtle.importKey("raw",i,{name:"AES-GCM"},!1,["encrypt"]),a=crypto.getRandomValues(new Uint8Array(12)),r=e.encode(JSON.stringify(t)),n=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},s,r),o=new Uint8Array(a.length+n.byteLength);return o.set(a,0),o.set(new Uint8Array(n),a.length),btoa(String.fromCharCode(...o))}catch(e){console.error("Encryption failed, using fallback:",e);const i=JSON.stringify(t);return btoa(unescape(encodeURIComponent(i)))}}async decryptSensitiveData(t){try{const e=Uint8Array.from(atob(t),(t=>t.charCodeAt(0))),i=e.slice(0,12),s=e.slice(12),a=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),r=await crypto.subtle.importKey("raw",a,{name:"AES-GCM"},!1,["decrypt"]),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},r,s),o=new TextDecoder;return JSON.parse(o.decode(n))}catch(e){console.error("Decryption failed, trying fallback:",e);try{const e=decodeURIComponent(escape(atob(t)));return JSON.parse(e)}catch(t){throw console.error("All decryption methods failed:",t),new Error("Unable to decrypt data")}}}},v.swBroadcastChannel=class{constructor(t){this.handlers=new Map,this.channelName=t,this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener(((t,e,i)=>"CRYPTO_OPERATION"===t.type||t.channel===this.channelName&&(this.handleMessage(t.data),!0)))}serializeMessageData(t){try{return JSON.parse(JSON.stringify(t))}catch(e){return console.warn("Message serialization issue, cleaning object:",e),this.cleanObjectForSerialization(t)}}cleanObjectForSerialization(t){if(null==t)return t;if("function"==typeof t)return"[Function]";if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if("object"!=typeof t)return t;if(Array.isArray(t))return t.map((t=>this.cleanObjectForSerialization(t)));const e={};for(const i in t)if(t.hasOwnProperty(i))try{e[i]=this.cleanObjectForSerialization(t[i])}catch(t){console.warn(`Failed to serialize property ${i}:`,t),e[i]="[Non-serializable]"}return e}postMessage(t){const e=this.serializeMessageData(t);chrome.tabs.query({},(t=>{t.forEach((t=>{t.id&&chrome.tabs.sendMessage(t.id,{channel:this.channelName,data:e}).catch((()=>{}))}))})),this.broadcastViaStorage(e)}async broadcastViaStorage(t){const e=y.getInstance(),i=Date.now(),s=`broadcast_${this.channelName}_${i}`;await e.setItem(s,JSON.stringify({data:t,timestamp:i,channel:this.channelName})),setTimeout((async()=>{await e.removeItem(s)}),3e4)}handleMessage(t){(this.handlers.get("message")||[]).forEach((e=>{try{e({data:t})}catch(t){console.error("Message handler error:",t)}}))}set onmessage(t){this.handlers.has("message")||this.handlers.set("message",[]),this.handlers.get("message").push(t)}};const f=v.swLocalStorage,w=(v.swBroadcastChannel,v.swCryptoAPI),b=v.swIndexedDB;class E{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(t){if(w&&w.subtle){const e=new TextEncoder,i=e.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),s=await w.subtle.importKey("raw",i,{name:"AES-GCM"},!1,["encrypt"]),a=w.getRandomValues(new Uint8Array(12)),r=e.encode(JSON.stringify(t)),n=await w.subtle.encrypt({name:"AES-GCM",iv:a},s,r),o=new Uint8Array(a.length+n.byteLength);return o.set(a,0),o.set(new Uint8Array(n),a.length),btoa(String.fromCharCode(...o))}{const e=JSON.stringify(t);return btoa(unescape(encodeURIComponent(e)))}}async decryptSensitiveData(t){if("string"!=typeof t)throw new Error("decryptSensitiveData attend une chaîne de caractères.");if(!w||!w.subtle){const e=decodeURIComponent(escape(atob(String(t))));return JSON.parse(e)}try{const e=Uint8Array.from(atob(String(t)),(t=>t.charCodeAt(0))),i=e.slice(0,12),s=e.slice(12),a=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),r=await w.subtle.importKey("raw",a,{name:"AES-GCM"},!1,["decrypt"]),n=await w.subtle.decrypt({name:"AES-GCM",iv:i},r,s);return JSON.parse((new TextDecoder).decode(n))}catch{const e=decodeURIComponent(escape(atob(String(t))));return JSON.parse(e)}}anonymizeForSharing(t){const e={...t};return"url"in e&&(e.url="anonymized"),"userId"in e&&"string"==typeof e.userId&&(e.userId=this.hash(e.userId)),"id"in e&&"string"==typeof e.id&&(e.id=this.hash(e.id)),e}validateDataAccess(t,e="user"){return!(!t.userId||!t.resource||"admin"===e&&"admin"!==t.role)}hash(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return btoa(e.toString())}}class S{static setDependencies(t){this.dependencies=t}static createOrganism(t,e){if(!this.dependencies)throw new Error("OrganismFactory dependencies not set. Call setDependencies() first.");const{OrganismCore:i}=r(326);return new i(t,e,this.dependencies.createNeuralMesh)}static createNeuralMesh(){const{NeuralMesh:t}=r(194);return new t}}S.dependencies=null;class I{constructor(){this.failureCount=0,this.open=!1,this.lastFailure=0,this.failureThreshold=5,this.recoveryTimeout=3e4}isOpen(){return this.open&&Date.now()-this.lastFailure>this.recoveryTimeout&&(this.open=!1,this.failureCount=0),this.open}recordSuccess(){this.failureCount=0,this.open=!1}recordFailure(){this.failureCount++,this.lastFailure=Date.now(),this.failureCount>=this.failureThreshold&&(this.open=!0)}}class T{constructor(){this.key="symbiont_messages"}async enqueue(t){console.log("[ResilientMessageBus] enqueue",t);const e=JSON.parse(await f.getItem(this.key)||"[]");e.push(t),await f.setItem(this.key,JSON.stringify(e)),console.log("[ResilientMessageBus] enqueue OK",e.length)}async dequeue(){const t=JSON.parse(await f.getItem(this.key)||"[]"),e=t.shift();return await f.setItem(this.key,JSON.stringify(t)),console.log("[ResilientMessageBus] dequeue",e),e}async getAll(){const t=JSON.parse(await f.getItem(this.key)||"[]");return console.log("[ResilientMessageBus] getAll",t.length),t}}const M=new class{constructor(){this.memoryCache=new Map,this.persistentStorage=chrome.storage?.local,this.indexedDB=null,this.emergencyLocalStorage=f,this.indexedDBReady=this.setupMultiLayerStorage(),this.setupDataReplication(),this.setupIntegrityMonitoring()}async store(t,e,i={}){console.log("[HybridStorageManager] store - Mémoire",t,e),this.memoryCache.set(t,e);try{await new Promise(((i,s)=>{this.persistentStorage.set({[t]:e},(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):i(!0)}))})),console.log("[HybridStorageManager] store - chrome.storage.local OK",t)}catch(e){console.warn("[HybridStorageManager] store - chrome.storage.local failed, fallback IndexedDB",t,e)}try{if(await this.indexedDBReady,!this.indexedDB)throw new Error("IndexedDB not ready");await new Promise(((i,s)=>{const a=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(e,t);a.onsuccess=()=>i(!0),a.onerror=()=>s(a.error)})),console.log("[HybridStorageManager] store - IndexedDB OK",t)}catch(i){console.warn("[HybridStorageManager] store - IndexedDB failed, fallback localStorage",t,i),await this.emergencyLocalStorage.setItem(t,JSON.stringify(e)),console.log("[HybridStorageManager] store - localStorage d'urgence OK",t)}}async retrieve(t){if(this.memoryCache.has(t))return console.log("[HybridStorageManager] retrieve - Mémoire HIT",t),this.memoryCache.get(t);try{const e=await new Promise(((e,i)=>{this.persistentStorage.get([t],(s=>{chrome.runtime.lastError?i(chrome.runtime.lastError):e(s[t])}))}));if(void 0!==e)return this.memoryCache.set(t,e),console.log("[HybridStorageManager] retrieve - chrome.storage.local OK",t),e}catch(e){console.warn("[HybridStorageManager] retrieve - chrome.storage.local failed",t,e)}try{if(await this.indexedDBReady,this.indexedDB){const e=await new Promise(((e,i)=>{const s=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(t);s.onsuccess=()=>e(s.result),s.onerror=()=>i(s.error)}));if(void 0!==e)return this.memoryCache.set(t,e),console.log("[HybridStorageManager] retrieve - IndexedDB OK",t),e}}catch(e){console.warn("[HybridStorageManager] retrieve - IndexedDB failed",t,e)}try{const e=await this.emergencyLocalStorage.getItem(t);if(e)return console.log("[HybridStorageManager] retrieve - localStorage d'urgence OK",t),JSON.parse(e)}catch(e){console.warn("[HybridStorageManager] retrieve - localStorage d'urgence failed",t,e)}return null}setupMultiLayerStorage(){return new Promise((t=>{let e=!1;const i=setTimeout((()=>{e||(console.warn("[HybridStorageManager] IndexedDB init timeout (5s), fallback only"),this.indexedDB=null,e=!0,t(!1))}),5e3);try{const s=b.open("symbiont-db",1);s.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("symbiont")||e.createObjectStore("symbiont")},s.onsuccess=()=>{this.indexedDB=s.result,e||(clearTimeout(i),e=!0,console.log("[HybridStorageManager] IndexedDB ready"),t(!0))},s.onerror=()=>{this.indexedDB=null,e||(clearTimeout(i),e=!0,console.warn("[HybridStorageManager] IndexedDB failed to open"),t(!1))}}catch(s){this.indexedDB=null,e||(clearTimeout(i),e=!0,console.warn("[HybridStorageManager] IndexedDB exception",s),t(!1))}}))}isIndexedDBReady(){return!!this.indexedDB}async syncData(){}async syncKeyAcrossLayers(t,e){this.memoryCache.set(t,e);try{await new Promise(((i,s)=>{this.persistentStorage.set({[t]:e},(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):i(!0)}))}))}catch{}try{await this.indexedDBReady,this.indexedDB&&await new Promise(((i,s)=>{const a=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(e,t);a.onsuccess=()=>i(!0),a.onerror=()=>s(a.error)}))}catch{}try{await this.emergencyLocalStorage.setItem(t,JSON.stringify(e))}catch{}}setupDataReplication(){chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener(((t,e)=>{if("local"===e)for(const e in t){const{newValue:i}=t[e];this.syncKeyAcrossLayers(e,i),console.log("[HybridStorageManager] DataReplication - Synchronisation des couches",e)}}))}setupIntegrityMonitoring(){setInterval((async()=>{for(const t of this.memoryCache.keys())try{const e=this.memoryCache.get(t),i=await new Promise((e=>{this.persistentStorage.get([t],(i=>e(i[t])))}));let s;await this.indexedDBReady,this.indexedDB&&(s=await new Promise((e=>{const i=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(t);i.onsuccess=()=>e(i.result),i.onerror=()=>e(void 0)})));const a=await this.emergencyLocalStorage.getItem(t),r=[e,i,s,a?JSON.parse(a):void 0].filter((t=>void 0!==t));if(!r.every((t=>JSON.stringify(t)===JSON.stringify(r[0])))){console.warn("[HybridStorageManager] IntegrityMonitoring - Divergence détectée pour",t);const e={};for(const t of r){const i=JSON.stringify(t);e[i]=(e[i]||0)+1}const[i]=Object.entries(e).sort(((t,e)=>e[1]-t[1]))[0],s=JSON.parse(i);if(this.memoryCache.set(t,s),this.persistentStorage.set({[t]:s}),this.indexedDB){this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(s,t)}this.emergencyLocalStorage.setItem(t,JSON.stringify(s)),console.log("[HybridStorageManager] IntegrityMonitoring - Auto-réparation appliquée pour",t)}}catch(e){console.warn("[HybridStorageManager] IntegrityMonitoring - Erreur sur",t,e)}}),6e4)}},N=new class{constructor(){this.connectionState="offline",this.messageQueue=new T,this.failureStrategies=new Map,this.circuitBreaker=new I,this.failureQueue=[],this.isConnected=!1,this.connectionAttempts=0,this.setupFailureStrategies()}setupFailureStrategies(){this.failureStrategies.set("ORGANISM_UPDATE",{maxRetries:3,backoffStrategy:"exponential",fallbackAction:this.cacheOrganismState,criticalLevel:"high"}),this.failureStrategies.set("INTERACTION_DETECTED",{maxRetries:5,backoffStrategy:"linear",fallbackAction:this.queueForLaterSync,criticalLevel:"medium"}),this.failureStrategies.set("PAGE_ANALYSIS_COMPLETE",{maxRetries:2,backoffStrategy:"immediate",fallbackAction:this.processLocally,criticalLevel:"low"})}async send(t){if(this.circuitBreaker.isOpen())return await this.messageQueue.enqueue(t),{success:!1,queued:!0,error:"Circuit breaker open"};let e=0;const i=this.failureStrategies.get(t.type),s=i?.maxRetries||2;for(;e<=s;)try{return await this.simulateSend(t),this.circuitBreaker.recordSuccess(),{success:!0}}catch(a){if(this.circuitBreaker.recordFailure(),e++,e>s)return i&&await i.fallbackAction.call(this,t),await this.messageQueue.enqueue(t),{success:!1,queued:!0,error:a};await this.wait(this.getBackoff(i?.backoffStrategy,e))}return{success:!1,queued:!0,error:"Unknown error"}}async simulateSend(t){return{success:!0,id:`sim_${Date.now()}`}}getBackoff(t="immediate",e){return"exponential"===t?500*Math.pow(2,e):"linear"===t?500*e:0}wait(t){return new Promise((e=>setTimeout(e,t)))}async cacheOrganismState(t){console.log("[ResilientMessageBus] fallback cacheOrganismState",t),await f.setItem("symbiont_organism_cache",JSON.stringify(t))}async queueForLaterSync(t){console.log("[ResilientMessageBus] fallback queueForLaterSync",t),await this.messageQueue.enqueue(t)}async processLocally(t){console.log("[ResilientMessageBus] fallback processLocally",t),await f.setItem("symbiont_local_processing",JSON.stringify(t))}_attemptConnection(){return Promise.resolve(!0)}_processMessage(t){}};async function C(t){return await M.retrieve(t)}async function D(t,e){await M.store(t,e)}new class{constructor(t){this.metrics={cpu:[],memory:[],latency:[],errors:0},this.alertCallback=null,t&&(this.alertCallback=t),this.setupMonitoring()}setupMonitoring(){setInterval((()=>{this.collectMetrics(),this.checkHealth()}),5e3)}collectMetrics(){const t=.2*Math.random(),e=20*Math.random(),i=5*Math.random();this.metrics.cpu.push(t),this.metrics.memory.push(e),this.metrics.latency.push(i),this.metrics.cpu.length>20&&this.metrics.cpu.shift(),this.metrics.memory.length>20&&this.metrics.memory.shift(),this.metrics.latency.length>20&&this.metrics.latency.shift()}checkHealth(){const t=t=>t.reduce(((t,e)=>t+e),0)/(t.length||1),e=t(this.metrics.cpu),i=t(this.metrics.memory),s=t(this.metrics.latency);e>.18&&this.alert("CPU élevé : "+e.toFixed(3)),i>18&&this.alert("Mémoire élevée : "+i.toFixed(2)+"MB"),s>4&&this.alert("Latence élevée : "+s.toFixed(2)+"ms"),this.metrics.errors>0&&this.alert("Erreurs détectées : "+this.metrics.errors)}logError(){this.metrics.errors++}alert(t){console.warn("🛑 [HealthMonitor]",t),this.alertCallback&&this.alertCallback(t)}}((async t=>{await M.store("symbiont_health_alert_"+Date.now(),{msg:t,timestamp:Date.now()})})),(async()=>{const t={type:"ORGANISM_UPDATE",payload:{state:{id:"demo",traits:{focus:1}},timestamp:Date.now()}};(await N.send(t)).success||console.warn("Message ORGANISM_UPDATE fallback, voir la queue persistante.")})();let A=null;A=new class{constructor(){this.organism=null,this.activated=!1,this.events=[],this.collectiveThresholds=[10,50,100,250,500],this.reachedThresholds=[],this.security=new E,this.messageBus=new c("background"),this.storage=new h,this._navigationObserver=new l(this.messageBus),this.invitationService=new u(this.storage),this.murmureService=new g,this._organismFactory=new S,C("symbiont_collective_thresholds").then((t=>{this.reachedThresholds=t?JSON.parse(t):[],this.initialize()}))}async initialize(){try{await this.storage.initialize(),this.activated="true"===await C("symbiont_activated"),this.activated?(this.organism=await this.storage.getOrganism(),this.organism||(this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism))):this.organism=null,this.setupMessageHandlers(),this.startPeriodicTasks(),console.log("Background service initialized")}catch(t){console.error("Failed to initialize background service:",t)}}createNewOrganism(){const t=this.generateVisualDNA();return{id:crypto.randomUUID(),generation:1,health:100,energy:100,traits:{curiosity:100*Math.random(),focus:100*Math.random(),rhythm:100*Math.random(),empathy:100*Math.random(),creativity:100*Math.random()},visualDNA:t,lastMutation:Date.now(),mutations:[],createdAt:Date.now(),dna:t,birthTime:Date.now(),socialConnections:[],memoryFragments:[]}}generateVisualDNA(){let t="";for(let e=0;e<64;e++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}setupMessageHandlers(){this.messageBus.on(i.PAGE_VISIT,(async t=>{const{url:e,title:i}=t.payload;let s=await this.storage.getBehavior(e)||{url:e,visitCount:0,totalTime:0,scrollDepth:0,lastVisit:Date.now(),interactions:[]};s.visitCount++,s.lastVisit=Date.now(),await this.storage.saveBehavior(s),this.events.push({type:"visit",timestamp:Date.now(),url:e}),this.updateOrganismTraits(e,i),this.analyzeContextualPatterns()})),this.messageBus.on(i.SCROLL_EVENT,(async t=>{const{url:e,scrollDepth:i}=t.payload,s=await this.storage.getBehavior(e);s&&(s.scrollDepth=Math.max(s.scrollDepth,i),await this.storage.saveBehavior(s)),this.events.push({type:"scroll",timestamp:Date.now(),url:e}),this.analyzeContextualPatterns()})),this.messageBus.on(i.INTERACTION_DETECTED,(t=>{const{type:e,timestamp:i,target:s,data:a}=t.payload;this.events.push({type:e,timestamp:i,target:s,...a}),this.analyzeContextualPatterns()})),this.messageBus.on(i.GENERATE_INVITATION,(async t=>{const{donorId:e}=t.payload,s=await this.invitationService.generateInvitation(e),a={code:s.code,createdAt:s.createdAt,consumed:s.used??!1,inviter:s.donorId,...s.usedAt&&{consumedAt:s.usedAt},...s.receiverId&&{invitee:s.receiverId}};let r=a;try{r=await this.security.encryptSensitiveData(a)}catch(t){r=a}await N.send({type:i.INVITATION_GENERATED,payload:r})})),this.messageBus.on(i.CONSUME_INVITATION,(async t=>{const{code:e,receiverId:s,role:a}=t.payload;if(!this.security.validateDataAccess({userId:s,resource:e,role:a},"user"))return void N.send({type:i.INVITATION_CONSUMED,payload:{error:"Accès refusé."}});const r=await this.invitationService.consumeInvitation(e,s);r&&(this.activated=!0,await D("symbiont_activated","true"),this.organism||(this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism))),N.send({type:i.INVITATION_CONSUMED,payload:r})})),this.messageBus.on(i.CHECK_INVITATION,(async t=>{const{code:e}=t.payload,s=await this.invitationService.isValid(e);N.send({type:i.INVITATION_CHECKED,payload:{code:e,valid:s}})})),this.messageBus.on(i.GET_INVITER,(async t=>{const{userId:e}=t.payload,s=(await this.invitationService.getAllInvitations()).find((t=>t.receiverId===e));N.send({type:i.INVITER_RESULT,payload:s||null})})),this.messageBus.on(i.GET_INVITEES,(async t=>{const{userId:e}=t.payload,s=(await this.invitationService.getAllInvitations()).filter((t=>t.donorId===e));N.send({type:i.INVITEES_RESULT,payload:s})})),this.messageBus.on(i.GET_INVITATION_HISTORY,(async t=>{const{userId:e}=t.payload,s=await this.invitationService.getAllInvitations(),a=[...s.filter((t=>t.receiverId===e)).map((t=>({...t,type:"reçue"}))),...s.filter((t=>t.donorId===e)).map((t=>({...t,type:"envoyée"})))];N.send({type:i.INVITATION_HISTORY_RESULT,payload:a})}));const t=new Map;this.messageBus.on(i.REQUEST_SHARED_MUTATION,(e=>{const{initiatorId:s,traits:a}=e.payload,r=Math.random().toString(36).substr(2,6).toUpperCase(),n=Date.now()+3e5;t.set(r,{initiatorId:s,traits:a,expiresAt:n}),N.send({type:i.SHARED_MUTATION_CODE,payload:{code:r,initiatorId:s,expiresAt:n}})})),this.messageBus.on(i.ACCEPT_SHARED_MUTATION,(async e=>{const{code:s,receiverId:a,traits:r,role:n}=e.payload;if(!this.security.validateDataAccess({userId:a,resource:s,role:n},"user"))return void N.send({type:i.SHARED_MUTATION_RESULT,payload:{error:"Accès refusé."}});const o=t.get(s);if(!o||o.expiresAt<Date.now())return void N.send({type:i.SHARED_MUTATION_RESULT,payload:{error:"Code expiré ou invalide."}});const c={...o.traits};for(const t of Object.keys(r))c[t]=(c[t]??0+r[t]??0)/2;t.delete(s);let h={initiatorId:o.initiatorId,receiverId:a,mergedTraits:c,timestamp:Date.now()};try{h=await this.security.encryptSensitiveData(h)}catch(t){}N.send({type:i.SHARED_MUTATION_RESULT,payload:h})}));let e=new Set,s=null;this.messageBus.on(i.COLLECTIVE_WAKE_REQUEST,(t=>{const{userId:a}=t.payload;e.add(a),s||(s=setTimeout((()=>{N.send({type:i.COLLECTIVE_WAKE_RESULT,payload:{participants:Array.from(e),triggeredAt:Date.now()}}),e.clear(),s=null}),1e4))}));const a=async t=>{const e=await C("symbiont_user_id")||"unknown",s=await this.invitationService.generateInvitation(e);await N.send({type:i.CONTEXTUAL_INVITATION,payload:{invitation:s,context:t}})},r=this.generateMutation.bind(this);this.generateMutation=()=>{const t=r();return"cognitive"===t.type&&a("mutation_cognitive"),t};const n=this.updateOrganismTraits.bind(this);this.updateOrganismTraits=async(t,e)=>{await n(t,e),this.organism&&this.organism.traits.curiosity>90&&await a("curiosity_threshold")};let o=Date.now();chrome.idle.onStateChanged.addListener((t=>{"idle"===t?o=Date.now():"active"===t&&Date.now()-o>18e5&&a("long_inactivity")}));const c=["SYMBIOSE","AWAKEN","ECHO"];this.messageBus.on(i.SECRET_CODE_ENTERED,(t=>{const{code:e}=t.payload;c.includes(e.toUpperCase())&&N.send({type:i.SECRET_RITUAL_TRIGGERED,payload:{code:e,effect:"mutation_unique",timestamp:Date.now()}})}))}async updateOrganismTraits(t,e){if(!this.organism)return;const s=t.toLowerCase(),a=e.toLowerCase();(s.includes("github")||s.includes("stackoverflow")||s.includes("codepen")||s.includes("dribbble"))&&(this.organism.traits.creativity+=.5),(s.includes("docs")||s.includes("wiki")||s.includes("tutorial")||a.includes("guide"))&&(this.organism.traits.focus+=.3),(s.includes("twitter")||s.includes("linkedin")||s.includes("facebook")||s.includes("reddit"))&&(this.organism.traits.empathy+=.4);const r=new URL(t).hostname;if(!await this.hasVisitedDomain(r)&&(this.organism.traits.curiosity+=1),!this.organism)return;const n=this.organism.traits;if(!n)return;Object.keys(n).forEach((t=>{n[t]=Math.max(0,Math.min(100,n[t]))})),await this.checkForMutations(),await this.storage.saveOrganism(this.organism);let o="default";if(await this.isLoop(t)?o="loop":await this.isIdle()?o="idle":await this.isExploration(t)?o="exploration":await this.isRoutine(t)&&(o="routine"),!this.organism)return;const c=this.organism;await N.send({type:i.ORGANISM_UPDATE,payload:{state:c,mutations:await this.storage.getRecentMutations(5)}});const h=this.murmureService.generateMurmur(o);await N.send({type:i.MURMUR,payload:{text:h,pattern:o,timestamp:Date.now()}})}async hasVisitedDomain(t){return(await chrome.tabs.query({})).some((e=>e.url&&new URL(e.url).hostname===t))}async checkForMutations(){if(!this.organism)return;const t=this.organism,e=Date.now(),i=e-(t.lastMutation??0),s=Math.min(.5,i/36e5);if(Math.random()<s){const i=this.generateMutation();await this.storage.addMutation(i),t.lastMutation=e,this.applyMutation(i)}}generateMutation(){const t=["visual","behavioral","cognitive"],e=t[Math.floor(Math.random()*t.length)];return{type:e,trigger:this.getMutationTrigger(e),magnitude:.5*Math.random()+.1,timestamp:Date.now()}}getMutationTrigger(t){const e={visual:["color_shift","pattern_change","size_fluctuation","opacity_variation"],behavioral:["navigation_speed","content_preference","interaction_pattern"],cognitive:["memory_retention","pattern_recognition","association_strength"]}[t];return e[Math.floor(Math.random()*e.length)]}applyMutation(t){if(this.organism)switch(t.type){case"visual":this.organism.visualDNA=this.mutateVisualDNA(this.organism.visualDNA??"",t.magnitude);break;case"behavioral":const e=Object.keys(this.organism.traits),i=e[Math.floor(Math.random()*e.length)];this.organism.traits[i]+=(Math.random()-.5)*t.magnitude*20;break;case"cognitive":if(!this.organism)return;const s=this.organism.traits;if(!s)return;Object.keys(s).forEach((e=>{s[e]+=(Math.random()-.5)*t.magnitude*5}))}}mutateVisualDNA(t,e){const i=Math.floor(t.length*e);let s=t.split("");for(let e=0;e<i;e++)s[Math.floor(Math.random()*t.length)]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return s.join("")}startPeriodicTasks(){setInterval((()=>{this.organism&&(this.organism.health??0)>0&&(this.organism.health=Math.max(0,(this.organism.health??0)-.1),this.organism.energy=Math.max(0,(this.organism.energy??0)-.05))}),6e4),setInterval((async()=>{this.organism&&(await this.storage.saveOrganism(this.organism),await N.send({type:i.ORGANISM_UPDATE,payload:{state:this.organism,mutations:await this.storage.getRecentMutations(5)}}))}),3e4)}async isLoop(t){const e=await this.storage.getBehavior(t);return!!e&&e.visitCount>=3}async isIdle(){return!1}async isExploration(t){const e=await this.storage.getBehavior(t);return!!e&&e.visitCount<=1}async isRoutine(t){const e=await this.storage.getBehavior(t);return!!e&&Date.now()-e.lastVisit<1728e5}async analyzeContextualPatterns(){const t=Date.now();this.events=this.events.filter((e=>t-e.timestamp<18e5)),p.detectBurst(this.events,1e4,5).length>0?this.triggerContextualInvitation("burst_activity"):p.detectTemporalPattern(this.events,6e4,.15).length>0?this.triggerContextualInvitation("temporal_cycle"):p.detectAlternance(this.events,"visit","scroll",6).length>0?this.triggerContextualInvitation("alternance_nav_scroll"):p.detectRepetition(this.events,7).length>0?this.triggerContextualInvitation("repetition_action"):this.checkCollectiveThreshold()}async checkCollectiveThreshold(){const t=(await this.invitationService.getAllInvitations()).length;for(const e of this.collectiveThresholds)if(t>=e&&!this.reachedThresholds.includes(e)){this.reachedThresholds.push(e),await D("symbiont_collective_thresholds",JSON.stringify(this.reachedThresholds)),this.triggerContextualInvitation("collective_threshold_"+e);break}}async triggerContextualInvitation(t){const e=await C("symbiont_user_id")||"unknown",s=await this.invitationService.generateInvitation(e);await N.send({type:i.CONTEXTUAL_INVITATION,payload:{invitation:s,context:t}})}},new class{constructor(){this.peers=new Set,this.organismState=null,this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_network"),this.channel.onmessage=t=>this.handleMessage(t.data),this.announce()}announce(){this.channel.postMessage({type:"announce",peerId:this.peerId})}joinNetwork(t){this.peers.add(t),this.channel.postMessage({type:"join",peerId:this.peerId}),console.log(`[Network] Pair rejoint : ${t}`)}leaveNetwork(t){this.peers.delete(t),this.channel.postMessage({type:"leave",peerId:this.peerId}),console.log(`[Network] Pair quitté : ${t}`)}broadcastMutation(t){this.channel.postMessage({type:"mutation",from:this.peerId,mutation:t}),console.log(`[Network] Diffusion mutation à ${this.peers.size} pairs`)}receiveMutation(t,e){console.log(`[Network] Mutation reçue de ${e}`,t)}performCommunityBackup(t){this.channel.postMessage({type:"backup",from:this.peerId,state:t}),console.log("[Network] Backup communautaire lancé")}handleMessage(t){if(t.peerId!==this.peerId)switch(t.type){case"announce":case"join":this.peers.add(t.peerId);break;case"leave":this.peers.delete(t.peerId);break;case"mutation":this.receiveMutation(t.mutation,t.from);break;case"backup":console.log(`[Network] Backup reçu de ${t.from}`,t.state)}}},new class{constructor(t){this.proposals=new Map,this.votes=new Map,this.onCollectiveMutation=null,this.peerId="peer_"+Math.random().toString(36).substr(2,8),t&&(this.onCollectiveMutation=t)}proposeMutation(t,e){this.proposals.has(t.id)||(this.proposals.set(t.id,[]),this.votes.set(t.id,new Set)),this.proposals.get(t.id).push({mutation:t,proposerId:e}),this.vote(t.id,e),console.log(`[Collective] Mutation proposée par ${e}`)}vote(t,e){this.votes.has(t)||this.votes.set(t,new Set),this.votes.get(t).add(e),console.log(`[Collective] Vote de ${e} pour mutation ${t}`)}aggregateVotes(t){return this.votes.get(t)?.size||0}triggerCollectiveMutation(t,e){const i=this.aggregateVotes(t);return i>Math.max(1,Math.floor(e/2))?(console.log(`[Collective] Mutation collective déclenchée : ${t}`),this.onCollectiveMutation&&this.onCollectiveMutation(t),!0):(console.log(`[Collective] Consensus non atteint pour ${t} (${i}/${e})`),!1)}},new class{constructor(){this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_resilience"),this.channel.onmessage=t=>this.handleMessage(t.data)}requestCommunityBackup(t){this.channel.postMessage({type:"backup_request",from:this.peerId,organismId:t}),console.log(`[SocialResilience] Demande de backup pour ${t}`)}restoreFromCommunity(t){console.log(`[SocialResilience] Restauration depuis la communauté pour ${t}`)}detectMassiveFailure(){console.log("[SocialResilience] Détection de panne massive")}launchCommunityAlert(t){this.channel.postMessage({type:"alert",from:this.peerId,message:t}),console.log(`[SocialResilience] Alerte communautaire : ${t}`)}handleMessage(t){if(t.from!==this.peerId)switch(t.type){case"backup_request":console.log(`[SocialResilience] Backup demandé par ${t.from} pour ${t.organismId}`);break;case"alert":console.log(`[SocialResilience] Alerte reçue : ${t.message}`)}}},new class{constructor(){this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_mystical"),this.channel.onmessage=t=>this.handleMessage(t.data)}triggerMysticalEvent(t,e){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:t,payload:e}),console.log(`[MysticalEvents] Événement mystique déclenché : ${t}`)}propagateToCommunity(t,e){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:t,payload:e}),console.log(`[MysticalEvents] Propagation à la communauté : ${t}`)}applySpecialEffect(t){console.log(`[MysticalEvents] Effet spécial appliqué : ${t}`)}handleMessage(t){t.from!==this.peerId&&"mystical"===t.type&&this.applySpecialEffect(`Effet mystique reçu : ${t.eventId}`)}};