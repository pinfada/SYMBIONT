(()=>{"use strict";var e,t={18:(e,t,r)=>{r.d(t,{Dm:()=>i});var s=r(513);class i{static random(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/(this.MAX_UINT32+1)}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random numbers.");throw s.vF.error("SecureRandom: CRITICAL SECURITY FAILURE",e),e}static randomInt(e,t){if(e>=t)throw new Error("SecureRandom: min doit √™tre inf√©rieur √† max");const r=t-e;return Math.floor(this.random()*r)+e}static randomFloat(e,t){if(e>=t)throw new Error("SecureRandom: min doit √™tre inf√©rieur √† max");return this.random()*(t-e)+e}static randomBytes(e){if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}const t=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure random bytes.");throw s.vF.error("SecureRandom: CRITICAL SECURITY FAILURE in randomBytes",t),t}static choice(e){if(0===e.length)throw new Error("SecureRandom: Le tableau ne peut pas √™tre vide");return e[this.randomInt(0,e.length)]}static uuid(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20,32)].join("-")}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available. Cannot generate secure UUID.");throw s.vF.error("SecureRandom: CRITICAL SECURITY FAILURE in uuid",e),e}static randomString(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r="";for(let s=0;s<e;s++)r+=t.charAt(this.randomInt(0,t.length));return r}static randomId(e="",t=8){const r=this.randomString(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return e?`${e}_${r}`:r}}i.MAX_UINT32=4294967295,i.random,i.randomInt,i.randomFloat},194:(e,t,r)=>{r.r(t),r.d(t,{NeuralMesh:()=>n});var s=r(849),i=r(513);class n{constructor(){this.nodes=new Map,this.connections=new Map,this.activations=new Map,this.learningRate=.01}addNode(e,t,r=0){const s={type:t,activation:0,bias:r};this.nodes.set(e,s),this.activations.set(e,0)}addConnection(e,t,r){if(!this.nodes.has(e)||!this.nodes.has(t))throw new Error(`Cannot connect non-existent nodes: ${e} -> ${t}`);this.connections.has(e)||this.connections.set(e,new Map),this.connections.get(e).set(t,r)}stimulate(e,t){const r=this.nodes.get(e);r&&"input"===r.type?this.activations.set(e,t):i.vF.warn(`Cannot stimulate non-input node: ${e}`)}propagate(){for(const[e,t]of this.nodes)if("input"!==t.type){const r=Number.isFinite(t.bias)?t.bias:0;this.activations.set(e,r)}for(const[e,t]of this.connections){const r=this.activations.get(e)||0;if(Number.isFinite(r))for(const[s,n]of t){if(!Number.isFinite(n)){i.vF.warn(`NeuralMesh: Invalid weight from ${e} to ${s}: ${n}, skipping connection`);continue}const t=this.activations.get(s)||0;if(!Number.isFinite(t)){i.vF.warn(`NeuralMesh: Invalid current activation for node ${s}: ${t}, resetting to 0`),this.activations.set(s,0);continue}const a=r*n;if(!Number.isFinite(a)){i.vF.warn(`NeuralMesh: Invalid weighted input from ${e} to ${s}, skipping`);continue}const o=t+a;if(!Number.isFinite(o)){i.vF.warn(`NeuralMesh: Invalid new activation for node ${s}: ${o}, using current`);continue}const c=this.sigmoid(o);this.activations.set(s,c)}else i.vF.warn(`NeuralMesh: Invalid activation from node ${e}: ${r}, skipping`)}for(const[e,t]of this.activations)Number.isFinite(t)||(i.vF.error(`NeuralMesh: CRITICAL - Node ${e} has invalid activation ${t}, resetting to 0`),this.activations.set(e,0))}sigmoid(e){if(!Number.isFinite(e))return i.vF.warn(`NeuralMesh: Invalid sigmoid input: ${e}, using 0.5 as fallback`),.5;const t=Math.max(-500,Math.min(500,e));try{const r=1/(1+Math.exp(-t));return Number.isFinite(r)?r:(i.vF.warn(`NeuralMesh: Invalid sigmoid output for input ${e}, using 0.5 as fallback`),.5)}catch(t){return i.vF.error("NeuralMesh: Sigmoid computation error",{input:e,error:t}),.5}}getActivation(e){return this.activations.get(e)||0}mutate(e=.05){for(const t of this.connections.values())for(const[r,i]of t)s.tm.random()<e&&(t.set(r,i+.2*(s.tm.random()-.5)),t.set(r,Math.max(-2,Math.min(2,t.get(r)||0))));for(const t of this.nodes.values())s.tm.random()<e&&(t.bias+=.1*(s.tm.random()-.5),t.bias=Math.max(-1,Math.min(1,t.bias)))}getNeuralActivity(){let e=0,t=0;for(const r of this.activations.values())e+=Math.abs(r),t++;return t>0?e/t:0}getConnectionStrength(){let e=0,t=0;for(const r of this.connections.values())for(const s of r.values())e+=Math.abs(s),t++;return t>0?e/t:0}toJSON(){return{nodes:Array.from(this.nodes.values()),connections:Array.from(this.connections.values()).map((e=>Array.from(e.entries()))),activations:Object.fromEntries(this.activations)}}async initialize(){0===this.nodes.size&&this.setupDefaultNetwork(),this.propagate()}setupDefaultNetwork(){this.addNode("sensory_input","input"),this.addNode("memory_input","input"),this.addNode("processing_1","hidden",.1),this.addNode("processing_2","hidden",-.1),this.addNode("motor_output","output"),this.addNode("emotion_output","output"),this.addConnection("sensory_input","processing_1",.8),this.addConnection("memory_input","processing_2",.6),this.addConnection("processing_1","motor_output",.9),this.addConnection("processing_2","emotion_output",.7),this.addConnection("processing_1","processing_2",.3)}async suspend(){this.activations.clear(),i.vF.info("Neural mesh suspended")}async getCPUUsage(){const e=this.nodes.size*this.connections.size;return Math.min(1,e/1e3)}async getMemoryUsage(){const e=64*(this.nodes.size+this.connections.size);return Math.min(1,e/1048576)}saveState(){return{nodes:Object.fromEntries(this.nodes),connections:Object.fromEntries(Array.from(this.connections.entries()).map((([e,t])=>[e,Object.fromEntries(t)]))),activations:Object.fromEntries(this.activations)}}loadState(e){if(e.nodes){this.nodes.clear();for(const[t,r]of Object.entries(e.nodes))this.nodes.set(t,r)}if(e.connections){this.connections.clear();for(const[t,r]of Object.entries(e.connections))this.connections.set(t,new Map(Object.entries(r)))}if(e.activations){this.activations.clear();for(const[t,r]of Object.entries(e.activations))this.activations.set(t,r)}}reset(){this.nodes.clear(),this.connections.clear(),this.activations.clear(),this.setupDefaultNetwork()}healthCheck(){const e=[];0===this.nodes.size&&e.push("No nodes in neural mesh"),0===this.connections.size&&e.push("No connections in neural mesh");const t=new Set;for(const[e,r]of this.connections){t.add(e);for(const e of r.keys())t.add(e)}const r=Array.from(this.nodes.keys()).filter((e=>!t.has(e)));return r.length>0&&e.push(`Orphaned nodes: ${r.join(", ")}`),{healthy:0===e.length,issues:e}}cleanup(){this.nodes.clear(),this.connections.clear(),this.activations.clear()}async processPattern(e){if(e&&"object"==typeof e){const t=Array.from(this.nodes.entries()).filter((([,e])=>"input"===e.type)).map((([e])=>e));Object.entries(e).forEach((([,e],r)=>{r<t.length&&"number"==typeof e&&this.stimulate(t[r],e)})),this.propagate();const r=Array.from(this.nodes.entries()).filter((([,e])=>"output"===e.type));return Object.fromEntries(r.map((([e])=>[e,this.getActivation(e)])))}return{}}async learn(e){if(e&&"object"==typeof e&&"feedback"in e&&"number"==typeof e.feedback){const t=.01*Math.abs(e.feedback);this.mutate(t)}}getPerformanceMetrics(){return{nodeCount:this.nodes.size,connectionCount:Array.from(this.connections.values()).reduce(((e,t)=>e+t.size),0),neuralActivity:this.getNeuralActivity(),connectionStrength:this.getConnectionStrength()}}}},455:(e,t,r)=>{r.d(t,{lk:()=>n,wP:()=>a});var s=r(18),i=r(513);function n(){if("undefined"!=typeof crypto&&crypto.randomUUID)try{return crypto.randomUUID()}catch(e){i.vF.warn("crypto.randomUUID failed, using fallback",{error:e})}return s.Dm.uuid()}function a(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():s.Dm.uuid()}},502:(e,t,r)=>{r.r(t),r.d(t,{OrganismCore:()=>p});var s=r(513);class i{constructor(){this.errorQueue=[],this.maxQueueSize=1e3,this.logLevel="warning",this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0}}static getInstance(){return i.instance||(i.instance=new i),i.instance}setLogLevel(e){this.logLevel=e}logError(e){this.updateMetrics(e),this.addToQueue(e),this.outputError(e)}logSimpleError(e,t,r,s="error",i){const n=r instanceof Error?r.message:String(r),a={component:e,method:t,timestamp:Date.now(),severity:s,details:{message:n,context:i,originalError:r instanceof Error?{name:r.name,stack:r.stack}:void 0}};console["warning"===s?"warn":"debug"===s?"debug":"info"===s?"info":"error"](`[${e}][${t}] ${n}`,i||""),this.recordError(a)}validateRequired(e,t,r,s){const i=[];null==e&&i.push(`${t} is required`);const n={isValid:0===i.length,errors:i,warnings:[],context:{component:r,method:s,timestamp:Date.now(),severity:i.length>0?"error":"info"}};return n.isValid||this.logError(n.context),n}validateType(e,t,r={},s,i,n){const a=[];if(r.required&&null==e&&a.push(`${s} is required`),null!=e){const i=typeof e;i!==t&&a.push(`${s} must be of type ${t}, got ${i}`),"number"===t&&"number"==typeof e&&(void 0!==r.min&&e<r.min&&a.push(`${s} must be >= ${r.min}`),void 0!==r.max&&e>r.max&&a.push(`${s} must be <= ${r.max}`),Number.isFinite(e)||a.push(`${s} must be a finite number`)),"string"===t&&"string"==typeof e&&(void 0!==r.min&&e.length<r.min&&a.push(`${s} must be at least ${r.min} characters long`),void 0!==r.max&&e.length>r.max&&a.push(`${s} must be at most ${r.max} characters long`),r.pattern&&!r.pattern.test(e)&&a.push(`${s} does not match required pattern`))}const o={isValid:0===a.length,errors:a,warnings:[],context:{component:i,method:n,timestamp:Date.now(),severity:a.length>0?"error":"warning",details:{fieldName:s,expectedType:t,actualValue:e}}};return o.isValid||this.logError(o.context),o}async withRetry(e,t,r){let s=null;for(let i=1;i<=t.maxRetries;i++){this.metrics.recoveryAttempts++;try{const t=await e();return i>1&&(this.metrics.recoverySuccesses++,this.logSimpleError(r.component,r.method,`Recovery successful after ${i} attempts`,"info")),t}catch(e){if(s=e instanceof Error?e:new Error(String(e)),this.logSimpleError(r.component,r.method,`Attempt ${i}/${t.maxRetries} failed: ${s.message}`,"warning"),i<t.maxRetries&&t.shouldRetry(s,i)){await this.delay(t.backoffMs*i);continue}break}}if(this.logSimpleError(r.component,r.method,`All ${t.maxRetries} retry attempts failed. Last error: ${s?.message}`,"error"),void 0!==t.fallbackValue)return t.fallbackValue;throw s}safeExecute(e,t,r){try{return e()}catch(e){return this.logSimpleError(r.component,r.method,e,"error"),t}}async safeExecuteAsync(e,t,r){try{return await e()}catch(e){return this.logSimpleError(r.component,r.method,e,"error"),t}}getMetrics(){return{...this.metrics}}getRecentErrors(e=50){return this.errorQueue.slice(-e)}reset(){this.metrics={errorCount:0,lastErrorTime:0,errorsByComponent:new Map,errorsByMethod:new Map,recoveryAttempts:0,recoverySuccesses:0},this.errorQueue=[]}updateMetrics(e){this.metrics.errorCount++,this.metrics.lastErrorTime=e.timestamp;const t=this.metrics.errorsByComponent.get(e.component)||0;this.metrics.errorsByComponent.set(e.component,t+1);const r=`${e.component}.${e.method}`,s=this.metrics.errorsByMethod.get(r)||0;this.metrics.errorsByMethod.set(r,s+1)}addToQueue(e){this.errorQueue.push(e),this.errorQueue.length>this.maxQueueSize&&(this.errorQueue=this.errorQueue.slice(-this.maxQueueSize))}outputError(e){if(!this.shouldLog(e.severity))return;const t=`[${new Date(e.timestamp).toISOString()}] ${e.severity.toUpperCase()} ${e.component}.${e.method}`;switch(e.severity){case"critical":case"error":s.vF.error(t,e.details);break;case"warning":s.vF.warn(t,e.details);break;case"info":console.info(t,e.details);break;case"debug":s.vF.debug(t,e.details)}}shouldLog(e){const t=["debug","info","warning","error","critical"],r=t.indexOf(this.logLevel);return t.indexOf(e)>=r}delay(e){return new Promise((t=>setTimeout(t,e)))}recordError(e){this.updateMetrics(e),this.addToQueue(e)}}i.instance=null;const n=i.getInstance();class a{constructor(e){this.history=[],this.listeners=[],this.traits={curiosity:.5,focus:.5,rhythm:.5,empathy:.5,creativity:.5,memory:.5,intuition:.5,resilience:.5,adaptability:.5,collaboration:.5,...e}}updateTrait(e,t,r="manual"){const s=this.traits[e],i=Math.max(0,Math.min(1,t));this.traits[e]=i,this.history.push({trait:e,value:i,timestamp:Date.now(),trigger:r});const n={traitName:e,oldValue:s,newValue:i,timestamp:Date.now()};this.listeners.forEach((e=>e(n)))}updateTraits(e,t="batch"){Object.entries(e).forEach((([e,r])=>{"number"==typeof r&&this.updateTrait(e,r,t)}))}getTrait(e){return this.traits[e]}getAllTraits(){return{...this.traits}}getTraitHistory(e){return this.history.filter((t=>t.trait===e))}getFullHistory(e=100){return this.history.slice(-e)}normalizeTraits(){Object.keys(this.traits).forEach((e=>{const t=e,r=this.traits[t];(r<0||r>1)&&this.updateTrait(t,Math.max(0,Math.min(1,r)),"normalization")}))}calculateBalance(){const e=Object.values(this.traits),t=e.reduce(((e,t)=>e+t),0)/e.length,r=e.reduce(((e,r)=>e+Math.pow(r-t,2)),0)/e.length;return Math.max(0,1-r)}addTraitChangeListener(e){this.listeners.push(e)}removeTraitChangeListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}cleanup(e=864e5){const t=Date.now()-e;this.history=this.history.filter((e=>e.timestamp>t))}toJSON(){return{traits:{...this.traits},history:[...this.history]}}fromJSON(e){this.traits={...e.traits},this.history=[...e.history]}}class o{constructor(e,t="BoundedArray"){this.items=[],this.maxSize=Math.max(1,e),this.name=t}add(e){if(this.items.push(e),this.items.length>this.maxSize){const e=this.items.splice(0,this.items.length-this.maxSize);s.vF.debug(`${this.name}: Cleaned ${e.length} old items, keeping ${this.items.length}/${this.maxSize}`)}}addBatch(e){if(this.items.push(...e),this.items.length>this.maxSize){const e=this.items.splice(0,this.items.length-this.maxSize);s.vF.debug(`${this.name}: Batch cleaned ${e.length} old items`)}}getAll(){return this.items}getRecent(e){return this.items.slice(-Math.min(e,this.items.length))}slice(e,t){return this.items.slice(e,t)}filter(e){return this.items.filter(e)}reduce(e,t){return this.items.reduce(e,t)}[Symbol.iterator](){return this.items[Symbol.iterator]()}get length(){return this.items.length}clear(){const e=this.items.length;this.items=[],s.vF.debug(`${this.name}: Cleared ${e} items`)}size(){return this.items.length}isFull(){return this.items.length>=this.maxSize}getMemoryUsage(){return{count:this.items.length,maxSize:this.maxSize,utilizationPercent:this.items.length/this.maxSize*100}}}class c{constructor(e=100,t){this.listeners=[],this.regenerationTimer=null,this.config={baseRegenRate:1,maxEnergy:100,decayRate:.1,efficiencyFactor:1,...t},this.maxEnergy=this.config.maxEnergy,this.energy=Math.min(e,this.maxEnergy),this.metabolismRate=this.config.baseRegenRate,this.history=new o(100,"EnergyHistory"),this.startMetabolism()}startMetabolism(){this.regenerationTimer||(this.regenerationTimer=setInterval((()=>{this.passiveRegeneration()}),1e3))}stopMetabolism(){this.regenerationTimer&&(clearInterval(this.regenerationTimer),this.regenerationTimer=null)}passiveRegeneration(){const e=this.metabolismRate*this.config.efficiencyFactor-this.config.decayRate;if(e>0&&this.energy<this.maxEnergy){const t=this.energy;this.energy=Math.min(this.maxEnergy,this.energy+e),this.recordEvent({type:"regeneration",amount:this.energy-t,source:"passive_metabolism",timestamp:Date.now(),energyBefore:t,energyAfter:this.energy})}else if(e<0){const t=this.energy;this.energy=Math.max(0,this.energy+e),this.recordEvent({type:"drain",amount:Math.abs(e),source:"natural_decay",timestamp:Date.now(),energyBefore:t,energyAfter:this.energy})}}consumeEnergy(e,t="unknown"){if(e<=0)return!0;if(this.energy<e)return!1;const r=this.energy;return this.energy-=e,this.recordEvent({type:"consumption",amount:e,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy}),!0}forceConsumeEnergy(e,t="forced"){const r=this.energy,s=Math.min(e,this.energy);return this.energy-=s,this.recordEvent({type:"consumption",amount:s,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy}),s}addEnergy(e,t="boost"){if(e<=0)return;const r=this.energy;this.energy=Math.min(this.maxEnergy,this.energy+e),this.recordEvent({type:"boost",amount:this.energy-r,source:t,timestamp:Date.now(),energyBefore:r,energyAfter:this.energy})}regenerateEnergy(e){const t=e||this.metabolismRate;this.addEnergy(t,"manual_regeneration")}getEnergyLevel(){return this.energy}getEnergyPercentage(){return this.energy/this.maxEnergy*100}getMaxEnergy(){return this.maxEnergy}hasEnergy(e){return this.energy>=e}isExhausted(){return 0===this.energy}isFullEnergy(){return this.energy===this.maxEnergy}setMetabolismRate(e){this.metabolismRate=Math.max(0,e)}setEfficiency(e){this.config.efficiencyFactor=Math.max(.1,Math.min(2,e))}increaseMaxEnergy(e){this.maxEnergy+=e,this.config.maxEnergy=this.maxEnergy}recordEvent(e){this.history.add(e),this.listeners.forEach((t=>t(e)))}getEnergyHistory(e=50){return this.history.slice(-e)}getEnergyStats(){const e=this.history.filter((e=>"consumption"===e.type)),t=this.history.filter((e=>"regeneration"===e.type||"boost"===e.type)),r=e.reduce(((e,t)=>e+t.amount),0),s=t.reduce(((e,t)=>e+t.amount),0);return{current:this.energy,max:this.maxEnergy,percentage:this.getEnergyPercentage(),metabolismRate:this.metabolismRate,efficiency:this.config.efficiencyFactor,totalConsumed:r,totalRegenerated:s}}addEnergyListener(e){this.listeners.push(e)}removeEnergyListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}cleanup(e=864e5){const t=Date.now()-e,r=this.history.filter((e=>e.timestamp>t));this.history.clear(),this.history.addBatch(r)}toJSON(){return{energy:this.energy,maxEnergy:this.maxEnergy,metabolismRate:this.metabolismRate,config:{...this.config},history:[...this.history]}}fromJSON(e){this.energy=e.energy,this.maxEnergy=e.maxEnergy,this.metabolismRate=e.metabolismRate,this.config={...e.config},this.history.clear(),this.history.addBatch(e.history)}destroy(){this.stopMetabolism(),this.listeners=[],this.history.clear()}}class h{constructor(e){this.processingQueue=[],this.isProcessing=!1,this.MAX_QUEUE_SIZE=1e3,this.BATCH_SIZE=10,this.mesh=e}async processStimulus(e,t){const r=Date.now();try{const s=this.convertStimulusToPattern(e),i=this.mesh.processPattern?await this.mesh.processPattern(s):{},n=this.convertResultToTraitAdaptations(i,t),a=Date.now()-r;return{success:!0,adaptations:n,confidence:i.confidence||.8,processingTime:a}}catch(e){return s.vF.error("Erreur de traitement neural:",e),{success:!1,adaptations:{},confidence:0,processingTime:Date.now()-r}}}queuePattern(e){this.processingQueue.length>=this.MAX_QUEUE_SIZE&&(s.vF.warn("Neural processing queue at maximum capacity, dropping oldest pattern"),this.processingQueue.shift()),this.processingQueue.push(e),this.isProcessing||this.processQueue()}async processQueue(){if(!this.isProcessing&&0!==this.processingQueue.length){for(this.isProcessing=!0;this.processingQueue.length>0;){const e=Math.min(this.BATCH_SIZE,this.processingQueue.length);for(let t=0;t<e;t++){const e=this.processingQueue.shift();if(e)try{this.mesh.learn&&await this.mesh.learn(e.data)}catch(e){s.vF.error("Erreur apprentissage neural:",e)}}this.processingQueue.length>0&&await new Promise((e=>setTimeout(e,0)))}this.isProcessing=!1}}convertStimulusToPattern(e){return"object"==typeof e&&null!==e?{type:e.type||"unknown",intensity:e.intensity||.5,context:e.context||{},timestamp:Date.now()}:{type:"simple",intensity:.5,data:e,timestamp:Date.now()}}convertResultToTraitAdaptations(e,t){const r={};if(e&&"object"==typeof e&&(e.traitSuggestions&&Object.entries(e.traitSuggestions).forEach((([e,s])=>{if(e in t&&"number"==typeof s){const i=t[e],n=.1,a=Math.max(-n,Math.min(n,s-i));r[e]=i+a}})),e.activityType))switch(e.activityType){case"exploration":r.curiosity=this.adjustTrait(t.curiosity,.05),r.adaptability=this.adjustTrait(t.adaptability,.03);break;case"focus":r.focus=this.adjustTrait(t.focus,.05),r.memory=this.adjustTrait(t.memory,.02);break;case"social":r.empathy=this.adjustTrait(t.empathy,.04),r.collaboration=this.adjustTrait(t.collaboration,.04);break;case"creative":r.creativity=this.adjustTrait(t.creativity,.05),r.intuition=this.adjustTrait(t.intuition,.03)}return r}adjustTrait(e,t){return Math.max(0,Math.min(1,e+t))}async learn(e){try{return this.mesh.learn&&await this.mesh.learn(e),!0}catch(e){return s.vF.error("Erreur apprentissage:",e),!1}}getPerformanceMetrics(){try{return this.mesh.getPerformanceMetrics?this.mesh.getPerformanceMetrics():{nodeCount:0,connectionCount:0,neuralActivity:0,connectionStrength:0}}catch(e){return s.vF.error("Erreur m√©triques:",e),{processingTime:0,accuracy:0,memoryUsage:0}}}saveState(){try{return this.mesh.saveState()}catch(e){return s.vF.error("Erreur sauvegarde √©tat neural:",e),null}}loadState(e){try{return this.mesh.loadState(e),!0}catch(e){return s.vF.error("Erreur chargement √©tat neural:",e),!1}}reset(){try{this.mesh.reset(),this.processingQueue=[],this.isProcessing=!1}catch(e){s.vF.error("Erreur reset neural:",e)}}cleanup(){this.processingQueue=[],this.isProcessing=!1,"function"==typeof this.mesh.cleanup&&this.mesh.cleanup()}healthCheck(){const e=[];this.mesh||e.push("R√©seau neural non initialis√©"),this.processingQueue.length>1e3&&e.push("Queue de traitement surcharg√©e");try{this.getPerformanceMetrics().processingTime>1e3&&e.push("Temps de traitement √©lev√©")}catch{e.push("M√©triques non disponibles")}return{healthy:0===e.length,issues:e}}async initialize(){await this.mesh.initialize()}async suspend(){await this.mesh.suspend()}update(e){const t=e/16.67,r=Math.ceil(t);for(let e=0;e<r&&this.processingQueue.length>0;e++){const e=this.processingQueue.shift();e&&this.mesh.learn&&this.mesh.learn(e.data).catch((e=>{s.vF.error("Neural processing error:",e)}))}}stimulate(e,t){this.mesh.stimulate(e,t)}getNeuralActivity(){return this.mesh.getNeuralActivity()}}class l{constructor(){this.metricsCache=new Map,this.isProduction=!0}static getInstance(){return l.instance||(l.instance=new l),l.instance}async getMemoryMetrics(){try{if("memory"in performance){const e=performance.memory;return{used:e.usedJSHeapSize,total:e.totalJSHeapSize,percentage:e.usedJSHeapSize/e.jsHeapSizeLimit*100}}const e=this.estimateMemoryUsage();return{used:e,total:2*e,percentage:50}}catch(e){return s.vF.warn("Erreur collecte m√©moire, fallback estimation:",e),this.getFallbackMemoryMetrics()}}async getTimingMetrics(){try{const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint"),r=t.find((e=>"first-paint"===e.name))?.startTime||0,s=t.find((e=>"first-contentful-paint"===e.name))?.startTime||0;return{loadTime:e?e.loadEventEnd-e.fetchStart:0,domReady:e?e.domContentLoadedEventEnd-e.fetchStart:0,firstPaint:r,firstContentfulPaint:s}}catch(e){return s.vF.warn("Erreur collecte timing, fallback estimation:",e),this.getFallbackTimingMetrics()}}async getNetworkMetrics(){try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return{latency:await this.measureNetworkLatency(),bandwidth:e?.downlink||0,connectionType:e?.effectiveType||"unknown"}}catch(e){return s.vF.warn("Erreur collecte r√©seau, fallback estimation:",e),this.getFallbackNetworkMetrics()}}async getCPUMetrics(){try{return{usage:await this.estimateCPUUsage(),cores:navigator.hardwareConcurrency||4}}catch(e){return s.vF.warn("Erreur collecte CPU, fallback estimation:",e),this.getFallbackCPUMetrics()}}async getSystemMetrics(){const e="system_metrics",t=this.metricsCache.get(e);if(t&&Date.now()-t.timestamp<3e4)return t.value;try{const[t,r,s]=await Promise.all([this.getMemoryMetrics(),this.getNetworkMetrics(),this.getCPUMetrics()]),i=this.measureFrameRate(),n={cpu:s.usage,memory:t.percentage,latency:r.latency,frameRate:await i,timestamp:Date.now()};return this.metricsCache.set(e,{value:n,timestamp:Date.now()}),n}catch(e){return s.vF.error("Erreur collecte m√©triques syst√®me:",e),this.getFallbackSystemMetrics()}}async getWebVitals(){try{const[e,t,r,s,i]=await Promise.all([this.measureLCP(),this.measureFID(),this.measureCLS(),this.measureFCP(),this.measureTTFB()]);return{lcp:e,fid:t,cls:r,fcp:s,ttfb:i}}catch(e){return s.vF.warn("Erreur Web Vitals, fallback defaults:",e),this.getFallbackWebVitals()}}async measureNetworkLatency(){try{const e=performance.now();return await fetch("/favicon.ico",{method:"HEAD"}),performance.now()-e}catch{return 50}}async estimateCPUUsage(){return new Promise((e=>{const t=performance.now();let r=0,s=0;const i=()=>{const n=Math.min(r+1e3,5e4);for(let e=r;e<n;e++)s+=Math.sqrt(e)*Math.sin(e);if(r=n,r<5e4)setTimeout(i,0);else{const r=performance.now()-t,s=Math.min(r/20,1);e(s)}};i()}))}async measureFrameRate(){return new Promise((e=>{let t=0;const r=performance.now(),s=()=>{t++,performance.now()-r<1e3?requestAnimationFrame(s):e(t)};requestAnimationFrame(s)}))}estimateMemoryUsage(){return 1e3*document.querySelectorAll("*").length}async measureLCP(){try{const e=performance.getEntriesByType("largest-contentful-paint");return e.length>0?e[e.length-1].startTime:0}catch{return 2500}}async measureFID(){try{const e=performance.getEntriesByType("first-input");return e.length>0?e[0].processingStart-e[0].startTime:0}catch{return 100}}async measureCLS(){try{let e=0;const t=new PerformanceObserver((t=>{for(const r of t.getEntries())r.hadRecentInput||(e+=r.value)}));return t.observe({type:"layout-shift",buffered:!0}),await new Promise((e=>setTimeout(e,100))),t.disconnect(),e}catch{return.1}}async measureFCP(){try{const e=performance.getEntriesByName("first-contentful-paint")[0];return e?e.startTime:0}catch{return 1500}}async measureTTFB(){try{const e=performance.getEntriesByType("navigation")[0];return e?e.responseStart-e.requestStart:0}catch{return 200}}getFallbackMemoryMetrics(){return{used:26214400,total:104857600,percentage:25}}getFallbackTimingMetrics(){return{loadTime:1500,domReady:800,firstPaint:1200,firstContentfulPaint:1400}}getFallbackNetworkMetrics(){return{latency:50,bandwidth:10,connectionType:"4g"}}getFallbackCPUMetrics(){return{usage:.15,cores:4}}getFallbackSystemMetrics(){return{cpu:.15,memory:25,latency:50,frameRate:60,timestamp:Date.now()}}getFallbackWebVitals(){return{lcp:2500,fid:100,cls:.1,fcp:1500,ttfb:200}}async getRandomReplacementValue(e="generic"){const t=await this.getSystemMetrics();switch(e){case"cpu":return t.cpu;case"memory":return t.memory/100;case"latency":return t.latency/1e3;default:return(t.cpu+t.memory/100+t.latency/1e3)/3}}refreshMetrics(){this.metricsCache.clear()}async getDevMetrics(){return this.isProduction?this.getSystemMetrics():(s.vF.warn("üöß MODE D√âVELOPPEMENT: Utilisation m√©triques simul√©es pour les tests"),this.getFallbackSystemMetrics())}async getCPUUsage(){return(await this.getSystemMetrics()).cpu}async getMemoryUsage(){return(await this.getSystemMetrics()).memory/100}}const u=l;class m{constructor(){this.overrides={},this.environment=this.detectEnvironment(),this.flags=this.initializeFlags(),this.loadOverrides()}static getInstance(){return m.instance||(m.instance=new m),m.instance}detectEnvironment(){return"production"}initializeFlags(){const e={USE_REAL_METRICS:!1,USE_REAL_DNA:!1,USE_REAL_BEHAVIOR:!1,USE_BACKEND_API:!1,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!1,ENABLE_MOCK_DATA:!0,ENABLE_SECURITY_AUDIT:!1,ENABLE_ADVANCED_ANALYTICS:!1,ENABLE_A_B_TESTING:!1};switch(this.environment){case"development":return{...e,ENABLE_DEBUG_LOGGING:!0,ENABLE_PERFORMANCE_PROFILING:!0,ENABLE_MOCK_DATA:!0,ENABLE_SECURITY_AUDIT:!0,USE_REAL_METRICS:this.getEnvBoolean("USE_REAL_METRICS",!1),USE_REAL_DNA:this.getEnvBoolean("USE_REAL_DNA",!1),USE_REAL_BEHAVIOR:this.getEnvBoolean("USE_REAL_BEHAVIOR",!1),USE_BACKEND_API:this.getEnvBoolean("USE_BACKEND_API",!1)};case"staging":return{...e,USE_REAL_METRICS:!0,USE_REAL_DNA:!0,USE_REAL_BEHAVIOR:!0,USE_BACKEND_API:!0,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!0,ENABLE_MOCK_DATA:!1,ENABLE_SECURITY_AUDIT:!0,ENABLE_ADVANCED_ANALYTICS:!0,ENABLE_A_B_TESTING:!0};case"production":return{...e,USE_REAL_METRICS:!0,USE_REAL_DNA:!0,USE_REAL_BEHAVIOR:!0,USE_BACKEND_API:!0,ENABLE_DEBUG_LOGGING:!1,ENABLE_PERFORMANCE_PROFILING:!1,ENABLE_MOCK_DATA:!1,ENABLE_SECURITY_AUDIT:!1,ENABLE_ADVANCED_ANALYTICS:!0,ENABLE_A_B_TESTING:!1};default:return e}}loadOverrides(){Object.keys(this.flags).forEach((e=>{const t=process.env[`SYMBIONT_${e}`];void 0!==t&&(this.overrides[e]="true"===t)})),"development"===this.environment&&"undefined"!=typeof localStorage&&Object.keys(this.flags).forEach((e=>{const t=`symbiont_feature_${e.toLowerCase()}`,r=localStorage.getItem(t);null!==r&&(this.overrides[e]="true"===r)}))}isEnabled(e){return void 0!==this.overrides[e]?this.overrides[e]:this.flags[e]}setFlag(e,t){if("development"===this.environment){if(this.overrides[e]=t,"undefined"!=typeof localStorage){const r=`symbiont_feature_${e.toLowerCase()}`;localStorage.setItem(r,t.toString())}s.vF.info(`üîß Feature flag '${e}' d√©fini √† ${t}`)}else s.vF.warn(`‚ö†Ô∏è Override de feature flag '${e}' ignor√© en ${this.environment}`)}resetOverrides(){"development"===this.environment?(this.overrides={},"undefined"!=typeof localStorage&&Object.keys(this.flags).forEach((e=>{const t=`symbiont_feature_${e.toLowerCase()}`;localStorage.removeItem(t)})),s.vF.info("üîÑ Tous les feature flags remis aux valeurs par d√©faut")):s.vF.warn("‚ö†Ô∏è Reset des overrides ignor√© en production")}getEnvironment(){return this.environment}getAllFlags(){const e={};return Object.keys(this.flags).forEach((t=>{e[t]=this.isEnabled(t)})),{...e,environment:this.environment}}isDevelopment(){return"development"===this.environment}isStaging(){return"staging"===this.environment}isProduction(){return"production"===this.environment}runInEnvironment(e){const t=e[this.environment]||e.default;return t?.()}debugLog(e,...t){this.isEnabled("ENABLE_DEBUG_LOGGING")&&s.vF.info(`üêõ [SYMBIONT Debug] ${e}`,...t)}profileOperation(e,t){if(!this.isEnabled("ENABLE_PERFORMANCE_PROFILING"))return t();const r=performance.now(),i=t(),n=performance.now()-r;return s.vF.info(`‚è±Ô∏è [SYMBIONT Profile] ${e}: ${n.toFixed(2)}ms`),i}whenEnabled(e,t){return this.isEnabled(e)?t():void 0}getEnvBoolean(e,t){const r=process.env[e];return void 0===r?t:"true"===r.toLowerCase()}validateProductionSafety(){if(!this.isProduction())return;const e=["ENABLE_MOCK_DATA","ENABLE_DEBUG_LOGGING"].filter((e=>this.isEnabled(e)));if(e.length>0)throw new Error(`üö® S√âCURIT√â: Flags dangereux activ√©s en production: ${e.join(", ")}`)}}const d=m;var g=r(455),y=r(849);class p{constructor(e,t,s){this.health=100,this.lastMutation=Date.now();const i=this.validateInput(e,t);if(!i.isValid)throw new Error(`OrganismCore creation failed: ${i.errors.join(", ")}`);if(this.id=(0,g.wP)(),this.dna=e,this.logger=s?.logger,this.metricsService=u.getInstance(),this.featureFlags=d.getInstance(),this.traitService=new a(t),this.energyService=new c(100),s?.neuralMesh)this.neuralService=new h(s.neuralMesh);else{const{NeuralMesh:e}=r(194);this.neuralService=new h(new e)}this.setupServiceListeners(),this.logger?.debug("OrganismCore initialized",{id:this.id,dna:this.dna})}setupServiceListeners(){this.traitService.addTraitChangeListener((e=>{this.onTraitChanged(e)})),this.energyService.addEnergyListener((e=>{"consumption"===e.type&&e.energyAfter<10&&this.logger?.debug("Low energy warning",{energy:e.energyAfter})}))}onTraitChanged(e){const t=this.traitService.getAllTraits(),r=(t.resilience+t.adaptability)/2;this.energyService.setEfficiency(r),this.logger?.debug("Trait changed, metabolism adjusted",{trait:e.traitName,newValue:e.newValue,efficiency:r})}validateInput(e,t){const r=[];return e&&"string"==typeof e||r.push("DNA must be a non-empty string"),e&&e.length<10&&r.push("DNA must be at least 10 characters long"),t&&Object.entries(t).forEach((([e,t])=>{("number"!=typeof t||t<0||t>1)&&r.push(`Trait ${e} must be a number between 0 and 1`)})),{isValid:0===r.length,errors:r}}getId(){return this.id}getDNA(){return this.dna}getTraits(){return this.traitService.getAllTraits()}updateTrait(e,t){if(!this.energyService.consumeEnergy(1,`trait_update_${e}`))throw new Error("Insufficient energy to update trait");this.traitService.updateTrait(e,t,"manual_update"),this.logger?.debug("Trait updated",{trait:e,value:t})}getEnergyLevel(){return this.energyService.getEnergyLevel()}getHealth(){return this.health}async evolve(e){if(this.energyService.consumeEnergy(5,"evolution"))try{const t=this.traitService.getAllTraits(),r=await this.neuralService.processStimulus(e,t);r.success&&Object.keys(r.adaptations).length>0&&(this.traitService.updateTraits(r.adaptations,"evolution"),this.lastMutation=Date.now(),this.logger?.debug("Evolution successful",{adaptations:r.adaptations,confidence:r.confidence}))}catch(e){this.logger?.error("Evolution failed",e),n.logSimpleError("OrganismCore","evolve",e,"error")}else this.logger?.debug("Evolution skipped: insufficient energy")}async learn(e){if(!this.energyService.consumeEnergy(2,"learning"))return;const t=await this.neuralService.learn(e);if(t){const e=this.traitService.getTrait("memory");this.traitService.updateTrait("memory",e+.01,"learning")}this.logger?.debug("Learning completed",{success:t,data:e})}processStimulus(e){this.energyService.consumeEnergy(1,"stimulus_processing")&&(this.neuralService.queuePattern({id:`pattern_${Date.now()}`,type:"behavioral",data:e,timestamp:Date.now(),confidence:.8}),this.logger?.debug("Stimulus processed",{stimulus:e}))}getState(){const e=this.traitService.getAllTraits(),t=this.energyService.getEnergyStats();return{id:this.id,traits:e,energy:t.current,maxEnergy:t.max,health:this.health,dna:this.dna,lastMutation:this.lastMutation,balance:this.traitService.calculateBalance(),metabolismRate:t.metabolismRate,age:Date.now()-parseInt(this.id.split("_")[1])}}generateShaderParameters(){const e=this.traitService.getAllTraits();return{energy:this.energyService.getEnergyPercentage()/100,health:this.health/100,neuralActivity:this.neuralService.getNeuralActivity(),creativity:e.creativity,focus:e.focus,time:Date.now()/1e3,colorPrimary:[e.creativity,e.empathy,e.intuition],colorSecondary:[e.focus,e.resilience,e.adaptability],morphology:e.adaptability,complexity:e.creativity*e.memory}}toJSON(){return{mesh:this.neuralService.saveState()||{},dna:this.dna,health:this.health,lastMutation:this.lastMutation,traits:this.traitService.toJSON()||{traits:this.traitService.getAllTraits(),history:[]},energy:this.energyService.toJSON()||{energy:100,maxEnergy:100,metabolismRate:1,config:{efficiency:1,baseConsumption:.1},history:[]},neural:this.neuralService.saveState(),timestamp:Date.now()}}fromJSON(e){e.traits&&"object"==typeof e.traits&&this.traitService.fromJSON(e.traits),e.energy&&"object"==typeof e.energy&&this.energyService.fromJSON(e.energy),e.neural&&this.neuralService.loadState(e.neural),this.health=e.health||100,this.lastMutation=e.lastMutation||Date.now(),this.logger?.debug("State restored from JSON",{id:this.id})}cleanup(){this.energyService.destroy(),this.traitService.cleanup(),this.neuralService.cleanup(),this.logger?.debug("OrganismCore cleaned up",{id:this.id})}healthCheck(){const e=[];this.health<20&&e.push("Low health"),this.energyService.getEnergyLevel()<10&&e.push("Low energy");const t=this.neuralService.healthCheck();return t.healthy||e.push(...t.issues),{healthy:0===e.length,issues:e}}async boot(){try{await this.neuralService.initialize(),this.logger?.debug("Organism booted successfully",{id:this.id})}catch(e){throw this.logger?.error("Failed to boot organism",{id:this.id,_error:e}),e}}async hibernate(){try{this.energyService.setEfficiency(.1),await this.neuralService.suspend(),this.logger?.debug("Organism hibernated",{id:this.id})}catch(e){throw this.logger?.error("Failed to hibernate organism",{id:this.id,_error:e}),e}}update(e=16.67){const t=e/16.67;this.energyService.consumeEnergy(.1*t,"metabolism"),this.neuralService.update(e),this.energyService.getEnergyLevel()>80&&(this.health=Math.min(100,this.health+.1*t))}stimulate(e,t){this.neuralService.stimulate(e,t),this.energyService.consumeEnergy(.5,`stimulation_${e}`)}mutate(e=.01){const t=this.traitService.getAllTraits(),r={};Object.keys(t).forEach((s=>{if(y.tm.random()<e){const e=t[s],i=.1*(y.tm.random()-.5),n=Math.max(0,Math.min(1,e+i));r[s]=n}})),Object.keys(r).length>0&&(this.traitService.updateTraits(r,"mutation"),this.lastMutation=Date.now(),this.logger?.debug("Mutation applied",{id:this.id,mutations:r}))}feed(e=10){this.energyService.addEnergy(e),this.logger?.debug("Organism fed",{id:this.id,amount:e})}setTraits(e){this.traitService.updateTraits(e,"external_update")}async getPerformanceMetrics(){const e=this.neuralService.getPerformanceMetrics();return{cpu:await this.metricsService.getCPUUsage(),memory:await this.metricsService.getMemoryUsage(),neuralActivity:e?.neuralActivity||0,connectionStrength:e?.connectionStrength||0}}getShaderParameters(){const e=this.getTraits();return{energy:this.energyService.getEnergyLevel()/100,health:this.health/100,neuralActivity:this.neuralService.getNeuralActivity()||0,creativity:e.creativity,focus:e.focus,time:Date.now()/1e3}}}},513:(e,t,r)=>{var s;r.d(t,{vF:()=>n}),function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.FATAL=5]="FATAL"}(s||(s={}));class i{constructor(e={}){this.logEntries=[],this.config={level:s.INFO,enableConsole:!this.isProduction(),enableStorage:!0,maxStorageEntries:1e3,sensitiveFields:["password","token","key","secret","auth"],productionMode:this.isProduction(),...e}}static getInstance(e){return i.instance||(i.instance=new i(e)),i.instance}isProduction(){return!0}sanitizeData(e){if("string"==typeof e)return this.sanitizeString(e);if("object"==typeof e&&null!==e){if(Array.isArray(e))return e.map((e=>this.sanitizeData(e)));const t={};for(const[r,s]of Object.entries(e))this.isSensitiveField(r)?t[r]="[REDACTED]":t[r]=this.sanitizeData(s);return t}return e}sanitizeString(e){let t=e;for(const e of i.SENSITIVE_PATTERNS)t=t.replace(e,"[REDACTED]");return t}isSensitiveField(e){return this.config.sensitiveFields.some((t=>e.toLowerCase().includes(t.toLowerCase())))}formatMessage(e,t,r,i){return`[${(new Date).toISOString()}] ${s[e]}${i?` [${i}]`:""}: ${t}${r?` ${JSON.stringify(r,null,2)}`:""}`}shouldLog(e){return e>=this.config.level}log(e,t,r,i){if(!this.shouldLog(e))return;const n=r?this.sanitizeData(r):void 0,a=this.sanitizeString(t),o={timestamp:Date.now(),level:e,message:a,data:n,context:i,sanitized:!0};if(this.config.enableStorage&&(this.logEntries.push(o),this.logEntries.length>this.config.maxStorageEntries&&(this.logEntries=this.logEntries.slice(-this.config.maxStorageEntries))),this.config.enableConsole){const t=this.formatMessage(e,a,n,i);switch(e){case s.TRACE:case s.DEBUG:console.debug(t);break;case s.INFO:console.info(t);break;case s.WARN:console.warn(t);break;case s.ERROR:case s.FATAL:console.error(t)}}}trace(e,t,r){this.log(s.TRACE,e,t,r)}debug(e,t,r){this.log(s.DEBUG,e,t,r)}info(e,t,r){this.log(s.INFO,e,t,r)}warn(e,t,r){this.log(s.WARN,e,t,r)}error(e,t,r){this.log(s.ERROR,e,t,r)}fatal(e,t,r){this.log(s.FATAL,e,t,r)}setLevel(e){this.config.level=e}enableConsole(e){this.config.enableConsole=e}getLogs(e){return void 0!==e?this.logEntries.filter((t=>t.level>=e)):[...this.logEntries]}clearLogs(){this.logEntries=[]}exportLogs(){return JSON.stringify(this.logEntries,null,2)}}i.SENSITIVE_PATTERNS=[/password/i,/token/i,/key/i,/secret/i,/auth/i,/credential/i,/session/i,/cookie/i,/jwt/i,/bearer/i,/api[_-]?key/i,/access[_-]?token/i,/refresh[_-]?token/i,/private[_-]?key/i,/\b[A-Za-z0-9+/]{32,}={0,2}\b/,/\b[0-9a-f]{32,}\b/i,/\b[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}[_-]?[0-9]{4}\b/,/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/];const n=i.getInstance();n.info.bind(n),n.warn.bind(n),n.error.bind(n),n.debug.bind(n)},849:(e,t,r)=>{r.d(t,{tm:()=>h});var s,i,n=r(513);!function(e){e.CRYPTOGRAPHIC="cryptographic",e.MODERATE="moderate",e.PERFORMANCE="performance"}(s||(s={})),function(e){e.NEURAL_NETWORK="neural_network",e.WEBGL_RENDERING="webgl_rendering",e.GENETIC_MUTATIONS="genetic_mutations",e.SOCIAL_EVENTS="social_events",e.CRYPTOGRAPHIC_OPS="cryptographic_ops",e.MONITORING="monitoring"}(i||(i={}));class a{constructor(e=123456789,t=987654321){this.state0=e,this.state1=t}random(){let e=this.state0;const t=this.state1;return this.state0=t,e^=e<<23,e^=e>>>17,e^=t,e^=t>>>26,this.state1=e,(t+e>>>0)/4294967296}reseed(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(2);crypto.getRandomValues(e),this.state0=e[0],this.state1=e[1]}}}class o{constructor(e=1e4,t=2e3){this.pool=[],this.isRefilling=!1,this.totalGenerated=0,this.totalConsumed=0,this.poolSize=e,this.refillThreshold=t}async initialize(){await this.fillPool()}async fillPool(){if(!this.isRefilling){this.isRefilling=!0;try{const e=Math.min(5e3,this.poolSize-this.pool.length),t=new Uint32Array(e);if("undefined"!=typeof crypto&&crypto.getRandomValues){crypto.getRandomValues(t);for(const e of t)this.pool.push(e/4294967296);this.totalGenerated+=e}}catch(e){n.vF.error("RandomPool: Erreur g√©n√©ration batch",{error:e})}finally{this.isRefilling=!1}}}getNext(){if(0===this.pool.length)return null;const e=this.pool.pop();return this.totalConsumed++,this.pool.length<=this.refillThreshold&&!this.isRefilling&&this.fillPool(),e}getStats(){return{poolSize:this.pool.length,totalGenerated:this.totalGenerated,totalConsumed:this.totalConsumed,hitRate:this.totalConsumed>0?(this.totalConsumed-this.pool.length)/this.totalConsumed:0,isRefilling:this.isRefilling}}}class c{constructor(){this.configs=new Map([[i.CRYPTOGRAPHIC_OPS,{securityLevel:s.CRYPTOGRAPHIC,poolSize:1e3,refillThreshold:200,batchGeneration:!0,metricsEnabled:!0}],[i.NEURAL_NETWORK,{securityLevel:s.PERFORMANCE,poolSize:5e4,refillThreshold:1e4,batchGeneration:!0,metricsEnabled:!0}],[i.WEBGL_RENDERING,{securityLevel:s.PERFORMANCE,poolSize:1e4,refillThreshold:2e3,batchGeneration:!0,metricsEnabled:!1}],[i.GENETIC_MUTATIONS,{securityLevel:s.MODERATE,poolSize:5e3,refillThreshold:1e3,batchGeneration:!0,metricsEnabled:!0}]]),this.metrics={totalCalls:0,secureCalls:0,poolCalls:0,fastCalls:0,avgLatencyMs:0,lastReseedTime:Date.now()},this.securePool=new o(1e4,2e3),this.fastPRNG=new a,this.initialize()}static getInstance(){return c.instance||(c.instance=new c),c.instance}async initialize(){await this.securePool.initialize(),setInterval((()=>{this.fastPRNG.reseed(),this.metrics.lastReseedTime=Date.now()}),3e5)}random(e=i.GENETIC_MUTATIONS){const t=performance.now();this.metrics.totalCalls++;const r=this.configs.get(e)||this.configs.get(i.GENETIC_MUTATIONS);let n;switch(r.securityLevel){case s.CRYPTOGRAPHIC:n=this.getSecureRandom(),this.metrics.secureCalls++;break;case s.MODERATE:n=this.getPooledRandom(),this.metrics.poolCalls++;break;case s.PERFORMANCE:n=this.getFastRandom(),this.metrics.fastCalls++;break;default:n=this.getPooledRandom(),this.metrics.poolCalls++}if(r.metricsEnabled){const e=performance.now()-t;this.metrics.avgLatencyMs=(this.metrics.avgLatencyMs+e)/2}return n}getSecureRandom(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}const e=new Error("SECURITY CRITICAL: crypto.getRandomValues not available for secure random generation");throw n.vF.error("HybridRandom: CRITICAL FAILURE in getSecureRandom",e),e}getPooledRandom(){const e=this.securePool.getNext();if(null!==e)return e;if(n.vF.warn("HybridRandom: Pool empty, attempting direct crypto generation"),"undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}const t=new Error("SECURITY CRITICAL: Pool empty and crypto.getRandomValues unavailable");throw n.vF.error("HybridRandom: CRITICAL FAILURE - no secure random source available",t),t}getFastRandom(){return this.fastPRNG.random()}neuralRandom(){return this.random(i.NEURAL_NETWORK)}renderingRandom(){return this.random(i.WEBGL_RENDERING)}cryptoRandom(){return this.random(i.CRYPTOGRAPHIC_OPS)}mutationRandom(){return this.random(i.GENETIC_MUTATIONS)}async generateBatch(e,t){const r=this.configs.get(t);if(!r?.batchGeneration)return Array.from({length:e},(()=>this.random(t)));if(r.securityLevel===s.PERFORMANCE)return Array.from({length:e},(()=>this.fastPRNG.random()));{const t=new Uint32Array(e);return"undefined"!=typeof crypto&&crypto.getRandomValues?(crypto.getRandomValues(t),Array.from(t,(e=>e/4294967296))):Array.from({length:e},(()=>this.getSecureRandom()))}}getPerformanceMetrics(){return{...this.metrics,poolStats:this.securePool.getStats(),distribution:{secure:(this.metrics.secureCalls/this.metrics.totalCalls*100).toFixed(1)+"%",pooled:(this.metrics.poolCalls/this.metrics.totalCalls*100).toFixed(1)+"%",fast:(this.metrics.fastCalls/this.metrics.totalCalls*100).toFixed(1)+"%"}}}configureContext(e,t){const r=this.configs.get(e)||this.configs.get(i.GENETIC_MUTATIONS);this.configs.set(e,{...r,...t})}shutdown(){n.vF.info("HybridRandomProvider: Arr√™t avec m√©triques",this.getPerformanceMetrics())}}c.getInstance();class h{static random(){const e=this.detectUsageContext();return this.provider.random(e)}static detectUsageContext(){try{const e=(new Error).stack;return e?e.includes("NeuralMesh")||e.includes("NeuralCore")||e.includes("neural")||e.includes("evolve")||e.includes("mutate")?i.NEURAL_NETWORK:e.includes("WebGL")||e.includes("render")||e.includes("draw")||e.includes("Batcher")?i.WEBGL_RENDERING:e.includes("uuid")||e.includes("UUID")||e.includes("token")||e.includes("encrypt")||e.includes("crypto")?i.CRYPTOGRAPHIC_OPS:e.includes("Social")||e.includes("Mystical")||e.includes("Collective")?i.SOCIAL_EVENTS:e.includes("Monitor")||e.includes("Health")||e.includes("metrics")?i.MONITORING:i.GENETIC_MUTATIONS:i.GENETIC_MUTATIONS}catch{return i.GENETIC_MUTATIONS}}static randomInt(e,t){if(e>=t)throw new Error("PerformanceOptimizedRandom: min doit √™tre inf√©rieur √† max");const r=t-e,s=this.detectUsageContext();return Math.floor(this.provider.random(s)*r)+e}static randomFloat(e,t){if(e>=t)throw new Error("PerformanceOptimizedRandom: min doit √™tre inf√©rieur √† max");const r=this.detectUsageContext();return this.provider.random(r)*(t-e)+e}static async randomBatch(e,t){const r=t||this.detectUsageContext();return this.provider.generateBatch(e,r)}static randomBytes(e){const t=this.detectUsageContext();if(t!==i.CRYPTOGRAPHIC_OPS){const r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=Math.floor(256*this.provider.random(t));return r}if("undefined"!=typeof crypto&&crypto.getRandomValues){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}n.vF.warn("PerformanceOptimizedRandom: crypto.getRandomValues non disponible");const r=new Uint8Array(e);for(let t=0;t<e;t++)r[t]=Math.floor(256*this.provider.cryptoRandom());return r}static choice(e){if(0===e.length)throw new Error("PerformanceOptimizedRandom: Le tableau ne peut pas √™tre vide");return e[this.randomInt(0,e.length)]}static uuid(){return this.generateSecureUUID()}static generateSecureUUID(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const t=Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20,32)].join("-")}return n.vF.warn("PerformanceOptimizedRandom: crypto.getRandomValues non disponible, fallback provider"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*this.provider.cryptoRandom()|0;return("x"===e?t:3&t|8).toString(16)}))}static randomString(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r="";for(let s=0;s<e;s++)r+=t.charAt(this.randomInt(0,t.length));return r}static randomId(e="",t=8){const r=this.randomString(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");return e?`${e}_${r}`:r}static neuralRandom(){return this.provider.neuralRandom()}static renderingRandom(){return this.provider.renderingRandom()}static mutationRandom(){return this.provider.mutationRandom()}static cryptoRandom(){return this.provider.cryptoRandom()}static async neuralBatch(e){return this.provider.generateBatch(e,i.NEURAL_NETWORK)}static async renderingBatch(e){return this.provider.generateBatch(e,i.WEBGL_RENDERING)}static getPerformanceMetrics(){return this.provider.getPerformanceMetrics()}static configurePerformance(e,t){this.provider.configureContext(e,{securityLevel:t})}static async warmup(){n.vF.info("PerformanceOptimizedRandom: Initialisation pools performance..."),await Promise.all([this.provider.generateBatch(1e3,i.NEURAL_NETWORK),this.provider.generateBatch(500,i.WEBGL_RENDERING),this.provider.generateBatch(300,i.GENETIC_MUTATIONS)]),n.vF.info("PerformanceOptimizedRandom: Warmup termin√©, performance optimale pr√™te")}static async benchmarkVsSecureRandom(e=1e4){const t=performance.now();for(let t=0;t<e;t++){const e=new Uint32Array(1);"undefined"!=typeof crypto&&crypto.getRandomValues&&(crypto.getRandomValues(e),e[0],this.MAX_UINT32)}const r=performance.now()-t,s=performance.now();for(let t=0;t<e;t++)this.neuralRandom();const i=performance.now()-s,n=r/i;return{secureRandomMs:Math.round(100*r)/100,optimizedMs:Math.round(100*i)/100,speedupRatio:Math.round(10*n)/10,recommendation:n>100?`üöÄ Gain massif ${n.toFixed(0)}x - Migration recommand√©e`:n>10?`‚ö° Gain significatif ${n.toFixed(0)}x - Migration b√©n√©fique`:`‚úÖ Gain mod√©r√© ${n.toFixed(1)}x - Migration optionnelle`}}}h.provider=c.getInstance(),h.MAX_UINT32=4294967295,h.random,h.randomInt,h.randomFloat,h.neuralRandom,h.renderingRandom,h.mutationRandom,h.cryptoRandom}},r={};function s(e){var i=r[e];if(void 0!==i)return i.exports;var n=r[e]={exports:{}};return t[e](n,n.exports,s),n.exports}s.m=t,s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce(((t,r)=>(s.f[r](e,t),t)),[])),s.u=e=>"background/"+e+".index.js",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;s.g.importScripts&&(e=s.g.location+"");var t=s.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var i=r.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=r[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=e+"../"})(),(()=>{var e={792:1};s.f.i=(t,r)=>{e[t]||importScripts(s.p+s.u(t))};var t=self.webpackChunksymbiont=self.webpackChunksymbiont||[],r=t.push.bind(t);t.push=t=>{var[i,n,a]=t;for(var o in n)s.o(n,o)&&(s.m[o]=n[o]);for(a&&a(s);i.length;)e[i.pop()]=1;r(t)}})(),function(e){e.PAGE_VISIT="PAGE_VISIT",e.SCROLL_EVENT="SCROLL_EVENT",e.ORGANISM_UPDATE="ORGANISM_UPDATE",e.ORGANISM_MUTATE="ORGANISM_MUTATE",e.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",e.WEBGL_INIT="WEBGL_INIT",e.WEBGL_ERROR="WEBGL_ERROR",e.WEBGL_INITIALIZED="WEBGL_INITIALIZED",e.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",e.GENERATE_INVITATION="GENERATE_INVITATION",e.INVITATION_GENERATED="INVITATION_GENERATED",e.CONSUME_INVITATION="CONSUME_INVITATION",e.INVITATION_CONSUMED="INVITATION_CONSUMED",e.CHECK_INVITATION="CHECK_INVITATION",e.INVITATION_CHECKED="INVITATION_CHECKED",e.MURMUR="MURMUR",e.GET_INVITER="GET_INVITER",e.INVITER_RESULT="INVITER_RESULT",e.GET_INVITEES="GET_INVITEES",e.INVITEES_RESULT="INVITEES_RESULT",e.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",e.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",e.INTERACTION_DETECTED="INTERACTION_DETECTED",e.GET_HEALTH_METRICS="GET_HEALTH_METRICS",e.HEALTH_METRICS_RESPONSE="HEALTH_METRICS_RESPONSE",e.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",e.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",e.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",e.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",e.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",e.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",e.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",e.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",e.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED"}(e||(e={}));var i=s(455),n=s(513);function a(e){return e&&"object"==typeof e?o(e):e}function o(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof HTMLCanvasElement||e instanceof CanvasRenderingContext2D||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner||e&&"object"==typeof e&&e.constructor&&e.constructor.name&&e.constructor.name.includes("Fiber"))return e instanceof HTMLCanvasElement?{tagName:"CANVAS",width:e.width,height:e.height,className:e.className,id:e.id}:"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>o(e,t)));const r={};for(const s in e)if(e.hasOwnProperty(s))try{r[s]=o(e[s],t)}catch(e){r[s]="[Non-serializable]"}return r}function c(e){return"object"==typeof e&&null!==e&&"code"in e&&"string"==typeof e.code&&"status"in e&&"string"==typeof e.status}function h(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return n.vF.warn("Message serialization issue, cleaning object:",t),l(e)}}function l(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof HTMLCanvasElement||e instanceof CanvasRenderingContext2D||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner||e&&"object"==typeof e&&e.constructor&&e.constructor.name&&e.constructor.name.includes("Fiber"))return"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>l(e,t)));const r={};for(const s in e)if(e.hasOwnProperty(s))try{r[s]=l(e[s],t)}catch(e){r[s]="[Non-serializable]"}return r}class u{constructor(e){this.source=e,this.handlers=new Map,this.globalHandlers=new Set,this.filters=[],this.messageQueue=[],this.processing=!1,this.setupListeners()}setupListeners(){chrome.runtime.onMessage.addListener(((e,t,r)=>(this.shouldProcessMessage(e)&&(this.enqueueMessage(e),r({received:!0})),!1)))}shouldProcessMessage(e){return this.filters.every((t=>t(e)))}async enqueueMessage(e){if(this.messageQueue.push(e),!this.processing){this.processing=!0;try{await this.processQueue()}finally{this.processing=!1}}}async processQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();await this.processMessage(e)}}async processMessage(t){if(!function(t,r){switch(t){case e.ORGANISM_UPDATE:return"object"==typeof(s=r)&&null!==s&&"id"in s&&"string"==typeof s.id&&"generation"in s&&"number"==typeof s.generation&&"health"in s&&"number"==typeof s.health&&"energy"in s&&"number"==typeof s.energy&&"traits"in s&&"object"==typeof s.traits;case e.ORGANISM_MUTATE:return function(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"trigger"in e&&"string"==typeof e.trigger}(r);case e.PAGE_VISIT:case e.SCROLL_EVENT:return function(e){return e&&"string"==typeof e.url&&"number"==typeof e.visitCount}(r);case e.MURMUR:return function(e){return"object"==typeof e&&null!==e&&"text"in e&&"string"==typeof e.text&&"timestamp"in e&&"number"==typeof e.timestamp}(r);case e.GENERATE_INVITATION:case e.CONSUME_INVITATION:case e.CHECK_INVITATION:return function(e){return"object"==typeof e&&null!==e&&"code"in e&&"string"==typeof e.code}(r);case e.INVITATION_GENERATED:return"string"==typeof r||c(r);case e.INVITATION_CONSUMED:case e.INVITATION_CHECKED:return c(r);case e.SHARED_MUTATION_RESULT:return"string"==typeof r||r&&"object"==typeof r;default:return!0}var s}(t.type,t.payload))return void n.vF.warn(`[MessageBus] Payload non valide pour le type ${t.type}`,t.payload);for(const e of this.globalHandlers)try{await e(t)}catch(e){n.vF.error("Error in global handler:",e)}const r=this.handlers.get(t.type);if(r)for(const e of r)try{await e(t)}catch(e){n.vF.error(`Error in handler for ${t.type}:`,e)}}on(e,t){this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t)}off(e,t){const r=this.handlers.get(e);r&&r.delete(t)}onAny(e){this.globalHandlers.add(e)}offAny(e){this.globalHandlers.delete(e)}addFilter(e){this.filters.push(e)}async send(e){const t={...e,source:this.source,timestamp:Date.now(),id:(0,i.lk)()};try{const e=h(a(t));if("content"===this.source)await chrome.runtime.sendMessage(e);else{const t=await chrome.tabs.query({}),r=e=>e.active||e.url&&e.url.includes("symbiont"),s=t.filter(r);for(const t of s)t.id&&chrome.tabs.sendMessage(t.id,e).catch((()=>{}));chrome.runtime.sendMessage(e).catch((()=>{}))}}catch(e){n.vF.error("Error sending message:",e)}}sendToBackground(e){this.send(e)}emit(e,t){const r=this.handlers.get(e);r&&r.forEach((r=>r({type:e,payload:t})))}handleMessage(e,t){n.vF.info("Handling message:",e)}onMessage(e,t,r){return n.vF.info("Received message:",e),!0}sendToFrame(e,t,r){n.vF.info("Sending to frame:",t,r)}}class m{constructor(){this.db=null,this.DB_NAME="symbiont-db",this.DB_VERSION=3,this.OPERATION_TIMEOUT=1e4,this.MAX_STORAGE_SIZE_MB=50,this.quotaWarningIssued=!1}withTimeout(e,t=this.OPERATION_TIMEOUT){return Promise.race([e,new Promise(((e,r)=>setTimeout((()=>r(new Error(`Operation timed out after ${t}ms`))),t)))])}async initialize(){try{await this.checkStorageQuota()}catch(e){console.warn("Failed to check storage quota:",e)}const e=new Promise(((e,t)=>{const r=indexedDB.open(this.DB_NAME,this.DB_VERSION);r.onerror=()=>{const e=r.error;console.error("IndexedDB open failed:",{name:e?.name,message:e?.message,code:e?.code}),t(e)},r.onsuccess=()=>{this.db=r.result,this.db.onerror=e=>{console.error("Database error:",e)},this.db.onversionchange=()=>{console.warn("Database version changed, closing connection"),this.db?.close(),this.db=null},e()},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("organisms")){const e=t.createObjectStore("organisms",{keyPath:"id"});e.createIndex("generation","generation",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(!t.objectStoreNames.contains("behaviors")){const e=t.createObjectStore("behaviors",{keyPath:"url"});e.createIndex("lastVisit","lastVisit",{unique:!1}),e.createIndex("visitCount","visitCount",{unique:!1})}if(!t.objectStoreNames.contains("mutations")){const e=t.createObjectStore("mutations",{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}if(t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"key"}),!t.objectStoreNames.contains("invitations")){const e=t.createObjectStore("invitations",{keyPath:"code"});e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("status","status",{unique:!1})}}}));return this.withTimeout(e,15e3)}async getOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,r)=>{const s=this.db.transaction(["organisms"],"readonly").objectStore("organisms");if(e){const i=s.get(e);i.onsuccess=()=>t(i.result||null),i.onerror=()=>r(i.error)}else{const e=s.openCursor();e.onsuccess=e=>{const r=e.target.result;t(r?r.value:null)},e.onerror=()=>r(e.error)}}));return this.withTimeout(t)}async saveOrganism(e){if(!this.db)throw new Error("Database not initialized");const t=new Promise(((t,r)=>{const s=this.db.transaction(["organisms"],"readwrite").objectStore("organisms").put(e);s.onsuccess=()=>t(),s.onerror=()=>r(s.error)}));return this.withTimeout(t)}async getBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const s=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").get(e);s.onsuccess=()=>t(s.result||null),s.onerror=()=>r(s.error)}))}async saveBehavior(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const s=this.db.transaction(["behaviors"],"readwrite").objectStore("behaviors").put(e);s.onsuccess=()=>t(),s.onerror=()=>r(s.error)}))}async addMutation(e){if(!this.db)throw new Error("Database not initialized");const t={...e,timestamp:e.timestamp||Date.now()};return new Promise(((e,r)=>{const s=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").add(t);s.onsuccess=()=>e(),s.onerror=()=>r(s.error)}))}async getRecentMutations(e=10){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const s=this.db.transaction(["mutations"],"readonly").objectStore("mutations").index("timestamp").openCursor(null,"prev"),i=[];s.onsuccess=r=>{const s=r.target.result;s&&i.length<e?(i.push(s.value),s.continue()):t(i)},s.onerror=()=>r(s.error)}))}async getSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((r,s)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{const e=i.result;r(e?e.value:t)},i.onerror=()=>s(i.error)}))}async setSetting(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise(((r,s)=>{const i=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:e,value:t});i.onsuccess=()=>r(),i.onerror=()=>s(i.error)}))}async addInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const s=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").add({...e,createdAt:e.createdAt||Date.now()});s.onsuccess=()=>t(),s.onerror=()=>r(s.error)}))}async updateInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const s=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").put(e);s.onsuccess=()=>t(),s.onerror=()=>r(s.error)}))}async getInvitation(e){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,r)=>{const s=this.db.transaction(["invitations"],"readonly").objectStore("invitations").get(e);s.onsuccess=()=>t(s.result||null),s.onerror=()=>r(s.error)}))}async getAllInvitations(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const r=this.db.transaction(["invitations"],"readonly").objectStore("invitations").openCursor(),s=[];r.onsuccess=t=>{const r=t.target.result;r?(s.push(r.value),r.continue()):e(s)},r.onerror=()=>t(r.error)}))}async getBehaviorPatterns(){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,t)=>{const r=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),s=[];r.onsuccess=t=>{const r=t.target.result;r?(s.push(r.value),r.continue()):(s.sort(((e,t)=>t.visitCount!==e.visitCount?t.visitCount-e.visitCount:t.lastVisit-e.lastVisit)),e(s))},r.onerror=()=>t(r.error)}))}async getRecentActivity(e=864e5){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-e;return new Promise(((e,r)=>{const s=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),i=[];s.onsuccess=r=>{const s=r.target.result;if(s){const e=s.value,r=(e.interactions||[]).filter((e=>e.timestamp>=t));for(const t of r)i.push({...t,url:e.url});s.continue()}else i.sort(((e,t)=>t.timestamp-e.timestamp)),e(i)},s.onerror=()=>r(s.error)}))}async cleanup(e=30){if(!this.db)throw new Error("Database not initialized");const t=Date.now()-24*e*60*60*1e3;return new Promise(((e,r)=>{const s=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").index("timestamp"),i=IDBKeyRange.upperBound(t),n=s.openCursor(i);n.onsuccess=t=>{const r=t.target.result;r?(r.delete(),r.continue()):e()},n.onerror=()=>r(n.error)}))}async checkStorageQuota(){if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,r=(e.quota||0)/1048576,s=r>0?t/r*100:0;console.info("Storage quota:",{usageInMB:t.toFixed(2),quotaInMB:r.toFixed(2),usagePercent:s.toFixed(2)+"%"}),s>80&&!this.quotaWarningIssued&&(this.quotaWarningIssued=!0,console.warn("STORAGE WARNING: Usage above 80%, consider cleanup"),s>90&&(console.warn("STORAGE CRITICAL: Usage above 90%, triggering automatic cleanup"),await this.cleanup(15))),t>.9*this.MAX_STORAGE_SIZE_MB&&(console.error("STORAGE CRITICAL: Approaching maximum storage size limit"),await this.cleanup(7))}catch(e){console.error("Failed to check storage quota:",e)}else console.warn("Storage API not available, skipping quota check")}async getStorageStats(){if(!navigator.storage||!navigator.storage.estimate)return{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1};try{const e=await navigator.storage.estimate(),t=(e.usage||0)/1048576,r=(e.quota||0)/1048576,s=r>0?t/r*100:0;return{usageInMB:t,quotaInMB:r,usagePercent:s,needsCleanup:s>80}}catch(e){return console.error("Failed to get storage stats:",e),{usageInMB:0,quotaInMB:0,usagePercent:0,needsCleanup:!1}}}close(){this.db&&(this.db.close(),this.db=null)}}var d=s(18);class g{constructor(e){this.storage=e}async generateInvitation(e){const t={code:(await s.e(221).then(s.bind(s,221))).v4().slice(0,8).toUpperCase(),donorId:e,symbolicLink:this.generateSymbolicLink(),used:!1,createdAt:Date.now()};return await this.storage.addInvitation(t),t}async consumeInvitation(e,t){const r=await this.storage.getInvitation(e);return!r||r.used?null:(r.used=!0,r.receiverId=t,r.usedAt=Date.now(),await this.storage.updateInvitation(r),r)}async isValid(e){const t=await this.storage.getInvitation(e);return!!t&&!t.used}generateSymbolicLink(){const e=["#FF00FF","#00FFFF","#FFFF00","#FF8800","#00FF88","#8800FF"];return e[Math.floor(d.Dm.random()*e.length)]}async getAllInvitations(){return await this.storage.getAllInvitations()}}const y={loop:["Encore ce m√™me chemin... Qu'y cherches-tu ?","La boucle se r√©p√®te, intention ou habitude ?","Revenir, encore et encore. Un besoin de rep√®re ?"],idle:["Un temps de pause... ou d'h√©sitation ?","Le silence aussi fait partie du voyage.","L'inactivit√©, pr√©lude √† une nouvelle exploration ?"],exploration:["Nouveau territoire, nouvelle perspective.","L'exploration nourrit la curiosit√©.","Tu t'aventures hors des sentiers battus."],routine:["Les habitudes forgent des chemins familiers.","La routine rassure, mais l'inattendu surprend.","Encore ce site, comme un rituel quotidien."],default:["Tu reviens souvent ici quand tu doutes.","Pourquoi cette boucle ?","As-tu remarqu√© ce sch√©ma dans ta navigation ?","Un autre d√©tour, ou une qu√™te de sens ?","Ce site semble t'attirer dans les moments de r√©flexion.","Encore une fois, tu explores ce chemin familier.","Et si tu essayais une nouvelle direction ?","La r√©p√©tition cache-t-elle une intention ?","Un murmure dans le flux de tes habitudes...","Parfois, la boucle est une porte vers l'inattendu."]},p={morning:["Un nouveau jour, une nouvelle boucle commence.","Le matin invite √† la d√©couverte.","L'aube de tes habitudes num√©riques."],afternoon:["L'apr√®s-midi, la routine s'installe.","Un moment propice √† l'exploration ou √† la r√©p√©tition ?","Le soleil haut, l'esprit vagabonde."],evening:["Le soir, tu reviens √† l'essentiel.","La nuit favorise les d√©tours int√©rieurs.","Encore connect√©, m√™me √† la tomb√©e du jour."],weekend:["Le week-end, les chemins changent.","Un rythme diff√©rent, des envies nouvelles.","La libert√© du week-end se lit dans ta navigation."]};class f{generateMurmur(e){if(function(){const e=(new Date).getDay();return 0===e||6===e}()){const e=p.weekend;if(d.Dm.random()<.5)return e[Math.floor(d.Dm.random()*e.length)]}else{const e=function(){const e=(new Date).getHours();return e<12?"morning":e<18?"afternoon":"evening"}();if(p[e]&&d.Dm.random()<.4){const t=p[e];return t[Math.floor(d.Dm.random()*t.length)]}}const t=e&&y[e]?y[e]:y.default;return t[Math.floor(d.Dm.random()*t.length)]}}class v{static detectRepetition(e,t=3){const r={};for(const t of e)r[t.type]=(r[t.type]||0)+1;return Object.entries(r).filter((([e,r])=>r>=t)).map((([e,t])=>({type:"repetition",score:t,details:{eventType:e}})))}static detectAlternance(e,t,r,s=4){let i=0,n=null;for(const s of e)s.type!==t&&s.type!==r||s.type===n?s.type===n&&(i=1,n=s.type):(i++,n=s.type);return i>=s?[{type:"alternance",score:i,details:{typeA:t,typeB:r}}]:[]}static detectBurst(e,t=1e3,r=3){if(e.length<r)return[];let s=1,i=1;for(let r=1;r<e.length;r++)e[r].timestamp-e[r-1].timestamp<=t?(s++,i=Math.max(i,s)):s=1;return i>=r?[{type:"burst",score:i,details:{maxInterval:t}}]:[]}static detectTemporalPattern(e,t=1e3,r=.2){if(e.length<3)return[];const s=[];for(let t=1;t<e.length;t++)s.push(e[t].timestamp-e[t-1].timestamp);const i=s.reduce(((e,t)=>e+t),0)/s.length,n=s.reduce(((e,t)=>e+Math.pow(t-i,2)),0)/s.length,a=Math.sqrt(n);return i>=t&&a/i<r?[{type:"temporal",score:i,details:{std:a,count:e.length}}]:[]}}class E{static getInstance(){return this.instance||(this.instance=new E),this.instance}async setItem(e,t){try{await chrome.storage.local.set({[e]:t})}catch(e){throw n.vF.error("Storage error:",e),e}}async getItem(e){try{return(await chrome.storage.local.get([e]))[e]||null}catch(e){return n.vF.error("Storage retrieval error:",e),null}}async removeItem(e){try{await chrome.storage.local.remove([e])}catch(e){n.vF.error("Storage removal error:",e)}}}class w{static get swLocalStorage(){return{getItem:e=>this.storage.getItem(e),setItem:(e,t)=>this.storage.setItem(e,t),removeItem:e=>this.storage.removeItem(e)}}static get swIndexedDB(){return globalThis.indexedDB}static get swCryptoAPI(){return"undefined"!=typeof globalThis&&globalThis.crypto&&globalThis.crypto.subtle&&"function"==typeof globalThis.crypto.getRandomValues?{...globalThis.crypto,encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)}:(n.vF.warn("WebCrypto API non disponible - utilisation du mode de d√©veloppement"),{subtle:null,getRandomValues:e=>{for(let t=0;t<e.length;t++){const r=Date.now()+t;e[t]=Math.floor(1e4*Math.sin(r)%256)}return e},encryptSensitiveData:this.swCrypto.encryptSensitiveData.bind(this.swCrypto),decryptSensitiveData:this.swCrypto.decryptSensitiveData.bind(this.swCrypto)})}}w.storage=E.getInstance(),w.swCrypto=new class{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(e){try{const t=new TextEncoder,r=t.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),s=await crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt"]),i=crypto.getRandomValues(new Uint8Array(12)),n=t.encode(JSON.stringify(e)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:i},s,n),o=new Uint8Array(i.length+a.byteLength);return o.set(i,0),o.set(new Uint8Array(a),i.length),btoa(String.fromCharCode(...o))}catch(t){n.vF.error("Encryption failed, using fallback:",t);const r=JSON.stringify(e);return btoa(unescape(encodeURIComponent(r)))}}async decryptSensitiveData(e){try{const t=Uint8Array.from(atob(e),(e=>e.charCodeAt(0))),r=t.slice(0,12),s=t.slice(12),i=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),n=await crypto.subtle.importKey("raw",i,{name:"AES-GCM"},!1,["decrypt"]),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},n,s),o=new TextDecoder;return JSON.parse(o.decode(a))}catch(t){n.vF.error("Decryption failed, trying fallback:",t);try{const t=decodeURIComponent(escape(atob(e)));return JSON.parse(t)}catch(e){throw n.vF.error("All decryption methods failed:",e),new Error("Unable to decrypt data")}}}},w.swBroadcastChannel=class{constructor(e){this.handlers=new Map,this.channelName=e,this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener(((e,t,r)=>"CRYPTO_OPERATION"===e.type||e.channel===this.channelName&&(this.handleMessage(e.data),!0)))}serializeMessageData(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return n.vF.warn("Message serialization issue, cleaning object:",t),this.cleanObjectForSerialization(e)}}cleanObjectForSerialization(e,t=new WeakSet){if(null==e)return e;if("function"==typeof e)return"[Function]";if(e instanceof Date)return e.toISOString();if(e instanceof Error)return{name:e.name,message:e.message,stack:e.stack};if(e instanceof WebGLRenderingContext||e instanceof WebGL2RenderingContext||e instanceof HTMLElement||e instanceof WebGLProgram||e instanceof WebGLBuffer||e instanceof WebGLTexture||e&&e.$$typeof||e&&e.__reactFiber||e&&e._owner)return"[Non-serializable Object]";if("object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map((e=>this.cleanObjectForSerialization(e,t)));const r={};for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s))try{r[s]=this.cleanObjectForSerialization(e[s],t)}catch(e){r[s]="[Non-serializable]"}return r}postMessage(e){const t=this.serializeMessageData(e);chrome.tabs.query({},(e=>{e.forEach((e=>{e.id&&chrome.tabs.sendMessage(e.id,{channel:this.channelName,data:t}).catch((()=>{}))}))})),this.broadcastViaStorage(t)}async broadcastViaStorage(e){const t=E.getInstance(),r=Date.now(),s=`broadcast_${this.channelName}_${r}`;await t.setItem(s,JSON.stringify({data:e,timestamp:r,channel:this.channelName})),setTimeout((async()=>{await t.removeItem(s)}),3e4)}handleMessage(e){(this.handlers.get("message")||[]).forEach((t=>{try{t({data:e})}catch(e){n.vF.error("Message handler error:",e)}}))}set onmessage(e){this.handlers.has("message")||this.handlers.set("message",[]),this.handlers.get("message").push((t=>e(t)))}};const S=w.swLocalStorage,b=(w.swBroadcastChannel,w.swCryptoAPI);w.swIndexedDB;class I{constructor(e){this.activeRequests=0,this.circuitBreakerOpen=!1,this.lastFailureTime=0,this.circuitBreakerTimeout=3e4,this.config=e}async execute(e){if(this.circuitBreakerOpen){if(Date.now()-this.lastFailureTime<this.circuitBreakerTimeout)throw new Error(`Circuit breaker ouvert pour ${this.config.name}`);this.circuitBreakerOpen=!1,n.vF.info(`Circuit breaker ferm√© pour ${this.config.name}`)}if(this.activeRequests>=this.config.maxConcurrentRequests){if("fail-fast"===this.config.fallbackStrategy)throw new Error(`Bulkhead satur√©: ${this.config.name}`);await this.waitForSlot()}this.activeRequests++;try{return await this.executeWithTimeout(e)}catch(e){throw this.handleFailure(e),e}finally{this.activeRequests--}}async executeWithTimeout(e){return new Promise(((t,r)=>{const s=setTimeout((()=>{r(new Error(`Timeout dans bulkhead ${this.config.name}`))}),this.config.timeout);e().then((e=>{clearTimeout(s),t(e)})).catch((e=>{clearTimeout(s),r(e)}))}))}async waitForSlot(){const e=this.config.timeout,t=Date.now();for(;this.activeRequests>=this.config.maxConcurrentRequests;){if(Date.now()-t>e)throw new Error(`Timeout d'attente pour bulkhead ${this.config.name}`);await new Promise((e=>setTimeout(e,10)))}}handleFailure(e){"circuit-breaker"===this.config.fallbackStrategy&&(this.circuitBreakerOpen=!0,this.lastFailureTime=Date.now(),n.vF.warn(`Circuit breaker ouvert pour ${this.config.name}:`,e))}}const T=new class{constructor(){this.bulkheads=new Map,this.metrics=new Map}createBulkhead(e){if(this.bulkheads.has(e.name))return this.bulkheads.get(e.name);const t=new I(e);return this.bulkheads.set(e.name,t),this.metrics.set(e.name,{name:e.name,activeRequests:0,totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0}),n.vF.info(`Bulkhead cr√©√©: ${e.name}`,e),t}async execute(e,t,r){const s=this.bulkheads.get(e);if(!s)throw new Error(`Bulkhead non trouv√©: ${e}`);const i=Date.now();this.updateMetrics(e,"start");try{const r=await s.execute(t),n=Date.now()-i;return this.updateMetrics(e,"success",n),r}catch(t){const r=Date.now()-i;throw this.updateMetrics(e,"error",r,t),t}}updateMetrics(e,t,r,s){const i=this.metrics.get(e);if(i)switch(t){case"start":i.activeRequests++,i.totalRequests++;break;case"success":i.activeRequests--,i.successfulRequests++,r&&(i.averageResponseTime=(i.averageResponseTime*(i.successfulRequests-1)+r)/i.successfulRequests);break;case"error":i.activeRequests--,i.failedRequests++,s&&(i.lastError=s instanceof Error?s.message:String(s),i.lastErrorTime=Date.now())}}getMetrics(){return Array.from(this.metrics.values())}getBulkheadMetrics(e){return this.metrics.get(e)||null}getHealthStatus(){const e={};for(const[t,r]of this.metrics){const s=r.totalRequests>0?r.failedRequests/r.totalRequests:0;s>.5?e[t]="failed":s>.2||r.averageResponseTime>5e3?e[t]="degraded":e[t]="healthy"}return e}};class A{constructor(e=!1){this.encryptionKey=null,this.keyPromise=null,this.setupBulkheads(),e||this.initializeSecureKey()}setupBulkheads(){T.createBulkhead({name:"crypto-operations",maxConcurrentRequests:5,timeout:1e4,fallbackStrategy:"circuit-breaker",retryAttempts:2}),T.createBulkhead({name:"secure-storage",maxConcurrentRequests:10,timeout:5e3,fallbackStrategy:"fail-fast"}),T.createBulkhead({name:"data-anonymization",maxConcurrentRequests:3,timeout:3e3,fallbackStrategy:"retry",retryAttempts:3})}async initializeSecureKey(){this.keyPromise||(this.keyPromise=this.generateSecureKey(),this.encryptionKey=await this.keyPromise)}async generateSecureKey(){if(!b?.subtle)return n.vF.warn("WebCrypto API non disponible - mode d√©veloppement activ√© (NON S√âCURIS√â)"),this.createDevelopmentKey();const e=await this.getStoredKey();if(e)return await b.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"]);const t=await b.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return await this.storeKey(t),t}createDevelopmentKey(){return{type:"secret",extractable:!1,algorithm:{name:"AES-GCM"},usages:["encrypt","decrypt"]}}async getStoredKey(){try{return new Promise((e=>{chrome.storage.local.get(["symbiont_key_v2"],(t=>{if(t.symbiont_key_v2){const r=new Uint8Array(t.symbiont_key_v2);e(r.buffer)}else e(null)}))}))}catch{return null}}async storeKey(e){try{if(!b?.subtle)return void n.vF.warn("Mode d√©veloppement: pas de stockage de cl√© r√©el");const t=await b.subtle.exportKey("raw",e),r=Array.from(new Uint8Array(t));chrome.storage.local.set({symbiont_key_v2:r,symbiont_key_created:Date.now()})}catch(e){n.vF.error("Erreur lors du stockage de la cl√©:",e)}}async ensureKeyReady(){if(this.encryptionKey||await this.initializeSecureKey(),!this.encryptionKey)throw new Error("Impossible d'initialiser la cl√© de chiffrement");return this.encryptionKey}async encryptSensitiveData(e){return T.execute("crypto-operations",(async()=>this._encryptSensitiveData(e)),"encryptSensitiveData")}async _encryptSensitiveData(e){if(!b?.subtle)return n.vF.warn("WebCrypto API non disponible - chiffrement factice pour d√©veloppement"),"DEV_MODE:"+btoa(JSON.stringify(e));try{const t=await this.ensureKeyReady(),r=new TextEncoder,s=b.getRandomValues(new Uint8Array(12)),i=r.encode(JSON.stringify(e)),n=await b.subtle.encrypt({name:"AES-GCM",iv:s},t,i),a=new Uint8Array(s.length+n.byteLength);return a.set(s,0),a.set(new Uint8Array(n),s.length),btoa(String.fromCharCode(...a))}catch(e){throw n.vF.error("Erreur de chiffrement:",e),new Error("√âchec du chiffrement des donn√©es sensibles")}}async decryptSensitiveData(e){return T.execute("crypto-operations",(async()=>this._decryptSensitiveData(e)),"decryptSensitiveData")}async _decryptSensitiveData(e){if("string"!=typeof e)throw new Error("decryptSensitiveData attend une cha√Æne de caract√®res.");if(e.startsWith("DEV_MODE:")){n.vF.warn("D√©chiffrement en mode d√©veloppement (non s√©curis√©)");try{return JSON.parse(atob(e.substring(9)))}catch(e){return n.vF.error("Erreur d√©chiffrement mode d√©veloppement:",e),null}}if(!b?.subtle)return n.vF.warn("WebCrypto API non disponible - d√©chiffrement factice pour d√©veloppement"),null;try{const t=await this.ensureKeyReady(),r=Uint8Array.from(atob(String(e)),(e=>e.charCodeAt(0))),s=r.slice(0,12),i=r.slice(12),n=await b.subtle.decrypt({name:"AES-GCM",iv:s},t,i),a=(new TextDecoder).decode(n);return JSON.parse(a)}catch(e){throw n.vF.error("Erreur de d√©chiffrement:",e),new Error("√âchec du d√©chiffrement des donn√©es - donn√©es corrompues ou cl√© invalide")}}async anonymizeForSharing(e){return T.execute("data-anonymization",(async()=>this._anonymizeForSharing(e)),"anonymizeForSharing")}async _anonymizeForSharing(e){const t={...e};return"url"in t&&(t.url="anonymized"),"userId"in t&&"string"==typeof t.userId&&(t.userId=await this.hash(t.userId)),"id"in t&&"string"==typeof t.id&&(t.id=await this.hash(t.id)),["email","name","address","phone","ip","ssn","creditCard","passport","nationalId","birthDate","age","location","coordinates","biometric","medical","financial","salary"].forEach((e=>{e in t&&delete t[e]})),"timestamp"in t&&"number"==typeof t.timestamp&&(t.timestamp=36e5*Math.floor(t.timestamp/36e5)),t}anonymizeForSharingSync(e){const t={...e};return"url"in t&&(t.url="anonymized"),"userId"in t&&"string"==typeof t.userId&&(t.userId=this.hashSync(t.userId)),"id"in t&&"string"==typeof t.id&&(t.id=this.hashSync(t.id)),t}validateDataAccess(e,t="user"){return!(!e.userId||!e.resource||"admin"===t&&"admin"!==e.role)}async hash(e){if(!b?.subtle){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return btoa(t.toString())}try{const t=(new TextEncoder).encode(e),r=await b.subtle.digest("SHA-256",t),s=new Uint8Array(r);return btoa(String.fromCharCode(...s))}catch(e){throw n.vF.error("Erreur de hashage:",e),new Error("√âchec du hashage s√©curis√©")}}hashSync(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return btoa(t.toString())}}class R{static setDependencies(e){this.dependencies=e}static createOrganism(e,t){if(!this.dependencies)throw new Error("OrganismFactory dependencies not set. Call setDependencies() first.");const{OrganismCore:r}=s(502);return new r(e,t,this.dependencies.createNeuralMesh)}static createNeuralMesh(){const{NeuralMesh:e}=s(194);return new e}}R.dependencies=null;class C{constructor(){this.failureCount=0,this.open=!1,this.lastFailure=0,this.failureThreshold=5,this.recoveryTimeout=3e4}isOpen(){return this.open&&Date.now()-this.lastFailure>this.recoveryTimeout&&(this.open=!1,this.failureCount=0),this.open}recordSuccess(){this.failureCount=0,this.open=!1}recordFailure(){this.failureCount++,this.lastFailure=Date.now(),this.failureCount>=this.failureThreshold&&(this.open=!0)}}class M{constructor(){this.key="symbiont_messages"}async enqueue(e){n.vF.info("[ResilientMessageBus] enqueue",e);const t=JSON.parse(await S.getItem(this.key)||"[]");t.push(e),await S.setItem(this.key,JSON.stringify(t)),n.vF.info("[ResilientMessageBus] enqueue OK",t.length)}async dequeue(){const e=JSON.parse(await S.getItem(this.key)||"[]"),t=e.shift();return await S.setItem(this.key,JSON.stringify(e)),n.vF.info("[ResilientMessageBus] dequeue",t),t}async getAll(){const e=JSON.parse(await S.getItem(this.key)||"[]");return n.vF.info("[ResilientMessageBus] getAll",e.length),e}}const N={getItem:e=>{try{return"undefined"!=typeof localStorage?localStorage.getItem(e):null}catch{return null}},setItem:(e,t)=>{try{"undefined"!=typeof localStorage&&localStorage.setItem(e,t)}catch{}},removeItem:e=>{try{"undefined"!=typeof localStorage&&localStorage.removeItem(e)}catch{}},clear:()=>{try{"undefined"!=typeof localStorage&&localStorage.clear()}catch{}}},_="undefined"!=typeof indexedDB?indexedDB:null;class D{constructor(e,t){this.config=e,this.checkFunction=t}async execute(){return this.checkFunction()}}const O=new class{constructor(){this.checks=new Map,this.results=new Map,this.intervals=new Map,this.isRunning=!1,this.setupDefaultChecks()}setupDefaultChecks(){this.registerCheck("message-bus",{name:"message-bus",interval:3e4,timeout:5e3,retryAttempts:2,criticalLevel:"high"},(async()=>{const e=Date.now();try{return await new Promise((e=>setTimeout(e,50))),{status:"healthy",message:"MessageBus op√©rationnel",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`MessageBus en erreur: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("storage",{name:"storage",interval:6e4,timeout:1e4,retryAttempts:3,criticalLevel:"high"},(async()=>{const e=Date.now();try{const t="health_check_test",r={timestamp:Date.now()};return"undefined"!=typeof chrome&&chrome.storage&&(await new Promise(((e,s)=>{chrome.storage.local.set({[t]:r},(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):e()}))})),await new Promise(((e,r)=>{chrome.storage.local.get([t],(s=>{chrome.runtime.lastError?r(chrome.runtime.lastError):s&&s[t]?e():r(new Error("Failed to read test value from storage"))}))})),await new Promise(((e,r)=>{chrome.storage.local.remove(t,(()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):e()}))}))),{status:"healthy",message:"Stockage op√©rationnel",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`Stockage en erreur: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("bulkheads",{name:"bulkheads",interval:45e3,timeout:3e3,retryAttempts:1,criticalLevel:"medium"},(async()=>{const e=Date.now();try{const t=T.getHealthStatus(),r=Object.entries(t).filter((([,e])=>"failed"===e));return r.length>0?{status:"warning",message:`Bulkheads d√©grad√©s: ${r.map((([e])=>e)).join(", ")}`,responseTime:Date.now()-e,timestamp:Date.now(),details:{healthStatus:t}}:{status:"healthy",message:"Tous les bulkheads op√©rationnels",responseTime:Date.now()-e,timestamp:Date.now(),details:{healthStatus:t}}}catch(t){return{status:"warning",message:`Erreur check bulkheads: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}})),this.registerCheck("security",{name:"security",interval:12e4,timeout:5e3,retryAttempts:2,criticalLevel:"high"},(async()=>{const e=Date.now();try{return"undefined"!=typeof crypto&&void 0!==crypto.subtle?{status:"healthy",message:"S√©curit√© op√©rationnelle",responseTime:Date.now()-e,timestamp:Date.now()}:{status:"critical",message:"WebCrypto API indisponible",responseTime:Date.now()-e,timestamp:Date.now()}}catch(t){return{status:"critical",message:`Erreur s√©curit√©: ${t}`,responseTime:Date.now()-e,timestamp:Date.now()}}}))}registerCheck(e,t,r){const s=new D(t,r);this.checks.set(e,s),this.isRunning&&this.startCheck(e),n.vF.info(`Health check enregistr√©: ${e}`,t)}start(){if(this.isRunning)n.vF.warn("HealthCheckManager d√©j√† d√©marr√©");else{this.isRunning=!0;for(const e of this.checks.keys())this.startCheck(e);n.vF.info("HealthCheckManager d√©marr√©",{totalChecks:this.checks.size})}}stop(){this.isRunning=!1;for(const[e,t]of this.intervals)clearInterval(t),this.intervals.delete(e);n.vF.info("HealthCheckManager arr√™t√©")}startCheck(e){const t=this.checks.get(e);if(!t)return;this.executeCheck(e);const r=setInterval((()=>{this.executeCheck(e)}),t.config.interval);this.intervals.set(e,r)}async executeCheck(e){const t=this.checks.get(e);if(!t)return;let r,s=0;for(;s<=t.config.retryAttempts;)try{const r=await Promise.race([t.execute(),new Promise(((e,r)=>setTimeout((()=>r(new Error("Timeout"))),t.config.timeout)))]),s={name:e,...r};this.results.set(e,s);const i=this.results.get(e);return void(i&&i.status===r.status||n.vF.info(`Health check ${e}: ${r.status}`,{message:r.message,responseTime:r.responseTime}))}catch(e){r=e,s++,s<=t.config.retryAttempts&&await new Promise((e=>setTimeout(e,1e3*s)))}const i={name:e,status:"high"===t.config.criticalLevel?"critical":"warning",message:`Check √©chou√© apr√®s ${t.config.retryAttempts+1} tentatives: ${r}`,responseTime:t.config.timeout,timestamp:Date.now()};this.results.set(e,i),n.vF.error(`Health check ${e} √©chou√© d√©finitivement`,i)}getSystemHealth(){const e=Array.from(this.results.values()),t=e.length,r=e.filter((e=>"healthy"===e.status)).length,s=e.filter((e=>"critical"===e.status)).length;let i="unknown";return i=0===t?"unknown":s>0?"critical":r===t?"healthy":"degraded",{overallStatus:i,checks:e,lastUpdate:Date.now(),totalChecks:t,healthyChecks:r,criticalChecks:s}}getCheckResult(e){return this.results.get(e)||null}async forceCheck(e){return await this.executeCheck(e),this.getCheckResult(e)}},F=new class{constructor(){this.memoryCache=new Map,this.persistentStorage=chrome.storage?.local,this.indexedDB=null,this.emergencyLocalStorage=N,this.indexedDBReady=this.setupMultiLayerStorage(),this.setupDataReplication(),this.setupIntegrityMonitoring()}async store(e,t){if(e.includes("symbiont_health_alert_"))n.vF.info("[HybridStorageManager] Skipping health alert storage to prevent quota issues");else{n.vF.info("[HybridStorageManager] store - M√©moire",{key:e,data:t}),this.memoryCache.set(e,t);try{await new Promise(((r,s)=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?chrome.runtime.lastError.message?.includes("quota")?(n.vF.warn("[HybridStorageManager] Chrome storage quota exceeded, cleaning old data"),this.cleanOldStorageData().then((()=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):r(!0)}))})).catch(s)):s(chrome.runtime.lastError):r(!0)}))})),n.vF.info("[HybridStorageManager] store - chrome.storage.local OK",e)}catch(t){n.vF.warn("[HybridStorageManager] store - chrome.storage.local failed, fallback IndexedDB",{key:e,error:String(t)})}try{if(await this.indexedDBReady,!this.indexedDB)throw new Error("IndexedDB not ready");await new Promise(((r,s)=>{const i=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(t,e);i.onsuccess=()=>r(!0),i.onerror=()=>s(i.error)})),n.vF.info("[HybridStorageManager] store - IndexedDB OK",e)}catch(r){n.vF.warn("[HybridStorageManager] store - IndexedDB failed, fallback localStorage",{key:e,error:String(r)}),await this.emergencyLocalStorage.setItem(e,JSON.stringify(t)),n.vF.info("[HybridStorageManager] store - localStorage d'urgence OK",e)}}}async retrieve(e){if(this.memoryCache.has(e))return n.vF.info("[HybridStorageManager] retrieve - M√©moire HIT",e),this.memoryCache.get(e);try{const t=await new Promise(((t,r)=>{this.persistentStorage.get([e],(s=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t(s[e])}))}));if(void 0!==t)return this.memoryCache.set(e,t),n.vF.info("[HybridStorageManager] retrieve - chrome.storage.local OK",e),t}catch(t){n.vF.warn("[HybridStorageManager] retrieve - chrome.storage.local failed",{key:e,error:String(t)})}try{if(await this.indexedDBReady,this.indexedDB){const t=await new Promise(((t,r)=>{const s=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(e);s.onsuccess=()=>t(s.result),s.onerror=()=>r(s.error)}));if(void 0!==t)return this.memoryCache.set(e,t),n.vF.info("[HybridStorageManager] retrieve - IndexedDB OK",e),t}}catch(t){n.vF.warn("[HybridStorageManager] retrieve - IndexedDB failed",{key:e,error:String(t)})}try{const t=await this.emergencyLocalStorage.getItem(e);if(t)return n.vF.info("[HybridStorageManager] retrieve - localStorage d'urgence OK",e),JSON.parse(t)}catch(t){n.vF.warn("[HybridStorageManager] retrieve - localStorage d'urgence failed",{key:e,error:String(t)})}return null}setupMultiLayerStorage(){return new Promise((e=>{let t=!1;const r=setTimeout((()=>{t||(n.vF.warn("[HybridStorageManager] IndexedDB init timeout (5s), fallback only"),this.indexedDB=null,t=!0,e(!1))}),5e3);try{const s=_?.open("symbiont-db",1);if(!s)throw new Error("IndexedDB not available");s.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("symbiont")||t.createObjectStore("symbiont")},s.onsuccess=()=>{this.indexedDB=s.result,t||(clearTimeout(r),t=!0,n.vF.info("[HybridStorageManager] IndexedDB ready"),e(!0))},s.onerror=()=>{this.indexedDB=null,t||(clearTimeout(r),t=!0,n.vF.warn("[HybridStorageManager] IndexedDB failed to open"),e(!1))}}catch(s){this.indexedDB=null,t||(clearTimeout(r),t=!0,n.vF.warn("[HybridStorageManager] IndexedDB exception",s),e(!1))}}))}async cleanOldStorageData(){try{const e=(await new Promise(((e,t)=>{this.persistentStorage.get(null,(r=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(Object.keys(r))}))}))).filter((e=>e.includes("symbiont_health_alert_")||e.includes("broadcast_")||e.includes("_temp_")));e.length>0&&(await new Promise(((t,r)=>{this.persistentStorage.remove(e,(()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t()}))})),n.vF.info(`[HybridStorageManager] Cleaned ${e.length} old storage items`))}catch(e){n.vF.error("[HybridStorageManager] Failed to clean old storage data:",e)}}isIndexedDBReady(){return!!this.indexedDB}async syncData(){}async syncKeyAcrossLayers(e,t){this.memoryCache.set(e,t);try{await new Promise(((r,s)=>{this.persistentStorage.set({[e]:t},(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):r(!0)}))}))}catch(e){console.warn("Storage operation failed:",e)}try{await this.indexedDBReady,this.indexedDB&&await new Promise(((r,s)=>{const i=this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(t,e);i.onsuccess=()=>r(!0),i.onerror=()=>s(i.error)}))}catch(e){console.warn("Storage operation failed:",e)}try{await this.emergencyLocalStorage.setItem(e,JSON.stringify(t))}catch(e){console.warn("Storage operation failed:",e)}}setupDataReplication(){chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener(((e,t)=>{if("local"===t)for(const t in e){const{newValue:r}=e[t];this.syncKeyAcrossLayers(t,r),n.vF.info("[HybridStorageManager] DataReplication - Synchronisation des couches",t)}}))}setupIntegrityMonitoring(){setInterval((async()=>{for(const e of this.memoryCache.keys())try{const t=this.memoryCache.get(e),r=await new Promise((t=>{this.persistentStorage.get([e],(r=>t(r[e])))}));let s;await this.indexedDBReady,this.indexedDB&&(s=await new Promise((t=>{const r=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(e);r.onsuccess=()=>t(r.result),r.onerror=()=>t(void 0)})));const i=await this.emergencyLocalStorage.getItem(e),a=[t,r,s,i?JSON.parse(i):void 0].filter((e=>void 0!==e));if(!a.every((e=>JSON.stringify(e)===JSON.stringify(a[0])))){n.vF.warn("[HybridStorageManager] IntegrityMonitoring - Divergence d√©tect√©e pour",e);const t={};for(const e of a){const r=JSON.stringify(e);t[r]=(t[r]||0)+1}const[r]=Object.entries(t).sort(((e,t)=>t[1]-e[1]))[0],s=JSON.parse(r);if(this.memoryCache.set(e,s),this.persistentStorage.set({[e]:s}),this.indexedDB){this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(s,e)}this.emergencyLocalStorage.setItem(e,JSON.stringify(s)),n.vF.info("[HybridStorageManager] IntegrityMonitoring - Auto-r√©paration appliqu√©e pour",e)}}catch(t){n.vF.warn("[HybridStorageManager] IntegrityMonitoring - Erreur sur",{key:e,error:String(t)})}}),6e4)}},k=new class{constructor(){this.connectionState="offline",this.messageQueue=new M,this.failureStrategies=new Map,this.circuitBreaker=new C,this.failureQueue=[],this.isConnected=!1,this.connectionAttempts=0,this.setupFailureStrategies()}setupFailureStrategies(){this.failureStrategies.set("ORGANISM_UPDATE",{maxRetries:3,backoffStrategy:"exponential",fallbackAction:this.cacheOrganismState,criticalLevel:"high"}),this.failureStrategies.set("INTERACTION_DETECTED",{maxRetries:5,backoffStrategy:"linear",fallbackAction:this.queueForLaterSync,criticalLevel:"medium"}),this.failureStrategies.set("PAGE_ANALYSIS_COMPLETE",{maxRetries:2,backoffStrategy:"immediate",fallbackAction:this.processLocally,criticalLevel:"low"})}async send(e){if(this.circuitBreaker.isOpen())return await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:"Circuit breaker open"};let t=0;const r=this.failureStrategies.get(e.type),s=r?.maxRetries||2;for(;t<=s;)try{return await this.simulateSend(e),this.circuitBreaker.recordSuccess(),{success:!0}}catch(i){if(this.circuitBreaker.recordFailure(),t++,t>s)return r&&await r.fallbackAction.call(this,e),await this.messageQueue.enqueue(e),{success:!1,queued:!0,error:i};await this.wait(this.getBackoff(r?.backoffStrategy,t))}return{success:!1,queued:!0,error:"Unknown error"}}async simulateSend(e){return{success:!0,id:`sim_${Date.now()}`}}getBackoff(e="immediate",t){return"exponential"===e?500*Math.pow(2,t):"linear"===e?500*t:0}wait(e){return new Promise((t=>setTimeout(t,e)))}async cacheOrganismState(e){n.vF.info("[ResilientMessageBus] fallback cacheOrganismState",e),await S.setItem("symbiont_organism_cache",JSON.stringify(e))}async queueForLaterSync(e){n.vF.info("[ResilientMessageBus] fallback queueForLaterSync",e),await this.messageQueue.enqueue(e)}async processLocally(e){n.vF.info("[ResilientMessageBus] fallback processLocally",e),await S.setItem("symbiont_local_processing",JSON.stringify(e))}_attemptConnection(){return Promise.resolve(!0)}_processMessage(e){}};async function L(e){return await F.retrieve(e)}async function x(e,t){await F.store(e,t)}new class{constructor(e){this.metrics={cpu:[],memory:[],latency:[],errors:0},this.alertCallback=null,this.lastAlerts=new Map,this.alertCooldown=3e4,e&&(this.alertCallback=e),this.setupMonitoring()}setupMonitoring(){setInterval((()=>{this.collectMetrics(),this.checkHealth()}),3e4)}collectMetrics(){const e=.2*d.Dm.random(),t=20*d.Dm.random(),r=5*d.Dm.random();this.metrics.cpu.push(e),this.metrics.memory.push(t),this.metrics.latency.push(r),this.metrics.cpu.length>20&&this.metrics.cpu.shift(),this.metrics.memory.length>20&&this.metrics.memory.shift(),this.metrics.latency.length>20&&this.metrics.latency.shift()}checkHealth(){const e=e=>e.reduce(((e,t)=>e+t),0)/(e.length||1),t=e(this.metrics.cpu),r=e(this.metrics.memory),s=e(this.metrics.latency);t>.5&&this.alert("CPU √©lev√© : "+t.toFixed(3)),r>50&&this.alert("M√©moire √©lev√©e : "+r.toFixed(2)+"MB"),s>10&&this.alert("Latence √©lev√©e : "+s.toFixed(2)+"ms"),this.metrics.errors>5&&this.alert("Erreurs d√©tect√©es : "+this.metrics.errors)}logError(){this.metrics.errors++}alert(e){const t=e.split(":")[0],r=Date.now(),s=this.lastAlerts.get(t);(!s||r-s>this.alertCooldown)&&(n.vF.warn("üõë [HealthMonitor]",e),this.lastAlerts.set(t,r),this.alertCallback&&this.alertCallback(e))}}((async e=>{await F.store("symbiont_health_alert_"+Date.now(),{msg:e,timestamp:Date.now()})})),(async()=>{const e={type:"ORGANISM_UPDATE",payload:{state:{id:"demo",traits:{focus:1}},timestamp:Date.now()}};(await k.send(e)).success||n.vF.warn("Message ORGANISM_UPDATE fallback, voir la queue persistante.")})();let P=null;P=new class{constructor(){this.organism=null,this.activated=!1,this.events=[],this.collectiveThresholds=[10,50,100,250,500],this.reachedThresholds=[],this.security=new A,this.messageBus=new u("background"),this.storage=new m,this.invitationService=new g(this.storage),this.murmureService=new f,this._organismFactory=new R,L("symbiont_collective_thresholds").then((e=>{this.reachedThresholds=e?JSON.parse(e):[],this.initialize()}))}async initialize(){try{n.vF.info("Initializing storage...");try{await this.storage.initialize(),n.vF.info("Storage initialized successfully")}catch(e){const t={errorType:e instanceof Error?e.constructor.name:typeof e,errorMessage:e instanceof Error?e.message:String(e),errorStack:e instanceof Error?e.stack:void 0,timestamp:Date.now()};n.vF.error("CRITICAL: Storage initialization failed, entering degraded mode",t);try{await F.store("symbiont_init_error_"+Date.now(),t)}catch(e){n.vF.error("Failed to log error to hybrid storage:",e)}return"undefined"!=typeof chrome&&chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"SYMBIONT Storage Error",message:"Failed to initialize storage. Running in limited mode.",priority:2}),this.organism=null,this.setupMessageHandlers(),void this.startPeriodicTasks()}if(this.activated="true"===await L("symbiont_activated"),this.activated)try{n.vF.info("Loading organism from storage..."),this.organism=await this.storage.getOrganism(),this.organism?n.vF.info("Organism loaded successfully",{id:this.organism.id}):(n.vF.info("No organism found, creating new one..."),this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism),n.vF.info("New organism created and saved"))}catch(e){n.vF.error("Failed to load/create organism:",e),this.organism=this.createNewOrganism(),n.vF.warn("Created organism in memory only (storage unavailable)")}else this.organism=null,n.vF.info("Symbiont not activated, skipping organism creation");this.setupMessageHandlers(),this.startPeriodicTasks(),O.start(),n.vF.info("Background service initialized",{healthCheckActive:!0,bulkheadManagerActive:!0,organismLoaded:!!this.organism,activated:this.activated})}catch(e){n.vF.error("Failed to initialize background service:",e);try{this.setupMessageHandlers()}catch(e){n.vF.error("Failed to setup message handlers:",e)}}}createNewOrganism(){const e=this.generateVisualDNA();return{id:(0,i.lk)(),generation:1,health:100,energy:100,traits:{curiosity:100*d.Dm.random(),focus:100*d.Dm.random(),rhythm:100*d.Dm.random(),empathy:100*d.Dm.random(),creativity:100*d.Dm.random(),resilience:100*d.Dm.random(),adaptability:100*d.Dm.random(),memory:100*d.Dm.random(),intuition:100*d.Dm.random()},visualDNA:e,lastMutation:Date.now(),mutations:[],createdAt:Date.now(),dna:e,birthTime:Date.now(),socialConnections:[],memoryFragments:[]}}generateVisualDNA(){let e="";for(let t=0;t<64;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*d.Dm.random()));return e}setupMessageHandlers(){this.messageBus.on(e.PAGE_VISIT,(async e=>{const{url:t,title:r}=e.payload,s=await this.storage.getBehavior(t)||{url:t,visitCount:0,totalTime:0,scrollDepth:0,lastVisit:Date.now(),interactions:[]};s.visitCount++,s.lastVisit=Date.now(),await this.storage.saveBehavior(s),this.events.push({type:"visit",timestamp:Date.now(),url:t}),this.updateOrganismTraits(t,r),this.analyzeContextualPatterns()})),this.messageBus.on(e.SCROLL_EVENT,(async e=>{const{url:t,scrollDepth:r}=e.payload,s=await this.storage.getBehavior(t);s&&(s.scrollDepth=Math.max(s.scrollDepth,r),await this.storage.saveBehavior(s)),this.events.push({type:"scroll",timestamp:Date.now(),url:t}),this.analyzeContextualPatterns()})),this.messageBus.on(e.INTERACTION_DETECTED,(e=>{const{type:t,timestamp:r,target:s,data:i}=e.payload;this.events.push({type:t,timestamp:r,target:s,...i}),this.analyzeContextualPatterns()})),this.messageBus.on(e.GET_HEALTH_METRICS,(async t=>{try{const r={systemHealth:O.getSystemHealth(),bulkheadMetrics:T.getMetrics(),timestamp:Date.now()};t.sender&&this.messageBus.emit(e.HEALTH_METRICS_RESPONSE,{payload:r,requestId:t.requestId})}catch(e){n.vF.error("Erreur r√©cup√©ration m√©triques sant√©:",e)}})),this.messageBus.on(e.GENERATE_INVITATION,(async t=>{const{donorId:r}=t.payload,s=await this.invitationService.generateInvitation(r),i={code:s.code,createdAt:s.createdAt,consumed:s.used??!1,inviter:s.donorId,...s.usedAt&&{consumedAt:s.usedAt},...s.receiverId&&{invitee:s.receiverId}};let n=i;try{n=await this.security.encryptSensitiveData(i)}catch(e){n=i}await k.send({type:e.INVITATION_GENERATED,payload:n})})),this.messageBus.on(e.CONSUME_INVITATION,(async t=>{const{code:r,receiverId:s,role:i}=t.payload;if(!this.security.validateDataAccess({userId:s,resource:r,role:i},"user"))return void k.send({type:e.INVITATION_CONSUMED,payload:{error:"Acc√®s refus√©."}});const n=await this.invitationService.consumeInvitation(r,s);n&&(this.activated=!0,await x("symbiont_activated","true"),this.organism||(this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism))),k.send({type:e.INVITATION_CONSUMED,payload:n})})),this.messageBus.on(e.CHECK_INVITATION,(async t=>{const{code:r}=t.payload,s=await this.invitationService.isValid(r);k.send({type:e.INVITATION_CHECKED,payload:{code:r,valid:s}})})),this.messageBus.on(e.GET_INVITER,(async t=>{const{userId:r}=t.payload,s=(await this.invitationService.getAllInvitations()).find((e=>e.receiverId===r));k.send({type:e.INVITER_RESULT,payload:s||null})})),this.messageBus.on(e.GET_INVITEES,(async t=>{const{userId:r}=t.payload,s=(await this.invitationService.getAllInvitations()).filter((e=>e.donorId===r));k.send({type:e.INVITEES_RESULT,payload:s})})),this.messageBus.on(e.GET_INVITATION_HISTORY,(async t=>{const{userId:r}=t.payload,s=await this.invitationService.getAllInvitations(),i=[...s.filter((e=>e.receiverId===r)).map((e=>({...e,type:"re√ßue"}))),...s.filter((e=>e.donorId===r)).map((e=>({...e,type:"envoy√©e"})))];k.send({type:e.INVITATION_HISTORY_RESULT,payload:i})}));const t=new Map;this.messageBus.on(e.REQUEST_SHARED_MUTATION,(r=>{const{initiatorId:s,traits:i}=r.payload,n=d.Dm.random().toString(36).substr(2,6).toUpperCase(),a=Date.now()+3e5;t.set(n,{initiatorId:s,traits:i,expiresAt:a}),k.send({type:e.SHARED_MUTATION_CODE,payload:{code:n,initiatorId:s,expiresAt:a}})})),this.messageBus.on(e.ACCEPT_SHARED_MUTATION,(async r=>{const{code:s,receiverId:i,traits:n,role:a}=r.payload;if(!this.security.validateDataAccess({userId:i,resource:s,role:a},"user"))return void k.send({type:e.SHARED_MUTATION_RESULT,payload:{error:"Acc√®s refus√©."}});const o=t.get(s);if(!o||o.expiresAt<Date.now())return void k.send({type:e.SHARED_MUTATION_RESULT,payload:{error:"Code expir√© ou invalide."}});const c={...o.traits};for(const e of Object.keys(n))c[e]=(c[e]??0+n[e]??0)/2;t.delete(s);let h={initiatorId:o.initiatorId,receiverId:i,mergedTraits:c,timestamp:Date.now()};try{h=await this.security.encryptSensitiveData(h)}catch(e){}k.send({type:e.SHARED_MUTATION_RESULT,payload:h})}));const r=new Set;let s=null;this.messageBus.on(e.COLLECTIVE_WAKE_REQUEST,(t=>{const{userId:i}=t.payload;r.add(i),s||(s=setTimeout((()=>{k.send({type:e.COLLECTIVE_WAKE_RESULT,payload:{participants:Array.from(r),triggeredAt:Date.now()}}),r.clear(),s=null}),1e4))}));const i=async t=>{const r={code:"TEMP_CODE",donorId:await L("symbiont_user_id")||"unknown",symbolicLink:"",used:!1,createdAt:Date.now()};await k.send({type:e.CONTEXTUAL_INVITATION,payload:{invitation:r,context:t}})},a=this.generateMutation.bind(this);this.generateMutation=()=>{const e=a();return"cognitive"===e.type&&i("mutation_cognitive"),e};const o=this.updateOrganismTraits.bind(this);this.updateOrganismTraits=async(e,t)=>{await o(e,t),this.organism&&this.organism.traits.curiosity>90&&await i("curiosity_threshold")};let c=Date.now();chrome.idle.onStateChanged.addListener((e=>{"idle"===e?c=Date.now():"active"===e&&Date.now()-c>18e5&&i("long_inactivity")}));const h=["SYMBIOSE","AWAKEN","ECHO"];this.messageBus.on(e.SECRET_CODE_ENTERED,(t=>{const{code:r}=t.payload;h.includes(r.toUpperCase())&&k.send({type:e.SECRET_RITUAL_TRIGGERED,payload:{code:r,effect:"mutation_unique",timestamp:Date.now()}})}))}async updateOrganismTraits(t,r){if(!this.organism)return;const s=t.toLowerCase(),i=r.toLowerCase();(s.includes("github")||s.includes("stackoverflow")||s.includes("codepen")||s.includes("dribbble"))&&(this.organism.traits.creativity+=.5),(s.includes("docs")||s.includes("wiki")||s.includes("tutorial")||i.includes("guide"))&&(this.organism.traits.focus+=.3),(s.includes("twitter")||s.includes("linkedin")||s.includes("facebook")||s.includes("reddit"))&&(this.organism.traits.empathy+=.4);const n=new URL(t).hostname;if(!await this.hasVisitedDomain(n)&&(this.organism.traits.curiosity+=1),!this.organism)return;const a=this.organism.traits;if(!a)return;Object.keys(a).forEach((e=>{a[e]=Math.max(0,Math.min(100,a[e]))})),await this.checkForMutations(),await this.storage.saveOrganism(this.organism);let o="default";if(await this.isLoop(t)?o="loop":await this.isIdle()?o="idle":await this.isExploration(t)?o="exploration":await this.isRoutine(t)&&(o="routine"),!this.organism)return;const c=this.organism;await k.send({type:e.ORGANISM_UPDATE,payload:{state:c,mutations:await this.storage.getRecentMutations(5)}});const h=this.murmureService.generateMurmur(o);await k.send({type:e.MURMUR,payload:{text:h,pattern:o,timestamp:Date.now()}})}async hasVisitedDomain(e){return(await chrome.tabs.query({})).some((t=>t.url&&new URL(t.url).hostname===e))}async checkForMutations(){if(!this.organism)return;const e=this.organism,t=Date.now(),r=t-(e.lastMutation??0),s=Math.min(.5,r/36e5);if(d.Dm.random()<s){const r=this.generateMutation();await this.storage.addMutation(r),e.lastMutation=t,this.applyMutation(r)}}generateMutation(){const e=["visual","behavioral","cognitive"],t=e[Math.floor(d.Dm.random()*e.length)];return{type:t,trigger:this.getMutationTrigger(t),magnitude:.5*d.Dm.random()+.1,timestamp:Date.now()}}getMutationTrigger(e){const t={visual:["color_shift","pattern_change","size_fluctuation","opacity_variation"],behavioral:["navigation_speed","content_preference","interaction_pattern"],cognitive:["memory_retention","pattern_recognition","association_strength"]}[e];return t[Math.floor(d.Dm.random()*t.length)]}applyMutation(e){if(this.organism)switch(e.type){case"visual":this.organism.visualDNA=this.mutateVisualDNA(this.organism.visualDNA??"",e.magnitude);break;case"behavioral":{const t=Object.keys(this.organism.traits),r=t[Math.floor(d.Dm.random()*t.length)];this.organism.traits[r]+=(d.Dm.random()-.5)*e.magnitude*20;break}case"cognitive":{if(!this.organism)return;const t=this.organism.traits;if(!t)return;Object.keys(t).forEach((r=>{t[r]+=(d.Dm.random()-.5)*e.magnitude*5}));break}}}mutateVisualDNA(e,t){const r=Math.floor(e.length*t),s=e.split("");for(let t=0;t<r;t++)s[Math.floor(d.Dm.random()*e.length)]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*d.Dm.random()));return s.join("")}startPeriodicTasks(){setInterval((()=>{this.organism&&(this.organism.health??0)>0&&(this.organism.health=Math.max(0,(this.organism.health??0)-.1),this.organism.energy=Math.max(0,(this.organism.energy??0)-.05))}),6e4),setInterval((async()=>{this.organism&&(await this.storage.saveOrganism(this.organism),await k.send({type:e.ORGANISM_UPDATE,payload:{state:this.organism,mutations:await this.storage.getRecentMutations(5)}}))}),3e4)}async isLoop(e){const t=await this.storage.getBehavior(e);return!!t&&t.visitCount>=3}async isIdle(){return!1}async isExploration(e){const t=await this.storage.getBehavior(e);return!!t&&t.visitCount<=1}async isRoutine(e){const t=await this.storage.getBehavior(e);return!!t&&Date.now()-t.lastVisit<1728e5}async analyzeContextualPatterns(){const e=Date.now();this.events=this.events.filter((t=>e-t.timestamp<18e5)),v.detectBurst(this.events,1e4,5).length>0?this.triggerContextualInvitation("burst_activity"):v.detectTemporalPattern(this.events,6e4,.15).length>0?this.triggerContextualInvitation("temporal_cycle"):v.detectAlternance(this.events,"visit","scroll",6).length>0?this.triggerContextualInvitation("alternance_nav_scroll"):v.detectRepetition(this.events,7).length>0?this.triggerContextualInvitation("repetition_action"):this.checkCollectiveThreshold()}async checkCollectiveThreshold(){const e=(await this.invitationService.getAllInvitations()).length;for(const t of this.collectiveThresholds)if(e>=t&&!this.reachedThresholds.includes(t)){this.reachedThresholds.push(t),await x("symbiont_collective_thresholds",JSON.stringify(this.reachedThresholds)),this.triggerContextualInvitation("collective_threshold_"+t);break}}async triggerContextualInvitation(t){const r=await L("symbiont_user_id")||"unknown",s=await this.invitationService.generateInvitation(r);await k.send({type:e.CONTEXTUAL_INVITATION,payload:{invitation:s,context:t}})}dispose(){try{O.stop(),this.events=[],n.vF.info("BackgroundService disposed successfully")}catch(e){n.vF.error("Erreur lors du dispose du BackgroundService:",e)}}},globalThis._backgroundService=P,new class{constructor(){this.peers=new Set,this.organismState=null,this.peerId="peer_"+d.Dm.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_network"),this.channel.onmessage=e=>this.handleMessage(e.data),this.announce()}announce(){this.channel.postMessage({type:"announce",peerId:this.peerId})}joinNetwork(e){this.peers.add(e),this.channel.postMessage({type:"join",peerId:this.peerId}),n.vF.info(`[Network] Pair rejoint : ${e}`)}leaveNetwork(e){this.peers.delete(e),this.channel.postMessage({type:"leave",peerId:this.peerId}),n.vF.info(`[Network] Pair quitt√© : ${e}`)}broadcastMutation(e){this.channel.postMessage({type:"mutation",from:this.peerId,mutation:e}),n.vF.info(`[Network] Diffusion mutation √† ${this.peers.size} pairs`)}receiveMutation(e,t){n.vF.info(`[Network] Mutation re√ßue de ${t}`,e)}performCommunityBackup(e){this.channel.postMessage({type:"backup",from:this.peerId,state:e}),n.vF.info("[Network] Backup communautaire lanc√©")}handleMessage(e){if(e.peerId!==this.peerId)switch(e.type){case"announce":case"join":this.peers.add(e.peerId);break;case"leave":this.peers.delete(e.peerId);break;case"mutation":this.receiveMutation(e.mutation,e.from);break;case"backup":n.vF.info(`[Network] Backup re√ßu de ${e.from}`,e.state)}}},new class{constructor(e){this.proposals=new Map,this.votes=new Map,this.onCollectiveMutation=null,this.peerId="peer_"+d.Dm.random().toString(36).substr(2,8),e&&(this.onCollectiveMutation=e)}proposeMutation(e,t){this.proposals.has(e.id)||(this.proposals.set(e.id,[]),this.votes.set(e.id,new Set)),this.proposals.get(e.id).push({mutation:e,proposerId:t}),this.vote(e.id,t),n.vF.info(`[Collective] Mutation propos√©e par ${t}`)}vote(e,t){this.votes.has(e)||this.votes.set(e,new Set),this.votes.get(e).add(t),n.vF.info(`[Collective] Vote de ${t} pour mutation ${e}`)}aggregateVotes(e){return this.votes.get(e)?.size||0}triggerCollectiveMutation(e,t){const r=this.aggregateVotes(e);return r>Math.max(1,Math.floor(t/2))?(n.vF.info(`[Collective] Mutation collective d√©clench√©e : ${e}`),this.onCollectiveMutation&&this.onCollectiveMutation(e),!0):(n.vF.info(`[Collective] Consensus non atteint pour ${e} (${r}/${t})`),!1)}},new class{constructor(){this.peerId="peer_"+d.Dm.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_resilience"),this.channel.onmessage=e=>this.handleMessage(e.data)}requestCommunityBackup(e){this.channel.postMessage({type:"backup_request",from:this.peerId,organismId:e}),n.vF.info(`[SocialResilience] Demande de backup pour ${e}`)}restoreFromCommunity(e){n.vF.info(`[SocialResilience] Restauration depuis la communaut√© pour ${e}`)}detectMassiveFailure(){n.vF.info("[SocialResilience] D√©tection de panne massive")}launchCommunityAlert(e){this.channel.postMessage({type:"alert",from:this.peerId,message:e}),n.vF.info(`[SocialResilience] Alerte communautaire : ${e}`)}handleMessage(e){if(e.from!==this.peerId)switch(e.type){case"backup_request":n.vF.info(`[SocialResilience] Backup demand√© par ${e.from} pour ${e.organismId}`);break;case"alert":n.vF.info(`[SocialResilience] Alerte re√ßue : ${e.message}`)}}},new class{constructor(){this.peerId="peer_"+d.Dm.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_mystical"),this.channel.onmessage=e=>this.handleMessage(e.data)}triggerMysticalEvent(e,t){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:e,payload:t}),n.vF.info(`[MysticalEvents] √âv√©nement mystique d√©clench√© : ${e}`)}propagateToCommunity(e,t){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:e,payload:t}),n.vF.info(`[MysticalEvents] Propagation √† la communaut√© : ${e}`)}applySpecialEffect(e){n.vF.info(`[MysticalEvents] Effet sp√©cial appliqu√© : ${e}`)}handleMessage(e){e.from!==this.peerId&&"mystical"===e.type&&this.applySpecialEffect(`Effet mystique re√ßu : ${e.eventId}`)}}})();