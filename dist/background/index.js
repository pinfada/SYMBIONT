var t,e,s,i={},a={};function n(t){var e=a[t];if(void 0!==e)return e.exports;var s=a[t]={exports:{}};return i[t](s,s.exports,n),s.exports}n.m=i,n.d=(t,e)=>{for(var s in e)n.o(e,s)&&!n.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},n.f={},n.e=t=>Promise.all(Object.keys(n.f).reduce(((e,s)=>(n.f[s](t,e),e)),[])),n.u=t=>"background/"+t+".index.js",n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},t={792:0},e=e=>{var s,i,{__webpack_ids__:a,__webpack_modules__:r,__webpack_runtime__:o}=e,c=0;for(s in r)n.o(r,s)&&(n.m[s]=r[s]);for(o&&o(n);c<a.length;c++)i=a[c],n.o(t,i)&&t[i]&&t[i][0](),t[a[c]]=0},n.f.j=(s,i)=>{var a=n.o(t,s)?t[s]:void 0;if(0!==a)if(a)i.push(a[1]);else{var r=import("../"+n.u(s)).then(e,(e=>{throw 0!==t[s]&&(t[s]=void 0),e}));r=Promise.race([r,new Promise((e=>a=t[s]=[e]))]),i.push(a[1]=r)}},function(t){t.PAGE_VISIT="PAGE_VISIT",t.SCROLL_EVENT="SCROLL_EVENT",t.ORGANISM_UPDATE="ORGANISM_UPDATE",t.ORGANISM_MUTATE="ORGANISM_MUTATE",t.ORGANISM_STATE_CHANGE="ORGANISM_STATE_CHANGE",t.WEBGL_INIT="WEBGL_INIT",t.WEBGL_ERROR="WEBGL_ERROR",t.WEBGL_INITIALIZED="WEBGL_INITIALIZED",t.PERFORMANCE_UPDATE="PERFORMANCE_UPDATE",t.GENERATE_INVITATION="GENERATE_INVITATION",t.INVITATION_GENERATED="INVITATION_GENERATED",t.CONSUME_INVITATION="CONSUME_INVITATION",t.INVITATION_CONSUMED="INVITATION_CONSUMED",t.CHECK_INVITATION="CHECK_INVITATION",t.INVITATION_CHECKED="INVITATION_CHECKED",t.MURMUR="MURMUR",t.GET_INVITER="GET_INVITER",t.INVITER_RESULT="INVITER_RESULT",t.GET_INVITEES="GET_INVITEES",t.INVITEES_RESULT="INVITEES_RESULT",t.GET_INVITATION_HISTORY="GET_INVITATION_HISTORY",t.INVITATION_HISTORY_RESULT="INVITATION_HISTORY_RESULT",t.INTERACTION_DETECTED="INTERACTION_DETECTED",t.REQUEST_SHARED_MUTATION="REQUEST_SHARED_MUTATION",t.SHARED_MUTATION_CODE="SHARED_MUTATION_CODE",t.ACCEPT_SHARED_MUTATION="ACCEPT_SHARED_MUTATION",t.SHARED_MUTATION_RESULT="SHARED_MUTATION_RESULT",t.COLLECTIVE_WAKE_REQUEST="COLLECTIVE_WAKE_REQUEST",t.COLLECTIVE_WAKE_RESULT="COLLECTIVE_WAKE_RESULT",t.CONTEXTUAL_INVITATION="CONTEXTUAL_INVITATION",t.SECRET_RITUAL_TRIGGERED="SECRET_RITUAL_TRIGGERED",t.SECRET_CODE_ENTERED="SECRET_CODE_ENTERED"}(s||(s={}));class r{constructor(t){}on(t,e){}send(t){}subscribe(t,e){this.on(t,e)}}class o{constructor(){this.db=null,this.DB_NAME="symbiont-db",this.DB_VERSION=2}async initialize(){return new Promise(((t,e)=>{const s=indexedDB.open(this.DB_NAME,this.DB_VERSION);s.onerror=()=>e(s.error),s.onsuccess=()=>{this.db=s.result,t()},s.onupgradeneeded=t=>{const e=t.target.result;if(e.objectStoreNames.contains("organism")||e.createObjectStore("organism",{keyPath:"id"}),!e.objectStoreNames.contains("behaviors")){const t=e.createObjectStore("behaviors",{keyPath:"url"});t.createIndex("visitCount","visitCount",{unique:!1}),t.createIndex("lastVisit","lastVisit",{unique:!1})}if(!e.objectStoreNames.contains("mutations")){const t=e.createObjectStore("mutations",{autoIncrement:!0});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("type","type",{unique:!1})}e.objectStoreNames.contains("settings")||e.createObjectStore("settings",{keyPath:"key"}),e.objectStoreNames.contains("invitations")||e.createObjectStore("invitations",{keyPath:"code"})}}))}async getOrganism(){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,e)=>{const s=this.db.transaction(["organism"],"readonly").objectStore("organism").get("current");s.onsuccess=()=>t(s.result||null),s.onerror=()=>e(s.error)}))}async saveOrganism(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["organism"],"readwrite").objectStore("organism").put({...t,id:"current"});i.onsuccess=()=>e(),i.onerror=()=>s(i.error)}))}async getBehavior(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").get(t);i.onsuccess=()=>e(i.result||null),i.onerror=()=>s(i.error)}))}async saveBehavior(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["behaviors"],"readwrite").objectStore("behaviors").put(t);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)}))}async addMutation(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["mutations"],"readwrite").objectStore("mutations").add(t);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)}))}async getRecentMutations(t=10){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["mutations"],"readonly").objectStore("mutations").index("timestamp").openCursor(null,"prev"),a=[];i.onsuccess=s=>{const i=s.target.result;i&&a.length<t?(a.push(i.value),i.continue()):e(a)},i.onerror=()=>s(i.error)}))}async getSetting(t,e){if(!this.db)throw new Error("Database not initialized");return new Promise(((s,i)=>{const a=this.db.transaction(["settings"],"readonly").objectStore("settings").get(t);a.onsuccess=()=>{const t=a.result;s(t?t.value:e)},a.onerror=()=>i(a.error)}))}async setSetting(t,e){if(!this.db)throw new Error("Database not initialized");return new Promise(((s,i)=>{const a=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:t,value:e});a.onsuccess=()=>s(),a.onerror=()=>i(a.error)}))}async addInvitation(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").add(t);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)}))}async updateInvitation(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["invitations"],"readwrite").objectStore("invitations").put(t);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)}))}async getInvitation(t){if(!this.db)throw new Error("Database not initialized");return new Promise(((e,s)=>{const i=this.db.transaction(["invitations"],"readonly").objectStore("invitations").get(t);i.onsuccess=()=>e(i.result||null),i.onerror=()=>s(i.error)}))}async getAllInvitations(){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,e)=>{const s=this.db.transaction(["invitations"],"readonly").objectStore("invitations").openCursor(),i=[];s.onsuccess=e=>{const s=e.target.result;s?(i.push(s.value),s.continue()):t(i)},s.onerror=()=>e(s.error)}))}async getBehaviorPatterns(){if(!this.db)throw new Error("Database not initialized");return new Promise(((t,e)=>{const s=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),i=[];s.onsuccess=e=>{const s=e.target.result;s?(i.push(s.value),s.continue()):(i.sort(((t,e)=>e.visitCount!==t.visitCount?e.visitCount-t.visitCount:e.lastVisit-t.lastVisit)),t(i))},s.onerror=()=>e(s.error)}))}async getRecentActivity(t=864e5){if(!this.db)throw new Error("Database not initialized");const e=Date.now()-t;return new Promise(((t,s)=>{const i=this.db.transaction(["behaviors"],"readonly").objectStore("behaviors").openCursor(),a=[];i.onsuccess=s=>{const i=s.target.result;if(i){const t=i.value,s=(t.interactions||[]).filter((t=>t.timestamp>=e));for(const e of s)a.push({...e,url:t.url});i.continue()}else a.sort(((t,e)=>e.timestamp-t.timestamp)),t(a)},i.onerror=()=>s(i.error)}))}}class c{constructor(t){this.handler=null}observe(t){this.handler=t}disconnect(){this.handler=null}}class l{constructor(t){this.storage=t}async generateInvitation(t){const e={code:(await n.e(221).then(n.bind(n,221))).v4().slice(0,8).toUpperCase(),donorId:t,symbolicLink:this.generateSymbolicLink(),used:!1,createdAt:Date.now()};return await this.storage.addInvitation(e),e}async consumeInvitation(t,e){const s=await this.storage.getInvitation(t);return!s||s.used?null:(s.used=!0,s.receiverId=e,s.usedAt=Date.now(),await this.storage.updateInvitation(s),s)}async isValid(t){const e=await this.storage.getInvitation(t);return!!e&&!e.used}generateSymbolicLink(){const t=["#FF00FF","#00FFFF","#FFFF00","#FF8800","#00FF88","#8800FF"];return t[Math.floor(Math.random()*t.length)]}async getAllInvitations(){return await this.storage.getAllInvitations()}}const h={loop:["Encore ce m√™me chemin... Qu'y cherches-tu ?","La boucle se r√©p√®te, intention ou habitude ?","Revenir, encore et encore. Un besoin de rep√®re ?"],idle:["Un temps de pause... ou d'h√©sitation ?","Le silence aussi fait partie du voyage.","L'inactivit√©, pr√©lude √† une nouvelle exploration ?"],exploration:["Nouveau territoire, nouvelle perspective.","L'exploration nourrit la curiosit√©.","Tu t'aventures hors des sentiers battus."],routine:["Les habitudes forgent des chemins familiers.","La routine rassure, mais l'inattendu surprend.","Encore ce site, comme un rituel quotidien."],default:["Tu reviens souvent ici quand tu doutes.","Pourquoi cette boucle ?","As-tu remarqu√© ce sch√©ma dans ta navigation ?","Un autre d√©tour, ou une qu√™te de sens ?","Ce site semble t'attirer dans les moments de r√©flexion.","Encore une fois, tu explores ce chemin familier.","Et si tu essayais une nouvelle direction ?","La r√©p√©tition cache-t-elle une intention ?","Un murmure dans le flux de tes habitudes...","Parfois, la boucle est une porte vers l'inattendu."]},u={morning:["Un nouveau jour, une nouvelle boucle commence.","Le matin invite √† la d√©couverte.","L'aube de tes habitudes num√©riques."],afternoon:["L'apr√®s-midi, la routine s'installe.","Un moment propice √† l'exploration ou √† la r√©p√©tition ?","Le soleil haut, l'esprit vagabonde."],evening:["Le soir, tu reviens √† l'essentiel.","La nuit favorise les d√©tours int√©rieurs.","Encore connect√©, m√™me √† la tomb√©e du jour."],weekend:["Le week-end, les chemins changent.","Un rythme diff√©rent, des envies nouvelles.","La libert√© du week-end se lit dans ta navigation."]};class d{generateMurmur(t){if(function(){const t=(new Date).getDay();return 0===t||6===t}()){const t=u.weekend;if(Math.random()<.5)return t[Math.floor(Math.random()*t.length)]}else{const t=function(){const t=(new Date).getHours();return t<12?"morning":t<18?"afternoon":"evening"}();if(u[t]&&Math.random()<.4){const e=u[t];return e[Math.floor(Math.random()*e.length)]}}const e=t&&h[t]?h[t]:h.default;return e[Math.floor(Math.random()*e.length)]}}class m{static detectRepetition(t,e=3){const s={};for(const e of t)s[e.type]=(s[e.type]||0)+1;return Object.entries(s).filter((([t,s])=>s>=e)).map((([t,e])=>({type:"repetition",score:e,details:{eventType:t}})))}static detectAlternance(t,e,s,i=4){let a=0,n=null;for(const i of t)i.type!==e&&i.type!==s||i.type===n?i.type===n&&(a=1,n=i.type):(a++,n=i.type);return a>=i?[{type:"alternance",score:a,details:{typeA:e,typeB:s}}]:[]}static detectBurst(t,e=1e3,s=3){if(t.length<s)return[];let i=1,a=1;for(let s=1;s<t.length;s++)t[s].timestamp-t[s-1].timestamp<=e?(i++,a=Math.max(a,i)):i=1;return a>=s?[{type:"burst",score:a,details:{maxInterval:e}}]:[]}static detectTemporalPattern(t,e=1e3,s=.2){if(t.length<3)return[];const i=[];for(let e=1;e<t.length;e++)i.push(t[e].timestamp-t[e-1].timestamp);const a=i.reduce(((t,e)=>t+e),0)/i.length,n=i.reduce(((t,e)=>t+Math.pow(e-a,2)),0)/i.length,r=Math.sqrt(n);return a>=e&&r/a<s?[{type:"temporal",score:a,details:{std:r,count:t.length}}]:[]}}class p{constructor(){this.encryptionKey="symbiont-key-demo"}async encryptSensitiveData(t){if(window.crypto&&window.crypto.subtle){const e=new TextEncoder,s=e.encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),i=await window.crypto.subtle.importKey("raw",s,{name:"AES-GCM"},!1,["encrypt"]),a=window.crypto.getRandomValues(new Uint8Array(12)),n=e.encode(JSON.stringify(t)),r=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},i,n),o=new Uint8Array(a.length+r.byteLength);return o.set(a,0),o.set(new Uint8Array(r),a.length),btoa(String.fromCharCode(...o))}{const e=JSON.stringify(t);return btoa(unescape(encodeURIComponent(e)))}}async decryptSensitiveData(t){if("string"!=typeof t)throw new Error("decryptSensitiveData attend une cha√Æne de caract√®res.");if(!window.crypto||!window.crypto.subtle){const e=decodeURIComponent(escape(atob(String(t))));return JSON.parse(e)}try{const e=Uint8Array.from(atob(String(t)),(t=>t.charCodeAt(0))),s=e.slice(0,12),i=e.slice(12),a=(new TextEncoder).encode(this.encryptionKey.padEnd(32,"0").slice(0,32)),n=await window.crypto.subtle.importKey("raw",a,{name:"AES-GCM"},!1,["decrypt"]),r=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:s},n,i);return JSON.parse((new TextDecoder).decode(r))}catch{const e=decodeURIComponent(escape(atob(String(t))));return JSON.parse(e)}}anonymizeForSharing(t){const e={...t};return"url"in e&&(e.url="anonymized"),"userId"in e&&"string"==typeof e.userId&&(e.userId=this.hash(e.userId)),"id"in e&&"string"==typeof e.id&&(e.id=this.hash(e.id)),e}validateDataAccess(t,e="user"){return!(!t.userId||!t.resource||"admin"===e&&"admin"!==t.role)}hash(t){if(window.crypto&&window.crypto.subtle){let e=0;for(let s=0;s<t.length;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return btoa(e.toString())}{let e=0;for(let s=0;s<t.length;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return btoa(e.toString())}}}class g{constructor(){this.failureCount=0,this.open=!1,this.lastFailure=0,this.failureThreshold=5,this.recoveryTimeout=3e4}isOpen(){return this.open&&Date.now()-this.lastFailure>this.recoveryTimeout&&(this.open=!1,this.failureCount=0),this.open}recordSuccess(){this.failureCount=0,this.open=!1}recordFailure(){this.failureCount++,this.lastFailure=Date.now(),this.failureCount>=this.failureThreshold&&(this.open=!0)}}class y{constructor(){this.key="symbiont_messages"}async enqueue(t){const e=JSON.parse(localStorage.getItem(this.key)||"[]");e.push(t),localStorage.setItem(this.key,JSON.stringify(e))}async dequeue(){const t=JSON.parse(localStorage.getItem(this.key)||"[]"),e=t.shift();return localStorage.setItem(this.key,JSON.stringify(t)),e}async getAll(){return JSON.parse(localStorage.getItem(this.key)||"[]")}}const I=new class{constructor(){this.memoryCache=new Map,this.persistentStorage=chrome.storage?.local,this.indexedDB=null,this.emergencyLocalStorage=window.localStorage,this.setupMultiLayerStorage(),this.setupDataReplication(),this.setupIntegrityMonitoring()}async store(t,e,s={}){this.memoryCache.set(t,e);try{await new Promise(((s,i)=>{this.persistentStorage.set({[t]:e},(()=>{chrome.runtime.lastError?i(chrome.runtime.lastError):s(!0)}))}))}catch(t){console.warn("chrome.storage.local failed, fallback IndexedDB")}try{if(!this.indexedDB)throw new Error("IndexedDB not ready");this.indexedDB.transaction(["symbiont"],"readwrite").objectStore("symbiont").put(e,t)}catch(s){this.emergencyLocalStorage.setItem(t,JSON.stringify(e))}}async retrieve(t){if(this.memoryCache.has(t))return this.memoryCache.get(t);try{const e=await new Promise(((e,s)=>{this.persistentStorage.get([t],(i=>{chrome.runtime.lastError?s(chrome.runtime.lastError):e(i[t])}))}));if(void 0!==e)return this.memoryCache.set(t,e),e}catch(t){}try{if(this.indexedDB)return await new Promise(((e,s)=>{const i=this.indexedDB.transaction(["symbiont"],"readonly").objectStore("symbiont").get(t);i.onsuccess=()=>e(i.result),i.onerror=()=>s(i.error)}))}catch(t){}try{const e=this.emergencyLocalStorage.getItem(t);if(e)return JSON.parse(e)}catch(t){}return null}setupMultiLayerStorage(){const t=window.indexedDB.open("symbiont-db",1);t.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("symbiont")||e.createObjectStore("symbiont")},t.onsuccess=()=>{this.indexedDB=t.result},t.onerror=()=>{this.indexedDB=null}}setupDataReplication(){}setupIntegrityMonitoring(){}},E=new class{constructor(){this.connectionState="offline",this.messageQueue=new y,this.failureStrategies=new Map,this.circuitBreaker=new g,this.setupFailureStrategies()}setupFailureStrategies(){this.failureStrategies.set("ORGANISM_UPDATE",{maxRetries:3,backoffStrategy:"exponential",fallbackAction:this.cacheOrganismState,criticalLevel:"high"}),this.failureStrategies.set("INTERACTION_DETECTED",{maxRetries:5,backoffStrategy:"linear",fallbackAction:this.queueForLaterSync,criticalLevel:"medium"}),this.failureStrategies.set("PAGE_ANALYSIS_COMPLETE",{maxRetries:2,backoffStrategy:"immediate",fallbackAction:this.processLocally,criticalLevel:"low"})}async send(t){if(this.circuitBreaker.isOpen())return await this.messageQueue.enqueue(t),{success:!1,queued:!0,error:"Circuit breaker open"};let e=0;const s=this.failureStrategies.get(t.type),i=s?.maxRetries||2;for(;e<=i;)try{return await this.simulateSend(t),this.circuitBreaker.recordSuccess(),{success:!0}}catch(a){if(this.circuitBreaker.recordFailure(),e++,e>i)return s&&await s.fallbackAction.call(this,t),await this.messageQueue.enqueue(t),{success:!1,queued:!0,error:a};await this.wait(this.getBackoff(s?.backoffStrategy,e))}return{success:!1,queued:!0,error:"Unknown error"}}async simulateSend(t){if(Math.random()<.2)throw new Error("Simulated send failure")}getBackoff(t="immediate",e){return"exponential"===t?500*Math.pow(2,e):"linear"===t?500*e:0}wait(t){return new Promise((e=>setTimeout(e,t)))}async cacheOrganismState(t){localStorage.setItem("symbiont_organism_cache",JSON.stringify(t))}async queueForLaterSync(t){await this.messageQueue.enqueue(t)}async processLocally(t){localStorage.setItem("symbiont_local_processing",JSON.stringify(t))}};async function v(t){return await I.retrieve(t)}async function w(t,e){await I.store(t,e)}new class{constructor(t){this.metrics={cpu:[],memory:[],latency:[],errors:0},this.alertCallback=null,t&&(this.alertCallback=t),this.setupMonitoring()}setupMonitoring(){setInterval((()=>{this.collectMetrics(),this.checkHealth()}),5e3)}collectMetrics(){const t=.2*Math.random(),e=20*Math.random(),s=5*Math.random();this.metrics.cpu.push(t),this.metrics.memory.push(e),this.metrics.latency.push(s),this.metrics.cpu.length>20&&this.metrics.cpu.shift(),this.metrics.memory.length>20&&this.metrics.memory.shift(),this.metrics.latency.length>20&&this.metrics.latency.shift()}checkHealth(){const t=t=>t.reduce(((t,e)=>t+e),0)/(t.length||1),e=t(this.metrics.cpu),s=t(this.metrics.memory),i=t(this.metrics.latency);e>.18&&this.alert("CPU √©lev√© : "+e.toFixed(3)),s>18&&this.alert("M√©moire √©lev√©e : "+s.toFixed(2)+"MB"),i>4&&this.alert("Latence √©lev√©e : "+i.toFixed(2)+"ms"),this.metrics.errors>0&&this.alert("Erreurs d√©tect√©es : "+this.metrics.errors)}logError(){this.metrics.errors++}alert(t){console.warn("üõë [HealthMonitor]",t),this.alertCallback&&this.alertCallback(t)}}((async t=>{await I.store("symbiont_health_alert_"+Date.now(),{msg:t,timestamp:Date.now()})})),(async()=>{const t={type:"ORGANISM_UPDATE",payload:{state:{id:"demo",traits:{focus:1}},timestamp:Date.now()}};(await E.send(t)).success||console.warn("Message ORGANISM_UPDATE fallback, voir la queue persistante.")})();let T=null;T=new class{constructor(){this.organism=null,this.activated=!1,this.events=[],this.collectiveThresholds=[10,50,100,250,500],this.reachedThresholds=[],this.security=new p,this.messageBus=new r("background"),this.storage=new o,this.navigationObserver=new c(this.messageBus),this.invitationService=new l(this.storage),this.murmureService=new d,v("symbiont_collective_thresholds").then((t=>{this.reachedThresholds=t?JSON.parse(t):[],this.initialize()}))}async initialize(){try{await this.storage.initialize(),this.activated="true"===await v("symbiont_activated"),this.activated?(this.organism=await this.storage.getOrganism(),this.organism||(this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism))):this.organism=null,this.setupMessageHandlers(),this.startPeriodicTasks(),console.log("Background service initialized")}catch(t){console.error("Failed to initialize background service:",t)}}createNewOrganism(){const t=this.generateVisualDNA();return{id:crypto.randomUUID(),generation:1,health:100,energy:100,traits:{curiosity:100*Math.random(),focus:100*Math.random(),rhythm:100*Math.random(),empathy:100*Math.random(),creativity:100*Math.random()},visualDNA:t,lastMutation:Date.now(),mutations:[],createdAt:Date.now(),dna:t,birthTime:Date.now(),socialConnections:[],memoryFragments:[]}}generateVisualDNA(){let t="";for(let e=0;e<64;e++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}setupMessageHandlers(){this.messageBus.on(s.PAGE_VISIT,(async t=>{const{url:e,title:s}=t.payload;let i=await this.storage.getBehavior(e)||{url:e,visitCount:0,totalTime:0,scrollDepth:0,lastVisit:Date.now(),interactions:[]};i.visitCount++,i.lastVisit=Date.now(),await this.storage.saveBehavior(i),this.events.push({type:"visit",timestamp:Date.now(),url:e}),this.updateOrganismTraits(e,s),this.analyzeContextualPatterns()})),this.messageBus.on(s.SCROLL_EVENT,(async t=>{const{url:e,scrollDepth:s}=t.payload,i=await this.storage.getBehavior(e);i&&(i.scrollDepth=Math.max(i.scrollDepth,s),await this.storage.saveBehavior(i)),this.events.push({type:"scroll",timestamp:Date.now(),url:e}),this.analyzeContextualPatterns()})),this.messageBus.on(s.INTERACTION_DETECTED,(t=>{const{type:e,timestamp:s,target:i,data:a}=t.payload;this.events.push({type:e,timestamp:s,target:i,...a}),this.analyzeContextualPatterns()})),this.messageBus.on(s.GENERATE_INVITATION,(async t=>{const{donorId:e}=t.payload,i=await this.invitationService.generateInvitation(e),a={code:i.code,createdAt:i.createdAt,consumed:i.used??!1,consumedAt:i.usedAt,inviter:i.donorId,invitee:i.receiverId};let n=a;try{n=await this.security.encryptSensitiveData(a)}catch(t){n=a}await E.send({type:s.INVITATION_GENERATED,payload:n})})),this.messageBus.on(s.CONSUME_INVITATION,(async t=>{const{code:e,receiverId:i,role:a}=t.payload;if(!this.security.validateDataAccess({userId:i,resource:e,role:a},"user"))return void E.send({type:s.INVITATION_CONSUMED,payload:{error:"Acc√®s refus√©."}});const n=await this.invitationService.consumeInvitation(e,i);n&&(this.activated=!0,await w("symbiont_activated","true"),this.organism||(this.organism=this.createNewOrganism(),await this.storage.saveOrganism(this.organism))),E.send({type:s.INVITATION_CONSUMED,payload:n})})),this.messageBus.on(s.CHECK_INVITATION,(async t=>{const{code:e}=t.payload,i=await this.invitationService.isValid(e);E.send({type:s.INVITATION_CHECKED,payload:{code:e,valid:i}})})),this.messageBus.on(s.GET_INVITER,(async t=>{const{userId:e}=t.payload,i=(await this.invitationService.getAllInvitations()).find((t=>t.receiverId===e));E.send({type:s.INVITER_RESULT,payload:i||null})})),this.messageBus.on(s.GET_INVITEES,(async t=>{const{userId:e}=t.payload,i=(await this.invitationService.getAllInvitations()).filter((t=>t.donorId===e));E.send({type:s.INVITEES_RESULT,payload:i})})),this.messageBus.on(s.GET_INVITATION_HISTORY,(async t=>{const{userId:e}=t.payload,i=await this.invitationService.getAllInvitations(),a=[...i.filter((t=>t.receiverId===e)).map((t=>({...t,type:"re√ßue"}))),...i.filter((t=>t.donorId===e)).map((t=>({...t,type:"envoy√©e"})))];E.send({type:s.INVITATION_HISTORY_RESULT,payload:a})}));const t=new Map;this.messageBus.on(s.REQUEST_SHARED_MUTATION,(e=>{const{initiatorId:i,traits:a}=e.payload,n=Math.random().toString(36).substr(2,6).toUpperCase(),r=Date.now()+3e5;t.set(n,{initiatorId:i,traits:a,expiresAt:r}),E.send({type:s.SHARED_MUTATION_CODE,payload:{code:n,initiatorId:i,expiresAt:r}})})),this.messageBus.on(s.ACCEPT_SHARED_MUTATION,(async e=>{const{code:i,receiverId:a,traits:n,role:r}=e.payload;if(!this.security.validateDataAccess({userId:a,resource:i,role:r},"user"))return void E.send({type:s.SHARED_MUTATION_RESULT,payload:{error:"Acc√®s refus√©."}});const o=t.get(i);if(!o||o.expiresAt<Date.now())return void E.send({type:s.SHARED_MUTATION_RESULT,payload:{error:"Code expir√© ou invalide."}});const c={...o.traits};for(const t of Object.keys(n))c[t]=(c[t]??0+n[t]??0)/2;t.delete(i);let l={initiatorId:o.initiatorId,receiverId:a,mergedTraits:c,timestamp:Date.now()};try{l=await this.security.encryptSensitiveData(l)}catch(t){}E.send({type:s.SHARED_MUTATION_RESULT,payload:l})}));let e=new Set,i=null;this.messageBus.on(s.COLLECTIVE_WAKE_REQUEST,(t=>{const{userId:a}=t.payload;e.add(a),i||(i=setTimeout((()=>{E.send({type:s.COLLECTIVE_WAKE_RESULT,payload:{participants:Array.from(e),triggeredAt:Date.now()}}),e.clear(),i=null}),1e4))}));const a=async t=>{const e=await v("symbiont_user_id")||"unknown",i=await this.invitationService.generateInvitation(e);await E.send({type:s.CONTEXTUAL_INVITATION,payload:{invitation:i,context:t}})},n=this.generateMutation.bind(this);this.generateMutation=()=>{const t=n();return"cognitive"===t.type&&a("mutation_cognitive"),t};const r=this.updateOrganismTraits.bind(this);this.updateOrganismTraits=async(t,e)=>{await r(t,e),this.organism&&this.organism.traits.curiosity>90&&await a("curiosity_threshold")};let o=Date.now();chrome.idle.onStateChanged.addListener((t=>{"idle"===t?o=Date.now():"active"===t&&Date.now()-o>18e5&&a("long_inactivity")}));const c=["SYMBIOSE","AWAKEN","ECHO"];this.messageBus.on(s.SECRET_CODE_ENTERED,(t=>{const{code:e}=t.payload;c.includes(e.toUpperCase())&&E.send({type:s.SECRET_RITUAL_TRIGGERED,payload:{code:e,effect:"mutation_unique",timestamp:Date.now()}})}))}async updateOrganismTraits(t,e){if(!this.organism)return;const i=t.toLowerCase(),a=e.toLowerCase();(i.includes("github")||i.includes("stackoverflow")||i.includes("codepen")||i.includes("dribbble"))&&(this.organism.traits.creativity+=.5),(i.includes("docs")||i.includes("wiki")||i.includes("tutorial")||a.includes("guide"))&&(this.organism.traits.focus+=.3),(i.includes("twitter")||i.includes("linkedin")||i.includes("facebook")||i.includes("reddit"))&&(this.organism.traits.empathy+=.4);const n=new URL(t).hostname;if(!await this.hasVisitedDomain(n)&&(this.organism.traits.curiosity+=1),!this.organism)return;const r=this.organism.traits;if(!r)return;Object.keys(r).forEach((t=>{r[t]=Math.max(0,Math.min(100,r[t]))})),await this.checkForMutations(),await this.storage.saveOrganism(this.organism);let o="default";if(await this.isLoop(t)?o="loop":await this.isIdle()?o="idle":await this.isExploration(t)?o="exploration":await this.isRoutine(t)&&(o="routine"),!this.organism)return;const c=this.organism;await E.send({type:s.ORGANISM_UPDATE,payload:{state:c,mutations:await this.storage.getRecentMutations(5)}});const l=this.murmureService.generateMurmur(o);await E.send({type:s.MURMUR,payload:{text:l,pattern:o,timestamp:Date.now()}})}async hasVisitedDomain(t){return(await chrome.tabs.query({})).some((e=>e.url&&new URL(e.url).hostname===t))}async checkForMutations(){if(!this.organism)return;const t=this.organism,e=Date.now(),s=e-(t.lastMutation??0),i=Math.min(.5,s/36e5);if(Math.random()<i){const s=this.generateMutation();await this.storage.addMutation(s),t.lastMutation=e,this.applyMutation(s)}}generateMutation(){const t=["visual","behavioral","cognitive"],e=t[Math.floor(Math.random()*t.length)];return{type:e,trigger:this.getMutationTrigger(e),magnitude:.5*Math.random()+.1,timestamp:Date.now()}}getMutationTrigger(t){const e={visual:["color_shift","pattern_change","size_fluctuation","opacity_variation"],behavioral:["navigation_speed","content_preference","interaction_pattern"],cognitive:["memory_retention","pattern_recognition","association_strength"]}[t];return e[Math.floor(Math.random()*e.length)]}applyMutation(t){if(this.organism)switch(t.type){case"visual":this.organism.visualDNA=this.mutateVisualDNA(this.organism.visualDNA??"",t.magnitude);break;case"behavioral":const e=Object.keys(this.organism.traits),s=e[Math.floor(Math.random()*e.length)];this.organism.traits[s]+=(Math.random()-.5)*t.magnitude*20;break;case"cognitive":if(!this.organism)return;const i=this.organism.traits;if(!i)return;Object.keys(i).forEach((e=>{i[e]+=(Math.random()-.5)*t.magnitude*5}))}}mutateVisualDNA(t,e){const s=Math.floor(t.length*e);let i=t.split("");for(let e=0;e<s;e++)i[Math.floor(Math.random()*t.length)]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return i.join("")}startPeriodicTasks(){setInterval((()=>{this.organism&&(this.organism.health??0)>0&&(this.organism.health=Math.max(0,(this.organism.health??0)-.1),this.organism.energy=Math.max(0,(this.organism.energy??0)-.05))}),6e4),setInterval((async()=>{this.organism&&(await this.storage.saveOrganism(this.organism),await E.send({type:s.ORGANISM_UPDATE,payload:{state:this.organism,mutations:await this.storage.getRecentMutations(5)}}))}),3e4)}async isLoop(t){const e=await this.storage.getBehavior(t);return!!e&&e.visitCount>=3}async isIdle(){return!1}async isExploration(t){const e=await this.storage.getBehavior(t);return!!e&&e.visitCount<=1}async isRoutine(t){const e=await this.storage.getBehavior(t);return!!e&&Date.now()-e.lastVisit<1728e5}async analyzeContextualPatterns(){const t=Date.now();this.events=this.events.filter((e=>t-e.timestamp<18e5)),m.detectBurst(this.events,1e4,5).length>0?this.triggerContextualInvitation("burst_activity"):m.detectTemporalPattern(this.events,6e4,.15).length>0?this.triggerContextualInvitation("temporal_cycle"):m.detectAlternance(this.events,"visit","scroll",6).length>0?this.triggerContextualInvitation("alternance_nav_scroll"):m.detectRepetition(this.events,7).length>0?this.triggerContextualInvitation("repetition_action"):this.checkCollectiveThreshold()}async checkCollectiveThreshold(){const t=(await this.invitationService.getAllInvitations()).length;for(const e of this.collectiveThresholds)if(t>=e&&!this.reachedThresholds.includes(e)){this.reachedThresholds.push(e),await w("symbiont_collective_thresholds",JSON.stringify(this.reachedThresholds)),this.triggerContextualInvitation("collective_threshold_"+e);break}}async triggerContextualInvitation(t){const e=await v("symbiont_user_id")||"unknown",i=await this.invitationService.generateInvitation(e);await E.send({type:s.CONTEXTUAL_INVITATION,payload:{invitation:i,context:t}})}},new class{constructor(){this.peers=new Set,this.organismState=null,this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_network"),this.channel.onmessage=t=>this.handleMessage(t.data),this.announce()}announce(){this.channel.postMessage({type:"announce",peerId:this.peerId})}joinNetwork(t){this.peers.add(t),this.channel.postMessage({type:"join",peerId:this.peerId}),console.log(`[Network] Pair rejoint : ${t}`)}leaveNetwork(t){this.peers.delete(t),this.channel.postMessage({type:"leave",peerId:this.peerId}),console.log(`[Network] Pair quitt√© : ${t}`)}broadcastMutation(t){this.channel.postMessage({type:"mutation",from:this.peerId,mutation:t}),console.log(`[Network] Diffusion mutation √† ${this.peers.size} pairs`)}receiveMutation(t,e){console.log(`[Network] Mutation re√ßue de ${e}`,t)}performCommunityBackup(t){this.channel.postMessage({type:"backup",from:this.peerId,state:t}),console.log("[Network] Backup communautaire lanc√©")}handleMessage(t){if(t.peerId!==this.peerId)switch(t.type){case"announce":case"join":this.peers.add(t.peerId);break;case"leave":this.peers.delete(t.peerId);break;case"mutation":this.receiveMutation(t.mutation,t.from);break;case"backup":console.log(`[Network] Backup re√ßu de ${t.from}`,t.state)}}},new class{constructor(t){this.proposals=new Map,this.votes=new Map,this.onCollectiveMutation=null,this.peerId="peer_"+Math.random().toString(36).substr(2,8),t&&(this.onCollectiveMutation=t)}proposeMutation(t,e){this.proposals.has(t.id)||(this.proposals.set(t.id,[]),this.votes.set(t.id,new Set)),this.proposals.get(t.id).push({mutation:t,proposerId:e}),this.vote(t.id,e),console.log(`[Collective] Mutation propos√©e par ${e}`)}vote(t,e){this.votes.has(t)||this.votes.set(t,new Set),this.votes.get(t).add(e),console.log(`[Collective] Vote de ${e} pour mutation ${t}`)}aggregateVotes(t){return this.votes.get(t)?.size||0}triggerCollectiveMutation(t,e){const s=this.aggregateVotes(t);return s>Math.max(1,Math.floor(e/2))?(console.log(`[Collective] Mutation collective d√©clench√©e : ${t}`),this.onCollectiveMutation&&this.onCollectiveMutation(t),!0):(console.log(`[Collective] Consensus non atteint pour ${t} (${s}/${e})`),!1)}},new class{constructor(){this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_resilience"),this.channel.onmessage=t=>this.handleMessage(t.data)}requestCommunityBackup(t){this.channel.postMessage({type:"backup_request",from:this.peerId,organismId:t}),console.log(`[SocialResilience] Demande de backup pour ${t}`)}restoreFromCommunity(t){console.log(`[SocialResilience] Restauration depuis la communaut√© pour ${t}`)}detectMassiveFailure(){console.log("[SocialResilience] D√©tection de panne massive")}launchCommunityAlert(t){this.channel.postMessage({type:"alert",from:this.peerId,message:t}),console.log(`[SocialResilience] Alerte communautaire : ${t}`)}handleMessage(t){if(t.from!==this.peerId)switch(t.type){case"backup_request":console.log(`[SocialResilience] Backup demand√© par ${t.from} pour ${t.organismId}`);break;case"alert":console.log(`[SocialResilience] Alerte re√ßue : ${t.message}`)}}},new class{constructor(){this.peerId="peer_"+Math.random().toString(36).substr(2,8),this.channel=new BroadcastChannel("symbiont_mystical"),this.channel.onmessage=t=>this.handleMessage(t.data)}triggerMysticalEvent(t,e){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:t,payload:e}),console.log(`[MysticalEvents] √âv√©nement mystique d√©clench√© : ${t}`)}propagateToCommunity(t,e){this.channel.postMessage({type:"mystical",from:this.peerId,eventId:t,payload:e}),console.log(`[MysticalEvents] Propagation √† la communaut√© : ${t}`)}applySpecialEffect(t){console.log(`[MysticalEvents] Effet sp√©cial appliqu√© : ${t}`)}handleMessage(t){t.from!==this.peerId&&"mystical"===t.type&&this.applySpecialEffect(`Effet mystique re√ßu : ${t.eventId}`)}};